<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>分类: 数据分析 - Lanhoo&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="description9">
<meta property="og:type" content="website">
<meta property="og:title" content="Lanhoo&#39;s blog">
<meta property="og:url" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;categories&#x2F;%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90&#x2F;page&#x2F;2&#x2F;index.html">
<meta property="og:site_name" content="Lanhoo&#39;s blog">
<meta property="og:description" content="description9">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;images&#x2F;og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;images&#x2F;og_image.png">







<link rel="icon" href="/images/grid32.ico">


<!-- 添加用户的样式，用来修改表格样式 -->
<!-- 效果不好，代码块也是表格，把代码块也变了 -->
<link rel="stylesheet" href="/css/user2.css" media="screen" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146455672-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146455672-1');
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="Lanhoo's blog" type="application/atom+xml">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/grid.svg" alt="Lanhoo&#39;s blog" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;" target="_blank" rel="noopener">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <!-- 将main_column_class() 改为 col() -->
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main"><div class="card">
    <div class="card-content">
        <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
            <li><a href="/categories">分类</a></li>
            
            <li class="is-active"><a href="#" aria-current="page">数据分析</a></li>
        </ul>
        </nav>
    </div>
</div>

    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    30 分钟 读完 (大约 4441 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC12%E7%AB%A0%20pandas%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">《利用Python进行数据分析·第2版》第12章 pandas高级应用</a>
            
        </h1>
        <div class="content">
            <h1 id="《利用Python进行数据分析·第2版》第12章-pandas高级应用"><a href="#《利用Python进行数据分析·第2版》第12章-pandas高级应用" class="headerlink" title="《利用Python进行数据分析·第2版》第12章 pandas高级应用"></a>《利用Python进行数据分析·第2版》第12章 pandas高级应用</h1><hr>
<p>转载自<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
第12章 pandas高级应用
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>前面的章节关注于不同类型的数据规整流程和NumPy、pandas与其它库的特点。随着时间的发展，pandas发展出了更多适合高级用户的功能。本章就要深入学习pandas的高级功能。</p>
<h1 id="12-1-分类数据"><a href="#12-1-分类数据" class="headerlink" title="12.1 分类数据"></a>12.1 分类数据</h1><p>这一节介绍的是pandas的分类类型。我会向你展示通过使用它，提高性能和内存的使用率。我还会介绍一些在统计和机器学习中使用分类数据的工具。</p>
<h2 id="背景和目的"><a href="#背景和目的" class="headerlink" title="背景和目的"></a>背景和目的</h2><p>表中的一列通常会有重复的包含不同值的小集合的情况。我们已经学过了unique和value_counts，它们可以从数组提取出不同的值，并分别计算频率：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np; <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: values = pd.Series([<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'apple'</span>,</span><br><span class="line">   ....:                     <span class="hljs-string">'apple'</span>] * <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: values</span><br><span class="line">Out[<span class="hljs-number">12</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">2</span>     apple</span><br><span class="line"><span class="hljs-number">3</span>     apple</span><br><span class="line"><span class="hljs-number">4</span>     apple</span><br><span class="line"><span class="hljs-number">5</span>    orange</span><br><span class="line"><span class="hljs-number">6</span>     apple</span><br><span class="line"><span class="hljs-number">7</span>     apple</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: pd.unique(values)</span><br><span class="line">Out[<span class="hljs-number">13</span>]: array([<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>], dtype=object)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: pd.value_counts(values)</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">apple     <span class="hljs-number">6</span></span><br><span class="line">orange    <span class="hljs-number">2</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>许多数据系统（数据仓库、统计计算或其它应用）都发展出了特定的表征重复值的方法，以进行高效的存储和计算。在数据仓库中，最好的方法是使用所谓的包含不同值的维表(Dimension Table)，将主要的参数存储为引用维表整数键：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: values = pd.Series([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] * <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: dim = pd.Series([<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: values</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">6</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">7</span>    <span class="hljs-number">0</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">18</span>]: dim</span><br><span class="line">Out[<span class="hljs-number">18</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>可以使用take方法存储原始的字符串Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">19</span>]: dim.take(values)</span><br><span class="line">Out[<span class="hljs-number">19</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>这种用整数表示的方法称为分类或字典编码表示法。不同值得数组称为分类、字典或数据级。本书中，我们使用分类的说法。表示分类的整数值称为分类编码或简单地称为编码。</p>
<p>分类表示可以在进行分析时大大的提高性能。你也可以在保持编码不变的情况下，对分类进行转换。一些相对简单的转变例子包括：</p>
<ul>
<li>重命名分类。</li>
<li>加入一个新的分类，不改变已经存在的分类的顺序或位置。</li>
</ul>
<h2 id="pandas的分类类型"><a href="#pandas的分类类型" class="headerlink" title="pandas的分类类型"></a>pandas的分类类型</h2><p>pandas有一个特殊的分类类型，用于保存使用整数分类表示法的数据。看一个之前的Series例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">20</span>]: fruits = [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-string">'apple'</span>] * <span class="hljs-number">2</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: N = len(fruits)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'fruit'</span>: fruits,</span><br><span class="line">   ....:                    <span class="hljs-string">'basket_id'</span>: np.arange(N),</span><br><span class="line">   ....:                    <span class="hljs-string">'count'</span>: np.random.randint(<span class="hljs-number">3</span>, <span class="hljs-number">15</span>, size=N),</span><br><span class="line">   ....:                    <span class="hljs-string">'weight'</span>: np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, size=N)&#125;,</span><br><span class="line">   ....:                   columns=[<span class="hljs-string">'basket_id'</span>, <span class="hljs-string">'fruit'</span>, <span class="hljs-string">'count'</span>, <span class="hljs-string">'weight'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: df</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">   basket_id   fruit  count    weight</span><br><span class="line"><span class="hljs-number">0</span>          <span class="hljs-number">0</span>   apple      <span class="hljs-number">5</span>  <span class="hljs-number">3.858058</span></span><br><span class="line"><span class="hljs-number">1</span>          <span class="hljs-number">1</span>  orange      <span class="hljs-number">8</span>  <span class="hljs-number">2.612708</span></span><br><span class="line"><span class="hljs-number">2</span>          <span class="hljs-number">2</span>   apple      <span class="hljs-number">4</span>  <span class="hljs-number">2.995627</span></span><br><span class="line"><span class="hljs-number">3</span>          <span class="hljs-number">3</span>   apple      <span class="hljs-number">7</span>  <span class="hljs-number">2.614279</span></span><br><span class="line"><span class="hljs-number">4</span>          <span class="hljs-number">4</span>   apple     <span class="hljs-number">12</span>  <span class="hljs-number">2.990859</span></span><br><span class="line"><span class="hljs-number">5</span>          <span class="hljs-number">5</span>  orange      <span class="hljs-number">8</span>  <span class="hljs-number">3.845227</span></span><br><span class="line"><span class="hljs-number">6</span>          <span class="hljs-number">6</span>   apple      <span class="hljs-number">5</span>  <span class="hljs-number">0.033553</span></span><br><span class="line"><span class="hljs-number">7</span>          <span class="hljs-number">7</span>   apple      <span class="hljs-number">4</span>  <span class="hljs-number">0.425778</span></span><br></pre></td></tr></table></figure>

<p>这里，df[‘fruit’]是一个Python字符串对象的数组。我们可以通过调用它，将它转变为分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: fruit_cat = df[<span class="hljs-string">'fruit'</span>].astype(<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: fruit_cat</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">2</span>     apple</span><br><span class="line"><span class="hljs-number">3</span>     apple</span><br><span class="line"><span class="hljs-number">4</span>     apple</span><br><span class="line"><span class="hljs-number">5</span>    orange</span><br><span class="line"><span class="hljs-number">6</span>     apple</span><br><span class="line"><span class="hljs-number">7</span>     apple</span><br><span class="line">Name: fruit, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">2</span>, object): [apple, orange]</span><br></pre></td></tr></table></figure>

<p>fruit_cat的值不是NumPy数组，而是一个pandas.Categorical实例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">26</span>]: c = fruit_cat.values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: type(c)</span><br><span class="line">Out[<span class="hljs-number">27</span>]: pandas.core.categorical.Categorical</span><br></pre></td></tr></table></figure>

<p>分类对象有categories和codes属性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">28</span>]: c.categories</span><br><span class="line">Out[<span class="hljs-number">28</span>]: Index([<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>], dtype=<span class="hljs-string">'object'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">29</span>]: c.codes</span><br><span class="line">Out[<span class="hljs-number">29</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], dtype=int8)</span><br></pre></td></tr></table></figure>

<p>你可将DataFrame的列通过分配转换结果，转换为分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">30</span>]: df[<span class="hljs-string">'fruit'</span>] = df[<span class="hljs-string">'fruit'</span>].astype(<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: df.fruit</span><br><span class="line">Out[<span class="hljs-number">31</span>]:</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">2</span>     apple</span><br><span class="line"><span class="hljs-number">3</span>     apple</span><br><span class="line"><span class="hljs-number">4</span>     apple</span><br><span class="line"><span class="hljs-number">5</span>    orange</span><br><span class="line"><span class="hljs-number">6</span>     apple</span><br><span class="line"><span class="hljs-number">7</span>     apple</span><br><span class="line">Name: fruit, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">2</span>, object): [apple, orange]</span><br></pre></td></tr></table></figure>

<p>你还可以从其它Python序列直接创建pandas.Categorical：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">32</span>]: my_categories = pd.Categorical([<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">33</span>]: my_categories</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">[foo, bar, baz, foo, bar]</span><br><span class="line">Categories (<span class="hljs-number">3</span>, object): [bar, baz, foo]</span><br></pre></td></tr></table></figure>

<p>如果你已经从其它源获得了分类编码，你还可以使用from_codes构造器：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">34</span>]: categories = [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">35</span>]: codes = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: my_cats_2 = pd.Categorical.from_codes(codes, categories)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: my_cats_2</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">[foo, bar, baz, foo, foo, bar]</span><br><span class="line">Categories (<span class="hljs-number">3</span>, object): [foo, bar, baz]</span><br></pre></td></tr></table></figure>

<p>与显示指定不同，分类变换不认定指定的分类顺序。因此取决于输入数据的顺序，categories数组的顺序会不同。当使用from_codes或其它的构造器时，你可以指定分类一个有意义的顺序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">38</span>]: ordered_cat = pd.Categorical.from_codes(codes, categories,</span><br><span class="line">   ....:                                         ordered=<span class="hljs-literal">True</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">39</span>]: ordered_cat</span><br><span class="line">Out[<span class="hljs-number">39</span>]: </span><br><span class="line">[foo, bar, baz, foo, foo, bar]</span><br><span class="line">Categories (<span class="hljs-number">3</span>, object): [foo &lt; bar &lt; baz]</span><br></pre></td></tr></table></figure>

<p>输出[foo &lt; bar &lt; baz]指明‘foo’位于‘bar’的前面，以此类推。无序的分类实例可以通过as_ordered排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">40</span>]: my_cats_2.as_ordered()</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">[foo, bar, baz, foo, foo, bar]</span><br><span class="line">Categories (<span class="hljs-number">3</span>, object): [foo &lt; bar &lt; baz]</span><br></pre></td></tr></table></figure>

<p>最后要注意，分类数据不需要字符串，尽管我仅仅展示了字符串的例子。分类数组可以包括任意不可变类型。</p>
<h2 id="用分类进行计算"><a href="#用分类进行计算" class="headerlink" title="用分类进行计算"></a>用分类进行计算</h2><p>与非编码版本（比如字符串数组）相比，使用pandas的Categorical有些类似。某些pandas组件，比如groupby函数，更适合进行分类。还有一些函数可以使用有序标志位。</p>
<p>来看一些随机的数值数据，使用pandas.qcut面元函数。它会返回pandas.Categorical，我们之前使用过pandas.cut，但没解释分类是如何工作的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">41</span>]: np.random.seed(<span class="hljs-number">12345</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: draws = np.random.randn(<span class="hljs-number">1000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: draws[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">43</span>]: array([<span class="hljs-number">-0.2047</span>,  <span class="hljs-number">0.4789</span>, <span class="hljs-number">-0.5194</span>, <span class="hljs-number">-0.5557</span>,  <span class="hljs-number">1.9658</span>])</span><br></pre></td></tr></table></figure>

<p>计算这个数据的分位面元，提取一些统计信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: bins = pd.qcut(draws, <span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">45</span>]: bins</span><br><span class="line">Out[<span class="hljs-number">45</span>]: </span><br><span class="line">[(<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>], (<span class="hljs-number">-0.0101</span>, <span class="hljs-number">0.63</span>], (<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>], (<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>], (<span class="hljs-number">0.63</span>,</span><br><span class="line"> <span class="hljs-number">3.928</span>], ..., (<span class="hljs-number">-0.0101</span>, <span class="hljs-number">0.63</span>], (<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>], (<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.684</span>], (<span class="hljs-number">-0.0101</span>, <span class="hljs-number">0.63</span></span><br><span class="line">], (<span class="hljs-number">0.63</span>, <span class="hljs-number">3.928</span>]]</span><br><span class="line">Length: <span class="hljs-number">1000</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.684</span>] &lt; (<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>] &lt; (<span class="hljs-number">-0.010</span></span><br><span class="line"><span class="hljs-number">1</span>, <span class="hljs-number">0.63</span>] &lt;</span><br><span class="line">                                    (<span class="hljs-number">0.63</span>, <span class="hljs-number">3.928</span>]]</span><br></pre></td></tr></table></figure>

<p>虽然有用，确切的样本分位数与分位的名称相比，不利于生成汇总。我们可以使用labels参数qcut，实现目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">46</span>]: bins = pd.qcut(draws, <span class="hljs-number">4</span>, labels=[<span class="hljs-string">'Q1'</span>, <span class="hljs-string">'Q2'</span>, <span class="hljs-string">'Q3'</span>, <span class="hljs-string">'Q4'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: bins</span><br><span class="line">Out[<span class="hljs-number">47</span>]: </span><br><span class="line">[Q2, Q3, Q2, Q2, Q4, ..., Q3, Q2, Q1, Q3, Q4]</span><br><span class="line">Length: <span class="hljs-number">1000</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [Q1 &lt; Q2 &lt; Q3 &lt; Q4]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: bins.codes[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">48</span>]: array([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>], dtype=int8)</span><br></pre></td></tr></table></figure>

<p>加上标签的面元分类不包含数据面元边界的信息，因此可以使用groupby提取一些汇总信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: bins = pd.Series(bins, name=<span class="hljs-string">'quartile'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">50</span>]: results = (pd.Series(draws)</span><br><span class="line">   ....:            .groupby(bins)</span><br><span class="line">   ....:            .agg([<span class="hljs-string">'count'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'max'</span>])</span><br><span class="line">   ....:            .reset_index())</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: results</span><br><span class="line">Out[<span class="hljs-number">51</span>]: </span><br><span class="line">  quartile  count       min       max</span><br><span class="line"><span class="hljs-number">0</span>       Q1    <span class="hljs-number">250</span> <span class="hljs-number">-2.949343</span> <span class="hljs-number">-0.685484</span></span><br><span class="line"><span class="hljs-number">1</span>       Q2    <span class="hljs-number">250</span> <span class="hljs-number">-0.683066</span> <span class="hljs-number">-0.010115</span></span><br><span class="line"><span class="hljs-number">2</span>       Q3    <span class="hljs-number">250</span> <span class="hljs-number">-0.010032</span>  <span class="hljs-number">0.628894</span></span><br><span class="line"><span class="hljs-number">3</span>       Q4    <span class="hljs-number">250</span>  <span class="hljs-number">0.634238</span>  <span class="hljs-number">3.927528</span></span><br></pre></td></tr></table></figure>

<p>分位数列保存了原始的面元分类信息，包括排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">52</span>]: results[<span class="hljs-string">'quartile'</span>]</span><br><span class="line">Out[<span class="hljs-number">52</span>]:</span><br><span class="line"><span class="hljs-number">0</span>    Q1</span><br><span class="line"><span class="hljs-number">1</span>    Q2</span><br><span class="line"><span class="hljs-number">2</span>    Q3</span><br><span class="line"><span class="hljs-number">3</span>    Q4</span><br><span class="line">Name: quartile, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [Q1 &lt; Q2 &lt; Q3 &lt; Q4]</span><br></pre></td></tr></table></figure>

<h2 id="用分类提高性能"><a href="#用分类提高性能" class="headerlink" title="用分类提高性能"></a>用分类提高性能</h2><p>如果你是在一个特定数据集上做大量分析，将其转换为分类可以极大地提高效率。DataFrame列的分类使用的内存通常少的多。来看一些包含一千万元素的Series，和一些不同的分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">53</span>]: N = <span class="hljs-number">10000000</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">54</span>]: draws = pd.Series(np.random.randn(N))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: labels = pd.Series([<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'qux'</span>] * (N // <span class="hljs-number">4</span>))</span><br></pre></td></tr></table></figure>

<p>现在，将标签转换为分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: categories = labels.astype(<span class="hljs-string">'category'</span>)</span><br></pre></td></tr></table></figure>

<p>这时，可以看到标签使用的内存远比分类多：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">57</span>]: labels.memory_usage()</span><br><span class="line">Out[<span class="hljs-number">57</span>]: <span class="hljs-number">80000080</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: categories.memory_usage()</span><br><span class="line">Out[<span class="hljs-number">58</span>]: <span class="hljs-number">10000272</span></span><br></pre></td></tr></table></figure>

<p>转换为分类不是没有代价的，但这是一次性的代价：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">59</span>]: %time _ = labels.astype(<span class="hljs-string">'category'</span>)</span><br><span class="line">CPU times: user <span class="hljs-number">490</span> ms, sys: <span class="hljs-number">240</span> ms, total: <span class="hljs-number">730</span> ms</span><br><span class="line">Wall time: <span class="hljs-number">726</span> ms</span><br></pre></td></tr></table></figure>

<p>GroupBy使用分类操作明显更快，是因为底层的算法使用整数编码数组，而不是字符串数组。</p>
<h2 id="分类方法"><a href="#分类方法" class="headerlink" title="分类方法"></a>分类方法</h2><p>包含分类数据的Series有一些特殊的方法，类似于Series.str字符串方法。它还提供了方便的分类和编码的使用方法。看下面的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: s = pd.Series([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>] * <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: cat_s = s.astype(<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: cat_s</span><br><span class="line">Out[<span class="hljs-number">62</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">2</span>    c</span><br><span class="line"><span class="hljs-number">3</span>    d</span><br><span class="line"><span class="hljs-number">4</span>    a</span><br><span class="line"><span class="hljs-number">5</span>    b</span><br><span class="line"><span class="hljs-number">6</span>    c</span><br><span class="line"><span class="hljs-number">7</span>    d</span><br><span class="line">dtype: category</span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [a, b, c, d]</span><br></pre></td></tr></table></figure>

<p>特别的cat属性提供了分类方法的入口：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">63</span>]: cat_s.cat.codes</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">6</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">7</span>    <span class="hljs-number">3</span></span><br><span class="line">dtype: int8</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">64</span>]: cat_s.cat.categories</span><br><span class="line">Out[<span class="hljs-number">64</span>]: Index([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>], dtype=<span class="hljs-string">'object'</span>)</span><br></pre></td></tr></table></figure>

<p>假设我们知道这个数据的实际分类集，超出了数据中的四个值。我们可以使用set_categories方法改变它们：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: actual_categories = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">66</span>]: cat_s2 = cat_s.cat.set_categories(actual_categories)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: cat_s2</span><br><span class="line">Out[<span class="hljs-number">67</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">2</span>    c</span><br><span class="line"><span class="hljs-number">3</span>    d</span><br><span class="line"><span class="hljs-number">4</span>    a</span><br><span class="line"><span class="hljs-number">5</span>    b</span><br><span class="line"><span class="hljs-number">6</span>    c</span><br><span class="line"><span class="hljs-number">7</span>    d</span><br><span class="line">dtype: category</span><br><span class="line">Categories (<span class="hljs-number">5</span>, object): [a, b, c, d, e]</span><br></pre></td></tr></table></figure>

<p>虽然数据看起来没变，新的分类将反映在它们的操作中。例如，如果有的话，value_counts表示分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: cat_s.value_counts()</span><br><span class="line">Out[<span class="hljs-number">68</span>]: </span><br><span class="line">d    <span class="hljs-number">2</span></span><br><span class="line">c    <span class="hljs-number">2</span></span><br><span class="line">b    <span class="hljs-number">2</span></span><br><span class="line">a    <span class="hljs-number">2</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">69</span>]: cat_s2.value_counts()</span><br><span class="line">Out[<span class="hljs-number">69</span>]: </span><br><span class="line">d    <span class="hljs-number">2</span></span><br><span class="line">c    <span class="hljs-number">2</span></span><br><span class="line">b    <span class="hljs-number">2</span></span><br><span class="line">a    <span class="hljs-number">2</span></span><br><span class="line">e    <span class="hljs-number">0</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>在大数据集中，分类经常作为节省内存和高性能的便捷工具。过滤完大DataFrame或Series之后，许多分类可能不会出现在数据中。我们可以使用remove_unused_categories方法删除没看到的分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">70</span>]: cat_s3 = cat_s[cat_s.isin([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: cat_s3</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">4</span>    a</span><br><span class="line"><span class="hljs-number">5</span>    b</span><br><span class="line">dtype: category</span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [a, b, c, d]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: cat_s3.cat.remove_unused_categories()</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">4</span>    a</span><br><span class="line"><span class="hljs-number">5</span>    b</span><br><span class="line">dtype: category</span><br><span class="line">Categories (<span class="hljs-number">2</span>, object): [a, b]</span><br></pre></td></tr></table></figure>

<p>表12-1列出了可用的分类方法。</p>
<p><img src="/images/blog/7178691-6c602152c2bba658.webp" alt="img"></p>
<p>表12-1 pandas的Series的分类方法</p>
<h2 id="为建模创建虚拟变量"><a href="#为建模创建虚拟变量" class="headerlink" title="为建模创建虚拟变量"></a>为建模创建虚拟变量</h2><p>当你使用统计或机器学习工具时，通常会将分类数据转换为虚拟变量，也称为one-hot编码。这包括创建一个不同类别的列的DataFrame；这些列包含给定分类的1s，其它为0。</p>
<p>看前面的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: cat_s = pd.Series([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>] * <span class="hljs-number">2</span>, dtype=<span class="hljs-string">'category'</span>)</span><br></pre></td></tr></table></figure>

<p>前面的第7章提到过，pandas.get_dummies函数可以转换这个分类数据为包含虚拟变量的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: pd.get_dummies(cat_s)</span><br><span class="line">Out[<span class="hljs-number">74</span>]: </span><br><span class="line">   a  b  c  d</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">7</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="12-2-GroupBy高级应用"><a href="#12-2-GroupBy高级应用" class="headerlink" title="12.2 GroupBy高级应用"></a>12.2 GroupBy高级应用</h1><p>尽管我们在第10章已经深度学习了Series和DataFrame的Groupby方法，还有一些方法也是很有用的。</p>
<h2 id="分组转换和“解封”GroupBy"><a href="#分组转换和“解封”GroupBy" class="headerlink" title="分组转换和“解封”GroupBy"></a>分组转换和“解封”GroupBy</h2><p>在第10章，我们在分组操作中学习了apply方法，进行转换。还有另一个transform方法，它与apply很像，但是对使用的函数有一定限制：</p>
<ul>
<li>它可以产生向分组形状广播标量值</li>
<li>它可以产生一个和输入组形状相同的对象</li>
<li>它不能修改输入</li>
</ul>
<p>来看一个简单的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>] * <span class="hljs-number">4</span>,</span><br><span class="line">   ....:                    <span class="hljs-string">'value'</span>: np.arange(<span class="hljs-number">12.</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: df</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">   key  value</span><br><span class="line"><span class="hljs-number">0</span>    a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">1</span>    b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>    c    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    a    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">4</span>    b    <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">5</span>    c    <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">6</span>    a    <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">7</span>    b    <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">8</span>    c    <span class="hljs-number">8.0</span></span><br><span class="line"><span class="hljs-number">9</span>    a    <span class="hljs-number">9.0</span></span><br><span class="line"><span class="hljs-number">10</span>   b   <span class="hljs-number">10.0</span></span><br><span class="line"><span class="hljs-number">11</span>   c   <span class="hljs-number">11.0</span></span><br></pre></td></tr></table></figure>

<p>按键进行分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">77</span>]: g = df.groupby(<span class="hljs-string">'key'</span>).value</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: g.mean()</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">key</span><br><span class="line">a    <span class="hljs-number">4.5</span></span><br><span class="line">b    <span class="hljs-number">5.5</span></span><br><span class="line">c    <span class="hljs-number">6.5</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>假设我们想产生一个和df[‘value’]形状相同的Series，但值替换为按键分组的平均值。我们可以传递函数lambda x: x.mean()进行转换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: g.transform(<span class="hljs-keyword">lambda</span> x: x.mean())</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">6.5</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>对于内置的聚合函数，我们可以传递一个字符串假名作为GroupBy的agg方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">80</span>]: g.transform(<span class="hljs-string">'mean'</span>)</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">6.5</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>与apply类似，transform的函数会返回Series，但是结果必须与输入大小相同。举个例子，我们可以用lambda函数将每个分组乘以2：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">81</span>]: g.transform(<span class="hljs-keyword">lambda</span> x: x * <span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">81</span>]: </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">8.0</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">10.0</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">12.0</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">14.0</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">16.0</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">18.0</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">20.0</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">22.0</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>再举一个复杂的例子，我们可以计算每个分组的降序排名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: g.transform(<span class="hljs-keyword">lambda</span> x: x.rank(ascending=<span class="hljs-literal">False</span>))</span><br><span class="line">Out[<span class="hljs-number">82</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">1.0</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>看一个由简单聚合构造的的分组转换函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize</span><span class="hljs-params">(x)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> (x - x.mean()) / x.std()</span><br></pre></td></tr></table></figure>

<p>我们用transform或apply可以获得等价的结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">84</span>]: g.transform(normalize)</span><br><span class="line">Out[<span class="hljs-number">84</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">1.161895</span></span><br><span class="line">Name: value, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: g.apply(normalize)</span><br><span class="line">Out[<span class="hljs-number">85</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">1.161895</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>内置的聚合函数，比如mean或sum，通常比apply函数快，也比transform快。这允许我们进行一个所谓的解封（unwrapped）分组操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: g.transform(<span class="hljs-string">'mean'</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">6.5</span></span><br><span class="line">Name: value, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">87</span>]: normalized = (df[<span class="hljs-string">'value'</span>] - g.transform(<span class="hljs-string">'mean'</span>)) / g.transform(<span class="hljs-string">'std'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: normalized</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">1.161895</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>解封分组操作可能包括多个分组聚合，但是矢量化操作还是会带来收益。</p>
<h2 id="分组的时间重采样"><a href="#分组的时间重采样" class="headerlink" title="分组的时间重采样"></a>分组的时间重采样</h2><p>对于时间序列数据，resample方法从语义上是一个基于内在时间的分组操作。下面是一个示例表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">89</span>]: N = <span class="hljs-number">15</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: times = pd.date_range(<span class="hljs-string">'2017-05-20 00:00'</span>, freq=<span class="hljs-string">'1min'</span>, periods=N)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">91</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'time'</span>: times,</span><br><span class="line">   ....:                    <span class="hljs-string">'value'</span>: np.arange(N)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: df</span><br><span class="line">Out[<span class="hljs-number">92</span>]: </span><br><span class="line">                  time  value</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">00</span>      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00</span>      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">04</span>:<span class="hljs-number">00</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00</span>      <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">7</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">00</span>      <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">8</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">08</span>:<span class="hljs-number">00</span>      <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">9</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">09</span>:<span class="hljs-number">00</span>      <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">10</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>     <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">11</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">00</span>     <span class="hljs-number">11</span></span><br><span class="line"><span class="hljs-number">12</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">12</span>:<span class="hljs-number">00</span>     <span class="hljs-number">12</span></span><br><span class="line"><span class="hljs-number">13</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">13</span>:<span class="hljs-number">00</span>     <span class="hljs-number">13</span></span><br><span class="line"><span class="hljs-number">14</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00</span>     <span class="hljs-number">14</span></span><br></pre></td></tr></table></figure>

<p>这里，我们可以用time作为索引，然后重采样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">93</span>]: df.set_index(<span class="hljs-string">'time'</span>).resample(<span class="hljs-string">'5min'</span>).count()</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line">                     value</span><br><span class="line">time                      </span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>      <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>假设DataFrame包含多个时间序列，用一个额外的分组键的列进行标记：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: df2 = pd.DataFrame(&#123;<span class="hljs-string">'time'</span>: times.repeat(<span class="hljs-number">3</span>),</span><br><span class="line">   ....:                     <span class="hljs-string">'key'</span>: np.tile([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>], N),</span><br><span class="line">   ....:                     <span class="hljs-string">'value'</span>: np.arange(N * <span class="hljs-number">3.</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: df2[:<span class="hljs-number">7</span>]</span><br><span class="line">Out[<span class="hljs-number">95</span>]: </span><br><span class="line">  key                time  value</span><br><span class="line"><span class="hljs-number">0</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">1</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">4</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">5</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">6</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">00</span>    <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>要对每个key值进行相同的重采样，我们引入pandas.TimeGrouper对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: time_key = pd.TimeGrouper(<span class="hljs-string">'5min'</span>)</span><br></pre></td></tr></table></figure>

<p>我们然后设定时间索引，用key和time_key分组，然后聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">97</span>]: resampled = (df2.set_index(<span class="hljs-string">'time'</span>)</span><br><span class="line">   ....:              .groupby([<span class="hljs-string">'key'</span>, time_key])</span><br><span class="line">   ....:              .sum())</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: resampled</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">                         value</span><br><span class="line">key time                      </span><br><span class="line">a   <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">30.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">105.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">180.0</span></span><br><span class="line">b   <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">35.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">110.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">185.0</span></span><br><span class="line">c   <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">40.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">115.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">190.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: resampled.reset_index()</span><br><span class="line">Out[<span class="hljs-number">99</span>]:</span><br><span class="line">key                time  value</span><br><span class="line"><span class="hljs-number">0</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">30.0</span></span><br><span class="line"><span class="hljs-number">1</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">105.0</span></span><br><span class="line"><span class="hljs-number">2</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">180.0</span></span><br><span class="line"><span class="hljs-number">3</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">35.0</span></span><br><span class="line"><span class="hljs-number">4</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">110.0</span></span><br><span class="line"><span class="hljs-number">5</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">185.0</span></span><br><span class="line"><span class="hljs-number">6</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">40.0</span></span><br><span class="line"><span class="hljs-number">7</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">115.0</span></span><br><span class="line"><span class="hljs-number">8</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">190.0</span></span><br></pre></td></tr></table></figure>

<p>使用TimeGrouper的限制是时间必须是Series或DataFrame的索引。</p>
<h1 id="12-3-链式编程技术"><a href="#12-3-链式编程技术" class="headerlink" title="12.3 链式编程技术"></a>12.3 链式编程技术</h1><p>当对数据集进行一系列变换时，你可能发现创建的多个临时变量其实并没有在分析中用到。看下面的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">df = load_data()</span><br><span class="line">df2 = df[df[<span class="hljs-string">'col2'</span>] &lt; <span class="hljs-number">0</span>]</span><br><span class="line">df2[<span class="hljs-string">'col1_demeaned'</span>] = df2[<span class="hljs-string">'col1'</span>] - df2[<span class="hljs-string">'col1'</span>].mean()</span><br><span class="line">result = df2.groupby(<span class="hljs-string">'key'</span>).col1_demeaned.std()</span><br></pre></td></tr></table></figure>

<p>虽然这里没有使用真实的数据，这个例子却指出了一些新方法。首先，DataFrame.assign方法是一个df[k] = v形式的函数式的列分配方法。它不是就地修改对象，而是返回新的修改过的DataFrame。因此，下面的语句是等价的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Usual non-functional way</span></span><br><span class="line">df2 = df.copy()</span><br><span class="line">df2[<span class="hljs-string">'k'</span>] = v</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Functional assign way</span></span><br><span class="line">df2 = df.assign(k=v)</span><br></pre></td></tr></table></figure>

<p>就地分配可能会比assign快，但是assign可以方便地进行链式编程：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = (df2.assign(col1_demeaned=df2.col1 - df2.col2.mean())</span><br><span class="line">          .groupby(<span class="hljs-string">'key'</span>)</span><br><span class="line">          .col1_demeaned.std())</span><br></pre></td></tr></table></figure>

<p>我使用外括号，这样便于添加换行符。</p>
<p>使用链式编程时要注意，你可能会需要涉及临时对象。在前面的例子中，我们不能使用load_data的结果，直到它被赋值给临时变量df。为了这么做，assign和许多其它pandas函数可以接收类似函数的参数，即可调用对象（callable）。为了展示可调用对象，看一个前面例子的片段：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df = load_data()</span><br><span class="line">df2 = df[df[<span class="hljs-string">'col2'</span>] &lt; <span class="hljs-number">0</span>]</span><br></pre></td></tr></table></figure>

<p>它可以重写为：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df = (load_data()</span><br><span class="line">      [<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'col2'</span>] &lt; <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>这里，load_data的结果没有赋值给某个变量，因此传递到[ ]的函数在这一步被绑定到了对象。</p>
<p>我们可以把整个过程写为一个单链表达式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">result = (load_data()</span><br><span class="line">          [<span class="hljs-keyword">lambda</span> x: x.col2 &lt; <span class="hljs-number">0</span>]</span><br><span class="line">          .assign(col1_demeaned=<span class="hljs-keyword">lambda</span> x: x.col1 - x.col1.mean())</span><br><span class="line">          .groupby(<span class="hljs-string">'key'</span>)</span><br><span class="line">          .col1_demeaned.std())</span><br></pre></td></tr></table></figure>

<p>是否将代码写成这种形式只是习惯而已，将它分开成若干步可以提高可读性。</p>
<h2 id="管道方法"><a href="#管道方法" class="headerlink" title="管道方法"></a>管道方法</h2><p>你可以用Python内置的pandas函数和方法，用带有可调用对象的链式编程做许多工作。但是，有时你需要使用自己的函数，或是第三方库的函数。这时就要用到管道方法。</p>
<p>看下面的函数调用：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = f(df, arg1=v1)</span><br><span class="line">b = g(a, v2, arg3=v3)</span><br><span class="line">c = h(b, arg4=v4)</span><br></pre></td></tr></table></figure>

<p>当使用接收、返回Series或DataFrame对象的函数式，你可以调用pipe将其重写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = (df.pipe(f, arg1=v1)</span><br><span class="line">          .pipe(g, v2, arg3=v3)</span><br><span class="line">          .pipe(h, arg4=v4))</span><br></pre></td></tr></table></figure>

<p>f(df)和df.pipe(f)是等价的，但是pipe使得链式声明更容易。</p>
<p>pipe的另一个有用的地方是提炼操作为可复用的函数。看一个从列减去分组方法的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g = df.groupby([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>])</span><br><span class="line">df[<span class="hljs-string">'col1'</span>] = df[<span class="hljs-string">'col1'</span>] - g.transform(<span class="hljs-string">'mean'</span>)</span><br></pre></td></tr></table></figure>

<p>假设你想转换多列，并修改分组的键。另外，你想用链式编程做这个转换。下面就是一个方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">group_demean</span><span class="hljs-params">(df, by, cols)</span>:</span></span><br><span class="line">    result = df.copy()</span><br><span class="line">    g = df.groupby(by)</span><br><span class="line">    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> cols:</span><br><span class="line">        result[c] = df[c] - g[c].transform(<span class="hljs-string">'mean'</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>然后可以写为：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = (df[df.col1 &lt; <span class="hljs-number">0</span>]</span><br><span class="line">          .pipe(group_demean, [<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>], [<span class="hljs-string">'col1'</span>]))</span><br></pre></td></tr></table></figure>

<h1 id="12-4-总结"><a href="#12-4-总结" class="headerlink" title="12.4 总结"></a>12.4 总结</h1><p>和其它许多开源项目一样，pandas仍然在不断的变化和进步中。和本书中其它地方一样，这里的重点是放在接下来几年不会发生什么改变且稳定的功能。</p>
<p>为了深入学习pandas的知识，我建议你学习官方文档，并阅读开发团队发布的文档更新。我们还邀请你加入pandas的开发工作：修改bug、创建新功能、完善文档。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    35 分钟 读完 (大约 5223 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC13%E7%AB%A0%20Python%E5%BB%BA%E6%A8%A1%E5%BA%93%E4%BB%8B%E7%BB%8D/">《利用Python进行数据分析·第2版》第13章 Python建模库介绍</a>
            
        </h1>
        <div class="content">
            <h1 id="《利用Python进行数据分析·第2版》第13章-Python建模库介绍"><a href="#《利用Python进行数据分析·第2版》第13章-Python建模库介绍" class="headerlink" title="《利用Python进行数据分析·第2版》第13章 Python建模库介绍"></a>《利用Python进行数据分析·第2版》第13章 Python建模库介绍</h1><hr>
<p>转载自<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
第13章 Python建模库介绍
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。</p>
<p>开发模型选用什么库取决于应用本身。许多统计问题可以用简单方法解决，比如普通的最小二乘回归，其它问题可能需要复杂的机器学习方法。幸运的是，Python已经成为了运用这些分析方法的语言之一，因此读完此书，你可以探索许多工具。</p>
<p>本章中，我会回顾一些pandas的特点，在你胶着于pandas数据规整和模型拟合和评分时，它们可能派上用场。然后我会简短介绍两个流行的建模工具，statsmodels和scikit-learn。这二者每个都值得再写一本书，我就不做全面的介绍，而是建议你学习两个项目的线上文档和其它基于Python的数据科学、统计和机器学习的书籍。</p>
<h1 id="13-1-pandas与模型代码的接口"><a href="#13-1-pandas与模型代码的接口" class="headerlink" title="13.1 pandas与模型代码的接口"></a>13.1 pandas与模型代码的接口</h1><p>模型开发的通常工作流是使用pandas进行数据加载和清洗，然后切换到建模库进行建模。开发模型的重要一环是机器学习中的“特征工程”。它可以描述从原始数据集中提取信息的任何数据转换或分析，这些数据集可能在建模中有用。本书中学习的数据聚合和GroupBy工具常用于特征工程中。</p>
<p>优秀的特征工程超出了本书的范围，我会尽量直白地介绍一些用于数据操作和建模切换的方法。</p>
<p>pandas与其它分析库通常是靠NumPy的数组联系起来的。将DataFrame转换为NumPy数组，可以使用.values属性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">0.01</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">0.</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">-1.5</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">3.6</span>, <span class="hljs-number">1.3</span>, <span class="hljs-number">-2.</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: data</span><br><span class="line">Out[<span class="hljs-number">13</span>]: </span><br><span class="line">   x0    x1    y</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: data.columns</span><br><span class="line">Out[<span class="hljs-number">14</span>]: Index([<span class="hljs-string">'x0'</span>, <span class="hljs-string">'x1'</span>, <span class="hljs-string">'y'</span>], dtype=<span class="hljs-string">'object'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: data.values</span><br><span class="line">Out[<span class="hljs-number">15</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>, <span class="hljs-number">-1.5</span> ],</span><br><span class="line">       [ <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>,  <span class="hljs-number">0.</span>  ],</span><br><span class="line">       [ <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>,  <span class="hljs-number">3.6</span> ],</span><br><span class="line">       [ <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ,  <span class="hljs-number">1.3</span> ],</span><br><span class="line">       [ <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  , <span class="hljs-number">-2.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>要转换回DataFrame，可以传递一个二维ndarray，可带有列名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">16</span>]: df2 = pd.DataFrame(data.values, columns=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line">   one   two  three</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">0.01</span>   <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">2.0</span> <span class="hljs-number">-0.01</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">3.0</span>  <span class="hljs-number">0.25</span>    <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">4.0</span> <span class="hljs-number">-4.10</span>    <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">0.00</span>   <span class="hljs-number">-2.0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：最好当数据是均匀的时候使用.values属性。例如，全是数值类型。如果数据是不均匀的，结果会是Python对象的ndarray：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: df3 = data.copy()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: df3[<span class="hljs-string">'strings'</span>] = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: df3</span><br><span class="line">Out[<span class="hljs-number">20</span>]: </span><br><span class="line">  x0    x1    y strings</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>       a</span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>       b</span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>       c</span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>       d</span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>       e</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: df3.values</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">array([[<span class="hljs-number">1</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">-1.5</span>, <span class="hljs-string">'a'</span>],</span><br><span class="line">      [<span class="hljs-number">2</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.0</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">      [<span class="hljs-number">3</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">3.6</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">      [<span class="hljs-number">4</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">1.3</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">      [<span class="hljs-number">5</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">-2.0</span>, <span class="hljs-string">'e'</span>]], dtype=object)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对于一些模型，你可能只想使用列的子集。我建议你使用loc，用values作索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">22</span>]: model_cols = [<span class="hljs-string">'x0'</span>, <span class="hljs-string">'x1'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: data.loc[:, model_cols].values</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>],</span><br><span class="line">       [ <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ],</span><br><span class="line">       [ <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>一些库原生支持pandas，会自动完成工作：从DataFrame转换到NumPy，将模型的参数名添加到输出表的列或Series。其它情况，你可以手工进行“元数据管理”。</p>
<p>在第12章，我们学习了pandas的Categorical类型和pandas.get_dummies函数。假设数据集中有一个非数值列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: data[<span class="hljs-string">'category'</span>] = pd.Categorical([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                                   categories=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: data</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">   x0    x1    y category</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>        a</span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>        b</span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>        a</span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>        a</span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>        b</span><br></pre></td></tr></table></figure>

<p>如果我们想替换category列为虚变量，我们可以创建虚变量，删除category列，然后添加到结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">26</span>]: dummies = pd.get_dummies(data.category, prefix=<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: data_with_dummies = data.drop(<span class="hljs-string">'category'</span>, axis=<span class="hljs-number">1</span>).join(dummies)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: data_with_dummies</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">   x0    x1    y  category_a  category_b</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>用虚变量拟合某些统计模型会有一些细微差别。当你不只有数字列时，使用Patsy（下一节的主题）可能更简单，更不容易出错。</p>
<h1 id="13-2-用Patsy创建模型描述"><a href="#13-2-用Patsy创建模型描述" class="headerlink" title="13.2 用Patsy创建模型描述"></a>13.2 用Patsy创建模型描述</h1><p>Patsy是Python的一个库，使用简短的字符串“公式语法”描述统计模型（尤其是线性模型），可能是受到了R和S统计编程语言的公式语法的启发。</p>
<p>Patsy适合描述statsmodels的线性模型，因此我会关注于它的主要特点，让你尽快掌握。Patsy的公式是一个特殊的字符串语法，如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y ~ x0 + x1</span><br></pre></td></tr></table></figure>

<p>a+b不是将a与b相加的意思，而是为模型创建的设计矩阵。patsy.dmatrices函数接收一个公式字符串和一个数据集（可以是DataFrame或数组的字典），为线性模型创建设计矩阵：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">0.01</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">0.</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">-1.5</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">3.6</span>, <span class="hljs-number">1.3</span>, <span class="hljs-number">-2.</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: data</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">   x0    x1    y</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: <span class="hljs-keyword">import</span> patsy</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ x0 + x1'</span>, data)</span><br></pre></td></tr></table></figure>

<p>现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: y</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">1</span>)</span><br><span class="line">     y</span><br><span class="line">  <span class="hljs-number">-1.5</span></span><br><span class="line">   <span class="hljs-number">0.0</span></span><br><span class="line">   <span class="hljs-number">3.6</span></span><br><span class="line">   <span class="hljs-number">1.3</span></span><br><span class="line">  <span class="hljs-number">-2.0</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'y'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: X</span><br><span class="line">Out[<span class="hljs-number">34</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  x0     x1</span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">1</span>   <span class="hljs-number">0.01</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">2</span>  <span class="hljs-number">-0.01</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">3</span>   <span class="hljs-number">0.25</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">4</span>  <span class="hljs-number">-4.10</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">5</span>   <span class="hljs-number">0.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'x1'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>这些Patsy的DesignMatrix实例是NumPy的ndarray，带有附加元数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: np.asarray(y)</span><br><span class="line">Out[<span class="hljs-number">35</span>]: </span><br><span class="line">array([[<span class="hljs-number">-1.5</span>],</span><br><span class="line">       [ <span class="hljs-number">0.</span> ],</span><br><span class="line">       [ <span class="hljs-number">3.6</span>],</span><br><span class="line">       [ <span class="hljs-number">1.3</span>],</span><br><span class="line">       [<span class="hljs-number">-2.</span> ]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: np.asarray(X)</span><br><span class="line">Out[<span class="hljs-number">36</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>你可能想Intercept是哪里来的。这是线性模型（比如普通最小二乘回归）的惯例用法。添加 +0 到模型可以不显示intercept：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">37</span>]: patsy.dmatrices(<span class="hljs-string">'y ~ x0 + x1 + 0'</span>, data)[<span class="hljs-number">1</span>]</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  x0     x1</span><br><span class="line">   <span class="hljs-number">1</span>   <span class="hljs-number">0.01</span></span><br><span class="line">   <span class="hljs-number">2</span>  <span class="hljs-number">-0.01</span></span><br><span class="line">   <span class="hljs-number">3</span>   <span class="hljs-number">0.25</span></span><br><span class="line">   <span class="hljs-number">4</span>  <span class="hljs-number">-4.10</span></span><br><span class="line">   <span class="hljs-number">5</span>   <span class="hljs-number">0.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x1'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy对象可以直接传递到算法（比如numpy.linalg.lstsq）中，它执行普通最小二乘回归：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">38</span>]: coef, resid, _, _ = np.linalg.lstsq(X, y)</span><br></pre></td></tr></table></figure>

<p>模型的元数据保留在design_info属性中，因此你可以重新附加列名到拟合系数，以获得一个Series，例如：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: coef</span><br><span class="line">Out[<span class="hljs-number">39</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.3129</span>],</span><br><span class="line">       [<span class="hljs-number">-0.0791</span>],</span><br><span class="line">       [<span class="hljs-number">-0.2655</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: coef = pd.Series(coef.squeeze(), index=X.design_info.column_names)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: coef</span><br><span class="line">Out[<span class="hljs-number">41</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.312910</span></span><br><span class="line">x0          <span class="hljs-number">-0.079106</span></span><br><span class="line">x1          <span class="hljs-number">-0.265464</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="用Patsy公式进行数据转换"><a href="#用Patsy公式进行数据转换" class="headerlink" title="用Patsy公式进行数据转换"></a>用Patsy公式进行数据转换</h2><p>你可以将Python代码与patsy公式结合。在评估公式时，库将尝试查找在封闭作用域内使用的函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">42</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ x0 + np.log(np.abs(x1) + 1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: X</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  x0  np.log(np.abs(x1) + <span class="hljs-number">1</span>)</span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">1</span>                 <span class="hljs-number">0.00995</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">2</span>                 <span class="hljs-number">0.00995</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">3</span>                 <span class="hljs-number">0.22314</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">4</span>                 <span class="hljs-number">1.62924</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">5</span>                 <span class="hljs-number">0.00000</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'np.log(np.abs(x1) + 1)'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>常见的变量转换包括标准化（平均值为0，方差为1）和中心化（减去平均值）。Patsy有内置的函数进行这样的工作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ standardize(x0) + center(x1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">45</span>]: X</span><br><span class="line">Out[<span class="hljs-number">45</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  standardize(x0)  center(x1)</span><br><span class="line">          <span class="hljs-number">1</span>         <span class="hljs-number">-1.41421</span>        <span class="hljs-number">0.78</span></span><br><span class="line">          <span class="hljs-number">1</span>         <span class="hljs-number">-0.70711</span>        <span class="hljs-number">0.76</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0.00000</span>        <span class="hljs-number">1.02</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0.70711</span>       <span class="hljs-number">-3.33</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1.41421</span>        <span class="hljs-number">0.77</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'standardize(x0)'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'center(x1)'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>作为建模的一步，你可能拟合模型到一个数据集，然后用另一个数据集评估模型。另一个数据集可能是剩余的部分或是新数据。当执行中心化和标准化转变，用新数据进行预测要格外小心。因为你必须使用平均值或标准差转换新数据集，这也称作状态转换。</p>
<p>patsy.build_design_matrices函数可以使用原始样本数据集的保存信息，来转换新数据，：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">46</span>]: new_data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">3.1</span>, <span class="hljs-number">-0.5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2.3</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: new_X = patsy.build_design_matrices([X.design_info], new_data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: new_X</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line">[DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>)</span><br><span class="line">   Intercept  standardize(x0)  center(x1)</span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">2.12132</span>        <span class="hljs-number">3.87</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">2.82843</span>        <span class="hljs-number">0.27</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">3.53553</span>        <span class="hljs-number">0.77</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">4.24264</span>        <span class="hljs-number">3.07</span></span><br><span class="line">   Terms:</span><br><span class="line">     <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">     <span class="hljs-string">'standardize(x0)'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">     <span class="hljs-string">'center(x1)'</span> (column <span class="hljs-number">2</span>)]</span><br></pre></td></tr></table></figure>

<p>因为Patsy中的加号不是加法的意义，当你按照名称将数据集的列相加时，你必须用特殊I函数将它们封装起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ I(x0 + x1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">50</span>]: X</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  I(x0 + x1)</span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">1.01</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">1.99</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">3.25</span></span><br><span class="line">          <span class="hljs-number">1</span>       <span class="hljs-number">-0.10</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">5.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'I(x0 + x1)'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy的patsy.builtins模块还有一些其它的内置转换。请查看线上文档。</p>
<p>分类数据有一个特殊的转换类，下面进行讲解。</p>
<h2 id="分类数据和Patsy"><a href="#分类数据和Patsy" class="headerlink" title="分类数据和Patsy"></a>分类数据和Patsy</h2><p>非数值数据可以用多种方式转换为模型设计矩阵。完整的讲解超出了本书范围，最好和统计课一起学习。</p>
<p>当你在Patsy公式中使用非数值数据，它们会默认转换为虚变量。如果有截距，会去掉一个，避免共线性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">51</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'key1'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'key2'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'v1'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'v2'</span>: [<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2.5</span>, <span class="hljs-number">-0.5</span>, <span class="hljs-number">4.0</span>, <span class="hljs-number">-1.2</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">-1.7</span>]</span><br><span class="line">   ....: &#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">52</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: X</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  key1[T.b]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>如果你从模型中忽略截距，每个分类值的列都会包括在设计矩阵的模型中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + 0'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: X</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  key1[a]  key1[b]</span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'key1'</span> (columns <span class="hljs-number">0</span>:<span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>使用C函数，数值列可以截取为分类量：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ C(key2)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">57</span>]: X</span><br><span class="line">Out[<span class="hljs-number">57</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  C(key2)[T<span class="hljs-number">.1</span>]</span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'C(key2)'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>当你在模型中使用多个分类名，事情就会变复杂，因为会包括key1:key2形式的相交部分，它可以用在方差（ANOVA）模型分析中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">58</span>]: data[<span class="hljs-string">'key2'</span>] = data[<span class="hljs-string">'key2'</span>].map(&#123;<span class="hljs-number">0</span>: <span class="hljs-string">'zero'</span>, <span class="hljs-number">1</span>: <span class="hljs-string">'one'</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: data</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line">  key1  key2  v1   v2</span><br><span class="line"><span class="hljs-number">0</span>    a  zero   <span class="hljs-number">1</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    a   one   <span class="hljs-number">2</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>    b  zero   <span class="hljs-number">3</span>  <span class="hljs-number">2.5</span></span><br><span class="line"><span class="hljs-number">3</span>    b   one   <span class="hljs-number">4</span> <span class="hljs-number">-0.5</span></span><br><span class="line"><span class="hljs-number">4</span>    a  zero   <span class="hljs-number">5</span>  <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">5</span>    b   one   <span class="hljs-number">6</span> <span class="hljs-number">-1.2</span></span><br><span class="line"><span class="hljs-number">6</span>    a  zero   <span class="hljs-number">7</span>  <span class="hljs-number">0.2</span></span><br><span class="line"><span class="hljs-number">7</span>    b  zero   <span class="hljs-number">8</span> <span class="hljs-number">-1.7</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + key2'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: X</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  key1[T.b]  key2[T.zero]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'key2'</span> (column <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + key2 + key1:key2'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: X</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">4</span>)</span><br><span class="line">  Intercept  key1[T.b]  key2[T.zero]</span><br><span class="line">key1[T.b]:key2[T.zero]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'key2'</span> (column <span class="hljs-number">2</span>)</span><br><span class="line">    <span class="hljs-string">'key1:key2'</span> (column <span class="hljs-number">3</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy提供转换分类数据的其它方法，包括以特定顺序转换。请参阅线上文档。</p>
<h1 id="13-3-statsmodels介绍"><a href="#13-3-statsmodels介绍" class="headerlink" title="13.3 statsmodels介绍"></a>13.3 statsmodels介绍</h1><p>statsmodels是Python进行拟合多种统计模型、进行统计试验和数据探索可视化的库。Statsmodels包含许多经典的统计方法，但没有贝叶斯方法和机器学习模型。</p>
<p>statsmodels包含的模型有：</p>
<ul>
<li>线性模型，广义线性模型和健壮线性模型</li>
<li>线性混合效应模型</li>
<li>方差（ANOVA）方法分析</li>
<li>时间序列过程和状态空间模型</li>
<li>广义矩估计</li>
</ul>
<p>下面，我会使用一些基本的statsmodels工具，探索Patsy公式和pandasDataFrame对象如何使用模型接口。</p>
<h2 id="估计线性模型"><a href="#估计线性模型" class="headerlink" title="估计线性模型"></a>估计线性模型</h2><p>statsmodels有多种线性回归模型，包括从基本（比如普通最小二乘）到复杂（比如迭代加权最小二乘法）的。</p>
<p>statsmodels的线性模型有两种不同的接口：基于数组和基于公式。它们可以通过API模块引入：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm</span><br><span class="line"><span class="hljs-keyword">import</span> statsmodels.formula.api <span class="hljs-keyword">as</span> smf</span><br></pre></td></tr></table></figure>

<p>为了展示它们的使用方法，我们从一些随机数据生成一个线性模型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dnorm</span><span class="hljs-params">(mean, variance, size=<span class="hljs-number">1</span>)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">if</span> isinstance(size, int):</span><br><span class="line">        size = size,</span><br><span class="line">    <span class="hljs-keyword">return</span> mean + np.sqrt(variance) * np.random.randn(*size)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># For reproducibility</span></span><br><span class="line">np.random.seed(<span class="hljs-number">12345</span>)</span><br><span class="line"></span><br><span class="line">N = <span class="hljs-number">100</span></span><br><span class="line">X = np.c_[dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.4</span>, size=N),</span><br><span class="line">          dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>, size=N),</span><br><span class="line">          dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, size=N)]</span><br><span class="line">eps = dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, size=N)</span><br><span class="line">beta = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.5</span>]</span><br><span class="line"></span><br><span class="line">y = np.dot(X, beta) + eps</span><br></pre></td></tr></table></figure>

<p>这里，我使用了“真实”模型和可知参数beta。此时，dnorm可用来生成正态分布数据，带有特定均值和方差。现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: X[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">66</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.1295</span>, <span class="hljs-number">-1.2128</span>,  <span class="hljs-number">0.5042</span>],</span><br><span class="line">       [ <span class="hljs-number">0.3029</span>, <span class="hljs-number">-0.4357</span>, <span class="hljs-number">-0.2542</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3285</span>, <span class="hljs-number">-0.0253</span>,  <span class="hljs-number">0.1384</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3515</span>, <span class="hljs-number">-0.7196</span>, <span class="hljs-number">-0.2582</span>],</span><br><span class="line">       [ <span class="hljs-number">1.2433</span>, <span class="hljs-number">-0.3738</span>, <span class="hljs-number">-0.5226</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: y[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">67</span>]: array([ <span class="hljs-number">0.4279</span>, <span class="hljs-number">-0.6735</span>, <span class="hljs-number">-0.0909</span>, <span class="hljs-number">-0.4895</span>,<span class="hljs-number">-0.1289</span>])</span><br></pre></td></tr></table></figure>

<p>像之前Patsy看到的，线性模型通常要拟合一个截距。sm.add_constant函数可以添加一个截距的列到现存的矩阵：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: X_model = sm.add_constant(X)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">69</span>]: X_model[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">69</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.1295</span>, <span class="hljs-number">-1.2128</span>,  <span class="hljs-number">0.5042</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    ,  <span class="hljs-number">0.3029</span>, <span class="hljs-number">-0.4357</span>, <span class="hljs-number">-0.2542</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.3285</span>, <span class="hljs-number">-0.0253</span>,  <span class="hljs-number">0.1384</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.3515</span>, <span class="hljs-number">-0.7196</span>, <span class="hljs-number">-0.2582</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    ,  <span class="hljs-number">1.2433</span>, <span class="hljs-number">-0.3738</span>, <span class="hljs-number">-0.5226</span>]])</span><br></pre></td></tr></table></figure>

<p>sm.OLS类可以拟合一个普通最小二乘回归：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">70</span>]: model = sm.OLS(y, X)</span><br></pre></td></tr></table></figure>

<p>这个模型的fit方法返回了一个回归结果对象，它包含估计的模型参数和其它内容：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">71</span>]: results = model.fit()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">72</span>]: array([ <span class="hljs-number">0.1783</span>,  <span class="hljs-number">0.223</span> ,  <span class="hljs-number">0.501</span> ])</span><br></pre></td></tr></table></figure>

<p>对结果使用summary方法可以打印模型的详细诊断结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: print(results.summary())</span><br><span class="line">OLS Regression Results                            </span><br><span class="line">==============================================================================</span><br><span class="line">Dep. Variable:                      y   R-squared:                       <span class="hljs-number">0.430</span></span><br><span class="line">Model:                            OLS   Adj. R-squared:                  <span class="hljs-number">0.413</span></span><br><span class="line">Method:                 Least Squares   F-statistic:                     <span class="hljs-number">24.42</span></span><br><span class="line">Date:                Mon, <span class="hljs-number">25</span> Sep <span class="hljs-number">2017</span>   Prob (F-statistic):           <span class="hljs-number">7.44e-12</span></span><br><span class="line">Time:                        <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">15</span>   Log-Likelihood:                <span class="hljs-number">-34.305</span></span><br><span class="line">No. Observations:                 <span class="hljs-number">100</span>   AIC:                             <span class="hljs-number">74.61</span></span><br><span class="line">Df Residuals:                      <span class="hljs-number">97</span>   BIC:                             <span class="hljs-number">82.42</span></span><br><span class="line">Df Model:                           <span class="hljs-number">3</span>                                         </span><br><span class="line">Covariance Type:            nonrobust                                         </span><br><span class="line">==============================================================================</span><br><span class="line">                 coef    std err          t      P&gt;|t|      [<span class="hljs-number">0.025</span>      <span class="hljs-number">0.975</span>]</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">x1             <span class="hljs-number">0.1783</span>      <span class="hljs-number">0.053</span>      <span class="hljs-number">3.364</span>      <span class="hljs-number">0.001</span>       <span class="hljs-number">0.073</span>       <span class="hljs-number">0.283</span></span><br><span class="line">x2             <span class="hljs-number">0.2230</span>      <span class="hljs-number">0.046</span>      <span class="hljs-number">4.818</span>      <span class="hljs-number">0.000</span>       <span class="hljs-number">0.131</span>       <span class="hljs-number">0.315</span></span><br><span class="line">x3             <span class="hljs-number">0.5010</span>      <span class="hljs-number">0.080</span>      <span class="hljs-number">6.237</span>      <span class="hljs-number">0.000</span>       <span class="hljs-number">0.342</span>       <span class="hljs-number">0.660</span></span><br><span class="line">==============================================================================</span><br><span class="line">Omnibus:                        <span class="hljs-number">4.662</span>   Durbin-Watson:                   <span class="hljs-number">2.201</span></span><br><span class="line">Prob(Omnibus):                  <span class="hljs-number">0.097</span>   Jarque-Bera (JB):                <span class="hljs-number">4.098</span></span><br><span class="line">Skew:                           <span class="hljs-number">0.481</span>   Prob(JB):                        <span class="hljs-number">0.129</span></span><br><span class="line">Kurtosis:                       <span class="hljs-number">3.243</span>   Cond. No.</span><br><span class="line"><span class="hljs-number">1.74</span></span><br><span class="line">==============================================================================</span><br><span class="line">Warnings:</span><br><span class="line">[<span class="hljs-number">1</span>] Standard Errors assume that the covariance matrix of the errors <span class="hljs-keyword">is</span> correctly </span><br><span class="line">specified.</span><br></pre></td></tr></table></figure>

<p>这里的参数名为通用名x1, x2等等。假设所有的模型参数都在一个DataFrame中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: data = pd.DataFrame(X, columns=[<span class="hljs-string">'col0'</span>, <span class="hljs-string">'col1'</span>, <span class="hljs-string">'col2'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">75</span>]: data[<span class="hljs-string">'y'</span>] = y</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: data[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">       col0      col1      col2         y</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.129468</span> <span class="hljs-number">-1.212753</span>  <span class="hljs-number">0.504225</span>  <span class="hljs-number">0.427863</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.302910</span> <span class="hljs-number">-0.435742</span> <span class="hljs-number">-0.254180</span> <span class="hljs-number">-0.673480</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.328522</span> <span class="hljs-number">-0.025302</span>  <span class="hljs-number">0.138351</span> <span class="hljs-number">-0.090878</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.351475</span> <span class="hljs-number">-0.719605</span> <span class="hljs-number">-0.258215</span> <span class="hljs-number">-0.489494</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.243269</span> <span class="hljs-number">-0.373799</span> <span class="hljs-number">-0.522629</span> <span class="hljs-number">-0.128941</span></span><br></pre></td></tr></table></figure>

<p>现在，我们使用statsmodels的公式API和Patsy的公式字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">77</span>]: results = smf.ols(<span class="hljs-string">'y ~ col0 + col1 + col2'</span>, data=data).fit()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.033559</span></span><br><span class="line">col0         <span class="hljs-number">0.176149</span></span><br><span class="line">col1         <span class="hljs-number">0.224826</span></span><br><span class="line">col2         <span class="hljs-number">0.514808</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">79</span>]: results.tvalues</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.952188</span></span><br><span class="line">col0         <span class="hljs-number">3.319754</span></span><br><span class="line">col1         <span class="hljs-number">4.850730</span></span><br><span class="line">col2         <span class="hljs-number">6.303971</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>观察下statsmodels是如何返回Series结果的，附带有DataFrame的列名。当使用公式和pandas对象时，我们不需要使用add_constant。</p>
<p>给出一个样本外数据，你可以根据估计的模型参数计算预测值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">80</span>]: results.predict(data[:<span class="hljs-number">5</span>])</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">-0.002327</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">-0.141904</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">0.041226</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">-0.323070</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">-0.100535</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>statsmodels的线性模型结果还有其它的分析、诊断和可视化工具。除了普通最小二乘模型，还有其它的线性模型。</p>
<h2 id="估计时间序列过程"><a href="#估计时间序列过程" class="headerlink" title="估计时间序列过程"></a>估计时间序列过程</h2><p>statsmodels的另一模型类是进行时间序列分析，包括自回归过程、卡尔曼滤波和其它态空间模型，和多元自回归模型。</p>
<p>用自回归结构和噪声来模拟一些时间序列数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">init_x = <span class="hljs-number">4</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> random</span><br><span class="line">values = [init_x, init_x]</span><br><span class="line">N = <span class="hljs-number">1000</span></span><br><span class="line"></span><br><span class="line">b0 = <span class="hljs-number">0.8</span></span><br><span class="line">b1 = <span class="hljs-number">-0.4</span></span><br><span class="line">noise = dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, N)</span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(N):</span><br><span class="line">    new_x = values[<span class="hljs-number">-1</span>] * b0 + values[<span class="hljs-number">-2</span>] * b1 + noise[i]</span><br><span class="line">    values.append(new_x)</span><br></pre></td></tr></table></figure>

<p>这个数据有AR(2)结构（两个延迟），参数是0.8和-0.4。拟合AR模型时，你可能不知道滞后项的个数，因此可以用较多的滞后量来拟合这个模型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: MAXLAGS = <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: model = sm.tsa.AR(values)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: results = model.fit(MAXLAGS)</span><br></pre></td></tr></table></figure>

<p>结果中的估计参数首先是截距，其次是前两个参数的估计值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">85</span>]: array([<span class="hljs-number">-0.0062</span>,  <span class="hljs-number">0.7845</span>, <span class="hljs-number">-0.4085</span>, <span class="hljs-number">-0.0136</span>,  <span class="hljs-number">0.015</span> ,  <span class="hljs-number">0.0143</span>])</span><br></pre></td></tr></table></figure>

<p>更多的细节以及如何解释结果超出了本书的范围，可以通过statsmodels文档学习更多。</p>
<h1 id="13-4-scikit-learn介绍"><a href="#13-4-scikit-learn介绍" class="headerlink" title="13.4 scikit-learn介绍"></a>13.4 scikit-learn介绍</h1><p>scikit-learn是一个广泛使用、用途多样的Python机器学习库。它包含多种标准监督和非监督机器学习方法和模型选择和评估、数据转换、数据加载和模型持久化工具。这些模型可以用于分类、聚合、预测和其它任务。</p>
<p>机器学习方面的学习和应用scikit-learn和TensorFlow解决实际问题的线上和纸质资料很多。本节中，我会简要介绍scikit-learn API的风格。</p>
<p>写作此书的时候，scikit-learn并没有和pandas深度结合，但是有些第三方包在开发中。尽管如此，pandas非常适合在模型拟合前处理数据集。</p>
<p>举个例子，我用一个Kaggle竞赛的经典数据集，关于泰坦尼克号乘客的生还率。我们用pandas加载测试和训练数据集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: train = pd.read_csv(<span class="hljs-string">'datasets/titanic/train.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">87</span>]: test = pd.read_csv(<span class="hljs-string">'datasets/titanic/test.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: train[:<span class="hljs-number">4</span>]</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">   PassengerId  Survived  Pclass  \</span><br><span class="line"><span class="hljs-number">0</span>            <span class="hljs-number">1</span>         <span class="hljs-number">0</span>       <span class="hljs-number">3</span>   </span><br><span class="line"><span class="hljs-number">1</span>            <span class="hljs-number">2</span>         <span class="hljs-number">1</span>       <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">2</span>            <span class="hljs-number">3</span>         <span class="hljs-number">1</span>       <span class="hljs-number">3</span>   </span><br><span class="line"><span class="hljs-number">3</span>            <span class="hljs-number">4</span>         <span class="hljs-number">1</span>       <span class="hljs-number">1</span>   </span><br><span class="line">                                                Name     Sex   Age  SibSp  \</span><br><span class="line"><span class="hljs-number">0</span>                            Braund, Mr. Owen Harris    male  <span class="hljs-number">22.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">1</span>  Cumings, Mrs. John Bradley (Florence Briggs Th...  female  <span class="hljs-number">38.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">2</span>                             Heikkinen, Miss. Laina  female  <span class="hljs-number">26.0</span>      <span class="hljs-number">0</span>   </span><br><span class="line"><span class="hljs-number">3</span>       Futrelle, Mrs. Jacques Heath (Lily May Peel)  female  <span class="hljs-number">35.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line">   Parch            Ticket     Fare Cabin Embarked  </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>         A/<span class="hljs-number">5</span> <span class="hljs-number">21171</span>   <span class="hljs-number">7.2500</span>   NaN        S  </span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">0</span>          PC <span class="hljs-number">17599</span>  <span class="hljs-number">71.2833</span>   C85        C  </span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">0</span>  STON/O2. <span class="hljs-number">3101282</span>   <span class="hljs-number">7.9250</span>   NaN        S  </span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">0</span>            <span class="hljs-number">113803</span>  <span class="hljs-number">53.1000</span>  C123        S</span><br></pre></td></tr></table></figure>

<p>statsmodels和scikit-learn通常不能接收缺失数据，因此我们要查看列是否包含缺失值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">89</span>]: train.isnull().sum()</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">PassengerId      <span class="hljs-number">0</span></span><br><span class="line">Survived         <span class="hljs-number">0</span></span><br><span class="line">Pclass           <span class="hljs-number">0</span></span><br><span class="line">Name             <span class="hljs-number">0</span></span><br><span class="line">Sex              <span class="hljs-number">0</span></span><br><span class="line">Age            <span class="hljs-number">177</span></span><br><span class="line">SibSp            <span class="hljs-number">0</span></span><br><span class="line">Parch            <span class="hljs-number">0</span></span><br><span class="line">Ticket           <span class="hljs-number">0</span></span><br><span class="line">Fare             <span class="hljs-number">0</span></span><br><span class="line">Cabin          <span class="hljs-number">687</span></span><br><span class="line">Embarked         <span class="hljs-number">2</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: test.isnull().sum()</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">PassengerId      <span class="hljs-number">0</span></span><br><span class="line">Pclass           <span class="hljs-number">0</span></span><br><span class="line">Name             <span class="hljs-number">0</span></span><br><span class="line">Sex              <span class="hljs-number">0</span></span><br><span class="line">Age             <span class="hljs-number">86</span></span><br><span class="line">SibSp            <span class="hljs-number">0</span></span><br><span class="line">Parch            <span class="hljs-number">0</span></span><br><span class="line">Ticket           <span class="hljs-number">0</span></span><br><span class="line">Fare             <span class="hljs-number">1</span></span><br><span class="line">Cabin          <span class="hljs-number">327</span></span><br><span class="line">Embarked         <span class="hljs-number">0</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>在统计和机器学习的例子中，根据数据中的特征，一个典型的任务是预测乘客能否生还。模型现在训练数据集中拟合，然后用样本外测试数据集评估。</p>
<p>我想用年龄作为预测值，但是它包含缺失值。缺失数据补全的方法有多种，我用的是一种简单方法，用训练数据集的中位数补全两个表的空值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: impute_value = train[<span class="hljs-string">'Age'</span>].median()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: train[<span class="hljs-string">'Age'</span>] = train[<span class="hljs-string">'Age'</span>].fillna(impute_value)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: test[<span class="hljs-string">'Age'</span>] = test[<span class="hljs-string">'Age'</span>].fillna(impute_value)</span><br></pre></td></tr></table></figure>

<p>现在我们需要指定模型。我增加了一个列IsFemale，作为“Sex”列的编码：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: train[<span class="hljs-string">'IsFemale'</span>] = (train[<span class="hljs-string">'Sex'</span>] == <span class="hljs-string">'female'</span>).astype(int)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: test[<span class="hljs-string">'IsFemale'</span>] = (test[<span class="hljs-string">'Sex'</span>] == <span class="hljs-string">'female'</span>).astype(int)</span><br></pre></td></tr></table></figure>

<p>然后，我们确定一些模型变量，并创建NumPy数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: predictors = [<span class="hljs-string">'Pclass'</span>, <span class="hljs-string">'IsFemale'</span>, <span class="hljs-string">'Age'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: X_train = train[predictors].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: X_test = test[predictors].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: y_train = train[<span class="hljs-string">'Survived'</span>].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: X_train[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">100</span>]: </span><br><span class="line">array([[  <span class="hljs-number">3.</span>,   <span class="hljs-number">0.</span>,  <span class="hljs-number">22.</span>],</span><br><span class="line">       [  <span class="hljs-number">1.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">38.</span>],</span><br><span class="line">       [  <span class="hljs-number">3.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">26.</span>],</span><br><span class="line">       [  <span class="hljs-number">1.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">35.</span>],</span><br><span class="line">       [  <span class="hljs-number">3.</span>,   <span class="hljs-number">0.</span>,  <span class="hljs-number">35.</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">101</span>]: y_train[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">101</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>我不能保证这是一个好模型，但它的特征都符合。我们用scikit-learn的LogisticRegression模型，创建一个模型实例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">102</span>]: <span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: model = LogisticRegression()</span><br></pre></td></tr></table></figure>

<p>与statsmodels类似，我们可以用模型的fit方法，将它拟合到训练数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">104</span>]: model.fit(X_train, y_train)</span><br><span class="line">Out[<span class="hljs-number">104</span>]: </span><br><span class="line">LogisticRegression(C=<span class="hljs-number">1.0</span>, class_weight=<span class="hljs-literal">None</span>, dual=<span class="hljs-literal">False</span>, fit_intercept=<span class="hljs-literal">True</span>,</span><br><span class="line">          intercept_scaling=<span class="hljs-number">1</span>, max_iter=<span class="hljs-number">100</span>, multi_class=<span class="hljs-string">'ovr'</span>, n_jobs=<span class="hljs-number">1</span>,</span><br><span class="line">          penalty=<span class="hljs-string">'l2'</span>, random_state=<span class="hljs-literal">None</span>, solver=<span class="hljs-string">'liblinear'</span>, tol=<span class="hljs-number">0.0001</span>,</span><br><span class="line">          verbose=<span class="hljs-number">0</span>, warm_start=<span class="hljs-literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>现在，我们可以用model.predict，对测试数据进行预测：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: y_predict = model.predict(X_test)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: y_predict[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">106</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>如果你有测试数据集的真实值，你可以计算准确率或其它错误度量值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(y_true == y_predict).mean()</span><br></pre></td></tr></table></figure>

<p>在实际中，模型训练经常有许多额外的复杂因素。许多模型有可以调节的参数，有些方法（比如交叉验证）可以用来进行参数调节，避免对训练数据过拟合。这通常可以提高预测性或对新数据的健壮性。</p>
<p>交叉验证通过分割训练数据来模拟样本外预测。基于模型的精度得分（比如均方差），可以对模型参数进行网格搜索。有些模型，如logistic回归，有内置的交叉验证的估计类。例如，logisticregressioncv类可以用一个参数指定网格搜索对模型的正则化参数C的粒度：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">107</span>]: <span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegressionCV</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">108</span>]: model_cv = LogisticRegressionCV(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">109</span>]: model_cv.fit(X_train, y_train)</span><br><span class="line">Out[<span class="hljs-number">109</span>]: </span><br><span class="line">LogisticRegressionCV(Cs=<span class="hljs-number">10</span>, class_weight=<span class="hljs-literal">None</span>, cv=<span class="hljs-literal">None</span>, dual=<span class="hljs-literal">False</span>,</span><br><span class="line">           fit_intercept=<span class="hljs-literal">True</span>, intercept_scaling=<span class="hljs-number">1.0</span>, max_iter=<span class="hljs-number">100</span>,</span><br><span class="line">           multi_class=<span class="hljs-string">'ovr'</span>, n_jobs=<span class="hljs-number">1</span>, penalty=<span class="hljs-string">'l2'</span>, random_state=<span class="hljs-literal">None</span>,</span><br><span class="line">           refit=<span class="hljs-literal">True</span>, scoring=<span class="hljs-literal">None</span>, solver=<span class="hljs-string">'lbfgs'</span>, tol=<span class="hljs-number">0.0001</span>, verbose=<span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>要手动进行交叉验证，你可以使用cross_val_score帮助函数，它可以处理数据分割。例如，要交叉验证我们的带有四个不重叠训练数据的模型，可以这样做：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">110</span>]: <span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">111</span>]: model = LogisticRegression(C=<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: scores = cross_val_score(model, X_train, y_train, cv=<span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: scores</span><br><span class="line">Out[<span class="hljs-number">113</span>]: array([ <span class="hljs-number">0.7723</span>,  <span class="hljs-number">0.8027</span>,  <span class="hljs-number">0.7703</span>,  <span class="hljs-number">0.7883</span>])</span><br></pre></td></tr></table></figure>

<p>默认的评分指标取决于模型本身，但是可以明确指定一个评分。交叉验证过的模型需要更长时间来训练，但会有更高的模型性能。</p>
<h1 id="13-5-继续学习"><a href="#13-5-继续学习" class="headerlink" title="13.5 继续学习"></a>13.5 继续学习</h1><p>我只是介绍了一些Python建模库的表面内容，现在有越来越多的框架用于各种统计和机器学习，它们都是用Python或Python用户界面实现的。</p>
<p>这本书的重点是数据规整，有其它的书是关注建模和数据科学工具的。其中优秀的有：</p>
<ul>
<li>Andreas Mueller and Sarah Guido (O’Reilly)的 《Introduction to Machine Learning with Python》</li>
<li>Jake VanderPlas (O’Reilly)的 《Python Data Science Handbook》</li>
<li>Joel Grus (O’Reilly) 的 《Data Science from Scratch: First Principles》</li>
<li>Sebastian Raschka (Packt Publishing) 的《Python Machine Learning》</li>
<li>Aurélien Géron (O’Reilly) 的《Hands-On Machine Learning with Scikit-Learn and TensorFlow》</li>
</ul>
<p>虽然书是学习的好资源，但是随着底层开源软件的发展，书的内容会过时。最好是不断熟悉各种统计和机器学习框架的文档，学习最新的功能和API。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7502 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC6%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E3%80%81%E5%AD%98%E5%82%A8%E4%B8%8E%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/">《利用Python进行数据分析·第2版》第6章 数据加载、存储与文件格式</a>
            
        </h1>
        <div class="content">
            <h1 id="《利用Python进行数据分析·第2版》第6章-数据加载、存储与文件格式"><a href="#《利用Python进行数据分析·第2版》第6章-数据加载、存储与文件格式" class="headerlink" title="《利用Python进行数据分析·第2版》第6章 数据加载、存储与文件格式"></a>《利用Python进行数据分析·第2版》第6章 数据加载、存储与文件格式</h1><hr>
<p>转载自<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
第6章 数据加载、存储与文件格式
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>访问数据是使用本书所介绍的这些工具的第一步。我会着重介绍pandas的数据输入与输出，虽然别的库中也有不少以此为目的的工具。</p>
<p>输入输出通常可以划分为几个大类：读取文本文件和其他更高效的磁盘存储格式，加载数据库中的数据，利用Web API操作网络资源。</p>
<h1 id="6-1-读写文本格式的数据"><a href="#6-1-读写文本格式的数据" class="headerlink" title="6.1 读写文本格式的数据"></a>6.1 读写文本格式的数据</h1><p>pandas提供了一些用于将表格型数据读取为DataFrame对象的函数。表6-1对它们进行了总结，其中read_csv和read_table可能会是你今后用得最多的。</p>
<p><img src="/images/blog/7178691-958f849e6067b19b.webp" alt="img"></p>
<p>表6-1 pandas中的解析函数</p>
<p>我将大致介绍一下这些函数在将文本数据转换为DataFrame时所用到的一些技术。这些函数的选项可以划分为以下几个大类：</p>
<ul>
<li>索引：将一个或多个列当做返回的DataFrame处理，以及是否从文件、用户获取列名。</li>
<li>类型推断和数据转换：包括用户定义值的转换、和自定义的缺失值标记列表等。</li>
<li>日期解析：包括组合功能，比如将分散在多个列中的日期时间信息组合成结果中的单个列。</li>
<li>迭代：支持对大文件进行逐块迭代。</li>
<li>不规整数据问题：跳过一些行、页脚、注释或其他一些不重要的东西（比如由成千上万个逗号隔开的数值数据）。</li>
</ul>
<p>因为工作中实际碰到的数据可能十分混乱，一些数据加载函数（尤其是read_csv）的选项逐渐变得复杂起来。面对不同的参数，感到头痛很正常（read_csv有超过50个参数）。pandas文档有这些参数的例子，如果你感到阅读某个文件很难，可以通过相似的足够多的例子找到正确的参数。</p>
<p>其中一些函数，比如pandas.read_csv，有类型推断功能，因为列数据的类型不属于数据类型。也就是说，你不需要指定列的类型到底是数值、整数、布尔值，还是字符串。其它的数据格式，如HDF5、Feather和msgpack，会在格式中存储数据类型。</p>
<p>日期和其他自定义类型的处理需要多花点工夫才行。首先我们来看一个以逗号分隔的（CSV）文本文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">8</span>]: !cat examples/ex1.csv</span><br><span class="line">a,b,c,d,message</span><br><span class="line"><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,hello</span><br><span class="line"><span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：这里，我用的是Unix的cat shell命令将文件的原始内容打印到屏幕上。如果你用的是Windows，你可以使用type达到同样的效果。</p>
</blockquote>
<p>由于该文件以逗号分隔，所以我们可以使用read_csv将其读入一个DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">9</span>]: df = pd.read_csv(<span class="hljs-string">'examples/ex1.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">10</span>]: df</span><br><span class="line">Out[<span class="hljs-number">10</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>我们还可以使用read_table，并指定分隔符：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">11</span>]: pd.read_table(<span class="hljs-string">'examples/ex1.csv'</span>, sep=<span class="hljs-string">','</span>)</span><br><span class="line">Out[<span class="hljs-number">11</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>并不是所有文件都有标题行。看看下面这个文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: !cat examples/ex2.csv</span><br><span class="line"><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,hello</span><br><span class="line"><span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<p>读入该文件的办法有两个。你可以让pandas为其分配默认的列名，也可以自己定义列名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">13</span>]: pd.read_csv(<span class="hljs-string">'examples/ex2.csv'</span>, header=<span class="hljs-literal">None</span>)</span><br><span class="line">Out[<span class="hljs-number">13</span>]: </span><br><span class="line">   <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>  hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>  world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>    foo</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: pd.read_csv(<span class="hljs-string">'examples/ex2.csv'</span>, names=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'message'</span>])</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>假设你希望将message列做成DataFrame的索引。你可以明确表示要将该列放到索引4的位置上，也可以通过index_col参数指定”message”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: names = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'message'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: pd.read_csv(<span class="hljs-string">'examples/ex2.csv'</span>, names=names, index_col=<span class="hljs-string">'message'</span>)</span><br><span class="line">Out[<span class="hljs-number">16</span>]: </span><br><span class="line">         a   b   c   d</span><br><span class="line">message               </span><br><span class="line">hello    <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span></span><br><span class="line">world    <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span></span><br><span class="line">foo      <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span></span><br></pre></td></tr></table></figure>

<p>如果希望将多个列做成一个层次化索引，只需传入由列编号或列名组成的列表即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: !cat examples/csv_mindex.csv</span><br><span class="line">key1,key2,value1,value2</span><br><span class="line">one,a,<span class="hljs-number">1</span>,<span class="hljs-number">2</span></span><br><span class="line">one,b,<span class="hljs-number">3</span>,<span class="hljs-number">4</span></span><br><span class="line">one,c,<span class="hljs-number">5</span>,<span class="hljs-number">6</span></span><br><span class="line">one,d,<span class="hljs-number">7</span>,<span class="hljs-number">8</span></span><br><span class="line">two,a,<span class="hljs-number">9</span>,<span class="hljs-number">10</span></span><br><span class="line">two,b,<span class="hljs-number">11</span>,<span class="hljs-number">12</span></span><br><span class="line">two,c,<span class="hljs-number">13</span>,<span class="hljs-number">14</span></span><br><span class="line">two,d,<span class="hljs-number">15</span>,<span class="hljs-number">16</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">18</span>]: parsed = pd.read_csv(<span class="hljs-string">'examples/csv_mindex.csv'</span>,</span><br><span class="line">   ....:                      index_col=[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: parsed</span><br><span class="line">Out[<span class="hljs-number">19</span>]: </span><br><span class="line">           value1  value2</span><br><span class="line">key1 key2                </span><br><span class="line">one  a          <span class="hljs-number">1</span>       <span class="hljs-number">2</span></span><br><span class="line">     b          <span class="hljs-number">3</span>       <span class="hljs-number">4</span></span><br><span class="line">     c          <span class="hljs-number">5</span>       <span class="hljs-number">6</span></span><br><span class="line">     d          <span class="hljs-number">7</span>       <span class="hljs-number">8</span></span><br><span class="line">two  a          <span class="hljs-number">9</span>      <span class="hljs-number">10</span></span><br><span class="line">     b         <span class="hljs-number">11</span>      <span class="hljs-number">12</span></span><br><span class="line">     c         <span class="hljs-number">13</span>      <span class="hljs-number">14</span></span><br><span class="line">     d         <span class="hljs-number">15</span>      <span class="hljs-number">16</span></span><br></pre></td></tr></table></figure>

<p>有些情况下，有些表格可能不是用固定的分隔符去分隔字段的（比如空白符或其它模式）。看看下面这个文本文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">20</span>]: list(open(<span class="hljs-string">'examples/ex3.txt'</span>))</span><br><span class="line">Out[<span class="hljs-number">20</span>]: </span><br><span class="line">[<span class="hljs-string">'            A         B         C\n'</span>,</span><br><span class="line"> <span class="hljs-string">'aaa -0.264438 -1.026059 -0.619500\n'</span>,</span><br><span class="line"> <span class="hljs-string">'bbb  0.927272  0.302904 -0.032399\n'</span>,</span><br><span class="line"> <span class="hljs-string">'ccc -0.264273 -0.386314 -0.217601\n'</span>,</span><br><span class="line"> <span class="hljs-string">'ddd -0.871858 -0.348382  1.100491\n'</span>]</span><br></pre></td></tr></table></figure>

<p>虽然可以手动对数据进行规整，这里的字段是被数量不同的空白字符间隔开的。这种情况下，你可以传递一个正则表达式作为read_table的分隔符。可以用正则表达式表达为\s+，于是有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">21</span>]: result = pd.read_table(<span class="hljs-string">'examples/ex3.txt'</span>, sep=<span class="hljs-string">'\s+'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: result</span><br><span class="line">Out[<span class="hljs-number">22</span>]: </span><br><span class="line">            A         B         C</span><br><span class="line">aaa <span class="hljs-number">-0.264438</span> <span class="hljs-number">-1.026059</span> <span class="hljs-number">-0.619500</span></span><br><span class="line">bbb  <span class="hljs-number">0.927272</span>  <span class="hljs-number">0.302904</span> <span class="hljs-number">-0.032399</span></span><br><span class="line">ccc <span class="hljs-number">-0.264273</span> <span class="hljs-number">-0.386314</span> <span class="hljs-number">-0.217601</span></span><br><span class="line">ddd <span class="hljs-number">-0.871858</span> <span class="hljs-number">-0.348382</span>  <span class="hljs-number">1.100491</span></span><br></pre></td></tr></table></figure>

<p>这里，由于列名比数据行的数量少，所以read_table推断第一列应该是DataFrame的索引。</p>
<p>这些解析器函数还有许多参数可以帮助你处理各种各样的异形文件格式（表6-2列出了一些）。比如说，你可以用skiprows跳过文件的第一行、第三行和第四行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">23</span>]: !cat examples/ex4.csv</span><br><span class="line"><span class="hljs-comment"># hey!</span></span><br><span class="line">a,b,c,d,message</span><br><span class="line"><span class="hljs-comment"># just wanted to make things more difficult for you</span></span><br><span class="line"><span class="hljs-comment"># who reads CSV files with computers, anyway?</span></span><br><span class="line"><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,hello</span><br><span class="line"><span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,foo</span><br><span class="line">In [<span class="hljs-number">24</span>]: pd.read_csv(<span class="hljs-string">'examples/ex4.csv'</span>, skiprows=[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])</span><br><span class="line">Out[<span class="hljs-number">24</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>缺失值处理是文件解析任务中的一个重要组成部分。缺失数据经常是要么没有（空字符串），要么用某个标记值表示。默认情况下，pandas会用一组经常出现的标记值进行识别，比如NA及NULL：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: !cat examples/ex5.csv</span><br><span class="line">something,a,b,c,d,message</span><br><span class="line">one,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,NA</span><br><span class="line">two,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,,<span class="hljs-number">8</span>,world</span><br><span class="line">three,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,foo</span><br><span class="line">In [<span class="hljs-number">26</span>]: result = pd.read_csv(<span class="hljs-string">'examples/ex5.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: result</span><br><span class="line">Out[<span class="hljs-number">27</span>]: </span><br><span class="line">  something  a   b     c   d message</span><br><span class="line"><span class="hljs-number">0</span>       one  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3.0</span>   <span class="hljs-number">4</span>     NaN</span><br><span class="line"><span class="hljs-number">1</span>       two  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   NaN   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>     three  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">12</span>     foo</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: pd.isnull(result)</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">   something      a      b      c      d  message</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>     <span class="hljs-literal">True</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>   <span class="hljs-literal">True</span>  <span class="hljs-literal">False</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>    <span class="hljs-literal">False</span></span><br></pre></td></tr></table></figure>

<p>na_values可以用一个列表或集合的字符串表示缺失值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: result = pd.read_csv(<span class="hljs-string">'examples/ex5.csv'</span>, na_values=[<span class="hljs-string">'NULL'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: result</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">  something  a   b     c   d message</span><br><span class="line"><span class="hljs-number">0</span>       one  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3.0</span>   <span class="hljs-number">4</span>     NaN</span><br><span class="line"><span class="hljs-number">1</span>       two  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   NaN   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>     three  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>字典的各列可以使用不同的NA标记值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: sentinels = &#123;<span class="hljs-string">'message'</span>: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'NA'</span>], <span class="hljs-string">'something'</span>: [<span class="hljs-string">'two'</span>]&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: pd.read_csv(<span class="hljs-string">'examples/ex5.csv'</span>, na_values=sentinels)</span><br><span class="line">Out[<span class="hljs-number">32</span>]:</span><br><span class="line">something  a   b     c   d message</span><br><span class="line"><span class="hljs-number">0</span>       one  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3.0</span>   <span class="hljs-number">4</span>     NaN</span><br><span class="line"><span class="hljs-number">1</span>       NaN  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   NaN   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>     three  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">12</span>     NaN</span><br></pre></td></tr></table></figure>

<p>表6-2列出了pandas.read_csv和pandas.read_table常用的选项。</p>
<p><img src="/images/blog/7178691-082daf4a00ed9494.webp" alt="img"></p>
<p><img src="/images/blog/7178691-f2bcc0a703c7236f.webp" alt="img"></p>
<p><img src="/images/blog/7178691-597327ade3e94c7a.webp" alt="img"></p>
<h2 id="逐块读取文本文件"><a href="#逐块读取文本文件" class="headerlink" title="逐块读取文本文件"></a>逐块读取文本文件</h2><p>在处理很大的文件时，或找出大文件中的参数集以便于后续处理时，你可能只想读取文件的一小部分或逐块对文件进行迭代。</p>
<p>在看大文件之前，我们先设置pandas显示地更紧些：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: pd.options.display.max_rows = <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>然后有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">34</span>]: result = pd.read_csv(<span class="hljs-string">'examples/ex6.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">35</span>]: result</span><br><span class="line">Out[<span class="hljs-number">35</span>]: </span><br><span class="line">           one       two     three      four key</span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">0.467976</span> <span class="hljs-number">-0.038649</span> <span class="hljs-number">-0.295344</span> <span class="hljs-number">-1.824726</span>   L</span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-0.358893</span>  <span class="hljs-number">1.404453</span>  <span class="hljs-number">0.704965</span> <span class="hljs-number">-0.200638</span>   B</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">-0.501840</span>  <span class="hljs-number">0.659254</span> <span class="hljs-number">-0.421691</span> <span class="hljs-number">-0.057688</span>   G</span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">0.204886</span>  <span class="hljs-number">1.074134</span>  <span class="hljs-number">1.388361</span> <span class="hljs-number">-0.982404</span>   R</span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">0.354628</span> <span class="hljs-number">-0.133116</span>  <span class="hljs-number">0.283763</span> <span class="hljs-number">-0.837063</span>   Q</span><br><span class="line"><span class="hljs-meta">... </span>       ...       ...       ...       ...  ..</span><br><span class="line"><span class="hljs-number">9995</span>  <span class="hljs-number">2.311896</span> <span class="hljs-number">-0.417070</span> <span class="hljs-number">-1.409599</span> <span class="hljs-number">-0.515821</span>   L</span><br><span class="line"><span class="hljs-number">9996</span> <span class="hljs-number">-0.479893</span> <span class="hljs-number">-0.650419</span>  <span class="hljs-number">0.745152</span> <span class="hljs-number">-0.646038</span>   E</span><br><span class="line"><span class="hljs-number">9997</span>  <span class="hljs-number">0.523331</span>  <span class="hljs-number">0.787112</span>  <span class="hljs-number">0.486066</span>  <span class="hljs-number">1.093156</span>   K</span><br><span class="line"><span class="hljs-number">9998</span> <span class="hljs-number">-0.362559</span>  <span class="hljs-number">0.598894</span> <span class="hljs-number">-1.843201</span>  <span class="hljs-number">0.887292</span>   G</span><br><span class="line"><span class="hljs-number">9999</span> <span class="hljs-number">-0.096376</span> <span class="hljs-number">-1.012999</span> <span class="hljs-number">-0.657431</span> <span class="hljs-number">-0.573315</span>   <span class="hljs-number">0</span></span><br><span class="line">[<span class="hljs-number">10000</span> rows x <span class="hljs-number">5</span> columns]</span><br><span class="line">If you want to only read a small</span><br></pre></td></tr></table></figure>

<p>如果只想读取几行（避免读取整个文件），通过nrows进行指定即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">36</span>]: pd.read_csv(<span class="hljs-string">'examples/ex6.csv'</span>, nrows=<span class="hljs-number">5</span>)</span><br><span class="line">Out[<span class="hljs-number">36</span>]: </span><br><span class="line">        one       two     three      four key</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.467976</span> <span class="hljs-number">-0.038649</span> <span class="hljs-number">-0.295344</span> <span class="hljs-number">-1.824726</span>   L</span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.358893</span>  <span class="hljs-number">1.404453</span>  <span class="hljs-number">0.704965</span> <span class="hljs-number">-0.200638</span>   B</span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.501840</span>  <span class="hljs-number">0.659254</span> <span class="hljs-number">-0.421691</span> <span class="hljs-number">-0.057688</span>   G</span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">0.204886</span>  <span class="hljs-number">1.074134</span>  <span class="hljs-number">1.388361</span> <span class="hljs-number">-0.982404</span>   R</span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.354628</span> <span class="hljs-number">-0.133116</span>  <span class="hljs-number">0.283763</span> <span class="hljs-number">-0.837063</span>   Q</span><br></pre></td></tr></table></figure>

<p>要逐块读取文件，可以指定chunksize（行数）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">874</span>]: chunker = pd.read_csv(<span class="hljs-string">'ch06/ex6.csv'</span>, chunksize=<span class="hljs-number">1000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">875</span>]: chunker</span><br><span class="line">Out[<span class="hljs-number">875</span>]: &lt;pandas.io.parsers.TextParser at <span class="hljs-number">0x8398150</span>&gt;</span><br></pre></td></tr></table></figure>

<p>read_csv所返回的这个TextParser对象使你可以根据chunksize对文件进行逐块迭代。比如说，我们可以迭代处理ex6.csv，将值计数聚合到”key”列中，如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chunker = pd.read_csv(<span class="hljs-string">'examples/ex6.csv'</span>, chunksize=<span class="hljs-number">1000</span>)</span><br><span class="line"></span><br><span class="line">tot = pd.Series([])</span><br><span class="line"><span class="hljs-keyword">for</span> piece <span class="hljs-keyword">in</span> chunker:</span><br><span class="line">    tot = tot.add(piece[<span class="hljs-string">'key'</span>].value_counts(), fill_value=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">tot = tot.sort_values(ascending=<span class="hljs-literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>然后有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">40</span>]: tot[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">E    <span class="hljs-number">368.0</span></span><br><span class="line">X    <span class="hljs-number">364.0</span></span><br><span class="line">L    <span class="hljs-number">346.0</span></span><br><span class="line">O    <span class="hljs-number">343.0</span></span><br><span class="line">Q    <span class="hljs-number">340.0</span></span><br><span class="line">M    <span class="hljs-number">338.0</span></span><br><span class="line">J    <span class="hljs-number">337.0</span></span><br><span class="line">F    <span class="hljs-number">335.0</span></span><br><span class="line">K    <span class="hljs-number">334.0</span></span><br><span class="line">H    <span class="hljs-number">330.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>TextParser还有一个get_chunk方法，它使你可以读取任意大小的块。</p>
<h2 id="将数据写出到文本格式"><a href="#将数据写出到文本格式" class="headerlink" title="将数据写出到文本格式"></a>将数据写出到文本格式</h2><p>数据也可以被输出为分隔符格式的文本。我们再来看看之前读过的一个CSV文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">41</span>]: data = pd.read_csv(<span class="hljs-string">'examples/ex5.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: data</span><br><span class="line">Out[<span class="hljs-number">42</span>]: </span><br><span class="line">  something  a   b     c   d message</span><br><span class="line"><span class="hljs-number">0</span>       one  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3.0</span>   <span class="hljs-number">4</span>     NaN</span><br><span class="line"><span class="hljs-number">1</span>       two  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   NaN   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>     three  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>利用DataFrame的to_csv方法，我们可以将数据写到一个以逗号分隔的文件中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">43</span>]: data.to_csv(<span class="hljs-string">'examples/out.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">44</span>]: !cat examples/out.csv</span><br><span class="line">,something,a,b,c,d,message</span><br><span class="line"><span class="hljs-number">0</span>,one,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3.0</span>,<span class="hljs-number">4</span>,</span><br><span class="line"><span class="hljs-number">1</span>,two,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">2</span>,three,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11.0</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<p>当然，还可以使用其他分隔符（由于这里直接写出到sys.stdout，所以仅仅是打印出文本结果而已）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: <span class="hljs-keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: data.to_csv(sys.stdout, sep=<span class="hljs-string">'|'</span>)</span><br><span class="line">|something|a|b|c|d|message</span><br><span class="line"><span class="hljs-number">0</span>|one|<span class="hljs-number">1</span>|<span class="hljs-number">2</span>|<span class="hljs-number">3.0</span>|<span class="hljs-number">4</span>|</span><br><span class="line"><span class="hljs-number">1</span>|two|<span class="hljs-number">5</span>|<span class="hljs-number">6</span>||<span class="hljs-number">8</span>|world</span><br><span class="line"><span class="hljs-number">2</span>|three|<span class="hljs-number">9</span>|<span class="hljs-number">10</span>|<span class="hljs-number">11.0</span>|<span class="hljs-number">12</span>|foo</span><br></pre></td></tr></table></figure>

<p>缺失值在输出结果中会被表示为空字符串。你可能希望将其表示为别的标记值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">47</span>]: data.to_csv(sys.stdout, na_rep=<span class="hljs-string">'NULL'</span>)</span><br><span class="line">,something,a,b,c,d,message</span><br><span class="line"><span class="hljs-number">0</span>,one,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3.0</span>,<span class="hljs-number">4</span>,NULL</span><br><span class="line"><span class="hljs-number">1</span>,two,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,NULL,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">2</span>,three,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11.0</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<p>如果没有设置其他选项，则会写出行和列的标签。当然，它们也都可以被禁用：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">48</span>]: data.to_csv(sys.stdout, index=<span class="hljs-literal">False</span>, header=<span class="hljs-literal">False</span>)</span><br><span class="line">one,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3.0</span>,<span class="hljs-number">4</span>,</span><br><span class="line">two,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,,<span class="hljs-number">8</span>,world</span><br><span class="line">three,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11.0</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<p>此外，你还可以只写出一部分的列，并以你指定的顺序排列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: data.to_csv(sys.stdout, index=<span class="hljs-literal">False</span>, columns=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>])</span><br><span class="line">a,b,c</span><br><span class="line"><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">5</span>,<span class="hljs-number">6</span>,</span><br><span class="line"><span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11.0</span></span><br></pre></td></tr></table></figure>

<p>Series也有一个to_csv方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: dates = pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">7</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: ts = pd.Series(np.arange(<span class="hljs-number">7</span>), index=dates)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">52</span>]: ts.to_csv(<span class="hljs-string">'examples/tseries.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: !cat examples/tseries.csv</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>,<span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>,<span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>,<span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>,<span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>,<span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>,<span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>,<span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<h2 id="处理分隔符格式"><a href="#处理分隔符格式" class="headerlink" title="处理分隔符格式"></a>处理分隔符格式</h2><p>大部分存储在磁盘上的表格型数据都能用pandas.read_table进行加载。然而，有时还是需要做一些手工处理。由于接收到含有畸形行的文件而使read_table出毛病的情况并不少见。为了说明这些基本工具，看看下面这个简单的CSV文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: !cat examples/ex7.csv</span><br><span class="line"><span class="hljs-string">"a"</span>,<span class="hljs-string">"b"</span>,<span class="hljs-string">"c"</span></span><br><span class="line"><span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>,<span class="hljs-string">"3"</span></span><br><span class="line"><span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>,<span class="hljs-string">"3"</span></span><br></pre></td></tr></table></figure>

<p>对于任何单字符分隔符文件，可以直接使用Python内置的csv模块。将任意已打开的文件或文件型的对象传给csv.reader：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> csv</span><br><span class="line">f = open(<span class="hljs-string">'examples/ex7.csv'</span>)</span><br><span class="line"></span><br><span class="line">reader = csv.reader(f)</span><br></pre></td></tr></table></figure>

<p>对这个reader进行迭代将会为每行产生一个元组（并移除了所有的引号）：对这个reader进行迭代将会为每行产生一个元组（并移除了所有的引号）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> reader:</span><br><span class="line">   ....:     print(line)</span><br><span class="line">[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]</span><br><span class="line">[<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>]</span><br><span class="line">[<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>]</span><br></pre></td></tr></table></figure>

<p>现在，为了使数据格式合乎要求，你需要对其做一些整理工作。我们一步一步来做。首先，读取文件到一个多行的列表中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">57</span>]: <span class="hljs-keyword">with</span> open(<span class="hljs-string">'examples/ex7.csv'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">   ....:     lines = list(csv.reader(f))</span><br></pre></td></tr></table></figure>

<p>然后，我们将这些行分为标题行和数据行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">58</span>]: header, values = lines[<span class="hljs-number">0</span>], lines[<span class="hljs-number">1</span>:]</span><br></pre></td></tr></table></figure>

<p>然后，我们可以用字典构造式和zip(*values)，后者将行转置为列，创建数据列的字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">59</span>]: data_dict = &#123;h: v <span class="hljs-keyword">for</span> h, v <span class="hljs-keyword">in</span> zip(header, zip(*values))&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: data_dict</span><br><span class="line">Out[<span class="hljs-number">60</span>]: &#123;<span class="hljs-string">'a'</span>: (<span class="hljs-string">'1'</span>, <span class="hljs-string">'1'</span>), <span class="hljs-string">'b'</span>: (<span class="hljs-string">'2'</span>, <span class="hljs-string">'2'</span>), <span class="hljs-string">'c'</span>: (<span class="hljs-string">'3'</span>, <span class="hljs-string">'3'</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>CSV文件的形式有很多。只需定义csv.Dialect的一个子类即可定义出新格式（如专门的分隔符、字符串引用约定、行结束符等）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">my_dialect</span><span class="hljs-params">(csv.Dialect)</span>:</span></span><br><span class="line">    lineterminator = <span class="hljs-string">'\n'</span></span><br><span class="line">    delimiter = <span class="hljs-string">';'</span></span><br><span class="line">    quotechar = <span class="hljs-string">'"'</span></span><br><span class="line">    quoting = csv.QUOTE_MINIMAL</span><br><span class="line">reader = csv.reader(f, dialect=my_dialect)</span><br></pre></td></tr></table></figure>

<p>各个CSV语支的参数也可以用关键字的形式提供给csv.reader，而无需定义子类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reader = csv.reader(f, delimiter=<span class="hljs-string">'|'</span>)</span><br></pre></td></tr></table></figure>

<p>可用的选项（csv.Dialect的属性）及其功能如表6-3所示。</p>
<p><img src="/images/blog/7178691-7a1cee622459072b.webp" alt="img"></p>
<blockquote>
<p>笔记：对于那些使用复杂分隔符或多字符分隔符的文件，csv模块就无能为力了。这种情况下，你就只能使用字符串的split方法或正则表达式方法re.split进行行拆分和其他整理工作了。</p>
</blockquote>
<p>要手工输出分隔符文件，你可以使用csv.writer。它接受一个已打开且可写的文件对象以及跟csv.reader相同的那些语支和格式化选项：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">with</span> open(<span class="hljs-string">'mydata.csv'</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(f, dialect=my_dialect)</span><br><span class="line">    writer.writerow((<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>))</span><br><span class="line">    writer.writerow((<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>))</span><br><span class="line">    writer.writerow((<span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>, <span class="hljs-string">'6'</span>))</span><br><span class="line">    writer.writerow((<span class="hljs-string">'7'</span>, <span class="hljs-string">'8'</span>, <span class="hljs-string">'9'</span>))</span><br></pre></td></tr></table></figure>

<h2 id="JSON数据"><a href="#JSON数据" class="headerlink" title="JSON数据"></a>JSON数据</h2><p>JSON（JavaScript Object Notation的简称）已经成为通过HTTP请求在Web浏览器和其他应用程序之间发送数据的标准格式之一。它是一种比表格型文本格式（如CSV）灵活得多的数据格式。下面是一个例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj = <span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">&#123;"name": "Wes",</span></span><br><span class="line"><span class="hljs-string"> "places_lived": ["United States", "Spain", "Germany"],</span></span><br><span class="line"><span class="hljs-string"> "pet": null,</span></span><br><span class="line"><span class="hljs-string"> "siblings": [&#123;"name": "Scott", "age": 30, "pets": ["Zeus", "Zuko"]&#125;,</span></span><br><span class="line"><span class="hljs-string">              &#123;"name": "Katie", "age": 38,</span></span><br><span class="line"><span class="hljs-string">               "pets": ["Sixes", "Stache", "Cisco"]&#125;]</span></span><br><span class="line"><span class="hljs-string">&#125;</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br></pre></td></tr></table></figure>

<p>除其空值null和一些其他的细微差别（如列表末尾不允许存在多余的逗号）之外，JSON非常接近于有效的Python代码。基本类型有对象（字典）、数组（列表）、字符串、数值、布尔值以及null。对象中所有的键都必须是字符串。许多Python库都可以读写JSON数据。我将使用json，因为它是构建于Python标准库中的。通过json.loads即可将JSON字符串转换成Python形式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: <span class="hljs-keyword">import</span> json</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: result = json.loads(obj)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">64</span>]: result</span><br><span class="line">Out[<span class="hljs-number">64</span>]: </span><br><span class="line">&#123;<span class="hljs-string">'name'</span>: <span class="hljs-string">'Wes'</span>,</span><br><span class="line"> <span class="hljs-string">'pet'</span>: <span class="hljs-literal">None</span>,</span><br><span class="line"> <span class="hljs-string">'places_lived'</span>: [<span class="hljs-string">'United States'</span>, <span class="hljs-string">'Spain'</span>, <span class="hljs-string">'Germany'</span>],</span><br><span class="line"> <span class="hljs-string">'siblings'</span>: [&#123;<span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'Scott'</span>, <span class="hljs-string">'pets'</span>: [<span class="hljs-string">'Zeus'</span>, <span class="hljs-string">'Zuko'</span>]&#125;,</span><br><span class="line">  &#123;<span class="hljs-string">'age'</span>: <span class="hljs-number">38</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'Katie'</span>, <span class="hljs-string">'pets'</span>: [<span class="hljs-string">'Sixes'</span>, <span class="hljs-string">'Stache'</span>, <span class="hljs-string">'Cisco'</span>]&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>json.dumps则将Python对象转换成JSON格式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: asjson = json.dumps(result)</span><br></pre></td></tr></table></figure>

<p>如何将（一个或一组）JSON对象转换为DataFrame或其他便于分析的数据结构就由你决定了。最简单方便的方式是：向DataFrame构造器传入一个字典的列表（就是原先的JSON对象），并选取数据字段的子集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: siblings = pd.DataFrame(result[<span class="hljs-string">'siblings'</span>], columns=[<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: siblings</span><br><span class="line">Out[<span class="hljs-number">67</span>]: </span><br><span class="line">    name  age</span><br><span class="line"><span class="hljs-number">0</span>  Scott   <span class="hljs-number">30</span></span><br><span class="line"><span class="hljs-number">1</span>  Katie   <span class="hljs-number">38</span></span><br></pre></td></tr></table></figure>

<p>pandas.read_json可以自动将特别格式的JSON数据集转换为Series或DataFrame。例如：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: !cat examples/example.json</span><br><span class="line">[&#123;<span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"c"</span>: <span class="hljs-number">3</span>&#125;,</span><br><span class="line"> &#123;<span class="hljs-string">"a"</span>: <span class="hljs-number">4</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">5</span>, <span class="hljs-string">"c"</span>: <span class="hljs-number">6</span>&#125;,</span><br><span class="line"> &#123;<span class="hljs-string">"a"</span>: <span class="hljs-number">7</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">8</span>, <span class="hljs-string">"c"</span>: <span class="hljs-number">9</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>pandas.read_json的默认选项假设JSON数组中的每个对象是表格中的一行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: data = pd.read_json(<span class="hljs-string">'examples/example.json'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: data</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">   a  b  c</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span></span><br></pre></td></tr></table></figure>

<p>第7章中关于USDA Food Database的那个例子进一步讲解了JSON数据的读取和处理（包括嵌套记录）。</p>
<p>如果你需要将数据从pandas输出到JSON，可以使用to_json方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">71</span>]: print(data.to_json())</span><br><span class="line">&#123;<span class="hljs-string">"a"</span>:&#123;<span class="hljs-string">"0"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"1"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"2"</span>:<span class="hljs-number">7</span>&#125;,<span class="hljs-string">"b"</span>:&#123;<span class="hljs-string">"0"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"1"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"2"</span>:<span class="hljs-number">8</span>&#125;,<span class="hljs-string">"c"</span>:&#123;<span class="hljs-string">"0"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"1"</span>:<span class="hljs-number">6</span>,<span class="hljs-string">"2"</span>:<span class="hljs-number">9</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: print(data.to_json(orient=<span class="hljs-string">'records'</span>))</span><br><span class="line">[&#123;<span class="hljs-string">"a"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"b"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"c"</span>:<span class="hljs-number">3</span>&#125;,&#123;<span class="hljs-string">"a"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"b"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"c"</span>:<span class="hljs-number">6</span>&#125;,&#123;<span class="hljs-string">"a"</span>:<span class="hljs-number">7</span>,<span class="hljs-string">"b"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"c"</span>:<span class="hljs-number">9</span>&#125;]</span><br></pre></td></tr></table></figure>

<h2 id="XML和HTML：Web信息收集"><a href="#XML和HTML：Web信息收集" class="headerlink" title="XML和HTML：Web信息收集"></a>XML和HTML：Web信息收集</h2><p>Python有许多可以读写常见的HTML和XML格式数据的库，包括lxml、Beautiful Soup和html5lib。lxml的速度比较快，但其它的库处理有误的HTML或XML文件更好。</p>
<p>pandas有一个内置的功能，read_html，它可以使用lxml和Beautiful Soup自动将HTML文件中的表格解析为DataFrame对象。为了进行展示，我从美国联邦存款保险公司下载了一个HTML文件（pandas文档中也使用过），它记录了银行倒闭的情况。首先，你需要安装read_html用到的库：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda install lxml</span><br><span class="line">pip install beautifulsoup4 html5lib</span><br></pre></td></tr></table></figure>

<p>如果你用的不是conda，可以使用<code>pip install lxml</code>。</p>
<p>pandas.read_html有一些选项，默认条件下，它会搜索、尝试解析<table>标签内的的表格数据。结果是一个列表的DataFrame对象：</table></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: tables = pd.read_html(<span class="hljs-string">'examples/fdic_failed_bank_list.html'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">74</span>]: len(tables)</span><br><span class="line">Out[<span class="hljs-number">74</span>]: <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">75</span>]: failures = tables[<span class="hljs-number">0</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: failures.head()</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">                      Bank Name             City  ST   CERT  \</span><br><span class="line"><span class="hljs-number">0</span>                   Allied Bank         Mulberry  AR     <span class="hljs-number">91</span>   </span><br><span class="line"><span class="hljs-number">1</span>  The Woodbury Banking Company         Woodbury  GA  <span class="hljs-number">11297</span>   </span><br><span class="line"><span class="hljs-number">2</span>        First CornerStone Bank  King of Prussia  PA  <span class="hljs-number">35312</span>   </span><br><span class="line"><span class="hljs-number">3</span>            Trust Company Bank          Memphis  TN   <span class="hljs-number">9956</span>   </span><br><span class="line"><span class="hljs-number">4</span>    North Milwaukee State Bank        Milwaukee  WI  <span class="hljs-number">20364</span>   </span><br><span class="line">                 Acquiring Institution        Closing Date       Updated Date  </span><br><span class="line"><span class="hljs-number">0</span>                         Today<span class="hljs-string">'s Bank  September 23, 2016  November 17, 2016  </span></span><br><span class="line"><span class="hljs-string">1                          United Bank     August 19, 2016  November 17, 2016  </span></span><br><span class="line"><span class="hljs-string">2  First-Citizens Bank &amp; Trust Company         May 6, 2016  September 6, 2016  </span></span><br><span class="line"><span class="hljs-string">3           The Bank of Fayette County      April 29, 2016  September 6, 2016  </span></span><br><span class="line"><span class="hljs-string">4  First-Citizens Bank &amp; Trust Company      March 11, 2016      June 16, 2016</span></span><br></pre></td></tr></table></figure>

<p>因为failures有许多列，pandas插入了一个换行符\。</p>
<p>这里，我们可以做一些数据清洗和分析（后面章节会进一步讲解），比如计算按年份计算倒闭的银行数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">77</span>]: close_timestamps = pd.to_datetime(failures[<span class="hljs-string">'Closing Date'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: close_timestamps.dt.year.value_counts()</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line"><span class="hljs-number">2010</span>    <span class="hljs-number">157</span></span><br><span class="line"><span class="hljs-number">2009</span>    <span class="hljs-number">140</span></span><br><span class="line"><span class="hljs-number">2011</span>     <span class="hljs-number">92</span></span><br><span class="line"><span class="hljs-number">2012</span>     <span class="hljs-number">51</span></span><br><span class="line"><span class="hljs-number">2008</span>     <span class="hljs-number">25</span></span><br><span class="line">       ... </span><br><span class="line"><span class="hljs-number">2004</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2001</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2007</span>      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2003</span>      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span>      <span class="hljs-number">2</span></span><br><span class="line">Name: Closing Date, Length: <span class="hljs-number">15</span>, dtype: int64</span><br></pre></td></tr></table></figure>

<h2 id="利用lxml-objectify解析XML"><a href="#利用lxml-objectify解析XML" class="headerlink" title="利用lxml.objectify解析XML"></a>利用lxml.objectify解析XML</h2><p>XML（Extensible Markup Language）是另一种常见的支持分层、嵌套数据以及元数据的结构化数据格式。本书所使用的这些文件实际上来自于一个很大的XML文档。</p>
<p>前面，我介绍了pandas.read_html函数，它可以使用lxml或Beautiful Soup从HTML解析数据。XML和HTML的结构很相似，但XML更为通用。这里，我会用一个例子演示如何利用lxml从XML格式解析数据。</p>
<p>纽约大都会运输署发布了一些有关其公交和列车服务的数据资料（<a href="http://www.mta.info/developers/download.html）。这里，我们将看看包含在一组XML文件中的运行情况数据。每项列车或公交服务都有各自的文件（如Metro-North" target="_blank" rel="noopener">http://www.mta.info/developers/download.html）。这里，我们将看看包含在一组XML文件中的运行情况数据。每项列车或公交服务都有各自的文件（如Metro-North</a> Railroad的文件是Performance_MNR.xml），其中每条XML记录就是一条月度数据，如下所示：</p>
<figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">INDICATOR</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">INDICATOR_SEQ</span>&gt;</span>373889<span class="hljs-tag">&lt;/<span class="hljs-name">INDICATOR_SEQ</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">PARENT_SEQ</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">PARENT_SEQ</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">AGENCY_NAME</span>&gt;</span>Metro-North Railroad<span class="hljs-tag">&lt;/<span class="hljs-name">AGENCY_NAME</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">INDICATOR_NAME</span>&gt;</span>Escalator Availability<span class="hljs-tag">&lt;/<span class="hljs-name">INDICATOR_NAME</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">DESCRIPTION</span>&gt;</span>Percent of the time that escalators are operational</span><br><span class="line">  systemwide. The availability rate is based on physical observations performed</span><br><span class="line">  the morning of regular business days only. This is a new indicator the agency</span><br><span class="line">  began reporting in 2009.<span class="hljs-tag">&lt;/<span class="hljs-name">DESCRIPTION</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">PERIOD_YEAR</span>&gt;</span>2011<span class="hljs-tag">&lt;/<span class="hljs-name">PERIOD_YEAR</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">PERIOD_MONTH</span>&gt;</span>12<span class="hljs-tag">&lt;/<span class="hljs-name">PERIOD_MONTH</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">CATEGORY</span>&gt;</span>Service Indicators<span class="hljs-tag">&lt;/<span class="hljs-name">CATEGORY</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">FREQUENCY</span>&gt;</span>M<span class="hljs-tag">&lt;/<span class="hljs-name">FREQUENCY</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">DESIRED_CHANGE</span>&gt;</span>U<span class="hljs-tag">&lt;/<span class="hljs-name">DESIRED_CHANGE</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">INDICATOR_UNIT</span>&gt;</span>%<span class="hljs-tag">&lt;/<span class="hljs-name">INDICATOR_UNIT</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">DECIMAL_PLACES</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">DECIMAL_PLACES</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">YTD_TARGET</span>&gt;</span>97.00<span class="hljs-tag">&lt;/<span class="hljs-name">YTD_TARGET</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">YTD_ACTUAL</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">YTD_ACTUAL</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">MONTHLY_TARGET</span>&gt;</span>97.00<span class="hljs-tag">&lt;/<span class="hljs-name">MONTHLY_TARGET</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">MONTHLY_ACTUAL</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">MONTHLY_ACTUAL</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">INDICATOR</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们先用lxml.objectify解析该文件，然后通过getroot得到该XML文件的根节点的引用：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> objectify</span><br><span class="line"></span><br><span class="line">path = <span class="hljs-string">'datasets/mta_perf/Performance_MNR.xml'</span></span><br><span class="line">parsed = objectify.parse(open(path))</span><br><span class="line">root = parsed.getroot()</span><br></pre></td></tr></table></figure>

<p>root.INDICATOR返回一个用于产生各个<indicator>XML元素的生成器。对于每条记录，我们可以用标记名（如YTD_ACTUAL）和数据值填充一个字典（排除几个标记）：</indicator></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data = []</span><br><span class="line"></span><br><span class="line">skip_fields = [<span class="hljs-string">'PARENT_SEQ'</span>, <span class="hljs-string">'INDICATOR_SEQ'</span>,</span><br><span class="line">               <span class="hljs-string">'DESIRED_CHANGE'</span>, <span class="hljs-string">'DECIMAL_PLACES'</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> elt <span class="hljs-keyword">in</span> root.INDICATOR:</span><br><span class="line">    el_data = &#123;&#125;</span><br><span class="line">    <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> elt.getchildren():</span><br><span class="line">        <span class="hljs-keyword">if</span> child.tag <span class="hljs-keyword">in</span> skip_fields:</span><br><span class="line">            <span class="hljs-keyword">continue</span></span><br><span class="line">        el_data[child.tag] = child.pyval</span><br><span class="line">    data.append(el_data)</span><br></pre></td></tr></table></figure>

<p>最后，将这组字典转换为一个DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">81</span>]: perf = pd.DataFrame(data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">82</span>]: perf.head()</span><br><span class="line">Out[<span class="hljs-number">82</span>]:</span><br><span class="line">Empty DataFrame</span><br><span class="line">Columns: []</span><br><span class="line">Index: []</span><br></pre></td></tr></table></figure>

<p>XML数据可以比本例复杂得多。每个标记都可以有元数据。看看下面这个HTML的链接标签（它也算是一段有效的XML）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO</span><br><span class="line">tag = <span class="hljs-string">'&lt;a href="http://www.google.com"&gt;Google&lt;/a&gt;'</span></span><br><span class="line">root = objectify.parse(StringIO(tag)).getroot()</span><br></pre></td></tr></table></figure>

<p>现在就可以访问标签或链接文本中的任何字段了（如href）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">84</span>]: root</span><br><span class="line">Out[<span class="hljs-number">84</span>]: &lt;Element a at <span class="hljs-number">0x7f6b15817748</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: root.get(<span class="hljs-string">'href'</span>)</span><br><span class="line">Out[<span class="hljs-number">85</span>]: <span class="hljs-string">'http://www.google.com'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: root.text</span><br><span class="line">Out[<span class="hljs-number">86</span>]: <span class="hljs-string">'Google'</span></span><br></pre></td></tr></table></figure>

<h1 id="6-2-二进制数据格式"><a href="#6-2-二进制数据格式" class="headerlink" title="6.2 二进制数据格式"></a>6.2 二进制数据格式</h1><p>实现数据的高效二进制格式存储最简单的办法之一是使用Python内置的pickle序列化。pandas对象都有一个用于将数据以pickle格式保存到磁盘上的to_pickle方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: frame = pd.read_csv(<span class="hljs-string">'examples/ex1.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: frame.to_pickle(<span class="hljs-string">'examples/frame_pickle'</span>)</span><br></pre></td></tr></table></figure>

<p>你可以通过pickle直接读取被pickle化的数据，或是使用更为方便的pandas.read_pickle：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">90</span>]: pd.read_pickle(<span class="hljs-string">'examples/frame_pickle'</span>)</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：pickle仅建议用于短期存储格式。其原因是很难保证该格式永远是稳定的；今天pickle的对象可能无法被后续版本的库unpickle出来。虽然我尽力保证这种事情不会发生在pandas中，但是今后的某个时候说不定还是得“打破”该pickle格式。</p>
</blockquote>
<p>pandas内置支持两个二进制数据格式：HDF5和MessagePack。下一节，我会给出几个HDF5的例子，但我建议你尝试下不同的文件格式，看看它们的速度以及是否适合你的分析工作。pandas或NumPy数据的其它存储格式有：</p>
<ul>
<li>bcolz：一种可压缩的列存储二进制格式，基于Blosc压缩库。</li>
<li>Feather：我与R语言社区的Hadley Wickham设计的一种跨语言的列存储文件格式。Feather使用了Apache Arrow的列式内存格式。</li>
</ul>
<h2 id="使用HDF5格式"><a href="#使用HDF5格式" class="headerlink" title="使用HDF5格式"></a>使用HDF5格式</h2><p>HDF5是一种存储大规模科学数组数据的非常好的文件格式。它可以被作为C标准库，带有许多语言的接口，如Java、Python和MATLAB等。HDF5中的HDF指的是层次型数据格式（hierarchical data format）。每个HDF5文件都含有一个文件系统式的节点结构，它使你能够存储多个数据集并支持元数据。与其他简单格式相比，HDF5支持多种压缩器的即时压缩，还能更高效地存储重复模式数据。对于那些非常大的无法直接放入内存的数据集，HDF5就是不错的选择，因为它可以高效地分块读写。</p>
<p>虽然可以用PyTables或h5py库直接访问HDF5文件，pandas提供了更为高级的接口，可以简化存储Series和DataFrame对象。HDFStore类可以像字典一样，处理低级的细节：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">92</span>]: frame = pd.DataFrame(&#123;<span class="hljs-string">'a'</span>: np.random.randn(<span class="hljs-number">100</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: store = pd.HDFStore(<span class="hljs-string">'mydata.h5'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">94</span>]: store[<span class="hljs-string">'obj1'</span>] = frame</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: store[<span class="hljs-string">'obj1_col'</span>] = frame[<span class="hljs-string">'a'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">96</span>]: store</span><br><span class="line">Out[<span class="hljs-number">96</span>]: </span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">io</span>.<span class="hljs-title">pytables</span>.<span class="hljs-title">HDFStore</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">File</span> <span class="hljs-title">path</span>:</span> mydata.h5</span><br><span class="line">/obj1                frame        (shape-&gt;[100,1])                               </span><br><span class="line">        </span><br><span class="line">/obj1_col            series       (shape-&gt;[100])                                 </span><br><span class="line">        </span><br><span class="line">/obj2                frame_table  (typ-&gt;appendable,nrows-&gt;100,ncols-&gt;1,indexers-&gt;</span><br><span class="line">[index])</span><br><span class="line">/obj3                frame_table  (typ-&gt;appendable,nrows-&gt;100,ncols-&gt;1,indexers-&gt;</span><br><span class="line">[index])</span><br></pre></td></tr></table></figure>

<p>HDF5文件中的对象可以通过与字典一样的API进行获取：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">97</span>]: store[<span class="hljs-string">'obj1'</span>]</span><br><span class="line">Out[<span class="hljs-number">97</span>]: </span><br><span class="line">           a</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">1.965781</span></span><br><span class="line">..       ...</span><br><span class="line"><span class="hljs-number">95</span>  <span class="hljs-number">0.795253</span></span><br><span class="line"><span class="hljs-number">96</span>  <span class="hljs-number">0.118110</span></span><br><span class="line"><span class="hljs-number">97</span> <span class="hljs-number">-0.748532</span></span><br><span class="line"><span class="hljs-number">98</span>  <span class="hljs-number">0.584970</span></span><br><span class="line"><span class="hljs-number">99</span>  <span class="hljs-number">0.152677</span></span><br><span class="line">[<span class="hljs-number">100</span> rows x <span class="hljs-number">1</span> columns]</span><br></pre></td></tr></table></figure>

<p>HDFStore支持两种存储模式，’fixed’和’table’。后者通常会更慢，但是支持使用特殊语法进行查询操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">98</span>]: store.put(<span class="hljs-string">'obj2'</span>, frame, format=<span class="hljs-string">'table'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: store.select(<span class="hljs-string">'obj2'</span>, where=[<span class="hljs-string">'index &gt;= 10 and index &lt;= 15'</span>])</span><br><span class="line">Out[<span class="hljs-number">99</span>]: </span><br><span class="line">           a</span><br><span class="line"><span class="hljs-number">10</span>  <span class="hljs-number">1.007189</span></span><br><span class="line"><span class="hljs-number">11</span> <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">12</span>  <span class="hljs-number">0.274992</span></span><br><span class="line"><span class="hljs-number">13</span>  <span class="hljs-number">0.228913</span></span><br><span class="line"><span class="hljs-number">14</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">15</span>  <span class="hljs-number">0.886429</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: store.close()</span><br></pre></td></tr></table></figure>

<p>put是store[‘obj2’] = frame方法的显示版本，允许我们设置其它的选项，比如格式。</p>
<p>pandas.read_hdf函数可以快捷使用这些工具：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: frame.to_hdf(<span class="hljs-string">'mydata.h5'</span>, <span class="hljs-string">'obj3'</span>, format=<span class="hljs-string">'table'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: pd.read_hdf(<span class="hljs-string">'mydata.h5'</span>, <span class="hljs-string">'obj3'</span>, where=[<span class="hljs-string">'index &lt; 5'</span>])</span><br><span class="line">Out[<span class="hljs-number">102</span>]: </span><br><span class="line">          a</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：如果你要处理的数据位于远程服务器，比如Amazon S3或HDFS，使用专门为分布式存储（比如Apache Parquet）的二进制格式也许更加合适。Python的Parquet和其它存储格式还在不断的发展之中，所以这本书中没有涉及。</p>
</blockquote>
<p>如果需要本地处理海量数据，我建议你好好研究一下PyTables和h5py，看看它们能满足你的哪些需求。。由于许多数据分析问题都是IO密集型（而不是CPU密集型），利用HDF5这样的工具能显著提升应用程序的效率。</p>
<blockquote>
<p>注意：HDF5不是数据库。它最适合用作“一次写多次读”的数据集。虽然数据可以在任何时候被添加到文件中，但如果同时发生多个写操作，文件就可能会被破坏。</p>
</blockquote>
<h2 id="读取Microsoft-Excel文件"><a href="#读取Microsoft-Excel文件" class="headerlink" title="读取Microsoft Excel文件"></a>读取Microsoft Excel文件</h2><p>pandas的ExcelFile类或pandas.read_excel函数支持读取存储在Excel 2003（或更高版本）中的表格型数据。这两个工具分别使用扩展包xlrd和openpyxl读取XLS和XLSX文件。你可以用pip或conda安装它们。</p>
<p>要使用ExcelFile，通过传递xls或xlsx路径创建一个实例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">104</span>]: xlsx = pd.ExcelFile(<span class="hljs-string">'examples/ex1.xlsx'</span>)</span><br></pre></td></tr></table></figure>

<p>存储在表单中的数据可以read_excel读取到DataFrame（原书这里写的是用parse解析，但代码中用的是read_excel，是个笔误：只换了代码，没有改文字）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: pd.read_excel(xlsx, <span class="hljs-string">'Sheet1'</span>)</span><br><span class="line">Out[<span class="hljs-number">105</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>如果要读取一个文件中的多个表单，创建ExcelFile会更快，但你也可以将文件名传递到pandas.read_excel：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">106</span>]: frame = pd.read_excel(<span class="hljs-string">'examples/ex1.xlsx'</span>, <span class="hljs-string">'Sheet1'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">107</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">107</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>如果要将pandas数据写入为Excel格式，你必须首先创建一个ExcelWriter，然后使用pandas对象的to_excel方法将数据写入到其中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: writer = pd.ExcelWriter(<span class="hljs-string">'examples/ex2.xlsx'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">109</span>]: frame.to_excel(writer, <span class="hljs-string">'Sheet1'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: writer.save()</span><br></pre></td></tr></table></figure>

<p>你还可以不使用ExcelWriter，而是传递文件的路径到to_excel：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">111</span>]: frame.to_excel(<span class="hljs-string">'examples/ex2.xlsx'</span>)</span><br></pre></td></tr></table></figure>

<h1 id="6-3-Web-APIs交互"><a href="#6-3-Web-APIs交互" class="headerlink" title="6.3 Web APIs交互"></a>6.3 Web APIs交互</h1><p>许多网站都有一些通过JSON或其他格式提供数据的公共API。通过Python访问这些API的办法有不少。一个简单易用的办法（推荐）是requests包（<a href="http://docs.python-requests.org/" target="_blank" rel="noopener">http://docs.python-requests.org</a>）。</p>
<p>为了搜索最新的30个GitHub上的pandas主题，我们可以发一个HTTP GET请求，使用requests扩展库：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">113</span>]: <span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">114</span>]: url = <span class="hljs-string">'https://api.github.com/repos/pandas-dev/pandas/issues'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">115</span>]: resp = requests.get(url)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: resp</span><br><span class="line">Out[<span class="hljs-number">116</span>]: &lt;Response [<span class="hljs-number">200</span>]&gt;</span><br></pre></td></tr></table></figure>

<p>响应对象的json方法会返回一个包含被解析过的JSON字典，加载到一个Python对象中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">117</span>]: data = resp.json()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">118</span>]: data[<span class="hljs-number">0</span>][<span class="hljs-string">'title'</span>]</span><br><span class="line">Out[<span class="hljs-number">118</span>]: <span class="hljs-string">'Period does not round down for frequencies less that 1 hour'</span></span><br></pre></td></tr></table></figure>

<p>data中的每个元素都是一个包含所有GitHub主题页数据（不包含评论）的字典。我们可以直接传递数据到DataFrame，并提取感兴趣的字段：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">119</span>]: issues = pd.DataFrame(data, columns=[<span class="hljs-string">'number'</span>, <span class="hljs-string">'title'</span>,</span><br><span class="line">   .....:                                      <span class="hljs-string">'labels'</span>, <span class="hljs-string">'state'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">120</span>]: issues</span><br><span class="line">Out[<span class="hljs-number">120</span>]:</span><br><span class="line">    number                                              title  \</span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">17666</span>  Period does <span class="hljs-keyword">not</span> round down <span class="hljs-keyword">for</span> frequencies les...   </span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">17665</span>           DOC: improve docstring of function where   </span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">17664</span>               COMPAT: skip <span class="hljs-number">32</span>-bit test on int repr   </span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">17662</span>                          implement Delegator <span class="hljs-class"><span class="hljs-keyword">class</span></span></span><br><span class="line"><span class="hljs-class">4    17654  <span class="hljs-title">BUG</span>:</span> Fix series rename called <span class="hljs-keyword">with</span> str alterin...   </span><br><span class="line">..     ...                                                ...   </span><br><span class="line"><span class="hljs-number">25</span>   <span class="hljs-number">17603</span>  BUG: Correctly localize naive datetime strings...   </span><br><span class="line">26   17599                     core.dtypes.generic --&gt; cython   </span><br><span class="line"><span class="hljs-number">27</span>   <span class="hljs-number">17596</span>   Merge cdate_range functionality into bdate_range   </span><br><span class="line"><span class="hljs-number">28</span>   <span class="hljs-number">17587</span>  Time Grouper bug fix when applied <span class="hljs-keyword">for</span> list gro...   </span><br><span class="line"><span class="hljs-number">29</span>   <span class="hljs-number">17583</span>  BUG: fix tz-aware DatetimeIndex + TimedeltaInd...   </span><br><span class="line">                                               labels state  </span><br><span class="line"><span class="hljs-number">0</span>                                                  []  open  </span><br><span class="line"><span class="hljs-number">1</span>   [&#123;<span class="hljs-string">'id'</span>: <span class="hljs-number">134699</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://api.github.com...  open  </span></span><br><span class="line"><span class="hljs-string">2   [&#123;'</span>id<span class="hljs-string">': 563047854, '</span>url<span class="hljs-string">': '</span>https://api.github....  open  </span><br><span class="line"><span class="hljs-number">3</span>                                                  []  open  </span><br><span class="line"><span class="hljs-number">4</span>   [&#123;<span class="hljs-string">'id'</span>: <span class="hljs-number">76811</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://api.github.com/...  open  </span></span><br><span class="line"><span class="hljs-string">..                                                ...   ...  </span></span><br><span class="line"><span class="hljs-string">25  [&#123;'</span>id<span class="hljs-string">': 76811, '</span>url<span class="hljs-string">': '</span>https://api.github.com/...  open  </span><br><span class="line"><span class="hljs-number">26</span>  [&#123;<span class="hljs-string">'id'</span>: <span class="hljs-number">49094459</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://api.github.c...  open  </span></span><br><span class="line"><span class="hljs-string">27  [&#123;'</span>id<span class="hljs-string">': 35818298, '</span>url<span class="hljs-string">': '</span>https://api.github.c...  open  </span><br><span class="line"><span class="hljs-number">28</span>  [&#123;<span class="hljs-string">'id'</span>: <span class="hljs-number">233160</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://api.github.com...  open  </span></span><br><span class="line"><span class="hljs-string">29  [&#123;'</span>id<span class="hljs-string">': 76811, '</span>url<span class="hljs-string">': '</span>https://api.github.com/...  open  </span><br><span class="line">[<span class="hljs-number">30</span> rows x <span class="hljs-number">4</span> columns]</span><br></pre></td></tr></table></figure>

<p>花费一些精力，你就可以创建一些更高级的常见的Web API的接口，返回DataFrame对象，方便进行分析。</p>
<h1 id="6-4-数据库交互"><a href="#6-4-数据库交互" class="headerlink" title="6.4 数据库交互"></a>6.4 数据库交互</h1><p>在商业场景下，大多数数据可能不是存储在文本或Excel文件中。基于SQL的关系型数据库（如SQL Server、PostgreSQL和MySQL等）使用非常广泛，其它一些数据库也很流行。数据库的选择通常取决于性能、数据完整性以及应用程序的伸缩性需求。</p>
<p>将数据从SQL加载到DataFrame的过程很简单，此外pandas还有一些能够简化该过程的函数。例如，我将使用SQLite数据库（通过Python内置的sqlite3驱动器）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">121</span>]: <span class="hljs-keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: query = <span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">   .....: CREATE TABLE test</span></span><br><span class="line"><span class="hljs-string">   .....: (a VARCHAR(20), b VARCHAR(20),</span></span><br><span class="line"><span class="hljs-string">   .....:  c REAL,        d INTEGER</span></span><br><span class="line"><span class="hljs-string">   .....: );"""</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">123</span>]: con = sqlite3.connect(<span class="hljs-string">'mydata.sqlite'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">124</span>]: con.execute(query)</span><br><span class="line">Out[<span class="hljs-number">124</span>]: &lt;sqlite3.Cursor at <span class="hljs-number">0x7f6b12a50f10</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: con.commit()</span><br></pre></td></tr></table></figure>

<p>然后插入几行数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">126</span>]: data = [(<span class="hljs-string">'Atlanta'</span>, <span class="hljs-string">'Georgia'</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">6</span>),</span><br><span class="line">   .....:         (<span class="hljs-string">'Tallahassee'</span>, <span class="hljs-string">'Florida'</span>, <span class="hljs-number">2.6</span>, <span class="hljs-number">3</span>),</span><br><span class="line">   .....:         (<span class="hljs-string">'Sacramento'</span>, <span class="hljs-string">'California'</span>, <span class="hljs-number">1.7</span>, <span class="hljs-number">5</span>)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">127</span>]: stmt = <span class="hljs-string">"INSERT INTO test VALUES(?, ?, ?, ?)"</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">128</span>]: con.executemany(stmt, data)</span><br><span class="line">Out[<span class="hljs-number">128</span>]: &lt;sqlite3.Cursor at <span class="hljs-number">0x7f6b15c66ce0</span>&gt;</span><br></pre></td></tr></table></figure>

<p>从表中选取数据时，大部分Python SQL驱动器（PyODBC、psycopg2、MySQLdb、pymssql等）都会返回一个元组列表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">130</span>]: cursor = con.execute(<span class="hljs-string">'select * from test'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">131</span>]: rows = cursor.fetchall()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: rows</span><br><span class="line">Out[<span class="hljs-number">132</span>]: </span><br><span class="line">[(<span class="hljs-string">'Atlanta'</span>, <span class="hljs-string">'Georgia'</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">6</span>),</span><br><span class="line"> (<span class="hljs-string">'Tallahassee'</span>, <span class="hljs-string">'Florida'</span>, <span class="hljs-number">2.6</span>, <span class="hljs-number">3</span>),</span><br><span class="line"> (<span class="hljs-string">'Sacramento'</span>, <span class="hljs-string">'California'</span>, <span class="hljs-number">1.7</span>, <span class="hljs-number">5</span>)]</span><br></pre></td></tr></table></figure>

<p>你可以将这个元组列表传给DataFrame构造器，但还需要列名（位于光标的description属性中）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">133</span>]: cursor.description</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">((<span class="hljs-string">'a'</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>),</span><br><span class="line"> (<span class="hljs-string">'b'</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>),</span><br><span class="line"> (<span class="hljs-string">'c'</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>),</span><br><span class="line"> (<span class="hljs-string">'d'</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: pd.DataFrame(rows, columns=[x[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cursor.description])</span><br><span class="line">Out[<span class="hljs-number">134</span>]: </span><br><span class="line">             a           b     c  d</span><br><span class="line"><span class="hljs-number">0</span>      Atlanta     Georgia  <span class="hljs-number">1.25</span>  <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">1</span>  Tallahassee     Florida  <span class="hljs-number">2.60</span>  <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2</span>   Sacramento  California  <span class="hljs-number">1.70</span>  <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>这种数据规整操作相当多，你肯定不想每查一次数据库就重写一次。<a href="http://www.sqlalchemy.org/" target="_blank" rel="noopener">SQLAlchemy项目</a>是一个流行的Python SQL工具，它抽象出了SQL数据库中的许多常见差异。pandas有一个read_sql函数，可以让你轻松的从SQLAlchemy连接读取数据。这里，我们用SQLAlchemy连接SQLite数据库，并从之前创建的表读取数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">135</span>]: <span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sqla</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">136</span>]: db = sqla.create_engine(<span class="hljs-string">'sqlite:///mydata.sqlite'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: pd.read_sql(<span class="hljs-string">'select * from test'</span>, db)</span><br><span class="line">Out[<span class="hljs-number">137</span>]: </span><br><span class="line">             a           b     c  d</span><br><span class="line"><span class="hljs-number">0</span>      Atlanta     Georgia  <span class="hljs-number">1.25</span>  <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">1</span>  Tallahassee     Florida  <span class="hljs-number">2.60</span>  <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2</span>   Sacramento  California  <span class="hljs-number">1.70</span>  <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<h1 id="6-5-总结"><a href="#6-5-总结" class="headerlink" title="6.5 总结"></a>6.5 总结</h1><p>访问数据通常是数据分析的第一步。在本章中，我们已经学了一些有用的工具。在接下来的章节中，我们将深入研究数据规整、数据可视化、时间序列分析和其它主题。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7499 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC7%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E5%92%8C%E5%87%86%E5%A4%87/">《利用Python进行数据分析·第2版》第7章 数据清洗和准备</a>
            
        </h1>
        <div class="content">
            <h1 id="《利用Python进行数据分析·第2版》第7章-数据清洗和准备"><a href="#《利用Python进行数据分析·第2版》第7章-数据清洗和准备" class="headerlink" title="《利用Python进行数据分析·第2版》第7章 数据清洗和准备"></a>《利用Python进行数据分析·第2版》第7章 数据清洗和准备</h1><hr>
<p>转载自<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
第7章 数据清洗和准备
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>在数据分析和建模的过程中，相当多的时间要用在数据准备上：加载、清理、转换以及重塑。这些工作会占到分析师时间的80%或更多。有时，存储在文件和数据库中的数据的格式不适合某个特定的任务。许多研究者都选择使用通用编程语言（如Python、Perl、R或Java）或UNIX文本处理工具（如sed或awk）对数据格式进行专门处理。幸运的是，pandas和内置的Python标准库提供了一组高级的、灵活的、快速的工具，可以让你轻松地将数据规整为想要的格式。</p>
<p>如果你发现了一种本书或pandas库中没有的数据操作方式，请在邮件列表或GitHub网站上提出。实际上，pandas的许多设计和实现都是由真实应用的需求所驱动的。</p>
<p>在本章中，我会讨论处理缺失数据、重复数据、字符串操作和其它分析数据转换的工具。下一章，我会关注于用多种方法合并、重塑数据集。</p>
<h1 id="7-1-处理缺失数据"><a href="#7-1-处理缺失数据" class="headerlink" title="7.1 处理缺失数据"></a>7.1 处理缺失数据</h1><p>在许多数据分析工作中，缺失数据是经常发生的。pandas的目标之一就是尽量轻松地处理缺失数据。例如，pandas对象的所有描述性统计默认都不包括缺失数据。</p>
<p>缺失数据在pandas中呈现的方式有些不完美，但对于大多数用户可以保证功能正常。对于数值数据，pandas使用浮点值NaN（Not a Number）表示缺失数据。我们称其为哨兵值，可以方便的检测出来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: string_data = pd.Series([<span class="hljs-string">'aardvark'</span>, <span class="hljs-string">'artichoke'</span>, np.nan, <span class="hljs-string">'avocado'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: string_data</span><br><span class="line">Out[<span class="hljs-number">11</span>]:</span><br><span class="line"><span class="hljs-number">0</span>     aardvark</span><br><span class="line"><span class="hljs-number">1</span>    artichoke</span><br><span class="line"><span class="hljs-number">2</span>          NaN</span><br><span class="line"><span class="hljs-number">3</span>      avocado</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: string_data.isnull()</span><br><span class="line">Out[<span class="hljs-number">12</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-literal">True</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-literal">False</span></span><br><span class="line">dtype: bool</span><br></pre></td></tr></table></figure>

<p>在pandas中，我们采用了R语言中的惯用法，即将缺失值表示为NA，它表示不可用not available。在统计应用中，NA数据可能是不存在的数据或者虽然存在，但是没有观察到（例如，数据采集中发生了问题）。当进行数据清洗以进行分析时，最好直接对缺失数据进行分析，以判断数据采集的问题或缺失数据可能导致的偏差。</p>
<p>Python内置的None值在对象数组中也可以作为NA：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">13</span>]: string_data[<span class="hljs-number">0</span>] = <span class="hljs-literal">None</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: string_data.isnull()</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-literal">True</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-literal">True</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-literal">False</span></span><br><span class="line">dtype: bool</span><br></pre></td></tr></table></figure>

<p>pandas项目中还在不断优化内部细节以更好处理缺失数据，像用户API功能，例如pandas.isnull，去除了许多恼人的细节。表7-1列出了一些关于缺失数据处理的函数。</p>
<p><img src="/images/blog/7178691-1a0f73e5bb26ea21.webp" alt="img"></p>
<p>表7-1 NA处理方法</p>
<h2 id="滤除缺失数据"><a href="#滤除缺失数据" class="headerlink" title="滤除缺失数据"></a>滤除缺失数据</h2><p>过滤掉缺失数据的办法有很多种。你可以通过pandas.isnull或布尔索引的手工方法，但dropna可能会更实用一些。对于一个Series，dropna返回一个仅含非空数据和索引值的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: <span class="hljs-keyword">from</span> numpy <span class="hljs-keyword">import</span> nan <span class="hljs-keyword">as</span> NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: data = pd.Series([<span class="hljs-number">1</span>, NA, <span class="hljs-number">3.5</span>, NA, <span class="hljs-number">7</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: data.dropna()</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">7.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>这等价于：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: data[data.notnull()]</span><br><span class="line">Out[<span class="hljs-number">18</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">7.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>而对于DataFrame对象，事情就有点复杂了。你可能希望丢弃全NA或含有NA的行或列。dropna默认丢弃任何含有缺失值的行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">19</span>]: data = pd.DataFrame([[<span class="hljs-number">1.</span>, <span class="hljs-number">6.5</span>, <span class="hljs-number">3.</span>], [<span class="hljs-number">1.</span>, NA, NA],</span><br><span class="line">   ....:                      [NA, NA, NA], [NA, <span class="hljs-number">6.5</span>, <span class="hljs-number">3.</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: cleaned = data.dropna()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: data</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line"><span class="hljs-number">2</span>  NaN  NaN  NaN</span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: cleaned</span><br><span class="line">Out[<span class="hljs-number">22</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>传入how=’all’将只丢弃全为NA的那些行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">23</span>]: data.dropna(how=<span class="hljs-string">'all'</span>)</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>用这种方式丢弃列，只需传入axis=1即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: data[<span class="hljs-number">4</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: data</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span>   <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span> NaN</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span>  NaN  NaN NaN</span><br><span class="line"><span class="hljs-number">2</span>  NaN  NaN  NaN NaN</span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span> NaN</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">26</span>]: data.dropna(axis=<span class="hljs-number">1</span>, how=<span class="hljs-string">'all'</span>)</span><br><span class="line">Out[<span class="hljs-number">26</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line"><span class="hljs-number">2</span>  NaN  NaN  NaN</span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>另一个滤除DataFrame行的问题涉及时间序列数据。假设你只想留下一部分观测数据，可以用thresh参数实现此目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">27</span>]: df = pd.DataFrame(np.random.randn(<span class="hljs-number">7</span>, <span class="hljs-number">3</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: df.iloc[:<span class="hljs-number">4</span>, <span class="hljs-number">1</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">29</span>]: df.iloc[:<span class="hljs-number">2</span>, <span class="hljs-number">2</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: df</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>       NaN       NaN</span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.555730</span>       NaN       NaN</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>       NaN  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>       NaN <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: df.dropna()</span><br><span class="line">Out[<span class="hljs-number">31</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: df.dropna(thresh=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">32</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>       NaN  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>       NaN <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br></pre></td></tr></table></figure>

<h2 id="填充缺失数据"><a href="#填充缺失数据" class="headerlink" title="填充缺失数据"></a>填充缺失数据</h2><p>你可能不想滤除缺失数据（有可能会丢弃跟它有关的其他数据），而是希望通过其他方式填补那些“空洞”。对于大多数情况而言，fillna方法是最主要的函数。通过一个常数调用fillna就会将缺失值替换为那个常数值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: df.fillna(<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">0.000000</span> <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br></pre></td></tr></table></figure>

<p>若是通过一个字典调用fillna，就可以实现对不同的列填充不同的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">34</span>]: df.fillna(&#123;<span class="hljs-number">1</span>: <span class="hljs-number">0.5</span>, <span class="hljs-number">2</span>: <span class="hljs-number">0</span>&#125;)</span><br><span class="line">Out[<span class="hljs-number">34</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.500000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.500000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>  <span class="hljs-number">0.500000</span>  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">0.500000</span> <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br></pre></td></tr></table></figure>

<p>fillna默认会返回新对象，但也可以对现有对象进行就地修改：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: _ = df.fillna(<span class="hljs-number">0</span>, inplace=<span class="hljs-literal">True</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: df</span><br><span class="line">Out[<span class="hljs-number">36</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">0.000000</span> <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br></pre></td></tr></table></figure>

<p>对reindexing有效的那些插值方法也可用于fillna：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">37</span>]: df = pd.DataFrame(np.random.randn(<span class="hljs-number">6</span>, <span class="hljs-number">3</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: df.iloc[<span class="hljs-number">2</span>:, <span class="hljs-number">1</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">39</span>]: df.iloc[<span class="hljs-number">4</span>:, <span class="hljs-number">2</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: df</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.476985</span>  <span class="hljs-number">3.248944</span> <span class="hljs-number">-1.021228</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.577087</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.523772</span>       NaN  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.713544</span>       NaN <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">-1.860761</span>       NaN       NaN</span><br><span class="line"><span class="hljs-number">5</span> <span class="hljs-number">-1.265934</span>       NaN       NaN</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: df.fillna(method=<span class="hljs-string">'ffill'</span>)</span><br><span class="line">Out[<span class="hljs-number">41</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.476985</span>  <span class="hljs-number">3.248944</span> <span class="hljs-number">-1.021228</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.577087</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.713544</span>  <span class="hljs-number">0.124121</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">-1.860761</span>  <span class="hljs-number">0.124121</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">5</span> <span class="hljs-number">-1.265934</span>  <span class="hljs-number">0.124121</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: df.fillna(method=<span class="hljs-string">'ffill'</span>, limit=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">42</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.476985</span>  <span class="hljs-number">3.248944</span> <span class="hljs-number">-1.021228</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.577087</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.713544</span>  <span class="hljs-number">0.124121</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">-1.860761</span>       NaN <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">5</span> <span class="hljs-number">-1.265934</span>       NaN <span class="hljs-number">-2.370232</span></span><br></pre></td></tr></table></figure>

<p>只要有些创新，你就可以利用fillna实现许多别的功能。比如说，你可以传入Series的平均值或中位数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">43</span>]: data = pd.Series([<span class="hljs-number">1.</span>, NA, <span class="hljs-number">3.5</span>, NA, <span class="hljs-number">7</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">44</span>]: data.fillna(data.mean())</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.000000</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">3.833333</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">3.500000</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">3.833333</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">7.000000</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>表7-2列出了fillna的参考。</p>
<p><img src="/images/blog/7178691-0bf235386a64c3b5.webp" alt="img"></p>
<p><img src="/images/blog/7178691-4edd39e68f4dc530.webp" alt="img"></p>
<p>fillna函数参数</p>
<h1 id="7-2-数据转换"><a href="#7-2-数据转换" class="headerlink" title="7.2 数据转换"></a>7.2 数据转换</h1><p>本章到目前为止介绍的都是数据的重排。另一类重要操作则是过滤、清理以及其他的转换工作。</p>
<h2 id="移除重复数据"><a href="#移除重复数据" class="headerlink" title="移除重复数据"></a>移除重复数据</h2><p>DataFrame中出现重复行有多种原因。下面就是一个例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: data = pd.DataFrame(&#123;<span class="hljs-string">'k1'</span>: [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>] * <span class="hljs-number">3</span> + [<span class="hljs-string">'two'</span>],</span><br><span class="line">   ....:                      <span class="hljs-string">'k2'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: data</span><br><span class="line">Out[<span class="hljs-number">46</span>]: </span><br><span class="line">    k1  k2</span><br><span class="line"><span class="hljs-number">0</span>  one   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>  two   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  one   <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  two   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>  one   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">5</span>  two   <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">6</span>  two   <span class="hljs-number">4</span></span><br></pre></td></tr></table></figure>

<p>DataFrame的duplicated方法返回一个布尔型Series，表示各行是否是重复行（前面出现过的行）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">47</span>]: data.duplicated()</span><br><span class="line">Out[<span class="hljs-number">47</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-literal">True</span></span><br><span class="line">dtype: bool</span><br></pre></td></tr></table></figure>

<p>还有一个与此相关的drop_duplicates方法，它会返回一个DataFrame，重复的数组会标为False：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">48</span>]: data.drop_duplicates()</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line">    k1  k2</span><br><span class="line"><span class="hljs-number">0</span>  one   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>  two   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  one   <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  two   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>  one   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">5</span>  two   <span class="hljs-number">4</span></span><br></pre></td></tr></table></figure>

<p>这两个方法默认会判断全部列，你也可以指定部分列进行重复项判断。假设我们还有一列值，且只希望根据k1列过滤重复项：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: data[<span class="hljs-string">'v1'</span>] = range(<span class="hljs-number">7</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">50</span>]: data.drop_duplicates([<span class="hljs-string">'k1'</span>])</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">    k1  k2  v1</span><br><span class="line"><span class="hljs-number">0</span>  one   <span class="hljs-number">1</span>   <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  two   <span class="hljs-number">1</span>   <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>duplicated和drop_duplicates默认保留的是第一个出现的值组合。传入keep=’last’则保留最后一个：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">51</span>]: data.drop_duplicates([<span class="hljs-string">'k1'</span>, <span class="hljs-string">'k2'</span>], keep=<span class="hljs-string">'last'</span>)</span><br><span class="line">Out[<span class="hljs-number">51</span>]: </span><br><span class="line">    k1  k2  v1</span><br><span class="line"><span class="hljs-number">0</span>  one   <span class="hljs-number">1</span>   <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  two   <span class="hljs-number">1</span>   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  one   <span class="hljs-number">2</span>   <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  two   <span class="hljs-number">3</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>  one   <span class="hljs-number">3</span>   <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">6</span>  two   <span class="hljs-number">4</span>   <span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<h2 id="利用函数或映射进行数据转换"><a href="#利用函数或映射进行数据转换" class="headerlink" title="利用函数或映射进行数据转换"></a>利用函数或映射进行数据转换</h2><p>对于许多数据集，你可能希望根据数组、Series或DataFrame列中的值来实现转换工作。我们来看看下面这组有关肉类的数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">52</span>]: data = pd.DataFrame(&#123;<span class="hljs-string">'food'</span>: [<span class="hljs-string">'bacon'</span>, <span class="hljs-string">'pulled pork'</span>, <span class="hljs-string">'bacon'</span>,</span><br><span class="line">   ....:                               <span class="hljs-string">'Pastrami'</span>, <span class="hljs-string">'corned beef'</span>, <span class="hljs-string">'Bacon'</span>,</span><br><span class="line">   ....:                               <span class="hljs-string">'pastrami'</span>, <span class="hljs-string">'honey ham'</span>, <span class="hljs-string">'nova lox'</span>],</span><br><span class="line">   ....:                      <span class="hljs-string">'ounces'</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">12</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7.5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: data</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">          food  ounces</span><br><span class="line"><span class="hljs-number">0</span>        bacon     <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">1</span>  pulled pork     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">2</span>        bacon    <span class="hljs-number">12.0</span></span><br><span class="line"><span class="hljs-number">3</span>     Pastrami     <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">4</span>  corned beef     <span class="hljs-number">7.5</span></span><br><span class="line"><span class="hljs-number">5</span>        Bacon     <span class="hljs-number">8.0</span></span><br><span class="line"><span class="hljs-number">6</span>     pastrami     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">7</span>    honey ham     <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">8</span>     nova lox     <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>假设你想要添加一列表示该肉类食物来源的动物类型。我们先编写一个不同肉类到动物的映射：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meat_to_animal = &#123;</span><br><span class="line">  <span class="hljs-string">'bacon'</span>: <span class="hljs-string">'pig'</span>,</span><br><span class="line">  <span class="hljs-string">'pulled pork'</span>: <span class="hljs-string">'pig'</span>,</span><br><span class="line">  <span class="hljs-string">'pastrami'</span>: <span class="hljs-string">'cow'</span>,</span><br><span class="line">  <span class="hljs-string">'corned beef'</span>: <span class="hljs-string">'cow'</span>,</span><br><span class="line">  <span class="hljs-string">'honey ham'</span>: <span class="hljs-string">'pig'</span>,</span><br><span class="line">  <span class="hljs-string">'nova lox'</span>: <span class="hljs-string">'salmon'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Series的map方法可以接受一个函数或含有映射关系的字典型对象，但是这里有一个小问题，即有些肉类的首字母大写了，而另一些则没有。因此，我们还需要使用Series的str.lower方法，将各个值转换为小写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">55</span>]: lowercased = data[<span class="hljs-string">'food'</span>].str.lower()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">56</span>]: lowercased</span><br><span class="line">Out[<span class="hljs-number">56</span>]: </span><br><span class="line"><span class="hljs-number">0</span>          bacon</span><br><span class="line"><span class="hljs-number">1</span>    pulled pork</span><br><span class="line"><span class="hljs-number">2</span>          bacon</span><br><span class="line"><span class="hljs-number">3</span>       pastrami</span><br><span class="line"><span class="hljs-number">4</span>    corned beef</span><br><span class="line"><span class="hljs-number">5</span>          bacon</span><br><span class="line"><span class="hljs-number">6</span>       pastrami</span><br><span class="line"><span class="hljs-number">7</span>      honey ham</span><br><span class="line"><span class="hljs-number">8</span>       nova lox</span><br><span class="line">Name: food, dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">57</span>]: data[<span class="hljs-string">'animal'</span>] = lowercased.map(meat_to_animal)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: data</span><br><span class="line">Out[<span class="hljs-number">58</span>]: </span><br><span class="line">          food  ounces  animal</span><br><span class="line"><span class="hljs-number">0</span>        bacon     <span class="hljs-number">4.0</span>     pig</span><br><span class="line"><span class="hljs-number">1</span>  pulled pork     <span class="hljs-number">3.0</span>     pig</span><br><span class="line"><span class="hljs-number">2</span>        bacon    <span class="hljs-number">12.0</span>     pig</span><br><span class="line"><span class="hljs-number">3</span>     Pastrami     <span class="hljs-number">6.0</span>     cow</span><br><span class="line"><span class="hljs-number">4</span>  corned beef     <span class="hljs-number">7.5</span>     cow</span><br><span class="line"><span class="hljs-number">5</span>        Bacon     <span class="hljs-number">8.0</span>     pig</span><br><span class="line"><span class="hljs-number">6</span>     pastrami     <span class="hljs-number">3.0</span>     cow</span><br><span class="line"><span class="hljs-number">7</span>    honey ham     <span class="hljs-number">5.0</span>     pig</span><br><span class="line"><span class="hljs-number">8</span>     nova lox     <span class="hljs-number">6.0</span>  salmon</span><br></pre></td></tr></table></figure>

<p>我们也可以传入一个能够完成全部这些工作的函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">59</span>]: data[<span class="hljs-string">'food'</span>].map(<span class="hljs-keyword">lambda</span> x: meat_to_animal[x.lower()])</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line"><span class="hljs-number">0</span>       pig</span><br><span class="line"><span class="hljs-number">1</span>       pig</span><br><span class="line"><span class="hljs-number">2</span>       pig</span><br><span class="line"><span class="hljs-number">3</span>       cow</span><br><span class="line"><span class="hljs-number">4</span>       cow</span><br><span class="line"><span class="hljs-number">5</span>       pig</span><br><span class="line"><span class="hljs-number">6</span>       cow</span><br><span class="line"><span class="hljs-number">7</span>       pig</span><br><span class="line"><span class="hljs-number">8</span>    salmon</span><br><span class="line">Name: food, dtype: object</span><br></pre></td></tr></table></figure>

<p>使用map是一种实现元素级转换以及其他数据清理工作的便捷方式。</p>
<h2 id="替换值"><a href="#替换值" class="headerlink" title="替换值"></a>替换值</h2><p>利用fillna方法填充缺失数据可以看做值替换的一种特殊情况。前面已经看到，map可用于修改对象的数据子集，而replace则提供了一种实现该功能的更简单、更灵活的方式。我们来看看下面这个Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: data = pd.Series([<span class="hljs-number">1.</span>, <span class="hljs-number">-999.</span>, <span class="hljs-number">2.</span>, <span class="hljs-number">-999.</span>, <span class="hljs-number">-1000.</span>, <span class="hljs-number">3.</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: data</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-999.0</span></span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">-999.0</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">-1000.0</span></span><br><span class="line"><span class="hljs-number">5</span>       <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>-999这个值可能是一个表示缺失数据的标记值。要将其替换为pandas能够理解的NA值，我们可以利用replace来产生一个新的Series（除非传入inplace=True）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: data.replace(<span class="hljs-number">-999</span>, np.nan)</span><br><span class="line">Out[<span class="hljs-number">62</span>]: </span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>       NaN</span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>       NaN</span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">-1000.0</span></span><br><span class="line"><span class="hljs-number">5</span>       <span class="hljs-number">3.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>如果你希望一次性替换多个值，可以传入一个由待替换值组成的列表以及一个替换值：：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">63</span>]: data.replace([<span class="hljs-number">-999</span>, <span class="hljs-number">-1000</span>], np.nan)</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    NaN</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    NaN</span><br><span class="line"><span class="hljs-number">4</span>    NaN</span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">3.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>要让每个值有不同的替换值，可以传递一个替换列表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">64</span>]: data.replace([<span class="hljs-number">-999</span>, <span class="hljs-number">-1000</span>], [np.nan, <span class="hljs-number">0</span>])</span><br><span class="line">Out[<span class="hljs-number">64</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    NaN</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    NaN</span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">3.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>传入的参数也可以是字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: data.replace(&#123;<span class="hljs-number">-999</span>: np.nan, <span class="hljs-number">-1000</span>: <span class="hljs-number">0</span>&#125;)</span><br><span class="line">Out[<span class="hljs-number">65</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    NaN</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    NaN</span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">3.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：data.replace方法与data.str.replace不同，后者做的是字符串的元素级替换。我们会在后面学习Series的字符串方法。</p>
</blockquote>
<h2 id="重命名轴索引"><a href="#重命名轴索引" class="headerlink" title="重命名轴索引"></a>重命名轴索引</h2><p>跟Series中的值一样，轴标签也可以通过函数或映射进行转换，从而得到一个新的不同标签的对象。轴还可以被就地修改，而无需新建一个数据结构。接下来看看下面这个简单的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: data = pd.DataFrame(np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)),</span><br><span class="line">   ....:                     index=[<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Colorado'</span>, <span class="hljs-string">'New York'</span>],</span><br><span class="line">   ....:                     columns=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>])</span><br></pre></td></tr></table></figure>

<p>跟Series一样，轴索引也有一个map方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">67</span>]: transform = <span class="hljs-keyword">lambda</span> x: x[:<span class="hljs-number">4</span>].upper()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">68</span>]: data.index.map(transform)</span><br><span class="line">Out[<span class="hljs-number">68</span>]: Index([<span class="hljs-string">'OHIO'</span>, <span class="hljs-string">'COLO'</span>, <span class="hljs-string">'NEW '</span>], dtype=<span class="hljs-string">'object'</span>)</span><br></pre></td></tr></table></figure>

<p>你可以将其赋值给index，这样就可以对DataFrame进行就地修改：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: data.index = data.index.map(transform)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: data</span><br><span class="line">Out[<span class="hljs-number">70</span>]:</span><br><span class="line">one  two  three  four</span><br><span class="line">OHIO    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span>     <span class="hljs-number">3</span></span><br><span class="line">COLO    <span class="hljs-number">4</span>    <span class="hljs-number">5</span>      <span class="hljs-number">6</span>     <span class="hljs-number">7</span></span><br><span class="line">NEW     <span class="hljs-number">8</span>    <span class="hljs-number">9</span>     <span class="hljs-number">10</span>    <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>如果想要创建数据集的转换版（而不是修改原始数据），比较实用的方法是rename：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">71</span>]: data.rename(index=str.title, columns=str.upper)</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line">      ONE  TWO  THREE  FOUR</span><br><span class="line">Ohio    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span>     <span class="hljs-number">3</span></span><br><span class="line">Colo    <span class="hljs-number">4</span>    <span class="hljs-number">5</span>      <span class="hljs-number">6</span>     <span class="hljs-number">7</span></span><br><span class="line">New     <span class="hljs-number">8</span>    <span class="hljs-number">9</span>     <span class="hljs-number">10</span>    <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>特别说明一下，rename可以结合字典型对象实现对部分轴标签的更新：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">72</span>]: data.rename(index=&#123;<span class="hljs-string">'OHIO'</span>: <span class="hljs-string">'INDIANA'</span>&#125;,</span><br><span class="line">   ....:             columns=&#123;<span class="hljs-string">'three'</span>: <span class="hljs-string">'peekaboo'</span>&#125;)</span><br><span class="line">Out[<span class="hljs-number">72</span>]:</span><br><span class="line">one  two  peekaboo  four</span><br><span class="line">INDIANA    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>         <span class="hljs-number">2</span>     <span class="hljs-number">3</span></span><br><span class="line">COLO       <span class="hljs-number">4</span>    <span class="hljs-number">5</span>         <span class="hljs-number">6</span>     <span class="hljs-number">7</span></span><br><span class="line">NEW        <span class="hljs-number">8</span>    <span class="hljs-number">9</span>        <span class="hljs-number">10</span>    <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>rename可以实现复制DataFrame并对其索引和列标签进行赋值。如果希望就地修改某个数据集，传入inplace=True即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: data.rename(index=&#123;<span class="hljs-string">'OHIO'</span>: <span class="hljs-string">'INDIANA'</span>&#125;, inplace=<span class="hljs-literal">True</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">74</span>]: data</span><br><span class="line">Out[<span class="hljs-number">74</span>]: </span><br><span class="line">         one  two  three  four</span><br><span class="line">INDIANA    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span>     <span class="hljs-number">3</span></span><br><span class="line">COLO       <span class="hljs-number">4</span>    <span class="hljs-number">5</span>      <span class="hljs-number">6</span>     <span class="hljs-number">7</span></span><br><span class="line">NEW        <span class="hljs-number">8</span>    <span class="hljs-number">9</span>     <span class="hljs-number">10</span>    <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<h2 id="离散化和面元划分"><a href="#离散化和面元划分" class="headerlink" title="离散化和面元划分"></a>离散化和面元划分</h2><p>为了便于分析，连续数据常常被离散化或拆分为“面元”（bin）。假设有一组人员数据，而你希望将它们划分为不同的年龄组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: ages = [<span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">25</span>, <span class="hljs-number">27</span>, <span class="hljs-number">21</span>, <span class="hljs-number">23</span>, <span class="hljs-number">37</span>, <span class="hljs-number">31</span>, <span class="hljs-number">61</span>, <span class="hljs-number">45</span>, <span class="hljs-number">41</span>, <span class="hljs-number">32</span>]</span><br></pre></td></tr></table></figure>

<p>接下来将这些数据划分为“18到25”、“26到35”、“35到60”以及“60以上”几个面元。要实现该功能，你需要使用pandas的cut函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">76</span>]: bins = [<span class="hljs-number">18</span>, <span class="hljs-number">25</span>, <span class="hljs-number">35</span>, <span class="hljs-number">60</span>, <span class="hljs-number">100</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: cats = pd.cut(ages, bins)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: cats</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">[(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], (<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], (<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>], (<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], ..., (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>], (<span class="hljs-number">60</span>, <span class="hljs-number">100</span>], (<span class="hljs-number">35</span>,<span class="hljs-number">60</span>], (<span class="hljs-number">35</span>, <span class="hljs-number">60</span>], (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>]]</span><br><span class="line">Length: <span class="hljs-number">12</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[int64]): [(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>] &lt; (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>] &lt; (<span class="hljs-number">35</span>, <span class="hljs-number">60</span>] &lt; (<span class="hljs-number">60</span>, <span class="hljs-number">100</span>]]</span><br></pre></td></tr></table></figure>

<p>pandas返回的是一个特殊的Categorical对象。结果展示了pandas.cut划分的面元。你可以将其看做一组表示面元名称的字符串。它的底层含有一个表示不同分类名称的类型数组，以及一个codes属性中的年龄数据的标签：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: cats.codes</span><br><span class="line">Out[<span class="hljs-number">79</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>], dtype=int8)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">80</span>]: cats.categories</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">IntervalIndex([(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>], (<span class="hljs-number">35</span>, <span class="hljs-number">60</span>], (<span class="hljs-number">60</span>, <span class="hljs-number">100</span>]]</span><br><span class="line">              closed=<span class="hljs-string">'right'</span>,</span><br><span class="line">              dtype=<span class="hljs-string">'interval[int64]'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">81</span>]: pd.value_counts(cats)</span><br><span class="line">Out[<span class="hljs-number">81</span>]: </span><br><span class="line">(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>]     <span class="hljs-number">5</span></span><br><span class="line">(<span class="hljs-number">35</span>, <span class="hljs-number">60</span>]     <span class="hljs-number">3</span></span><br><span class="line">(<span class="hljs-number">25</span>, <span class="hljs-number">35</span>]     <span class="hljs-number">3</span></span><br><span class="line">(<span class="hljs-number">60</span>, <span class="hljs-number">100</span>]    <span class="hljs-number">1</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>pd.value_counts(cats)是pandas.cut结果的面元计数。</p>
<p>跟“区间”的数学符号一样，圆括号表示开端，而方括号则表示闭端（包括）。哪边是闭端可以通过right=False进行修改：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: pd.cut(ages, [<span class="hljs-number">18</span>, <span class="hljs-number">26</span>, <span class="hljs-number">36</span>, <span class="hljs-number">61</span>, <span class="hljs-number">100</span>], right=<span class="hljs-literal">False</span>)</span><br><span class="line">Out[<span class="hljs-number">82</span>]: </span><br><span class="line">[[<span class="hljs-number">18</span>, <span class="hljs-number">26</span>), [<span class="hljs-number">18</span>, <span class="hljs-number">26</span>), [<span class="hljs-number">18</span>, <span class="hljs-number">26</span>), [<span class="hljs-number">26</span>, <span class="hljs-number">36</span>), [<span class="hljs-number">18</span>, <span class="hljs-number">26</span>), ..., [<span class="hljs-number">26</span>, <span class="hljs-number">36</span>), [<span class="hljs-number">61</span>, <span class="hljs-number">100</span>), [<span class="hljs-number">36</span>,</span><br><span class="line"> <span class="hljs-number">61</span>), [<span class="hljs-number">36</span>, <span class="hljs-number">61</span>), [<span class="hljs-number">26</span>, <span class="hljs-number">36</span>)]</span><br><span class="line">Length: <span class="hljs-number">12</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[int64]): [[<span class="hljs-number">18</span>, <span class="hljs-number">26</span>) &lt; [<span class="hljs-number">26</span>, <span class="hljs-number">36</span>) &lt; [<span class="hljs-number">36</span>, <span class="hljs-number">61</span>) &lt; [<span class="hljs-number">61</span>, <span class="hljs-number">100</span>)]</span><br></pre></td></tr></table></figure>

<p>你可 以通过传递一个列表或数组到labels，设置自己的面元名称：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">83</span>]: group_names = [<span class="hljs-string">'Youth'</span>, <span class="hljs-string">'YoungAdult'</span>, <span class="hljs-string">'MiddleAged'</span>, <span class="hljs-string">'Senior'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: pd.cut(ages, bins, labels=group_names)</span><br><span class="line">Out[<span class="hljs-number">84</span>]: </span><br><span class="line">[Youth, Youth, Youth, YoungAdult, Youth, ..., YoungAdult, Senior, MiddleAged, Mid</span><br><span class="line">dleAged, YoungAdult]</span><br><span class="line">Length: <span class="hljs-number">12</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [Youth &lt; YoungAdult &lt; MiddleAged &lt; Senior]</span><br></pre></td></tr></table></figure>

<p>如果向cut传入的是面元的数量而不是确切的面元边界，则它会根据数据的最小值和最大值计算等长面元。下面这个例子中，我们将一些均匀分布的数据分成四组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: data = np.random.rand(<span class="hljs-number">20</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: pd.cut(data, <span class="hljs-number">4</span>, precision=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line">[(<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.76</span>, <span class="hljs-number">0.97</span>], (<span class="hljs-number">0.76</span>, <span class="hljs-number">0.97</span>], (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], ..., (<span class="hljs-number">0.34</span></span><br><span class="line">, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.55</span>, <span class="hljs-number">0.76</span>], (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.12</span>, <span class="hljs-number">0.34</span>]]</span><br><span class="line">Length: <span class="hljs-number">20</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">0.12</span>, <span class="hljs-number">0.34</span>] &lt; (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>] &lt; (<span class="hljs-number">0.55</span>, <span class="hljs-number">0.76</span>] &lt; </span><br><span class="line">(<span class="hljs-number">0.76</span>, <span class="hljs-number">0.97</span>]]</span><br></pre></td></tr></table></figure>

<p>选项precision=2，限定小数只有两位。</p>
<p>qcut是一个非常类似于cut的函数，它可以根据样本分位数对数据进行面元划分。根据数据的分布情况，cut可能无法使各个面元中含有相同数量的数据点。而qcut由于使用的是样本分位数，因此可以得到大小基本相等的面元：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: data = np.random.randn(<span class="hljs-number">1000</span>)  <span class="hljs-comment"># Normally distributed</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: cats = pd.qcut(data, <span class="hljs-number">4</span>)  <span class="hljs-comment"># Cut into quartiles</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: cats</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">[(<span class="hljs-number">-0.0265</span>, <span class="hljs-number">0.62</span>], (<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>], (<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>], (<span class="hljs-number">-0.0265</span>, <span class="hljs-number">0.62</span>]</span><br><span class="line">, ..., (<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.68</span>], (<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>], (<span class="hljs-number">-0.68</span>,</span><br><span class="line"> <span class="hljs-number">-0.0265</span>]]</span><br><span class="line">Length: <span class="hljs-number">1000</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.68</span>] &lt; (<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>] &lt; (<span class="hljs-number">-0.0265</span>,</span><br><span class="line"> <span class="hljs-number">0.62</span>] &lt;</span><br><span class="line">                                    (<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: pd.value_counts(cats)</span><br><span class="line">Out[<span class="hljs-number">90</span>]:</span><br><span class="line">(<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>]       <span class="hljs-number">250</span></span><br><span class="line">(<span class="hljs-number">-0.0265</span>, <span class="hljs-number">0.62</span>]     <span class="hljs-number">250</span></span><br><span class="line">(<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>]    <span class="hljs-number">250</span></span><br><span class="line">(<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.68</span>]      <span class="hljs-number">250</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>与cut类似，你也可以传递自定义的分位数（0到1之间的数值，包含端点）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: pd.qcut(data, [<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">1.</span>])</span><br><span class="line">Out[<span class="hljs-number">91</span>]: </span><br><span class="line">[(<span class="hljs-number">-0.0265</span>, <span class="hljs-number">1.286</span>], (<span class="hljs-number">-0.0265</span>, <span class="hljs-number">1.286</span>], (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-0.0265</span>, <span class="hljs-number">1.286</span>], (<span class="hljs-number">-0.026</span></span><br><span class="line"><span class="hljs-number">5</span>, <span class="hljs-number">1.286</span>], ..., (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-2.95</span>, <span class="hljs-number">-1.187</span>], (<span class="hljs-number">-0.0265</span>, </span><br><span class="line"><span class="hljs-number">1.286</span>], (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>]]</span><br><span class="line">Length: <span class="hljs-number">1000</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">-2.95</span>, <span class="hljs-number">-1.187</span>] &lt; (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>] &lt; (<span class="hljs-number">-0.026</span></span><br><span class="line"><span class="hljs-number">5</span>, <span class="hljs-number">1.286</span>] &lt;</span><br><span class="line">                                    (<span class="hljs-number">1.286</span>, <span class="hljs-number">3.928</span>]]</span><br></pre></td></tr></table></figure>

<p>本章稍后在讲解聚合和分组运算时会再次用到cut和qcut，因为这两个离散化函数对分位和分组分析非常重要。</p>
<h2 id="检测和过滤异常值"><a href="#检测和过滤异常值" class="headerlink" title="检测和过滤异常值"></a>检测和过滤异常值</h2><p>过滤或变换异常值（outlier）在很大程度上就是运用数组运算。来看一个含有正态分布数据的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">92</span>]: data = pd.DataFrame(np.random.randn(<span class="hljs-number">1000</span>, <span class="hljs-number">4</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: data.describe()</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line">                 <span class="hljs-number">0</span>            <span class="hljs-number">1</span>            <span class="hljs-number">2</span>            <span class="hljs-number">3</span></span><br><span class="line">count  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span></span><br><span class="line">mean      <span class="hljs-number">0.049091</span>     <span class="hljs-number">0.026112</span>    <span class="hljs-number">-0.002544</span>    <span class="hljs-number">-0.051827</span></span><br><span class="line">std       <span class="hljs-number">0.996947</span>     <span class="hljs-number">1.007458</span>     <span class="hljs-number">0.995232</span>     <span class="hljs-number">0.998311</span></span><br><span class="line">min      <span class="hljs-number">-3.645860</span>    <span class="hljs-number">-3.184377</span>    <span class="hljs-number">-3.745356</span>    <span class="hljs-number">-3.428254</span></span><br><span class="line"><span class="hljs-number">25</span>%      <span class="hljs-number">-0.599807</span>    <span class="hljs-number">-0.612162</span>    <span class="hljs-number">-0.687373</span>    <span class="hljs-number">-0.747478</span></span><br><span class="line"><span class="hljs-number">50</span>%       <span class="hljs-number">0.047101</span>    <span class="hljs-number">-0.013609</span>    <span class="hljs-number">-0.022158</span>    <span class="hljs-number">-0.088274</span></span><br><span class="line"><span class="hljs-number">75</span>%       <span class="hljs-number">0.756646</span>     <span class="hljs-number">0.695298</span>     <span class="hljs-number">0.699046</span>     <span class="hljs-number">0.623331</span></span><br><span class="line">max       <span class="hljs-number">2.653656</span>     <span class="hljs-number">3.525865</span>     <span class="hljs-number">2.735527</span>     <span class="hljs-number">3.366626</span></span><br></pre></td></tr></table></figure>

<p>假设你想要找出某列中绝对值大小超过3的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: col = data[<span class="hljs-number">2</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: col[np.abs(col) &gt; <span class="hljs-number">3</span>]</span><br><span class="line">Out[<span class="hljs-number">95</span>]: </span><br><span class="line"><span class="hljs-number">41</span>    <span class="hljs-number">-3.399312</span></span><br><span class="line"><span class="hljs-number">136</span>   <span class="hljs-number">-3.745356</span></span><br><span class="line">Name: <span class="hljs-number">2</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>要选出全部含有“超过3或－3的值”的行，你可以在布尔型DataFrame中使用any方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: data[(np.abs(data) &gt; <span class="hljs-number">3</span>).any(<span class="hljs-number">1</span>)]</span><br><span class="line">Out[<span class="hljs-number">96</span>]: </span><br><span class="line">            <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span>         <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">41</span>   <span class="hljs-number">0.457246</span> <span class="hljs-number">-0.025907</span> <span class="hljs-number">-3.399312</span> <span class="hljs-number">-0.974657</span></span><br><span class="line"><span class="hljs-number">60</span>   <span class="hljs-number">1.951312</span>  <span class="hljs-number">3.260383</span>  <span class="hljs-number">0.963301</span>  <span class="hljs-number">1.201206</span></span><br><span class="line"><span class="hljs-number">136</span>  <span class="hljs-number">0.508391</span> <span class="hljs-number">-0.196713</span> <span class="hljs-number">-3.745356</span> <span class="hljs-number">-1.520113</span></span><br><span class="line"><span class="hljs-number">235</span> <span class="hljs-number">-0.242459</span> <span class="hljs-number">-3.056990</span>  <span class="hljs-number">1.918403</span> <span class="hljs-number">-0.578828</span></span><br><span class="line"><span class="hljs-number">258</span>  <span class="hljs-number">0.682841</span>  <span class="hljs-number">0.326045</span>  <span class="hljs-number">0.425384</span> <span class="hljs-number">-3.428254</span></span><br><span class="line"><span class="hljs-number">322</span>  <span class="hljs-number">1.179227</span> <span class="hljs-number">-3.184377</span>  <span class="hljs-number">1.369891</span> <span class="hljs-number">-1.074833</span></span><br><span class="line"><span class="hljs-number">544</span> <span class="hljs-number">-3.548824</span>  <span class="hljs-number">1.553205</span> <span class="hljs-number">-2.186301</span>  <span class="hljs-number">1.277104</span></span><br><span class="line"><span class="hljs-number">635</span> <span class="hljs-number">-0.578093</span>  <span class="hljs-number">0.193299</span>  <span class="hljs-number">1.397822</span>  <span class="hljs-number">3.366626</span></span><br><span class="line"><span class="hljs-number">782</span> <span class="hljs-number">-0.207434</span>  <span class="hljs-number">3.525865</span>  <span class="hljs-number">0.283070</span>  <span class="hljs-number">0.544635</span></span><br><span class="line"><span class="hljs-number">803</span> <span class="hljs-number">-3.645860</span>  <span class="hljs-number">0.255475</span> <span class="hljs-number">-0.549574</span> <span class="hljs-number">-1.907459</span></span><br></pre></td></tr></table></figure>

<p>根据这些条件，就可以对值进行设置。下面的代码可以将值限制在区间－3到3以内：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">97</span>]: data[np.abs(data) &gt; <span class="hljs-number">3</span>] = np.sign(data) * <span class="hljs-number">3</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: data.describe()</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">                 <span class="hljs-number">0</span>            <span class="hljs-number">1</span>            <span class="hljs-number">2</span>            <span class="hljs-number">3</span></span><br><span class="line">count  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span></span><br><span class="line">mean      <span class="hljs-number">0.050286</span>     <span class="hljs-number">0.025567</span>    <span class="hljs-number">-0.001399</span>    <span class="hljs-number">-0.051765</span></span><br><span class="line">std       <span class="hljs-number">0.992920</span>     <span class="hljs-number">1.004214</span>     <span class="hljs-number">0.991414</span>     <span class="hljs-number">0.995761</span></span><br><span class="line">min      <span class="hljs-number">-3.000000</span>    <span class="hljs-number">-3.000000</span>    <span class="hljs-number">-3.000000</span>    <span class="hljs-number">-3.000000</span></span><br><span class="line"><span class="hljs-number">25</span>%      <span class="hljs-number">-0.599807</span>    <span class="hljs-number">-0.612162</span>    <span class="hljs-number">-0.687373</span>    <span class="hljs-number">-0.747478</span></span><br><span class="line"><span class="hljs-number">50</span>%       <span class="hljs-number">0.047101</span>    <span class="hljs-number">-0.013609</span>    <span class="hljs-number">-0.022158</span>    <span class="hljs-number">-0.088274</span></span><br><span class="line"><span class="hljs-number">75</span>%       <span class="hljs-number">0.756646</span>     <span class="hljs-number">0.695298</span>     <span class="hljs-number">0.699046</span>     <span class="hljs-number">0.623331</span></span><br><span class="line">max       <span class="hljs-number">2.653656</span>     <span class="hljs-number">3.000000</span>     <span class="hljs-number">2.735527</span>     <span class="hljs-number">3.000000</span></span><br></pre></td></tr></table></figure>

<p>根据数据的值是正还是负，np.sign(data)可以生成1和-1：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">99</span>]: np.sign(data).head()</span><br><span class="line">Out[<span class="hljs-number">99</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-1.0</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span> <span class="hljs-number">-1.0</span></span><br></pre></td></tr></table></figure>

<h2 id="排列和随机采样"><a href="#排列和随机采样" class="headerlink" title="排列和随机采样"></a>排列和随机采样</h2><p>利用numpy.random.permutation函数可以轻松实现对Series或DataFrame的列的排列工作（permuting，随机重排序）。通过需要排列的轴的长度调用permutation，可产生一个表示新顺序的整数数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">100</span>]: df = pd.DataFrame(np.arange(<span class="hljs-number">5</span> * <span class="hljs-number">4</span>).reshape((<span class="hljs-number">5</span>, <span class="hljs-number">4</span>)))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">101</span>]: sampler = np.random.permutation(<span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: sampler</span><br><span class="line">Out[<span class="hljs-number">102</span>]: array([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>然后就可以在基于iloc的索引操作或take函数中使用该数组了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">103</span>]: df</span><br><span class="line">Out[<span class="hljs-number">103</span>]: </span><br><span class="line">    <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">4</span>   <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">8</span>   <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">12</span>  <span class="hljs-number">13</span>  <span class="hljs-number">14</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">16</span>  <span class="hljs-number">17</span>  <span class="hljs-number">18</span>  <span class="hljs-number">19</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">104</span>]: df.take(sampler)</span><br><span class="line">Out[<span class="hljs-number">104</span>]: </span><br><span class="line">    <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">12</span>  <span class="hljs-number">13</span>  <span class="hljs-number">14</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">4</span>   <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">16</span>  <span class="hljs-number">17</span>  <span class="hljs-number">18</span>  <span class="hljs-number">19</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">8</span>   <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span></span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<p>如果不想用替换的方式选取随机子集，可以在Series和DataFrame上使用sample方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: df.sample(n=<span class="hljs-number">3</span>)</span><br><span class="line">Out[<span class="hljs-number">105</span>]: </span><br><span class="line">    <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">12</span>  <span class="hljs-number">13</span>  <span class="hljs-number">14</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">16</span>  <span class="hljs-number">17</span>  <span class="hljs-number">18</span>  <span class="hljs-number">19</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">8</span>   <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>要通过替换的方式产生样本（允许重复选择），可以传递replace=True到sample：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">106</span>]: choices = pd.Series([<span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">4</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">107</span>]: draws = choices.sample(n=<span class="hljs-number">10</span>, replace=<span class="hljs-literal">True</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">108</span>]: draws</span><br><span class="line">Out[<span class="hljs-number">108</span>]: </span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">-1</span></span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h2 id="计算指标-哑变量"><a href="#计算指标-哑变量" class="headerlink" title="计算指标/哑变量"></a>计算指标/哑变量</h2><p>另一种常用于统计建模或机器学习的转换方式是：将分类变量（categorical variable）转换为“哑变量”或“指标矩阵”。</p>
<p>如果DataFrame的某一列中含有k个不同的值，则可以派生出一个k列矩阵或DataFrame（其值全为1和0）。pandas有一个get_dummies函数可以实现该功能（其实自己动手做一个也不难）。使用之前的一个DataFrame例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'data1'</span>: range(<span class="hljs-number">6</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: pd.get_dummies(df[<span class="hljs-string">'key'</span>])</span><br><span class="line">Out[<span class="hljs-number">110</span>]: </span><br><span class="line">   a  b  c</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>有时候，你可能想给指标DataFrame的列加上一个前缀，以便能够跟其他数据进行合并。get_dummies的prefix参数可以实现该功能：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">111</span>]: dummies = pd.get_dummies(df[<span class="hljs-string">'key'</span>], prefix=<span class="hljs-string">'key'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: df_with_dummy = df[[<span class="hljs-string">'data1'</span>]].join(dummies)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: df_with_dummy</span><br><span class="line">Out[<span class="hljs-number">113</span>]: </span><br><span class="line">   data1  key_a  key_b  key_c</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">3</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>如果DataFrame中的某行同属于多个分类，则事情就会有点复杂。看一下MovieLens 1M数据集，14章会更深入地研究它：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">114</span>]: mnames = [<span class="hljs-string">'movie_id'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'genres'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">115</span>]: movies = pd.read_table(<span class="hljs-string">'datasets/movielens/movies.dat'</span>, sep=<span class="hljs-string">'::'</span>,</span><br><span class="line">   .....:                        header=<span class="hljs-literal">None</span>, names=mnames)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: movies[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">116</span>]: </span><br><span class="line">   movie_id                               title                        genres</span><br><span class="line"><span class="hljs-number">0</span>         <span class="hljs-number">1</span>                    Toy Story (<span class="hljs-number">1995</span>)   Animation|Children<span class="hljs-string">'s|Comedy</span></span><br><span class="line"><span class="hljs-string">1         2                      Jumanji (1995)  Adventure|Children'</span>s|Fantasy</span><br><span class="line"><span class="hljs-number">2</span>         <span class="hljs-number">3</span>             Grumpier Old Men (<span class="hljs-number">1995</span>)                Comedy|Romance</span><br><span class="line"><span class="hljs-number">3</span>         <span class="hljs-number">4</span>            Waiting to Exhale (<span class="hljs-number">1995</span>)                  Comedy|Drama</span><br><span class="line"><span class="hljs-number">4</span>         <span class="hljs-number">5</span>  Father of the Bride Part II (<span class="hljs-number">1995</span>)                        Comedy</span><br><span class="line"><span class="hljs-number">5</span>         <span class="hljs-number">6</span>                         Heat (<span class="hljs-number">1995</span>)         Action|Crime|Thriller</span><br><span class="line"><span class="hljs-number">6</span>         <span class="hljs-number">7</span>                      Sabrina (<span class="hljs-number">1995</span>)                Comedy|Romance</span><br><span class="line"><span class="hljs-number">7</span>         <span class="hljs-number">8</span>                 Tom <span class="hljs-keyword">and</span> Huck (<span class="hljs-number">1995</span>)          Adventure|Children<span class="hljs-string">'s</span></span><br><span class="line"><span class="hljs-string">8         9                 Sudden Death (1995)</span></span><br><span class="line"><span class="hljs-string">Action</span></span><br><span class="line"><span class="hljs-string">9        10                    GoldenEye (1995)     Action|Adventure|Thriller</span></span><br></pre></td></tr></table></figure>

<p>要为每个genre添加指标变量就需要做一些数据规整操作。首先，我们从数据集中抽取出不同的genre值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">117</span>]: all_genres = []</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">118</span>]: <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> movies.genres:</span><br><span class="line">   .....:     all_genres.extend(x.split(<span class="hljs-string">'|'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">119</span>]: genres = pd.unique(all_genres)</span><br></pre></td></tr></table></figure>

<p>现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">120</span>]: genres</span><br><span class="line">Out[<span class="hljs-number">120</span>]: </span><br><span class="line">array([<span class="hljs-string">'Animation'</span>, <span class="hljs-string">"Children's"</span>, <span class="hljs-string">'Comedy'</span>, <span class="hljs-string">'Adventure'</span>, <span class="hljs-string">'Fantasy'</span>,</span><br><span class="line">       <span class="hljs-string">'Romance'</span>, <span class="hljs-string">'Drama'</span>, <span class="hljs-string">'Action'</span>, <span class="hljs-string">'Crime'</span>, <span class="hljs-string">'Thriller'</span>,<span class="hljs-string">'Horror'</span>,</span><br><span class="line">       <span class="hljs-string">'Sci-Fi'</span>, <span class="hljs-string">'Documentary'</span>, <span class="hljs-string">'War'</span>, <span class="hljs-string">'Musical'</span>, <span class="hljs-string">'Mystery'</span>, <span class="hljs-string">'Film-Noir'</span>,</span><br><span class="line">       <span class="hljs-string">'Western'</span>], dtype=object)</span><br></pre></td></tr></table></figure>

<p>构建指标DataFrame的方法之一是从一个全零DataFrame开始：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">121</span>]: zero_matrix = np.zeros((len(movies), len(genres)))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: dummies = pd.DataFrame(zero_matrix, columns=genres)</span><br></pre></td></tr></table></figure>

<p>现在，迭代每一部电影，并将dummies各行的条目设为1。要这么做，我们使用dummies.columns来计算每个类型的列索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">123</span>]: gen = movies.genres[<span class="hljs-number">0</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">124</span>]: gen.split(<span class="hljs-string">'|'</span>)</span><br><span class="line">Out[<span class="hljs-number">124</span>]: [<span class="hljs-string">'Animation'</span>, <span class="hljs-string">"Children's"</span>, <span class="hljs-string">'Comedy'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: dummies.columns.get_indexer(gen.split(<span class="hljs-string">'|'</span>))</span><br><span class="line">Out[<span class="hljs-number">125</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>])</span><br></pre></td></tr></table></figure>

<p>然后，根据索引，使用.iloc设定值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">126</span>]: <span class="hljs-keyword">for</span> i, gen <span class="hljs-keyword">in</span> enumerate(movies.genres):</span><br><span class="line">   .....:     indices = dummies.columns.get_indexer(gen.split(<span class="hljs-string">'|'</span>))</span><br><span class="line">   .....:     dummies.iloc[i, indices] = <span class="hljs-number">1</span></span><br><span class="line">   .....:</span><br></pre></td></tr></table></figure>

<p>然后，和以前一样，再将其与movies合并起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">127</span>]: movies_windic = movies.join(dummies.add_prefix(<span class="hljs-string">'Genre_'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">128</span>]: movies_windic.iloc[<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">128</span>]: </span><br><span class="line">movie_id                                       <span class="hljs-number">1</span></span><br><span class="line">title                           Toy Story (<span class="hljs-number">1995</span>)</span><br><span class="line">genres               Animation|Children<span class="hljs-string">'s|Comedy</span></span><br><span class="line"><span class="hljs-string">Genre_Animation                                1</span></span><br><span class="line"><span class="hljs-string">Genre_Children'</span>s                               <span class="hljs-number">1</span></span><br><span class="line">Genre_Comedy                                   <span class="hljs-number">1</span></span><br><span class="line">Genre_Adventure                                <span class="hljs-number">0</span></span><br><span class="line">Genre_Fantasy                                  <span class="hljs-number">0</span></span><br><span class="line">Genre_Romance                                  <span class="hljs-number">0</span></span><br><span class="line">Genre_Drama                                    <span class="hljs-number">0</span></span><br><span class="line">                                ...             </span><br><span class="line">Genre_Crime                                    <span class="hljs-number">0</span></span><br><span class="line">Genre_Thriller                                 <span class="hljs-number">0</span></span><br><span class="line">Genre_Horror                                   <span class="hljs-number">0</span></span><br><span class="line">Genre_Sci-Fi                                   <span class="hljs-number">0</span></span><br><span class="line">Genre_Documentary                              <span class="hljs-number">0</span></span><br><span class="line">Genre_War                                      <span class="hljs-number">0</span></span><br><span class="line">Genre_Musical                                  <span class="hljs-number">0</span></span><br><span class="line">Genre_Mystery                                  <span class="hljs-number">0</span></span><br><span class="line">Genre_Film-Noir                                <span class="hljs-number">0</span></span><br><span class="line">Genre_Western                                  <span class="hljs-number">0</span></span><br><span class="line">Name: <span class="hljs-number">0</span>, Length: <span class="hljs-number">21</span>, dtype: object</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：对于很大的数据，用这种方式构建多成员指标变量就会变得非常慢。最好使用更低级的函数，将其写入NumPy数组，然后结果包装在DataFrame中。</p>
</blockquote>
<p>一个对统计应用有用的秘诀是：结合get_dummies和诸如cut之类的离散化函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">129</span>]: np.random.seed(<span class="hljs-number">12345</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">130</span>]: values = np.random.rand(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">131</span>]: values</span><br><span class="line">Out[<span class="hljs-number">131</span>]: </span><br><span class="line">array([ <span class="hljs-number">0.9296</span>,  <span class="hljs-number">0.3164</span>,  <span class="hljs-number">0.1839</span>,  <span class="hljs-number">0.2046</span>,  <span class="hljs-number">0.5677</span>,  <span class="hljs-number">0.5955</span>,  <span class="hljs-number">0.9645</span>,</span><br><span class="line">        <span class="hljs-number">0.6532</span>,  <span class="hljs-number">0.7489</span>,  <span class="hljs-number">0.6536</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: bins = [<span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">1</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">133</span>]: pd.get_dummies(pd.cut(values, bins))</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">   (<span class="hljs-number">0.0</span>, <span class="hljs-number">0.2</span>]  (<span class="hljs-number">0.2</span>, <span class="hljs-number">0.4</span>]  (<span class="hljs-number">0.4</span>, <span class="hljs-number">0.6</span>]  (<span class="hljs-number">0.6</span>, <span class="hljs-number">0.8</span>]  (<span class="hljs-number">0.8</span>, <span class="hljs-number">1.0</span>]</span><br><span class="line"><span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">6</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">7</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">8</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">9</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>我们用numpy.random.seed，使这个例子具有确定性。本书后面会介绍pandas.get_dummies。</p>
<h1 id="7-3-字符串操作"><a href="#7-3-字符串操作" class="headerlink" title="7.3 字符串操作"></a>7.3 字符串操作</h1><p>Python能够成为流行的数据处理语言，部分原因是其简单易用的字符串和文本处理功能。大部分文本运算都直接做成了字符串对象的内置方法。对于更为复杂的模式匹配和文本操作，则可能需要用到正则表达式。pandas对此进行了加强，它使你能够对整组数据应用字符串表达式和正则表达式，而且能处理烦人的缺失数据。</p>
<h2 id="字符串对象方法"><a href="#字符串对象方法" class="headerlink" title="字符串对象方法"></a>字符串对象方法</h2><p>对于许多字符串处理和脚本应用，内置的字符串方法已经能够满足要求了。例如，以逗号分隔的字符串可以用split拆分成数段：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">134</span>]: val = <span class="hljs-string">'a,b,  guido'</span></span><br><span class="line">In [<span class="hljs-number">135</span>]: val.split(<span class="hljs-string">','</span>)</span><br><span class="line">Out[<span class="hljs-number">135</span>]: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'  guido'</span>]</span><br></pre></td></tr></table></figure>

<p>split常常与strip一起使用，以去除空白符（包括换行符）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">136</span>]: pieces = [x.strip() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> val.split(<span class="hljs-string">','</span>)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: pieces</span><br><span class="line">Out[<span class="hljs-number">137</span>]: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'guido'</span>]</span><br></pre></td></tr></table></figure>

<p>利用加法，可以将这些子字符串以双冒号分隔符的形式连接起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">138</span>]: first, second, third = pieces</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">139</span>]: first + <span class="hljs-string">'::'</span> + second + <span class="hljs-string">'::'</span> + third</span><br><span class="line">Out[<span class="hljs-number">139</span>]: <span class="hljs-string">'a::b::guido'</span></span><br></pre></td></tr></table></figure>

<p>但这种方式并不是很实用。一种更快更符合Python风格的方式是，向字符串”::”的join方法传入一个列表或元组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">140</span>]: <span class="hljs-string">'::'</span>.join(pieces)</span><br><span class="line">Out[<span class="hljs-number">140</span>]: <span class="hljs-string">'a::b::guido'</span></span><br></pre></td></tr></table></figure>

<p>其它方法关注的是子串定位。检测子串的最佳方式是利用Python的in关键字，还可以使用index和find：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">141</span>]: <span class="hljs-string">'guido'</span> <span class="hljs-keyword">in</span> val</span><br><span class="line">Out[<span class="hljs-number">141</span>]: <span class="hljs-literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">142</span>]: val.index(<span class="hljs-string">','</span>)</span><br><span class="line">Out[<span class="hljs-number">142</span>]: <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">143</span>]: val.find(<span class="hljs-string">':'</span>)</span><br><span class="line">Out[<span class="hljs-number">143</span>]: <span class="hljs-number">-1</span></span><br></pre></td></tr></table></figure>

<p>注意find和index的区别：如果找不到字符串，index将会引发一个异常（而不是返回－1）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">144</span>]: val.index(<span class="hljs-string">':'</span>)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input<span class="hljs-number">-144</span><span class="hljs-number">-280</span>f8b2856ce&gt; <span class="hljs-keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 val.index(':')</span><br><span class="line">ValueError: substring <span class="hljs-keyword">not</span> found</span><br></pre></td></tr></table></figure>

<p>与此相关，count可以返回指定子串的出现次数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">145</span>]: val.count(<span class="hljs-string">','</span>)</span><br><span class="line">Out[<span class="hljs-number">145</span>]: <span class="hljs-number">2</span></span><br></pre></td></tr></table></figure>

<p>replace用于将指定模式替换为另一个模式。通过传入空字符串，它也常常用于删除模式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">146</span>]: val.replace(<span class="hljs-string">','</span>, <span class="hljs-string">'::'</span>)</span><br><span class="line">Out[<span class="hljs-number">146</span>]: <span class="hljs-string">'a::b::  guido'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">147</span>]: val.replace(<span class="hljs-string">','</span>, <span class="hljs-string">''</span>)</span><br><span class="line">Out[<span class="hljs-number">147</span>]: <span class="hljs-string">'ab  guido'</span></span><br></pre></td></tr></table></figure>

<p>表7-3列出了Python内置的字符串方法。</p>
<p>这些运算大部分都能使用正则表达式实现（马上就会看到）。</p>
<p><img src="/images/blog/7178691-087fe67bf6db0701.webp" alt="img"></p>
<p><img src="/images/blog/7178691-d1f0d4ed3e895016.webp" alt="img"></p>
<p>casefold 将字符转换为小写，并将任何特定区域的变量字符组合转换成一个通用的可比较形式。</p>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><p>正则表达式提供了一种灵活的在文本中搜索或匹配（通常比前者复杂）字符串模式的方式。正则表达式，常称作regex，是根据正则表达式语言编写的字符串。Python内置的re模块负责对字符串应用正则表达式。我将通过一些例子说明其使用方法。</p>
<blockquote>
<p>笔记：正则表达式的编写技巧可以自成一章，超出了本书的范围。从网上和其它书可以找到许多非常不错的教程和参考资料。</p>
</blockquote>
<p>re模块的函数可以分为三个大类：模式匹配、替换以及拆分。当然，它们之间是相辅相成的。一个regex描述了需要在文本中定位的一个模式，它可以用于许多目的。我们先来看一个简单的例子：假设我想要拆分一个字符串，分隔符为数量不定的一组空白符（制表符、空格、换行符等）。描述一个或多个空白符的regex是\s+：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">148</span>]: <span class="hljs-keyword">import</span> re</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">149</span>]: text = <span class="hljs-string">"foo    bar\t baz  \tqux"</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">150</span>]: re.split(<span class="hljs-string">'\s+'</span>, text)</span><br><span class="line">Out[<span class="hljs-number">150</span>]: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'qux'</span>]</span><br></pre></td></tr></table></figure>

<p>调用re.split(‘\s+’,text)时，正则表达式会先被编译，然后再在text上调用其split方法。你可以用re.compile自己编译regex以得到一个可重用的regex对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">151</span>]: regex = re.compile(<span class="hljs-string">'\s+'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">152</span>]: regex.split(text)</span><br><span class="line">Out[<span class="hljs-number">152</span>]: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'qux'</span>]</span><br></pre></td></tr></table></figure>

<p>如果只希望得到匹配regex的所有模式，则可以使用findall方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">153</span>]: regex.findall(text)</span><br><span class="line">Out[<span class="hljs-number">153</span>]: [<span class="hljs-string">'    '</span>, <span class="hljs-string">'\t '</span>, <span class="hljs-string">'  \t'</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：如果想避免正则表达式中不需要的转义（\），则可以使用原始字符串字面量如r’C:\x’（也可以编写其等价式’C:\x’）。</p>
</blockquote>
<p>如果打算对许多字符串应用同一条正则表达式，强烈建议通过re.compile创建regex对象。这样将可以节省大量的CPU时间。</p>
<p>match和search跟findall功能类似。findall返回的是字符串中所有的匹配项，而search则只返回第一个匹配项。match更加严格，它只匹配字符串的首部。来看一个小例子，假设我们有一段文本以及一条能够识别大部分电子邮件地址的正则表达式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="hljs-string">"""Dave dave@google.com</span></span><br><span class="line"><span class="hljs-string">Steve steve@gmail.com</span></span><br><span class="line"><span class="hljs-string">Rob rob@gmail.com</span></span><br><span class="line"><span class="hljs-string">Ryan ryan@yahoo.com</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line">pattern = <span class="hljs-string">r'[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]&#123;2,4&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># re.IGNORECASE makes the regex case-insensitive</span></span><br><span class="line">regex = re.compile(pattern, flags=re.IGNORECASE)</span><br></pre></td></tr></table></figure>

<p>对text使用findall将得到一组电子邮件地址：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">155</span>]: regex.findall(text)</span><br><span class="line">Out[<span class="hljs-number">155</span>]: </span><br><span class="line">[<span class="hljs-string">'dave@google.com'</span>,</span><br><span class="line"> <span class="hljs-string">'steve@gmail.com'</span>,</span><br><span class="line"> <span class="hljs-string">'rob@gmail.com'</span>,</span><br><span class="line"> <span class="hljs-string">'ryan@yahoo.com'</span>]</span><br></pre></td></tr></table></figure>

<p>search返回的是文本中第一个电子邮件地址（以特殊的匹配项对象形式返回）。对于上面那个regex，匹配项对象只能告诉我们模式在原字符串中的起始和结束位置：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">156</span>]: m = regex.search(text)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">157</span>]: m</span><br><span class="line">Out[<span class="hljs-number">157</span>]: &lt;_sre.SRE_Match object; span=(<span class="hljs-number">5</span>, <span class="hljs-number">20</span>), match=<span class="hljs-string">'dave@google.com'</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: text[m.start():m.end()]</span><br><span class="line">Out[<span class="hljs-number">158</span>]: <span class="hljs-string">'dave@google.com'</span></span><br></pre></td></tr></table></figure>

<p>regex.match则将返回None，因为它只匹配出现在字符串开头的模式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">159</span>]: print(regex.match(text))</span><br><span class="line"><span class="hljs-literal">None</span></span><br></pre></td></tr></table></figure>

<p>相关的，sub方法可以将匹配到的模式替换为指定字符串，并返回所得到的新字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">160</span>]: print(regex.sub(<span class="hljs-string">'REDACTED'</span>, text))</span><br><span class="line">Dave REDACTED</span><br><span class="line">Steve REDACTED</span><br><span class="line">Rob REDACTED</span><br><span class="line">Ryan REDACTED</span><br></pre></td></tr></table></figure>

<p>假设你不仅想要找出电子邮件地址，还想将各个地址分成3个部分：用户名、域名以及域后缀。要实现此功能，只需将待分段的模式的各部分用圆括号包起来即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">161</span>]: pattern = <span class="hljs-string">r'([A-Z0-9._%+-]+)@([A-Z0-9.-]+)\.([A-Z]&#123;2,4&#125;)'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: regex = re.compile(pattern, flags=re.IGNORECASE)</span><br></pre></td></tr></table></figure>

<p>由这种修改过的正则表达式所产生的匹配项对象，可以通过其groups方法返回一个由模式各段组成的元组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">163</span>]: m = regex.match(<span class="hljs-string">'wesm@bright.net'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">164</span>]: m.groups()</span><br><span class="line">Out[<span class="hljs-number">164</span>]: (<span class="hljs-string">'wesm'</span>, <span class="hljs-string">'bright'</span>, <span class="hljs-string">'net'</span>)</span><br></pre></td></tr></table></figure>

<p>对于带有分组功能的模式，findall会返回一个元组列表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">165</span>]: regex.findall(text)</span><br><span class="line">Out[<span class="hljs-number">165</span>]:</span><br><span class="line">[(<span class="hljs-string">'dave'</span>, <span class="hljs-string">'google'</span>, <span class="hljs-string">'com'</span>),</span><br><span class="line"> (<span class="hljs-string">'steve'</span>, <span class="hljs-string">'gmail'</span>, <span class="hljs-string">'com'</span>),</span><br><span class="line"> (<span class="hljs-string">'rob'</span>, <span class="hljs-string">'gmail'</span>, <span class="hljs-string">'com'</span>),</span><br><span class="line"> (<span class="hljs-string">'ryan'</span>, <span class="hljs-string">'yahoo'</span>, <span class="hljs-string">'com'</span>)]</span><br></pre></td></tr></table></figure>

<p>sub还能通过诸如\1、\2之类的特殊符号访问各匹配项中的分组。符号\1对应第一个匹配的组，\2对应第二个匹配的组，以此类推：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">166</span>]: print(regex.sub(<span class="hljs-string">r'Username: \1, Domain: \2, Suffix: \3'</span>, text))</span><br><span class="line">Dave Username: dave, Domain: google, Suffix: com</span><br><span class="line">Steve Username: steve, Domain: gmail, Suffix: com</span><br><span class="line">Rob Username: rob, Domain: gmail, Suffix: com</span><br><span class="line">Ryan Username: ryan, Domain: yahoo, Suffix: com</span><br></pre></td></tr></table></figure>

<p>Python中还有许多的正则表达式，但大部分都超出了本书的范围。表7-4是一个简要概括。</p>
<p><img src="/images/blog/7178691-efbb80a793759fc0.webp" alt="img"></p>
<h2 id="pandas的矢量化字符串函数"><a href="#pandas的矢量化字符串函数" class="headerlink" title="pandas的矢量化字符串函数"></a>pandas的矢量化字符串函数</h2><p>清理待分析的散乱数据时，常常需要做一些字符串规整化工作。更为复杂的情况是，含有字符串的列有时还含有缺失数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">167</span>]: data = &#123;<span class="hljs-string">'Dave'</span>: <span class="hljs-string">'dave@google.com'</span>, <span class="hljs-string">'Steve'</span>: <span class="hljs-string">'steve@gmail.com'</span>,</span><br><span class="line">   .....:         <span class="hljs-string">'Rob'</span>: <span class="hljs-string">'rob@gmail.com'</span>, <span class="hljs-string">'Wes'</span>: np.nan&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">168</span>]: data = pd.Series(data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">169</span>]: data</span><br><span class="line">Out[<span class="hljs-number">169</span>]: </span><br><span class="line">Dave     dave@google.com</span><br><span class="line">Rob        rob@gmail.com</span><br><span class="line">Steve    steve@gmail.com</span><br><span class="line">Wes                  NaN</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">170</span>]: data.isnull()</span><br><span class="line">Out[<span class="hljs-number">170</span>]: </span><br><span class="line">Dave     <span class="hljs-literal">False</span></span><br><span class="line">Rob      <span class="hljs-literal">False</span></span><br><span class="line">Steve    <span class="hljs-literal">False</span></span><br><span class="line">Wes       <span class="hljs-literal">True</span></span><br><span class="line">dtype: bool</span><br></pre></td></tr></table></figure>

<p>通过data.map，所有字符串和正则表达式方法都能被应用于（传入lambda表达式或其他函数）各个值，但是如果存在NA（null）就会报错。为了解决这个问题，Series有一些能够跳过NA值的面向数组方法，进行字符串操作。通过Series的str属性即可访问这些方法。例如，我们可以通过str.contains检查各个电子邮件地址是否含有”gmail”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">171</span>]: data.str.contains(<span class="hljs-string">'gmail'</span>)</span><br><span class="line">Out[<span class="hljs-number">171</span>]: </span><br><span class="line">Dave     <span class="hljs-literal">False</span></span><br><span class="line">Rob       <span class="hljs-literal">True</span></span><br><span class="line">Steve     <span class="hljs-literal">True</span></span><br><span class="line">Wes        NaN</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>也可以使用正则表达式，还可以加上任意re选项（如IGNORECASE）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">172</span>]: pattern</span><br><span class="line">Out[<span class="hljs-number">172</span>]: <span class="hljs-string">'([A-Z0-9._%+-]+)@([A-Z0-9.-]+)\\.([A-Z]&#123;2,4&#125;)'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">173</span>]: data.str.findall(pattern, flags=re.IGNORECASE)</span><br><span class="line">Out[<span class="hljs-number">173</span>]: </span><br><span class="line">Dave     [(dave, google, com)]</span><br><span class="line">Rob        [(rob, gmail, com)]</span><br><span class="line">Steve    [(steve, gmail, com)]</span><br><span class="line">Wes                        NaN</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>有两个办法可以实现矢量化的元素获取操作：要么使用str.get，要么在str属性上使用索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">174</span>]: matches = data.str.match(pattern, flags=re.IGNORECASE)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">175</span>]: matches</span><br><span class="line">Out[<span class="hljs-number">175</span>]: </span><br><span class="line">Dave     <span class="hljs-literal">True</span></span><br><span class="line">Rob      <span class="hljs-literal">True</span></span><br><span class="line">Steve    <span class="hljs-literal">True</span></span><br><span class="line">Wes       NaN</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>要访问嵌入列表中的元素，我们可以传递索引到这两个函数中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">176</span>]: matches.str.get(<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">176</span>]: </span><br><span class="line">Dave    NaN</span><br><span class="line">Rob     NaN</span><br><span class="line">Steve   NaN</span><br><span class="line">Wes     NaN</span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">177</span>]: matches.str[<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">177</span>]: </span><br><span class="line">Dave    NaN</span><br><span class="line">Rob     NaN</span><br><span class="line">Steve   NaN</span><br><span class="line">Wes     NaN</span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>你可以利用这种方法对字符串进行截取：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">178</span>]: data.str[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">178</span>]: </span><br><span class="line">Dave     dave@</span><br><span class="line">Rob      rob@g</span><br><span class="line">Steve    steve</span><br><span class="line">Wes        NaN</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>表7-5介绍了更多的pandas字符串方法。</p>
<p><img src="/images/blog/7178691-a634364ed6d5d5c5.webp" alt="img"></p>
<p>表7-5 部分矢量化字符串方法</p>
<h1 id="7-4-总结"><a href="#7-4-总结" class="headerlink" title="7.4 总结"></a>7.4 总结</h1><p>高效的数据准备可以让你将更多的时间用于数据分析，花较少的时间用于准备工作，这样就可以极大地提高生产力。我们在本章中学习了许多工具，但覆盖并不全面。下一章，我们会学习pandas的聚合与分组。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7967 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC9%E7%AB%A0%20%E7%BB%98%E5%9B%BE%E5%92%8C%E5%8F%AF%E8%A7%86%E5%8C%96/">《利用Python进行数据分析·第2版》第9章 绘图和可视化</a>
            
        </h1>
        <div class="content">
            <h1 id="《利用Python进行数据分析·第2版》第9章-绘图和可视化"><a href="#《利用Python进行数据分析·第2版》第9章-绘图和可视化" class="headerlink" title="《利用Python进行数据分析·第2版》第9章 绘图和可视化"></a>《利用Python进行数据分析·第2版》第9章 绘图和可视化</h1><hr>
<p>转载自<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
第9章 绘图和可视化
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>信息可视化（也叫绘图）是数据分析中最重要的工作之一。它可能是探索过程的一部分，例如，帮助我们找出异常值、必要的数据转换、得出有关模型的idea等。另外，做一个可交互的数据可视化也许是工作的最终目标。Python有许多库进行静态或动态的数据可视化，但我这里重要关注于matplotlib（<a href="http://matplotlib.org/）和基于它的库。" target="_blank" rel="noopener">http://matplotlib.org/）和基于它的库。</a></p>
<p>matplotlib是一个用于创建出版质量图表的桌面绘图包（主要是2D方面）。该项目是由John Hunter于2002年启动的，其目的是为Python构建一个MATLAB式的绘图接口。matplotlib和IPython社区进行合作，简化了从IPython shell（包括现在的Jupyter notebook）进行交互式绘图。matplotlib支持各种操作系统上许多不同的GUI后端，而且还能将图片导出为各种常见的矢量（vector）和光栅（raster）图：PDF、SVG、JPG、PNG、BMP、GIF等。除了几张，本书中的大部分图都是用它生成的。</p>
<p>随着时间的发展，matplotlib衍生出了多个数据可视化的工具集，它们使用matplotlib作为底层。其中之一是seaborn（<a href="http://seaborn.pydata.org/），本章后面会学习它。" target="_blank" rel="noopener">http://seaborn.pydata.org/），本章后面会学习它。</a></p>
<p>学习本章代码案例的最简单方法是在Jupyter notebook进行交互式绘图。在Jupyter notebook中执行下面的语句：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib notebook</span><br></pre></td></tr></table></figure>

<h1 id="9-1-matplotlib-API入门"><a href="#9-1-matplotlib-API入门" class="headerlink" title="9.1 matplotlib API入门"></a>9.1 matplotlib API入门</h1><p>matplotlib的通常引入约定是：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">11</span>]: <span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt</span><br></pre></td></tr></table></figure>

<p>在Jupyter中运行%matplotlib notebook（或在IPython中运行%matplotlib），就可以创建一个简单的图形。如果一切设置正确，会看到图9-1：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: data = np.arange(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: data</span><br><span class="line">Out[<span class="hljs-number">14</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: plt.plot(data)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-7032e333a6ecdd37.webp" alt="img"></p>
<p>图9-1 简单的线图</p>
<p>虽然seaborn这样的库和pandas的内置绘图函数能够处理许多普通的绘图任务，但如果需要自定义一些高级功能的话就必须学习matplotlib API。</p>
<blockquote>
<p>笔记：虽然本书没有详细地讨论matplotlib的各种功能，但足以将你引入门。matplotlib的示例库和文档是学习高级特性的最好资源。</p>
</blockquote>
<h2 id="Figure和Subplot"><a href="#Figure和Subplot" class="headerlink" title="Figure和Subplot"></a>Figure和Subplot</h2><p>matplotlib的图像都位于Figure对象中。你可以用plt.figure创建一个新的Figure：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">16</span>]: fig = plt.figure()</span><br></pre></td></tr></table></figure>

<p>如果用的是IPython，这时会弹出一个空窗口，但在Jupyter中，必须再输入更多命令才能看到。plt.figure有一些选项，特别是figsize，它用于确保当图片保存到磁盘时具有一定的大小和纵横比。</p>
<p>不能通过空Figure绘图。必须用add_subplot创建一个或多个subplot才行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: ax1 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>这条代码的意思是：图像应该是2×2的（即最多4张图），且当前选中的是4个subplot中的第一个（编号从1开始）。如果再把后面两个subplot也创建出来，最终得到的图像如图9-2所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: ax2 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: ax3 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-b8cff158e64eae74.webp" alt="img"></p>
<p>图9-2 带有三个subplot的Figure</p>
<blockquote>
<p>提示：使用Jupyter notebook有一点不同，即每个小窗重新执行后，图形会被重置。因此，对于复杂的图形，，你必须将所有的绘图命令存在一个小窗里。</p>
</blockquote>
<p>这里，我们运行同一个小窗里的所有命令：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax1 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)</span><br><span class="line">ax2 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)</span><br><span class="line">ax3 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)</span><br></pre></td></tr></table></figure>

<p>如果这时执行一条绘图命令（如plt.plot([1.5, 3.5, -2, 1.6])），matplotlib就会在最后一个用过的subplot（如果没有则创建一个）上进行绘制，隐藏创建figure和subplot的过程。因此，如果我们执行下列命令，你就会得到如图9-3所示的结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">20</span>]: plt.plot(np.random.randn(<span class="hljs-number">50</span>).cumsum(), <span class="hljs-string">'k--'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-7bcbd5e56fdbbd92.webp" alt="img"></p>
<p>图9-3 绘制一次之后的图像</p>
<p>“k–”是一个线型选项，用于告诉matplotlib绘制黑色虚线图。上面那些由fig.add_subplot所返回的对象是AxesSubplot对象，直接调用它们的实例方法就可以在其它空着的格子里面画图了，如图9-4所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">21</span>]: ax1.hist(np.random.randn(<span class="hljs-number">100</span>), bins=<span class="hljs-number">20</span>, color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: ax2.scatter(np.arange(<span class="hljs-number">30</span>), np.arange(<span class="hljs-number">30</span>) + <span class="hljs-number">3</span> * np.random.randn(<span class="hljs-number">30</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-2297bcaf355db24c.webp" alt="img"></p>
<p>图9-4 继续绘制两次之后的图像</p>
<p>你可以在matplotlib的文档中找到各种图表类型。</p>
<p>创建包含subplot网格的figure是一个非常常见的任务，matplotlib有一个更为方便的方法plt.subplots，它可以创建一个新的Figure，并返回一个含有已创建的subplot对象的NumPy数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: axes</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">array([[&lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb626374048</span>&gt;,</span><br><span class="line">        &lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb62625db00</span>&gt;,</span><br><span class="line">        &lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb6262f6c88</span>&gt;],</span><br><span class="line">       [&lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb6261a36a0</span>&gt;,</span><br><span class="line">        &lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb626181860</span>&gt;,</span><br><span class="line">        &lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb6260fd4e0</span>&gt;]], dtype</span><br><span class="line">=object)</span><br></pre></td></tr></table></figure>

<p>这是非常实用的，因为可以轻松地对axes数组进行索引，就好像是一个二维数组一样，例如axes[0,1]。你还可以通过sharex和sharey指定subplot应该具有相同的X轴或Y轴。在比较相同范围的数据时，这也是非常实用的，否则，matplotlib会自动缩放各图表的界限。有关该方法的更多信息，请参见表9-1。</p>
<p><img src="/images/blog/7178691-88bb55faca7d01ba.webp" alt="img"></p>
<p>表9-1 pyplot.subplots的选项</p>
<h2 id="调整subplot周围的间距"><a href="#调整subplot周围的间距" class="headerlink" title="调整subplot周围的间距"></a>调整subplot周围的间距</h2><p>默认情况下，matplotlib会在subplot外围留下一定的边距，并在subplot之间留下一定的间距。间距跟图像的高度和宽度有关，因此，如果你调整了图像大小（不管是编程还是手工），间距也会自动调整。利用Figure的subplots_adjust方法可以轻而易举地修改间距，此外，它也是个顶级函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subplots_adjust(left=<span class="hljs-literal">None</span>, bottom=<span class="hljs-literal">None</span>, right=<span class="hljs-literal">None</span>, top=<span class="hljs-literal">None</span>,</span><br><span class="line">                wspace=<span class="hljs-literal">None</span>, hspace=<span class="hljs-literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>wspace和hspace用于控制宽度和高度的百分比，可以用作subplot之间的间距。下面是一个简单的例子，其中我将间距收缩到了0（如图9-5所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, sharex=<span class="hljs-literal">True</span>, sharey=<span class="hljs-literal">True</span>)</span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):</span><br><span class="line">    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):</span><br><span class="line">        axes[i, j].hist(np.random.randn(<span class="hljs-number">500</span>), bins=<span class="hljs-number">50</span>, color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.5</span>)</span><br><span class="line">plt.subplots_adjust(wspace=<span class="hljs-number">0</span>, hspace=<span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-80be7ffc3dec88a5.webp" alt="img"></p>
<p>图9-5 各subplot之间没有间距</p>
<p>不难看出，其中的轴标签重叠了。matplotlib不会检查标签是否重叠，所以对于这种情况，你只能自己设定刻度位置和刻度标签。后面几节将会详细介绍该内容。</p>
<h2 id="颜色、标记和线型"><a href="#颜色、标记和线型" class="headerlink" title="颜色、标记和线型"></a>颜色、标记和线型</h2><p>matplotlib的plot函数接受一组X和Y坐标，还可以接受一个表示颜色和线型的字符串缩写。例如，要根据x和y绘制绿色虚线，你可以执行如下代码：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ax.plot(x, y, <span class="hljs-string">'g--'</span>)</span><br></pre></td></tr></table></figure>

<p>这种在一个字符串中指定颜色和线型的方式非常方便。在实际中，如果你是用代码绘图，你可能不想通过处理字符串来获得想要的格式。通过下面这种更为明确的方式也能得到同样的效果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ax.plot(x, y, linestyle=<span class="hljs-string">'--'</span>, color=<span class="hljs-string">'g'</span>)</span><br></pre></td></tr></table></figure>

<p>常用的颜色可以使用颜色缩写，你也可以指定颜色码（例如，’#CECECE’）。你可以通过查看plot的文档字符串查看所有线型的合集（在IPython和Jupyter中使用plot?）。</p>
<p>线图可以使用标记强调数据点。因为matplotlib可以创建连续线图，在点之间进行插值，因此有时可能不太容易看出真实数据点的位置。标记也可以放到格式字符串中，但标记类型和线型必须放在颜色后面（见图9-6）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">30</span>]: <span class="hljs-keyword">from</span> numpy.random <span class="hljs-keyword">import</span> randn</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: plt.plot(randn(<span class="hljs-number">30</span>).cumsum(), <span class="hljs-string">'ko--'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-404d816f3e1d6621.webp" alt="img"></p>
<p>图9-6 带有标记的线型图示例</p>
<p>还可以将其写成更为明确的形式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plot(randn(<span class="hljs-number">30</span>).cumsum(), color=<span class="hljs-string">'k'</span>, linestyle=<span class="hljs-string">'dashed'</span>, marker=<span class="hljs-string">'o'</span>)</span><br></pre></td></tr></table></figure>

<p>在线型图中，非实际数据点默认是按线性方式插值的。可以通过drawstyle选项修改（见图9-7）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: data = np.random.randn(<span class="hljs-number">30</span>).cumsum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: plt.plot(data, <span class="hljs-string">'k--'</span>, label=<span class="hljs-string">'Default'</span>)</span><br><span class="line">Out[<span class="hljs-number">34</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624d86160</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">35</span>]: plt.plot(data, <span class="hljs-string">'k-'</span>, drawstyle=<span class="hljs-string">'steps-post'</span>, label=<span class="hljs-string">'steps-post'</span>)</span><br><span class="line">Out[<span class="hljs-number">35</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624d869e8</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: plt.legend(loc=<span class="hljs-string">'best'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-3ec7642e1a592f08.webp" alt="img"></p>
<p>图9-7 不同drawstyle选项的线型图</p>
<p>你可能注意到运行上面代码时有输出&lt;matplotlib.lines.Line2D at …&gt;。matplotlib会返回引用了新添加的子组件的对象。大多数时候，你可以放心地忽略这些输出。这里，因为我们传递了label参数到plot，我们可以创建一个plot图例，指明每条使用plt.legend的线。</p>
<blockquote>
<p>笔记：你必须调用plt.legend（或使用ax.legend，如果引用了轴的话）来创建图例，无论你绘图时是否传递label标签选项。</p>
</blockquote>
<h2 id="刻度、标签和图例"><a href="#刻度、标签和图例" class="headerlink" title="刻度、标签和图例"></a>刻度、标签和图例</h2><p>对于大多数的图表装饰项，其主要实现方式有二：使用过程型的pyplot接口（例如，matplotlib.pyplot）以及更为面向对象的原生matplotlib API。</p>
<p>pyplot接口的设计目的就是交互式使用，含有诸如xlim、xticks和xticklabels之类的方法。它们分别控制图表的范围、刻度位置、刻度标签等。其使用方式有以下两种：</p>
<ul>
<li>调用时不带参数，则返回当前的参数值（例如，plt.xlim()返回当前的X轴绘图范围）。</li>
<li>调用时带参数，则设置参数值（例如，plt.xlim([0,10])会将X轴的范围设置为0到10）。</li>
</ul>
<p>所有这些方法都是对当前或最近创建的AxesSubplot起作用的。它们各自对应subplot对象上的两个方法，以xlim为例，就是ax.get_xlim和ax.set_xlim。我更喜欢使用subplot的实例方法（因为我喜欢明确的事情，而且在处理多个subplot时这样也更清楚一些）。当然你完全可以选择自己觉得方便的那个。</p>
<h2 id="设置标题、轴标签、刻度以及刻度标签"><a href="#设置标题、轴标签、刻度以及刻度标签" class="headerlink" title="设置标题、轴标签、刻度以及刻度标签"></a>设置标题、轴标签、刻度以及刻度标签</h2><p>为了说明自定义轴，我将创建一个简单的图像并绘制一段随机漫步（如图9-8所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">37</span>]: fig = plt.figure()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: ax = fig.add_subplot(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">39</span>]: ax.plot(np.random.randn(<span class="hljs-number">1000</span>).cumsum())</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-caf9300dacb61fa4.webp" alt="img"></p>
<p>图9-8 用于演示xticks的简单线型图（带有标签）</p>
<p>要改变x轴刻度，最简单的办法是使用set_xticks和set_xticklabels。前者告诉matplotlib要将刻度放在数据范围中的哪些位置，默认情况下，这些位置也就是刻度标签。但我们可以通过set_xticklabels将任何其他的值用作标签：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">40</span>]: ticks = ax.set_xticks([<span class="hljs-number">0</span>, <span class="hljs-number">250</span>, <span class="hljs-number">500</span>, <span class="hljs-number">750</span>, <span class="hljs-number">1000</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: labels = ax.set_xticklabels([<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>, <span class="hljs-string">'five'</span>],</span><br><span class="line">   ....:                             rotation=<span class="hljs-number">30</span>, fontsize=<span class="hljs-string">'small'</span>)</span><br></pre></td></tr></table></figure>

<p>rotation选项设定x刻度标签倾斜30度。最后，再用set_xlabel为X轴设置一个名称，并用set_title设置一个标题（见图9-9的结果）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">42</span>]: ax.set_title(<span class="hljs-string">'My first matplotlib plot'</span>)</span><br><span class="line">Out[<span class="hljs-number">42</span>]: &lt;matplotlib.text.Text at <span class="hljs-number">0x7fb624d055f8</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: ax.set_xlabel(<span class="hljs-string">'Stages'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-741f968323bd818f.webp" alt="img"></p>
<p>图9-9 用于演示xticks的简单线型图</p>
<p>Y轴的修改方式与此类似，只需将上述代码中的x替换为y即可。轴的类有集合方法，可以批量设定绘图选项。前面的例子，也可以写为：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">props = &#123;</span><br><span class="line">    <span class="hljs-string">'title'</span>: <span class="hljs-string">'My first matplotlib plot'</span>,</span><br><span class="line">    <span class="hljs-string">'xlabel'</span>: <span class="hljs-string">'Stages'</span></span><br><span class="line">&#125;</span><br><span class="line">ax.set(**props)</span><br></pre></td></tr></table></figure>

<h2 id="添加图例"><a href="#添加图例" class="headerlink" title="添加图例"></a>添加图例</h2><p>图例（legend）是另一种用于标识图表元素的重要工具。添加图例的方式有多种。最简单的是在添加subplot的时候传入label参数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: <span class="hljs-keyword">from</span> numpy.random <span class="hljs-keyword">import</span> randn</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">45</span>]: fig = plt.figure(); ax = fig.add_subplot(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: ax.plot(randn(<span class="hljs-number">1000</span>).cumsum(), <span class="hljs-string">'k'</span>, label=<span class="hljs-string">'one'</span>)</span><br><span class="line">Out[<span class="hljs-number">46</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624bdf860</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: ax.plot(randn(<span class="hljs-number">1000</span>).cumsum(), <span class="hljs-string">'k--'</span>, label=<span class="hljs-string">'two'</span>)</span><br><span class="line">Out[<span class="hljs-number">47</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624be90f0</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: ax.plot(randn(<span class="hljs-number">1000</span>).cumsum(), <span class="hljs-string">'k.'</span>, label=<span class="hljs-string">'three'</span>)</span><br><span class="line">Out[<span class="hljs-number">48</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624be9160</span>&gt;]</span><br></pre></td></tr></table></figure>

<p>在此之后，你可以调用ax.legend()或plt.legend()来自动创建图例（结果见图9-10）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: ax.legend(loc=<span class="hljs-string">'best'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-651ff89750c0a89b.webp" alt="img"></p>
<p>图9-10 带有三条线以及图例的简单线型图</p>
<p>legend方法有几个其它的loc位置参数选项。请查看文档字符串（使用ax.legend?）。</p>
<p>loc告诉matplotlib要将图例放在哪。如果你不是吹毛求疵的话，”best”是不错的选择，因为它会选择最不碍事的位置。要从图例中去除一个或多个元素，不传入label或传入label=’<em>nolegend</em>‘即可。（中文第一版这里把best错写成了beat）</p>
<h2 id="注解以及在Subplot上绘图"><a href="#注解以及在Subplot上绘图" class="headerlink" title="注解以及在Subplot上绘图"></a>注解以及在Subplot上绘图</h2><p>除标准的绘图类型，你可能还希望绘制一些子集的注解，可能是文本、箭头或其他图形等。注解和文字可以通过text、arrow和annotate函数进行添加。text可以将文本绘制在图表的指定坐标(x,y)，还可以加上一些自定义格式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ax.text(x, y, <span class="hljs-string">'Hello world!'</span>,</span><br><span class="line">        family=<span class="hljs-string">'monospace'</span>, fontsize=<span class="hljs-number">10</span>)</span><br></pre></td></tr></table></figure>

<p>注解中可以既含有文本也含有箭头。例如，我们根据最近的标准普尔500指数价格（来自Yahoo!Finance）绘制一张曲线图，并标出2008年到2009年金融危机期间的一些重要日期。你可以在Jupyter notebook的一个小窗中试验这段代码（图9-11是结果）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">data = pd.read_csv(<span class="hljs-string">'examples/spx.csv'</span>, index_col=<span class="hljs-number">0</span>, parse_dates=<span class="hljs-literal">True</span>)</span><br><span class="line">spx = data[<span class="hljs-string">'SPX'</span>]</span><br><span class="line"></span><br><span class="line">spx.plot(ax=ax, style=<span class="hljs-string">'k-'</span>)</span><br><span class="line"></span><br><span class="line">crisis_data = [</span><br><span class="line">    (datetime(<span class="hljs-number">2007</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>), <span class="hljs-string">'Peak of bull market'</span>),</span><br><span class="line">    (datetime(<span class="hljs-number">2008</span>, <span class="hljs-number">3</span>, <span class="hljs-number">12</span>), <span class="hljs-string">'Bear Stearns Fails'</span>),</span><br><span class="line">    (datetime(<span class="hljs-number">2008</span>, <span class="hljs-number">9</span>, <span class="hljs-number">15</span>), <span class="hljs-string">'Lehman Bankruptcy'</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> date, label <span class="hljs-keyword">in</span> crisis_data:</span><br><span class="line">    ax.annotate(label, xy=(date, spx.asof(date) + <span class="hljs-number">75</span>),</span><br><span class="line">                xytext=(date, spx.asof(date) + <span class="hljs-number">225</span>),</span><br><span class="line">                arrowprops=dict(facecolor=<span class="hljs-string">'black'</span>, headwidth=<span class="hljs-number">4</span>, width=<span class="hljs-number">2</span>,</span><br><span class="line">                                headlength=<span class="hljs-number">4</span>),</span><br><span class="line">                horizontalalignment=<span class="hljs-string">'left'</span>, verticalalignment=<span class="hljs-string">'top'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Zoom in on 2007-2010</span></span><br><span class="line">ax.set_xlim([<span class="hljs-string">'1/1/2007'</span>, <span class="hljs-string">'1/1/2011'</span>])</span><br><span class="line">ax.set_ylim([<span class="hljs-number">600</span>, <span class="hljs-number">1800</span>])</span><br><span class="line"></span><br><span class="line">ax.set_title(<span class="hljs-string">'Important dates in the 2008-2009 financial crisis'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-3127eaa51f5e4c2c.webp" alt="img"></p>
<p>图9-11 2008-2009年金融危机期间的重要日期</p>
<p>这张图中有几个重要的点要强调：ax.annotate方法可以在指定的x和y坐标轴绘制标签。我们使用set_xlim和set_ylim人工设定起始和结束边界，而不使用matplotlib的默认方法。最后，用ax.set_title添加图标标题。</p>
<p>更多有关注解的示例，请访问matplotlib的在线示例库。</p>
<p>图形的绘制要麻烦一些。matplotlib有一些表示常见图形的对象。这些对象被称为块（patch）。其中有些（如Rectangle和Circle），可以在matplotlib.pyplot中找到，但完整集合位于matplotlib.patches。</p>
<p>要在图表中添加一个图形，你需要创建一个块对象shp，然后通过ax.add_patch(shp)将其添加到subplot中（如图9-12所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">rect = plt.Rectangle((<span class="hljs-number">0.2</span>, <span class="hljs-number">0.75</span>), <span class="hljs-number">0.4</span>, <span class="hljs-number">0.15</span>, color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.3</span>)</span><br><span class="line">circ = plt.Circle((<span class="hljs-number">0.7</span>, <span class="hljs-number">0.2</span>), <span class="hljs-number">0.15</span>, color=<span class="hljs-string">'b'</span>, alpha=<span class="hljs-number">0.3</span>)</span><br><span class="line">pgon = plt.Polygon([[<span class="hljs-number">0.15</span>, <span class="hljs-number">0.15</span>], [<span class="hljs-number">0.35</span>, <span class="hljs-number">0.4</span>], [<span class="hljs-number">0.2</span>, <span class="hljs-number">0.6</span>]],</span><br><span class="line">                   color=<span class="hljs-string">'g'</span>, alpha=<span class="hljs-number">0.5</span>)</span><br><span class="line"></span><br><span class="line">ax.add_patch(rect)</span><br><span class="line">ax.add_patch(circ)</span><br><span class="line">ax.add_patch(pgon)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-1f8a3d7a3a02d7d8.webp" alt="img"></p>
<p>图9-12 由三个块图形组成的图</p>
<p>如果查看许多常见图表对象的具体实现代码，你就会发现它们其实就是由块patch组装而成的。</p>
<h2 id="将图表保存到文件"><a href="#将图表保存到文件" class="headerlink" title="将图表保存到文件"></a>将图表保存到文件</h2><p>利用plt.savefig可以将当前图表保存到文件。该方法相当于Figure对象的实例方法savefig。例如，要将图表保存为SVG文件，你只需输入：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.savefig(<span class="hljs-string">'figpath.svg'</span>)</span><br></pre></td></tr></table></figure>

<p>文件类型是通过文件扩展名推断出来的。因此，如果你使用的是.pdf，就会得到一个PDF文件。我在发布图片时最常用到两个重要的选项是dpi（控制“每英寸点数”分辨率）和bbox_inches（可以剪除当前图表周围的空白部分）。要得到一张带有最小白边且分辨率为400DPI的PNG图片，你可以：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.savefig(<span class="hljs-string">'figpath.png'</span>, dpi=<span class="hljs-number">400</span>, bbox_inches=<span class="hljs-string">'tight'</span>)</span><br></pre></td></tr></table></figure>

<p>savefig并非一定要写入磁盘，也可以写入任何文件型的对象，比如BytesIO：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO</span><br><span class="line">buffer = BytesIO()</span><br><span class="line">plt.savefig(buffer)</span><br><span class="line">plot_data = buffer.getvalue()</span><br></pre></td></tr></table></figure>

<p>表9-2列出了savefig的其它选项。</p>
<p><img src="/images/blog/7178691-4bee796bf7262423.webp" alt="img"></p>
<p>表9-2 Figure.savefig的选项</p>
<h2 id="matplotlib配置"><a href="#matplotlib配置" class="headerlink" title="matplotlib配置"></a>matplotlib配置</h2><p>matplotlib自带一些配色方案，以及为生成出版质量的图片而设定的默认配置信息。幸运的是，几乎所有默认行为都能通过一组全局参数进行自定义，它们可以管理图像大小、subplot边距、配色方案、字体大小、网格类型等。一种Python编程方式配置系统的方法是使用rc方法。例如，要将全局的图像默认大小设置为10×10，你可以执行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.rc(<span class="hljs-string">'figure'</span>, figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>))</span><br></pre></td></tr></table></figure>

<p>rc的第一个参数是希望自定义的对象，如’figure’、’axes’、’xtick’、’ytick’、’grid’、’legend’等。其后可以跟上一系列的关键字参数。一个简单的办法是将这些选项写成一个字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">font_options = &#123;<span class="hljs-string">'family'</span> : <span class="hljs-string">'monospace'</span>,</span><br><span class="line">                <span class="hljs-string">'weight'</span> : <span class="hljs-string">'bold'</span>,</span><br><span class="line">                <span class="hljs-string">'size'</span>   : <span class="hljs-string">'small'</span>&#125;</span><br><span class="line">plt.rc(<span class="hljs-string">'font'</span>, **font_options)</span><br></pre></td></tr></table></figure>

<p>要了解全部的自定义选项，请查阅matplotlib的配置文件matplotlibrc（位于matplotlib/mpl-data目录中）。如果对该文件进行了自定义，并将其放在你自己的.matplotlibrc目录中，则每次使用matplotlib时就会加载该文件。</p>
<p>下一节，我们会看到，seaborn包有若干内置的绘图主题或类型，它们使用了matplotlib的内部配置。</p>
<h1 id="9-2-使用pandas和seaborn绘图"><a href="#9-2-使用pandas和seaborn绘图" class="headerlink" title="9.2 使用pandas和seaborn绘图"></a>9.2 使用pandas和seaborn绘图</h1><p>matplotlib实际上是一种比较低级的工具。要绘制一张图表，你组装一些基本组件就行：数据展示（即图表类型：线型图、柱状图、盒形图、散布图、等值线图等）、图例、标题、刻度标签以及其他注解型信息。</p>
<p>在pandas中，我们有多列数据，还有行和列标签。pandas自身就有内置的方法，用于简化从DataFrame和Series绘制图形。另一个库seaborn（<a href="https://seaborn.pydata.org/），由Michael" target="_blank" rel="noopener">https://seaborn.pydata.org/），由Michael</a> Waskom创建的静态图形库。Seaborn简化了许多常见可视类型的创建。</p>
<blockquote>
<p>提示：引入seaborn会修改matplotlib默认的颜色方案和绘图类型，以提高可读性和美观度。即使你不使用seaborn API，你可能也会引入seaborn，作为提高美观度和绘制常见matplotlib图形的简化方法。</p>
</blockquote>
<h2 id="线型图"><a href="#线型图" class="headerlink" title="线型图"></a>线型图</h2><p>Series和DataFrame都有一个用于生成各类图表的plot方法。默认情况下，它们所生成的是线型图（如图9-13所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: s = pd.Series(np.random.randn(<span class="hljs-number">10</span>).cumsum(), index=np.arange(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">10</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: s.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-f28e5ab2ac94c7a2.webp" alt="img"></p>
<p>图9-13 简单的Series图表示例</p>
<p>该Series对象的索引会被传给matplotlib，并用以绘制X轴。可以通过use_index=False禁用该功能。X轴的刻度和界限可以通过xticks和xlim选项进行调节，Y轴就用yticks和ylim。plot参数的完整列表请参见表9-3。我只会讲解其中几个，剩下的就留给读者自己去研究了。</p>
<p><img src="/images/blog/7178691-6d9fbf863c09370a.webp" alt="img"></p>
<p><img src="/images/blog/7178691-44e50562aeb5eb49.webp" alt="img"></p>
<p>表9-3 Series.plot方法的参数</p>
<p>pandas的大部分绘图方法都有一个可选的ax参数，它可以是一个matplotlib的subplot对象。这使你能够在网格布局中更为灵活地处理subplot的位置。</p>
<p>DataFrame的plot方法会在一个subplot中为各列绘制一条线，并自动创建图例（如图9-14所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: df = pd.DataFrame(np.random.randn(<span class="hljs-number">10</span>, <span class="hljs-number">4</span>).cumsum(<span class="hljs-number">0</span>),</span><br><span class="line">   ....:                   columns=[<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>],</span><br><span class="line">   ....:                   index=np.arange(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">10</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: df.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-a1234d5e5ee41a40.webp" alt="img"></p>
<p>图9-14 简单的DataFrame绘图</p>
<p>plot属性包含一批不同绘图类型的方法。例如，df.plot()等价于df.plot.line()。后面会学习这些方法。</p>
<blockquote>
<p>笔记：plot的其他关键字参数会被传给相应的matplotlib绘图函数，所以要更深入地自定义图表，就必须学习更多有关matplotlib API的知识。</p>
</blockquote>
<p>DataFrame还有一些用于对列进行灵活处理的选项，例如，是要将所有列都绘制到一个subplot中还是创建各自的subplot。详细信息请参见表9-4。</p>
<p><img src="/images/blog/7178691-96651ecaa90f1c68.webp" alt="img"></p>
<p>表9-4 专用于DataFrame的plot参数</p>
<blockquote>
<p>注意： 有关时间序列的绘图，请见第11章。</p>
</blockquote>
<h2 id="柱状图"><a href="#柱状图" class="headerlink" title="柱状图"></a>柱状图</h2><p>plot.bar()和plot.barh()分别绘制水平和垂直的柱状图。这时，Series和DataFrame的索引将会被用作X（bar）或Y（barh）刻度（如图9-15所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">64</span>]: fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">65</span>]: data = pd.Series(np.random.rand(<span class="hljs-number">16</span>), index=list(<span class="hljs-string">'abcdefghijklmnop'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">66</span>]: data.plot.bar(ax=axes[<span class="hljs-number">0</span>], color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.7</span>)</span><br><span class="line">Out[<span class="hljs-number">66</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7fb62493d470</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: data.plot.barh(ax=axes[<span class="hljs-number">1</span>], color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.7</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-cd54c7ccfa3f0687.webp" alt="img"></p>
<p>图9-15 水平和垂直的柱状图</p>
<p>color=’k’和alpha=0.7设定了图形的颜色为黑色，并使用部分的填充透明度。对于DataFrame，柱状图会将每一行的值分为一组，并排显示，如图9-16所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: df = pd.DataFrame(np.random.rand(<span class="hljs-number">6</span>, <span class="hljs-number">4</span>),</span><br><span class="line">   ....:                   index=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>, <span class="hljs-string">'five'</span>, <span class="hljs-string">'six'</span>],</span><br><span class="line">   ....:                   columns=pd.Index([<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>], name=<span class="hljs-string">'Genus'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: df</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">Genus         A         B         C         D</span><br><span class="line">one    <span class="hljs-number">0.370670</span>  <span class="hljs-number">0.602792</span>  <span class="hljs-number">0.229159</span>  <span class="hljs-number">0.486744</span></span><br><span class="line">two    <span class="hljs-number">0.420082</span>  <span class="hljs-number">0.571653</span>  <span class="hljs-number">0.049024</span>  <span class="hljs-number">0.880592</span></span><br><span class="line">three  <span class="hljs-number">0.814568</span>  <span class="hljs-number">0.277160</span>  <span class="hljs-number">0.880316</span>  <span class="hljs-number">0.431326</span></span><br><span class="line">four   <span class="hljs-number">0.374020</span>  <span class="hljs-number">0.899420</span>  <span class="hljs-number">0.460304</span>  <span class="hljs-number">0.100843</span></span><br><span class="line">five   <span class="hljs-number">0.433270</span>  <span class="hljs-number">0.125107</span>  <span class="hljs-number">0.494675</span>  <span class="hljs-number">0.961825</span></span><br><span class="line">six    <span class="hljs-number">0.601648</span>  <span class="hljs-number">0.478576</span>  <span class="hljs-number">0.205690</span>  <span class="hljs-number">0.560547</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: df.plot.bar()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-bfc141acb37d99b5.webp" alt="img"></p>
<p>图9-16 DataFrame的柱状图</p>
<p>注意，DataFrame各列的名称”Genus”被用作了图例的标题。</p>
<p>设置stacked=True即可为DataFrame生成堆积柱状图，这样每行的值就会被堆积在一起（如图9-17所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: df.plot.barh(stacked=<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.5</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-c19e4246eb897978.webp" alt="img"></p>
<p>图9-17 DataFrame的堆积柱状图</p>
<blockquote>
<p>笔记：柱状图有一个非常不错的用法：利用value_counts图形化显示Series中各值的出现频率，比如s.value_counts().plot.bar()。</p>
</blockquote>
<p>再以本书前面用过的那个有关小费的数据集为例，假设我们想要做一张堆积柱状图以展示每天各种聚会规模的数据点的百分比。我用read_csv将数据加载进来，然后根据日期和聚会规模创建一张交叉表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: tips = pd.read_csv(<span class="hljs-string">'examples/tips.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: party_counts = pd.crosstab(tips[<span class="hljs-string">'day'</span>], tips[<span class="hljs-string">'size'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: party_counts</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">size  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span></span><br><span class="line">day                      </span><br><span class="line">Fri   <span class="hljs-number">1</span>  <span class="hljs-number">16</span>   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line">Sat   <span class="hljs-number">2</span>  <span class="hljs-number">53</span>  <span class="hljs-number">18</span>  <span class="hljs-number">13</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line">Sun   <span class="hljs-number">0</span>  <span class="hljs-number">39</span>  <span class="hljs-number">15</span>  <span class="hljs-number">18</span>  <span class="hljs-number">3</span>  <span class="hljs-number">1</span></span><br><span class="line">Thur  <span class="hljs-number">1</span>  <span class="hljs-number">48</span>   <span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">1</span>  <span class="hljs-number">3</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Not many 1- and 6-person parties</span></span><br><span class="line">In [<span class="hljs-number">78</span>]: party_counts = party_counts.loc[:, <span class="hljs-number">2</span>:<span class="hljs-number">5</span>]</span><br></pre></td></tr></table></figure>

<p>然后进行规格化，使得各行的和为1，并生成图表（如图9-18所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Normalize to sum to 1</span></span><br><span class="line">In [<span class="hljs-number">79</span>]: party_pcts = party_counts.div(party_counts.sum(<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">80</span>]: party_pcts</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">size         <span class="hljs-number">2</span>         <span class="hljs-number">3</span>         <span class="hljs-number">4</span>         <span class="hljs-number">5</span></span><br><span class="line">day                                         </span><br><span class="line">Fri   <span class="hljs-number">0.888889</span>  <span class="hljs-number">0.055556</span>  <span class="hljs-number">0.055556</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">Sat   <span class="hljs-number">0.623529</span>  <span class="hljs-number">0.211765</span>  <span class="hljs-number">0.152941</span>  <span class="hljs-number">0.011765</span></span><br><span class="line">Sun   <span class="hljs-number">0.520000</span>  <span class="hljs-number">0.200000</span>  <span class="hljs-number">0.240000</span>  <span class="hljs-number">0.040000</span></span><br><span class="line">Thur  <span class="hljs-number">0.827586</span>  <span class="hljs-number">0.068966</span>  <span class="hljs-number">0.086207</span>  <span class="hljs-number">0.017241</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">81</span>]: party_pcts.plot.bar()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-2918f67936823834.webp" alt="img"></p>
<p>图9-18 每天各种聚会规模的比例</p>
<p>于是，通过该数据集就可以看出，聚会规模在周末会变大。</p>
<p>对于在绘制一个图形之前，需要进行合计的数据，使用seaborn可以减少工作量。用seaborn来看每天的小费比例（图9-19是结果）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">83</span>]: <span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: tips[<span class="hljs-string">'tip_pct'</span>] = tips[<span class="hljs-string">'tip'</span>] / (tips[<span class="hljs-string">'total_bill'</span>] - tips[<span class="hljs-string">'tip'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: tips.head()</span><br><span class="line">Out[<span class="hljs-number">85</span>]: </span><br><span class="line">   total_bill   tip smoker  day    time  size   tip_pct</span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">16.99</span>  <span class="hljs-number">1.01</span>     No  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.063204</span></span><br><span class="line"><span class="hljs-number">1</span>       <span class="hljs-number">10.34</span>  <span class="hljs-number">1.66</span>     No  Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.191244</span></span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">21.01</span>  <span class="hljs-number">3.50</span>     No  Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.199886</span></span><br><span class="line"><span class="hljs-number">3</span>       <span class="hljs-number">23.68</span>  <span class="hljs-number">3.31</span>     No  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.162494</span></span><br><span class="line"><span class="hljs-number">4</span>       <span class="hljs-number">24.59</span>  <span class="hljs-number">3.61</span>     No  Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.172069</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: sns.barplot(x=<span class="hljs-string">'tip_pct'</span>, y=<span class="hljs-string">'day'</span>, data=tips, orient=<span class="hljs-string">'h'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-c33e8b3add99904b.webp" alt="img"></p>
<p>图9-19 小费的每日比例，带有误差条</p>
<p>seaborn的绘制函数使用data参数，它可能是pandas的DataFrame。其它的参数是关于列的名字。因为一天的每个值有多次观察，柱状图的值是tip_pct的平均值。绘制在柱状图上的黑线代表95%置信区间（可以通过可选参数配置）。</p>
<p>seaborn.barplot有颜色选项，使我们能够通过一个额外的值设置（见图9-20）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">88</span>]: sns.barplot(x=<span class="hljs-string">'tip_pct'</span>, y=<span class="hljs-string">'day'</span>, hue=<span class="hljs-string">'time'</span>, data=tips, orient=<span class="hljs-string">'h'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-06abe2f070222115.webp" alt="img"></p>
<p>图9-20 根据天和时间的小费比例</p>
<p>注意，seaborn已经自动修改了图形的美观度：默认调色板，图形背景和网格线的颜色。你可以用seaborn.set在不同的图形外观之间切换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">90</span>]: sns.set(style=<span class="hljs-string">"whitegrid"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="直方图和密度图"><a href="#直方图和密度图" class="headerlink" title="直方图和密度图"></a>直方图和密度图</h2><p>直方图（histogram）是一种可以对值频率进行离散化显示的柱状图。数据点被拆分到离散的、间隔均匀的面元中，绘制的是各面元中数据点的数量。再以前面那个小费数据为例，通过在Series使用plot.hist方法，我们可以生成一张“小费占消费总额百分比”的直方图（如图9-21所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">92</span>]: tips[<span class="hljs-string">'tip_pct'</span>].plot.hist(bins=<span class="hljs-number">50</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-255279376f7649a3.webp" alt="img"></p>
<p>图9-21 小费百分比的直方图</p>
<p>与此相关的一种图表类型是密度图，它是通过计算“可能会产生观测数据的连续概率分布的估计”而产生的。一般的过程是将该分布近似为一组核（即诸如正态分布之类的较为简单的分布）。因此，密度图也被称作KDE（Kernel Density Estimate，核密度估计）图。使用plot.kde和标准混合正态分布估计即可生成一张密度图（见图9-22）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: tips[<span class="hljs-string">'tip_pct'</span>].plot.density()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-ee929d033159516a.webp" alt="img"></p>
<p>图9-22 小费百分比的密度图</p>
<p>seaborn的distplot方法绘制直方图和密度图更加简单，还可以同时画出直方图和连续密度估计图。作为例子，考虑一个双峰分布，由两个不同的标准正态分布组成（见图9-23）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: comp1 = np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, size=<span class="hljs-number">200</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: comp2 = np.random.normal(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>, size=<span class="hljs-number">200</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: values = pd.Series(np.concatenate([comp1, comp2]))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: sns.distplot(values, bins=<span class="hljs-number">100</span>, color=<span class="hljs-string">'k'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-975f04d750c4efe2.webp" alt="img"></p>
<p>图9-23 标准混合密度估计的标准直方图</p>
<h2 id="散布图或点图"><a href="#散布图或点图" class="headerlink" title="散布图或点图"></a>散布图或点图</h2><p>点图或散布图是观察两个一维数据序列之间的关系的有效手段。在下面这个例子中，我加载了来自statsmodels项目的macrodata数据集，选择了几个变量，然后计算对数差：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">100</span>]: macro = pd.read_csv(<span class="hljs-string">'examples/macrodata.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">101</span>]: data = macro[[<span class="hljs-string">'cpi'</span>, <span class="hljs-string">'m1'</span>, <span class="hljs-string">'tbilrate'</span>, <span class="hljs-string">'unemp'</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: trans_data = np.log(data).diff().dropna()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: trans_data[<span class="hljs-number">-5</span>:]</span><br><span class="line">Out[<span class="hljs-number">103</span>]: </span><br><span class="line">          cpi        m1  tbilrate     unemp</span><br><span class="line"><span class="hljs-number">198</span> <span class="hljs-number">-0.007904</span>  <span class="hljs-number">0.045361</span> <span class="hljs-number">-0.396881</span>  <span class="hljs-number">0.105361</span></span><br><span class="line"><span class="hljs-number">199</span> <span class="hljs-number">-0.021979</span>  <span class="hljs-number">0.066753</span> <span class="hljs-number">-2.277267</span>  <span class="hljs-number">0.139762</span></span><br><span class="line"><span class="hljs-number">200</span>  <span class="hljs-number">0.002340</span>  <span class="hljs-number">0.010286</span>  <span class="hljs-number">0.606136</span>  <span class="hljs-number">0.160343</span></span><br><span class="line"><span class="hljs-number">201</span>  <span class="hljs-number">0.008419</span>  <span class="hljs-number">0.037461</span> <span class="hljs-number">-0.200671</span>  <span class="hljs-number">0.127339</span></span><br><span class="line"><span class="hljs-number">202</span>  <span class="hljs-number">0.008894</span>  <span class="hljs-number">0.012202</span> <span class="hljs-number">-0.405465</span>  <span class="hljs-number">0.042560</span></span><br></pre></td></tr></table></figure>

<p>然后可以使用seaborn的regplot方法，它可以做一个散布图，并加上一条线性回归的线（见图9-24）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: sns.regplot(<span class="hljs-string">'m1'</span>, <span class="hljs-string">'unemp'</span>, data=trans_data)</span><br><span class="line">Out[<span class="hljs-number">105</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7fb613720be0</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: plt.title(<span class="hljs-string">'Changes in log %s versus log %s'</span> % (<span class="hljs-string">'m1'</span>, <span class="hljs-string">'unemp'</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-2133d20739478a80.webp" alt="img"></p>
<p>图9-24 seaborn的回归/散布图</p>
<p>在探索式数据分析工作中，同时观察一组变量的散布图是很有意义的，这也被称为散布图矩阵（scatter plot matrix）。纯手工创建这样的图表很费工夫，所以seaborn提供了一个便捷的pairplot函数，它支持在对角线上放置每个变量的直方图或密度估计（见图9-25）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">107</span>]: sns.pairplot(trans_data, diag_kind=<span class="hljs-string">'kde'</span>, plot_kws=&#123;<span class="hljs-string">'alpha'</span>: <span class="hljs-number">0.2</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-20aa530a44e06f61.webp" alt="img"></p>
<p>图9-25 statsmodels macro data的散布图矩阵</p>
<p>你可能注意到了plot_kws参数。它可以让我们传递配置选项到非对角线元素上的图形使用。对于更详细的配置选项，可以查阅seaborn.pairplot文档字符串。</p>
<h2 id="分面网格（facet-grid）和类型数据"><a href="#分面网格（facet-grid）和类型数据" class="headerlink" title="分面网格（facet grid）和类型数据"></a>分面网格（facet grid）和类型数据</h2><p>要是数据集有额外的分组维度呢？有多个分类变量的数据可视化的一种方法是使用小面网格。seaborn有一个有用的内置函数factorplot，可以简化制作多种分面图（见图9-26）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: sns.factorplot(x=<span class="hljs-string">'day'</span>, y=<span class="hljs-string">'tip_pct'</span>, hue=<span class="hljs-string">'time'</span>, col=<span class="hljs-string">'smoker'</span>,</span><br><span class="line">  .....:                kind=<span class="hljs-string">'bar'</span>, data=tips[tips.tip_pct &lt; <span class="hljs-number">1</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-737ba19a0cbdd46f.webp" alt="img"></p>
<p>图9-26 按照天/时间/吸烟者的小费百分比</p>
<p>除了在分面中用不同的颜色按时间分组，我们还可以通过给每个时间值添加一行来扩展分面网格：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: sns.factorplot(x=<span class="hljs-string">'day'</span>, y=<span class="hljs-string">'tip_pct'</span>, row=<span class="hljs-string">'time'</span>,</span><br><span class="line">   .....:                col=<span class="hljs-string">'smoker'</span>,</span><br><span class="line">   .....:                kind=<span class="hljs-string">'bar'</span>, data=tips[tips.tip_pct &lt; <span class="hljs-number">1</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-4e52192441c609f7.webp" alt="img"></p>
<p>图9-27 按天的tip_pct，通过time/smoker分面</p>
<p>factorplot支持其它的绘图类型，你可能会用到。例如，盒图（它可以显示中位数，四分位数，和异常值）就是一个有用的可视化类型（见图9-28）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">110</span>]: sns.factorplot(x=<span class="hljs-string">'tip_pct'</span>, y=<span class="hljs-string">'day'</span>, kind=<span class="hljs-string">'box'</span>,</span><br><span class="line">   .....:                data=tips[tips.tip_pct &lt; <span class="hljs-number">0.5</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-356fb27a7c658920.webp" alt="img"></p>
<p>图9-28 按天的tip_pct的盒图</p>
<p>使用更通用的seaborn.FacetGrid类，你可以创建自己的分面网格。请查阅seaborn的文档（<a href="https://seaborn.pydata.org/）。" target="_blank" rel="noopener">https://seaborn.pydata.org/）。</a></p>
<h1 id="9-3-其它的Python可视化工具"><a href="#9-3-其它的Python可视化工具" class="headerlink" title="9.3 其它的Python可视化工具"></a>9.3 其它的Python可视化工具</h1><p>与其它开源库类似，Python创建图形的方式非常多（根本罗列不完）。自从2010年，许多开发工作都集中在创建交互式图形以便在Web上发布。利用工具如Boken（<a href="https://bokeh.pydata.org/en/latest/）和Plotly（https://github.com/plotly/plotly.py），现在可以创建动态交互图形，用于网页浏览器。" target="_blank" rel="noopener">https://bokeh.pydata.org/en/latest/）和Plotly（https://github.com/plotly/plotly.py），现在可以创建动态交互图形，用于网页浏览器。</a></p>
<p>对于创建用于打印或网页的静态图形，我建议默认使用matplotlib和附加的库，比如pandas和seaborn。对于其它数据可视化要求，学习其它的可用工具可能是有用的。我鼓励你探索绘图的生态系统，因为它将持续发展。</p>
<h1 id="9-4-总结"><a href="#9-4-总结" class="headerlink" title="9.4 总结"></a>9.4 总结</h1><p>本章的目的是熟悉一些基本的数据可视化操作，使用pandas，matplotlib，和seaborn。如果视觉显示数据分析的结果对你的工作很重要，我鼓励你寻求更多的资源来了解更高效的数据可视化。这是一个活跃的研究领域，你可以通过在线和纸质的形式学习许多优秀的资源。</p>
<p>下一章，我们将重点放在pandas的数据聚合和分组操作上。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 6738 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC8%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E8%A7%84%E6%95%B4%EF%BC%9A%E8%81%9A%E5%90%88%E3%80%81%E5%90%88%E5%B9%B6%E5%92%8C%E9%87%8D%E5%A1%91/">《利用Python进行数据分析·第2版》第8章 数据规整：聚合、合并和重塑</a>
            
        </h1>
        <div class="content">
            <h1 id="《利用Python进行数据分析·第2版》第8章-数据规整：聚合、合并和重塑"><a href="#《利用Python进行数据分析·第2版》第8章-数据规整：聚合、合并和重塑" class="headerlink" title="《利用Python进行数据分析·第2版》第8章 数据规整：聚合、合并和重塑"></a>《利用Python进行数据分析·第2版》第8章 数据规整：聚合、合并和重塑</h1><hr>
<p>转载自<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
第8章 数据规整：聚合、合并和重塑
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>在许多应用中，数据可能分散在许多文件或数据库中，存储的形式也不利于分析。本章关注可以聚合、合并、重塑数据的方法。</p>
<p>首先，我会介绍pandas的层次化索引，它广泛用于以上操作。然后，我深入介绍了一些特殊的数据操作。在第14章，你可以看到这些工具的多种应用。</p>
<h1 id="8-1-层次化索引"><a href="#8-1-层次化索引" class="headerlink" title="8.1 层次化索引"></a>8.1 层次化索引</h1><p>层次化索引（hierarchical indexing）是pandas的一项重要功能，它使你能在一个轴上拥有多个（两个以上）索引级别。抽象点说，它使你能以低维度形式处理高维度数据。我们先来看一个简单的例子：创建一个Series，并用一个由列表或数组组成的列表作为索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">9</span>]: data = pd.Series(np.random.randn(<span class="hljs-number">9</span>),</span><br><span class="line">   ...:                  index=[[<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">   ...:                         [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">10</span>]: data</span><br><span class="line">Out[<span class="hljs-number">10</span>]: </span><br><span class="line">a  <span class="hljs-number">1</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.478943</span></span><br><span class="line">   <span class="hljs-number">3</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line">b  <span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">c  <span class="hljs-number">1</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.092908</span></span><br><span class="line">d  <span class="hljs-number">2</span>    <span class="hljs-number">0.281746</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">0.769023</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>看到的结果是经过美化的带有MultiIndex索引的Series的格式。索引之间的“间隔”表示“直接使用上面的标签”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">11</span>]: data.index</span><br><span class="line">Out[<span class="hljs-number">11</span>]: </span><br><span class="line">MultiIndex(levels=[[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]],</span><br><span class="line">           labels=[[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]])</span><br></pre></td></tr></table></figure>

<p>对于一个层次化索引的对象，可以使用所谓的部分索引，使用它选取数据子集的操作更简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: data[<span class="hljs-string">'b'</span>]</span><br><span class="line">Out[<span class="hljs-number">12</span>]: </span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: data[<span class="hljs-string">'b'</span>:<span class="hljs-string">'c'</span>]</span><br><span class="line">Out[<span class="hljs-number">13</span>]: </span><br><span class="line">b  <span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">c  <span class="hljs-number">1</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.092908</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: data.loc[[<span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>]]</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">b  <span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">d  <span class="hljs-number">2</span>    <span class="hljs-number">0.281746</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">0.769023</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>有时甚至还可以在“内层”中进行选取：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: data.loc[:, <span class="hljs-number">2</span>]</span><br><span class="line">Out[<span class="hljs-number">15</span>]: </span><br><span class="line">a    <span class="hljs-number">0.478943</span></span><br><span class="line">c    <span class="hljs-number">0.092908</span></span><br><span class="line">d    <span class="hljs-number">0.281746</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>层次化索引在数据重塑和基于分组的操作（如透视表生成）中扮演着重要的角色。例如，可以通过unstack方法将这段数据重新安排到一个DataFrame中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">16</span>]: data.unstack()</span><br><span class="line">Out[<span class="hljs-number">16</span>]: </span><br><span class="line">          <span class="hljs-number">1</span>         <span class="hljs-number">2</span>         <span class="hljs-number">3</span></span><br><span class="line">a <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.478943</span> <span class="hljs-number">-0.519439</span></span><br><span class="line">b <span class="hljs-number">-0.555730</span>       NaN  <span class="hljs-number">1.965781</span></span><br><span class="line">c  <span class="hljs-number">1.393406</span>  <span class="hljs-number">0.092908</span>       NaN</span><br><span class="line">d       NaN  <span class="hljs-number">0.281746</span>  <span class="hljs-number">0.769023</span></span><br></pre></td></tr></table></figure>

<p>unstack的逆运算是stack：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: data.unstack().stack()</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line">a  <span class="hljs-number">1</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.478943</span></span><br><span class="line">   <span class="hljs-number">3</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line">b  <span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">c  <span class="hljs-number">1</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.092908</span></span><br><span class="line">d  <span class="hljs-number">2</span>    <span class="hljs-number">0.281746</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">0.769023</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>stack和unstack将在本章后面详细讲解。</p>
<p>对于一个DataFrame，每条轴都可以有分层索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: frame = pd.DataFrame(np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">4</span>, <span class="hljs-number">3</span>)),</span><br><span class="line">   ....:                      index=[[<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]],</span><br><span class="line">   ....:                      columns=[[<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Colorado'</span>],</span><br><span class="line">   ....:                               [<span class="hljs-string">'Green'</span>, <span class="hljs-string">'Red'</span>, <span class="hljs-string">'Green'</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">19</span>]: </span><br><span class="line">     Ohio     Colorado</span><br><span class="line">    Green Red    Green</span><br><span class="line">a <span class="hljs-number">1</span>     <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line">  <span class="hljs-number">2</span>     <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line">b <span class="hljs-number">1</span>     <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line">  <span class="hljs-number">2</span>     <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>各层都可以有名字（可以是字符串，也可以是别的Python对象）。如果指定了名称，它们就会显示在控制台输出中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">20</span>]: frame.index.names = [<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: frame.columns.names = [<span class="hljs-string">'state'</span>, <span class="hljs-string">'color'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">22</span>]: </span><br><span class="line">state      Ohio     Colorado</span><br><span class="line">color     Green Red    Green</span><br><span class="line">key1 key2                   </span><br><span class="line">a    <span class="hljs-number">1</span>        <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line">     <span class="hljs-number">2</span>        <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line">b    <span class="hljs-number">1</span>        <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line">     <span class="hljs-number">2</span>        <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：小心区分索引名state、color与行标签。</p>
</blockquote>
<p>有了部分列索引，因此可以轻松选取列分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">23</span>]: frame[<span class="hljs-string">'Ohio'</span>]</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">color      Green  Red</span><br><span class="line">key1 key2            </span><br><span class="line">a    <span class="hljs-number">1</span>         <span class="hljs-number">0</span>    <span class="hljs-number">1</span></span><br><span class="line">     <span class="hljs-number">2</span>         <span class="hljs-number">3</span>    <span class="hljs-number">4</span></span><br><span class="line">b    <span class="hljs-number">1</span>         <span class="hljs-number">6</span>    <span class="hljs-number">7</span></span><br><span class="line">     <span class="hljs-number">2</span>         <span class="hljs-number">9</span>   <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>可以单独创建MultiIndex然后复用。上面那个DataFrame中的（带有分级名称）列可以这样创建：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MultiIndex.from_arrays([[<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Colorado'</span>], [<span class="hljs-string">'Green'</span>, <span class="hljs-string">'Red'</span>, <span class="hljs-string">'Green'</span>]],</span><br><span class="line">                       names=[<span class="hljs-string">'state'</span>, <span class="hljs-string">'color'</span>])</span><br></pre></td></tr></table></figure>

<h2 id="重排与分级排序"><a href="#重排与分级排序" class="headerlink" title="重排与分级排序"></a>重排与分级排序</h2><p>有时，你需要重新调整某条轴上各级别的顺序，或根据指定级别上的值对数据进行排序。swaplevel接受两个级别编号或名称，并返回一个互换了级别的新对象（但数据不会发生变化）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: frame.swaplevel(<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>)</span><br><span class="line">Out[<span class="hljs-number">24</span>]: </span><br><span class="line">state      Ohio     Colorado</span><br><span class="line">color     Green Red    Green</span><br><span class="line">key2 key1                   </span><br><span class="line"><span class="hljs-number">1</span>    a        <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>    a        <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1</span>    b        <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">2</span>    b        <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>而sort_index则根据单个级别中的值对数据进行排序。交换级别时，常常也会用到sort_index，这样最终结果就是按照指定顺序进行字母排序了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: frame.sort_index(level=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">state      Ohio     Colorado</span><br><span class="line">color     Green Red    Green</span><br><span class="line">key1 key2                   </span><br><span class="line">a    <span class="hljs-number">1</span>        <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line">b    <span class="hljs-number">1</span>        <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line">a    <span class="hljs-number">2</span>        <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line">b    <span class="hljs-number">2</span>        <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">26</span>]: frame.swaplevel(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).sort_index(level=<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">26</span>]: </span><br><span class="line">state      Ohio     Colorado</span><br><span class="line">color     Green Red    Green</span><br><span class="line">key2 key1                   </span><br><span class="line"><span class="hljs-number">1</span>    a        <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line">     b        <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">2</span>    a        <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line">     b        <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<h2 id="根据级别汇总统计"><a href="#根据级别汇总统计" class="headerlink" title="根据级别汇总统计"></a>根据级别汇总统计</h2><p>许多对DataFrame和Series的描述和汇总统计都有一个level选项，它用于指定在某条轴上求和的级别。再以上面那个DataFrame为例，我们可以根据行或列上的级别来进行求和：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">27</span>]: frame.sum(level=<span class="hljs-string">'key2'</span>)</span><br><span class="line">Out[<span class="hljs-number">27</span>]: </span><br><span class="line">state  Ohio     Colorado</span><br><span class="line">color Green Red    Green</span><br><span class="line">key2                    </span><br><span class="line"><span class="hljs-number">1</span>         <span class="hljs-number">6</span>   <span class="hljs-number">8</span>       <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">2</span>        <span class="hljs-number">12</span>  <span class="hljs-number">14</span>       <span class="hljs-number">16</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: frame.sum(level=<span class="hljs-string">'color'</span>, axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">color      Green  Red</span><br><span class="line">key1 key2            </span><br><span class="line">a    <span class="hljs-number">1</span>         <span class="hljs-number">2</span>    <span class="hljs-number">1</span></span><br><span class="line">     <span class="hljs-number">2</span>         <span class="hljs-number">8</span>    <span class="hljs-number">4</span></span><br><span class="line">b    <span class="hljs-number">1</span>        <span class="hljs-number">14</span>    <span class="hljs-number">7</span></span><br><span class="line">     <span class="hljs-number">2</span>        <span class="hljs-number">20</span>   <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>这其实是利用了pandas的groupby功能，本书稍后将对其进行详细讲解。</p>
<h2 id="使用DataFrame的列进行索引"><a href="#使用DataFrame的列进行索引" class="headerlink" title="使用DataFrame的列进行索引"></a>使用DataFrame的列进行索引</h2><p>人们经常想要将DataFrame的一个或多个列当做行索引来用，或者可能希望将行索引变成DataFrame的列。以下面这个DataFrame为例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: frame = pd.DataFrame(&#123;<span class="hljs-string">'a'</span>: range(<span class="hljs-number">7</span>), <span class="hljs-string">'b'</span>: range(<span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>),</span><br><span class="line">   ....:                       <span class="hljs-string">'c'</span>: [<span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'two'</span>,</span><br><span class="line">   ....:                             <span class="hljs-string">'two'</span>, <span class="hljs-string">'two'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'d'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">   a  b    c  d</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">7</span>  one  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">6</span>  one  <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  one  <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  two  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">4</span>  <span class="hljs-number">3</span>  two  <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">5</span>  <span class="hljs-number">2</span>  two  <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">6</span>  <span class="hljs-number">1</span>  two  <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<p>DataFrame的set_index函数会将其一个或多个列转换为行索引，并创建一个新的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: frame2 = frame.set_index([<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: frame2</span><br><span class="line">Out[<span class="hljs-number">32</span>]: </span><br><span class="line">       a  b</span><br><span class="line">c   d      </span><br><span class="line">one <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">7</span></span><br><span class="line">    <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">6</span></span><br><span class="line">    <span class="hljs-number">2</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span></span><br><span class="line">two <span class="hljs-number">0</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span></span><br><span class="line">    <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">3</span></span><br><span class="line">    <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">2</span></span><br><span class="line">    <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，那些列会从DataFrame中移除，但也可以将其保留下来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: frame.set_index([<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>], drop=<span class="hljs-literal">False</span>)</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">       a  b    c  d</span><br><span class="line">c   d              </span><br><span class="line">one <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">7</span>  one  <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">6</span>  one  <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-number">2</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  one  <span class="hljs-number">2</span></span><br><span class="line">two <span class="hljs-number">0</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  two  <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">3</span>  two  <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">2</span>  two  <span class="hljs-number">2</span></span><br><span class="line">    <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">1</span>  two  <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<p>reset_index的功能跟set_index刚好相反，层次化索引的级别会被转移到列里面：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">34</span>]: frame2.reset_index()</span><br><span class="line">Out[<span class="hljs-number">34</span>]:</span><br><span class="line">c  d  a  b</span><br><span class="line"><span class="hljs-number">0</span>  one  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">1</span>  one  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">2</span>  one  <span class="hljs-number">2</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">3</span>  two  <span class="hljs-number">0</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">4</span>  two  <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">5</span>  two  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">6</span>  two  <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="8-2-合并数据集"><a href="#8-2-合并数据集" class="headerlink" title="8.2 合并数据集"></a>8.2 合并数据集</h1><p>pandas对象中的数据可以通过一些方式进行合并：</p>
<ul>
<li>pandas.merge可根据一个或多个键将不同DataFrame中的行连接起来。SQL或其他关系型数据库的用户对此应该会比较熟悉，因为它实现的就是数据库的join操作。</li>
<li>pandas.concat可以沿着一条轴将多个对象堆叠到一起。</li>
<li>实例方法combine_first可以将重复数据拼接在一起，用一个对象中的值填充另一个对象中的缺失值。</li>
</ul>
<p>我将分别对它们进行讲解，并给出一些例子。本书剩余部分的示例中将经常用到它们。</p>
<h2 id="数据库风格的DataFrame合并"><a href="#数据库风格的DataFrame合并" class="headerlink" title="数据库风格的DataFrame合并"></a>数据库风格的DataFrame合并</h2><p>数据集的合并（merge）或连接（join）运算是通过一个或多个键将行连接起来的。这些运算是关系型数据库（基于SQL）的核心。pandas的merge函数是对数据应用这些算法的主要切入点。</p>
<p>以一个简单的例子开始：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: df1 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data1'</span>: range(<span class="hljs-number">7</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: df2 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data2'</span>: range(<span class="hljs-number">3</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">   data1 key</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>   a</span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">3</span>   c</span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   a</span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   a</span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">6</span>   b</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">38</span>]: </span><br><span class="line">   data2 key</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   a</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>   d</span><br></pre></td></tr></table></figure>

<p>这是一种多对一的合并。df1中的数据有多个被标记为a和b的行，而df2中key列的每个值则仅对应一行。对这些对象调用merge即可得到：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: pd.merge(df1, df2)</span><br><span class="line">Out[<span class="hljs-number">39</span>]: </span><br><span class="line">   data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">6</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">2</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   a      <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>注意，我并没有指明要用哪个列进行连接。如果没有指定，merge就会将重叠列的列名当做键。不过，最好明确指定一下：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">40</span>]: pd.merge(df1, df2, on=<span class="hljs-string">'key'</span>)</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">   data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">6</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">2</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   a      <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>如果两个对象的列名不同，也可以分别进行指定：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">41</span>]: df3 = pd.DataFrame(&#123;<span class="hljs-string">'lkey'</span>: [<span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data1'</span>: range(<span class="hljs-number">7</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: df4 = pd.DataFrame(&#123;<span class="hljs-string">'rkey'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data2'</span>: range(<span class="hljs-number">3</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: pd.merge(df3, df4, left_on=<span class="hljs-string">'lkey'</span>, right_on=<span class="hljs-string">'rkey'</span>)</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line">   data1 lkey  data2 rkey</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>    b      <span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>    b      <span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">6</span>    b      <span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">2</span>    a      <span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>    a      <span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>    a      <span class="hljs-number">0</span>    a</span><br></pre></td></tr></table></figure>

<p>可能你已经注意到了，结果里面c和d以及与之相关的数据消失了。默认情况下，merge做的是“内连接”；结果中的键是交集。其他方式还有”left”、”right”以及”outer”。外连接求取的是键的并集，组合了左连接和右连接的效果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: pd.merge(df1, df2, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line">   data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">0.0</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">1.0</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">6.0</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">2.0</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4.0</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">5.0</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">6</span>    <span class="hljs-number">3.0</span>   c    NaN</span><br><span class="line"><span class="hljs-number">7</span>    NaN   d    <span class="hljs-number">2.0</span></span><br></pre></td></tr></table></figure>

<p>表8-1对这些选项进行了总结。</p>
<p><img src="/images/blog/7178691-e49b3341f4a3c90e.webp" alt="img"></p>
<p>表8-1 不同的连接类型</p>
<p>多对多的合并有些不直观。看下面的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: df1 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data1'</span>: range(<span class="hljs-number">6</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: df2 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data2'</span>: range(<span class="hljs-number">5</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">47</span>]: </span><br><span class="line">   data1 key</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>   a</span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">3</span>   c</span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   a</span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   b</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line">   data2 key</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   a</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>   a</span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">3</span>   b</span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   d</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">49</span>]: pd.merge(df1, df2, on=<span class="hljs-string">'key'</span>, how=<span class="hljs-string">'left'</span>)</span><br><span class="line">Out[<span class="hljs-number">49</span>]: </span><br><span class="line">    data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">0</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>       <span class="hljs-number">0</span>   b    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">1</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">3</span>       <span class="hljs-number">1</span>   b    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">4</span>       <span class="hljs-number">2</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>       <span class="hljs-number">2</span>   a    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">6</span>       <span class="hljs-number">3</span>   c    NaN</span><br><span class="line"><span class="hljs-number">7</span>       <span class="hljs-number">4</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">8</span>       <span class="hljs-number">4</span>   a    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">9</span>       <span class="hljs-number">5</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">10</span>      <span class="hljs-number">5</span>   b    <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>多对多连接产生的是行的笛卡尔积。由于左边的DataFrame有3个”b”行，右边的有2个，所以最终结果中就有6个”b”行。连接方式只影响出现在结果中的不同的键的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: pd.merge(df1, df2, how=<span class="hljs-string">'inner'</span>)</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">   data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">0</span>   b      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">1</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">1</span>   b      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">5</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   b      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">2</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">7</span>      <span class="hljs-number">2</span>   a      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">8</span>      <span class="hljs-number">4</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">9</span>      <span class="hljs-number">4</span>   a      <span class="hljs-number">2</span></span><br></pre></td></tr></table></figure>

<p>要根据多个键进行合并，传入一个由列名组成的列表即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">51</span>]: left = pd.DataFrame(&#123;<span class="hljs-string">'key1'</span>: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>],</span><br><span class="line">   ....:                      <span class="hljs-string">'key2'</span>: [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'one'</span>],</span><br><span class="line">   ....:                      <span class="hljs-string">'lval'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">52</span>]: right = pd.DataFrame(&#123;<span class="hljs-string">'key1'</span>: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'bar'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'key2'</span>: [<span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'rval'</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: pd.merge(left, right, on=[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>], how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">  key1 key2  lval  rval</span><br><span class="line"><span class="hljs-number">0</span>  foo  one   <span class="hljs-number">1.0</span>   <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">1</span>  foo  one   <span class="hljs-number">1.0</span>   <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">2</span>  foo  two   <span class="hljs-number">2.0</span>   NaN</span><br><span class="line"><span class="hljs-number">3</span>  bar  one   <span class="hljs-number">3.0</span>   <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">4</span>  bar  two   NaN   <span class="hljs-number">7.0</span></span><br></pre></td></tr></table></figure>

<p>结果中会出现哪些键组合取决于所选的合并方式，你可以这样来理解：多个键形成一系列元组，并将其当做单个连接键（当然，实际上并不是这么回事）。</p>
<blockquote>
<p>注意：在进行列－列连接时，DataFrame对象中的索引会被丢弃。</p>
</blockquote>
<p>对于合并运算需要考虑的最后一个问题是对重复列名的处理。虽然你可以手工处理列名重叠的问题（查看前面介绍的重命名轴标签），但merge有一个更实用的suffixes选项，用于指定附加到左右两个DataFrame对象的重叠列名上的字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: pd.merge(left, right, on=<span class="hljs-string">'key1'</span>)</span><br><span class="line">Out[<span class="hljs-number">54</span>]: </span><br><span class="line">  key1 key2_x  lval key2_y  rval</span><br><span class="line"><span class="hljs-number">0</span>  foo    one     <span class="hljs-number">1</span>    one     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">1</span>  foo    one     <span class="hljs-number">1</span>    one     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2</span>  foo    two     <span class="hljs-number">2</span>    one     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">3</span>  foo    two     <span class="hljs-number">2</span>    one     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">4</span>  bar    one     <span class="hljs-number">3</span>    one     <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">5</span>  bar    one     <span class="hljs-number">3</span>    two     <span class="hljs-number">7</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: pd.merge(left, right, on=<span class="hljs-string">'key1'</span>, suffixes=(<span class="hljs-string">'_left'</span>, <span class="hljs-string">'_right'</span>))</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line">  key1 key2_left  lval key2_right  rval</span><br><span class="line"><span class="hljs-number">0</span>  foo       one     <span class="hljs-number">1</span>        one     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">1</span>  foo       one     <span class="hljs-number">1</span>        one     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2</span>  foo       two     <span class="hljs-number">2</span>        one     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">3</span>  foo       two     <span class="hljs-number">2</span>        one     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">4</span>  bar       one     <span class="hljs-number">3</span>        one     <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">5</span>  bar       one     <span class="hljs-number">3</span>        two     <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<p>merge的参数请参见表8-2。使用DataFrame的行索引合并是下一节的主题。</p>
<p>表8-2 merge函数的参数</p>
<p><img src="/images/blog/7178691-35ca716a4f1b8475.webp" alt="img"></p>
<p><img src="/images/blog/7178691-c86672e733ceccd9.webp" alt="img"></p>
<p>indicator 添加特殊的列_merge，它可以指明每个行的来源，它的值有left_only、right_only或both，根据每行的合并数据的来源。</p>
<h2 id="索引上的合并"><a href="#索引上的合并" class="headerlink" title="索引上的合并"></a>索引上的合并</h2><p>有时候，DataFrame中的连接键位于其索引中。在这种情况下，你可以传入left_index=True或right_index=True（或两个都传）以说明索引应该被用作连接键：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: left1 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'value'</span>: range(<span class="hljs-number">6</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">57</span>]: right1 = pd.DataFrame(&#123;<span class="hljs-string">'group_val'</span>: [<span class="hljs-number">3.5</span>, <span class="hljs-number">7</span>]&#125;, index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: left1</span><br><span class="line">Out[<span class="hljs-number">58</span>]:</span><br><span class="line"></span><br><span class="line">  key  value</span><br><span class="line"><span class="hljs-number">0</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>   a      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>   a      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>   b      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">5</span>   c      <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: right1</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line">   group_val</span><br><span class="line">a        <span class="hljs-number">3.5</span></span><br><span class="line">b        <span class="hljs-number">7.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: pd.merge(left1, right1, left_on=<span class="hljs-string">'key'</span>, right_index=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">60</span>]: </span><br><span class="line">  key  value  group_val</span><br><span class="line"><span class="hljs-number">0</span>   a      <span class="hljs-number">0</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">2</span>   a      <span class="hljs-number">2</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">3</span>   a      <span class="hljs-number">3</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">1</span>   b      <span class="hljs-number">1</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">4</span>   b      <span class="hljs-number">4</span>        <span class="hljs-number">7.0</span></span><br></pre></td></tr></table></figure>

<p>由于默认的merge方法是求取连接键的交集，因此你可以通过外连接的方式得到它们的并集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">61</span>]: pd.merge(left1, right1, left_on=<span class="hljs-string">'key'</span>, right_index=<span class="hljs-literal">True</span>, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line">  key  value  group_val</span><br><span class="line"><span class="hljs-number">0</span>   a      <span class="hljs-number">0</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">2</span>   a      <span class="hljs-number">2</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">3</span>   a      <span class="hljs-number">3</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">1</span>   b      <span class="hljs-number">1</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">4</span>   b      <span class="hljs-number">4</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">5</span>   c      <span class="hljs-number">5</span>        NaN</span><br></pre></td></tr></table></figure>

<p>对于层次化索引的数据，事情就有点复杂了，因为索引的合并默认是多键合并：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: lefth = pd.DataFrame(&#123;<span class="hljs-string">'key1'</span>: [<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>,</span><br><span class="line">   ....:                                <span class="hljs-string">'Nevada'</span>, <span class="hljs-string">'Nevada'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'key2'</span>: [<span class="hljs-number">2000</span>, <span class="hljs-number">2001</span>, <span class="hljs-number">2002</span>, <span class="hljs-number">2001</span>, <span class="hljs-number">2002</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'data'</span>: np.arange(<span class="hljs-number">5.</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: righth = pd.DataFrame(np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">6</span>, <span class="hljs-number">2</span>)),</span><br><span class="line">   ....:                       index=[[<span class="hljs-string">'Nevada'</span>, <span class="hljs-string">'Nevada'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>,</span><br><span class="line">   ....:                               <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>],</span><br><span class="line">   ....:                              [<span class="hljs-number">2001</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">2001</span>, <span class="hljs-number">2002</span>]],</span><br><span class="line">   ....:                       columns=[<span class="hljs-string">'event1'</span>, <span class="hljs-string">'event2'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">64</span>]: lefth</span><br><span class="line">Out[<span class="hljs-number">64</span>]: </span><br><span class="line">   data    key1  key2</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">1.0</span>    Ohio  <span class="hljs-number">2001</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">2.0</span>    Ohio  <span class="hljs-number">2002</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">3.0</span>  Nevada  <span class="hljs-number">2001</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">4.0</span>  Nevada  <span class="hljs-number">2002</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">65</span>]: righth</span><br><span class="line">Out[<span class="hljs-number">65</span>]: </span><br><span class="line">             event1  event2</span><br><span class="line">Nevada <span class="hljs-number">2001</span>       <span class="hljs-number">0</span>       <span class="hljs-number">1</span></span><br><span class="line">       <span class="hljs-number">2000</span>       <span class="hljs-number">2</span>       <span class="hljs-number">3</span></span><br><span class="line">Ohio   <span class="hljs-number">2000</span>       <span class="hljs-number">4</span>       <span class="hljs-number">5</span></span><br><span class="line">       <span class="hljs-number">2000</span>       <span class="hljs-number">6</span>       <span class="hljs-number">7</span></span><br><span class="line">       <span class="hljs-number">2001</span>       <span class="hljs-number">8</span>       <span class="hljs-number">9</span></span><br><span class="line">       <span class="hljs-number">2002</span>      <span class="hljs-number">10</span>      <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>这种情况下，你必须以列表的形式指明用作合并键的多个列（注意用how=’outer’对重复索引值的处理）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: pd.merge(lefth, righth, left_on=[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>], right_index=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">66</span>]: </span><br><span class="line">   data    key1  key2  event1  event2</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span>       <span class="hljs-number">4</span>       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span>       <span class="hljs-number">6</span>       <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">1.0</span>    Ohio  <span class="hljs-number">2001</span>       <span class="hljs-number">8</span>       <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">2.0</span>    Ohio  <span class="hljs-number">2002</span>      <span class="hljs-number">10</span>      <span class="hljs-number">11</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">3.0</span>  Nevada  <span class="hljs-number">2001</span>       <span class="hljs-number">0</span>       <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: pd.merge(lefth, righth, left_on=[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>],</span><br><span class="line">   ....:          right_index=<span class="hljs-literal">True</span>, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">67</span>]: </span><br><span class="line">   data    key1  key2  event1  event2</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span>     <span class="hljs-number">4.0</span>     <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span>     <span class="hljs-number">6.0</span>     <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">1.0</span>    Ohio  <span class="hljs-number">2001</span>     <span class="hljs-number">8.0</span>     <span class="hljs-number">9.0</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">2.0</span>    Ohio  <span class="hljs-number">2002</span>    <span class="hljs-number">10.0</span>    <span class="hljs-number">11.0</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">3.0</span>  Nevada  <span class="hljs-number">2001</span>     <span class="hljs-number">0.0</span>     <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">4.0</span>  Nevada  <span class="hljs-number">2002</span>     NaN     NaN</span><br><span class="line"><span class="hljs-number">4</span>   NaN  Nevada  <span class="hljs-number">2000</span>     <span class="hljs-number">2.0</span>     <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>同时使用合并双方的索引也没问题：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: left2 = pd.DataFrame([[<span class="hljs-number">1.</span>, <span class="hljs-number">2.</span>], [<span class="hljs-number">3.</span>, <span class="hljs-number">4.</span>], [<span class="hljs-number">5.</span>, <span class="hljs-number">6.</span>]],</span><br><span class="line">   ....:                      index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'e'</span>],</span><br><span class="line">   ....:                      columns=[<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Nevada'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">69</span>]: right2 = pd.DataFrame([[<span class="hljs-number">7.</span>, <span class="hljs-number">8.</span>], [<span class="hljs-number">9.</span>, <span class="hljs-number">10.</span>], [<span class="hljs-number">11.</span>, <span class="hljs-number">12.</span>], [<span class="hljs-number">13</span>, <span class="hljs-number">14</span>]],</span><br><span class="line">   ....:                       index=[<span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>],</span><br><span class="line">   ....:                       columns=[<span class="hljs-string">'Missouri'</span>, <span class="hljs-string">'Alabama'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: left2</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">   Ohio  Nevada</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span></span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span></span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: right2</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line">   Missouri  Alabama</span><br><span class="line">b       <span class="hljs-number">7.0</span>      <span class="hljs-number">8.0</span></span><br><span class="line">c       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span></span><br><span class="line">d      <span class="hljs-number">11.0</span>     <span class="hljs-number">12.0</span></span><br><span class="line">e      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: pd.merge(left2, right2, how=<span class="hljs-string">'outer'</span>, left_index=<span class="hljs-literal">True</span>, right_index=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line">   Ohio  Nevada  Missouri  Alabama</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span>       NaN      NaN</span><br><span class="line">b   NaN     NaN       <span class="hljs-number">7.0</span>      <span class="hljs-number">8.0</span></span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span>       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span></span><br><span class="line">d   NaN     NaN      <span class="hljs-number">11.0</span>     <span class="hljs-number">12.0</span></span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span>      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span></span><br></pre></td></tr></table></figure>

<p>DataFrame还有一个便捷的join实例方法，它能更为方便地实现按索引合并。它还可用于合并多个带有相同或相似索引的DataFrame对象，但要求没有重叠的列。在上面那个例子中，我们可以编写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: left2.join(right2, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">73</span>]: </span><br><span class="line">   Ohio  Nevada  Missouri  Alabama</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span>       NaN      NaN</span><br><span class="line">b   NaN     NaN       <span class="hljs-number">7.0</span>      <span class="hljs-number">8.0</span></span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span>       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span></span><br><span class="line">d   NaN     NaN      <span class="hljs-number">11.0</span>     <span class="hljs-number">12.0</span></span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span>      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span></span><br></pre></td></tr></table></figure>

<p>因为一些历史版本的遗留原因，DataFrame的join方法默认使用的是左连接，保留左边表的行索引。它还支持在调用的DataFrame的列上，连接传递的DataFrame索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: left1.join(right1, on=<span class="hljs-string">'key'</span>)</span><br><span class="line">Out[<span class="hljs-number">74</span>]: </span><br><span class="line">  key  value  group_val</span><br><span class="line"><span class="hljs-number">0</span>   a      <span class="hljs-number">0</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">1</span>   b      <span class="hljs-number">1</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">2</span>   a      <span class="hljs-number">2</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">3</span>   a      <span class="hljs-number">3</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">4</span>   b      <span class="hljs-number">4</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">5</span>   c      <span class="hljs-number">5</span>        NaN</span><br></pre></td></tr></table></figure>

<p>最后，对于简单的索引合并，你还可以向join传入一组DataFrame，下一节会介绍更为通用的concat函数，也能实现此功能：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: another = pd.DataFrame([[<span class="hljs-number">7.</span>, <span class="hljs-number">8.</span>], [<span class="hljs-number">9.</span>, <span class="hljs-number">10.</span>], [<span class="hljs-number">11.</span>, <span class="hljs-number">12.</span>], [<span class="hljs-number">16.</span>, <span class="hljs-number">17.</span>]],</span><br><span class="line">   ....:                        index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'f'</span>],</span><br><span class="line">   ....:                        columns=[<span class="hljs-string">'New York'</span>,</span><br><span class="line"><span class="hljs-string">'Oregon'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: another</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">   New York  Oregon</span><br><span class="line">a       <span class="hljs-number">7.0</span>     <span class="hljs-number">8.0</span></span><br><span class="line">c       <span class="hljs-number">9.0</span>    <span class="hljs-number">10.0</span></span><br><span class="line">e      <span class="hljs-number">11.0</span>    <span class="hljs-number">12.0</span></span><br><span class="line">f      <span class="hljs-number">16.0</span>    <span class="hljs-number">17.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: left2.join([right2, another])</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">   Ohio  Nevada  Missouri  Alabama  New York  Oregon</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span>       NaN      NaN       <span class="hljs-number">7.0</span>     <span class="hljs-number">8.0</span></span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span>       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span>       <span class="hljs-number">9.0</span>    <span class="hljs-number">10.0</span></span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span>      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span>      <span class="hljs-number">11.0</span>    <span class="hljs-number">12.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: left2.join([right2, another], how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">   Ohio  Nevada  Missouri  Alabama  New York  Oregon</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span>       NaN      NaN       <span class="hljs-number">7.0</span>     <span class="hljs-number">8.0</span></span><br><span class="line">b   NaN     NaN       <span class="hljs-number">7.0</span>      <span class="hljs-number">8.0</span>       NaN     NaN</span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span>       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span>       <span class="hljs-number">9.0</span>    <span class="hljs-number">10.0</span></span><br><span class="line">d   NaN     NaN      <span class="hljs-number">11.0</span>     <span class="hljs-number">12.0</span>       NaN     NaN</span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span>      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span>      <span class="hljs-number">11.0</span>    <span class="hljs-number">12.0</span></span><br><span class="line">f   NaN     NaN       NaN      NaN      <span class="hljs-number">16.0</span>    <span class="hljs-number">17.0</span></span><br></pre></td></tr></table></figure>

<h2 id="轴向连接"><a href="#轴向连接" class="headerlink" title="轴向连接"></a>轴向连接</h2><p>另一种数据合并运算也被称作连接（concatenation）、绑定（binding）或堆叠（stacking）。NumPy的concatenation函数可以用NumPy数组来做：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: arr = np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">3</span>, <span class="hljs-number">4</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">80</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],</span><br><span class="line">       [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],</span><br><span class="line">       [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">81</span>]: np.concatenate([arr, arr], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">81</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],</span><br><span class="line">       [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],</span><br><span class="line">       [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])</span><br></pre></td></tr></table></figure>

<p>对于pandas对象（如Series和DataFrame），带有标签的轴使你能够进一步推广数组的连接运算。具体点说，你还需要考虑以下这些东西：</p>
<ul>
<li>如果对象在其它轴上的索引不同，我们应该合并这些轴的不同元素还是只使用交集？</li>
<li>连接的数据集是否需要在结果对象中可识别？</li>
<li>连接轴中保存的数据是否需要保留？许多情况下，DataFrame默认的整数标签最好在连接时删掉。</li>
</ul>
<p>pandas的concat函数提供了一种能够解决这些问题的可靠方式。我将给出一些例子来讲解其使用方式。假设有三个没有重叠索引的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: s1 = pd.Series([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: s2 = pd.Series([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], index=[<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: s3 = pd.Series([<span class="hljs-number">5</span>, <span class="hljs-number">6</span>], index=[<span class="hljs-string">'f'</span>, <span class="hljs-string">'g'</span>])</span><br></pre></td></tr></table></figure>

<p>对这些对象调用concat可以将值和索引粘合在一起：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: pd.concat([s1, s2, s3])</span><br><span class="line">Out[<span class="hljs-number">85</span>]: </span><br><span class="line">a    <span class="hljs-number">0</span></span><br><span class="line">b    <span class="hljs-number">1</span></span><br><span class="line">c    <span class="hljs-number">2</span></span><br><span class="line">d    <span class="hljs-number">3</span></span><br><span class="line">e    <span class="hljs-number">4</span></span><br><span class="line">f    <span class="hljs-number">5</span></span><br><span class="line">g    <span class="hljs-number">6</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>默认情况下，concat是在axis=0上工作的，最终产生一个新的Series。如果传入axis=1，则结果就会变成一个DataFrame（axis=1是列）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: pd.concat([s1, s2, s3], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line">a  <span class="hljs-number">0.0</span>  NaN  NaN</span><br><span class="line">b  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line">c  NaN  <span class="hljs-number">2.0</span>  NaN</span><br><span class="line">d  NaN  <span class="hljs-number">3.0</span>  NaN</span><br><span class="line">e  NaN  <span class="hljs-number">4.0</span>  NaN</span><br><span class="line">f  NaN  NaN  <span class="hljs-number">5.0</span></span><br><span class="line">g  NaN  NaN  <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>这种情况下，另外的轴上没有重叠，从索引的有序并集（外连接）上就可以看出来。传入join=’inner’即可得到它们的交集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: s4 = pd.concat([s1, s3])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: s4</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">a    <span class="hljs-number">0</span></span><br><span class="line">b    <span class="hljs-number">1</span></span><br><span class="line">f    <span class="hljs-number">5</span></span><br><span class="line">g    <span class="hljs-number">6</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: pd.concat([s1, s4], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br><span class="line">a  <span class="hljs-number">0.0</span>  <span class="hljs-number">0</span></span><br><span class="line">b  <span class="hljs-number">1.0</span>  <span class="hljs-number">1</span></span><br><span class="line">f  NaN  <span class="hljs-number">5</span></span><br><span class="line">g  NaN  <span class="hljs-number">6</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: pd.concat([s1, s4], axis=<span class="hljs-number">1</span>, join=<span class="hljs-string">'inner'</span>)</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">   <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br><span class="line">a  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line">b  <span class="hljs-number">1</span>  <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，f和g标签消失了，是因为使用的是join=’inner’选项。</p>
<p>你可以通过join_axes指定要在其它轴上使用的索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: pd.concat([s1, s4], axis=<span class="hljs-number">1</span>, join_axes=[[<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'e'</span>]])</span><br><span class="line">Out[<span class="hljs-number">91</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span></span><br><span class="line">a  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.0</span></span><br><span class="line">c  NaN  NaN</span><br><span class="line">b  <span class="hljs-number">1.0</span>  <span class="hljs-number">1.0</span></span><br><span class="line">e  NaN  NaN</span><br></pre></td></tr></table></figure>

<p>不过有个问题，参与连接的片段在结果中区分不开。假设你想要在连接轴上创建一个层次化索引。使用keys参数即可达到这个目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">92</span>]: result = pd.concat([s1, s1, s3], keys=[<span class="hljs-string">'one'</span>,<span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: result</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line">one    a    <span class="hljs-number">0</span></span><br><span class="line">       b    <span class="hljs-number">1</span></span><br><span class="line">two    a    <span class="hljs-number">0</span></span><br><span class="line">       b    <span class="hljs-number">1</span></span><br><span class="line">three  f    <span class="hljs-number">5</span></span><br><span class="line">       g    <span class="hljs-number">6</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">94</span>]: result.unstack()</span><br><span class="line">Out[<span class="hljs-number">94</span>]: </span><br><span class="line">         a    b    f    g</span><br><span class="line">one    <span class="hljs-number">0.0</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line">two    <span class="hljs-number">0.0</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line">three  NaN  NaN  <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>如果沿着axis=1对Series进行合并，则keys就会成为DataFrame的列头：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">95</span>]: pd.concat([s1, s2, s3], axis=<span class="hljs-number">1</span>, keys=[<span class="hljs-string">'one'</span>,<span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>])</span><br><span class="line">Out[<span class="hljs-number">95</span>]: </span><br><span class="line">   one  two  three</span><br><span class="line">a  <span class="hljs-number">0.0</span>  NaN    NaN</span><br><span class="line">b  <span class="hljs-number">1.0</span>  NaN    NaN</span><br><span class="line">c  NaN  <span class="hljs-number">2.0</span>    NaN</span><br><span class="line">d  NaN  <span class="hljs-number">3.0</span>    NaN</span><br><span class="line">e  NaN  <span class="hljs-number">4.0</span>    NaN</span><br><span class="line">f  NaN  NaN    <span class="hljs-number">5.0</span></span><br><span class="line">g  NaN  NaN    <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>同样的逻辑也适用于DataFrame对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: df1 = pd.DataFrame(np.arange(<span class="hljs-number">6</span>).reshape(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>), index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">   ....:                    columns=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: df2 = pd.DataFrame(<span class="hljs-number">5</span> + np.arange(<span class="hljs-number">4</span>).reshape(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">   ....:                    columns=[<span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">   one  two</span><br><span class="line">a    <span class="hljs-number">0</span>    <span class="hljs-number">1</span></span><br><span class="line">b    <span class="hljs-number">2</span>    <span class="hljs-number">3</span></span><br><span class="line">c    <span class="hljs-number">4</span>    <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">99</span>]: </span><br><span class="line">   three  four</span><br><span class="line">a      <span class="hljs-number">5</span>     <span class="hljs-number">6</span></span><br><span class="line">c      <span class="hljs-number">7</span>     <span class="hljs-number">8</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: pd.concat([df1, df2], axis=<span class="hljs-number">1</span>, keys=[<span class="hljs-string">'level1'</span>, <span class="hljs-string">'level2'</span>])</span><br><span class="line">Out[<span class="hljs-number">100</span>]: </span><br><span class="line">  level1     level2     </span><br><span class="line">     one two  three four</span><br><span class="line">a      <span class="hljs-number">0</span>   <span class="hljs-number">1</span>    <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line">b      <span class="hljs-number">2</span>   <span class="hljs-number">3</span>    NaN  NaN</span><br><span class="line">c      <span class="hljs-number">4</span>   <span class="hljs-number">5</span>    <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span></span><br></pre></td></tr></table></figure>

<p>如果传入的不是列表而是一个字典，则字典的键就会被当做keys选项的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: pd.concat(&#123;<span class="hljs-string">'level1'</span>: df1, <span class="hljs-string">'level2'</span>: df2&#125;, axis=<span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">Out[<span class="hljs-number">101</span>]: </span><br><span class="line">  level1     level2     </span><br><span class="line">     one two  three four</span><br><span class="line">a      <span class="hljs-number">0</span>   <span class="hljs-number">1</span>    <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line">b      <span class="hljs-number">2</span>   <span class="hljs-number">3</span>    NaN  NaN</span><br><span class="line">c      <span class="hljs-number">4</span>   <span class="hljs-number">5</span>    <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span></span><br></pre></td></tr></table></figure>

<p>此外还有两个用于管理层次化索引创建方式的参数（参见表8-3）。举个例子，我们可以用names参数命名创建的轴级别：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">102</span>]: pd.concat([df1, df2], axis=<span class="hljs-number">1</span>, keys=[<span class="hljs-string">'level1'</span>, <span class="hljs-string">'level2'</span>],</span><br><span class="line">   .....:           names=[<span class="hljs-string">'upper'</span>, <span class="hljs-string">'lower'</span>])</span><br><span class="line">Out[<span class="hljs-number">102</span>]: </span><br><span class="line">upper level1     level2     </span><br><span class="line">lower    one two  three four</span><br><span class="line">a          <span class="hljs-number">0</span>   <span class="hljs-number">1</span>    <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line">b          <span class="hljs-number">2</span>   <span class="hljs-number">3</span>    NaN  NaN</span><br><span class="line">c          <span class="hljs-number">4</span>   <span class="hljs-number">5</span>    <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span></span><br></pre></td></tr></table></figure>

<p>最后一个关于DataFrame的问题是，DataFrame的行索引不包含任何相关数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">103</span>]: df1 = pd.DataFrame(np.random.randn(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), columns=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">104</span>]: df2 = pd.DataFrame(np.random.randn(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), columns=[<span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'a'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">105</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">105</span>]: </span><br><span class="line">          a         b         c         d</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">1.007189</span> <span class="hljs-number">-1.296221</span>  <span class="hljs-number">0.274992</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">106</span>]: </span><br><span class="line">          b         d         a</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.476985</span>  <span class="hljs-number">3.248944</span> <span class="hljs-number">-1.021228</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.577087</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span></span><br></pre></td></tr></table></figure>

<p>在这种情况下，传入ignore_index=True即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">107</span>]: pd.concat([df1, df2], ignore_index=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">107</span>]: </span><br><span class="line">          a         b         c         d</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">1.007189</span> <span class="hljs-number">-1.296221</span>  <span class="hljs-number">0.274992</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-1.021228</span>  <span class="hljs-number">0.476985</span>       NaN  <span class="hljs-number">3.248944</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.302614</span> <span class="hljs-number">-0.577087</span>       NaN  <span class="hljs-number">0.124121</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-339436563b519415.webp" alt="img"></p>
<p>表8-3 concat函数的参数</p>
<h2 id="合并重叠数据"><a href="#合并重叠数据" class="headerlink" title="合并重叠数据"></a>合并重叠数据</h2><p>还有一种数据组合问题不能用简单的合并（merge）或连接（concatenation）运算来处理。比如说，你可能有索引全部或部分重叠的两个数据集。举个有启发性的例子，我们使用NumPy的where函数，它表示一种等价于面向数组的if-else：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: a = pd.Series([np.nan, <span class="hljs-number">2.5</span>, np.nan, <span class="hljs-number">3.5</span>, <span class="hljs-number">4.5</span>, np.nan],</span><br><span class="line">   .....:               index=[<span class="hljs-string">'f'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">109</span>]: b = pd.Series(np.arange(len(a), dtype=np.float64),</span><br><span class="line">   .....:               index=[<span class="hljs-string">'f'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: b[<span class="hljs-number">-1</span>] = np.nan</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">111</span>]: a</span><br><span class="line">Out[<span class="hljs-number">111</span>]: </span><br><span class="line">f    NaN</span><br><span class="line">e    <span class="hljs-number">2.5</span></span><br><span class="line">d    NaN</span><br><span class="line">c    <span class="hljs-number">3.5</span></span><br><span class="line">b    <span class="hljs-number">4.5</span></span><br><span class="line">a    NaN</span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: b</span><br><span class="line">Out[<span class="hljs-number">112</span>]: </span><br><span class="line">f    <span class="hljs-number">0.0</span></span><br><span class="line">e    <span class="hljs-number">1.0</span></span><br><span class="line">d    <span class="hljs-number">2.0</span></span><br><span class="line">c    <span class="hljs-number">3.0</span></span><br><span class="line">b    <span class="hljs-number">4.0</span></span><br><span class="line">a    NaN</span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: np.where(pd.isnull(a), b, a)</span><br><span class="line">Out[<span class="hljs-number">113</span>]: array([ <span class="hljs-number">0.</span> ,  <span class="hljs-number">2.5</span>,  <span class="hljs-number">2.</span> ,  <span class="hljs-number">3.5</span>,  <span class="hljs-number">4.5</span>,  nan])</span><br></pre></td></tr></table></figure>

<p>Series有一个combine_first方法，实现的也是一样的功能，还带有pandas的数据对齐：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">114</span>]: b[:<span class="hljs-number">-2</span>].combine_first(a[<span class="hljs-number">2</span>:])</span><br><span class="line">Out[<span class="hljs-number">114</span>]: </span><br><span class="line">a    NaN</span><br><span class="line">b    <span class="hljs-number">4.5</span></span><br><span class="line">c    <span class="hljs-number">3.0</span></span><br><span class="line">d    <span class="hljs-number">2.0</span></span><br><span class="line">e    <span class="hljs-number">1.0</span></span><br><span class="line">f    <span class="hljs-number">0.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>对于DataFrame，combine_first自然也会在列上做同样的事情，因此你可以将其看做：用传递对象中的数据为调用对象的缺失数据“打补丁”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">115</span>]: df1 = pd.DataFrame(&#123;<span class="hljs-string">'a'</span>: [<span class="hljs-number">1.</span>, np.nan, <span class="hljs-number">5.</span>, np.nan],</span><br><span class="line">   .....:                     <span class="hljs-string">'b'</span>: [np.nan, <span class="hljs-number">2.</span>, np.nan, <span class="hljs-number">6.</span>],</span><br><span class="line">   .....:                     <span class="hljs-string">'c'</span>: range(<span class="hljs-number">2</span>, <span class="hljs-number">18</span>, <span class="hljs-number">4</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: df2 = pd.DataFrame(&#123;<span class="hljs-string">'a'</span>: [<span class="hljs-number">5.</span>, <span class="hljs-number">4.</span>, np.nan, <span class="hljs-number">3.</span>, <span class="hljs-number">7.</span>],</span><br><span class="line">   .....:                     <span class="hljs-string">'b'</span>: [np.nan, <span class="hljs-number">3.</span>, <span class="hljs-number">4.</span>, <span class="hljs-number">6.</span>, <span class="hljs-number">8.</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">117</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">117</span>]: </span><br><span class="line">     a    b   c</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  NaN   <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">1</span>  NaN  <span class="hljs-number">2.0</span>   <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">5.0</span>  NaN  <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.0</span>  <span class="hljs-number">14</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">118</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">118</span>]: </span><br><span class="line">     a    b</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">5.0</span>  NaN</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">4.0</span>  <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">2</span>  NaN  <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">3.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">119</span>]: df1.combine_first(df2)</span><br><span class="line">Out[<span class="hljs-number">119</span>]: </span><br><span class="line">     a    b     c</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  NaN   <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">4.0</span>  <span class="hljs-number">2.0</span>   <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">4.0</span>  <span class="hljs-number">10.0</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">3.0</span>  <span class="hljs-number">6.0</span>  <span class="hljs-number">14.0</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span>   NaN</span><br></pre></td></tr></table></figure>

<h1 id="8-3-重塑和轴向旋转"><a href="#8-3-重塑和轴向旋转" class="headerlink" title="8.3 重塑和轴向旋转"></a>8.3 重塑和轴向旋转</h1><p>有许多用于重新排列表格型数据的基础运算。这些函数也称作重塑（reshape）或轴向旋转（pivot）运算。</p>
<h2 id="重塑层次化索引"><a href="#重塑层次化索引" class="headerlink" title="重塑层次化索引"></a>重塑层次化索引</h2><p>层次化索引为DataFrame数据的重排任务提供了一种具有良好一致性的方式。主要功能有二：</p>
<ul>
<li>stack：将数据的列“旋转”为行。</li>
<li>unstack：将数据的行“旋转”为列。</li>
</ul>
<p>我将通过一系列的范例来讲解这些操作。接下来看一个简单的DataFrame，其中的行列索引均为字符串数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">120</span>]: data = pd.DataFrame(np.arange(<span class="hljs-number">6</span>).reshape((<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)),</span><br><span class="line">   .....:                     index=pd.Index([<span class="hljs-string">'Ohio'</span>,<span class="hljs-string">'Colorado'</span>], name=<span class="hljs-string">'state'</span>),</span><br><span class="line">   .....:                     columns=pd.Index([<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>],</span><br><span class="line">   .....:                     name=<span class="hljs-string">'number'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">121</span>]: data</span><br><span class="line">Out[<span class="hljs-number">121</span>]: </span><br><span class="line">number    one  two  three</span><br><span class="line">state                    </span><br><span class="line">Ohio        <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span></span><br><span class="line">Colorado    <span class="hljs-number">3</span>    <span class="hljs-number">4</span>      <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>对该数据使用stack方法即可将列转换为行，得到一个Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">122</span>]: result = data.stack()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">123</span>]: result</span><br><span class="line">Out[<span class="hljs-number">123</span>]: </span><br><span class="line">state     number</span><br><span class="line">Ohio      one       <span class="hljs-number">0</span></span><br><span class="line">          two       <span class="hljs-number">1</span></span><br><span class="line">          three     <span class="hljs-number">2</span></span><br><span class="line">Colorado  one       <span class="hljs-number">3</span></span><br><span class="line">          two       <span class="hljs-number">4</span></span><br><span class="line">          three     <span class="hljs-number">5</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>对于一个层次化索引的Series，你可以用unstack将其重排为一个DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">124</span>]: result.unstack()</span><br><span class="line">Out[<span class="hljs-number">124</span>]: </span><br><span class="line">number    one  two  three</span><br><span class="line">state                    </span><br><span class="line">Ohio        <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span></span><br><span class="line">Colorado    <span class="hljs-number">3</span>    <span class="hljs-number">4</span>      <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，unstack操作的是最内层（stack也是如此）。传入分层级别的编号或名称即可对其它级别进行unstack操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">125</span>]: result.unstack(<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">125</span>]: </span><br><span class="line">state   Ohio  Colorado</span><br><span class="line">number                </span><br><span class="line">one        <span class="hljs-number">0</span>         <span class="hljs-number">3</span></span><br><span class="line">two        <span class="hljs-number">1</span>         <span class="hljs-number">4</span></span><br><span class="line">three      <span class="hljs-number">2</span>         <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">126</span>]: result.unstack(<span class="hljs-string">'state'</span>)</span><br><span class="line">Out[<span class="hljs-number">126</span>]: </span><br><span class="line">state   Ohio  Colorado</span><br><span class="line">number                </span><br><span class="line">one        <span class="hljs-number">0</span>         <span class="hljs-number">3</span></span><br><span class="line">two        <span class="hljs-number">1</span>         <span class="hljs-number">4</span></span><br><span class="line">three      <span class="hljs-number">2</span>         <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>如果不是所有的级别值都能在各分组中找到的话，则unstack操作可能会引入缺失数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">127</span>]: s1 = pd.Series([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">128</span>]: s2 = pd.Series([<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>], index=[<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">129</span>]: data2 = pd.concat([s1, s2], keys=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">130</span>]: data2</span><br><span class="line">Out[<span class="hljs-number">130</span>]: </span><br><span class="line">one  a    <span class="hljs-number">0</span></span><br><span class="line">     b    <span class="hljs-number">1</span></span><br><span class="line">     c    <span class="hljs-number">2</span></span><br><span class="line">     d    <span class="hljs-number">3</span></span><br><span class="line">two  c    <span class="hljs-number">4</span></span><br><span class="line">     d    <span class="hljs-number">5</span></span><br><span class="line">     e    <span class="hljs-number">6</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">131</span>]: data2.unstack()</span><br><span class="line">Out[<span class="hljs-number">131</span>]: </span><br><span class="line">       a    b    c    d    e</span><br><span class="line">one  <span class="hljs-number">0.0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">2.0</span>  <span class="hljs-number">3.0</span>  NaN</span><br><span class="line">two  NaN  NaN  <span class="hljs-number">4.0</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>stack默认会滤除缺失数据，因此该运算是可逆的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">132</span>]: data2.unstack()</span><br><span class="line">Out[<span class="hljs-number">132</span>]: </span><br><span class="line">       a    b    c    d    e</span><br><span class="line">one  <span class="hljs-number">0.0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">2.0</span>  <span class="hljs-number">3.0</span>  NaN</span><br><span class="line">two  NaN  NaN  <span class="hljs-number">4.0</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">133</span>]: data2.unstack().stack()</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">one  a    <span class="hljs-number">0.0</span></span><br><span class="line">     b    <span class="hljs-number">1.0</span></span><br><span class="line">     c    <span class="hljs-number">2.0</span></span><br><span class="line">     d    <span class="hljs-number">3.0</span></span><br><span class="line">two  c    <span class="hljs-number">4.0</span></span><br><span class="line">     d    <span class="hljs-number">5.0</span></span><br><span class="line">     e    <span class="hljs-number">6.0</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: data2.unstack().stack(dropna=<span class="hljs-literal">False</span>)</span><br><span class="line">Out[<span class="hljs-number">134</span>]: </span><br><span class="line">one  a    <span class="hljs-number">0.0</span></span><br><span class="line">     b    <span class="hljs-number">1.0</span></span><br><span class="line">     c    <span class="hljs-number">2.0</span></span><br><span class="line">     d    <span class="hljs-number">3.0</span></span><br><span class="line">     e    NaN</span><br><span class="line">two  a    NaN</span><br><span class="line">     b    NaN</span><br><span class="line">     c    <span class="hljs-number">4.0</span></span><br><span class="line">     d    <span class="hljs-number">5.0</span></span><br><span class="line">     e    <span class="hljs-number">6.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>在对DataFrame进行unstack操作时，作为旋转轴的级别将会成为结果中的最低级别：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">135</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'left'</span>: result, <span class="hljs-string">'right'</span>: result + <span class="hljs-number">5</span>&#125;,</span><br><span class="line">   .....:                   columns=pd.Index([<span class="hljs-string">'left'</span>, <span class="hljs-string">'right'</span>], name=<span class="hljs-string">'side'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">136</span>]: df</span><br><span class="line">Out[<span class="hljs-number">136</span>]: </span><br><span class="line">side             left  right</span><br><span class="line">state    number             </span><br><span class="line">Ohio     one        <span class="hljs-number">0</span>      <span class="hljs-number">5</span></span><br><span class="line">         two        <span class="hljs-number">1</span>      <span class="hljs-number">6</span></span><br><span class="line">         three      <span class="hljs-number">2</span>      <span class="hljs-number">7</span></span><br><span class="line">Colorado one        <span class="hljs-number">3</span>      <span class="hljs-number">8</span></span><br><span class="line">         two        <span class="hljs-number">4</span>      <span class="hljs-number">9</span></span><br><span class="line">         three      <span class="hljs-number">5</span>     <span class="hljs-number">10</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: df.unstack(<span class="hljs-string">'state'</span>)</span><br><span class="line">Out[<span class="hljs-number">137</span>]: </span><br><span class="line">side   left          right</span><br><span class="line">state  Ohio Colorado  Ohio Colorado</span><br><span class="line">number                             </span><br><span class="line">one       <span class="hljs-number">0</span>        <span class="hljs-number">3</span>     <span class="hljs-number">5</span>        <span class="hljs-number">8</span></span><br><span class="line">two       <span class="hljs-number">1</span>        <span class="hljs-number">4</span>     <span class="hljs-number">6</span>        <span class="hljs-number">9</span></span><br><span class="line">three     <span class="hljs-number">2</span>        <span class="hljs-number">5</span>     <span class="hljs-number">7</span>       <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>当调用stack，我们可以指明轴的名字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">138</span>]: df.unstack(<span class="hljs-string">'state'</span>).stack(<span class="hljs-string">'side'</span>)</span><br><span class="line">Out[<span class="hljs-number">138</span>]: </span><br><span class="line">state         Colorado  Ohio</span><br><span class="line">number side                 </span><br><span class="line">one    left          <span class="hljs-number">3</span>     <span class="hljs-number">0</span></span><br><span class="line">       right         <span class="hljs-number">8</span>     <span class="hljs-number">5</span></span><br><span class="line">two    left          <span class="hljs-number">4</span>     <span class="hljs-number">1</span></span><br><span class="line">       right         <span class="hljs-number">9</span>     <span class="hljs-number">6</span></span><br><span class="line">three  left          <span class="hljs-number">5</span>     <span class="hljs-number">2</span></span><br><span class="line">       right        <span class="hljs-number">10</span>     <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<h2 id="将“长格式”旋转为“宽格式”"><a href="#将“长格式”旋转为“宽格式”" class="headerlink" title="将“长格式”旋转为“宽格式”"></a>将“长格式”旋转为“宽格式”</h2><p>多个时间序列数据通常是以所谓的“长格式”（long）或“堆叠格式”（stacked）存储在数据库和CSV中的。我们先加载一些示例数据，做一些时间序列规整和数据清洗：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">139</span>]: data = pd.read_csv(<span class="hljs-string">'examples/macrodata.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">140</span>]: data.head()</span><br><span class="line">Out[<span class="hljs-number">140</span>]: </span><br><span class="line">     year  quarter   realgdp  realcons  realinv  realgovt  realdpi    cpi  \</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">1.0</span>  <span class="hljs-number">2710.349</span>    <span class="hljs-number">1707.4</span>  <span class="hljs-number">286.898</span>   <span class="hljs-number">470.045</span>   <span class="hljs-number">1886.9</span>  <span class="hljs-number">28.98</span>   </span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">2.0</span>  <span class="hljs-number">2778.801</span>    <span class="hljs-number">1733.7</span>  <span class="hljs-number">310.859</span>   <span class="hljs-number">481.301</span>   <span class="hljs-number">1919.7</span>  <span class="hljs-number">29.15</span>   </span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">3.0</span>  <span class="hljs-number">2775.488</span>    <span class="hljs-number">1751.8</span>  <span class="hljs-number">289.226</span>   <span class="hljs-number">491.260</span>   <span class="hljs-number">1916.4</span>  <span class="hljs-number">29.35</span>   </span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">4.0</span>  <span class="hljs-number">2785.204</span>    <span class="hljs-number">1753.7</span>  <span class="hljs-number">299.356</span>   <span class="hljs-number">484.052</span>   <span class="hljs-number">1931.3</span>  <span class="hljs-number">29.37</span>   </span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1960.0</span>      <span class="hljs-number">1.0</span>  <span class="hljs-number">2847.699</span>    <span class="hljs-number">1770.5</span>  <span class="hljs-number">331.722</span>   <span class="hljs-number">462.199</span>   <span class="hljs-number">1955.5</span>  <span class="hljs-number">29.54</span>   </span><br><span class="line">      m1  tbilrate  unemp      pop  infl  realint  </span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">139.7</span>      <span class="hljs-number">2.82</span>    <span class="hljs-number">5.8</span>  <span class="hljs-number">177.146</span>  <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">141.7</span>      <span class="hljs-number">3.08</span>    <span class="hljs-number">5.1</span>  <span class="hljs-number">177.830</span>  <span class="hljs-number">2.34</span>     <span class="hljs-number">0.74</span>  </span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">140.5</span>      <span class="hljs-number">3.82</span>    <span class="hljs-number">5.3</span>  <span class="hljs-number">178.657</span>  <span class="hljs-number">2.74</span>     <span class="hljs-number">1.09</span>  </span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">140.0</span>      <span class="hljs-number">4.33</span>    <span class="hljs-number">5.6</span>  <span class="hljs-number">179.386</span>  <span class="hljs-number">0.27</span>     <span class="hljs-number">4.06</span>  </span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">139.6</span>      <span class="hljs-number">3.50</span>    <span class="hljs-number">5.2</span>  <span class="hljs-number">180.007</span>  <span class="hljs-number">2.31</span>     <span class="hljs-number">1.19</span>  </span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">141</span>]: periods = pd.PeriodIndex(year=data.year, quarter=data.quarter,</span><br><span class="line">   .....:                          name=<span class="hljs-string">'date'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">142</span>]: columns = pd.Index([<span class="hljs-string">'realgdp'</span>, <span class="hljs-string">'infl'</span>, <span class="hljs-string">'unemp'</span>], name=<span class="hljs-string">'item'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">143</span>]: data = data.reindex(columns=columns)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">144</span>]: data.index = periods.to_timestamp(<span class="hljs-string">'D'</span>, <span class="hljs-string">'end'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">145</span>]: ldata = data.stack().reset_index().rename(columns=&#123;<span class="hljs-number">0</span>: <span class="hljs-string">'value'</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>这就是多个时间序列（或者其它带有两个或多个键的可观察数据，这里，我们的键是date和item）的长格式。表中的每行代表一次观察。</p>
<p>关系型数据库（如MySQL）中的数据经常都是这样存储的，因为固定架构（即列名和数据类型）有一个好处：随着表中数据的添加，item列中的值的种类能够增加。在前面的例子中，date和item通常就是主键（用关系型数据库的说法），不仅提供了关系完整性，而且提供了更为简单的查询支持。有的情况下，使用这样的数据会很麻烦，你可能会更喜欢DataFrame，不同的item值分别形成一列，date列中的时间戳则用作索引。DataFrame的pivot方法完全可以实现这个转换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">147</span>]: pivoted = ldata.pivot(<span class="hljs-string">'date'</span>, <span class="hljs-string">'item'</span>, <span class="hljs-string">'value'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">148</span>]: pivoted</span><br><span class="line">Out[<span class="hljs-number">148</span>]: </span><br><span class="line">item        infl    realgdp  unemp</span><br><span class="line">date                              </span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.00</span>   <span class="hljs-number">2710.349</span>    <span class="hljs-number">5.8</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.34</span>   <span class="hljs-number">2778.801</span>    <span class="hljs-number">5.1</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.74</span>   <span class="hljs-number">2775.488</span>    <span class="hljs-number">5.3</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.27</span>   <span class="hljs-number">2785.204</span>    <span class="hljs-number">5.6</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.31</span>   <span class="hljs-number">2847.699</span>    <span class="hljs-number">5.2</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">0.14</span>   <span class="hljs-number">2834.390</span>    <span class="hljs-number">5.2</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.70</span>   <span class="hljs-number">2839.022</span>    <span class="hljs-number">5.6</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">1.21</span>   <span class="hljs-number">2802.616</span>    <span class="hljs-number">6.3</span></span><br><span class="line"><span class="hljs-number">1961</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span> <span class="hljs-number">-0.40</span>   <span class="hljs-number">2819.264</span>    <span class="hljs-number">6.8</span></span><br><span class="line"><span class="hljs-number">1961</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">1.47</span>   <span class="hljs-number">2872.005</span>    <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-meta">... </span>         ...        ...    ...</span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.75</span>  <span class="hljs-number">13203.977</span>    <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">3.45</span>  <span class="hljs-number">13321.109</span>    <span class="hljs-number">4.7</span></span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">6.38</span>  <span class="hljs-number">13391.249</span>    <span class="hljs-number">4.8</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.82</span>  <span class="hljs-number">13366.865</span>    <span class="hljs-number">4.9</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">8.53</span>  <span class="hljs-number">13415.266</span>    <span class="hljs-number">5.4</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span> <span class="hljs-number">-3.16</span>  <span class="hljs-number">13324.600</span>    <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">-8.79</span>  <span class="hljs-number">13141.920</span>    <span class="hljs-number">6.9</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.94</span>  <span class="hljs-number">12925.410</span>    <span class="hljs-number">8.1</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">3.37</span>  <span class="hljs-number">12901.504</span>    <span class="hljs-number">9.2</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">3.56</span>  <span class="hljs-number">12990.341</span>    <span class="hljs-number">9.6</span></span><br><span class="line">[<span class="hljs-number">203</span> rows x <span class="hljs-number">3</span> columns]</span><br></pre></td></tr></table></figure>

<p>前两个传递的值分别用作行和列索引，最后一个可选值则是用于填充DataFrame的数据列。假设有两个需要同时重塑的数据列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">149</span>]: ldata[<span class="hljs-string">'value2'</span>] = np.random.randn(len(ldata))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">150</span>]: ldata[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">150</span>]: </span><br><span class="line">        date     item     value    value2</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  realgdp  <span class="hljs-number">2710.349</span>  <span class="hljs-number">0.523772</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>     infl     <span class="hljs-number">0.000</span>  <span class="hljs-number">0.000940</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    unemp     <span class="hljs-number">5.800</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  realgdp  <span class="hljs-number">2778.801</span> <span class="hljs-number">-0.713544</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>     infl     <span class="hljs-number">2.340</span> <span class="hljs-number">-0.831154</span></span><br><span class="line"><span class="hljs-number">5</span> <span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>    unemp     <span class="hljs-number">5.100</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">6</span> <span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  realgdp  <span class="hljs-number">2775.488</span> <span class="hljs-number">-1.860761</span></span><br><span class="line"><span class="hljs-number">7</span> <span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>     infl     <span class="hljs-number">2.740</span> <span class="hljs-number">-0.860757</span></span><br><span class="line"><span class="hljs-number">8</span> <span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>    unemp     <span class="hljs-number">5.300</span>  <span class="hljs-number">0.560145</span></span><br><span class="line"><span class="hljs-number">9</span> <span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  realgdp  <span class="hljs-number">2785.204</span> <span class="hljs-number">-1.265934</span></span><br></pre></td></tr></table></figure>

<p>如果忽略最后一个参数，得到的DataFrame就会带有层次化的列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">151</span>]: pivoted = ldata.pivot(<span class="hljs-string">'date'</span>, <span class="hljs-string">'item'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">152</span>]: pivoted[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">152</span>]: </span><br><span class="line">           value                    value2                    </span><br><span class="line">item        infl   realgdp unemp      infl   realgdp     unemp</span><br><span class="line">date                                                          </span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.00</span>  <span class="hljs-number">2710.349</span>   <span class="hljs-number">5.8</span>  <span class="hljs-number">0.000940</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.34</span>  <span class="hljs-number">2778.801</span>   <span class="hljs-number">5.1</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-0.713544</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.74</span>  <span class="hljs-number">2775.488</span>   <span class="hljs-number">5.3</span> <span class="hljs-number">-0.860757</span> <span class="hljs-number">-1.860761</span>  <span class="hljs-number">0.560145</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.27</span>  <span class="hljs-number">2785.204</span>   <span class="hljs-number">5.6</span>  <span class="hljs-number">0.119827</span> <span class="hljs-number">-1.265934</span> <span class="hljs-number">-1.063512</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.31</span>  <span class="hljs-number">2847.699</span>   <span class="hljs-number">5.2</span> <span class="hljs-number">-2.359419</span>  <span class="hljs-number">0.332883</span> <span class="hljs-number">-0.199543</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">153</span>]: pivoted[<span class="hljs-string">'value'</span>][:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">153</span>]: </span><br><span class="line">item        infl   realgdp  unemp</span><br><span class="line">date                             </span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.00</span>  <span class="hljs-number">2710.349</span>    <span class="hljs-number">5.8</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.34</span>  <span class="hljs-number">2778.801</span>    <span class="hljs-number">5.1</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.74</span>  <span class="hljs-number">2775.488</span>    <span class="hljs-number">5.3</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.27</span>  <span class="hljs-number">2785.204</span>    <span class="hljs-number">5.6</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.31</span>  <span class="hljs-number">2847.699</span>    <span class="hljs-number">5.2</span></span><br></pre></td></tr></table></figure>

<p>注意，pivot其实就是用set_index创建层次化索引，再用unstack重塑：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">154</span>]: unstacked = ldata.set_index([<span class="hljs-string">'date'</span>, <span class="hljs-string">'item'</span>]).unstack(<span class="hljs-string">'item'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">155</span>]: unstacked[:<span class="hljs-number">7</span>]</span><br><span class="line">Out[<span class="hljs-number">155</span>]: </span><br><span class="line">           value                    value2                    </span><br><span class="line">item        infl   realgdp unemp      infl   realgdp     unemp</span><br><span class="line">date                                                          </span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.00</span>  <span class="hljs-number">2710.349</span>   <span class="hljs-number">5.8</span>  <span class="hljs-number">0.000940</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.34</span>  <span class="hljs-number">2778.801</span>   <span class="hljs-number">5.1</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-0.713544</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.74</span>  <span class="hljs-number">2775.488</span>   <span class="hljs-number">5.3</span> <span class="hljs-number">-0.860757</span> <span class="hljs-number">-1.860761</span>  <span class="hljs-number">0.560145</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.27</span>  <span class="hljs-number">2785.204</span>   <span class="hljs-number">5.6</span>  <span class="hljs-number">0.119827</span> <span class="hljs-number">-1.265934</span> <span class="hljs-number">-1.063512</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.31</span>  <span class="hljs-number">2847.699</span>   <span class="hljs-number">5.2</span> <span class="hljs-number">-2.359419</span>  <span class="hljs-number">0.332883</span> <span class="hljs-number">-0.199543</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">0.14</span>  <span class="hljs-number">2834.390</span>   <span class="hljs-number">5.2</span> <span class="hljs-number">-0.970736</span> <span class="hljs-number">-1.541996</span> <span class="hljs-number">-1.307030</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.70</span>  <span class="hljs-number">2839.022</span>   <span class="hljs-number">5.6</span>  <span class="hljs-number">0.377984</span>  <span class="hljs-number">0.286350</span> <span class="hljs-number">-0.753887</span></span><br></pre></td></tr></table></figure>

<h2 id="将“宽格式”旋转为“长格式”"><a href="#将“宽格式”旋转为“长格式”" class="headerlink" title="将“宽格式”旋转为“长格式”"></a>将“宽格式”旋转为“长格式”</h2><p>旋转DataFrame的逆运算是pandas.melt。它不是将一列转换到多个新的DataFrame，而是合并多个列成为一个，产生一个比输入长的DataFrame。看一个例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">157</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'A'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'B'</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'C'</span>: [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: df</span><br><span class="line">Out[<span class="hljs-number">158</span>]: </span><br><span class="line">   A  B  C  key</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">7</span>  foo</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">8</span>  bar</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">9</span>  baz</span><br></pre></td></tr></table></figure>

<p>key列可能是分组指标，其它的列是数据值。当使用pandas.melt，我们必须指明哪些列是分组指标。下面使用key作为唯一的分组指标：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">159</span>]: melted = pd.melt(df, [<span class="hljs-string">'key'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">160</span>]: melted</span><br><span class="line">Out[<span class="hljs-number">160</span>]: </span><br><span class="line">   key variable  value</span><br><span class="line"><span class="hljs-number">0</span>  foo        A      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>  bar        A      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>  baz        A      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>  foo        B      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">4</span>  bar        B      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">5</span>  baz        B      <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">6</span>  foo        C      <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">7</span>  bar        C      <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">8</span>  baz        C      <span class="hljs-number">9</span></span><br></pre></td></tr></table></figure>

<p>使用pivot，可以重塑回原来的样子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">161</span>]: reshaped = melted.pivot(<span class="hljs-string">'key'</span>, <span class="hljs-string">'variable'</span>, <span class="hljs-string">'value'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: reshaped</span><br><span class="line">Out[<span class="hljs-number">162</span>]: </span><br><span class="line">variable  A  B  C</span><br><span class="line">key              </span><br><span class="line">bar       <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">8</span></span><br><span class="line">baz       <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">9</span></span><br><span class="line">foo       <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<p>因为pivot的结果从列创建了一个索引，用作行标签，我们可以使用reset_index将数据移回列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">163</span>]: reshaped.reset_index()</span><br><span class="line">Out[<span class="hljs-number">163</span>]: </span><br><span class="line">variable  key  A  B  C</span><br><span class="line"><span class="hljs-number">0</span>         bar  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">1</span>         baz  <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">2</span>         foo  <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<p>你还可以指定列的子集，作为值的列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">164</span>]: pd.melt(df, id_vars=[<span class="hljs-string">'key'</span>], value_vars=[<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>])</span><br><span class="line">Out[<span class="hljs-number">164</span>]: </span><br><span class="line">   key variable  value</span><br><span class="line"><span class="hljs-number">0</span>  foo        A      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>  bar        A      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>  baz        A      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>  foo        B      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">4</span>  bar        B      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">5</span>  baz        B      <span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<p>pandas.melt也可以不用分组指标：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">165</span>]: pd.melt(df, value_vars=[<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>])</span><br><span class="line">Out[<span class="hljs-number">165</span>]: </span><br><span class="line">  variable  value</span><br><span class="line"><span class="hljs-number">0</span>        A      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>        A      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>        A      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>        B      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">4</span>        B      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">5</span>        B      <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">6</span>        C      <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">7</span>        C      <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">8</span>        C      <span class="hljs-number">9</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">166</span>]: pd.melt(df, value_vars=[<span class="hljs-string">'key'</span>, <span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>])</span><br><span class="line">Out[<span class="hljs-number">166</span>]: </span><br><span class="line">  variable value</span><br><span class="line"><span class="hljs-number">0</span>      key   foo</span><br><span class="line"><span class="hljs-number">1</span>      key   bar</span><br><span class="line"><span class="hljs-number">2</span>      key   baz</span><br><span class="line"><span class="hljs-number">3</span>        A     <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">4</span>        A     <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">5</span>        A     <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">6</span>        B     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">7</span>        B     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">8</span>        B     <span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<h1 id="8-4-总结"><a href="#8-4-总结" class="headerlink" title="8.4 总结"></a>8.4 总结</h1><p>现在你已经掌握了pandas数据导入、清洗、重塑，我们可以进一步学习matplotlib数据可视化。我们在稍后会回到pandas，学习更高级的分析。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 11225 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC14%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%A1%88%E4%BE%8B/">《利用Python进行数据分析·第2版》第14章 数据分析案例</a>
            
        </h1>
        <div class="content">
            <h1 id="《利用Python进行数据分析·第2版》第14章-数据分析案例"><a href="#《利用Python进行数据分析·第2版》第14章-数据分析案例" class="headerlink" title="《利用Python进行数据分析·第2版》第14章 数据分析案例"></a>《利用Python进行数据分析·第2版》第14章 数据分析案例</h1><hr>
<p>转载自<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
第14章 数据分析案例
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>本书正文的最后一章，我们来看一些真实世界的数据集。对于每个数据集，我们会用之前介绍的方法，从原始数据中提取有意义的内容。展示的方法适用于其它数据集，也包括你的。本章包含了一些各种各样的案例数据集，可以用来练习。</p>
<p>案例数据集可以在Github仓库找到，见第一章。</p>
<h1 id="14-1-来自Bitly的USA-gov数据"><a href="#14-1-来自Bitly的USA-gov数据" class="headerlink" title="14.1 来自Bitly的USA.gov数据"></a>14.1 来自Bitly的USA.gov数据</h1><p>2011年，URL缩短服务Bitly跟美国政府网站USA.gov合作，提供了一份从生成.gov或.mil短链接的用户那里收集来的匿名数据。在2011年，除实时数据之外，还可以下载文本文件形式的每小时快照。写作此书时（2017年），这项服务已经关闭，但我们保存一份数据用于本书的案例。</p>
<p>以每小时快照为例，文件中各行的格式为JSON（即JavaScript Object Notation，这是一种常用的Web数据格式）。例如，如果我们只读取某个文件中的第一行，那么所看到的结果应该是下面这样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">5</span>]: path = <span class="hljs-string">'datasets/bitly_usagov/example.txt'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">6</span>]: open(path).readline()</span><br><span class="line">Out[<span class="hljs-number">6</span>]: <span class="hljs-string">'&#123; "a": "Mozilla\\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\\/535.11</span></span><br><span class="line"><span class="hljs-string">(KHTML, like Gecko) Chrome\\/17.0.963.78 Safari\\/535.11", "c": "US", "nk": 1,</span></span><br><span class="line"><span class="hljs-string">"tz": "America\\/New_York", "gr": "MA", "g": "A6qOVH", "h": "wfLQtf", "l":</span></span><br><span class="line"><span class="hljs-string">"orofrog", "al": "en-US,en;q=0.8", "hh": "1.usa.gov", "r":</span></span><br><span class="line"><span class="hljs-string">"http:\\/\\/www.facebook.com\\/l\\/7AQEFzjSi\\/1.usa.gov\\/wfLQtf", "u":</span></span><br><span class="line"><span class="hljs-string">"http:\\/\\/www.ncbi.nlm.nih.gov\\/pubmed\\/22415991", "t": 1331923247, "hc":</span></span><br><span class="line"><span class="hljs-string">1331822918, "cy": "Danvers", "ll": [ 42.576698, -70.954903 ] &#125;\n'</span></span><br></pre></td></tr></table></figure>

<p>Python有内置或第三方模块可以将JSON字符串转换成Python字典对象。这里，我将使用json模块及其loads函数逐行加载已经下载好的数据文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> json</span><br><span class="line">path = <span class="hljs-string">'datasets/bitly_usagov/example.txt'</span></span><br><span class="line">records = [json.loads(line) <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> open(path)]</span><br></pre></td></tr></table></figure>

<p>现在，records对象就成为一组Python字典了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: records[<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">18</span>]:</span><br><span class="line">&#123;<span class="hljs-string">'a'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko)</span></span><br><span class="line"><span class="hljs-string">Chrome/17.0.963.78 Safari/535.11'</span>,</span><br><span class="line"> <span class="hljs-string">'al'</span>: <span class="hljs-string">'en-US,en;q=0.8'</span>,</span><br><span class="line"> <span class="hljs-string">'c'</span>: <span class="hljs-string">'US'</span>,</span><br><span class="line"> <span class="hljs-string">'cy'</span>: <span class="hljs-string">'Danvers'</span>,</span><br><span class="line"> <span class="hljs-string">'g'</span>: <span class="hljs-string">'A6qOVH'</span>,</span><br><span class="line"> <span class="hljs-string">'gr'</span>: <span class="hljs-string">'MA'</span>,</span><br><span class="line"> <span class="hljs-string">'h'</span>: <span class="hljs-string">'wfLQtf'</span>,</span><br><span class="line"> <span class="hljs-string">'hc'</span>: <span class="hljs-number">1331822918</span>,</span><br><span class="line"> <span class="hljs-string">'hh'</span>: <span class="hljs-string">'1.usa.gov'</span>,</span><br><span class="line"> <span class="hljs-string">'l'</span>: <span class="hljs-string">'orofrog'</span>,</span><br><span class="line"> <span class="hljs-string">'ll'</span>: [<span class="hljs-number">42.576698</span>, <span class="hljs-number">-70.954903</span>],</span><br><span class="line"> <span class="hljs-string">'nk'</span>: <span class="hljs-number">1</span>,</span><br><span class="line"> <span class="hljs-string">'r'</span>: <span class="hljs-string">'http://www.facebook.com/l/7AQEFzjSi/1.usa.gov/wfLQtf'</span>,</span><br><span class="line"> <span class="hljs-string">'t'</span>: <span class="hljs-number">1331923247</span>,</span><br><span class="line"> <span class="hljs-string">'tz'</span>: <span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'u'</span>: <span class="hljs-string">'http://www.ncbi.nlm.nih.gov/pubmed/22415991'</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="用纯Python代码对时区进行计数"><a href="#用纯Python代码对时区进行计数" class="headerlink" title="用纯Python代码对时区进行计数"></a>用纯Python代码对时区进行计数</h2><p>假设我们想要知道该数据集中最常出现的是哪个时区（即tz字段），得到答案的办法有很多。首先，我们用列表推导式取出一组时区：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: time_zones = [rec[<span class="hljs-string">'tz'</span>] <span class="hljs-keyword">for</span> rec <span class="hljs-keyword">in</span> records]</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">KeyError                                  Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input<span class="hljs-number">-12</span>-db4fbd348da9&gt; <span class="hljs-keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 time_zones = [rec['tz'] for rec in records]</span><br><span class="line">&lt;ipython-input<span class="hljs-number">-12</span>-db4fbd348da9&gt; <span class="hljs-keyword">in</span> &lt;listcomp&gt;(<span class="hljs-number">.0</span>)</span><br><span class="line">----&gt; 1 time_zones = [rec['tz'] for rec in records]</span><br><span class="line">KeyError: <span class="hljs-string">'tz'</span></span><br></pre></td></tr></table></figure>

<p>晕！原来并不是所有记录都有时区字段。这个好办，只需在列表推导式末尾加上一个if ‘tz’in rec判断即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">13</span>]: time_zones = [rec[<span class="hljs-string">'tz'</span>] <span class="hljs-keyword">for</span> rec <span class="hljs-keyword">in</span> records <span class="hljs-keyword">if</span> <span class="hljs-string">'tz'</span> <span class="hljs-keyword">in</span> rec]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: time_zones[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">[<span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'America/Denver'</span>,</span><br><span class="line"> <span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'America/Sao_Paulo'</span>,</span><br><span class="line"> <span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'Europe/Warsaw'</span>,</span><br><span class="line"> <span class="hljs-string">''</span>,</span><br><span class="line"> <span class="hljs-string">''</span>,</span><br><span class="line"> <span class="hljs-string">''</span>]</span><br></pre></td></tr></table></figure>

<p>只看前10个时区，我们发现有些是未知的（即空的）。虽然可以将它们过滤掉，但现在暂时先留着。接下来，为了对时区进行计数，这里介绍两个办法：一个较难（只使用标准Python库），另一个较简单（使用pandas）。计数的办法之一是在遍历时区的过程中将计数值保存在字典中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_counts</span><span class="hljs-params">(sequence)</span>:</span></span><br><span class="line">    counts = &#123;&#125;</span><br><span class="line">    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> sequence:</span><br><span class="line">        <span class="hljs-keyword">if</span> x <span class="hljs-keyword">in</span> counts:</span><br><span class="line">            counts[x] += <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-keyword">else</span>:</span><br><span class="line">            counts[x] = <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-keyword">return</span> counts</span><br></pre></td></tr></table></figure>

<p>如果使用Python标准库的更高级工具，那么你可能会将代码写得更简洁一些：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_counts2</span><span class="hljs-params">(sequence)</span>:</span></span><br><span class="line">    counts = defaultdict(int) <span class="hljs-comment"># values will initialize to 0</span></span><br><span class="line">    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> sequence:</span><br><span class="line">        counts[x] += <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-keyword">return</span> counts</span><br></pre></td></tr></table></figure>

<p>我将逻辑写到函数中是为了获得更高的复用性。要用它对时区进行处理，只需将time_zones传入即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: counts = get_counts(time_zones)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">18</span>]: counts[<span class="hljs-string">'America/New_York'</span>]</span><br><span class="line">Out[<span class="hljs-number">18</span>]: <span class="hljs-number">1251</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: len(time_zones)</span><br><span class="line">Out[<span class="hljs-number">19</span>]: <span class="hljs-number">3440</span></span><br></pre></td></tr></table></figure>

<p>如果想要得到前10位的时区及其计数值，我们需要用到一些有关字典的处理技巧：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">top_counts</span><span class="hljs-params">(count_dict, n=<span class="hljs-number">10</span>)</span>:</span></span><br><span class="line">    value_key_pairs = [(count, tz) <span class="hljs-keyword">for</span> tz, count <span class="hljs-keyword">in</span> count_dict.items()]</span><br><span class="line">    value_key_pairs.sort()</span><br><span class="line">    <span class="hljs-keyword">return</span> value_key_pairs[-n:]</span><br></pre></td></tr></table></figure>

<p>然后有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">21</span>]: top_counts(counts)</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">[(<span class="hljs-number">33</span>, <span class="hljs-string">'America/Sao_Paulo'</span>),</span><br><span class="line"> (<span class="hljs-number">35</span>, <span class="hljs-string">'Europe/Madrid'</span>),</span><br><span class="line">(<span class="hljs-number">36</span>, <span class="hljs-string">'Pacific/Honolulu'</span>),</span><br><span class="line"> (<span class="hljs-number">37</span>, <span class="hljs-string">'Asia/Tokyo'</span>),</span><br><span class="line"> (<span class="hljs-number">74</span>, <span class="hljs-string">'Europe/London'</span>),</span><br><span class="line"> (<span class="hljs-number">191</span>, <span class="hljs-string">'America/Denver'</span>),</span><br><span class="line"> (<span class="hljs-number">382</span>, <span class="hljs-string">'America/Los_Angeles'</span>),</span><br><span class="line"> (<span class="hljs-number">400</span>, <span class="hljs-string">'America/Chicago'</span>),</span><br><span class="line"> (<span class="hljs-number">521</span>, <span class="hljs-string">''</span>),</span><br><span class="line"> (<span class="hljs-number">1251</span>, <span class="hljs-string">'America/New_York'</span>)]</span><br></pre></td></tr></table></figure>

<p>如果你搜索Python的标准库，你能找到collections.Counter类，它可以使这项工作更简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">22</span>]: <span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: counts = Counter(time_zones)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">24</span>]: counts.most_common(<span class="hljs-number">10</span>)</span><br><span class="line">Out[<span class="hljs-number">24</span>]: </span><br><span class="line">[(<span class="hljs-string">'America/New_York'</span>, <span class="hljs-number">1251</span>),</span><br><span class="line"> (<span class="hljs-string">''</span>, <span class="hljs-number">521</span>),</span><br><span class="line"> (<span class="hljs-string">'America/Chicago'</span>, <span class="hljs-number">400</span>),</span><br><span class="line"> (<span class="hljs-string">'America/Los_Angeles'</span>, <span class="hljs-number">382</span>),</span><br><span class="line"> (<span class="hljs-string">'America/Denver'</span>, <span class="hljs-number">191</span>),</span><br><span class="line"> (<span class="hljs-string">'Europe/London'</span>, <span class="hljs-number">74</span>),</span><br><span class="line"> (<span class="hljs-string">'Asia/Tokyo'</span>, <span class="hljs-number">37</span>),</span><br><span class="line"> (<span class="hljs-string">'Pacific/Honolulu'</span>, <span class="hljs-number">36</span>),</span><br><span class="line"> (<span class="hljs-string">'Europe/Madrid'</span>, <span class="hljs-number">35</span>),</span><br><span class="line"> (<span class="hljs-string">'America/Sao_Paulo'</span>, <span class="hljs-number">33</span>)]</span><br></pre></td></tr></table></figure>

<h2 id="用pandas对时区进行计数"><a href="#用pandas对时区进行计数" class="headerlink" title="用pandas对时区进行计数"></a>用pandas对时区进行计数</h2><p>从原始记录的集合创建DateFrame，与将记录列表传递到pandas.DataFrame一样简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">26</span>]: frame = pd.DataFrame(records)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: frame.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">RangeIndex</span>:</span> <span class="hljs-number">3560</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">3559</span></span><br><span class="line">Data columns (total <span class="hljs-number">18</span> columns):</span><br><span class="line">_heartbeat_    <span class="hljs-number">120</span> non-null float64</span><br><span class="line">a              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">al             <span class="hljs-number">3094</span> non-null object</span><br><span class="line">c              <span class="hljs-number">2919</span> non-null object</span><br><span class="line">cy             <span class="hljs-number">2919</span> non-null object</span><br><span class="line">g              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">gr             <span class="hljs-number">2919</span> non-null object</span><br><span class="line">h              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">hc             <span class="hljs-number">3440</span> non-null float64</span><br><span class="line">hh             <span class="hljs-number">3440</span> non-null object</span><br><span class="line">kw             <span class="hljs-number">93</span> non-null object</span><br><span class="line">l              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">ll             <span class="hljs-number">2919</span> non-null object</span><br><span class="line">nk             <span class="hljs-number">3440</span> non-null float64</span><br><span class="line">r              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">t              <span class="hljs-number">3440</span> non-null float64</span><br><span class="line">tz             <span class="hljs-number">3440</span> non-null object</span><br><span class="line">u              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">dtypes: float64(<span class="hljs-number">4</span>), object(<span class="hljs-number">14</span>)</span><br><span class="line">memory usage: <span class="hljs-number">500.7</span>+ KB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: frame[<span class="hljs-string">'tz'</span>][:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     America/New_York</span><br><span class="line"><span class="hljs-number">1</span>       America/Denver</span><br><span class="line"><span class="hljs-number">2</span>     America/New_York</span><br><span class="line"><span class="hljs-number">3</span>    America/Sao_Paulo</span><br><span class="line"><span class="hljs-number">4</span>     America/New_York</span><br><span class="line"><span class="hljs-number">5</span>     America/New_York</span><br><span class="line"><span class="hljs-number">6</span>        Europe/Warsaw</span><br><span class="line"><span class="hljs-number">7</span>                     </span><br><span class="line"><span class="hljs-number">8</span>                     </span><br><span class="line"><span class="hljs-number">9</span>                     </span><br><span class="line">Name: tz, dtype: object</span><br></pre></td></tr></table></figure>

<p>这里frame的输出形式是摘要视图（summary view），主要用于较大的DataFrame对象。我们然后可以对Series使用value_counts方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: tz_counts = frame[<span class="hljs-string">'tz'</span>].value_counts()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: tz_counts[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">America/New_York       <span class="hljs-number">1251</span></span><br><span class="line">                        <span class="hljs-number">521</span></span><br><span class="line">America/Chicago         <span class="hljs-number">400</span></span><br><span class="line">America/Los_Angeles     <span class="hljs-number">382</span></span><br><span class="line">America/Denver          <span class="hljs-number">191</span></span><br><span class="line">Europe/London            <span class="hljs-number">74</span></span><br><span class="line">Asia/Tokyo               <span class="hljs-number">37</span></span><br><span class="line">Pacific/Honolulu         <span class="hljs-number">36</span></span><br><span class="line">Europe/Madrid            <span class="hljs-number">35</span></span><br><span class="line">America/Sao_Paulo        <span class="hljs-number">33</span></span><br><span class="line">Name: tz, dtype: int64</span><br></pre></td></tr></table></figure>

<p>我们可以用matplotlib可视化这个数据。为此，我们先给记录中未知或缺失的时区填上一个替代值。fillna函数可以替换缺失值（NA），而未知值（空字符串）则可以通过布尔型数组索引加以替换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: clean_tz = frame[<span class="hljs-string">'tz'</span>].fillna(<span class="hljs-string">'Missing'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: clean_tz[clean_tz == <span class="hljs-string">''</span>] = <span class="hljs-string">'Unknown'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">33</span>]: tz_counts = clean_tz.value_counts()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: tz_counts[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">34</span>]: </span><br><span class="line">America/New_York       <span class="hljs-number">1251</span></span><br><span class="line">Unknown                 <span class="hljs-number">521</span></span><br><span class="line">America/Chicago         <span class="hljs-number">400</span></span><br><span class="line">America/Los_Angeles     <span class="hljs-number">382</span></span><br><span class="line">America/Denver          <span class="hljs-number">191</span></span><br><span class="line">Missing                 <span class="hljs-number">120</span></span><br><span class="line">Europe/London            <span class="hljs-number">74</span></span><br><span class="line">Asia/Tokyo               <span class="hljs-number">37</span></span><br><span class="line">Pacific/Honolulu         <span class="hljs-number">36</span></span><br><span class="line">Europe/Madrid            <span class="hljs-number">35</span></span><br><span class="line">Name: tz, dtype: int64</span><br></pre></td></tr></table></figure>

<p>此时，我们可以用seaborn包创建水平柱状图（结果见图14-1）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">36</span>]: <span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: subset = tz_counts[:<span class="hljs-number">10</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: sns.barplot(y=subset.index, x=subset.values)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-aa267c1d399a78f0.webp" alt="img"></p>
<p>图14-1 usa.gov示例数据中最常出现的时区</p>
<p>a字段含有执行URL短缩操作的浏览器、设备、应用程序的相关信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: frame[<span class="hljs-string">'a'</span>][<span class="hljs-number">1</span>]</span><br><span class="line">Out[<span class="hljs-number">39</span>]: <span class="hljs-string">'GoogleMaps/RochesterNY'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: frame[<span class="hljs-string">'a'</span>][<span class="hljs-number">50</span>]</span><br><span class="line">Out[<span class="hljs-number">40</span>]: <span class="hljs-string">'Mozilla/5.0 (Windows NT 5.1; rv:10.0.2)</span></span><br><span class="line"><span class="hljs-string">Gecko/20100101 Firefox/10.0.2'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: frame[<span class="hljs-string">'a'</span>][<span class="hljs-number">51</span>][:<span class="hljs-number">50</span>]  <span class="hljs-comment"># long line</span></span><br><span class="line">Out[<span class="hljs-number">41</span>]: <span class="hljs-string">'Mozilla/5.0 (Linux; U; Android 2.2.2; en-us; LG-P9'</span></span><br></pre></td></tr></table></figure>

<p>将这些”agent”字符串中的所有信息都解析出来是一件挺郁闷的工作。一种策略是将这种字符串的第一节（与浏览器大致对应）分离出来并得到另外一份用户行为摘要：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">42</span>]: results = pd.Series([x.split()[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> frame.a.dropna()])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: results[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line"><span class="hljs-number">0</span>               Mozilla/<span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">1</span>    GoogleMaps/RochesterNY</span><br><span class="line"><span class="hljs-number">2</span>               Mozilla/<span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">3</span>               Mozilla/<span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">4</span>               Mozilla/<span class="hljs-number">5.0</span></span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">44</span>]: results.value_counts()[:<span class="hljs-number">8</span>]</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line">Mozilla/<span class="hljs-number">5.0</span>                 <span class="hljs-number">2594</span></span><br><span class="line">Mozilla/<span class="hljs-number">4.0</span>                  <span class="hljs-number">601</span></span><br><span class="line">GoogleMaps/RochesterNY       <span class="hljs-number">121</span></span><br><span class="line">Opera/<span class="hljs-number">9.80</span>                    <span class="hljs-number">34</span></span><br><span class="line">TEST_INTERNET_AGENT           <span class="hljs-number">24</span></span><br><span class="line">GoogleProducer                <span class="hljs-number">21</span></span><br><span class="line">Mozilla/<span class="hljs-number">6.0</span>                    <span class="hljs-number">5</span></span><br><span class="line">BlackBerry8520/<span class="hljs-number">5.0</span><span class="hljs-number">.0</span><span class="hljs-number">.681</span>       <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>现在，假设你想按Windows和非Windows用户对时区统计信息进行分解。为了简单起见，我们假定只要agent字符串中含有”Windows”就认为该用户为Windows用户。由于有的agent缺失，所以首先将它们从数据中移除：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: cframe = frame[frame.a.notnull()]</span><br></pre></td></tr></table></figure>

<p>然后计算出各行是否含有Windows的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">47</span>]: cframe[<span class="hljs-string">'os'</span>] = np.where(cframe[<span class="hljs-string">'a'</span>].str.contains(<span class="hljs-string">'Windows'</span>),</span><br><span class="line">   ....:                         <span class="hljs-string">'Windows'</span>, <span class="hljs-string">'Not Windows'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: cframe[<span class="hljs-string">'os'</span>][:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line"><span class="hljs-number">0</span>        Windows</span><br><span class="line"><span class="hljs-number">1</span>    Not Windows</span><br><span class="line"><span class="hljs-number">2</span>        Windows</span><br><span class="line"><span class="hljs-number">3</span>    Not Windows</span><br><span class="line"><span class="hljs-number">4</span>        Windows</span><br><span class="line">Name: os, dtype: object</span><br></pre></td></tr></table></figure>

<p>接下来就可以根据时区和新得到的操作系统列表对数据进行分组了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: by_tz_os = cframe.groupby([<span class="hljs-string">'tz'</span>, <span class="hljs-string">'os'</span>])</span><br></pre></td></tr></table></figure>

<p>分组计数，类似于value_counts函数，可以用size来计算。并利用unstack对计数结果进行重塑：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: agg_counts = by_tz_os.size().unstack().fillna(<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: agg_counts[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">51</span>]: </span><br><span class="line">os                              Not Windows  Windows</span><br><span class="line">tz                                                  </span><br><span class="line">                                      <span class="hljs-number">245.0</span>    <span class="hljs-number">276.0</span></span><br><span class="line">Africa/Cairo                            <span class="hljs-number">0.0</span>      <span class="hljs-number">3.0</span></span><br><span class="line">Africa/Casablanca                       <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">Africa/Ceuta                            <span class="hljs-number">0.0</span>      <span class="hljs-number">2.0</span></span><br><span class="line">Africa/Johannesburg                     <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">Africa/Lusaka                           <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">America/Anchorage                       <span class="hljs-number">4.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">America/Argentina/Buenos_Aires          <span class="hljs-number">1.0</span>      <span class="hljs-number">0.0</span></span><br><span class="line">America/Argentina/Cordoba               <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">America/Argentina/Mendoza               <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br></pre></td></tr></table></figure>

<p>最后，我们来选取最常出现的时区。为了达到这个目的，我根据agg_counts中的行数构造了一个间接索引数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Use to sort in ascending order</span></span><br><span class="line">In [<span class="hljs-number">52</span>]: indexer = agg_counts.sum(<span class="hljs-number">1</span>).argsort()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: indexer[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">tz</span><br><span class="line">                                  <span class="hljs-number">24</span></span><br><span class="line">Africa/Cairo                      <span class="hljs-number">20</span></span><br><span class="line">Africa/Casablanca                 <span class="hljs-number">21</span></span><br><span class="line">Africa/Ceuta                      <span class="hljs-number">92</span></span><br><span class="line">Africa/Johannesburg               <span class="hljs-number">87</span></span><br><span class="line">Africa/Lusaka                     <span class="hljs-number">53</span></span><br><span class="line">America/Anchorage                 <span class="hljs-number">54</span></span><br><span class="line">America/Argentina/Buenos_Aires    <span class="hljs-number">57</span></span><br><span class="line">America/Argentina/Cordoba         <span class="hljs-number">26</span></span><br><span class="line">America/Argentina/Mendoza         <span class="hljs-number">55</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>然后我通过take按照这个顺序截取了最后10行最大值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: count_subset = agg_counts.take(indexer[<span class="hljs-number">-10</span>:])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: count_subset</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line">os                   Not Windows  Windows</span><br><span class="line">tz                                       </span><br><span class="line">America/Sao_Paulo           <span class="hljs-number">13.0</span>     <span class="hljs-number">20.0</span></span><br><span class="line">Europe/Madrid               <span class="hljs-number">16.0</span>     <span class="hljs-number">19.0</span></span><br><span class="line">Pacific/Honolulu             <span class="hljs-number">0.0</span>     <span class="hljs-number">36.0</span></span><br><span class="line">Asia/Tokyo                   <span class="hljs-number">2.0</span>     <span class="hljs-number">35.0</span></span><br><span class="line">Europe/London               <span class="hljs-number">43.0</span>     <span class="hljs-number">31.0</span></span><br><span class="line">America/Denver             <span class="hljs-number">132.0</span>     <span class="hljs-number">59.0</span></span><br><span class="line">America/Los_Angeles        <span class="hljs-number">130.0</span>    <span class="hljs-number">252.0</span></span><br><span class="line">America/Chicago            <span class="hljs-number">115.0</span>    <span class="hljs-number">285.0</span></span><br><span class="line">                           <span class="hljs-number">245.0</span>    <span class="hljs-number">276.0</span></span><br><span class="line">America/New_York           <span class="hljs-number">339.0</span>    <span class="hljs-number">912.0</span></span><br></pre></td></tr></table></figure>

<p>pandas有一个简便方法nlargest，可以做同样的工作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: agg_counts.sum(<span class="hljs-number">1</span>).nlargest(<span class="hljs-number">10</span>)</span><br><span class="line">Out[<span class="hljs-number">56</span>]: </span><br><span class="line">tz</span><br><span class="line">America/New_York       <span class="hljs-number">1251.0</span></span><br><span class="line">                        <span class="hljs-number">521.0</span></span><br><span class="line">America/Chicago         <span class="hljs-number">400.0</span></span><br><span class="line">America/Los_Angeles     <span class="hljs-number">382.0</span></span><br><span class="line">America/Denver          <span class="hljs-number">191.0</span></span><br><span class="line">Europe/London            <span class="hljs-number">74.0</span></span><br><span class="line">Asia/Tokyo               <span class="hljs-number">37.0</span></span><br><span class="line">Pacific/Honolulu         <span class="hljs-number">36.0</span></span><br><span class="line">Europe/Madrid            <span class="hljs-number">35.0</span></span><br><span class="line">America/Sao_Paulo        <span class="hljs-number">33.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>然后，如这段代码所示，可以用柱状图表示。我传递一个额外参数到seaborn的barpolt函数，来画一个堆积条形图（见图14-2）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Rearrange the data for plotting</span></span><br><span class="line">In [<span class="hljs-number">58</span>]: count_subset = count_subset.stack()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: count_subset.name = <span class="hljs-string">'total'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: count_subset = count_subset.reset_index()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: count_subset[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line">                  tz           os  total</span><br><span class="line"><span class="hljs-number">0</span>  America/Sao_Paulo  Not Windows   <span class="hljs-number">13.0</span></span><br><span class="line"><span class="hljs-number">1</span>  America/Sao_Paulo      Windows   <span class="hljs-number">20.0</span></span><br><span class="line"><span class="hljs-number">2</span>      Europe/Madrid  Not Windows   <span class="hljs-number">16.0</span></span><br><span class="line"><span class="hljs-number">3</span>      Europe/Madrid      Windows   <span class="hljs-number">19.0</span></span><br><span class="line"><span class="hljs-number">4</span>   Pacific/Honolulu  Not Windows    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>   Pacific/Honolulu      Windows   <span class="hljs-number">36.0</span></span><br><span class="line"><span class="hljs-number">6</span>         Asia/Tokyo  Not Windows    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">7</span>         Asia/Tokyo      Windows   <span class="hljs-number">35.0</span></span><br><span class="line"><span class="hljs-number">8</span>      Europe/London  Not Windows   <span class="hljs-number">43.0</span></span><br><span class="line"><span class="hljs-number">9</span>      Europe/London      Windows   <span class="hljs-number">31.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: sns.barplot(x=<span class="hljs-string">'total'</span>, y=<span class="hljs-string">'tz'</span>, hue=<span class="hljs-string">'os'</span>,  data=count_subset)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-053612a5655b68d9.webp" alt="img"></p>
<p>图14-2 最常出现时区的Windows和非Windows用户</p>
<p>这张图不容易看出Windows用户在小分组中的相对比例，因此标准化分组百分比之和为1：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">norm_total</span><span class="hljs-params">(group)</span>:</span></span><br><span class="line">    group[<span class="hljs-string">'normed_total'</span>] = group.total / group.total.sum()</span><br><span class="line">    <span class="hljs-keyword">return</span> group</span><br><span class="line"></span><br><span class="line">results = count_subset.groupby(<span class="hljs-string">'tz'</span>).apply(norm_total)</span><br></pre></td></tr></table></figure>

<p>再次画图，见图14-3：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: sns.barplot(x=<span class="hljs-string">'normed_total'</span>, y=<span class="hljs-string">'tz'</span>, hue=<span class="hljs-string">'os'</span>,  data=results)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-60ee355801daf412.webp" alt="img"></p>
<p>图14-3 最常出现时区的Windows和非Windows用户的百分比</p>
<p>我们还可以用groupby的transform方法，更高效的计算标准化的和：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: g = count_subset.groupby(<span class="hljs-string">'tz'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: results2 = count_subset.total / g.total.transform(<span class="hljs-string">'sum'</span>)</span><br></pre></td></tr></table></figure>

<h1 id="14-2-MovieLens-1M数据集"><a href="#14-2-MovieLens-1M数据集" class="headerlink" title="14.2 MovieLens 1M数据集"></a>14.2 MovieLens 1M数据集</h1><p>GroupLens Research（<a href="http://www.grouplens.org/node/73）采集了一组从20世纪90年末到21世纪初由MovieLens用户提供的电影评分数据。这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。基于机器学习算法的推荐系统一般都会对此类数据感兴趣。虽然我不会在本书中详细介绍机器学习技术，但我会告诉你如何对这种数据进行切片切块以满足实际需求。" target="_blank" rel="noopener">http://www.grouplens.org/node/73）采集了一组从20世纪90年末到21世纪初由MovieLens用户提供的电影评分数据。这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。基于机器学习算法的推荐系统一般都会对此类数据感兴趣。虽然我不会在本书中详细介绍机器学习技术，但我会告诉你如何对这种数据进行切片切块以满足实际需求。</a></p>
<p>MovieLens 1M数据集含有来自6000名用户对4000部电影的100万条评分数据。它分为三个表：评分、用户信息和电影信息。将该数据从zip文件中解压出来之后，可以通过pandas.read_table将各个表分别读到一个pandas DataFrame对象中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Make display smaller</span></span><br><span class="line">pd.options.display.max_rows = <span class="hljs-number">10</span></span><br><span class="line"></span><br><span class="line">unames = [<span class="hljs-string">'user_id'</span>, <span class="hljs-string">'gender'</span>, <span class="hljs-string">'age'</span>, <span class="hljs-string">'occupation'</span>, <span class="hljs-string">'zip'</span>]</span><br><span class="line">users = pd.read_table(<span class="hljs-string">'datasets/movielens/users.dat'</span>, sep=<span class="hljs-string">'::'</span>,</span><br><span class="line">                      header=<span class="hljs-literal">None</span>, names=unames)</span><br><span class="line"></span><br><span class="line">rnames = [<span class="hljs-string">'user_id'</span>, <span class="hljs-string">'movie_id'</span>, <span class="hljs-string">'rating'</span>, <span class="hljs-string">'timestamp'</span>]</span><br><span class="line">ratings = pd.read_table(<span class="hljs-string">'datasets/movielens/ratings.dat'</span>, sep=<span class="hljs-string">'::'</span>,</span><br><span class="line">                        header=<span class="hljs-literal">None</span>, names=rnames)</span><br><span class="line">mnames = [<span class="hljs-string">'movie_id'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'genres'</span>]</span><br><span class="line">movies = pd.read_table(<span class="hljs-string">'datasets/movielens/movies.dat'</span>, sep=<span class="hljs-string">'::'</span>,</span><br><span class="line">                       header=<span class="hljs-literal">None</span>, names=mnames)</span><br></pre></td></tr></table></figure>

<p>利用Python的切片语法，通过查看每个DataFrame的前几行即可验证数据加载工作是否一切顺利：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: users[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">69</span>]: </span><br><span class="line">   user_id gender  age  occupation    zip</span><br><span class="line"><span class="hljs-number">0</span>        <span class="hljs-number">1</span>      F    <span class="hljs-number">1</span>          <span class="hljs-number">10</span>  <span class="hljs-number">48067</span></span><br><span class="line"><span class="hljs-number">1</span>        <span class="hljs-number">2</span>      M   <span class="hljs-number">56</span>          <span class="hljs-number">16</span>  <span class="hljs-number">70072</span></span><br><span class="line"><span class="hljs-number">2</span>        <span class="hljs-number">3</span>      M   <span class="hljs-number">25</span>          <span class="hljs-number">15</span>  <span class="hljs-number">55117</span></span><br><span class="line"><span class="hljs-number">3</span>        <span class="hljs-number">4</span>      M   <span class="hljs-number">45</span>           <span class="hljs-number">7</span>  <span class="hljs-number">02460</span></span><br><span class="line"><span class="hljs-number">4</span>        <span class="hljs-number">5</span>      M   <span class="hljs-number">25</span>          <span class="hljs-number">20</span>  <span class="hljs-number">55455</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: ratings[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">   user_id  movie_id  rating  timestamp</span><br><span class="line"><span class="hljs-number">0</span>        <span class="hljs-number">1</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978300760</span></span><br><span class="line"><span class="hljs-number">1</span>        <span class="hljs-number">1</span>       <span class="hljs-number">661</span>       <span class="hljs-number">3</span>  <span class="hljs-number">978302109</span></span><br><span class="line"><span class="hljs-number">2</span>        <span class="hljs-number">1</span>       <span class="hljs-number">914</span>       <span class="hljs-number">3</span>  <span class="hljs-number">978301968</span></span><br><span class="line"><span class="hljs-number">3</span>        <span class="hljs-number">1</span>      <span class="hljs-number">3408</span>       <span class="hljs-number">4</span>  <span class="hljs-number">978300275</span></span><br><span class="line"><span class="hljs-number">4</span>        <span class="hljs-number">1</span>      <span class="hljs-number">2355</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978824291</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: movies[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line">   movie_id                               title                        genres</span><br><span class="line"><span class="hljs-number">0</span>         <span class="hljs-number">1</span>                    Toy Story (<span class="hljs-number">1995</span>)   Animation|Children<span class="hljs-string">'s|Comedy</span></span><br><span class="line"><span class="hljs-string">1         2                      Jumanji (1995)  Adventure|Children'</span>s|Fantasy</span><br><span class="line"><span class="hljs-number">2</span>         <span class="hljs-number">3</span>             Grumpier Old Men (<span class="hljs-number">1995</span>)                Comedy|Romance</span><br><span class="line"><span class="hljs-number">3</span>         <span class="hljs-number">4</span>            Waiting to Exhale (<span class="hljs-number">1995</span>)                  Comedy|Drama</span><br><span class="line"><span class="hljs-number">4</span>         <span class="hljs-number">5</span>  Father of the Bride Part II (<span class="hljs-number">1995</span>)                        Comedy</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: ratings</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line">         user_id  movie_id  rating  timestamp</span><br><span class="line"><span class="hljs-number">0</span>              <span class="hljs-number">1</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978300760</span></span><br><span class="line"><span class="hljs-number">1</span>              <span class="hljs-number">1</span>       <span class="hljs-number">661</span>       <span class="hljs-number">3</span>  <span class="hljs-number">978302109</span></span><br><span class="line"><span class="hljs-number">2</span>              <span class="hljs-number">1</span>       <span class="hljs-number">914</span>       <span class="hljs-number">3</span>  <span class="hljs-number">978301968</span></span><br><span class="line"><span class="hljs-number">3</span>              <span class="hljs-number">1</span>      <span class="hljs-number">3408</span>       <span class="hljs-number">4</span>  <span class="hljs-number">978300275</span></span><br><span class="line"><span class="hljs-number">4</span>              <span class="hljs-number">1</span>      <span class="hljs-number">2355</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978824291</span></span><br><span class="line"><span class="hljs-meta">... </span>         ...       ...     ...        ...</span><br><span class="line"><span class="hljs-number">1000204</span>     <span class="hljs-number">6040</span>      <span class="hljs-number">1091</span>       <span class="hljs-number">1</span>  <span class="hljs-number">956716541</span></span><br><span class="line"><span class="hljs-number">1000205</span>     <span class="hljs-number">6040</span>      <span class="hljs-number">1094</span>       <span class="hljs-number">5</span>  <span class="hljs-number">956704887</span></span><br><span class="line"><span class="hljs-number">1000206</span>     <span class="hljs-number">6040</span>       <span class="hljs-number">562</span>       <span class="hljs-number">5</span>  <span class="hljs-number">956704746</span></span><br><span class="line"><span class="hljs-number">1000207</span>     <span class="hljs-number">6040</span>      <span class="hljs-number">1096</span>       <span class="hljs-number">4</span>  <span class="hljs-number">956715648</span></span><br><span class="line"><span class="hljs-number">1000208</span>     <span class="hljs-number">6040</span>      <span class="hljs-number">1097</span>       <span class="hljs-number">4</span>  <span class="hljs-number">956715569</span></span><br><span class="line">[<span class="hljs-number">1000209</span> rows x <span class="hljs-number">4</span> columns]</span><br></pre></td></tr></table></figure>

<p>注意，其中的年龄和职业是以编码形式给出的，它们的具体含义请参考该数据集的README文件。分析散布在三个表中的数据可不是一件轻松的事情。假设我们想要根据性别和年龄计算某部电影的平均得分，如果将所有数据都合并到一个表中的话问题就简单多了。我们先用pandas的merge函数将ratings跟users合并到一起，然后再将movies也合并进去。pandas会根据列名的重叠情况推断出哪些列是合并（或连接）键：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: data = pd.merge(pd.merge(ratings, users), movies)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">74</span>]: data</span><br><span class="line">Out[<span class="hljs-number">74</span>]: </span><br><span class="line">         user_id  movie_id  rating  timestamp gender  age  occupation    zip  \</span><br><span class="line"><span class="hljs-number">0</span>              <span class="hljs-number">1</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978300760</span>      F    <span class="hljs-number">1</span>          <span class="hljs-number">10</span>  <span class="hljs-number">48067</span>   </span><br><span class="line"><span class="hljs-number">1</span>              <span class="hljs-number">2</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978298413</span>      M   <span class="hljs-number">56</span>          <span class="hljs-number">16</span>  <span class="hljs-number">70072</span>   </span><br><span class="line"><span class="hljs-number">2</span>             <span class="hljs-number">12</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">4</span>  <span class="hljs-number">978220179</span>      M   <span class="hljs-number">25</span>          <span class="hljs-number">12</span>  <span class="hljs-number">32793</span>   </span><br><span class="line"><span class="hljs-number">3</span>             <span class="hljs-number">15</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">4</span>  <span class="hljs-number">978199279</span>      M   <span class="hljs-number">25</span>           <span class="hljs-number">7</span>  <span class="hljs-number">22903</span>   </span><br><span class="line"><span class="hljs-number">4</span>             <span class="hljs-number">17</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978158471</span>      M   <span class="hljs-number">50</span>           <span class="hljs-number">1</span>  <span class="hljs-number">95350</span>   </span><br><span class="line"><span class="hljs-meta">... </span>         ...       ...     ...        ...    ...  ...         ...    ...   </span><br><span class="line"><span class="hljs-number">1000204</span>     <span class="hljs-number">5949</span>      <span class="hljs-number">2198</span>       <span class="hljs-number">5</span>  <span class="hljs-number">958846401</span>      M   <span class="hljs-number">18</span>          <span class="hljs-number">17</span>  <span class="hljs-number">47901</span></span><br><span class="line"><span class="hljs-number">1000205</span>     <span class="hljs-number">5675</span>      <span class="hljs-number">2703</span>       <span class="hljs-number">3</span>  <span class="hljs-number">976029116</span>      M   <span class="hljs-number">35</span>          <span class="hljs-number">14</span>  <span class="hljs-number">30030</span>   </span><br><span class="line"><span class="hljs-number">1000206</span>     <span class="hljs-number">5780</span>      <span class="hljs-number">2845</span>       <span class="hljs-number">1</span>  <span class="hljs-number">958153068</span>      M   <span class="hljs-number">18</span>          <span class="hljs-number">17</span>  <span class="hljs-number">92886</span>   </span><br><span class="line"><span class="hljs-number">1000207</span>     <span class="hljs-number">5851</span>      <span class="hljs-number">3607</span>       <span class="hljs-number">5</span>  <span class="hljs-number">957756608</span>      F   <span class="hljs-number">18</span>          <span class="hljs-number">20</span>  <span class="hljs-number">55410</span>   </span><br><span class="line"><span class="hljs-number">1000208</span>     <span class="hljs-number">5938</span>      <span class="hljs-number">2909</span>       <span class="hljs-number">4</span>  <span class="hljs-number">957273353</span>      M   <span class="hljs-number">25</span>           <span class="hljs-number">1</span>  <span class="hljs-number">35401</span>   </span><br><span class="line">                                               title                genres  </span><br><span class="line"><span class="hljs-number">0</span>             One Flew Over the Cuckoo<span class="hljs-string">'s Nest (1975)                 Drama  </span></span><br><span class="line"><span class="hljs-string">1             One Flew Over the Cuckoo'</span>s Nest (<span class="hljs-number">1975</span>)                 Drama  </span><br><span class="line"><span class="hljs-number">2</span>             One Flew Over the Cuckoo<span class="hljs-string">'s Nest (1975)                 Drama  </span></span><br><span class="line"><span class="hljs-string">3             One Flew Over the Cuckoo'</span>s Nest (<span class="hljs-number">1975</span>)                 Drama  </span><br><span class="line"><span class="hljs-number">4</span>             One Flew Over the Cuckoo<span class="hljs-string">'s Nest (1975)                 Drama  </span></span><br><span class="line"><span class="hljs-string">...                                              ...                   ...  </span></span><br><span class="line"><span class="hljs-string">1000204                           Modulations (1998)           Documentary  </span></span><br><span class="line"><span class="hljs-string">1000205                        Broken Vessels (1998)                 Drama  </span></span><br><span class="line"><span class="hljs-string">1000206                            White Boys (1999)                 Drama  </span></span><br><span class="line"><span class="hljs-string">1000207                     One Little Indian (1973)  Comedy|Drama|Western  </span></span><br><span class="line"><span class="hljs-string">1000208  Five Wives, Three Secretaries and Me (1998)           Documentary  </span></span><br><span class="line"><span class="hljs-string">[1000209 rows x 10 columns]</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">In [75]: data.iloc[0]</span></span><br><span class="line"><span class="hljs-string">Out[75]: </span></span><br><span class="line"><span class="hljs-string">user_id                                            1</span></span><br><span class="line"><span class="hljs-string">movie_id                                        1193</span></span><br><span class="line"><span class="hljs-string">rating                                             5</span></span><br><span class="line"><span class="hljs-string">timestamp                                  978300760</span></span><br><span class="line"><span class="hljs-string">gender                                             F</span></span><br><span class="line"><span class="hljs-string">age                                                1</span></span><br><span class="line"><span class="hljs-string">occupation                                        10</span></span><br><span class="line"><span class="hljs-string">zip                                            48067</span></span><br><span class="line"><span class="hljs-string">title         One Flew Over the Cuckoo'</span>s Nest (<span class="hljs-number">1975</span>)</span><br><span class="line">genres                                         Drama</span><br><span class="line">Name: <span class="hljs-number">0</span>, dtype: object</span><br></pre></td></tr></table></figure>

<p>为了按性别计算每部电影的平均得分，我们可以使用pivot_table方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">76</span>]: mean_ratings = data.pivot_table(<span class="hljs-string">'rating'</span>, index=<span class="hljs-string">'title'</span>,</span><br><span class="line">   ....:                                 columns=<span class="hljs-string">'gender'</span>, aggfunc=<span class="hljs-string">'mean'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: mean_ratings[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">gender                                F         M</span><br><span class="line">title                                            </span><br><span class="line">$<span class="hljs-number">1</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> Duck (<span class="hljs-number">1971</span>)         <span class="hljs-number">3.375000</span>  <span class="hljs-number">2.761905</span></span><br><span class="line"><span class="hljs-string">'Night Mother (1986)           3.388889  3.352941</span></span><br><span class="line"><span class="hljs-string">'</span>Til There Was You (<span class="hljs-number">1997</span>)      <span class="hljs-number">2.675676</span>  <span class="hljs-number">2.733333</span></span><br><span class="line"><span class="hljs-string">'burbs, The (1989)             2.793478  2.962085</span></span><br><span class="line"><span class="hljs-string">...And Justice for All (1979)  3.828571  3.689024</span></span><br></pre></td></tr></table></figure>

<p>该操作产生了另一个DataFrame，其内容为电影平均得分，行标为电影名称（索引），列标为性别。现在，我打算过滤掉评分数据不够250条的电影（随便选的一个数字）。为了达到这个目的，我先对title进行分组，然后利用size()得到一个含有各电影分组大小的Series对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">78</span>]: ratings_by_title = data.groupby(<span class="hljs-string">'title'</span>).size()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">79</span>]: ratings_by_title[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line">title</span><br><span class="line">$<span class="hljs-number">1</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> Duck (<span class="hljs-number">1971</span>)                <span class="hljs-number">37</span></span><br><span class="line"><span class="hljs-string">'Night Mother (1986)                  70</span></span><br><span class="line"><span class="hljs-string">'</span>Til There Was You (<span class="hljs-number">1997</span>)             <span class="hljs-number">52</span></span><br><span class="line"><span class="hljs-string">'burbs, The (1989)                   303</span></span><br><span class="line"><span class="hljs-string">...And Justice for All (1979)        199</span></span><br><span class="line"><span class="hljs-string">1-900 (1994)                           2</span></span><br><span class="line"><span class="hljs-string">10 Things I Hate About You (1999)    700</span></span><br><span class="line"><span class="hljs-string">101 Dalmatians (1961)                565</span></span><br><span class="line"><span class="hljs-string">101 Dalmatians (1996)                364</span></span><br><span class="line"><span class="hljs-string">12 Angry Men (1957)                  616</span></span><br><span class="line"><span class="hljs-string">dtype: int64</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">In [80]: active_titles = ratings_by_title.index[ratings_by_title &gt;= 250]</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">In [81]: active_titles</span></span><br><span class="line"><span class="hljs-string">Out[81]: </span></span><br><span class="line"><span class="hljs-string">Index(['</span><span class="hljs-string">'burbs, The (1989)'</span>, <span class="hljs-string">'10 Things I Hate About You (1999)'</span>,</span><br><span class="line">       <span class="hljs-string">'101 Dalmatians (1961)'</span>, <span class="hljs-string">'101 Dalmatians (1996)'</span>, <span class="hljs-string">'12 Angry Men (1957)'</span>,</span><br><span class="line">       <span class="hljs-string">'13th Warrior, The (1999)'</span>, <span class="hljs-string">'2 Days in the Valley (1996)'</span>,</span><br><span class="line">       <span class="hljs-string">'20,000 Leagues Under the Sea (1954)'</span>, <span class="hljs-string">'2001: A Space Odyssey (1968)'</span>,</span><br><span class="line">       <span class="hljs-string">'2010 (1984)'</span>,</span><br><span class="line">       ...</span><br><span class="line"><span class="hljs-string">'X-Men (2000)'</span>, <span class="hljs-string">'Year of Living Dangerously (1982)'</span>,</span><br><span class="line">       <span class="hljs-string">'Yellow Submarine (1968)'</span>, <span class="hljs-string">'You'</span>ve Got Mail (<span class="hljs-number">1998</span>)<span class="hljs-string">',</span></span><br><span class="line"><span class="hljs-string">       '</span>Young Frankenstein (<span class="hljs-number">1974</span>)<span class="hljs-string">', '</span>Young Guns (<span class="hljs-number">1988</span>)<span class="hljs-string">',</span></span><br><span class="line"><span class="hljs-string">       '</span>Young Guns II (<span class="hljs-number">1990</span>)<span class="hljs-string">', '</span>Young Sherlock Holmes (<span class="hljs-number">1985</span>)<span class="hljs-string">',</span></span><br><span class="line"><span class="hljs-string">       '</span>Zero Effect (<span class="hljs-number">1998</span>)<span class="hljs-string">', '</span>eXistenZ (<span class="hljs-number">1999</span>)<span class="hljs-string">'],</span></span><br><span class="line"><span class="hljs-string">      dtype='</span>object<span class="hljs-string">', name='</span>title<span class="hljs-string">', length=1216)</span></span><br></pre></td></tr></table></figure>

<p>标题索引中含有评分数据大于250条的电影名称，然后我们就可以据此从前面的mean_ratings中选取所需的行了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Select rows on the index</span></span><br><span class="line">In [<span class="hljs-number">82</span>]: mean_ratings = mean_ratings.loc[active_titles]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: mean_ratings</span><br><span class="line">Out[<span class="hljs-number">83</span>]: </span><br><span class="line">gender                                    F         M</span><br><span class="line">title                                                </span><br><span class="line"><span class="hljs-string">'burbs, The (1989)                 2.793478  2.962085</span></span><br><span class="line"><span class="hljs-string">10 Things I Hate About You (1999)  3.646552  3.311966</span></span><br><span class="line"><span class="hljs-string">101 Dalmatians (1961)              3.791444  3.500000</span></span><br><span class="line"><span class="hljs-string">101 Dalmatians (1996)              3.240000  2.911215</span></span><br><span class="line"><span class="hljs-string">12 Angry Men (1957)                4.184397  4.328421</span></span><br><span class="line"><span class="hljs-string">...                                     ...       ...</span></span><br><span class="line"><span class="hljs-string">Young Guns (1988)                  3.371795  3.425620</span></span><br><span class="line"><span class="hljs-string">Young Guns II (1990)               2.934783  2.904025</span></span><br><span class="line"><span class="hljs-string">Young Sherlock Holmes (1985)       3.514706  3.363344</span></span><br><span class="line"><span class="hljs-string">Zero Effect (1998)                 3.864407  3.723140</span></span><br><span class="line"><span class="hljs-string">eXistenZ (1999)                    3.098592  3.289086</span></span><br><span class="line"><span class="hljs-string">[1216 rows x 2 columns]</span></span><br></pre></td></tr></table></figure>

<p>为了了解女性观众最喜欢的电影，我们可以对F列降序排列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: top_female_ratings = mean_ratings.sort_values(by=<span class="hljs-string">'F'</span>, ascending=<span class="hljs-literal">False</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: top_female_ratings[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line">gender                                                     F         M</span><br><span class="line">title                                                                 </span><br><span class="line">Close Shave, A (<span class="hljs-number">1995</span>)                               <span class="hljs-number">4.644444</span>  <span class="hljs-number">4.473795</span></span><br><span class="line">Wrong Trousers, The (<span class="hljs-number">1993</span>)                          <span class="hljs-number">4.588235</span>  <span class="hljs-number">4.478261</span></span><br><span class="line">Sunset Blvd. (a.k.a. Sunset Boulevard) (<span class="hljs-number">1950</span>)       <span class="hljs-number">4.572650</span>  <span class="hljs-number">4.464589</span></span><br><span class="line">Wallace &amp; Gromit: The Best of Aardman Animation...  <span class="hljs-number">4.563107</span>  <span class="hljs-number">4.385075</span></span><br><span class="line">Schindle<span class="hljs-string">r's List (1993)                             4.562602  4.491415</span></span><br><span class="line"><span class="hljs-string">Shawshank Redemption, The (1994)                    4.539075  4.560625</span></span><br><span class="line"><span class="hljs-string">Grand Day Out, A (1992)                             4.537879  4.293255</span></span><br><span class="line"><span class="hljs-string">To Kill a Mockingbird (1962)                        4.536667  4.372611</span></span><br><span class="line"><span class="hljs-string">Creature Comforts (1990)                            4.513889  4.272277</span></span><br><span class="line"><span class="hljs-string">Usual Suspects, The (1995)                          4.513317  4.518248</span></span><br></pre></td></tr></table></figure>

<h2 id="计算评分分歧"><a href="#计算评分分歧" class="headerlink" title="计算评分分歧"></a>计算评分分歧</h2><p>假设我们想要找出男性和女性观众分歧最大的电影。一个办法是给mean_ratings加上一个用于存放平均得分之差的列，并对其进行排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: mean_ratings[<span class="hljs-string">'diff'</span>] = mean_ratings[<span class="hljs-string">'M'</span>] - mean_ratings[<span class="hljs-string">'F'</span>]</span><br></pre></td></tr></table></figure>

<p>按”diff”排序即可得到分歧最大且女性观众更喜欢的电影：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">88</span>]: sorted_by_diff = mean_ratings.sort_values(by=<span class="hljs-string">'diff'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: sorted_by_diff[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">gender                                        F         M      diff</span><br><span class="line">title                                                              </span><br><span class="line">Dirty Dancing (<span class="hljs-number">1987</span>)                   <span class="hljs-number">3.790378</span>  <span class="hljs-number">2.959596</span> <span class="hljs-number">-0.830782</span></span><br><span class="line">Jumpin<span class="hljs-string">' Jack Flash (1986)              3.254717  2.578358 -0.676359</span></span><br><span class="line"><span class="hljs-string">Grease (1978)                          3.975265  3.367041 -0.608224</span></span><br><span class="line"><span class="hljs-string">Little Women (1994)                    3.870588  3.321739 -0.548849</span></span><br><span class="line"><span class="hljs-string">Steel Magnolias (1989)                 3.901734  3.365957 -0.535777</span></span><br><span class="line"><span class="hljs-string">Anastasia (1997)                       3.800000  3.281609 -0.518391</span></span><br><span class="line"><span class="hljs-string">Rocky Horror Picture Show, The (1975)  3.673016  3.160131 -0.512885</span></span><br><span class="line"><span class="hljs-string">Color Purple, The (1985)               4.158192  3.659341 -0.498851</span></span><br><span class="line"><span class="hljs-string">Age of Innocence, The (1993)           3.827068  3.339506 -0.487561</span></span><br><span class="line"><span class="hljs-string">Free Willy (1993)                      2.921348  2.438776 -0.482573</span></span><br></pre></td></tr></table></figure>

<p>对排序结果反序并取出前10行，得到的则是男性观众更喜欢的电影：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Reverse order of rows, take first 10 rows</span></span><br><span class="line">In [<span class="hljs-number">90</span>]: sorted_by_diff[::<span class="hljs-number">-1</span>][:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">gender                                         F         M      diff</span><br><span class="line">title                                                               </span><br><span class="line">Good, The Bad <span class="hljs-keyword">and</span> The Ugly, The (<span class="hljs-number">1966</span>)  <span class="hljs-number">3.494949</span>  <span class="hljs-number">4.221300</span>  <span class="hljs-number">0.726351</span></span><br><span class="line">Kentucky Fried Movie, The (<span class="hljs-number">1977</span>)        <span class="hljs-number">2.878788</span>  <span class="hljs-number">3.555147</span>  <span class="hljs-number">0.676359</span></span><br><span class="line">Dumb &amp; Dumber (<span class="hljs-number">1994</span>)                    <span class="hljs-number">2.697987</span>  <span class="hljs-number">3.336595</span>  <span class="hljs-number">0.638608</span></span><br><span class="line">Longest Day, The (<span class="hljs-number">1962</span>)                 <span class="hljs-number">3.411765</span>  <span class="hljs-number">4.031447</span>  <span class="hljs-number">0.619682</span></span><br><span class="line">Cable Guy, The (<span class="hljs-number">1996</span>)                   <span class="hljs-number">2.250000</span>  <span class="hljs-number">2.863787</span>  <span class="hljs-number">0.613787</span></span><br><span class="line">Evil Dead II (Dead By Dawn) (<span class="hljs-number">1987</span>)      <span class="hljs-number">3.297297</span>  <span class="hljs-number">3.909283</span>  <span class="hljs-number">0.611985</span></span><br><span class="line">Hidden, The (<span class="hljs-number">1987</span>)                      <span class="hljs-number">3.137931</span>  <span class="hljs-number">3.745098</span>  <span class="hljs-number">0.607167</span></span><br><span class="line">Rocky III (<span class="hljs-number">1982</span>)                        <span class="hljs-number">2.361702</span>  <span class="hljs-number">2.943503</span>  <span class="hljs-number">0.581801</span></span><br><span class="line">Caddyshack (<span class="hljs-number">1980</span>)                       <span class="hljs-number">3.396135</span>  <span class="hljs-number">3.969737</span>  <span class="hljs-number">0.573602</span></span><br><span class="line">For a Few Dollars More (<span class="hljs-number">1965</span>)           <span class="hljs-number">3.409091</span>  <span class="hljs-number">3.953795</span>  <span class="hljs-number">0.544704</span></span><br></pre></td></tr></table></figure>

<p>如果只是想要找出分歧最大的电影（不考虑性别因素），则可以计算得分数据的方差或标准差：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Standard deviation of rating grouped by title</span></span><br><span class="line">In [<span class="hljs-number">91</span>]: rating_std_by_title = data.groupby(<span class="hljs-string">'title'</span>)[<span class="hljs-string">'rating'</span>].std()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Filter down to active_titles</span></span><br><span class="line">In [<span class="hljs-number">92</span>]: rating_std_by_title = rating_std_by_title.loc[active_titles]</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Order Series by value in descending order</span></span><br><span class="line">In [<span class="hljs-number">93</span>]: rating_std_by_title.sort_values(ascending=<span class="hljs-literal">False</span>)[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line">title</span><br><span class="line">Dumb &amp; Dumber (<span class="hljs-number">1994</span>)                     <span class="hljs-number">1.321333</span></span><br><span class="line">Blair Witch Project, The (<span class="hljs-number">1999</span>)          <span class="hljs-number">1.316368</span></span><br><span class="line">Natural Born Killers (<span class="hljs-number">1994</span>)              <span class="hljs-number">1.307198</span></span><br><span class="line">Tank Girl (<span class="hljs-number">1995</span>)                         <span class="hljs-number">1.277695</span></span><br><span class="line">Rocky Horror Picture Show, The (<span class="hljs-number">1975</span>)    <span class="hljs-number">1.260177</span></span><br><span class="line">Eyes Wide Shut (<span class="hljs-number">1999</span>)                    <span class="hljs-number">1.259624</span></span><br><span class="line">Evita (<span class="hljs-number">1996</span>)                             <span class="hljs-number">1.253631</span></span><br><span class="line">Billy Madison (<span class="hljs-number">1995</span>)                     <span class="hljs-number">1.249970</span></span><br><span class="line">Fear <span class="hljs-keyword">and</span> Loathing <span class="hljs-keyword">in</span> Las Vegas (<span class="hljs-number">1998</span>)    <span class="hljs-number">1.246408</span></span><br><span class="line">Bicentennial Man (<span class="hljs-number">1999</span>)                  <span class="hljs-number">1.245533</span></span><br><span class="line">Name: rating, dtype: float64</span><br></pre></td></tr></table></figure>

<p>可能你已经注意到了，电影分类是以竖线（|）分隔的字符串形式给出的。如果想对电影分类进行分析的话，就需要先将其转换成更有用的形式才行。</p>
<h1 id="14-3-1880-2010年间全美婴儿姓名"><a href="#14-3-1880-2010年间全美婴儿姓名" class="headerlink" title="14.3 1880-2010年间全美婴儿姓名"></a>14.3 1880-2010年间全美婴儿姓名</h1><p>美国社会保障总署（SSA）提供了一份从1880年到现在的婴儿名字频率数据。Hadley Wickham（许多流行R包的作者）经常用这份数据来演示R的数据处理功能。</p>
<p>我们要做一些数据规整才能加载这个数据集，这么做就会产生一个如下的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">4</span>]: names.head(<span class="hljs-number">10</span>)</span><br><span class="line">Out[<span class="hljs-number">4</span>]:</span><br><span class="line">        name sex  births  year</span><br><span class="line"><span class="hljs-number">0</span>       Mary   F    <span class="hljs-number">7065</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">1</span>       Anna   F    <span class="hljs-number">2604</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">2</span>       Emma   F    <span class="hljs-number">2003</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">3</span>  Elizabeth   F    <span class="hljs-number">1939</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">4</span>     Minnie   F    <span class="hljs-number">1746</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">5</span>   Margaret   F    <span class="hljs-number">1578</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">6</span>        Ida   F    <span class="hljs-number">1472</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">7</span>      Alice   F    <span class="hljs-number">1414</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">8</span>     Bertha   F    <span class="hljs-number">1320</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">9</span>      Sarah   F    <span class="hljs-number">1288</span>  <span class="hljs-number">1880</span></span><br></pre></td></tr></table></figure>

<p>你可以用这个数据集做很多事，例如：</p>
<ul>
<li>计算指定名字（可以是你自己的，也可以是别人的）的年度比例。</li>
<li>计算某个名字的相对排名。</li>
<li>计算各年度最流行的名字，以及增长或减少最快的名字。</li>
<li>分析名字趋势：元音、辅音、长度、总体多样性、拼写变化、首尾字母等。</li>
<li>分析外源性趋势：圣经中的名字、名人、人口结构变化等。</li>
</ul>
<p>利用前面介绍过的那些工具，这些分析工作都能很轻松地完成，我会讲解其中的一些。</p>
<p>到编写本书时为止，美国社会保障总署将该数据库按年度制成了多个数据文件，其中给出了每个性别/名字组合的出生总数。这些文件的原始档案可以在这里获取：<a href="http://www.ssa.gov/oact/babynames/limits.html。" target="_blank" rel="noopener">http://www.ssa.gov/oact/babynames/limits.html。</a></p>
<p>如果你在阅读本书的时候这个页面已经不见了，也可以用搜索引擎找找。</p>
<p>下载”National data”文件names.zip，解压后的目录中含有一组文件（如yob1880.txt）。我用UNIX的head命令查看了其中一个文件的前10行（在Windows上，你可以用more命令，或直接在文本编辑器中打开）：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [94]: !head -n 10 datasets/babynames/yob1880.txt</span><br><span class="line">Mary,F,7065</span><br><span class="line">Anna,F,2604</span><br><span class="line">Emma,F,2003</span><br><span class="line">Elizabeth,F,1939</span><br><span class="line">Minnie,F,1746</span><br><span class="line">Margaret,F,1578</span><br><span class="line">Ida,F,1472</span><br><span class="line">Alice,F,1414</span><br><span class="line">Bertha,F,1320</span><br><span class="line">Sarah,F,1288</span><br></pre></td></tr></table></figure>

<p>由于这是一个非常标准的以逗号隔开的格式，所以可以用pandas.read_csv将其加载到DataFrame中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">95</span>]: <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">96</span>]: names1880 =</span><br><span class="line">pd.read_csv(<span class="hljs-string">'datasets/babynames/yob1880.txt'</span>,</span><br><span class="line">   ....:                         names=[<span class="hljs-string">'name'</span>, <span class="hljs-string">'sex'</span>, <span class="hljs-string">'births'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: names1880</span><br><span class="line">Out[<span class="hljs-number">97</span>]: </span><br><span class="line">           name sex  births</span><br><span class="line"><span class="hljs-number">0</span>          Mary   F    <span class="hljs-number">7065</span></span><br><span class="line"><span class="hljs-number">1</span>          Anna   F    <span class="hljs-number">2604</span></span><br><span class="line"><span class="hljs-number">2</span>          Emma   F    <span class="hljs-number">2003</span></span><br><span class="line"><span class="hljs-number">3</span>     Elizabeth   F    <span class="hljs-number">1939</span></span><br><span class="line"><span class="hljs-number">4</span>        Minnie   F    <span class="hljs-number">1746</span></span><br><span class="line"><span class="hljs-meta">... </span>        ...  ..     ...</span><br><span class="line"><span class="hljs-number">1995</span>     Woodie   M       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1996</span>     Worthy   M       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1997</span>     Wright   M       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1998</span>       York   M       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1999</span>  Zachariah   M       <span class="hljs-number">5</span></span><br><span class="line">[<span class="hljs-number">2000</span> rows x <span class="hljs-number">3</span> columns]</span><br></pre></td></tr></table></figure>

<p>这些文件中仅含有当年出现超过5次的名字。为了简单起见，我们可以用births列的sex分组小计表示该年度的births总计：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">98</span>]: names1880.groupby(<span class="hljs-string">'sex'</span>).births.sum()</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">sex</span><br><span class="line">F     <span class="hljs-number">90993</span></span><br><span class="line">M    <span class="hljs-number">110493</span></span><br><span class="line">Name: births, dtype: int64</span><br></pre></td></tr></table></figure>

<p>由于该数据集按年度被分隔成了多个文件，所以第一件事情就是要将所有数据都组装到一个DataFrame里面，并加上一个year字段。使用pandas.concat即可达到这个目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">years = range(<span class="hljs-number">1880</span>, <span class="hljs-number">2011</span>)</span><br><span class="line"></span><br><span class="line">pieces = []</span><br><span class="line">columns = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'sex'</span>, <span class="hljs-string">'births'</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> year <span class="hljs-keyword">in</span> years:</span><br><span class="line">    path = <span class="hljs-string">'datasets/babynames/yob%d.txt'</span> % year</span><br><span class="line">    frame = pd.read_csv(path, names=columns)</span><br><span class="line"></span><br><span class="line">    frame[<span class="hljs-string">'year'</span>] = year</span><br><span class="line">    pieces.append(frame)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Concatenate everything into a single DataFrame</span></span><br><span class="line">names = pd.concat(pieces, ignore_index=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这里需要注意几件事情。第一，concat默认是按行将多个DataFrame组合到一起的；第二，必须指定ignore_index=True，因为我们不希望保留read_csv所返回的原始行号。现在我们得到了一个非常大的DataFrame，它含有全部的名字数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">100</span>]: names</span><br><span class="line">Out[<span class="hljs-number">100</span>]: </span><br><span class="line">              name sex  births  year</span><br><span class="line"><span class="hljs-number">0</span>             Mary   F    <span class="hljs-number">7065</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">1</span>             Anna   F    <span class="hljs-number">2604</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">2</span>             Emma   F    <span class="hljs-number">2003</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">3</span>        Elizabeth   F    <span class="hljs-number">1939</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">4</span>           Minnie   F    <span class="hljs-number">1746</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-meta">... </span>           ...  ..     ...   ...</span><br><span class="line"><span class="hljs-number">1690779</span>    Zymaire   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line"><span class="hljs-number">1690780</span>     Zyonne   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line"><span class="hljs-number">1690781</span>  Zyquarius   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line"><span class="hljs-number">1690782</span>      Zyran   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line"><span class="hljs-number">1690783</span>      Zzyzx   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line">[<span class="hljs-number">1690784</span> rows x <span class="hljs-number">4</span> columns]</span><br></pre></td></tr></table></figure>

<p>有了这些数据之后，我们就可以利用groupby或pivot_table在year和sex级别上对其进行聚合了，如图14-4所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: total_births = names.pivot_table(<span class="hljs-string">'births'</span>, index=<span class="hljs-string">'year'</span>,</span><br><span class="line">   .....:                                  columns=<span class="hljs-string">'sex'</span>, aggfunc=sum)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: total_births.tail()</span><br><span class="line">Out[<span class="hljs-number">102</span>]: </span><br><span class="line">sex         F        M</span><br><span class="line">year                  </span><br><span class="line"><span class="hljs-number">2006</span>  <span class="hljs-number">1896468</span>  <span class="hljs-number">2050234</span></span><br><span class="line"><span class="hljs-number">2007</span>  <span class="hljs-number">1916888</span>  <span class="hljs-number">2069242</span></span><br><span class="line"><span class="hljs-number">2008</span>  <span class="hljs-number">1883645</span>  <span class="hljs-number">2032310</span></span><br><span class="line"><span class="hljs-number">2009</span>  <span class="hljs-number">1827643</span>  <span class="hljs-number">1973359</span></span><br><span class="line"><span class="hljs-number">2010</span>  <span class="hljs-number">1759010</span>  <span class="hljs-number">1898382</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: total_births.plot(title=<span class="hljs-string">'Total births by sex and year'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-7643b150d88aae11.webp" alt="img"></p>
<p>图14-4 按性别和年度统计的总出生数</p>
<p>下面我们来插入一个prop列，用于存放指定名字的婴儿数相对于总出生数的比例。prop值为0.02表示每100名婴儿中有2名取了当前这个名字。因此，我们先按year和sex分组，然后再将新列加到各个分组上：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_prop</span><span class="hljs-params">(group)</span>:</span></span><br><span class="line">    group[<span class="hljs-string">'prop'</span>] = group.births / group.births.sum()</span><br><span class="line">    <span class="hljs-keyword">return</span> group</span><br><span class="line">names = names.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>]).apply(add_prop)</span><br></pre></td></tr></table></figure>

<p>现在，完整的数据集就有了下面这些列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: names</span><br><span class="line">Out[<span class="hljs-number">105</span>]: </span><br><span class="line">              name sex  births  year      prop</span><br><span class="line"><span class="hljs-number">0</span>             Mary   F    <span class="hljs-number">7065</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.077643</span></span><br><span class="line"><span class="hljs-number">1</span>             Anna   F    <span class="hljs-number">2604</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.028618</span></span><br><span class="line"><span class="hljs-number">2</span>             Emma   F    <span class="hljs-number">2003</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.022013</span></span><br><span class="line"><span class="hljs-number">3</span>        Elizabeth   F    <span class="hljs-number">1939</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.021309</span></span><br><span class="line"><span class="hljs-number">4</span>           Minnie   F    <span class="hljs-number">1746</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.019188</span></span><br><span class="line"><span class="hljs-meta">... </span>           ...  ..     ...   ...       ...</span><br><span class="line"><span class="hljs-number">1690779</span>    Zymaire   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line"><span class="hljs-number">1690780</span>     Zyonne   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line"><span class="hljs-number">1690781</span>  Zyquarius   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line"><span class="hljs-number">1690782</span>      Zyran   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line"><span class="hljs-number">1690783</span>      Zzyzx   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line">[<span class="hljs-number">1690784</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>在执行这样的分组处理时，一般都应该做一些有效性检查，比如验证所有分组的prop的总和是否为1：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">106</span>]: names.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>]).prop.sum()</span><br><span class="line">Out[<span class="hljs-number">106</span>]: </span><br><span class="line">year  sex</span><br><span class="line"><span class="hljs-number">1880</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">      M      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1881</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">      M      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1882</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">            ... </span><br><span class="line"><span class="hljs-number">2008</span>  M      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2009</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">      M      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2010</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">      M      <span class="hljs-number">1.0</span></span><br><span class="line">Name: prop, Length: <span class="hljs-number">262</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>工作完成。为了便于实现更进一步的分析，我需要取出该数据的一个子集：每对sex/year组合的前1000个名字。这又是一个分组操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_top1000</span><span class="hljs-params">(group)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> group.sort_values(by=<span class="hljs-string">'births'</span>, ascending=<span class="hljs-literal">False</span>)[:<span class="hljs-number">1000</span>]</span><br><span class="line">grouped = names.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>])</span><br><span class="line">top1000 = grouped.apply(get_top1000)</span><br><span class="line"><span class="hljs-comment"># Drop the group index, not needed</span></span><br><span class="line">top1000.reset_index(inplace=<span class="hljs-literal">True</span>, drop=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>如果你喜欢DIY的话，也可以这样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pieces = []</span><br><span class="line"><span class="hljs-keyword">for</span> year, group <span class="hljs-keyword">in</span> names.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>]):</span><br><span class="line">    pieces.append(group.sort_values(by=<span class="hljs-string">'births'</span>, ascending=<span class="hljs-literal">False</span>)[:<span class="hljs-number">1000</span>])</span><br><span class="line">top1000 = pd.concat(pieces, ignore_index=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>现在的结果数据集就小多了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: top1000</span><br><span class="line">Out[<span class="hljs-number">108</span>]: </span><br><span class="line">             name sex  births  year      prop</span><br><span class="line"><span class="hljs-number">0</span>            Mary   F    <span class="hljs-number">7065</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.077643</span></span><br><span class="line"><span class="hljs-number">1</span>            Anna   F    <span class="hljs-number">2604</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.028618</span></span><br><span class="line"><span class="hljs-number">2</span>            Emma   F    <span class="hljs-number">2003</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.022013</span></span><br><span class="line"><span class="hljs-number">3</span>       Elizabeth   F    <span class="hljs-number">1939</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.021309</span></span><br><span class="line"><span class="hljs-number">4</span>          Minnie   F    <span class="hljs-number">1746</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.019188</span></span><br><span class="line"><span class="hljs-meta">... </span>          ...  ..     ...   ...       ...</span><br><span class="line"><span class="hljs-number">261872</span>     Camilo   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261873</span>     Destin   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261874</span>     Jaquan   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261875</span>     Jaydan   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261876</span>     Maxton   M     <span class="hljs-number">193</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line">[<span class="hljs-number">261877</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>接下来的数据分析工作就针对这个top1000数据集了。</p>
<h2 id="分析命名趋势"><a href="#分析命名趋势" class="headerlink" title="分析命名趋势"></a>分析命名趋势</h2><p>有了完整的数据集和刚才生成的top1000数据集，我们就可以开始分析各种命名趋势了。首先将前1000个名字分为男女两个部分：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: boys = top1000[top1000.sex == <span class="hljs-string">'M'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: girls = top1000[top1000.sex == <span class="hljs-string">'F'</span>]</span><br></pre></td></tr></table></figure>

<p>这是两个简单的时间序列，只需稍作整理即可绘制出相应的图表（比如每年叫做John和Mary的婴儿数）。我们先生成一张按year和name统计的总出生数透视表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">111</span>]: total_births = top1000.pivot_table(<span class="hljs-string">'births'</span>, index=<span class="hljs-string">'year'</span>,</span><br><span class="line">   .....:                                    columns=<span class="hljs-string">'name'</span>,</span><br><span class="line">   .....:                                    aggfunc=sum)</span><br></pre></td></tr></table></figure>

<p>现在，我们用DataFrame的plot方法绘制几个名字的曲线图（见图14-5）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">112</span>]: total_births.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">Int64Index</span>:</span> <span class="hljs-number">131</span> entries, <span class="hljs-number">1880</span> to <span class="hljs-number">2010</span></span><br><span class="line">Columns: <span class="hljs-number">6868</span> entries, Aaden to Zuri</span><br><span class="line">dtypes: float64(<span class="hljs-number">6868</span>)</span><br><span class="line">memory usage: <span class="hljs-number">6.9</span> MB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: subset = total_births[[<span class="hljs-string">'John'</span>, <span class="hljs-string">'Harry'</span>, <span class="hljs-string">'Mary'</span>, <span class="hljs-string">'Marilyn'</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">114</span>]: subset.plot(subplots=<span class="hljs-literal">True</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">10</span>), grid=<span class="hljs-literal">False</span>,</span><br><span class="line">   .....:             title=<span class="hljs-string">"Number of births per year"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-33f0f97656367a53.webp" alt="img"></p>
<p>图14-5 几个男孩和女孩名字随时间变化的使用数量</p>
<p>从图中可以看出，这几个名字在美国人民的心目中已经风光不再了。但事实并非如此简单，我们在下一节中就能知道是怎么一回事了。</p>
<h2 id="评估命名多样性的增长"><a href="#评估命名多样性的增长" class="headerlink" title="评估命名多样性的增长"></a>评估命名多样性的增长</h2><p>一种解释是父母愿意给小孩起常见的名字越来越少。这个假设可以从数据中得到验证。一个办法是计算最流行的1000个名字所占的比例，我按year和sex进行聚合并绘图（见图14-6）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">116</span>]: table = top1000.pivot_table(<span class="hljs-string">'prop'</span>, index=<span class="hljs-string">'year'</span>,</span><br><span class="line">   .....:                             columns=<span class="hljs-string">'sex'</span>, aggfunc=sum)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">117</span>]: table.plot(title=<span class="hljs-string">'Sum of table1000.prop by year and sex'</span>,</span><br><span class="line">   .....:            yticks=np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">1.2</span>, <span class="hljs-number">13</span>), xticks=range(<span class="hljs-number">1880</span>, <span class="hljs-number">2020</span>, <span class="hljs-number">10</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-63e1ddc326a033b9.webp" alt="img"></p>
<p>图14-6 分性别统计的前1000个名字在总出生人数中的比例</p>
<p>从图中可以看出，名字的多样性确实出现了增长（前1000项的比例降低）。另一个办法是计算占总出生人数前50%的不同名字的数量，这个数字不太好计算。我们只考虑2010年男孩的名字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">118</span>]: df = boys[boys.year == <span class="hljs-number">2010</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">119</span>]: df</span><br><span class="line">Out[<span class="hljs-number">119</span>]: </span><br><span class="line">           name sex  births  year      prop</span><br><span class="line"><span class="hljs-number">260877</span>    Jacob   M   <span class="hljs-number">21875</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.011523</span></span><br><span class="line"><span class="hljs-number">260878</span>    Ethan   M   <span class="hljs-number">17866</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.009411</span></span><br><span class="line"><span class="hljs-number">260879</span>  Michael   M   <span class="hljs-number">17133</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.009025</span></span><br><span class="line"><span class="hljs-number">260880</span>   Jayden   M   <span class="hljs-number">17030</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.008971</span></span><br><span class="line"><span class="hljs-number">260881</span>  William   M   <span class="hljs-number">16870</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.008887</span></span><br><span class="line"><span class="hljs-meta">... </span>        ...  ..     ...   ...       ...</span><br><span class="line"><span class="hljs-number">261872</span>   Camilo   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261873</span>   Destin   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261874</span>   Jaquan   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261875</span>   Jaydan   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261876</span>   Maxton   M     <span class="hljs-number">193</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line">[<span class="hljs-number">1000</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>在对prop降序排列之后，我们想知道前面多少个名字的人数加起来才够50%。虽然编写一个for循环确实也能达到目的，但NumPy有一种更聪明的矢量方式。先计算prop的累计和cumsum，然后再通过searchsorted方法找出0.5应该被插入在哪个位置才能保证不破坏顺序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">120</span>]: prop_cumsum = df.sort_values(by=<span class="hljs-string">'prop'</span>, ascending=<span class="hljs-literal">False</span>).prop.cumsum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">121</span>]: prop_cumsum[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">121</span>]: </span><br><span class="line"><span class="hljs-number">260877</span>    <span class="hljs-number">0.011523</span></span><br><span class="line"><span class="hljs-number">260878</span>    <span class="hljs-number">0.020934</span></span><br><span class="line"><span class="hljs-number">260879</span>    <span class="hljs-number">0.029959</span></span><br><span class="line"><span class="hljs-number">260880</span>    <span class="hljs-number">0.038930</span></span><br><span class="line"><span class="hljs-number">260881</span>    <span class="hljs-number">0.047817</span></span><br><span class="line"><span class="hljs-number">260882</span>    <span class="hljs-number">0.056579</span></span><br><span class="line"><span class="hljs-number">260883</span>    <span class="hljs-number">0.065155</span></span><br><span class="line"><span class="hljs-number">260884</span>    <span class="hljs-number">0.073414</span></span><br><span class="line"><span class="hljs-number">260885</span>    <span class="hljs-number">0.081528</span></span><br><span class="line"><span class="hljs-number">260886</span>    <span class="hljs-number">0.089621</span></span><br><span class="line">Name: prop, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: prop_cumsum.values.searchsorted(<span class="hljs-number">0.5</span>)</span><br><span class="line">Out[<span class="hljs-number">122</span>]: <span class="hljs-number">116</span></span><br></pre></td></tr></table></figure>

<p>由于数组索引是从0开始的，因此我们要给这个结果加1，即最终结果为117。拿1900年的数据来做个比较，这个数字要小得多：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">123</span>]: df = boys[boys.year == <span class="hljs-number">1900</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">124</span>]: in1900 = df.sort_values(by=<span class="hljs-string">'prop'</span>, ascending=<span class="hljs-literal">False</span>).prop.cumsum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: in1900.values.searchsorted(<span class="hljs-number">0.5</span>) + <span class="hljs-number">1</span></span><br><span class="line">Out[<span class="hljs-number">125</span>]: <span class="hljs-number">25</span></span><br></pre></td></tr></table></figure>

<p>现在就可以对所有year/sex组合执行这个计算了。按这两个字段进行groupby处理，然后用一个函数计算各分组的这个值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_quantile_count</span><span class="hljs-params">(group, q=<span class="hljs-number">0.5</span>)</span>:</span></span><br><span class="line">    group = group.sort_values(by=<span class="hljs-string">'prop'</span>, ascending=<span class="hljs-literal">False</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> group.prop.cumsum().values.searchsorted(q) + <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">diversity = top1000.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>]).apply(get_quantile_count)</span><br><span class="line">diversity = diversity.unstack(<span class="hljs-string">'sex'</span>)</span><br></pre></td></tr></table></figure>

<p>现在，diversity这个DataFrame拥有两个时间序列（每个性别各一个，按年度索引）。通过IPython，你可以查看其内容，还可以像之前那样绘制图表（如图14-7所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">128</span>]: diversity.head()</span><br><span class="line">Out[<span class="hljs-number">128</span>]: </span><br><span class="line">sex    F   M</span><br><span class="line">year        </span><br><span class="line"><span class="hljs-number">1880</span>  <span class="hljs-number">38</span>  <span class="hljs-number">14</span></span><br><span class="line"><span class="hljs-number">1881</span>  <span class="hljs-number">38</span>  <span class="hljs-number">14</span></span><br><span class="line"><span class="hljs-number">1882</span>  <span class="hljs-number">38</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">1883</span>  <span class="hljs-number">39</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">1884</span>  <span class="hljs-number">39</span>  <span class="hljs-number">16</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">129</span>]: diversity.plot(title=<span class="hljs-string">"Number of popular names in top 50%"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-574b53a383cad681.webp" alt="img"></p>
<p>图14-7 按年度统计的密度表</p>
<p>从图中可以看出，女孩名字的多样性总是比男孩的高，而且还在变得越来越高。读者们可以自己分析一下具体是什么在驱动这个多样性（比如拼写形式的变化）。</p>
<h2 id="“最后一个字母”的变革"><a href="#“最后一个字母”的变革" class="headerlink" title="“最后一个字母”的变革"></a>“最后一个字母”的变革</h2><p>2007年，一名婴儿姓名研究人员Laura Wattenberg在她自己的网站上指出（<a href="http://www.babynamewizard.com/" target="_blank" rel="noopener">http://www.babynamewizard.com</a>）：近百年来，男孩名字在最后一个字母上的分布发生了显著的变化。为了了解具体的情况，我首先将全部出生数据在年度、性别以及末字母上进行了聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># extract last letter from name column</span></span><br><span class="line">get_last_letter = <span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">-1</span>]</span><br><span class="line">last_letters = names.name.map(get_last_letter)</span><br><span class="line">last_letters.name = <span class="hljs-string">'last_letter'</span></span><br><span class="line"></span><br><span class="line">table = names.pivot_table(<span class="hljs-string">'births'</span>, index=last_letters,</span><br><span class="line">                          columns=[<span class="hljs-string">'sex'</span>, <span class="hljs-string">'year'</span>], aggfunc=sum)</span><br></pre></td></tr></table></figure>

<p>然后，我选出具有一定代表性的三年，并输出前面几行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">131</span>]: subtable = table.reindex(columns=[<span class="hljs-number">1910</span>, <span class="hljs-number">1960</span>, <span class="hljs-number">2010</span>], level=<span class="hljs-string">'year'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: subtable.head()</span><br><span class="line">Out[<span class="hljs-number">132</span>]: </span><br><span class="line">sex                 F                            M                    </span><br><span class="line">year             <span class="hljs-number">1910</span>      <span class="hljs-number">1960</span>      <span class="hljs-number">2010</span>     <span class="hljs-number">1910</span>      <span class="hljs-number">1960</span>      <span class="hljs-number">2010</span></span><br><span class="line">last_letter                                                           </span><br><span class="line">a            <span class="hljs-number">108376.0</span>  <span class="hljs-number">691247.0</span>  <span class="hljs-number">670605.0</span>    <span class="hljs-number">977.0</span>    <span class="hljs-number">5204.0</span>   <span class="hljs-number">28438.0</span></span><br><span class="line">b                 NaN     <span class="hljs-number">694.0</span>     <span class="hljs-number">450.0</span>    <span class="hljs-number">411.0</span>    <span class="hljs-number">3912.0</span>   <span class="hljs-number">38859.0</span></span><br><span class="line">c                 <span class="hljs-number">5.0</span>      <span class="hljs-number">49.0</span>     <span class="hljs-number">946.0</span>    <span class="hljs-number">482.0</span>   <span class="hljs-number">15476.0</span>   <span class="hljs-number">23125.0</span></span><br><span class="line">d              <span class="hljs-number">6750.0</span>    <span class="hljs-number">3729.0</span>    <span class="hljs-number">2607.0</span>  <span class="hljs-number">22111.0</span>  <span class="hljs-number">262112.0</span>   <span class="hljs-number">44398.0</span></span><br><span class="line">e            <span class="hljs-number">133569.0</span>  <span class="hljs-number">435013.0</span>  <span class="hljs-number">313833.0</span>  <span class="hljs-number">28655.0</span>  <span class="hljs-number">178823.0</span>  <span class="hljs-number">129012.0</span></span><br></pre></td></tr></table></figure>

<p>接下来我们需要按总出生数对该表进行规范化处理，以便计算出各性别各末字母占总出生人数的比例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">133</span>]: subtable.sum()</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">sex  year</span><br><span class="line">F    <span class="hljs-number">1910</span>     <span class="hljs-number">396416.0</span></span><br><span class="line">     <span class="hljs-number">1960</span>    <span class="hljs-number">2022062.0</span></span><br><span class="line">     <span class="hljs-number">2010</span>    <span class="hljs-number">1759010.0</span></span><br><span class="line">M    <span class="hljs-number">1910</span>     <span class="hljs-number">194198.0</span></span><br><span class="line">     <span class="hljs-number">1960</span>    <span class="hljs-number">2132588.0</span></span><br><span class="line"><span class="hljs-number">2010</span>    <span class="hljs-number">1898382.0</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: letter_prop = subtable / subtable.sum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">135</span>]: letter_prop</span><br><span class="line">Out[<span class="hljs-number">135</span>]: </span><br><span class="line">sex                 F                             M                    </span><br><span class="line">year             <span class="hljs-number">1910</span>      <span class="hljs-number">1960</span>      <span class="hljs-number">2010</span>      <span class="hljs-number">1910</span>      <span class="hljs-number">1960</span>      <span class="hljs-number">2010</span></span><br><span class="line">last_letter                                                            </span><br><span class="line">a            <span class="hljs-number">0.273390</span>  <span class="hljs-number">0.341853</span>  <span class="hljs-number">0.381240</span>  <span class="hljs-number">0.005031</span>  <span class="hljs-number">0.002440</span>  <span class="hljs-number">0.014980</span></span><br><span class="line">b                 NaN  <span class="hljs-number">0.000343</span>  <span class="hljs-number">0.000256</span>  <span class="hljs-number">0.002116</span>  <span class="hljs-number">0.001834</span>  <span class="hljs-number">0.020470</span></span><br><span class="line">c            <span class="hljs-number">0.000013</span>  <span class="hljs-number">0.000024</span>  <span class="hljs-number">0.000538</span>  <span class="hljs-number">0.002482</span>  <span class="hljs-number">0.007257</span>  <span class="hljs-number">0.012181</span></span><br><span class="line">d            <span class="hljs-number">0.017028</span>  <span class="hljs-number">0.001844</span>  <span class="hljs-number">0.001482</span>  <span class="hljs-number">0.113858</span>  <span class="hljs-number">0.122908</span>  <span class="hljs-number">0.023387</span></span><br><span class="line">e            <span class="hljs-number">0.336941</span>  <span class="hljs-number">0.215133</span>  <span class="hljs-number">0.178415</span>  <span class="hljs-number">0.147556</span>  <span class="hljs-number">0.083853</span>  <span class="hljs-number">0.067959</span></span><br><span class="line"><span class="hljs-meta">... </span>              ...       ...       ...       ...       ...       ...</span><br><span class="line">v                 NaN  <span class="hljs-number">0.000060</span>  <span class="hljs-number">0.000117</span>  <span class="hljs-number">0.000113</span></span><br><span class="line"><span class="hljs-number">0.000037</span>  <span class="hljs-number">0.001434</span></span><br><span class="line">w            <span class="hljs-number">0.000020</span>  <span class="hljs-number">0.000031</span>  <span class="hljs-number">0.001182</span>  <span class="hljs-number">0.006329</span>  <span class="hljs-number">0.007711</span>  <span class="hljs-number">0.016148</span></span><br><span class="line">x            <span class="hljs-number">0.000015</span>  <span class="hljs-number">0.000037</span>  <span class="hljs-number">0.000727</span>  <span class="hljs-number">0.003965</span>  <span class="hljs-number">0.001851</span>  <span class="hljs-number">0.008614</span></span><br><span class="line">y            <span class="hljs-number">0.110972</span>  <span class="hljs-number">0.152569</span>  <span class="hljs-number">0.116828</span>  <span class="hljs-number">0.077349</span>  <span class="hljs-number">0.160987</span>  <span class="hljs-number">0.058168</span></span><br><span class="line">z            <span class="hljs-number">0.002439</span>  <span class="hljs-number">0.000659</span>  <span class="hljs-number">0.000704</span>  <span class="hljs-number">0.000170</span>  <span class="hljs-number">0.000184</span>  <span class="hljs-number">0.001831</span></span><br><span class="line">[<span class="hljs-number">26</span> rows x <span class="hljs-number">6</span> columns]</span><br></pre></td></tr></table></figure>

<p>有了这个字母比例数据之后，就可以生成一张各年度各性别的条形图了，如图14-8所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))</span><br><span class="line">letter_prop[<span class="hljs-string">'M'</span>].plot(kind=<span class="hljs-string">'bar'</span>, rot=<span class="hljs-number">0</span>, ax=axes[<span class="hljs-number">0</span>], title=<span class="hljs-string">'Male'</span>)</span><br><span class="line">letter_prop[<span class="hljs-string">'F'</span>].plot(kind=<span class="hljs-string">'bar'</span>, rot=<span class="hljs-number">0</span>, ax=axes[<span class="hljs-number">1</span>], title=<span class="hljs-string">'Female'</span>,</span><br><span class="line">                      legend=<span class="hljs-literal">False</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-67686f38e66ef5f1.webp" alt="img"></p>
<p>图14-8 男孩女孩名字中各个末字母的比例</p>
<p>可以看出，从20世纪60年代开始，以字母”n”结尾的男孩名字出现了显著的增长。回到之前创建的那个完整表，按年度和性别对其进行规范化处理，并在男孩名字中选取几个字母，最后进行转置以便将各个列做成一个时间序列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">138</span>]: letter_prop = table / table.sum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">139</span>]: dny_ts = letter_prop.loc[[<span class="hljs-string">'d'</span>, <span class="hljs-string">'n'</span>, <span class="hljs-string">'y'</span>], <span class="hljs-string">'M'</span>].T</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">140</span>]: dny_ts.head()</span><br><span class="line">Out[<span class="hljs-number">140</span>]: </span><br><span class="line">last_letter         d         n         y</span><br><span class="line">year                                     </span><br><span class="line"><span class="hljs-number">1880</span>         <span class="hljs-number">0.083055</span>  <span class="hljs-number">0.153213</span>  <span class="hljs-number">0.075760</span></span><br><span class="line"><span class="hljs-number">1881</span>         <span class="hljs-number">0.083247</span>  <span class="hljs-number">0.153214</span>  <span class="hljs-number">0.077451</span></span><br><span class="line"><span class="hljs-number">1882</span>         <span class="hljs-number">0.085340</span>  <span class="hljs-number">0.149560</span>  <span class="hljs-number">0.077537</span></span><br><span class="line"><span class="hljs-number">1883</span>         <span class="hljs-number">0.084066</span>  <span class="hljs-number">0.151646</span>  <span class="hljs-number">0.079144</span></span><br><span class="line"><span class="hljs-number">1884</span>         <span class="hljs-number">0.086120</span>  <span class="hljs-number">0.149915</span>  <span class="hljs-number">0.080405</span></span><br></pre></td></tr></table></figure>

<p>有了这个时间序列的DataFrame之后，就可以通过其plot方法绘制出一张趋势图了（如图14-9所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">143</span>]: dny_ts.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-51c431b2490424c2.webp" alt="img"></p>
<p>图14-9 各年出生的男孩中名字以d/n/y结尾的人数比例</p>
<h2 id="变成女孩名字的男孩名字（以及相反的情况）"><a href="#变成女孩名字的男孩名字（以及相反的情况）" class="headerlink" title="变成女孩名字的男孩名字（以及相反的情况）"></a>变成女孩名字的男孩名字（以及相反的情况）</h2><p>另一个有趣的趋势是，早年流行于男孩的名字近年来“变性了”，例如Lesley或Leslie。回到top1000数据集，找出其中以”lesl”开头的一组名字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">144</span>]: all_names = pd.Series(top1000.name.unique())</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">145</span>]: lesley_like = all_names[all_names.str.lower().str.contains(<span class="hljs-string">'lesl'</span>)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">146</span>]: lesley_like</span><br><span class="line">Out[<span class="hljs-number">146</span>]: </span><br><span class="line"><span class="hljs-number">632</span>     Leslie</span><br><span class="line"><span class="hljs-number">2294</span>    Lesley</span><br><span class="line"><span class="hljs-number">4262</span>    Leslee</span><br><span class="line"><span class="hljs-number">4728</span>     Lesli</span><br><span class="line"><span class="hljs-number">6103</span>     Lesly</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>然后利用这个结果过滤其他的名字，并按名字分组计算出生数以查看相对频率：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">147</span>]: filtered = top1000[top1000.name.isin(lesley_like)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">148</span>]: filtered.groupby(<span class="hljs-string">'name'</span>).births.sum()</span><br><span class="line">Out[<span class="hljs-number">148</span>]: </span><br><span class="line">name</span><br><span class="line">Leslee      <span class="hljs-number">1082</span></span><br><span class="line">Lesley     <span class="hljs-number">35022</span></span><br><span class="line">Lesli        <span class="hljs-number">929</span></span><br><span class="line">Leslie    <span class="hljs-number">370429</span></span><br><span class="line">Lesly      <span class="hljs-number">10067</span></span><br><span class="line">Name: births, dtype: int64</span><br></pre></td></tr></table></figure>

<p>接下来，我们按性别和年度进行聚合，并按年度进行规范化处理：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">149</span>]: table = filtered.pivot_table(<span class="hljs-string">'births'</span>, index=<span class="hljs-string">'year'</span>,</span><br><span class="line">   .....:                              columns=<span class="hljs-string">'sex'</span>, aggfunc=<span class="hljs-string">'sum'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">150</span>]: table = table.div(table.sum(<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">151</span>]: table.tail()</span><br><span class="line">Out[<span class="hljs-number">151</span>]: </span><br><span class="line">sex     F   M</span><br><span class="line">year         </span><br><span class="line"><span class="hljs-number">2006</span>  <span class="hljs-number">1.0</span> NaN</span><br><span class="line"><span class="hljs-number">2007</span>  <span class="hljs-number">1.0</span> NaN</span><br><span class="line"><span class="hljs-number">2008</span>  <span class="hljs-number">1.0</span> NaN</span><br><span class="line"><span class="hljs-number">2009</span>  <span class="hljs-number">1.0</span> NaN</span><br><span class="line"><span class="hljs-number">2010</span>  <span class="hljs-number">1.0</span> NaN</span><br></pre></td></tr></table></figure>

<p>最后，就可以轻松绘制一张分性别的年度曲线图了（如图2-10所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">153</span>]: table.plot(style=&#123;<span class="hljs-string">'M'</span>: <span class="hljs-string">'k-'</span>, <span class="hljs-string">'F'</span>: <span class="hljs-string">'k--'</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-b99d98f8bb5fc695.webp" alt="img"></p>
<p>图14-10 各年度使用“Lesley型”名字的男女比例</p>
<h1 id="14-4-USDA食品数据库"><a href="#14-4-USDA食品数据库" class="headerlink" title="14.4 USDA食品数据库"></a>14.4 USDA食品数据库</h1><p>美国农业部（USDA）制作了一份有关食物营养信息的数据库。Ashley Williams制作了该数据的JSON版（<a href="http://ashleyw.co.uk/project/food-nutrient-database）。其中的记录如下所示：" target="_blank" rel="noopener">http://ashleyw.co.uk/project/food-nutrient-database）。其中的记录如下所示：</a></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-string">"id"</span>: <span class="hljs-number">21441</span>,</span><br><span class="line">  <span class="hljs-string">"description"</span>: <span class="hljs-string">"KENTUCKY FRIED CHICKEN, Fried Chicken, EXTRA CRISPY,</span></span><br><span class="line"><span class="hljs-string">Wing, meat and skin with breading"</span>,</span><br><span class="line">  <span class="hljs-string">"tags"</span>: [<span class="hljs-string">"KFC"</span>],</span><br><span class="line">  <span class="hljs-string">"manufacturer"</span>: <span class="hljs-string">"Kentucky Fried Chicken"</span>,</span><br><span class="line"><span class="hljs-string">"group"</span>: <span class="hljs-string">"Fast Foods"</span>,</span><br><span class="line">  <span class="hljs-string">"portions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="hljs-string">"amount"</span>: <span class="hljs-number">1</span>,</span><br><span class="line">      <span class="hljs-string">"unit"</span>: <span class="hljs-string">"wing, with skin"</span>,</span><br><span class="line">      <span class="hljs-string">"grams"</span>: <span class="hljs-number">68.0</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">  <span class="hljs-string">"nutrients"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="hljs-string">"value"</span>: <span class="hljs-number">20.8</span>,</span><br><span class="line">      <span class="hljs-string">"units"</span>: <span class="hljs-string">"g"</span>,</span><br><span class="line">      <span class="hljs-string">"description"</span>: <span class="hljs-string">"Protein"</span>,</span><br><span class="line">      <span class="hljs-string">"group"</span>: <span class="hljs-string">"Composition"</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每种食物都带有若干标识性属性以及两个有关营养成分和分量的列表。这种形式的数据不是很适合分析工作，因此我们需要做一些规整化以使其具有更好用的形式。</p>
<p>从上面列举的那个网址下载并解压数据之后，你可以用任何喜欢的JSON库将其加载到Python中。我用的是Python内置的json模块：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">154</span>]: <span class="hljs-keyword">import</span> json</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">155</span>]: db = json.load(open(<span class="hljs-string">'datasets/usda_food/database.json'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">156</span>]: len(db)</span><br><span class="line">Out[<span class="hljs-number">156</span>]: <span class="hljs-number">6636</span></span><br></pre></td></tr></table></figure>

<p>db中的每个条目都是一个含有某种食物全部数据的字典。nutrients字段是一个字典列表，其中的每个字典对应一种营养成分：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">157</span>]: db[<span class="hljs-number">0</span>].keys()</span><br><span class="line">Out[<span class="hljs-number">157</span>]: dict_keys([<span class="hljs-string">'id'</span>, <span class="hljs-string">'description'</span>, <span class="hljs-string">'tags'</span>, <span class="hljs-string">'manufacturer'</span>, <span class="hljs-string">'group'</span>, <span class="hljs-string">'porti</span></span><br><span class="line"><span class="hljs-string">ons'</span>, <span class="hljs-string">'nutrients'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: db[<span class="hljs-number">0</span>][<span class="hljs-string">'nutrients'</span>][<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">158</span>]: </span><br><span class="line">&#123;<span class="hljs-string">'description'</span>: <span class="hljs-string">'Protein'</span>,</span><br><span class="line"> <span class="hljs-string">'group'</span>: <span class="hljs-string">'Composition'</span>,</span><br><span class="line"> <span class="hljs-string">'units'</span>: <span class="hljs-string">'g'</span>,</span><br><span class="line"> <span class="hljs-string">'value'</span>: <span class="hljs-number">25.18</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">159</span>]: nutrients = pd.DataFrame(db[<span class="hljs-number">0</span>][<span class="hljs-string">'nutrients'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">160</span>]: nutrients[:<span class="hljs-number">7</span>]</span><br><span class="line">Out[<span class="hljs-number">160</span>]: </span><br><span class="line">                   description        group units    value</span><br><span class="line"><span class="hljs-number">0</span>                      Protein  Composition     g    <span class="hljs-number">25.18</span></span><br><span class="line"><span class="hljs-number">1</span>            Total lipid (fat)  Composition     g    <span class="hljs-number">29.20</span></span><br><span class="line"><span class="hljs-number">2</span>  Carbohydrate, by difference  Composition     g     <span class="hljs-number">3.06</span></span><br><span class="line"><span class="hljs-number">3</span>                          Ash        Other     g     <span class="hljs-number">3.28</span></span><br><span class="line"><span class="hljs-number">4</span>                       Energy       Energy  kcal   <span class="hljs-number">376.00</span></span><br><span class="line"><span class="hljs-number">5</span>                        Water  Composition     g    <span class="hljs-number">39.28</span></span><br><span class="line"><span class="hljs-number">6</span>                       Energy       Energy    kJ  <span class="hljs-number">1573.00</span></span><br></pre></td></tr></table></figure>

<p>在将字典列表转换为DataFrame时，可以只抽取其中的一部分字段。这里，我们将取出食物的名称、分类、编号以及制造商等信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">161</span>]: info_keys = [<span class="hljs-string">'description'</span>, <span class="hljs-string">'group'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'manufacturer'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: info = pd.DataFrame(db, columns=info_keys)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">163</span>]: info[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">163</span>]: </span><br><span class="line">                          description                   group    id  \</span><br><span class="line"><span class="hljs-number">0</span>                     Cheese, caraway  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1008</span>   </span><br><span class="line"><span class="hljs-number">1</span>                     Cheese, cheddar  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1009</span></span><br><span class="line"><span class="hljs-number">2</span>                        Cheese, edam  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1018</span>   </span><br><span class="line"><span class="hljs-number">3</span>                        Cheese, feta  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1019</span>   </span><br><span class="line"><span class="hljs-number">4</span>  Cheese, mozzarella, part skim milk  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1028</span>   </span><br><span class="line">  manufacturer  </span><br><span class="line"><span class="hljs-number">0</span>               </span><br><span class="line"><span class="hljs-number">1</span>               </span><br><span class="line"><span class="hljs-number">2</span>               </span><br><span class="line"><span class="hljs-number">3</span>               </span><br><span class="line"><span class="hljs-number">4</span>               </span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">164</span>]: info.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">RangeIndex</span>:</span> <span class="hljs-number">6636</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">6635</span></span><br><span class="line">Data columns (total <span class="hljs-number">4</span> columns):</span><br><span class="line">description     <span class="hljs-number">6636</span> non-null object</span><br><span class="line">group           <span class="hljs-number">6636</span> non-null object</span><br><span class="line">id              <span class="hljs-number">6636</span> non-null int64</span><br><span class="line">manufacturer    <span class="hljs-number">5195</span> non-null object</span><br><span class="line">dtypes: int64(<span class="hljs-number">1</span>), object(<span class="hljs-number">3</span>)</span><br><span class="line">memory usage: <span class="hljs-number">207.5</span>+ KB</span><br></pre></td></tr></table></figure>

<p>通过value_counts，你可以查看食物类别的分布情况：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">165</span>]: pd.value_counts(info.group)[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">165</span>]: </span><br><span class="line">Vegetables <span class="hljs-keyword">and</span> Vegetable Products    <span class="hljs-number">812</span></span><br><span class="line">Beef Products                        <span class="hljs-number">618</span></span><br><span class="line">Baked Products                       <span class="hljs-number">496</span></span><br><span class="line">Breakfast Cereals                    <span class="hljs-number">403</span></span><br><span class="line">Fast Foods                           <span class="hljs-number">365</span></span><br><span class="line">Legumes <span class="hljs-keyword">and</span> Legume Products          <span class="hljs-number">365</span></span><br><span class="line">Lamb, Veal, <span class="hljs-keyword">and</span> Game Products        <span class="hljs-number">345</span></span><br><span class="line">Sweets                               <span class="hljs-number">341</span></span><br><span class="line">Pork Products                        <span class="hljs-number">328</span></span><br><span class="line">Fruits <span class="hljs-keyword">and</span> Fruit Juices              <span class="hljs-number">328</span></span><br><span class="line">Name: group, dtype: int64</span><br></pre></td></tr></table></figure>

<p>现在，为了对全部营养数据做一些分析，最简单的办法是将所有食物的营养成分整合到一个大表中。我们分几个步骤来实现该目的。首先，将各食物的营养成分列表转换为一个DataFrame，并添加一个表示编号的列，然后将该DataFrame添加到一个列表中。最后通过concat将这些东西连接起来就可以了：</p>
<p>顺利的话，nutrients的结果是：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">167</span>]: nutrients</span><br><span class="line">Out[<span class="hljs-number">167</span>]: </span><br><span class="line">                               description        group units    value     id</span><br><span class="line"><span class="hljs-number">0</span>                                  Protein  Composition     g   <span class="hljs-number">25.180</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">1</span>                        Total lipid (fat)  Composition     g   <span class="hljs-number">29.200</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">2</span>              Carbohydrate, by difference  Composition     g    <span class="hljs-number">3.060</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">3</span>                                      Ash        Other     g    <span class="hljs-number">3.280</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">4</span>                                   Energy       Energy  kcal  <span class="hljs-number">376.000</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-meta">... </span>                                   ...          ...</span><br><span class="line"><span class="hljs-meta">... </span>     ...    ...</span><br><span class="line"><span class="hljs-number">389350</span>                 Vitamin B<span class="hljs-number">-12</span>, added     Vitamins   mcg    <span class="hljs-number">0.000</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389351</span>                         Cholesterol        Other    mg    <span class="hljs-number">0.000</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389352</span>        Fatty acids, total saturated        Other     g    <span class="hljs-number">0.072</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389353</span>  Fatty acids, total monounsaturated        Other     g    <span class="hljs-number">0.028</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389354</span>  Fatty acids, total polyunsaturated        Other     g    <span class="hljs-number">0.041</span>  <span class="hljs-number">43546</span></span><br><span class="line">[<span class="hljs-number">389355</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>我发现这个DataFrame中无论如何都会有一些重复项，所以直接丢弃就可以了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">168</span>]: nutrients.duplicated().sum()  <span class="hljs-comment"># number of duplicates</span></span><br><span class="line">Out[<span class="hljs-number">168</span>]: <span class="hljs-number">14179</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">169</span>]: nutrients = nutrients.drop_duplicates()</span><br></pre></td></tr></table></figure>

<p>由于两个DataFrame对象中都有”group”和”description”，所以为了明确到底谁是谁，我们需要对它们进行重命名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">170</span>]: col_mapping = &#123;<span class="hljs-string">'description'</span> : <span class="hljs-string">'food'</span>,</span><br><span class="line">   .....:                <span class="hljs-string">'group'</span>       : <span class="hljs-string">'fgroup'</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">171</span>]: info = info.rename(columns=col_mapping, copy=<span class="hljs-literal">False</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">172</span>]: info.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">RangeIndex</span>:</span> <span class="hljs-number">6636</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">6635</span></span><br><span class="line">Data columns (total <span class="hljs-number">4</span> columns):</span><br><span class="line">food            <span class="hljs-number">6636</span> non-null object</span><br><span class="line">fgroup          <span class="hljs-number">6636</span> non-null object</span><br><span class="line">id              <span class="hljs-number">6636</span> non-null int64</span><br><span class="line">manufacturer    <span class="hljs-number">5195</span> non-null object</span><br><span class="line">dtypes: int64(<span class="hljs-number">1</span>), object(<span class="hljs-number">3</span>)</span><br><span class="line">memory usage: <span class="hljs-number">207.5</span>+ KB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">173</span>]: col_mapping = &#123;<span class="hljs-string">'description'</span> : <span class="hljs-string">'nutrient'</span>,</span><br><span class="line">   .....:                <span class="hljs-string">'group'</span> : <span class="hljs-string">'nutgroup'</span>&#125;</span><br><span class="line">In [<span class="hljs-number">174</span>]: nutrients = nutrients.rename(columns=col_mapping, copy=<span class="hljs-literal">False</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">175</span>]: nutrients</span><br><span class="line">Out[<span class="hljs-number">175</span>]: </span><br><span class="line">                                  nutrient     nutgroup units    value     id</span><br><span class="line"><span class="hljs-number">0</span>                                  Protein  Composition     g   <span class="hljs-number">25.180</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">1</span>                        Total lipid (fat)  Composition     g   <span class="hljs-number">29.200</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">2</span>              Carbohydrate, by difference  Composition     g    <span class="hljs-number">3.060</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">3</span>                                      Ash        Other     g    <span class="hljs-number">3.280</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">4</span>                                   Energy       Energy  kcal  <span class="hljs-number">376.000</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-meta">... </span>                                   ...          ...   ...      ...    ...</span><br><span class="line"><span class="hljs-number">389350</span>                 Vitamin B<span class="hljs-number">-12</span>, added     Vitamins   mcg    <span class="hljs-number">0.000</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389351</span>                         Cholesterol        Other    mg    <span class="hljs-number">0.000</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389352</span>        Fatty acids, total saturated        Other     g    <span class="hljs-number">0.072</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389353</span>  Fatty acids, total monounsaturated        Other     g    <span class="hljs-number">0.028</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389354</span>  Fatty acids, total polyunsaturated        Other     g    <span class="hljs-number">0.041</span>  <span class="hljs-number">43546</span></span><br><span class="line">[<span class="hljs-number">375176</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>做完这些，就可以将info跟nutrients合并起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">176</span>]: ndata = pd.merge(nutrients, info, on=<span class="hljs-string">'id'</span>, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">177</span>]: ndata.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">Int64Index</span>:</span> <span class="hljs-number">375176</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">375175</span></span><br><span class="line">Data columns (total <span class="hljs-number">8</span> columns):</span><br><span class="line">nutrient        <span class="hljs-number">375176</span> non-null object</span><br><span class="line">nutgroup        <span class="hljs-number">375176</span> non-null object</span><br><span class="line">units           <span class="hljs-number">375176</span> non-null object</span><br><span class="line">value           <span class="hljs-number">375176</span> non-null float64</span><br><span class="line">id              <span class="hljs-number">375176</span> non-null int64</span><br><span class="line">food            <span class="hljs-number">375176</span> non-null object</span><br><span class="line">fgroup          <span class="hljs-number">375176</span> non-null object</span><br><span class="line">manufacturer    <span class="hljs-number">293054</span> non-null object</span><br><span class="line">dtypes: float64(<span class="hljs-number">1</span>), int64(<span class="hljs-number">1</span>), object(<span class="hljs-number">6</span>)</span><br><span class="line">memory usage: <span class="hljs-number">25.8</span>+ MB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">178</span>]: ndata.iloc[<span class="hljs-number">30000</span>]</span><br><span class="line">Out[<span class="hljs-number">178</span>]: </span><br><span class="line">nutrient                                       Glycine</span><br><span class="line">nutgroup                                   Amino Acids</span><br><span class="line">units                                                g</span><br><span class="line">value                                             <span class="hljs-number">0.04</span></span><br><span class="line">id                                                <span class="hljs-number">6158</span></span><br><span class="line">food            Soup, tomato bisque, canned, condensed</span><br><span class="line">fgroup                      Soups, Sauces, <span class="hljs-keyword">and</span> Gravies</span><br><span class="line">manufacturer                                          </span><br><span class="line">Name: <span class="hljs-number">30000</span>, dtype: object</span><br></pre></td></tr></table></figure>

<p>我们现在可以根据食物分类和营养类型画出一张中位值图（如图14-11所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">180</span>]: result = ndata.groupby([<span class="hljs-string">'nutrient'</span>, <span class="hljs-string">'fgroup'</span>])[<span class="hljs-string">'value'</span>].quantile(<span class="hljs-number">0.5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">181</span>]: result[<span class="hljs-string">'Zinc, Zn'</span>].sort_values().plot(kind=<span class="hljs-string">'barh'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-99b176d022a444c0.webp" alt="img"></p>
<p>图片14-11 根据营养分类得出的锌中位值</p>
<p>只要稍微动一动脑子，就可以发现各营养成分最为丰富的食物是什么了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">by_nutrient = ndata.groupby([<span class="hljs-string">'nutgroup'</span>, <span class="hljs-string">'nutrient'</span>])</span><br><span class="line"></span><br><span class="line">get_maximum = <span class="hljs-keyword">lambda</span> x: x.loc[x.value.idxmax()]</span><br><span class="line">get_minimum = <span class="hljs-keyword">lambda</span> x: x.loc[x.value.idxmin()]</span><br><span class="line"></span><br><span class="line">max_foods = by_nutrient.apply(get_maximum)[[<span class="hljs-string">'value'</span>, <span class="hljs-string">'food'</span>]]</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># make the food a little smaller</span></span><br><span class="line">max_foods.food = max_foods.food.str[:<span class="hljs-number">50</span>]</span><br></pre></td></tr></table></figure>

<p>由于得到的DataFrame很大，所以不方便在书里面全部打印出来。这里只给出”Amino Acids”营养分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">183</span>]: max_foods.loc[<span class="hljs-string">'Amino Acids'</span>][<span class="hljs-string">'food'</span>]</span><br><span class="line">Out[<span class="hljs-number">183</span>]: </span><br><span class="line">nutrient</span><br><span class="line">Alanine                          Gelatins, dry powder, unsweetened</span><br><span class="line">Arginine                              Seeds, sesame flour, low-fat</span><br><span class="line">Aspartic acid                                  Soy protein isolate</span><br><span class="line">Cystine               Seeds, cottonseed flour, low fat (glandless)</span><br><span class="line">Glutamic acid                                  Soy protein isolate</span><br><span class="line">                                       ...                        </span><br><span class="line">Serine           Soy protein isolate, PROTEIN TECHNOLOGIES INTE...</span><br><span class="line">Threonine        Soy protein isolate, PROTEIN TECHNOLOGIES INTE...</span><br><span class="line">Tryptophan        Sea lion, Steller, meat <span class="hljs-keyword">with</span> fat (Alaska Native)</span><br><span class="line">Tyrosine         Soy protein isolate, PROTEIN TECHNOLOGIES INTE...</span><br><span class="line">Valine           Soy protein isolate, PROTEIN TECHNOLOGIES INTE...</span><br><span class="line">Name: food, Length: <span class="hljs-number">19</span>, dtype: object</span><br></pre></td></tr></table></figure>

<h1 id="14-5-2012联邦选举委员会数据库"><a href="#14-5-2012联邦选举委员会数据库" class="headerlink" title="14.5 2012联邦选举委员会数据库"></a>14.5 2012联邦选举委员会数据库</h1><p>美国联邦选举委员会发布了有关政治竞选赞助方面的数据。其中包括赞助者的姓名、职业、雇主、地址以及出资额等信息。我们对2012年美国总统大选的数据集比较感兴趣（<a href="http://www.fec.gov/disclosurep/PDownload.do）。我在2012年6月下载的数据集是一个150MB的CSV文件（P00000001-ALL.csv），我们先用pandas.read_csv将其加载进来：" target="_blank" rel="noopener">http://www.fec.gov/disclosurep/PDownload.do）。我在2012年6月下载的数据集是一个150MB的CSV文件（P00000001-ALL.csv），我们先用pandas.read_csv将其加载进来：</a></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">184</span>]: fec = pd.read_csv(<span class="hljs-string">'datasets/fec/P00000001-ALL.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">185</span>]: fec.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">RangeIndex</span>:</span> <span class="hljs-number">1001731</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">1001730</span></span><br><span class="line">Data columns (total <span class="hljs-number">16</span> columns):</span><br><span class="line">cmte_id              <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">cand_id              <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">cand_nm              <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">contbr_nm            <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">contbr_city          <span class="hljs-number">1001712</span> non-null object</span><br><span class="line">contbr_st            <span class="hljs-number">1001727</span> non-null object</span><br><span class="line">contbr_zip           <span class="hljs-number">1001620</span> non-null object</span><br><span class="line">contbr_employer      <span class="hljs-number">988002</span> non-null object</span><br><span class="line">contbr_occupation    <span class="hljs-number">993301</span> non-null object</span><br><span class="line">contb_receipt_amt    <span class="hljs-number">1001731</span> non-null float64</span><br><span class="line">contb_receipt_dt     <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">receipt_desc         <span class="hljs-number">14166</span> non-null object</span><br><span class="line">memo_cd              <span class="hljs-number">92482</span> non-null object</span><br><span class="line">memo_text            <span class="hljs-number">97770</span> non-null object</span><br><span class="line">form_tp              <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">file_num             <span class="hljs-number">1001731</span> non-null int64</span><br><span class="line">dtypes: float64(<span class="hljs-number">1</span>), int64(<span class="hljs-number">1</span>), object(<span class="hljs-number">14</span>)</span><br><span class="line">memory usage: <span class="hljs-number">122.3</span>+ MB</span><br></pre></td></tr></table></figure>

<p>该DataFrame中的记录如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">186</span>]: fec.iloc[<span class="hljs-number">123456</span>]</span><br><span class="line">Out[<span class="hljs-number">186</span>]: </span><br><span class="line">cmte_id             C00431445</span><br><span class="line">cand_id             P80003338</span><br><span class="line">cand_nm         Obama, Barack</span><br><span class="line">contbr_nm         ELLMAN, IRA</span><br><span class="line">contbr_city             TEMPE</span><br><span class="line">                    ...      </span><br><span class="line">receipt_desc              NaN</span><br><span class="line">memo_cd                   NaN</span><br><span class="line">memo_text                 NaN</span><br><span class="line">form_tp                 SA17A</span><br><span class="line">file_num               <span class="hljs-number">772372</span></span><br><span class="line">Name: <span class="hljs-number">123456</span>, Length: <span class="hljs-number">16</span>, dtype: object</span><br></pre></td></tr></table></figure>

<p>你可能已经想出了许多办法从这些竞选赞助数据中抽取有关赞助人和赞助模式的统计信息。我将在接下来的内容中介绍几种不同的分析工作（运用到目前为止已经学到的方法）。</p>
<p>不难看出，该数据中没有党派信息，因此最好把它加进去。通过unique，你可以获取全部的候选人名单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">187</span>]: unique_cands = fec.cand_nm.unique()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">188</span>]: unique_cands</span><br><span class="line">Out[<span class="hljs-number">188</span>]: </span><br><span class="line">array([<span class="hljs-string">'Bachmann, Michelle'</span>, <span class="hljs-string">'Romney, Mitt'</span>, <span class="hljs-string">'Obama, Barack'</span>,</span><br><span class="line">       <span class="hljs-string">"Roemer, Charles E. 'Buddy' III"</span>, <span class="hljs-string">'Pawlenty, Timothy'</span>,</span><br><span class="line">       <span class="hljs-string">'Johnson, Gary Earl'</span>, <span class="hljs-string">'Paul, Ron'</span>, <span class="hljs-string">'Santorum, Rick'</span>, <span class="hljs-string">'Cain, Herman'</span>,</span><br><span class="line">       <span class="hljs-string">'Gingrich, Newt'</span>, <span class="hljs-string">'McCotter, Thaddeus G'</span>, <span class="hljs-string">'Huntsman, Jon'</span>,</span><br><span class="line">       <span class="hljs-string">'Perry, Rick'</span>], dtype=object)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">189</span>]: unique_cands[<span class="hljs-number">2</span>]</span><br><span class="line">Out[<span class="hljs-number">189</span>]: <span class="hljs-string">'Obama, Barack'</span></span><br></pre></td></tr></table></figure>

<p>指明党派信息的方法之一是使用字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">parties = &#123;<span class="hljs-string">'Bachmann, Michelle'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Cain, Herman'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Gingrich, Newt'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Huntsman, Jon'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Johnson, Gary Earl'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'McCotter, Thaddeus G'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Obama, Barack'</span>: <span class="hljs-string">'Democrat'</span>,</span><br><span class="line">           <span class="hljs-string">'Paul, Ron'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Pawlenty, Timothy'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Perry, Rick'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">"Roemer, Charles E. 'Buddy' III"</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Romney, Mitt'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Santorum, Rick'</span>: <span class="hljs-string">'Republican'</span>&#125;</span><br></pre></td></tr></table></figure>

<p>现在，通过这个映射以及Series对象的map方法，你可以根据候选人姓名得到一组党派信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">191</span>]: fec.cand_nm[<span class="hljs-number">123456</span>:<span class="hljs-number">123461</span>]</span><br><span class="line">Out[<span class="hljs-number">191</span>]: </span><br><span class="line"><span class="hljs-number">123456</span>    Obama, Barack</span><br><span class="line"><span class="hljs-number">123457</span>    Obama, Barack</span><br><span class="line"><span class="hljs-number">123458</span>    Obama, Barack</span><br><span class="line"><span class="hljs-number">123459</span>    Obama, Barack</span><br><span class="line"><span class="hljs-number">123460</span>    Obama, Barack</span><br><span class="line">Name: cand_nm, dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">192</span>]: fec.cand_nm[<span class="hljs-number">123456</span>:<span class="hljs-number">123461</span>].map(parties)</span><br><span class="line">Out[<span class="hljs-number">192</span>]: </span><br><span class="line"><span class="hljs-number">123456</span>    Democrat</span><br><span class="line"><span class="hljs-number">123457</span>    Democrat</span><br><span class="line"><span class="hljs-number">123458</span>    Democrat</span><br><span class="line"><span class="hljs-number">123459</span>    Democrat</span><br><span class="line"><span class="hljs-number">123460</span>    Democrat</span><br><span class="line">Name: cand_nm, dtype: object</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Add it as a column</span></span><br><span class="line">In [<span class="hljs-number">193</span>]: fec[<span class="hljs-string">'party'</span>] = fec.cand_nm.map(parties)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">194</span>]: fec[<span class="hljs-string">'party'</span>].value_counts()</span><br><span class="line">Out[<span class="hljs-number">194</span>]: </span><br><span class="line">Democrat      <span class="hljs-number">593746</span></span><br><span class="line">Republican    <span class="hljs-number">407985</span></span><br><span class="line">Name: party, dtype: int64</span><br></pre></td></tr></table></figure>

<p>这里有两个需要注意的地方。第一，该数据既包括赞助也包括退款（负的出资额）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">195</span>]: (fec.contb_receipt_amt &gt; <span class="hljs-number">0</span>).value_counts()</span><br><span class="line">Out[<span class="hljs-number">195</span>]: </span><br><span class="line"><span class="hljs-literal">True</span>     <span class="hljs-number">991475</span></span><br><span class="line"><span class="hljs-literal">False</span>     <span class="hljs-number">10256</span></span><br><span class="line">Name: contb_receipt_amt, dtype: int64</span><br></pre></td></tr></table></figure>

<p>为了简化分析过程，我限定该数据集只能有正的出资额：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">196</span>]: fec = fec[fec.contb_receipt_amt &gt; <span class="hljs-number">0</span>]</span><br></pre></td></tr></table></figure>

<p>由于Barack Obama和Mitt Romney是最主要的两名候选人，所以我还专门准备了一个子集，只包含针对他们两人的竞选活动的赞助信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">197</span>]: fec_mrbo = fec[fec.cand_nm.isin([<span class="hljs-string">'Obama, Barack'</span>,<span class="hljs-string">'Romney, Mitt'</span>])]</span><br></pre></td></tr></table></figure>

<h2 id="根据职业和雇主统计赞助信息"><a href="#根据职业和雇主统计赞助信息" class="headerlink" title="根据职业和雇主统计赞助信息"></a>根据职业和雇主统计赞助信息</h2><p>基于职业的赞助信息统计是另一种经常被研究的统计任务。例如，律师们更倾向于资助民主党，而企业主则更倾向于资助共和党。你可以不相信我，自己看那些数据就知道了。首先，根据职业计算出资总额，这很简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">198</span>]: fec.contbr_occupation.value_counts()[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">198</span>]: </span><br><span class="line">RETIRED                                   <span class="hljs-number">233990</span></span><br><span class="line">INFORMATION REQUESTED                      <span class="hljs-number">35107</span></span><br><span class="line">ATTORNEY                                   <span class="hljs-number">34286</span></span><br><span class="line">HOMEMAKER                                  <span class="hljs-number">29931</span></span><br><span class="line">PHYSICIAN                                  <span class="hljs-number">23432</span></span><br><span class="line">INFORMATION REQUESTED PER BEST EFFORTS     <span class="hljs-number">21138</span></span><br><span class="line">ENGINEER                                   <span class="hljs-number">14334</span></span><br><span class="line">TEACHER                                    <span class="hljs-number">13990</span></span><br><span class="line">CONSULTANT                                 <span class="hljs-number">13273</span></span><br><span class="line">PROFESSOR                                  <span class="hljs-number">12555</span></span><br><span class="line">Name: contbr_occupation, dtype: int64</span><br></pre></td></tr></table></figure>

<p>不难看出，许多职业都涉及相同的基本工作类型，或者同一样东西有多种变体。下面的代码片段可以清理一些这样的数据（将一个职业信息映射到另一个）。注意，这里巧妙地利用了dict.get，它允许没有映射关系的职业也能“通过”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">occ_mapping = &#123;</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED PER BEST EFFORTS'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED (BEST EFFORTS)'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'C.E.O.'</span>: <span class="hljs-string">'CEO'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># If no mapping provided, return x</span></span><br><span class="line">f = <span class="hljs-keyword">lambda</span> x: occ_mapping.get(x, x)</span><br><span class="line">fec.contbr_occupation = fec.contbr_occupation.map(f)</span><br></pre></td></tr></table></figure>

<p>我对雇主信息也进行了同样的处理：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">emp_mapping = &#123;</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED PER BEST EFFORTS'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'SELF'</span> : <span class="hljs-string">'SELF-EMPLOYED'</span>,</span><br><span class="line">   <span class="hljs-string">'SELF EMPLOYED'</span> : <span class="hljs-string">'SELF-EMPLOYED'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># If no mapping provided, return x</span></span><br><span class="line">f = <span class="hljs-keyword">lambda</span> x: emp_mapping.get(x, x)</span><br><span class="line">fec.contbr_employer = fec.contbr_employer.map(f)</span><br></pre></td></tr></table></figure>

<p>现在，你可以通过pivot_table根据党派和职业对数据进行聚合，然后过滤掉总出资额不足200万美元的数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">201</span>]: by_occupation = fec.pivot_table(<span class="hljs-string">'contb_receipt_amt'</span>,</span><br><span class="line">   .....:                                 index=<span class="hljs-string">'contbr_occupation'</span>,</span><br><span class="line">   .....:                                 columns=<span class="hljs-string">'party'</span>, aggfunc=<span class="hljs-string">'sum'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">202</span>]: over_2mm = by_occupation[by_occupation.sum(<span class="hljs-number">1</span>) &gt; <span class="hljs-number">2000000</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">203</span>]: over_2mm</span><br><span class="line">Out[<span class="hljs-number">203</span>]: </span><br><span class="line">party                 Democrat    Republican</span><br><span class="line">contbr_occupation                           </span><br><span class="line">ATTORNEY           <span class="hljs-number">11141982.97</span>  <span class="hljs-number">7.477194e+06</span></span><br><span class="line">CEO                 <span class="hljs-number">2074974.79</span>  <span class="hljs-number">4.211041e+06</span></span><br><span class="line">CONSULTANT          <span class="hljs-number">2459912.71</span>  <span class="hljs-number">2.544725e+06</span></span><br><span class="line">ENGINEER             <span class="hljs-number">951525.55</span>  <span class="hljs-number">1.818374e+06</span></span><br><span class="line">EXECUTIVE           <span class="hljs-number">1355161.05</span>  <span class="hljs-number">4.138850e+06</span></span><br><span class="line"><span class="hljs-meta">... </span>                       ...           ...</span><br><span class="line">PRESIDENT           <span class="hljs-number">1878509.95</span>  <span class="hljs-number">4.720924e+06</span></span><br><span class="line">PROFESSOR           <span class="hljs-number">2165071.08</span>  <span class="hljs-number">2.967027e+05</span></span><br><span class="line">REAL ESTATE          <span class="hljs-number">528902.09</span>  <span class="hljs-number">1.625902e+06</span></span><br><span class="line">RETIRED            <span class="hljs-number">25305116.38</span>  <span class="hljs-number">2.356124e+07</span></span><br><span class="line">SELF-EMPLOYED        <span class="hljs-number">672393.40</span>  <span class="hljs-number">1.640253e+06</span></span><br><span class="line">[<span class="hljs-number">17</span> rows x <span class="hljs-number">2</span> columns]</span><br></pre></td></tr></table></figure>

<p>把这些数据做成柱状图看起来会更加清楚（’barh’表示水平柱状图，如图14-12所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">205</span>]: over_2mm.plot(kind=<span class="hljs-string">'barh'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-d2254e547c6ce537.webp" alt="img"></p>
<p>图14-12 对各党派总出资额最高的职业</p>
<p>你可能还想了解一下对Obama和Romney总出资额最高的职业和企业。为此，我们先对候选人进行分组，然后使用本章前面介绍的类似top的方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_top_amounts</span><span class="hljs-params">(group, key, n=<span class="hljs-number">5</span>)</span>:</span></span><br><span class="line">    totals = group.groupby(key)[<span class="hljs-string">'contb_receipt_amt'</span>].sum()</span><br><span class="line">    <span class="hljs-keyword">return</span> totals.nlargest(n)</span><br></pre></td></tr></table></figure>

<p>然后根据职业和雇主进行聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">207</span>]: grouped = fec_mrbo.groupby(<span class="hljs-string">'cand_nm'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">208</span>]: grouped.apply(get_top_amounts, <span class="hljs-string">'contbr_occupation'</span>, n=<span class="hljs-number">7</span>)</span><br><span class="line">Out[<span class="hljs-number">208</span>]: </span><br><span class="line">cand_nm        contbr_occupation    </span><br><span class="line">Obama, Barack  RETIRED                  <span class="hljs-number">25305116.38</span></span><br><span class="line">               ATTORNEY                 <span class="hljs-number">11141982.97</span></span><br><span class="line">               INFORMATION REQUESTED     <span class="hljs-number">4866973.96</span></span><br><span class="line">               HOMEMAKER                 <span class="hljs-number">4248875.80</span></span><br><span class="line">               PHYSICIAN                 <span class="hljs-number">3735124.94</span></span><br><span class="line">                                           ...     </span><br><span class="line">Romney, Mitt   HOMEMAKER                 <span class="hljs-number">8147446.22</span></span><br><span class="line">               ATTORNEY                  <span class="hljs-number">5364718.82</span></span><br><span class="line">               PRESIDENT                 <span class="hljs-number">2491244.89</span></span><br><span class="line">               EXECUTIVE                 <span class="hljs-number">2300947.03</span></span><br><span class="line">               C.E.O.                    <span class="hljs-number">1968386.11</span></span><br><span class="line">Name: contb_receipt_amt, Length: <span class="hljs-number">14</span>, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">209</span>]: grouped.apply(get_top_amounts, <span class="hljs-string">'contbr_employer'</span>, n=<span class="hljs-number">10</span>)</span><br><span class="line">Out[<span class="hljs-number">209</span>]: </span><br><span class="line">cand_nm        contbr_employer      </span><br><span class="line">Obama, Barack  RETIRED                  <span class="hljs-number">22694358.85</span></span><br><span class="line">               SELF-EMPLOYED            <span class="hljs-number">17080985.96</span></span><br><span class="line">               NOT EMPLOYED              <span class="hljs-number">8586308.70</span></span><br><span class="line">               INFORMATION REQUESTED     <span class="hljs-number">5053480.37</span></span><br><span class="line">               HOMEMAKER                 <span class="hljs-number">2605408.54</span></span><br><span class="line">                                           ...     </span><br><span class="line">Romney, Mitt   CREDIT SUISSE              <span class="hljs-number">281150.00</span></span><br><span class="line">               MORGAN STANLEY             <span class="hljs-number">267266.00</span></span><br><span class="line">               GOLDMAN SACH &amp; CO.         <span class="hljs-number">238250.00</span></span><br><span class="line">               BARCLAYS CAPITAL           <span class="hljs-number">162750.00</span></span><br><span class="line">               H.I.G. CAPITAL             <span class="hljs-number">139500.00</span></span><br><span class="line">Name: contb_receipt_amt, Length: <span class="hljs-number">20</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="对出资额分组"><a href="#对出资额分组" class="headerlink" title="对出资额分组"></a>对出资额分组</h2><p>还可以对该数据做另一种非常实用的分析：利用cut函数根据出资额的大小将数据离散化到多个面元中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">210</span>]: bins = np.array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>,</span><br><span class="line">   .....:                  <span class="hljs-number">100000</span>, <span class="hljs-number">1000000</span>, <span class="hljs-number">10000000</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">211</span>]: labels = pd.cut(fec_mrbo.contb_receipt_amt, bins)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">212</span>]: labels</span><br><span class="line">Out[<span class="hljs-number">212</span>]: </span><br><span class="line"><span class="hljs-number">411</span>         (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line"><span class="hljs-number">412</span>       (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]</span><br><span class="line"><span class="hljs-number">413</span>       (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]</span><br><span class="line"><span class="hljs-number">414</span>         (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line"><span class="hljs-number">415</span>         (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line">             ...     </span><br><span class="line"><span class="hljs-number">701381</span>      (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line"><span class="hljs-number">701382</span>    (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]</span><br><span class="line"><span class="hljs-number">701383</span>        (<span class="hljs-number">1</span>, <span class="hljs-number">10</span>]</span><br><span class="line"><span class="hljs-number">701384</span>      (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line"><span class="hljs-number">701385</span>    (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]</span><br><span class="line">Name: contb_receipt_amt, Length: <span class="hljs-number">694282</span>, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">8</span>, interval[int64]): [(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>] &lt; (<span class="hljs-number">1</span>, <span class="hljs-number">10</span>] &lt; (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>] &lt; (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>] &lt; (<span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">000</span>, <span class="hljs-number">10000</span>] &lt;</span><br><span class="line">                                  (<span class="hljs-number">10000</span>, <span class="hljs-number">100000</span>] &lt; (<span class="hljs-number">100000</span>, <span class="hljs-number">1000000</span>] &lt; (<span class="hljs-number">1000000</span>,</span><br><span class="line"> <span class="hljs-number">10000000</span>]]</span><br></pre></td></tr></table></figure>

<p>现在可以根据候选人姓名以及面元标签对奥巴马和罗姆尼数据进行分组，以得到一个柱状图：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">213</span>]: grouped = fec_mrbo.groupby([<span class="hljs-string">'cand_nm'</span>, labels])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">214</span>]: grouped.size().unstack(<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">214</span>]: </span><br><span class="line">cand_nm              Obama, Barack  Romney, Mitt</span><br><span class="line">contb_receipt_amt                               </span><br><span class="line">(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]                       <span class="hljs-number">493.0</span>          <span class="hljs-number">77.0</span></span><br><span class="line">(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>]                    <span class="hljs-number">40070.0</span>        <span class="hljs-number">3681.0</span></span><br><span class="line">(<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]                 <span class="hljs-number">372280.0</span>       <span class="hljs-number">31853.0</span></span><br><span class="line">(<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]               <span class="hljs-number">153991.0</span>       <span class="hljs-number">43357.0</span></span><br><span class="line">(<span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>]              <span class="hljs-number">22284.0</span>       <span class="hljs-number">26186.0</span></span><br><span class="line">(<span class="hljs-number">10000</span>, <span class="hljs-number">100000</span>]                <span class="hljs-number">2.0</span>           <span class="hljs-number">1.0</span></span><br><span class="line">(<span class="hljs-number">100000</span>, <span class="hljs-number">1000000</span>]              <span class="hljs-number">3.0</span>           NaN</span><br><span class="line">(<span class="hljs-number">1000000</span>, <span class="hljs-number">10000000</span>]            <span class="hljs-number">4.0</span>           NaN</span><br></pre></td></tr></table></figure>

<p>从这个数据中可以看出，在小额赞助方面，Obama获得的数量比Romney多得多。你还可以对出资额求和并在面元内规格化，以便图形化显示两位候选人各种赞助额度的比例（见图14-13）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">216</span>]: bucket_sums = grouped.contb_receipt_amt.sum().unstack(<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">217</span>]: normed_sums = bucket_sums.div(bucket_sums.sum(axis=<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">218</span>]: normed_sums</span><br><span class="line">Out[<span class="hljs-number">218</span>]: </span><br><span class="line">cand_nm              Obama, Barack  Romney, Mitt</span><br><span class="line">contb_receipt_amt                               </span><br><span class="line">(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]                    <span class="hljs-number">0.805182</span>      <span class="hljs-number">0.194818</span></span><br><span class="line">(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>]                   <span class="hljs-number">0.918767</span>      <span class="hljs-number">0.081233</span></span><br><span class="line">(<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]                 <span class="hljs-number">0.910769</span>      <span class="hljs-number">0.089231</span></span><br><span class="line">(<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]               <span class="hljs-number">0.710176</span>      <span class="hljs-number">0.289824</span></span><br><span class="line">(<span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>]             <span class="hljs-number">0.447326</span>      <span class="hljs-number">0.552674</span></span><br><span class="line">(<span class="hljs-number">10000</span>, <span class="hljs-number">100000</span>]           <span class="hljs-number">0.823120</span>      <span class="hljs-number">0.176880</span></span><br><span class="line">(<span class="hljs-number">100000</span>, <span class="hljs-number">1000000</span>]         <span class="hljs-number">1.000000</span>           NaN</span><br><span class="line">(<span class="hljs-number">1000000</span>, <span class="hljs-number">10000000</span>]       <span class="hljs-number">1.000000</span>           NaN</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">219</span>]: normed_sums[:<span class="hljs-number">-2</span>].plot(kind=<span class="hljs-string">'barh'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-77e8c8d3c784692b.webp" alt="img"></p>
<p>图14-13 两位候选人收到的各种捐赠额度的总额比例</p>
<p>我排除了两个最大的面元，因为这些不是由个人捐赠的。</p>
<p>还可以对该分析过程做许多的提炼和改进。比如说，可以根据赞助人的姓名和邮编对数据进行聚合，以便找出哪些人进行了多次小额捐款，哪些人又进行了一次或多次大额捐款。我强烈建议你下载这些数据并自己摸索一下。</p>
<h2 id="根据州统计赞助信息"><a href="#根据州统计赞助信息" class="headerlink" title="根据州统计赞助信息"></a>根据州统计赞助信息</h2><p>根据候选人和州对数据进行聚合是常规操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">220</span>]: grouped = fec_mrbo.groupby([<span class="hljs-string">'cand_nm'</span>, <span class="hljs-string">'contbr_st'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">221</span>]: totals = grouped.contb_receipt_amt.sum().unstack(<span class="hljs-number">0</span>).fillna(<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">222</span>]: totals = totals[totals.sum(<span class="hljs-number">1</span>) &gt; <span class="hljs-number">100000</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">223</span>]: totals[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">223</span>]: </span><br><span class="line">cand_nm    Obama, Barack  Romney, Mitt</span><br><span class="line">contbr_st                             </span><br><span class="line">AK             <span class="hljs-number">281840.15</span>      <span class="hljs-number">86204.24</span></span><br><span class="line">AL             <span class="hljs-number">543123.48</span>     <span class="hljs-number">527303.51</span></span><br><span class="line">AR             <span class="hljs-number">359247.28</span>     <span class="hljs-number">105556.00</span></span><br><span class="line">AZ            <span class="hljs-number">1506476.98</span>    <span class="hljs-number">1888436.23</span></span><br><span class="line">CA           <span class="hljs-number">23824984.24</span>   <span class="hljs-number">11237636.60</span></span><br><span class="line">CO            <span class="hljs-number">2132429.49</span>    <span class="hljs-number">1506714.12</span></span><br><span class="line">CT            <span class="hljs-number">2068291.26</span>    <span class="hljs-number">3499475.45</span></span><br><span class="line">DC            <span class="hljs-number">4373538.80</span>    <span class="hljs-number">1025137.50</span></span><br><span class="line">DE             <span class="hljs-number">336669.14</span>      <span class="hljs-number">82712.00</span></span><br><span class="line">FL            <span class="hljs-number">7318178.58</span>    <span class="hljs-number">8338458.81</span></span><br></pre></td></tr></table></figure>

<p>如果对各行除以总赞助额，就会得到各候选人在各州的总赞助额比例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">224</span>]: percent = totals.div(totals.sum(<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">225</span>]: percent[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">225</span>]: </span><br><span class="line">cand_nm    Obama, Barack  Romney, Mitt</span><br><span class="line">contbr_st                             </span><br><span class="line">AK              <span class="hljs-number">0.765778</span>      <span class="hljs-number">0.234222</span></span><br><span class="line">AL              <span class="hljs-number">0.507390</span>      <span class="hljs-number">0.492610</span></span><br><span class="line">AR              <span class="hljs-number">0.772902</span>      <span class="hljs-number">0.227098</span></span><br><span class="line">AZ              <span class="hljs-number">0.443745</span>      <span class="hljs-number">0.556255</span></span><br><span class="line">CA              <span class="hljs-number">0.679498</span>      <span class="hljs-number">0.320502</span></span><br><span class="line">CO              <span class="hljs-number">0.585970</span>      <span class="hljs-number">0.414030</span></span><br><span class="line">CT              <span class="hljs-number">0.371476</span>      <span class="hljs-number">0.628524</span></span><br><span class="line">DC              <span class="hljs-number">0.810113</span>      <span class="hljs-number">0.189887</span></span><br><span class="line">DE              <span class="hljs-number">0.802776</span>      <span class="hljs-number">0.197224</span></span><br><span class="line">FL              <span class="hljs-number">0.467417</span>      <span class="hljs-number">0.532583</span></span><br></pre></td></tr></table></figure>

<h1 id="14-6-总结"><a href="#14-6-总结" class="headerlink" title="14.6 总结"></a>14.6 总结</h1><p>我们已经完成了正文的最后一章。附录中有一些额外的内容，可能对你有用。</p>
<p>本书第一版出版已经有5年了，Python已经成为了一个流行的、广泛使用的数据分析语言。你从本书中学到的方法，在相当长的一段时间都是可用的。我希望本书介绍的工具和库对你的工作有用。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 9306 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC11%E7%AB%A0%20%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/">《利用Python进行数据分析·第2版》第11章 时间序列</a>
            
        </h1>
        <div class="content">
            <h1 id="《利用Python进行数据分析·第2版》第11章-时间序列"><a href="#《利用Python进行数据分析·第2版》第11章-时间序列" class="headerlink" title="《利用Python进行数据分析·第2版》第11章 时间序列"></a>《利用Python进行数据分析·第2版》第11章 时间序列</h1><hr>
<p>转载自<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
第11章 时间序列
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>时间序列（time series）数据是一种重要的结构化数据形式，应用于多个领域，包括金融学、经济学、生态学、神经科学、物理学等。在多个时间点观察或测量到的任何事物都可以形成一段时间序列。很多时间序列是固定频率的，也就是说，数据点是根据某种规律定期出现的（比如每15秒、每5分钟、每月出现一次）。时间序列也可以是不定期的，没有固定的时间单位或单位之间的偏移量。时间序列数据的意义取决于具体的应用场景，主要有以下几种：</p>
<ul>
<li>时间戳（timestamp），特定的时刻。</li>
<li>固定时期（period），如2007年1月或2010年全年。</li>
<li>时间间隔（interval），由起始和结束时间戳表示。时期（period）可以被看做间隔（interval）的特例。</li>
<li>实验或过程时间，每个时间点都是相对于特定起始时间的一个度量。例如，从放入烤箱时起，每秒钟饼干的直径。</li>
</ul>
<p>本章主要讲解前3种时间序列。许多技术都可用于处理实验型时间序列，其索引可能是一个整数或浮点数（表示从实验开始算起已经过去的时间）。最简单也最常见的时间序列都是用时间戳进行索引的。</p>
<blockquote>
<p>提示：pandas也支持基于timedeltas的指数，它可以有效代表实验或经过的时间。这本书不涉及timedelta指数，但你可以学习pandas的文档（<a href="http://pandas.pydata.org/）。" target="_blank" rel="noopener">http://pandas.pydata.org/）。</a></p>
</blockquote>
<p>pandas提供了许多内置的时间序列处理工具和数据算法。因此，你可以高效处理非常大的时间序列，轻松地进行切片/切块、聚合、对定期/不定期的时间序列进行重采样等。有些工具特别适合金融和经济应用，你当然也可以用它们来分析服务器日志数据。</p>
<h1 id="11-1-日期和时间数据类型及工具"><a href="#11-1-日期和时间数据类型及工具" class="headerlink" title="11.1 日期和时间数据类型及工具"></a>11.1 日期和时间数据类型及工具</h1><p>Python标准库包含用于日期（date）和时间（time）数据的数据类型，而且还有日历方面的功能。我们主要会用到datetime、time以及calendar模块。datetime.datetime（也可以简写为datetime）是用得最多的数据类型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: now = datetime.now()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: now</span><br><span class="line">Out[<span class="hljs-number">12</span>]: datetime.datetime(<span class="hljs-number">2017</span>, <span class="hljs-number">9</span>, <span class="hljs-number">25</span>, <span class="hljs-number">14</span>, <span class="hljs-number">5</span>, <span class="hljs-number">52</span>, <span class="hljs-number">72973</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: now.year, now.month, now.day</span><br><span class="line">Out[<span class="hljs-number">13</span>]: (<span class="hljs-number">2017</span>, <span class="hljs-number">9</span>, <span class="hljs-number">25</span>)</span><br></pre></td></tr></table></figure>

<p>datetime以毫秒形式存储日期和时间。timedelta表示两个datetime对象之间的时间差：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">14</span>]: delta = datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>) - datetime(<span class="hljs-number">2008</span>, <span class="hljs-number">6</span>, <span class="hljs-number">24</span>, <span class="hljs-number">8</span>, <span class="hljs-number">15</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: delta</span><br><span class="line">Out[<span class="hljs-number">15</span>]: datetime.timedelta(<span class="hljs-number">926</span>, <span class="hljs-number">56700</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: delta.days</span><br><span class="line">Out[<span class="hljs-number">16</span>]: <span class="hljs-number">926</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: delta.seconds</span><br><span class="line">Out[<span class="hljs-number">17</span>]: <span class="hljs-number">56700</span></span><br></pre></td></tr></table></figure>

<p>可以给datetime对象加上（或减去）一个或多个timedelta，这样会产生一个新对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: start = datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: start + timedelta(<span class="hljs-number">12</span>)</span><br><span class="line">Out[<span class="hljs-number">20</span>]: datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">19</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: start - <span class="hljs-number">2</span> * timedelta(<span class="hljs-number">12</span>)</span><br><span class="line">Out[<span class="hljs-number">21</span>]: datetime.datetime(<span class="hljs-number">2010</span>, <span class="hljs-number">12</span>, <span class="hljs-number">14</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>datetime模块中的数据类型参见表10-1。虽然本章主要讲的是pandas数据类型和高级时间序列处理，但你肯定会在Python的其他地方遇到有关datetime的数据类型。</p>
<p>表11-1 datetime模块中的数据类型</p>
<p><img src="/images/blog/7178691-4af261a305a70aeb.webp" alt="img"></p>
<p>tzinfo 存储时区信息的基本类型</p>
<h2 id="字符串和datetime的相互转换"><a href="#字符串和datetime的相互转换" class="headerlink" title="字符串和datetime的相互转换"></a>字符串和datetime的相互转换</h2><p>利用str或strftime方法（传入一个格式化字符串），datetime对象和pandas的Timestamp对象（稍后就会介绍）可以被格式化为字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">22</span>]: stamp = datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: str(stamp)</span><br><span class="line">Out[<span class="hljs-number">23</span>]: <span class="hljs-string">'2011-01-03 00:00:00'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">24</span>]: stamp.strftime(<span class="hljs-string">'%Y-%m-%d'</span>)</span><br><span class="line">Out[<span class="hljs-number">24</span>]: <span class="hljs-string">'2011-01-03'</span></span><br></pre></td></tr></table></figure>

<p>表11-2列出了全部的格式化编码。</p>
<p>表11-2 datetime格式定义（兼容ISO C89）</p>
<p><img src="/images/blog/7178691-50c751823754df58.webp" alt="img"></p>
<p><img src="/images/blog/7178691-de0181e1f6b45eaf.webp" alt="img"></p>
<p>datetime.strptime可以用这些格式化编码将字符串转换为日期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: value = <span class="hljs-string">'2011-01-03'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">26</span>]: datetime.strptime(value, <span class="hljs-string">'%Y-%m-%d'</span>)</span><br><span class="line">Out[<span class="hljs-number">26</span>]: datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: datestrs = [<span class="hljs-string">'7/6/2011'</span>, <span class="hljs-string">'8/6/2011'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: [datetime.strptime(x, <span class="hljs-string">'%m/%d/%Y'</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> datestrs]</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">[datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),</span><br><span class="line"> datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">8</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)]</span><br></pre></td></tr></table></figure>

<p>datetime.strptime是通过已知格式进行日期解析的最佳方式。但是每次都要编写格式定义是很麻烦的事情，尤其是对于一些常见的日期格式。这种情况下，你可以用dateutil这个第三方包中的parser.parse方法（pandas中已经自动安装好了）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: <span class="hljs-keyword">from</span> dateutil.parser <span class="hljs-keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: parse(<span class="hljs-string">'2011-01-03'</span>)</span><br><span class="line">Out[<span class="hljs-number">30</span>]: datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>dateutil可以解析几乎所有人类能够理解的日期表示形式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: parse(<span class="hljs-string">'Jan 31, 1997 10:45 PM'</span>)</span><br><span class="line">Out[<span class="hljs-number">31</span>]: datetime.datetime(<span class="hljs-number">1997</span>, <span class="hljs-number">1</span>, <span class="hljs-number">31</span>, <span class="hljs-number">22</span>, <span class="hljs-number">45</span>)</span><br></pre></td></tr></table></figure>

<p>在国际通用的格式中，日出现在月的前面很普遍，传入dayfirst=True即可解决这个问题：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">32</span>]: parse(<span class="hljs-string">'6/12/2011'</span>, dayfirst=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">32</span>]: datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">12</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>pandas通常是用于处理成组日期的，不管这些日期是DataFrame的轴索引还是列。to_datetime方法可以解析多种不同的日期表示形式。对标准日期格式（如ISO8601）的解析非常快：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: datestrs = [<span class="hljs-string">'2011-07-06 12:00:00'</span>, <span class="hljs-string">'2011-08-06 00:00:00'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: pd.to_datetime(datestrs)</span><br><span class="line">Out[<span class="hljs-number">34</span>]: DatetimeIndex([<span class="hljs-string">'2011-07-06 12:00:00'</span>, <span class="hljs-string">'2011-08-06 00:00:00'</span>], dtype=<span class="hljs-string">'dat</span></span><br><span class="line"><span class="hljs-string">etime64[ns]'</span>, freq=<span class="hljs-literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>它还可以处理缺失值（None、空字符串等）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: idx = pd.to_datetime(datestrs + [<span class="hljs-literal">None</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: idx</span><br><span class="line">Out[<span class="hljs-number">36</span>]: DatetimeIndex([<span class="hljs-string">'2011-07-06 12:00:00'</span>, <span class="hljs-string">'2011-08-06 00:00:00'</span>, <span class="hljs-string">'NaT'</span>], dty</span><br><span class="line">pe=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-literal">None</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: idx[<span class="hljs-number">2</span>]</span><br><span class="line">Out[<span class="hljs-number">37</span>]: NaT</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: pd.isnull(idx)</span><br><span class="line">Out[<span class="hljs-number">38</span>]: array([<span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>,  <span class="hljs-literal">True</span>], dtype=bool)</span><br></pre></td></tr></table></figure>

<p>NaT（Not a Time）是pandas中时间戳数据的null值。</p>
<blockquote>
<p>注意：dateutil.parser是一个实用但不完美的工具。比如说，它会把一些原本不是日期的字符串认作是日期（比如”42”会被解析为2042年的今天）。</p>
</blockquote>
<p>datetime对象还有一些特定于当前环境（位于不同国家或使用不同语言的系统）的格式化选项。例如，德语或法语系统所用的月份简写就与英语系统所用的不同。表11-3进行了总结。</p>
<p>表11-3 特定于当前环境的日期格式</p>
<p><img src="/images/blog/7178691-cf0119398273e2b0.webp" alt="img"></p>
<h1 id="11-2-时间序列基础"><a href="#11-2-时间序列基础" class="headerlink" title="11.2 时间序列基础"></a>11.2 时间序列基础</h1><p>pandas最基本的时间序列类型就是以时间戳（通常以Python字符串或datatime对象表示）为索引的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: dates = [datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>), datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>),</span><br><span class="line">   ....:          datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>), datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>),</span><br><span class="line">   ....:          datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>), datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">12</span>)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: ts = pd.Series(np.random.randn(<span class="hljs-number">6</span>), index=dates)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">42</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>这些datetime对象实际上是被放在一个DatetimeIndex中的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">43</span>]: ts.index</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2011-01-02'</span>, <span class="hljs-string">'2011-01-05'</span>, <span class="hljs-string">'2011-01-07'</span>, <span class="hljs-string">'2011-01-08'</span>,</span><br><span class="line">               <span class="hljs-string">'2011-01-10'</span>, <span class="hljs-string">'2011-01-12'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>跟其他Series一样，不同索引的时间序列之间的算术运算会自动按日期对齐：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: ts + ts[::<span class="hljs-number">2</span>]</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.409415</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>         NaN</span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-1.038877</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>         NaN</span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">3.931561</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>         NaN</span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>ts[::2] 是每隔两个取一个。</p>
<p>pandas用NumPy的datetime64数据类型以纳秒形式存储时间戳：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: ts.index.dtype</span><br><span class="line">Out[<span class="hljs-number">45</span>]: dtype(<span class="hljs-string">'&lt;M8[ns]'</span>)</span><br></pre></td></tr></table></figure>

<p>DatetimeIndex中的各个标量值是pandas的Timestamp对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">46</span>]: stamp = ts.index[<span class="hljs-number">0</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: stamp</span><br><span class="line">Out[<span class="hljs-number">47</span>]: Timestamp(<span class="hljs-string">'2011-01-02 00:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>只要有需要，TimeStamp可以随时自动转换为datetime对象。此外，它还可以存储频率信息（如果有的话），且知道如何执行时区转换以及其他操作。稍后将对此进行详细讲解。</p>
<h2 id="索引、选取、子集构造"><a href="#索引、选取、子集构造" class="headerlink" title="索引、选取、子集构造"></a>索引、选取、子集构造</h2><p>当你根据标签索引选取数据时，时间序列和其它的pandas.Series很像：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">48</span>]: stamp = ts.index[<span class="hljs-number">2</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">49</span>]: ts[stamp]</span><br><span class="line">Out[<span class="hljs-number">49</span>]: <span class="hljs-number">-0.51943871505673811</span></span><br></pre></td></tr></table></figure>

<p>还有一种更为方便的用法：传入一个可以被解释为日期的字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: ts[<span class="hljs-string">'1/10/2011'</span>]</span><br><span class="line">Out[<span class="hljs-number">50</span>]: <span class="hljs-number">1.9657805725027142</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: ts[<span class="hljs-string">'20110110'</span>]</span><br><span class="line">Out[<span class="hljs-number">51</span>]: <span class="hljs-number">1.9657805725027142</span></span><br></pre></td></tr></table></figure>

<p>对于较长的时间序列，只需传入“年”或“年月”即可轻松选取数据的切片：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">52</span>]: longer_ts = pd.Series(np.random.randn(<span class="hljs-number">1000</span>),</span><br><span class="line">   ....:                       index=pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">1000</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: longer_ts</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.092908</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">0.281746</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>    <span class="hljs-number">1.246435</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">1.007189</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>   <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>    <span class="hljs-number">0.274992</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>    <span class="hljs-number">0.228913</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>    <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">0.886429</span></span><br><span class="line">                ...   </span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-17</span>   <span class="hljs-number">-0.139298</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-18</span>   <span class="hljs-number">-1.159926</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span>    <span class="hljs-number">0.618965</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-20</span>    <span class="hljs-number">1.373890</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-21</span>   <span class="hljs-number">-0.983505</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-22</span>    <span class="hljs-number">0.930944</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-23</span>   <span class="hljs-number">-0.811676</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-24</span>   <span class="hljs-number">-1.830156</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-25</span>   <span class="hljs-number">-0.138730</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-26</span>    <span class="hljs-number">0.334088</span></span><br><span class="line">Freq: D, Length: <span class="hljs-number">1000</span>, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">54</span>]: longer_ts[<span class="hljs-string">'2001'</span>]</span><br><span class="line">Out[<span class="hljs-number">54</span>]: </span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">1.599534</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">0.474071</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.151326</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>   <span class="hljs-number">-0.542173</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>   <span class="hljs-number">-0.475496</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>    <span class="hljs-number">0.106403</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-1.308228</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>    <span class="hljs-number">2.173185</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>    <span class="hljs-number">0.564561</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>   <span class="hljs-number">-0.190481</span></span><br><span class="line">                ...   </span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-22</span>    <span class="hljs-number">0.000369</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-23</span>    <span class="hljs-number">0.900885</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-24</span>   <span class="hljs-number">-0.454869</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-25</span>   <span class="hljs-number">-0.864547</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span>    <span class="hljs-number">1.129120</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span>    <span class="hljs-number">0.057874</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-28</span>   <span class="hljs-number">-0.433739</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.092698</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-30</span>   <span class="hljs-number">-1.397820</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>    <span class="hljs-number">1.457823</span></span><br><span class="line">Freq: D, Length: <span class="hljs-number">365</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>这里，字符串“2001”被解释成年，并根据它选取时间区间。指定月也同样奏效：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">55</span>]: longer_ts[<span class="hljs-string">'2001-05'</span>]</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.622547</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-02</span>    <span class="hljs-number">0.936289</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.750018</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-04</span>   <span class="hljs-number">-0.056715</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-05</span>    <span class="hljs-number">2.300675</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-06</span>    <span class="hljs-number">0.569497</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-07</span>    <span class="hljs-number">1.489410</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-08</span>    <span class="hljs-number">1.264250</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-09</span>   <span class="hljs-number">-0.761837</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-10</span>   <span class="hljs-number">-0.331617</span></span><br><span class="line">                ...   </span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-22</span>    <span class="hljs-number">0.503699</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-23</span>   <span class="hljs-number">-1.387874</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-24</span>    <span class="hljs-number">0.204851</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-25</span>    <span class="hljs-number">0.603705</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-26</span>    <span class="hljs-number">0.545680</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-27</span>    <span class="hljs-number">0.235477</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-28</span>    <span class="hljs-number">0.111835</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-29</span>   <span class="hljs-number">-1.251504</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-30</span>   <span class="hljs-number">-2.949343</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.634634</span></span><br><span class="line">Freq: D, Length: <span class="hljs-number">31</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>datetime对象也可以进行切片：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: ts[datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>):]</span><br><span class="line">Out[<span class="hljs-number">56</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>由于大部分时间序列数据都是按照时间先后排序的，因此你也可以用不存在于该时间序列中的时间戳对其进行切片（即范围查询）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">57</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">57</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: ts[<span class="hljs-string">'1/6/2011'</span>:<span class="hljs-string">'1/11/2011'</span>]</span><br><span class="line">Out[<span class="hljs-number">58</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>跟之前一样，你可以传入字符串日期、datetime或Timestamp。注意，这样切片所产生的是原时间序列的视图，跟NumPy数组的切片运算是一样的。</p>
<p>这意味着，没有数据被复制，对切片进行修改会反映到原始数据上。</p>
<p>此外，还有一个等价的实例方法也可以截取两个日期之间TimeSeries：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">59</span>]: ts.truncate(after=<span class="hljs-string">'1/9/2011'</span>)</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>面这些操作对DataFrame也有效。例如，对DataFrame的行进行索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: dates = pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">100</span>, freq=<span class="hljs-string">'W-WED'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: long_df = pd.DataFrame(np.random.randn(<span class="hljs-number">100</span>, <span class="hljs-number">4</span>),</span><br><span class="line">   ....:                        index=dates,</span><br><span class="line">   ....:                        columns=[<span class="hljs-string">'Colorado'</span>, <span class="hljs-string">'Texas'</span>,</span><br><span class="line">   ....:                                 <span class="hljs-string">'New York'</span>, <span class="hljs-string">'Ohio'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: long_df.loc[<span class="hljs-string">'5-2001'</span>]</span><br><span class="line">Out[<span class="hljs-number">62</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-02</span> <span class="hljs-number">-0.006045</span>  <span class="hljs-number">0.490094</span> <span class="hljs-number">-0.277186</span> <span class="hljs-number">-0.707213</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-09</span> <span class="hljs-number">-0.560107</span>  <span class="hljs-number">2.735527</span>  <span class="hljs-number">0.927335</span>  <span class="hljs-number">1.513906</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-16</span>  <span class="hljs-number">0.538600</span>  <span class="hljs-number">1.273768</span>  <span class="hljs-number">0.667876</span> <span class="hljs-number">-0.969206</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-23</span>  <span class="hljs-number">1.676091</span> <span class="hljs-number">-0.817649</span>  <span class="hljs-number">0.050188</span>  <span class="hljs-number">1.951312</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-30</span>  <span class="hljs-number">3.260383</span>  <span class="hljs-number">0.963301</span>  <span class="hljs-number">1.201206</span> <span class="hljs-number">-1.852001</span></span><br></pre></td></tr></table></figure>

<h2 id="带有重复索引的时间序列"><a href="#带有重复索引的时间序列" class="headerlink" title="带有重复索引的时间序列"></a>带有重复索引的时间序列</h2><p>在某些应用场景中，可能会存在多个观测数据落在同一个时间点上的情况。下面就是一个例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">63</span>]: dates = pd.DatetimeIndex([<span class="hljs-string">'1/1/2000'</span>, <span class="hljs-string">'1/2/2000'</span>, <span class="hljs-string">'1/2/2000'</span>,</span><br><span class="line">   ....:                           <span class="hljs-string">'1/2/2000'</span>, <span class="hljs-string">'1/3/2000'</span>])</span><br><span class="line">In [<span class="hljs-number">64</span>]: dup_ts = pd.Series(np.arange(<span class="hljs-number">5</span>), index=dates)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">65</span>]: dup_ts</span><br><span class="line">Out[<span class="hljs-number">65</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>通过检查索引的is_unique属性，我们就可以知道它是不是唯一的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: dup_ts.index.is_unique</span><br><span class="line">Out[<span class="hljs-number">66</span>]: <span class="hljs-literal">False</span></span><br></pre></td></tr></table></figure>

<p>对这个时间序列进行索引，要么产生标量值，要么产生切片，具体要看所选的时间点是否重复：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">67</span>]: dup_ts[<span class="hljs-string">'1/3/2000'</span>]  <span class="hljs-comment"># not duplicated</span></span><br><span class="line">Out[<span class="hljs-number">67</span>]: <span class="hljs-number">4</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">68</span>]: dup_ts[<span class="hljs-string">'1/2/2000'</span>]  <span class="hljs-comment"># duplicated</span></span><br><span class="line">Out[<span class="hljs-number">68</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">3</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>假设你想要对具有非唯一时间戳的数据进行聚合。一个办法是使用groupby，并传入level=0：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: grouped = dup_ts.groupby(level=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: grouped.mean()</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: grouped.count()</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">1</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h1 id="11-3-日期的范围、频率以及移动"><a href="#11-3-日期的范围、频率以及移动" class="headerlink" title="11.3 日期的范围、频率以及移动"></a>11.3 日期的范围、频率以及移动</h1><p>pandas中的原生时间序列一般被认为是不规则的，也就是说，它们没有固定的频率。对于大部分应用程序而言，这是无所谓的。但是，它常常需要以某种相对固定的频率进行分析，比如每日、每月、每15分钟等（这样自然会在时间序列中引入缺失值）。幸运的是，pandas有一整套标准时间序列频率以及用于重采样、频率推断、生成固定频率日期范围的工具。例如，我们可以将之前那个时间序列转换为一个具有固定频率（每日）的时间序列，只需调用resample即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">72</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">73</span>]: resampler = ts.resample(<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>字符串“D”是每天的意思。</p>
<p>频率的转换（或重采样）是一个比较大的主题，稍后将专门用一节来进行讨论（11.6小节）。这里，我将告诉你如何使用基本的频率和它的倍数。</p>
<h2 id="生成日期范围"><a href="#生成日期范围" class="headerlink" title="生成日期范围"></a>生成日期范围</h2><p>虽然我之前用的时候没有明说，但你可能已经猜到pandas.date_range可用于根据指定的频率生成指定长度的DatetimeIndex：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: index = pd.date_range(<span class="hljs-string">'2012-04-01'</span>, <span class="hljs-string">'2012-06-01'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">75</span>]: index</span><br><span class="line">Out[<span class="hljs-number">75</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-04-01'</span>, <span class="hljs-string">'2012-04-02'</span>, <span class="hljs-string">'2012-04-03'</span>, <span class="hljs-string">'2012-04-04'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-05'</span>, <span class="hljs-string">'2012-04-06'</span>, <span class="hljs-string">'2012-04-07'</span>, <span class="hljs-string">'2012-04-08'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-09'</span>, <span class="hljs-string">'2012-04-10'</span>, <span class="hljs-string">'2012-04-11'</span>, <span class="hljs-string">'2012-04-12'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-13'</span>, <span class="hljs-string">'2012-04-14'</span>, <span class="hljs-string">'2012-04-15'</span>, <span class="hljs-string">'2012-04-16'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-17'</span>, <span class="hljs-string">'2012-04-18'</span>, <span class="hljs-string">'2012-04-19'</span>, <span class="hljs-string">'2012-04-20'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-21'</span>, <span class="hljs-string">'2012-04-22'</span>, <span class="hljs-string">'2012-04-23'</span>, <span class="hljs-string">'2012-04-24'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-25'</span>, <span class="hljs-string">'2012-04-26'</span>, <span class="hljs-string">'2012-04-27'</span>, <span class="hljs-string">'2012-04-28'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-29'</span>, <span class="hljs-string">'2012-04-30'</span>, <span class="hljs-string">'2012-05-01'</span>, <span class="hljs-string">'2012-05-02'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-03'</span>, <span class="hljs-string">'2012-05-04'</span>, <span class="hljs-string">'2012-05-05'</span>, <span class="hljs-string">'2012-05-06'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-07'</span>, <span class="hljs-string">'2012-05-08'</span>, <span class="hljs-string">'2012-05-09'</span>, <span class="hljs-string">'2012-05-10'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-11'</span>, <span class="hljs-string">'2012-05-12'</span>, <span class="hljs-string">'2012-05-13'</span>, <span class="hljs-string">'2012-05-14'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-15'</span>, <span class="hljs-string">'2012-05-16'</span>, <span class="hljs-string">'2012-05-17'</span>, <span class="hljs-string">'2012-05-18'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-19'</span>, <span class="hljs-string">'2012-05-20'</span>, <span class="hljs-string">'2012-05-21'</span>, <span class="hljs-string">'2012-05-22'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-23'</span>, <span class="hljs-string">'2012-05-24'</span>, <span class="hljs-string">'2012-05-25'</span>, <span class="hljs-string">'2012-05-26'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-27'</span>, <span class="hljs-string">'2012-05-28'</span>, <span class="hljs-string">'2012-05-29'</span>, <span class="hljs-string">'2012-05-30'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-31'</span>, <span class="hljs-string">'2012-06-01'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>默认情况下，date_range会产生按天计算的时间点。如果只传入起始或结束日期，那就还得传入一个表示一段时间的数字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">76</span>]: pd.date_range(start=<span class="hljs-string">'2012-04-01'</span>, periods=<span class="hljs-number">20</span>)</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-04-01'</span>, <span class="hljs-string">'2012-04-02'</span>, <span class="hljs-string">'2012-04-03'</span>, <span class="hljs-string">'2012-04-04'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-05'</span>, <span class="hljs-string">'2012-04-06'</span>, <span class="hljs-string">'2012-04-07'</span>, <span class="hljs-string">'2012-04-08'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-09'</span>, <span class="hljs-string">'2012-04-10'</span>, <span class="hljs-string">'2012-04-11'</span>, <span class="hljs-string">'2012-04-12'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-13'</span>, <span class="hljs-string">'2012-04-14'</span>, <span class="hljs-string">'2012-04-15'</span>, <span class="hljs-string">'2012-04-16'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-17'</span>, <span class="hljs-string">'2012-04-18'</span>, <span class="hljs-string">'2012-04-19'</span>, <span class="hljs-string">'2012-04-20'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: pd.date_range(end=<span class="hljs-string">'2012-06-01'</span>, periods=<span class="hljs-number">20</span>)</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-05-13'</span>, <span class="hljs-string">'2012-05-14'</span>, <span class="hljs-string">'2012-05-15'</span>, <span class="hljs-string">'2012-05-16'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-17'</span>, <span class="hljs-string">'2012-05-18'</span>, <span class="hljs-string">'2012-05-19'</span>, <span class="hljs-string">'2012-05-20'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-21'</span>, <span class="hljs-string">'2012-05-22'</span>, <span class="hljs-string">'2012-05-23'</span>, <span class="hljs-string">'2012-05-24'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-25'</span>, <span class="hljs-string">'2012-05-26'</span>, <span class="hljs-string">'2012-05-27'</span>,<span class="hljs-string">'2012-05-28'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-29'</span>, <span class="hljs-string">'2012-05-30'</span>, <span class="hljs-string">'2012-05-31'</span>, <span class="hljs-string">'2012-06-01'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>起始和结束日期定义了日期索引的严格边界。例如，如果你想要生成一个由每月最后一个工作日组成的日期索引，可以传入”BM”频率（表示business end of month，表11-4是频率列表），这样就只会包含时间间隔内（或刚好在边界上的）符合频率要求的日期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">78</span>]: pd.date_range(<span class="hljs-string">'2000-01-01'</span>, <span class="hljs-string">'2000-12-01'</span>, freq=<span class="hljs-string">'BM'</span>)</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2000-01-31'</span>, <span class="hljs-string">'2000-02-29'</span>, <span class="hljs-string">'2000-03-31'</span>, <span class="hljs-string">'2000-04-28'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-05-31'</span>, <span class="hljs-string">'2000-06-30'</span>, <span class="hljs-string">'2000-07-31'</span>, <span class="hljs-string">'2000-08-31'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-09-29'</span>, <span class="hljs-string">'2000-10-31'</span>, <span class="hljs-string">'2000-11-30'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'BM'</span>)</span><br></pre></td></tr></table></figure>

<p>表11-4 基本的时间序列频率（不完整）</p>
<p><img src="/images/blog/7178691-c8614ddbd10793ca.webp" alt="img"></p>
<p><img src="/images/blog/7178691-8da46ba96544b071.webp" alt="img"></p>
<p><img src="/images/blog/7178691-3ca410609195edc4.webp" alt="img"></p>
<p>date_range默认会保留起始和结束时间戳的时间信息（如果有的话）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: pd.date_range(<span class="hljs-string">'2012-05-02 12:56:31'</span>, periods=<span class="hljs-number">5</span>)</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-05-02 12:56:31'</span>, <span class="hljs-string">'2012-05-03 12:56:31'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-04 12:56:31'</span>, <span class="hljs-string">'2012-05-05 12:56:31'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-06 12:56:31'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>有时，虽然起始和结束日期带有时间信息，但你希望产生一组被规范化（normalize）到午夜的时间戳。normalize选项即可实现该功能：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">80</span>]: pd.date_range(<span class="hljs-string">'2012-05-02 12:56:31'</span>, periods=<span class="hljs-number">5</span>, normalize=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-05-02'</span>, <span class="hljs-string">'2012-05-03'</span>, <span class="hljs-string">'2012-05-04'</span>, <span class="hljs-string">'2012-05-05'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-06'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="频率和日期偏移量"><a href="#频率和日期偏移量" class="headerlink" title="频率和日期偏移量"></a>频率和日期偏移量</h2><p>pandas中的频率是由一个基础频率（base frequency）和一个乘数组成的。基础频率通常以一个字符串别名表示，比如”M”表示每月，”H”表示每小时。对于每个基础频率，都有一个被称为日期偏移量（date offset）的对象与之对应。例如，按小时计算的频率可以用Hour类表示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">81</span>]: <span class="hljs-keyword">from</span> pandas.tseries.offsets <span class="hljs-keyword">import</span> Hour, Minute</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">82</span>]: hour = Hour()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: hour</span><br><span class="line">Out[<span class="hljs-number">83</span>]: &lt;Hour&gt;</span><br></pre></td></tr></table></figure>

<p>传入一个整数即可定义偏移量的倍数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">84</span>]: four_hours = Hour(<span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: four_hours</span><br><span class="line">Out[<span class="hljs-number">85</span>]: &lt;<span class="hljs-number">4</span> * Hours&gt;</span><br></pre></td></tr></table></figure>

<p>一般来说，无需明确创建这样的对象，只需使用诸如”H”或”4H”这样的字符串别名即可。在基础频率前面放上一个整数即可创建倍数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: pd.date_range(<span class="hljs-string">'2000-01-01'</span>, <span class="hljs-string">'2000-01-03 23:59'</span>, freq=<span class="hljs-string">'4h'</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2000-01-01 00:00:00'</span>, <span class="hljs-string">'2000-01-01 04:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 08:00:00'</span>, <span class="hljs-string">'2000-01-01 12:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 16:00:00'</span>, <span class="hljs-string">'2000-01-01 20:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-02 00:00:00'</span>, <span class="hljs-string">'2000-01-02 04:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-02 08:00:00'</span>, <span class="hljs-string">'2000-01-02 12:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-02 16:00:00'</span>, <span class="hljs-string">'2000-01-02 20:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-03 00:00:00'</span>, <span class="hljs-string">'2000-01-03 04:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-03 08:00:00'</span>, <span class="hljs-string">'2000-01-03 12:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-03 16:00:00'</span>, <span class="hljs-string">'2000-01-03 20:00:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'4H'</span>)</span><br></pre></td></tr></table></figure>

<p>大部分偏移量对象都可通过加法进行连接：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: Hour(<span class="hljs-number">2</span>) + Minute(<span class="hljs-number">30</span>)</span><br><span class="line">Out[<span class="hljs-number">87</span>]: &lt;<span class="hljs-number">150</span> * Minutes&gt;</span><br></pre></td></tr></table></figure>

<p>同理，你也可以传入频率字符串（如”2h30min”），这种字符串可以被高效地解析为等效的表达式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">88</span>]: pd.date_range(<span class="hljs-string">'2000-01-01'</span>, periods=<span class="hljs-number">10</span>, freq=<span class="hljs-string">'1h30min'</span>)</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2000-01-01 00:00:00'</span>, <span class="hljs-string">'2000-01-01 01:30:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 03:00:00'</span>, <span class="hljs-string">'2000-01-01 04:30:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 06:00:00'</span>, <span class="hljs-string">'2000-01-01 07:30:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 09:00:00'</span>, <span class="hljs-string">'2000-01-01 10:30:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 12:00:00'</span>, <span class="hljs-string">'2000-01-01 13:30:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'90T'</span>)</span><br></pre></td></tr></table></figure>

<p>有些频率所描述的时间点并不是均匀分隔的。例如，”M”（日历月末）和”BM”（每月最后一个工作日）就取决于每月的天数，对于后者，还要考虑月末是不是周末。由于没有更好的术语，我将这些称为锚点偏移量（anchored offset）。</p>
<p>表11-4列出了pandas中的频率代码和日期偏移量类。</p>
<blockquote>
<p>笔记：用户可以根据实际需求自定义一些频率类以便提供pandas所没有的日期逻辑，但具体的细节超出了本书的范围。</p>
</blockquote>
<p>表11-4 时间序列的基础频率</p>
<p><img src="/images/blog/7178691-ff139312cd972204.webp" alt="img"></p>
<p><img src="/images/blog/7178691-adfa57a998c0296e.webp" alt="img"></p>
<p><img src="/images/blog/7178691-d09e577a10d0e6eb.webp" alt="img"></p>
<h2 id="WOM日期"><a href="#WOM日期" class="headerlink" title="WOM日期"></a>WOM日期</h2><p>WOM（Week Of Month）是一种非常实用的频率类，它以WOM开头。它使你能获得诸如“每月第3个星期五”之类的日期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">89</span>]: rng = pd.date_range(<span class="hljs-string">'2012-01-01'</span>, <span class="hljs-string">'2012-09-01'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: list(rng)</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">[Timestamp(<span class="hljs-string">'2012-01-20 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-02-17 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-03-16 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-04-20 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-05-18 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-06-15 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-07-20 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-08-17 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>)]</span><br></pre></td></tr></table></figure>

<h2 id="移动（超前和滞后）数据"><a href="#移动（超前和滞后）数据" class="headerlink" title="移动（超前和滞后）数据"></a>移动（超前和滞后）数据</h2><p>移动（shifting）指的是沿着时间轴将数据前移或后移。Series和DataFrame都有一个shift方法用于执行单纯的前移或后移操作，保持索引不变：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: ts = pd.Series(np.random.randn(<span class="hljs-number">4</span>),</span><br><span class="line">   ....:                index=pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">4</span>, freq=<span class="hljs-string">'M'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">92</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.838639</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line">Freq: M, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: ts.shift(<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>         NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>         NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.838639</span></span><br><span class="line">Freq: M, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">94</span>]: ts.shift(<span class="hljs-number">-2</span>)</span><br><span class="line">Out[<span class="hljs-number">94</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>         NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>         NaN</span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>当我们这样进行移动时，就会在时间序列的前面或后面产生缺失数据。</p>
<p>shift通常用于计算一个时间序列或多个时间序列（如DataFrame的列）中的百分比变化。可以这样表达：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ts / ts.shift(<span class="hljs-number">1</span>) - <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>由于单纯的移位操作不会修改索引，所以部分数据会被丢弃。因此，如果频率已知，则可以将其传给shift以便实现对时间戳进行位移而不是对数据进行简单位移：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">95</span>]: ts.shift(<span class="hljs-number">2</span>, freq=<span class="hljs-string">'M'</span>)</span><br><span class="line">Out[<span class="hljs-number">95</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.838639</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-05</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>这里还可以使用其他频率，于是你就能非常灵活地对数据进行超前和滞后处理了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: ts.shift(<span class="hljs-number">3</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line">Out[<span class="hljs-number">96</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.838639</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-05</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: ts.shift(<span class="hljs-number">1</span>, freq=<span class="hljs-string">'90T'</span>)</span><br><span class="line">Out[<span class="hljs-number">97</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span> <span class="hljs-number">01</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span> <span class="hljs-number">01</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.838639</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span> <span class="hljs-number">01</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span> <span class="hljs-number">01</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="通过偏移量对日期进行位移"><a href="#通过偏移量对日期进行位移" class="headerlink" title="通过偏移量对日期进行位移"></a>通过偏移量对日期进行位移</h2><p>pandas的日期偏移量还可以用在datetime或Timestamp对象上：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">98</span>]: <span class="hljs-keyword">from</span> pandas.tseries.offsets <span class="hljs-keyword">import</span> Day, MonthEnd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: now = datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">11</span>, <span class="hljs-number">17</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: now + <span class="hljs-number">3</span> * Day()</span><br><span class="line">Out[<span class="hljs-number">100</span>]: Timestamp(<span class="hljs-string">'2011-11-20 00:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>如果加的是锚点偏移量（比如MonthEnd），第一次增量会将原日期向前滚动到符合频率规则的下一个日期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: now + MonthEnd()</span><br><span class="line">Out[<span class="hljs-number">101</span>]: Timestamp(<span class="hljs-string">'2011-11-30 00:00:00'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: now + MonthEnd(<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">102</span>]: Timestamp(<span class="hljs-string">'2011-12-31 00:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>通过锚点偏移量的rollforward和rollback方法，可明确地将日期向前或向后“滚动”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">103</span>]: offset = MonthEnd()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">104</span>]: offset.rollforward(now)</span><br><span class="line">Out[<span class="hljs-number">104</span>]: Timestamp(<span class="hljs-string">'2011-11-30 00:00:00'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">105</span>]: offset.rollback(now)</span><br><span class="line">Out[<span class="hljs-number">105</span>]: Timestamp(<span class="hljs-string">'2011-10-31 00:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>日期偏移量还有一个巧妙的用法，即结合groupby使用这两个“滚动”方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">106</span>]: ts = pd.Series(np.random.randn(<span class="hljs-number">20</span>),</span><br><span class="line">   .....:                index=pd.date_range(<span class="hljs-string">'1/15/2000'</span>, periods=<span class="hljs-number">20</span>, freq=<span class="hljs-string">'4d'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">107</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">107</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>   <span class="hljs-number">-0.116696</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-19</span>    <span class="hljs-number">2.389645</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-23</span>   <span class="hljs-number">-0.932454</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span>   <span class="hljs-number">-0.229331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-1.140330</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-04</span>    <span class="hljs-number">0.439920</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.823758</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-12</span>   <span class="hljs-number">-0.520930</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-16</span>    <span class="hljs-number">0.350282</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-20</span>    <span class="hljs-number">0.204395</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-24</span>    <span class="hljs-number">0.133445</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-28</span>    <span class="hljs-number">0.327905</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.072153</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-07</span>    <span class="hljs-number">0.131678</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span>   <span class="hljs-number">-1.297459</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-15</span>    <span class="hljs-number">0.997747</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-19</span>    <span class="hljs-number">0.870955</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-23</span>   <span class="hljs-number">-0.991253</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-27</span>    <span class="hljs-number">0.151699</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">1.266151</span></span><br><span class="line">Freq: <span class="hljs-number">4</span>D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">108</span>]: ts.groupby(offset.rollforward).mean()</span><br><span class="line">Out[<span class="hljs-number">108</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.005833</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.015894</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.150209</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>当然，更简单、更快速地实现该功能的办法是使用resample（11.6小节将对此进行详细介绍）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: ts.resample(<span class="hljs-string">'M'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">109</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.005833</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.015894</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.150209</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<h1 id="11-4-时区处理"><a href="#11-4-时区处理" class="headerlink" title="11.4 时区处理"></a>11.4 时区处理</h1><p>时间序列处理工作中最让人不爽的就是对时区的处理。许多人都选择以协调世界时（UTC，它是格林尼治标准时间（Greenwich Mean Time）的接替者，目前已经是国际标准了）来处理时间序列。时区是以UTC偏移量的形式表示的。例如，夏令时期间，纽约比UTC慢4小时，而在全年其他时间则比UTC慢5小时。</p>
<p>在Python中，时区信息来自第三方库pytz，它使Python可以使用Olson数据库（汇编了世界时区信息）。这对历史数据非常重要，这是因为由于各地政府的各种突发奇想，夏令时转变日期（甚至UTC偏移量）已经发生过多次改变了。就拿美国来说，DST转变时间自1900年以来就改变过多次！</p>
<p>有关pytz库的更多信息，请查阅其文档。就本书而言，由于pandas包装了pytz的功能，因此你可以不用记忆其API，只要记得时区的名称即可。时区名可以在shell中看到，也可以通过文档查看：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">110</span>]: <span class="hljs-keyword">import</span> pytz</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">111</span>]: pytz.common_timezones[<span class="hljs-number">-5</span>:]</span><br><span class="line">Out[<span class="hljs-number">111</span>]: [<span class="hljs-string">'US/Eastern'</span>, <span class="hljs-string">'US/Hawaii'</span>, <span class="hljs-string">'US/Mountain'</span>, <span class="hljs-string">'US/Pacific'</span>, <span class="hljs-string">'UTC'</span>]</span><br></pre></td></tr></table></figure>

<p>要从pytz中获取时区对象，使用pytz.timezone即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">112</span>]: tz = pytz.timezone(<span class="hljs-string">'America/New_York'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: tz</span><br><span class="line">Out[<span class="hljs-number">113</span>]: &lt;DstTzInfo <span class="hljs-string">'America/New_York'</span> LMT<span class="hljs-number">-1</span> day, <span class="hljs-number">19</span>:<span class="hljs-number">04</span>:<span class="hljs-number">00</span> STD&gt;</span><br></pre></td></tr></table></figure>

<p>pandas中的方法既可以接受时区名也可以接受这些对象。</p>
<h1 id="时区本地化和转换"><a href="#时区本地化和转换" class="headerlink" title="时区本地化和转换"></a>时区本地化和转换</h1><p>默认情况下，pandas中的时间序列是单纯（naive）的时区。看看下面这个时间序列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">114</span>]: rng = pd.date_range(<span class="hljs-string">'3/9/2012 9:30'</span>, periods=<span class="hljs-number">6</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">115</span>]: ts = pd.Series(np.random.randn(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">116</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br></pre></td></tr></table></figure>

<p>其索引的tz字段为None：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">117</span>]: print(ts.index.tz)</span><br><span class="line"><span class="hljs-literal">None</span></span><br></pre></td></tr></table></figure>

<p>可以用时区集生成日期范围：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">118</span>]: pd.date_range(<span class="hljs-string">'3/9/2012 9:30'</span>, periods=<span class="hljs-number">10</span>, freq=<span class="hljs-string">'D'</span>, tz=<span class="hljs-string">'UTC'</span>)</span><br><span class="line">Out[<span class="hljs-number">118</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-03-09 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-10 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-11 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-12 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-13 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-14 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-15 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-16 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-17 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-18 09:30:00+00:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns, UTC]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>从单纯到本地化的转换是通过tz_localize方法处理的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">119</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">119</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">120</span>]: ts_utc = ts.tz_localize(<span class="hljs-string">'UTC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">121</span>]: ts_utc</span><br><span class="line">Out[<span class="hljs-number">121</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: ts_utc.index</span><br><span class="line">Out[<span class="hljs-number">122</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-03-09 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-10 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-11 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-12 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-13 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-14 09:30:00+00:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns, UTC]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>一旦时间序列被本地化到某个特定时区，就可以用tz_convert将其转换到别的时区了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">123</span>]: ts_utc.tz_convert(<span class="hljs-string">'America/New_York'</span>)</span><br><span class="line">Out[<span class="hljs-number">123</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">04</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-05</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">04</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-05</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br></pre></td></tr></table></figure>

<p>对于上面这种时间序列（它跨越了美国东部时区的夏令时转变期），我们可以将其本地化到EST，然后转换为UTC或柏林时间：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">124</span>]: ts_eastern = ts.tz_localize(<span class="hljs-string">'America/New_York'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: ts_eastern.tz_convert(<span class="hljs-string">'UTC'</span>)</span><br><span class="line">Out[<span class="hljs-number">125</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">13</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">13</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">13</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">13</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">126</span>]: ts_eastern.tz_convert(<span class="hljs-string">'Europe/Berlin'</span>)</span><br><span class="line">Out[<span class="hljs-number">126</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">15</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">15</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br></pre></td></tr></table></figure>

<p>tz_localize和tz_convert也是DatetimeIndex的实例方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">127</span>]: ts.index.tz_localize(<span class="hljs-string">'Asia/Shanghai'</span>)</span><br><span class="line">Out[<span class="hljs-number">127</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-03-09 09:30:00+08:00'</span>, <span class="hljs-string">'2012-03-10 09:30:00+08:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-11 09:30:00+08:00'</span>, <span class="hljs-string">'2012-03-12 09:30:00+08:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-13 09:30:00+08:00'</span>, <span class="hljs-string">'2012-03-14 09:30:00+08:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns, Asia/Shanghai]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：对单纯时间戳的本地化操作还会检查夏令时转变期附近容易混淆或不存在的时间。</p>
</blockquote>
<h2 id="操作时区意识型Timestamp对象"><a href="#操作时区意识型Timestamp对象" class="headerlink" title="操作时区意识型Timestamp对象"></a>操作时区意识型Timestamp对象</h2><p>跟时间序列和日期范围差不多，独立的Timestamp对象也能被从单纯型（naive）本地化为时区意识型（time zone-aware），并从一个时区转换到另一个时区：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">128</span>]: stamp = pd.Timestamp(<span class="hljs-string">'2011-03-12 04:00'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">129</span>]: stamp_utc = stamp.tz_localize(<span class="hljs-string">'utc'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">130</span>]: stamp_utc.tz_convert(<span class="hljs-string">'America/New_York'</span>)</span><br><span class="line">Out[<span class="hljs-number">130</span>]: Timestamp(<span class="hljs-string">'2011-03-11 23:00:00-0500'</span>, tz=<span class="hljs-string">'America/New_York'</span>)</span><br></pre></td></tr></table></figure>

<p>在创建Timestamp时，还可以传入一个时区信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">131</span>]: stamp_moscow = pd.Timestamp(<span class="hljs-string">'2011-03-12 04:00'</span>, tz=<span class="hljs-string">'Europe/Moscow'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: stamp_moscow</span><br><span class="line">Out[<span class="hljs-number">132</span>]: Timestamp(<span class="hljs-string">'2011-03-12 04:00:00+0300'</span>, tz=<span class="hljs-string">'Europe/Moscow'</span>)</span><br></pre></td></tr></table></figure>

<p>时区意识型Timestamp对象在内部保存了一个UTC时间戳值（自UNIX纪元（1970年1月1日）算起的纳秒数）。这个UTC值在时区转换过程中是不会发生变化的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">133</span>]: stamp_utc.value</span><br><span class="line">Out[<span class="hljs-number">133</span>]: <span class="hljs-number">1299902400000000000</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: stamp_utc.tz_convert(<span class="hljs-string">'America/New_York'</span>).value</span><br><span class="line">Out[<span class="hljs-number">134</span>]: <span class="hljs-number">1299902400000000000</span></span><br></pre></td></tr></table></figure>

<p>当使用pandas的DateOffset对象执行时间算术运算时，运算过程会自动关注是否存在夏令时转变期。这里，我们创建了在DST转变之前的时间戳。首先，来看夏令时转变前的30分钟：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">135</span>]: <span class="hljs-keyword">from</span> pandas.tseries.offsets <span class="hljs-keyword">import</span> Hour</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">136</span>]: stamp = pd.Timestamp(<span class="hljs-string">'2012-03-12 01:30'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: stamp</span><br><span class="line">Out[<span class="hljs-number">137</span>]: Timestamp(<span class="hljs-string">'2012-03-12 01:30:00-0400'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">138</span>]: stamp + Hour()</span><br><span class="line">Out[<span class="hljs-number">138</span>]: Timestamp(<span class="hljs-string">'2012-03-12 02:30:00-0400'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br></pre></td></tr></table></figure>

<p>然后，夏令时转变前90分钟：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">139</span>]: stamp = pd.Timestamp(<span class="hljs-string">'2012-11-04 00:30'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">140</span>]: stamp</span><br><span class="line">Out[<span class="hljs-number">140</span>]: Timestamp(<span class="hljs-string">'2012-11-04 00:30:00-0400'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">141</span>]: stamp + <span class="hljs-number">2</span> * Hour()</span><br><span class="line">Out[<span class="hljs-number">141</span>]: Timestamp(<span class="hljs-string">'2012-11-04 01:30:00-0500'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="不同时区之间的运算"><a href="#不同时区之间的运算" class="headerlink" title="不同时区之间的运算"></a>不同时区之间的运算</h2><p>如果两个时间序列的时区不同，在将它们合并到一起时，最终结果就会是UTC。由于时间戳其实是以UTC存储的，所以这是一个很简单的运算，并不需要发生任何转换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">142</span>]: rng = pd.date_range(<span class="hljs-string">'3/7/2012 9:30'</span>, periods=<span class="hljs-number">10</span>, freq=<span class="hljs-string">'B'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">143</span>]: ts = pd.Series(np.random.randn(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">144</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">144</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-07</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.522356</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.546348</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.733537</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">1.302736</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.022199</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.364287</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-15</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.922839</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-16</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.312656</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-19</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-1.128497</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.333488</span></span><br><span class="line">Freq: B, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">145</span>]: ts1 = ts[:<span class="hljs-number">7</span>].tz_localize(<span class="hljs-string">'Europe/London'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">146</span>]: ts2 = ts1[<span class="hljs-number">2</span>:].tz_convert(<span class="hljs-string">'Europe/Moscow'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">147</span>]: result = ts1 + ts2</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">148</span>]: result.index</span><br><span class="line">Out[<span class="hljs-number">148</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-03-07 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-08 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-09 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-12 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-13 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-14 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-15 09:30:00+00:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns, UTC]'</span>, freq=<span class="hljs-string">'B'</span>)</span><br></pre></td></tr></table></figure>

<h1 id="11-5-时期及其算术运算"><a href="#11-5-时期及其算术运算" class="headerlink" title="11.5 时期及其算术运算"></a>11.5 时期及其算术运算</h1><p>时期（period）表示的是时间区间，比如数日、数月、数季、数年等。Period类所表示的就是这种数据类型，其构造函数需要用到一个字符串或整数，以及表11-4中的频率：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">149</span>]: p = pd.Period(<span class="hljs-number">2007</span>, freq=<span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">150</span>]: p</span><br><span class="line">Out[<span class="hljs-number">150</span>]: Period(<span class="hljs-string">'2007'</span>, <span class="hljs-string">'A-DEC'</span>)</span><br></pre></td></tr></table></figure>

<p>这里，这个Period对象表示的是从2007年1月1日到2007年12月31日之间的整段时间。只需对Period对象加上或减去一个整数即可达到根据其频率进行位移的效果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">151</span>]: p + <span class="hljs-number">5</span></span><br><span class="line">Out[<span class="hljs-number">151</span>]: Period(<span class="hljs-string">'2012'</span>, <span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">152</span>]: p - <span class="hljs-number">2</span></span><br><span class="line">Out[<span class="hljs-number">152</span>]: Period(<span class="hljs-string">'2005'</span>, <span class="hljs-string">'A-DEC'</span>)</span><br></pre></td></tr></table></figure>

<p>如果两个Period对象拥有相同的频率，则它们的差就是它们之间的单位数量：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">153</span>]: pd.Period(<span class="hljs-string">'2014'</span>, freq=<span class="hljs-string">'A-DEC'</span>) - p</span><br><span class="line">Out[<span class="hljs-number">153</span>]: <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<p>period_range函数可用于创建规则的时期范围：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">154</span>]: rng = pd.period_range(<span class="hljs-string">'2000-01-01'</span>, <span class="hljs-string">'2000-06-30'</span>, freq=<span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">155</span>]: rng</span><br><span class="line">Out[<span class="hljs-number">155</span>]: PeriodIndex([<span class="hljs-string">'2000-01'</span>, <span class="hljs-string">'2000-02'</span>, <span class="hljs-string">'2000-03'</span>, <span class="hljs-string">'2000-04'</span>, <span class="hljs-string">'2000-05'</span>, <span class="hljs-string">'20</span></span><br><span class="line"><span class="hljs-string">00-06'</span>], dtype=<span class="hljs-string">'period[M]'</span>, freq=<span class="hljs-string">'M'</span>)</span><br></pre></td></tr></table></figure>

<p>PeriodIndex类保存了一组Period，它可以在任何pandas数据结构中被用作轴索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">156</span>]: pd.Series(np.random.randn(<span class="hljs-number">6</span>), index=rng)</span><br><span class="line">Out[<span class="hljs-number">156</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.514551</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.559782</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.783408</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span>   <span class="hljs-number">-1.797685</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-05</span>   <span class="hljs-number">-0.172670</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-06</span>    <span class="hljs-number">0.680215</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>如果你有一个字符串数组，你也可以使用PeriodIndex类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">157</span>]: values = [<span class="hljs-string">'2001Q3'</span>, <span class="hljs-string">'2002Q2'</span>, <span class="hljs-string">'2003Q1'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: index = pd.PeriodIndex(values, freq=<span class="hljs-string">'Q-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">159</span>]: index</span><br><span class="line">Out[<span class="hljs-number">159</span>]: PeriodIndex([<span class="hljs-string">'2001Q3'</span>, <span class="hljs-string">'2002Q2'</span>, <span class="hljs-string">'2003Q1'</span>], dtype=<span class="hljs-string">'period[Q-DEC]'</span>, freq</span><br><span class="line">=<span class="hljs-string">'Q-DEC'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="时期的频率转换"><a href="#时期的频率转换" class="headerlink" title="时期的频率转换"></a>时期的频率转换</h2><p>Period和PeriodIndex对象都可以通过其asfreq方法被转换成别的频率。假设我们有一个年度时期，希望将其转换为当年年初或年末的一个月度时期。该任务非常简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">160</span>]: p = pd.Period(<span class="hljs-string">'2007'</span>, freq=<span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">161</span>]: p</span><br><span class="line">Out[<span class="hljs-number">161</span>]: Period(<span class="hljs-string">'2007'</span>, <span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: p.asfreq(<span class="hljs-string">'M'</span>, how=<span class="hljs-string">'start'</span>)</span><br><span class="line">Out[<span class="hljs-number">162</span>]: Period(<span class="hljs-string">'2007-01'</span>, <span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">163</span>]: p.asfreq(<span class="hljs-string">'M'</span>, how=<span class="hljs-string">'end'</span>)</span><br><span class="line">Out[<span class="hljs-number">163</span>]: Period(<span class="hljs-string">'2007-12'</span>, <span class="hljs-string">'M'</span>)</span><br></pre></td></tr></table></figure>

<p>你可以将Period(‘2007’,’A-DEC’)看做一个被划分为多个月度时期的时间段中的游标。图11-1对此进行了说明。对于一个不以12月结束的财政年度，月度子时期的归属情况就不一样了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">164</span>]: p = pd.Period(<span class="hljs-string">'2007'</span>, freq=<span class="hljs-string">'A-JUN'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">165</span>]: p</span><br><span class="line">Out[<span class="hljs-number">165</span>]: Period(<span class="hljs-string">'2007'</span>, <span class="hljs-string">'A-JUN'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">166</span>]: p.asfreq(<span class="hljs-string">'M'</span>, <span class="hljs-string">'start'</span>)</span><br><span class="line">Out[<span class="hljs-number">166</span>]: Period(<span class="hljs-string">'2006-07'</span>, <span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">167</span>]: p.asfreq(<span class="hljs-string">'M'</span>, <span class="hljs-string">'end'</span>)</span><br><span class="line">Out[<span class="hljs-number">167</span>]: Period(<span class="hljs-string">'2007-06'</span>, <span class="hljs-string">'M'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-d201200d0e65676f.webp" alt="img"></p>
<p>图11-1 Period频率转换示例</p>
<p>在将高频率转换为低频率时，超时期（superperiod）是由子时期（subperiod）所属的位置决定的。例如，在A-JUN频率中，月份“2007年8月”实际上是属于周期“2008年”的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">168</span>]: p = pd.Period(<span class="hljs-string">'Aug-2007'</span>, <span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">169</span>]: p.asfreq(<span class="hljs-string">'A-JUN'</span>)</span><br><span class="line">Out[<span class="hljs-number">169</span>]: Period(<span class="hljs-string">'2008'</span>, <span class="hljs-string">'A-JUN'</span>)</span><br></pre></td></tr></table></figure>

<p>完整的PeriodIndex或TimeSeries的频率转换方式也是如此：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">170</span>]: rng = pd.period_range(<span class="hljs-string">'2006'</span>, <span class="hljs-string">'2009'</span>, freq=<span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">171</span>]: ts = pd.Series(np.random.randn(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">172</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">172</span>]: </span><br><span class="line"><span class="hljs-number">2006</span>    <span class="hljs-number">1.607578</span></span><br><span class="line"><span class="hljs-number">2007</span>    <span class="hljs-number">0.200381</span></span><br><span class="line"><span class="hljs-number">2008</span>   <span class="hljs-number">-0.834068</span></span><br><span class="line"><span class="hljs-number">2009</span>   <span class="hljs-number">-0.302988</span></span><br><span class="line">Freq: A-DEC, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">173</span>]: ts.asfreq(<span class="hljs-string">'M'</span>, how=<span class="hljs-string">'start'</span>)</span><br><span class="line">Out[<span class="hljs-number">173</span>]: </span><br><span class="line"><span class="hljs-number">2006</span><span class="hljs-number">-01</span>    <span class="hljs-number">1.607578</span></span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.200381</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.834068</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.302988</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>这里，根据年度时期的第一个月，每年的时期被取代为每月的时期。如果我们想要每年的最后一个工作日，我们可以使用“B”频率，并指明想要该时期的末尾：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">174</span>]: ts.asfreq(<span class="hljs-string">'B'</span>, how=<span class="hljs-string">'end'</span>)</span><br><span class="line"></span><br><span class="line">Out[<span class="hljs-number">174</span>]: </span><br><span class="line"><span class="hljs-number">2006</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span>    <span class="hljs-number">1.607578</span></span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.200381</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.834068</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.302988</span></span><br><span class="line">Freq: B, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="按季度计算的时期频率"><a href="#按季度计算的时期频率" class="headerlink" title="按季度计算的时期频率"></a>按季度计算的时期频率</h2><p>季度型数据在会计、金融等领域中很常见。许多季度型数据都会涉及“财年末”的概念，通常是一年12个月中某月的最后一个日历日或工作日。就这一点来说，时期”2012Q4”根据财年末的不同会有不同的含义。pandas支持12种可能的季度型频率，即Q-JAN到Q-DEC：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">175</span>]: p = pd.Period(<span class="hljs-string">'2012Q4'</span>, freq=<span class="hljs-string">'Q-JAN'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">176</span>]: p</span><br><span class="line">Out[<span class="hljs-number">176</span>]: Period(<span class="hljs-string">'2012Q4'</span>, <span class="hljs-string">'Q-JAN'</span>)</span><br></pre></td></tr></table></figure>

<p>在以1月结束的财年中，2012Q4是从11月到1月（将其转换为日型频率就明白了）。图11-2对此进行了说明：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">177</span>]: p.asfreq(<span class="hljs-string">'D'</span>, <span class="hljs-string">'start'</span>)</span><br><span class="line">Out[<span class="hljs-number">177</span>]: Period(<span class="hljs-string">'2011-11-01'</span>, <span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">178</span>]: p.asfreq(<span class="hljs-string">'D'</span>, <span class="hljs-string">'end'</span>)</span><br><span class="line">Out[<span class="hljs-number">178</span>]: Period(<span class="hljs-string">'2012-01-31'</span>, <span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-e2e1d52c9766f6ff.webp" alt="img"></p>
<p>图11.2 不同季度型频率之间的转换</p>
<p>因此，Period之间的算术运算会非常简单。例如，要获取该季度倒数第二个工作日下午4点的时间戳，你可以这样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">179</span>]: p4pm = (p.asfreq(<span class="hljs-string">'B'</span>, <span class="hljs-string">'e'</span>) - <span class="hljs-number">1</span>).asfreq(<span class="hljs-string">'T'</span>, <span class="hljs-string">'s'</span>) + <span class="hljs-number">16</span> * <span class="hljs-number">60</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">180</span>]: p4pm</span><br><span class="line">Out[<span class="hljs-number">180</span>]: Period(<span class="hljs-string">'2012-01-30 16:00'</span>, <span class="hljs-string">'T'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">181</span>]: p4pm.to_timestamp()</span><br><span class="line">Out[<span class="hljs-number">181</span>]: Timestamp(<span class="hljs-string">'2012-01-30 16:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>period_range可用于生成季度型范围。季度型范围的算术运算也跟上面是一样的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">182</span>]: rng = pd.period_range(<span class="hljs-string">'2011Q3'</span>, <span class="hljs-string">'2012Q4'</span>, freq=<span class="hljs-string">'Q-JAN'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">183</span>]: ts = pd.Series(np.arange(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">184</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">184</span>]: </span><br><span class="line"><span class="hljs-number">2011</span>Q3    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2011</span>Q4    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2012</span>Q1    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2012</span>Q2    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2012</span>Q3    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2012</span>Q4    <span class="hljs-number">5</span></span><br><span class="line">Freq: Q-JAN, dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">185</span>]: new_rng = (rng.asfreq(<span class="hljs-string">'B'</span>, <span class="hljs-string">'e'</span>) - <span class="hljs-number">1</span>).asfreq(<span class="hljs-string">'T'</span>, <span class="hljs-string">'s'</span>) + <span class="hljs-number">16</span> * <span class="hljs-number">60</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">186</span>]: ts.index = new_rng.to_timestamp()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">187</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">187</span>]:</span><br><span class="line"><span class="hljs-number">2010</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-04</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-07</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-01</span><span class="hljs-number">-30</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">5</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h2 id="将Timestamp转换为Period（及其反向过程）"><a href="#将Timestamp转换为Period（及其反向过程）" class="headerlink" title="将Timestamp转换为Period（及其反向过程）"></a>将Timestamp转换为Period（及其反向过程）</h2><p>通过使用to_period方法，可以将由时间戳索引的Series和DataFrame对象转换为以时期索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">188</span>]: rng = pd.date_range(<span class="hljs-string">'2000-01-01'</span>, periods=<span class="hljs-number">3</span>, freq=<span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">189</span>]: ts = pd.Series(np.random.randn(<span class="hljs-number">3</span>), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">190</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">190</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>    <span class="hljs-number">1.663261</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>   <span class="hljs-number">-0.996206</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">1.521760</span></span><br><span class="line">Freq: M, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">191</span>]: pts = ts.to_period()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">192</span>]: pts</span><br><span class="line">Out[<span class="hljs-number">192</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>    <span class="hljs-number">1.663261</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.996206</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span>    <span class="hljs-number">1.521760</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>由于时期指的是非重叠时间区间，因此对于给定的频率，一个时间戳只能属于一个时期。新PeriodIndex的频率默认是从时间戳推断而来的，你也可以指定任何别的频率。结果中允许存在重复时期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">193</span>]: rng = pd.date_range(<span class="hljs-string">'1/29/2000'</span>, periods=<span class="hljs-number">6</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">194</span>]: ts2 = pd.Series(np.random.randn(<span class="hljs-number">6</span>), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">195</span>]: ts2</span><br><span class="line">Out[<span class="hljs-number">195</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.244175</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.423331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.654040</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-01</span>    <span class="hljs-number">2.089154</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.060220</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.167933</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">196</span>]: ts2.to_period(<span class="hljs-string">'M'</span>)</span><br><span class="line">Out[<span class="hljs-number">196</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.244175</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.423331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.654040</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>    <span class="hljs-number">2.089154</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.060220</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.167933</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>要转换回时间戳，使用to_timestamp即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">197</span>]: pts = ts2.to_period()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">198</span>]: pts</span><br><span class="line">Out[<span class="hljs-number">198</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.244175</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.423331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.654040</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-01</span>    <span class="hljs-number">2.089154</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.060220</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.167933</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">199</span>]: pts.to_timestamp(how=<span class="hljs-string">'end'</span>)</span><br><span class="line">Out[<span class="hljs-number">199</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.244175</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.423331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.654040</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-01</span>    <span class="hljs-number">2.089154</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.060220</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.167933</span></span><br><span class="line">Freq: D, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="通过数组创建PeriodIndex"><a href="#通过数组创建PeriodIndex" class="headerlink" title="通过数组创建PeriodIndex"></a>通过数组创建PeriodIndex</h2><p>固定频率的数据集通常会将时间信息分开存放在多个列中。例如，在下面这个宏观经济数据集中，年度和季度就分别存放在不同的列中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">200</span>]: data = pd.read_csv(<span class="hljs-string">'examples/macrodata.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">201</span>]: data.head(<span class="hljs-number">5</span>)</span><br><span class="line">Out[<span class="hljs-number">201</span>]: </span><br><span class="line">     year  quarter   realgdp  realcons  realinv  realgovt  realdpi    cpi  \</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">1.0</span>  <span class="hljs-number">2710.349</span>    <span class="hljs-number">1707.4</span>  <span class="hljs-number">286.898</span>   <span class="hljs-number">470.045</span>   <span class="hljs-number">1886.9</span>  <span class="hljs-number">28.98</span>   </span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">2.0</span>  <span class="hljs-number">2778.801</span>    <span class="hljs-number">1733.7</span>  <span class="hljs-number">310.859</span>   <span class="hljs-number">481.301</span>   <span class="hljs-number">1919.7</span>  <span class="hljs-number">29.15</span>   </span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">3.0</span>  <span class="hljs-number">2775.488</span>    <span class="hljs-number">1751.8</span>  <span class="hljs-number">289.226</span>   <span class="hljs-number">491.260</span>   <span class="hljs-number">1916.4</span>  <span class="hljs-number">29.35</span>   </span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">4.0</span>  <span class="hljs-number">2785.204</span>    <span class="hljs-number">1753.7</span>  <span class="hljs-number">299.356</span>   <span class="hljs-number">484.052</span>   <span class="hljs-number">1931.3</span>  <span class="hljs-number">29.37</span>   </span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1960.0</span>      <span class="hljs-number">1.0</span>  <span class="hljs-number">2847.699</span>    <span class="hljs-number">1770.5</span>  <span class="hljs-number">331.722</span>   <span class="hljs-number">462.199</span>   <span class="hljs-number">1955.5</span>  <span class="hljs-number">29.54</span>   </span><br><span class="line">      m1  tbilrate  unemp      pop  infl  realint  </span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">139.7</span>      <span class="hljs-number">2.82</span>    <span class="hljs-number">5.8</span>  <span class="hljs-number">177.146</span>  <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  </span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">141.7</span>      <span class="hljs-number">3.08</span>    <span class="hljs-number">5.1</span>  <span class="hljs-number">177.830</span>  <span class="hljs-number">2.34</span>     <span class="hljs-number">0.74</span>  </span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">140.5</span>      <span class="hljs-number">3.82</span>    <span class="hljs-number">5.3</span>  <span class="hljs-number">178.657</span>  <span class="hljs-number">2.74</span>     <span class="hljs-number">1.09</span>  </span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">140.0</span>      <span class="hljs-number">4.33</span>    <span class="hljs-number">5.6</span>  <span class="hljs-number">179.386</span>  <span class="hljs-number">0.27</span>     <span class="hljs-number">4.06</span>  </span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">139.6</span>      <span class="hljs-number">3.50</span>    <span class="hljs-number">5.2</span>  <span class="hljs-number">180.007</span>  <span class="hljs-number">2.31</span>     <span class="hljs-number">1.19</span>  </span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">202</span>]: data.year</span><br><span class="line">Out[<span class="hljs-number">202</span>]: </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">1959.0</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1959.0</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">1959.0</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">1959.0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">1960.0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">1960.0</span></span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">1960.0</span></span><br><span class="line"><span class="hljs-number">7</span>      <span class="hljs-number">1960.0</span></span><br><span class="line"><span class="hljs-number">8</span>      <span class="hljs-number">1961.0</span></span><br><span class="line"><span class="hljs-number">9</span>      <span class="hljs-number">1961.0</span></span><br><span class="line">        ...  </span><br><span class="line"><span class="hljs-number">193</span>    <span class="hljs-number">2007.0</span></span><br><span class="line"><span class="hljs-number">194</span>    <span class="hljs-number">2007.0</span></span><br><span class="line"><span class="hljs-number">195</span>    <span class="hljs-number">2007.0</span></span><br><span class="line"><span class="hljs-number">196</span>    <span class="hljs-number">2008.0</span></span><br><span class="line"><span class="hljs-number">197</span>    <span class="hljs-number">2008.0</span></span><br><span class="line"><span class="hljs-number">198</span>    <span class="hljs-number">2008.0</span></span><br><span class="line"><span class="hljs-number">199</span>    <span class="hljs-number">2008.0</span></span><br><span class="line"><span class="hljs-number">200</span>    <span class="hljs-number">2009.0</span></span><br><span class="line"><span class="hljs-number">201</span>    <span class="hljs-number">2009.0</span></span><br><span class="line"><span class="hljs-number">202</span>    <span class="hljs-number">2009.0</span></span><br><span class="line">Name: year, Length: <span class="hljs-number">203</span>, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">203</span>]: data.quarter</span><br><span class="line">Out[<span class="hljs-number">203</span>]: </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">7</span>      <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">8</span>      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">9</span>      <span class="hljs-number">2.0</span></span><br><span class="line">      ... </span><br><span class="line"><span class="hljs-number">193</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">194</span>    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">195</span>    <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">196</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">197</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">198</span>    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">199</span>    <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">200</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">201</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">202</span>    <span class="hljs-number">3.0</span></span><br><span class="line">Name: quarter, Length: <span class="hljs-number">203</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>通过将这些数组以及一个频率传入PeriodIndex，就可以将它们合并成DataFrame的一个索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">204</span>]: index = pd.PeriodIndex(year=data.year, quarter=data.quarter,</span><br><span class="line">   .....:                        freq=<span class="hljs-string">'Q-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">205</span>]: index</span><br><span class="line">Out[<span class="hljs-number">205</span>]: </span><br><span class="line">PeriodIndex([<span class="hljs-string">'1959Q1'</span>, <span class="hljs-string">'1959Q2'</span>, <span class="hljs-string">'1959Q3'</span>, <span class="hljs-string">'1959Q4'</span>, <span class="hljs-string">'1960Q1'</span>, <span class="hljs-string">'1960Q2'</span>,</span><br><span class="line">             <span class="hljs-string">'1960Q3'</span>, <span class="hljs-string">'1960Q4'</span>, <span class="hljs-string">'1961Q1'</span>, <span class="hljs-string">'1961Q2'</span>,</span><br><span class="line">             ...</span><br><span class="line">             <span class="hljs-string">'2007Q2'</span>, <span class="hljs-string">'2007Q3'</span>, <span class="hljs-string">'2007Q4'</span>, <span class="hljs-string">'2008Q1'</span>, <span class="hljs-string">'2008Q2'</span>, <span class="hljs-string">'2008Q3'</span>,</span><br><span class="line">             <span class="hljs-string">'2008Q4'</span>, <span class="hljs-string">'2009Q1'</span>, <span class="hljs-string">'2009Q2'</span>, <span class="hljs-string">'2009Q3'</span>],</span><br><span class="line">            dtype=<span class="hljs-string">'period[Q-DEC]'</span>, length=<span class="hljs-number">203</span>, freq=<span class="hljs-string">'Q-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">206</span>]: data.index = index</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">207</span>]: data.infl</span><br><span class="line">Out[<span class="hljs-number">207</span>]: </span><br><span class="line"><span class="hljs-number">1959</span>Q1    <span class="hljs-number">0.00</span></span><br><span class="line"><span class="hljs-number">1959</span>Q2    <span class="hljs-number">2.34</span></span><br><span class="line"><span class="hljs-number">1959</span>Q3    <span class="hljs-number">2.74</span></span><br><span class="line"><span class="hljs-number">1959</span>Q4    <span class="hljs-number">0.27</span></span><br><span class="line"><span class="hljs-number">1960</span>Q1    <span class="hljs-number">2.31</span></span><br><span class="line"><span class="hljs-number">1960</span>Q2    <span class="hljs-number">0.14</span></span><br><span class="line"><span class="hljs-number">1960</span>Q3    <span class="hljs-number">2.70</span></span><br><span class="line"><span class="hljs-number">1960</span>Q4    <span class="hljs-number">1.21</span></span><br><span class="line"><span class="hljs-number">1961</span>Q1   <span class="hljs-number">-0.40</span></span><br><span class="line"><span class="hljs-number">1961</span>Q2    <span class="hljs-number">1.47</span></span><br><span class="line">          ... </span><br><span class="line"><span class="hljs-number">2007</span>Q2    <span class="hljs-number">2.75</span></span><br><span class="line"><span class="hljs-number">2007</span>Q3    <span class="hljs-number">3.45</span></span><br><span class="line"><span class="hljs-number">2007</span>Q4    <span class="hljs-number">6.38</span></span><br><span class="line"><span class="hljs-number">2008</span>Q1    <span class="hljs-number">2.82</span></span><br><span class="line"><span class="hljs-number">2008</span>Q2    <span class="hljs-number">8.53</span></span><br><span class="line"><span class="hljs-number">2008</span>Q3   <span class="hljs-number">-3.16</span></span><br><span class="line"><span class="hljs-number">2008</span>Q4   <span class="hljs-number">-8.79</span></span><br><span class="line"><span class="hljs-number">2009</span>Q1    <span class="hljs-number">0.94</span></span><br><span class="line"><span class="hljs-number">2009</span>Q2    <span class="hljs-number">3.37</span></span><br><span class="line"><span class="hljs-number">2009</span>Q3    <span class="hljs-number">3.56</span></span><br><span class="line">Freq: Q-DEC, Name: infl, Length: <span class="hljs-number">203</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<h1 id="11-6-重采样及频率转换"><a href="#11-6-重采样及频率转换" class="headerlink" title="11.6 重采样及频率转换"></a>11.6 重采样及频率转换</h1><p>重采样（resampling）指的是将时间序列从一个频率转换到另一个频率的处理过程。将高频率数据聚合到低频率称为降采样（downsampling），而将低频率数据转换到高频率则称为升采样（upsampling）。并不是所有的重采样都能被划分到这两个大类中。例如，将W-WED（每周三）转换为W-FRI既不是降采样也不是升采样。</p>
<p>pandas对象都带有一个resample方法，它是各种频率转换工作的主力函数。resample有一个类似于groupby的API，调用resample可以分组数据，然后会调用一个聚合函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">208</span>]: rng = pd.date_range(<span class="hljs-string">'2000-01-01'</span>, periods=<span class="hljs-number">100</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">209</span>]: ts = pd.Series(np.random.randn(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">210</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">210</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.631634</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-1.594313</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>   <span class="hljs-number">-1.519937</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>    <span class="hljs-number">1.108752</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">1.255853</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>   <span class="hljs-number">-0.024330</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-2.047939</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.272657</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>   <span class="hljs-number">-1.692615</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.423830</span></span><br><span class="line">                ...   </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.007852</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-01</span>   <span class="hljs-number">-1.638806</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-02</span>    <span class="hljs-number">1.401227</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-03</span>    <span class="hljs-number">1.758539</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-04</span>    <span class="hljs-number">0.628932</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-05</span>   <span class="hljs-number">-0.423776</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-06</span>    <span class="hljs-number">0.789740</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-07</span>    <span class="hljs-number">0.937568</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-08</span>   <span class="hljs-number">-2.253294</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-09</span>   <span class="hljs-number">-1.772919</span></span><br><span class="line">Freq: D, Length: <span class="hljs-number">100</span>, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">211</span>]: ts.resample(<span class="hljs-string">'M'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">211</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.165893</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.078606</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.223811</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>   <span class="hljs-number">-0.063643</span></span><br><span class="line">Freq: M, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">212</span>]: ts.resample(<span class="hljs-string">'M'</span>, kind=<span class="hljs-string">'period'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">212</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.165893</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>    <span class="hljs-number">0.078606</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.223811</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span>   <span class="hljs-number">-0.063643</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>resample是一个灵活高效的方法，可用于处理非常大的时间序列。我将通过一系列的示例说明其用法。表11-5总结它的一些选项。</p>
<p>表11-5 resample方法的参数</p>
<p><img src="/images/blog/7178691-b40a57086c904e83.webp" alt="img"></p>
<h2 id="降采样"><a href="#降采样" class="headerlink" title="降采样"></a>降采样</h2><p>将数据聚合到规律的低频率是一件非常普通的时间序列处理任务。待聚合的数据不必拥有固定的频率，期望的频率会自动定义聚合的面元边界，这些面元用于将时间序列拆分为多个片段。例如，要转换到月度频率（’M’或’BM’），数据需要被划分到多个单月时间段中。各时间段都是半开放的。一个数据点只能属于一个时间段，所有时间段的并集必须能组成整个时间帧。在用resample对数据进行降采样时，需要考虑两样东西：</p>
<ul>
<li>各区间哪边是闭合的。</li>
<li>如何标记各个聚合面元，用区间的开头还是末尾。</li>
</ul>
<p>为了说明，我们来看一些“1分钟”数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">213</span>]: rng = pd.date_range(<span class="hljs-string">'2000-01-01'</span>, periods=<span class="hljs-number">12</span>, freq=<span class="hljs-string">'T'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">214</span>]: ts = pd.Series(np.arange(<span class="hljs-number">12</span>), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">215</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">215</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>     <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">00</span>     <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00</span>     <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">04</span>:<span class="hljs-number">00</span>     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00</span>     <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">00</span>     <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">08</span>:<span class="hljs-number">00</span>     <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">09</span>:<span class="hljs-number">00</span>     <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">00</span>    <span class="hljs-number">11</span></span><br><span class="line">Freq: T, dtype: int64</span><br></pre></td></tr></table></figure>

<p>假设你想要通过求和的方式将这些数据聚合到“5分钟”块中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">216</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">216</span>]: </span><br><span class="line"><span class="hljs-number">1999</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">23</span>:<span class="hljs-number">55</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>    <span class="hljs-number">40</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">11</span></span><br><span class="line">Freq: <span class="hljs-number">5</span>T, dtype: int64</span><br></pre></td></tr></table></figure>

<p>传入的频率将会以“5分钟”的增量定义面元边界。默认情况下，面元的右边界是包含的，因此00:00到00:05的区间中是包含00:05的。传入closed=’left’会让区间以左边界闭合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">217</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">217</span>]: </span><br><span class="line"><span class="hljs-number">1999</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">23</span>:<span class="hljs-number">55</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>    <span class="hljs-number">40</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">11</span></span><br><span class="line">Freq: <span class="hljs-number">5</span>T, dtype: int64</span><br></pre></td></tr></table></figure>

<p>如你所见，最终的时间序列是以各面元右边界的时间戳进行标记的。传入label=’right’即可用面元的邮编界对其进行标记：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">218</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>, label=<span class="hljs-string">'right'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">218</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>    <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">40</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">15</span>:<span class="hljs-number">00</span>    <span class="hljs-number">11</span></span><br><span class="line">Freq: <span class="hljs-number">5</span>T, dtype: int64</span><br></pre></td></tr></table></figure>

<p>图11-3说明了“1分钟”数据被转换为“5分钟”数据的处理过程。</p>
<p><img src="/images/blog/7178691-7a77f47844f2ee8c.webp" alt="img"></p>
<p>图11-3 各种closed、label约定的“5分钟”重采样演示</p>
<p>最后，你可能希望对结果索引做一些位移，比如从右边界减去一秒以便更容易明白该时间戳到底表示的是哪个区间。只需通过loffset设置一个字符串或日期偏移量即可实现这个目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">219</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>,</span><br><span class="line">   .....:             label=<span class="hljs-string">'right'</span>, loffset=<span class="hljs-string">'-1s'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">219</span>]: </span><br><span class="line"><span class="hljs-number">1999</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">23</span>:<span class="hljs-number">59</span>:<span class="hljs-number">59</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">04</span>:<span class="hljs-number">59</span>    <span class="hljs-number">15</span></span><br><span class="line">In [<span class="hljs-number">219</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>,</span><br><span class="line">   .....:             label=<span class="hljs-string">'right'</span>, loffset=<span class="hljs-string">'-1s'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">219</span>]: </span><br><span class="line"><span class="hljs-number">1999</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">23</span>:<span class="hljs-number">59</span>:<span class="hljs-number">59</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">04</span>:<span class="hljs-number">59</span>    <span class="hljs-number">15</span></span><br></pre></td></tr></table></figure>

<p>此外，也可以通过调用结果对象的shift方法来实现该目的，这样就不需要设置loffset了。</p>
<h2 id="OHLC重采样"><a href="#OHLC重采样" class="headerlink" title="OHLC重采样"></a>OHLC重采样</h2><p>金融领域中有一种无所不在的时间序列聚合方式，即计算各面元的四个值：第一个值（open，开盘）、最后一个值（close，收盘）、最大值（high，最高）以及最小值（low，最低）。传入how=’ohlc’即可得到一个含有这四种聚合值的DataFrame。整个过程很高效，只需一次扫描即可计算出结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">220</span>]: ts.resample(<span class="hljs-string">'5min'</span>).ohlc()</span><br><span class="line">Out[<span class="hljs-number">220</span>]: </span><br><span class="line">                     open  high  low  close</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span>     <span class="hljs-number">4</span>    <span class="hljs-number">0</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>     <span class="hljs-number">5</span>     <span class="hljs-number">9</span>    <span class="hljs-number">5</span>      <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">10</span>    <span class="hljs-number">11</span>   <span class="hljs-number">10</span>     <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<h2 id="升采样和插值"><a href="#升采样和插值" class="headerlink" title="升采样和插值"></a>升采样和插值</h2><p>在将数据从低频率转换到高频率时，就不需要聚合了。我们来看一个带有一些周型数据的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">221</span>]: frame = pd.DataFrame(np.random.randn(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>),</span><br><span class="line">   .....:                      index=pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">2</span>,</span><br><span class="line">   .....:                                          freq=<span class="hljs-string">'W-WED'</span>),</span><br><span class="line">   .....:                      columns=[<span class="hljs-string">'Colorado'</span>, <span class="hljs-string">'Texas'</span>, <span class="hljs-string">'New York'</span>, <span class="hljs-string">'Ohio'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">222</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">222</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<p>当你对这个数据进行聚合，每组只有一个值，这样就会引入缺失值。我们使用asfreq方法转换成高频，不经过聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">223</span>]: df_daily = frame.resample(<span class="hljs-string">'D'</span>).asfreq()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">224</span>]: df_daily</span><br><span class="line">Out[<span class="hljs-number">224</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-11</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<p>假设你想要用前面的周型值填充“非星期三”。resampling的填充和插值方式跟fillna和reindex的一样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">225</span>]: frame.resample(<span class="hljs-string">'D'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">225</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-11</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<p>同样，这里也可以只填充指定的时期数（目的是限制前面的观测值的持续使用距离）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">226</span>]: frame.resample(<span class="hljs-string">'D'</span>).ffill(limit=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">226</span>]:</span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-11</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<p>注意，新的日期索引完全没必要跟旧的重叠：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">227</span>]: frame.resample(<span class="hljs-string">'W-THU'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">227</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-13</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<h2 id="通过时期进行重采样"><a href="#通过时期进行重采样" class="headerlink" title="通过时期进行重采样"></a>通过时期进行重采样</h2><p>对那些使用时期索引的数据进行重采样与时间戳很像：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">228</span>]: frame = pd.DataFrame(np.random.randn(<span class="hljs-number">24</span>, <span class="hljs-number">4</span>),</span><br><span class="line">   .....:                      index=pd.period_range(<span class="hljs-string">'1-2000'</span>, <span class="hljs-string">'12-2001'</span>,</span><br><span class="line">   .....:                                            freq=<span class="hljs-string">'M'</span>),</span><br><span class="line">   .....:                      columns=[<span class="hljs-string">'Colorado'</span>, <span class="hljs-string">'Texas'</span>, <span class="hljs-string">'New York'</span>, <span class="hljs-string">'Ohio'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">229</span>]: frame[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">229</span>]: </span><br><span class="line">         Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>  <span class="hljs-number">0.493841</span> <span class="hljs-number">-0.155434</span>  <span class="hljs-number">1.397286</span>  <span class="hljs-number">1.507055</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span> <span class="hljs-number">-1.179442</span>  <span class="hljs-number">0.443171</span>  <span class="hljs-number">1.395676</span> <span class="hljs-number">-0.529658</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span>  <span class="hljs-number">0.787358</span>  <span class="hljs-number">0.248845</span>  <span class="hljs-number">0.743239</span>  <span class="hljs-number">1.267746</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span>  <span class="hljs-number">1.302395</span> <span class="hljs-number">-0.272154</span> <span class="hljs-number">-0.051532</span> <span class="hljs-number">-0.467740</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-05</span> <span class="hljs-number">-1.040816</span>  <span class="hljs-number">0.426419</span>  <span class="hljs-number">0.312945</span> <span class="hljs-number">-1.115689</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">230</span>]: annual_frame = frame.resample(<span class="hljs-string">'A-DEC'</span>).mean()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">231</span>]: annual_frame</span><br><span class="line">Out[<span class="hljs-number">231</span>]: </span><br><span class="line">      Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span>  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br></pre></td></tr></table></figure>

<p>升采样要稍微麻烦一些，因为你必须决定在新频率中各区间的哪端用于放置原来的值，就像asfreq方法那样。convention参数默认为’start’，也可设置为’end’：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Q-DEC: Quarterly, year ending in December</span></span><br><span class="line">In [<span class="hljs-number">232</span>]: annual_frame.resample(<span class="hljs-string">'Q-DEC'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">232</span>]: </span><br><span class="line">        Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span>Q1  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2000</span>Q2  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2000</span>Q3  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2000</span>Q4  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q1  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2001</span>Q2  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2001</span>Q3  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2001</span>Q4  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">233</span>]: annual_frame.resample(<span class="hljs-string">'Q-DEC'</span>, convention=<span class="hljs-string">'end'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">233</span>]: </span><br><span class="line">        Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span>Q4  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q1  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q2  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q3  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q4  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br></pre></td></tr></table></figure>

<p>由于时期指的是时间区间，所以升采样和降采样的规则就比较严格：</p>
<ul>
<li>在降采样中，目标频率必须是源频率的子时期（subperiod）。</li>
<li>在升采样中，目标频率必须是源频率的超时期（superperiod）。</li>
</ul>
<p>如果不满足这些条件，就会引发异常。这主要影响的是按季、年、周计算的频率。例如，由Q-MAR定义的时间区间只能升采样为A-MAR、A-JUN、A-SEP、A-DEC等：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">234</span>]: annual_frame.resample(<span class="hljs-string">'Q-MAR'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">234</span>]: </span><br><span class="line">        Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span>Q4  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q1  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q2  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q3  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q4  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2002</span>Q1  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2002</span>Q2  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2002</span>Q3  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br></pre></td></tr></table></figure>

<h1 id="11-7-移动窗口函数"><a href="#11-7-移动窗口函数" class="headerlink" title="11.7 移动窗口函数"></a>11.7 移动窗口函数</h1><p>在移动窗口（可以带有指数衰减权数）上计算的各种统计函数也是一类常见于时间序列的数组变换。这样可以圆滑噪音数据或断裂数据。我将它们称为移动窗口函数（moving window function），其中还包括那些窗口不定长的函数（如指数加权移动平均）。跟其他统计函数一样，移动窗口函数也会自动排除缺失值。</p>
<p>开始之前，我们加载一些时间序列数据，将其重采样为工作日频率：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">235</span>]: close_px_all = pd.read_csv(<span class="hljs-string">'examples/stock_px_2.csv'</span>,</span><br><span class="line">   .....:                            parse_dates=<span class="hljs-literal">True</span>, index_col=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">236</span>]: close_px = close_px_all[[<span class="hljs-string">'AAPL'</span>, <span class="hljs-string">'MSFT'</span>, <span class="hljs-string">'XOM'</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">237</span>]: close_px = close_px.resample(<span class="hljs-string">'B'</span>).ffill()</span><br></pre></td></tr></table></figure>

<p>现在引入rolling运算符，它与resample和groupby很像。可以在TimeSeries或DataFrame以及一个window（表示期数，见图11-4）上调用它：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">238</span>]: close_px.AAPL.plot()</span><br><span class="line">Out[<span class="hljs-number">238</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7f2f2570cf98</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">239</span>]: close_px.AAPL.rolling(<span class="hljs-number">250</span>).mean().plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-3327483eab730b09.webp" alt="img"></p>
<p>图11-4 苹果公司股价的250日均线</p>
<p>表达式rolling(250)与groupby很像，但不是对其进行分组，而是创建一个按照250天分组的滑动窗口对象。然后，我们就得到了苹果公司股价的250天的移动窗口。</p>
<p>默认情况下，rolling函数需要窗口中所有的值为非NA值。可以修改该行为以解决缺失数据的问题。其实，在时间序列开始处尚不足窗口期的那些数据就是个特例（见图11-5）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">241</span>]: appl_std250 = close_px.AAPL.rolling(<span class="hljs-number">250</span>, min_periods=<span class="hljs-number">10</span>).std()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">242</span>]: appl_std250[<span class="hljs-number">5</span>:<span class="hljs-number">12</span>]</span><br><span class="line">Out[<span class="hljs-number">242</span>]: </span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>         NaN</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>         NaN</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-13</span>         NaN</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>         NaN</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>    <span class="hljs-number">0.077496</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-16</span>    <span class="hljs-number">0.074760</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-17</span>    <span class="hljs-number">0.112368</span></span><br><span class="line">Freq: B, Name: AAPL, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">243</span>]: appl_std250.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-15f565bed1ccad09.webp" alt="img"></p>
<p>图11-5 苹果公司250日每日回报标准差</p>
<p>要计算扩展窗口平均（expanding window mean），可以使用expanding而不是rolling。“扩展”意味着，从时间序列的起始处开始窗口，增加窗口直到它超过所有的序列。apple_std250时间序列的扩展窗口平均如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">244</span>]: expanding_mean = appl_std250.expanding().mean()</span><br></pre></td></tr></table></figure>

<p>对DataFrame调用rolling_mean（以及与之类似的函数）会将转换应用到所有的列上（见图11-6）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">246</span>]: close_px.rolling(<span class="hljs-number">60</span>).mean().plot(logy=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-979f748052b2279f.webp" alt="img"></p>
<p>图11-6 各股价60日均线（对数Y轴）</p>
<p>rolling函数也可以接受一个指定固定大小时间补偿字符串，而不是一组时期。这样可以方便处理不规律的时间序列。这些字符串也可以传递给resample。例如，我们可以计算20天的滚动均值，如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">247</span>]: close_px.rolling(<span class="hljs-string">'20D'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">247</span>]:</span><br><span class="line">                  AAPL       MSFT        XOM</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">7.400000</span>  <span class="hljs-number">21.110000</span>  <span class="hljs-number">29.220000</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">7.425000</span>  <span class="hljs-number">21.125000</span>  <span class="hljs-number">29.230000</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>    <span class="hljs-number">7.433333</span>  <span class="hljs-number">21.256667</span>  <span class="hljs-number">29.473333</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>    <span class="hljs-number">7.432500</span>  <span class="hljs-number">21.425000</span>  <span class="hljs-number">29.342500</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>    <span class="hljs-number">7.402000</span>  <span class="hljs-number">21.402000</span>  <span class="hljs-number">29.240000</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>    <span class="hljs-number">7.391667</span>  <span class="hljs-number">21.490000</span>  <span class="hljs-number">29.273333</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">7.387143</span>  <span class="hljs-number">21.558571</span>  <span class="hljs-number">29.238571</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-13</span>    <span class="hljs-number">7.378750</span>  <span class="hljs-number">21.633750</span>  <span class="hljs-number">29.197500</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>    <span class="hljs-number">7.370000</span>  <span class="hljs-number">21.717778</span>  <span class="hljs-number">29.194444</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>    <span class="hljs-number">7.355000</span>  <span class="hljs-number">21.757000</span>  <span class="hljs-number">29.152000</span></span><br><span class="line"><span class="hljs-meta">... </span>               ...        ...        ...</span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-03</span>  <span class="hljs-number">398.002143</span>  <span class="hljs-number">25.890714</span>  <span class="hljs-number">72.413571</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-04</span>  <span class="hljs-number">396.802143</span>  <span class="hljs-number">25.807857</span>  <span class="hljs-number">72.427143</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-05</span>  <span class="hljs-number">395.751429</span>  <span class="hljs-number">25.729286</span>  <span class="hljs-number">72.422857</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-06</span>  <span class="hljs-number">394.099286</span>  <span class="hljs-number">25.673571</span>  <span class="hljs-number">72.375714</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-07</span>  <span class="hljs-number">392.479333</span>  <span class="hljs-number">25.712000</span>  <span class="hljs-number">72.454667</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-10</span>  <span class="hljs-number">389.351429</span>  <span class="hljs-number">25.602143</span>  <span class="hljs-number">72.527857</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-11</span>  <span class="hljs-number">388.505000</span>  <span class="hljs-number">25.674286</span>  <span class="hljs-number">72.835000</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-12</span>  <span class="hljs-number">388.531429</span>  <span class="hljs-number">25.810000</span>  <span class="hljs-number">73.400714</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-13</span>  <span class="hljs-number">388.826429</span>  <span class="hljs-number">25.961429</span>  <span class="hljs-number">73.905000</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-14</span>  <span class="hljs-number">391.038000</span>  <span class="hljs-number">26.048667</span>  <span class="hljs-number">74.185333</span></span><br><span class="line">[<span class="hljs-number">2292</span> rows x <span class="hljs-number">3</span> columns]</span><br></pre></td></tr></table></figure>

<h2 id="指数加权函数"><a href="#指数加权函数" class="headerlink" title="指数加权函数"></a>指数加权函数</h2><p>另一种使用固定大小窗口及相等权数观测值的办法是，定义一个衰减因子（decay factor）常量，以便使近期的观测值拥有更大的权数。衰减因子的定义方式有很多，比较流行的是使用时间间隔（span），它可以使结果兼容于窗口大小等于时间间隔的简单移动窗口（simple moving window）函数。</p>
<p>由于指数加权统计会赋予近期的观测值更大的权数，因此相对于等权统计，它能“适应”更快的变化。</p>
<p>除了rolling和expanding，pandas还有ewm运算符。下面这个例子对比了苹果公司股价的30日移动平均和span=30的指数加权移动平均（如图11-7所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">249</span>]: aapl_px = close_px.AAPL[<span class="hljs-string">'2006'</span>:<span class="hljs-string">'2007'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">250</span>]: ma60 = aapl_px.rolling(<span class="hljs-number">30</span>, min_periods=<span class="hljs-number">20</span>).mean()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">251</span>]: ewma60 = aapl_px.ewm(span=<span class="hljs-number">30</span>).mean()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">252</span>]: ma60.plot(style=<span class="hljs-string">'k--'</span>, label=<span class="hljs-string">'Simple MA'</span>)</span><br><span class="line">Out[<span class="hljs-number">252</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7f2f252161d0</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">253</span>]: ewma60.plot(style=<span class="hljs-string">'k-'</span>, label=<span class="hljs-string">'EW MA'</span>)</span><br><span class="line">Out[<span class="hljs-number">253</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7f2f252161d0</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">254</span>]: plt.legend()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-dae48defe3749fad.webp" alt="img"></p>
<p>图11-7 简单移动平均与指数加权移动平均</p>
<h2 id="二元移动窗口函数"><a href="#二元移动窗口函数" class="headerlink" title="二元移动窗口函数"></a>二元移动窗口函数</h2><p>有些统计运算（如相关系数和协方差）需要在两个时间序列上执行。例如，金融分析师常常对某只股票对某个参考指数（如标准普尔500指数）的相关系数感兴趣。要进行说明，我们先计算我们感兴趣的时间序列的百分数变化：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">256</span>]: spx_px = close_px_all[<span class="hljs-string">'SPX'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">257</span>]: spx_rets = spx_px.pct_change()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">258</span>]: returns = close_px.pct_change()</span><br></pre></td></tr></table></figure>

<p>调用rolling之后，corr聚合函数开始计算与spx_rets滚动相关系数（结果见图11-8）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">259</span>]: corr = returns.AAPL.rolling(<span class="hljs-number">125</span>, min_periods=<span class="hljs-number">100</span>).corr(spx_rets)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">260</span>]: corr.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-e81e0f602b4db0ed.webp" alt="img"></p>
<p>图11-8 AAPL 6个月的回报与标准普尔500指数的相关系数</p>
<p>假设你想要一次性计算多只股票与标准普尔500指数的相关系数。虽然编写一个循环并新建一个DataFrame不是什么难事，但比较啰嗦。其实，只需传入一个TimeSeries和一个DataFrame，rolling_corr就会自动计算TimeSeries（本例中就是spx_rets）与DataFrame各列的相关系数。结果如图11-9所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">262</span>]: corr = returns.rolling(<span class="hljs-number">125</span>, min_periods=<span class="hljs-number">100</span>).corr(spx_rets)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">263</span>]: corr.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-0a54a028a62b9b50.webp" alt="img"></p>
<p>图11-9 3只股票6个月的回报与标准普尔500指数的相关系数</p>
<h2 id="用户定义的移动窗口函数"><a href="#用户定义的移动窗口函数" class="headerlink" title="用户定义的移动窗口函数"></a>用户定义的移动窗口函数</h2><p>rolling_apply函数使你能够在移动窗口上应用自己设计的数组函数。唯一要求的就是：该函数要能从数组的各个片段中产生单个值（即约简）。比如说，当我们用rolling(…).quantile(q)计算样本分位数时，可能对样本中特定值的百分等级感兴趣。scipy.stats.percentileofscore函数就能达到这个目的（结果见图11-10）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">265</span>]: <span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> percentileofscore</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">266</span>]: score_at_2percent = <span class="hljs-keyword">lambda</span> x: percentileofscore(x, <span class="hljs-number">0.02</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">267</span>]: result = returns.AAPL.rolling(<span class="hljs-number">250</span>).apply(score_at_2percent)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">268</span>]: result.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-af49e84a90c23c1e.webp" alt="img"></p>
<p>图11-10 AAPL 2%回报率的百分等级（一年窗口期）</p>
<p>如果你没安装SciPy，可以使用conda或pip安装。</p>
<h1 id="11-8-总结"><a href="#11-8-总结" class="headerlink" title="11.8 总结"></a>11.8 总结</h1><p>与前面章节接触的数据相比，时间序列数据要求不同类型的分析和数据转换工具。</p>
<p>在接下来的章节中，我们将学习一些高级的pandas方法和如何开始使用建模库statsmodels和scikit-learn。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-09-28T13:06:53.000Z">2019-09-28</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    18 分钟 读完 (大约 2706 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/28/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-9/">mysql与pandas对照学习(9)</a>
            
        </h1>
        <div class="content">
            <h2 id="Self-join"><a href="#Self-join" class="headerlink" title="Self join"></a>Self join</h2><p><a href="https://sqlzoo.net/wiki/Self_join" target="_blank" rel="noopener">Self join</a></p>
<h3 id="Edinburgh-Buses"><a href="#Edinburgh-Buses" class="headerlink" title="Edinburgh Buses"></a>Edinburgh Buses</h3><p><a href="https://sqlzoo.net/wiki/Edinburgh_Buses." target="_blank" rel="noopener" title="Edinburgh Buses.">Details of the database</a> Looking at the data</p>
<p>stops(<strong>id</strong>, name)
route(<strong>num</strong>, <strong>company</strong>, <strong>pos</strong>, <em>stop</em>)</p>
<table>
<thead>
<tr>
<th><strong>stops</strong></th>
</tr>
</thead>
<tbody><tr>
<td><em>id</em></td>
</tr>
<tr>
<td>name</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>route</strong></th>
</tr>
</thead>
<tbody><tr>
<td><em>num</em></td>
</tr>
<tr>
<td><em>company</em></td>
</tr>
<tr>
<td><em>pos</em></td>
</tr>
<tr>
<td>stop</td>
</tr>
</tbody></table>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/09/28/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-9/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/09/28/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-9/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-09-27T11:32:09.000Z">2019-09-27</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    9 分钟 读完 (大约 1390 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/27/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-8/">mysql与pandas对照学习(8)</a>
            
        </h1>
        <div class="content">
            <h2 id="Using-Null"><a href="#Using-Null" class="headerlink" title="Using Null"></a>Using Null</h2><p><a href="https://sqlzoo.net/wiki/Using_Null" target="_blank" rel="noopener">Using Null</a></p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">dept</th>
<th align="left">name</th>
<th align="left">phone</th>
<th align="left">mobile</th>
</tr>
</thead>
<tbody><tr>
<td align="left">101</td>
<td align="left">1</td>
<td align="left">Shrivell</td>
<td align="left">2753</td>
<td align="left">07986 555 1234</td>
</tr>
<tr>
<td align="left">102</td>
<td align="left">1</td>
<td align="left">Throd</td>
<td align="left">2754</td>
<td align="left">07122 555 1920</td>
</tr>
<tr>
<td align="left">103</td>
<td align="left">1</td>
<td align="left">Splint</td>
<td align="left">2293</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">104</td>
<td align="left"></td>
<td align="left">Spiregrain</td>
<td align="left">3287</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">105</td>
<td align="left">2</td>
<td align="left">Cutflower</td>
<td align="left">3212</td>
<td align="left">07996 555 6574</td>
</tr>
<tr>
<td align="left">106</td>
<td align="left"></td>
<td align="left">Deadyawn</td>
<td align="left">3345</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">…</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Computing</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Design</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Engineering</td>
</tr>
<tr>
<td align="left">…</td>
<td align="left"></td>
</tr>
</tbody></table>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/09/27/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-8/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/09/27/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-8/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous">
            <a class="is-flex-grow has-text-black-ter" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">上一页</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/page/3/">下一页</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link has-text-black-ter" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">1</a></li>
            
            <li><a class="pagination-link is-current" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/page/2/">2</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/page/3/">3</a></li>
            
        </ul>
    </nav>
</div>
</div>
                        <!-- 修改 -->
    
    
    
    
    <div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
        
            
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar_tiger.jpg" alt="Lanhoo">
                    
                    
                    <p class="is-size-4 is-block">
                        Lanhoo
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Just do it!
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Shenzhen, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        38
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        2
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        17
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/gladall" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/gladall">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Weibo" href="https://weibo.com/gladall">
                
                <i class="fab fa-weibo"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
        
            

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://godweiyang.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">韦阳的博客</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">godweiyang.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://easyhexo.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Easy Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">easyhexo.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


        
            
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">
            <span class="level-start">
                <span class="level-item">数据分析</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">28</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">
            <span class="level-start">
                <span class="level-item">系统配置</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/SQL/" style="font-size: 15.71px;">SQL</a> <a href="/tags/arch/" style="font-size: 11.43px;">arch</a> <a href="/tags/excel/" style="font-size: 11.43px;">excel</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/icarus/" style="font-size: 10px;">icarus</a> <a href="/tags/jupyter/" style="font-size: 10px;">jupyter</a> <a href="/tags/linux/" style="font-size: 12.86px;">linux</a> <a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a> <a href="/tags/matplotlib/" style="font-size: 10px;">matplotlib</a> <a href="/tags/mysql/" style="font-size: 14.29px;">mysql</a> <a href="/tags/pandas/" style="font-size: 18.57px;">pandas</a> <a href="/tags/python/" style="font-size: 17.14px;">python</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/%E5%8D%8E%E5%AE%B9%E9%81%93/" style="font-size: 10px;">华容道</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" style="font-size: 20px;">数据分析</a> <a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 10px;">软件</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 12.86px;">配置</a>
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">18</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
        
            <div class="column-right-shadow is-hidden-widescreen is-sticky">
            
                
            
                
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-10T11:48:06.000Z">2019-11-10</time></div>
                    <a href="/2019/11/10/%E7%94%A8python%E5%86%99%E4%BA%86%E4%B8%80%E4%B8%AA%E8%A7%A3%E6%95%B0%E5%AD%97%E5%8D%8E%E5%AE%B9%E9%81%93%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A8%8B%E5%BA%8F/" class="has-link-black-ter is-size-6">用python写了一个解数字华容道游戏的程序</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-08T01:12:36.000Z">2019-11-08</time></div>
                    <a href="/2019/11/08/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%8C%89%E7%85%A7%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%87%AA%E5%8A%A8%E6%B1%87%E6%80%BB%E7%BB%9F%E8%AE%A1%E7%9A%84%E8%84%9A%E6%9C%AC/" class="has-link-black-ter is-size-6">分享一个按照模板文件格式自动汇总统计的脚本</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:53:33.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC4%E7%AB%A0%20NumPy%E5%9F%BA%E7%A1%80%EF%BC%9A%E6%95%B0%E7%BB%84%E5%92%8C%E7%9F%A2%E9%87%8F%E8%AE%A1%E7%AE%97/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第4章 NumPy基础：数组和矢量计算</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:52:29.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC3%E7%AB%A0%20Python%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%81%E5%87%BD%E6%95%B0%E5%92%8C%E6%96%87%E4%BB%B6/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第3章 Python的数据结构、函数和文件</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:51:17.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC2%E7%AB%A0%20Python%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80%EF%BC%8CIPython%E5%92%8CJupyter%20Notebooks/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第2章 Python语法基础，IPython和Jupyter Notebooks</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

            
            </div>
        
    </div>
    
    
    <!-- 粘贴的部分 -->
    
                        <!-- 修改 -->
    
    
    
    
    <div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right is-sticky">
        
            
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-10T11:48:06.000Z">2019-11-10</time></div>
                    <a href="/2019/11/10/%E7%94%A8python%E5%86%99%E4%BA%86%E4%B8%80%E4%B8%AA%E8%A7%A3%E6%95%B0%E5%AD%97%E5%8D%8E%E5%AE%B9%E9%81%93%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A8%8B%E5%BA%8F/" class="has-link-black-ter is-size-6">用python写了一个解数字华容道游戏的程序</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-08T01:12:36.000Z">2019-11-08</time></div>
                    <a href="/2019/11/08/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%8C%89%E7%85%A7%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%87%AA%E5%8A%A8%E6%B1%87%E6%80%BB%E7%BB%9F%E8%AE%A1%E7%9A%84%E8%84%9A%E6%9C%AC/" class="has-link-black-ter is-size-6">分享一个按照模板文件格式自动汇总统计的脚本</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:53:33.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC4%E7%AB%A0%20NumPy%E5%9F%BA%E7%A1%80%EF%BC%9A%E6%95%B0%E7%BB%84%E5%92%8C%E7%9F%A2%E9%87%8F%E8%AE%A1%E7%AE%97/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第4章 NumPy基础：数组和矢量计算</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:52:29.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC3%E7%AB%A0%20Python%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%81%E5%87%BD%E6%95%B0%E5%92%8C%E6%96%87%E4%BB%B6/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第3章 Python的数据结构、函数和文件</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:51:17.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC2%E7%AB%A0%20Python%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80%EF%BC%8CIPython%E5%92%8CJupyter%20Notebooks/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第2章 Python语法基础，IPython和Jupyter Notebooks</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
        
    </div>
    
    
    <!-- 粘贴的部分 -->
    
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/grid.svg" alt="Lanhoo&#39;s blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Lanhoo&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;" target="_blank" rel="noopener">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

<script>
// [].slice.call(document.querySelectorAll('table')).forEach(function(el){
//     var wrapper = document.createElement('div');
//     wrapper.className = 'table-area';
//     el.parentNode.insertBefore(wrapper, el);
//     el.parentNode.removeChild(el);
//     wrapper.appendChild(el);
// })
// 这是给真正的表格添加样式
$(".content > table").wrap("<div class='table-area'></div>");
$("table.dataframe").wrap("<div class='table-area'></div>");
</script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>