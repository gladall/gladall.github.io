<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>Lanhoo&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="description9">
<meta property="og:type" content="website">
<meta property="og:title" content="Lanhoo&#39;s blog">
<meta property="og:url" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;page&#x2F;2&#x2F;index.html">
<meta property="og:site_name" content="Lanhoo&#39;s blog">
<meta property="og:description" content="description9">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;images&#x2F;og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;images&#x2F;og_image.png">







<link rel="icon" href="/images/grid32.ico">


<!-- 添加用户的样式，用来修改表格样式 -->
<!-- 效果不好，代码块也是表格，把代码块也变了 -->
<link rel="stylesheet" href="/css/user2.css" media="screen" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146455672-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146455672-1');
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="Lanhoo's blog" type="application/atom+xml">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/grid.svg" alt="Lanhoo&#39;s blog" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;" target="_blank" rel="noopener">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <!-- 将main_column_class() 改为 col() -->
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main">
    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    25 分钟 读完 (大约 3764 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E6%91%98%E5%BD%95%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8Ejupyter-notebook%E6%8A%80%E5%B7%A7%E7%9A%84%E7%BD%91%E9%A1%B5/">摘录一个关于jupyter-notebook技巧的网页</a>
            
        </h1>
        <div class="content">
            <blockquote>
<p>原文在：<a href="https://www.dataquest.io/blog/jupyter-notebook-tips-tricks-shortcuts/" target="_blank" rel="noopener">https://www.dataquest.io/blog/jupyter-notebook-tips-tricks-shortcuts/</a></p>
<p>若看不到，得翻墙</p>
</blockquote>
<h1 id="28-Jupyter-Notebook-Tips-Tricks-and-Shortcuts"><a href="#28-Jupyter-Notebook-Tips-Tricks-and-Shortcuts" class="headerlink" title="28 Jupyter Notebook Tips, Tricks, and Shortcuts"></a>28 Jupyter Notebook Tips, Tricks, and Shortcuts</h1>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/10/05/%E6%91%98%E5%BD%95%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8Ejupyter-notebook%E6%8A%80%E5%B7%A7%E7%9A%84%E7%BD%91%E9%A1%B5/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/10/05/%E6%91%98%E5%BD%95%E4%B8%80%E4%B8%AA%E5%85%B3%E4%BA%8Ejupyter-notebook%E6%8A%80%E5%B7%A7%E7%9A%84%E7%BD%91%E9%A1%B5/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 8495 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%20%E9%99%84%E5%BD%95A%20NumPy%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">《利用Python进行数据分析·第2版》 附录A NumPy高级应用</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
附录A NumPy高级应用
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>在这篇附录中，我会深入NumPy库的数组计算。这会包括ndarray更内部的细节，和更高级的数组操作和算法。</p>
<p>本章包括了一些杂乱的章节，不需要仔细研究。</p>
<h1 id="A-1-ndarray对象的内部机理"><a href="#A-1-ndarray对象的内部机理" class="headerlink" title="A.1 ndarray对象的内部机理"></a>A.1 ndarray对象的内部机理</h1><p>NumPy的ndarray提供了一种将同质数据块（可以是连续或跨越）解释为多维数组对象的方式。正如你之前所看到的那样，数据类型（dtype）决定了数据的解释方式，比如浮点数、整数、布尔值等。</p>
<p>ndarray如此强大的部分原因是所有数组对象都是数据块的一个跨度视图（strided view）。你可能想知道数组视图arr[::2,::-1]不复制任何数据的原因是什么。简单地说，ndarray不只是一块内存和一个dtype，它还有跨度信息，这使得数组能以各种步幅（step size）在内存中移动。更准确地讲，ndarray内部由以下内容组成：</p>
<ul>
<li>一个指向数据（内存或内存映射文件中的一块数据）的指针。</li>
<li>数据类型或dtype，描述在数组中的固定大小值的格子。</li>
<li>一个表示数组形状（shape）的元组。</li>
<li>一个跨度元组（stride），其中的整数指的是为了前进到当前维度下一个元素需要“跨过”的字节数。</li>
</ul>
<p>图A-1简单地说明了ndarray的内部结构。</p>
<p><img src="/images/blog/7178691-43452f2f413e5094.webp" alt="img"></p>
<p>图A-1 Numpy的ndarray对象</p>
<p>例如，一个10×5的数组，其形状为(10,5)：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: np.ones((<span class="hljs-number">10</span>, <span class="hljs-number">5</span>)).shape</span><br><span class="line">Out[<span class="hljs-number">10</span>]: (<span class="hljs-number">10</span>, <span class="hljs-number">5</span>)</span><br></pre></td></tr></table></figure>

<p>一个典型的（C顺序，稍后将详细讲解）3×4×5的float64（8个字节）数组，其跨度为(160,40,8) —— 知道跨度是非常有用的，通常，跨度在一个轴上越大，沿这个轴进行计算的开销就越大：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">11</span>]: np.ones((<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>), dtype=np.float64).strides</span><br><span class="line">Out[<span class="hljs-number">11</span>]: (<span class="hljs-number">160</span>, <span class="hljs-number">40</span>, <span class="hljs-number">8</span>)</span><br></pre></td></tr></table></figure>

<p>虽然NumPy用户很少会对数组的跨度信息感兴趣，但它们却是构建非复制式数组视图的重要因素。跨度甚至可以是负数，这样会使数组在内存中后向移动，比如在切片obj[::-1]或obj[:,::-1]中就是这样的。</p>
<h2 id="NumPy数据类型体系"><a href="#NumPy数据类型体系" class="headerlink" title="NumPy数据类型体系"></a>NumPy数据类型体系</h2><p>你可能偶尔需要检查数组中所包含的是否是整数、浮点数、字符串或Python对象。因为浮点数的种类很多（从float16到float128），判断dtype是否属于某个大类的工作非常繁琐。幸运的是，dtype都有一个超类（比如np.integer和np.floating），它们可以跟np.issubdtype函数结合使用：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: ints = np.ones(<span class="hljs-number">10</span>, dtype=np.uint16)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: floats = np.ones(<span class="hljs-number">10</span>, dtype=np.float32)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: np.issubdtype(ints.dtype, np.integer)</span><br><span class="line">Out[<span class="hljs-number">14</span>]: <span class="hljs-literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: np.issubdtype(floats.dtype, np.floating)</span><br><span class="line">Out[<span class="hljs-number">15</span>]: <span class="hljs-literal">True</span></span><br></pre></td></tr></table></figure>

<p>调用dtype的mro方法即可查看其所有的父类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">16</span>]: np.float64.mro()</span><br><span class="line">Out[<span class="hljs-number">16</span>]:</span><br><span class="line">[numpy.float64,</span><br><span class="line"> numpy.floating,</span><br><span class="line"> numpy.inexact,</span><br><span class="line"> numpy.number,</span><br><span class="line"> numpy.generic,</span><br><span class="line"> float,</span><br><span class="line"> object]</span><br></pre></td></tr></table></figure>

<p>然后得到：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: np.issubdtype(ints.dtype, np.number)</span><br><span class="line">Out[<span class="hljs-number">17</span>]: <span class="hljs-literal">True</span></span><br></pre></td></tr></table></figure>

<p>大部分NumPy用户完全不需要了解这些知识，但是这些知识偶尔还是能派上用场的。图A-2说明了dtype体系以及父子类关系。</p>
<p><img src="/images/blog/7178691-b8996bf943a06ab9.webp" alt="img"></p>
<p>图A-2 NumPy的dtype体系</p>
<h1 id="A-2-高级数组操作"><a href="#A-2-高级数组操作" class="headerlink" title="A.2 高级数组操作"></a>A.2 高级数组操作</h1><p>除花式索引、切片、布尔条件取子集等操作之外，数组的操作方式还有很多。虽然pandas中的高级函数可以处理数据分析工作中的许多重型任务，但有时你还是需要编写一些在现有库中找不到的数据算法。</p>
<h2 id="数组重塑"><a href="#数组重塑" class="headerlink" title="数组重塑"></a>数组重塑</h2><p>多数情况下，你可以无需复制任何数据，就将数组从一个形状转换为另一个形状。只需向数组的实例方法reshape传入一个表示新形状的元组即可实现该目的。例如，假设有一个一维数组，我们希望将其重新排列为一个矩阵（结果见图A-3）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: arr = np.arange(<span class="hljs-number">8</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">19</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: arr.reshape((<span class="hljs-number">4</span>, <span class="hljs-number">2</span>))</span><br><span class="line">Out[<span class="hljs-number">20</span>]: </span><br><span class="line">array([[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>],</span><br><span class="line">       [<span class="hljs-number">2</span>, <span class="hljs-number">3</span>],</span><br><span class="line">       [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>],</span><br><span class="line">       [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>]])</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-95bbca6d8d04e4c7.webp" alt="img"></p>
<p>图A-3 按C顺序（按行）和按Fortran顺序（按列）进行重塑</p>
<p>多维数组也能被重塑：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">21</span>]: arr.reshape((<span class="hljs-number">4</span>, <span class="hljs-number">2</span>)).reshape((<span class="hljs-number">2</span>, <span class="hljs-number">4</span>))</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">array([[<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],</span><br><span class="line">       [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>]])</span><br></pre></td></tr></table></figure>

<p>作为参数的形状的其中一维可以是－1，它表示该维度的大小由数据本身推断而来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">22</span>]: arr = np.arange(<span class="hljs-number">15</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: arr.reshape((<span class="hljs-number">5</span>, <span class="hljs-number">-1</span>))</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>],</span><br><span class="line">       [ <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>],</span><br><span class="line">       [ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>],</span><br><span class="line">       [ <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>],</span><br><span class="line">       [<span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>]])</span><br></pre></td></tr></table></figure>

<p>与reshape将一维数组转换为多维数组的运算过程相反的运算通常称为扁平化（flattening）或散开（raveling）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">27</span>]: arr = np.arange(<span class="hljs-number">15</span>).reshape((<span class="hljs-number">5</span>, <span class="hljs-number">3</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>],</span><br><span class="line">       [ <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>],</span><br><span class="line">       [ <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>],</span><br><span class="line">       [ <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>],</span><br><span class="line">       [<span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">29</span>]: arr.ravel()</span><br><span class="line">Out[<span class="hljs-number">29</span>]: array([ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>])</span><br></pre></td></tr></table></figure>

<p>如果结果中的值与原始数组相同，ravel不会产生源数据的副本。flatten方法的行为类似于ravel，只不过它总是返回数据的副本：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">30</span>]: arr.flatten()</span><br><span class="line">Out[<span class="hljs-number">30</span>]: array([ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>])</span><br></pre></td></tr></table></figure>

<p>数组可以被重塑或散开为别的顺序。这对NumPy新手来说是一个比较微妙的问题，所以在下一小节中我们将专门讲解这个问题。</p>
<h2 id="C和Fortran顺序"><a href="#C和Fortran顺序" class="headerlink" title="C和Fortran顺序"></a>C和Fortran顺序</h2><p>NumPy允许你更为灵活地控制数据在内存中的布局。默认情况下，NumPy数组是按行优先顺序创建的。在空间方面，这就意味着，对于一个二维数组，每行中的数据项是被存放在相邻内存位置上的。另一种顺序是列优先顺序，它意味着每列中的数据项是被存放在相邻内存位置上的。</p>
<p>由于一些历史原因，行和列优先顺序又分别称为C和Fortran顺序。在FORTRAN 77中，矩阵全都是列优先的。</p>
<p>像reshape和reval这样的函数，都可以接受一个表示数组数据存放顺序的order参数。一般可以是’C’或’F’（还有’A’和’K’等不常用的选项，具体请参考NumPy的文档）。图A-3对此进行了说明：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: arr = np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">3</span>, <span class="hljs-number">4</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">32</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],</span><br><span class="line">       [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],</span><br><span class="line">       [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">33</span>]: arr.ravel()</span><br><span class="line">Out[<span class="hljs-number">33</span>]: array([ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: arr.ravel(<span class="hljs-string">'F'</span>)</span><br><span class="line">Out[<span class="hljs-number">34</span>]: array([ <span class="hljs-number">0</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">9</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">7</span>, <span class="hljs-number">11</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-f486e7c41d7e0eec.webp" alt="img"></p>
<p>图A-3 按C（行优先）或Fortran（列优先）顺序进行重塑</p>
<p>二维或更高维数组的重塑过程比较令人费解（见图A-3）。C和Fortran顺序的关键区别就是维度的行进顺序：</p>
<ul>
<li>C/行优先顺序：先经过更高的维度（例如，轴1会先于轴0被处理）。</li>
<li>Fortran/列优先顺序：后经过更高的维度（例如，轴0会先于轴1被处理）。</li>
</ul>
<h2 id="数组的合并和拆分"><a href="#数组的合并和拆分" class="headerlink" title="数组的合并和拆分"></a>数组的合并和拆分</h2><p>numpy.concatenate可以按指定轴将一个由数组组成的序列（如元组、列表等）连接到一起：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: arr1 = np.array([[<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: arr2 = np.array([[<span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>], [<span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: np.concatenate([arr1, arr2], axis=<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],</span><br><span class="line">       [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>],</span><br><span class="line">       [ <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>],</span><br><span class="line">       [<span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: np.concatenate([arr1, arr2], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">38</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>],</span><br><span class="line">       [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>]])</span><br></pre></td></tr></table></figure>

<p>对于常见的连接操作，NumPy提供了一些比较方便的方法（如vstack和hstack）。因此，上面的运算还可以表达为：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: np.vstack((arr1, arr2))</span><br><span class="line">Out[<span class="hljs-number">39</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],</span><br><span class="line">       [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>],</span><br><span class="line">       [ <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>],</span><br><span class="line">       [<span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: np.hstack((arr1, arr2))</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>],</span><br><span class="line">[ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>, <span class="hljs-number">12</span>]])</span><br></pre></td></tr></table></figure>

<p>与此相反，split用于将一个数组沿指定轴拆分为多个数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">41</span>]: arr = np.random.randn(<span class="hljs-number">5</span>, <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">42</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.2047</span>,  <span class="hljs-number">0.4789</span>],</span><br><span class="line">       [<span class="hljs-number">-0.5194</span>, <span class="hljs-number">-0.5557</span>],</span><br><span class="line">       [ <span class="hljs-number">1.9658</span>,  <span class="hljs-number">1.3934</span>],</span><br><span class="line">       [ <span class="hljs-number">0.0929</span>,  <span class="hljs-number">0.2817</span>],</span><br><span class="line">       [ <span class="hljs-number">0.769</span> ,  <span class="hljs-number">1.2464</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: first, second, third = np.split(arr, [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">44</span>]: first</span><br><span class="line">Out[<span class="hljs-number">44</span>]: array([[<span class="hljs-number">-0.2047</span>,  <span class="hljs-number">0.4789</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">45</span>]: second</span><br><span class="line">Out[<span class="hljs-number">45</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.5194</span>, <span class="hljs-number">-0.5557</span>],</span><br><span class="line">       [ <span class="hljs-number">1.9658</span>,  <span class="hljs-number">1.3934</span>]])</span><br><span class="line">In [<span class="hljs-number">46</span>]: third</span><br><span class="line">Out[<span class="hljs-number">46</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.0929</span>,  <span class="hljs-number">0.2817</span>],</span><br><span class="line">       [ <span class="hljs-number">0.769</span> ,  <span class="hljs-number">1.2464</span>]])</span><br></pre></td></tr></table></figure>

<p>传入到np.split的值[1,3]指示在哪个索引处分割数组。</p>
<p>表A-1中列出了所有关于数组连接和拆分的函数，其中有些是专门为了方便常见的连接运算而提供的。</p>
<p><img src="/images/blog/7178691-c597246722a6bb01.webp" alt="img"></p>
<p>表A-1 数组连接函数</p>
<h2 id="堆叠辅助类：r-和c"><a href="#堆叠辅助类：r-和c" class="headerlink" title="堆叠辅助类：r_和c_"></a>堆叠辅助类：r_和c_</h2><p>NumPy命名空间中有两个特殊的对象——r_和c_，它们可以使数组的堆叠操作更为简洁：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">47</span>]: arr = np.arange(<span class="hljs-number">6</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: arr1 = arr.reshape((<span class="hljs-number">3</span>, <span class="hljs-number">2</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">49</span>]: arr2 = np.random.randn(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">50</span>]: np.r_[arr1, arr2]</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">1.</span>    ],</span><br><span class="line">       [ <span class="hljs-number">2.</span>    ,  <span class="hljs-number">3.</span>    ],</span><br><span class="line">       [ <span class="hljs-number">4.</span>    ,  <span class="hljs-number">5.</span>    ],</span><br><span class="line">       [ <span class="hljs-number">1.0072</span>, <span class="hljs-number">-1.2962</span>],</span><br><span class="line">       [ <span class="hljs-number">0.275</span> ,  <span class="hljs-number">0.2289</span>],</span><br><span class="line">       [ <span class="hljs-number">1.3529</span>,  <span class="hljs-number">0.8864</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: np.c_[np.r_[arr1, arr2], arr]</span><br><span class="line">Out[<span class="hljs-number">51</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">1.</span>    ,  <span class="hljs-number">0.</span>    ],</span><br><span class="line">       [ <span class="hljs-number">2.</span>    ,  <span class="hljs-number">3.</span>    ,  <span class="hljs-number">1.</span>    ],</span><br><span class="line">       [ <span class="hljs-number">4.</span>    ,  <span class="hljs-number">5.</span>    ,  <span class="hljs-number">2.</span>    ],</span><br><span class="line">       [ <span class="hljs-number">1.0072</span>, <span class="hljs-number">-1.2962</span>,  <span class="hljs-number">3.</span>    ],</span><br><span class="line">       [ <span class="hljs-number">0.275</span> ,  <span class="hljs-number">0.2289</span>,  <span class="hljs-number">4.</span>    ],</span><br><span class="line">       [ <span class="hljs-number">1.3529</span>,  <span class="hljs-number">0.8864</span>,  <span class="hljs-number">5.</span>    ]])</span><br></pre></td></tr></table></figure>

<p>它还可以将切片转换成数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">52</span>]: np.c_[<span class="hljs-number">1</span>:<span class="hljs-number">6</span>, <span class="hljs-number">-10</span>:<span class="hljs-number">-5</span>]</span><br><span class="line">Out[<span class="hljs-number">52</span>]: </span><br><span class="line">array([[  <span class="hljs-number">1</span>, <span class="hljs-number">-10</span>],</span><br><span class="line">       [  <span class="hljs-number">2</span>,  <span class="hljs-number">-9</span>],</span><br><span class="line">       [  <span class="hljs-number">3</span>,  <span class="hljs-number">-8</span>],</span><br><span class="line">       [  <span class="hljs-number">4</span>,  <span class="hljs-number">-7</span>],</span><br><span class="line">       [  <span class="hljs-number">5</span>,  <span class="hljs-number">-6</span>]])</span><br></pre></td></tr></table></figure>

<p>r_和c_的具体功能请参考其文档。</p>
<h2 id="元素的重复操作：tile和repeat"><a href="#元素的重复操作：tile和repeat" class="headerlink" title="元素的重复操作：tile和repeat"></a>元素的重复操作：tile和repeat</h2><p>对数组进行重复以产生更大数组的工具主要是repeat和tile这两个函数。repeat会将数组中的各个元素重复一定次数，从而产生一个更大的数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">53</span>]: arr = np.arange(<span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">54</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">54</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: arr.repeat(<span class="hljs-number">3</span>)</span><br><span class="line">Out[<span class="hljs-number">55</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>])</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：跟其他流行的数组编程语言（如MATLAB）不同，NumPy中很少需要对数组进行重复（replicate）。这主要是因为广播（broadcasting，我们将在下一节中讲解该技术）能更好地满足该需求。</p>
</blockquote>
<p>默认情况下，如果传入的是一个整数，则各元素就都会重复那么多次。如果传入的是一组整数，则各元素就可以重复不同的次数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: arr.repeat([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>])</span><br><span class="line">Out[<span class="hljs-number">56</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>])</span><br></pre></td></tr></table></figure>

<p>对于多维数组，还可以让它们的元素沿指定轴重复：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">57</span>]: arr = np.random.randn(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">58</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: arr.repeat(<span class="hljs-number">2</span>, axis=<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>]])</span><br></pre></td></tr></table></figure>

<p>注意，如果没有设置轴向，则数组会被扁平化，这可能不会是你想要的结果。同样，在对多维进行重复时，也可以传入一组整数，这样就会使各切片重复不同的次数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: arr.repeat([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>], axis=<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">60</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: arr.repeat([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>, <span class="hljs-number">-0.3718</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> ,  <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>, <span class="hljs-number">-0.4386</span>, <span class="hljs-number">-0.4386</span>]])</span><br></pre></td></tr></table></figure>

<p>tile的功能是沿指定轴向堆叠数组的副本。你可以形象地将其想象成“铺瓷砖”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">62</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: np.tile(arr, <span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>, <span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>,  <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>]])</span><br></pre></td></tr></table></figure>

<p>第二个参数是瓷砖的数量。对于标量，瓷砖是水平铺设的，而不是垂直铺设。它可以是一个表示“铺设”布局的元组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">64</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">64</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">65</span>]: np.tile(arr, (<span class="hljs-number">2</span>, <span class="hljs-number">1</span>))</span><br><span class="line">Out[<span class="hljs-number">65</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>],</span><br><span class="line">       [<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">66</span>]: np.tile(arr, (<span class="hljs-number">3</span>, <span class="hljs-number">2</span>))</span><br><span class="line">Out[<span class="hljs-number">66</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>, <span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>,  <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>],</span><br><span class="line">       [<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>, <span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>,  <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>],</span><br><span class="line">       [<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>, <span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>],</span><br><span class="line">       [ <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>,  <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>]])</span><br></pre></td></tr></table></figure>

<h2 id="花式索引的等价函数：take和put"><a href="#花式索引的等价函数：take和put" class="headerlink" title="花式索引的等价函数：take和put"></a>花式索引的等价函数：take和put</h2><p>在第4章中我们讲过，获取和设置数组子集的一个办法是通过整数数组使用花式索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">67</span>]: arr = np.arange(<span class="hljs-number">10</span>) * <span class="hljs-number">100</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">68</span>]: inds = [<span class="hljs-number">7</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">6</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">69</span>]: arr[inds]</span><br><span class="line">Out[<span class="hljs-number">69</span>]: array([<span class="hljs-number">700</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">600</span>])</span><br></pre></td></tr></table></figure>

<p>ndarray还有其它方法用于获取单个轴向上的选区：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">70</span>]: arr.take(inds)</span><br><span class="line">Out[<span class="hljs-number">70</span>]: array([<span class="hljs-number">700</span>, <span class="hljs-number">100</span>, <span class="hljs-number">200</span>, <span class="hljs-number">600</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: arr.put(inds, <span class="hljs-number">42</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">72</span>]: array([  <span class="hljs-number">0</span>,  <span class="hljs-number">42</span>,  <span class="hljs-number">42</span>, <span class="hljs-number">300</span>, <span class="hljs-number">400</span>, <span class="hljs-number">500</span>,  <span class="hljs-number">42</span>,  <span class="hljs-number">42</span>,<span class="hljs-number">800</span>, <span class="hljs-number">900</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">73</span>]: arr.put(inds, [<span class="hljs-number">40</span>, <span class="hljs-number">41</span>, <span class="hljs-number">42</span>, <span class="hljs-number">43</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">74</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">74</span>]: array([  <span class="hljs-number">0</span>,  <span class="hljs-number">41</span>,  <span class="hljs-number">42</span>, <span class="hljs-number">300</span>, <span class="hljs-number">400</span>, <span class="hljs-number">500</span>,  <span class="hljs-number">43</span>,  <span class="hljs-number">40</span>, <span class="hljs-number">800</span>, <span class="hljs-number">900</span>])</span><br></pre></td></tr></table></figure>

<p>要在其它轴上使用take，只需传入axis关键字即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: inds = [<span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: arr = np.random.randn(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.5397</span>,  <span class="hljs-number">0.477</span> ,  <span class="hljs-number">3.2489</span>, <span class="hljs-number">-1.0212</span>],</span><br><span class="line">       [<span class="hljs-number">-0.5771</span>,  <span class="hljs-number">0.1241</span>,  <span class="hljs-number">0.3026</span>,  <span class="hljs-number">0.5238</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: arr.take(inds, axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">array([[ <span class="hljs-number">3.2489</span>, <span class="hljs-number">-0.5397</span>,  <span class="hljs-number">3.2489</span>,  <span class="hljs-number">0.477</span> ],</span><br><span class="line">       [ <span class="hljs-number">0.3026</span>, <span class="hljs-number">-0.5771</span>,  <span class="hljs-number">0.3026</span>,  <span class="hljs-number">0.1241</span>]])</span><br></pre></td></tr></table></figure>

<p>put不接受axis参数，它只会在数组的扁平化版本（一维，C顺序）上进行索引。因此，在需要用其他轴向的索引设置元素时，最好还是使用花式索引。</p>
<h1 id="A-3-广播"><a href="#A-3-广播" class="headerlink" title="A.3 广播"></a>A.3 广播</h1><p>广播（broadcasting）指的是不同形状的数组之间的算术运算的执行方式。它是一种非常强大的功能，但也容易令人误解，即使是经验丰富的老手也是如此。将标量值跟数组合并时就会发生最简单的广播：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: arr = np.arange(<span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">80</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">80</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">81</span>]: arr * <span class="hljs-number">4</span></span><br><span class="line">Out[<span class="hljs-number">81</span>]: array([ <span class="hljs-number">0</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">8</span>, <span class="hljs-number">12</span>, <span class="hljs-number">16</span>])</span><br></pre></td></tr></table></figure>

<p>这里我们说：在这个乘法运算中，标量值4被广播到了其他所有的元素上。</p>
<p>看一个例子，我们可以通过减去列平均值的方式对数组的每一列进行距平化处理。这个问题解决起来非常简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: arr = np.random.randn(<span class="hljs-number">4</span>, <span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: arr.mean(<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">83</span>]: array([<span class="hljs-number">-0.3928</span>, <span class="hljs-number">-0.3824</span>, <span class="hljs-number">-0.8768</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: demeaned = arr - arr.mean(<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: demeaned</span><br><span class="line">Out[<span class="hljs-number">85</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.3937</span>,  <span class="hljs-number">1.7263</span>,  <span class="hljs-number">0.1633</span>],</span><br><span class="line">       [<span class="hljs-number">-0.4384</span>, <span class="hljs-number">-1.9878</span>, <span class="hljs-number">-0.9839</span>],</span><br><span class="line">       [<span class="hljs-number">-0.468</span> ,  <span class="hljs-number">0.9426</span>, <span class="hljs-number">-0.3891</span>],</span><br><span class="line">       [ <span class="hljs-number">0.5126</span>, <span class="hljs-number">-0.6811</span>,  <span class="hljs-number">1.2097</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: demeaned.mean(<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: array([<span class="hljs-number">-0.</span>,  <span class="hljs-number">0.</span>, <span class="hljs-number">-0.</span>])</span><br></pre></td></tr></table></figure>

<p>图A-4形象地展示了该过程。用广播的方式对行进行距平化处理会稍微麻烦一些。幸运的是，只要遵循一定的规则，低维度的值是可以被广播到数组的任意维度的（比如对二维数组各列减去行平均值）。</p>
<p><img src="/images/blog/7178691-6aaf022ab88452a9.webp" alt="img"></p>
<p>图A-4 一维数组在轴0上的广播</p>
<p>于是就得到了：</p>
<p><img src="/images/blog/7178691-fcaba8455960862a.webp" alt="img"></p>
<p>虽然我是一名经验丰富的NumPy老手，但经常还是得停下来画张图并想想广播的原则。再来看一下最后那个例子，假设你希望对各行减去那个平均值。由于arr.mean(0)的长度为3，所以它可以在0轴向上进行广播：因为arr的后缘维度是3，所以它们是兼容的。根据该原则，要在1轴向上做减法（即各行减去行平均值），较小的那个数组的形状必须是(4,1)：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">87</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.0009</span>,  <span class="hljs-number">1.3438</span>, <span class="hljs-number">-0.7135</span>],</span><br><span class="line">       [<span class="hljs-number">-0.8312</span>, <span class="hljs-number">-2.3702</span>, <span class="hljs-number">-1.8608</span>],</span><br><span class="line">       [<span class="hljs-number">-0.8608</span>,  <span class="hljs-number">0.5601</span>, <span class="hljs-number">-1.2659</span>],</span><br><span class="line">       [ <span class="hljs-number">0.1198</span>, <span class="hljs-number">-1.0635</span>,  <span class="hljs-number">0.3329</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: row_means = arr.mean(<span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: row_means.shape</span><br><span class="line">Out[<span class="hljs-number">89</span>]: (<span class="hljs-number">4</span>,)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: row_means.reshape((<span class="hljs-number">4</span>, <span class="hljs-number">1</span>))</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.2104</span>],</span><br><span class="line">       [<span class="hljs-number">-1.6874</span>],</span><br><span class="line">       [<span class="hljs-number">-0.5222</span>],</span><br><span class="line">       [<span class="hljs-number">-0.2036</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">91</span>]: demeaned = arr - row_means.reshape((<span class="hljs-number">4</span>, <span class="hljs-number">1</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: demeaned.mean(<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">92</span>]: array([ <span class="hljs-number">0.</span>, <span class="hljs-number">-0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>])</span><br></pre></td></tr></table></figure>

<p>图A-5说明了该运算的过程。</p>
<p><img src="/images/blog/7178691-9b0310d6773c3d38.webp" alt="img"></p>
<p>图A-5 二维数组在轴1上的广播</p>
<p>图A-6展示了另外一种情况，这次是在一个三维数组上沿0轴向加上一个二维数组。</p>
<p><img src="/images/blog/7178691-965eb28b60046cd9.webp" alt="img"></p>
<p>图A-6 三维数组在轴0上的广播</p>
<h2 id="沿其它轴向广播"><a href="#沿其它轴向广播" class="headerlink" title="沿其它轴向广播"></a>沿其它轴向广播</h2><p>高维度数组的广播似乎更难以理解，而实际上它也是遵循广播原则的。如果不然，你就会得到下面这样一个错误：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">93</span>]: arr - arr.mean(<span class="hljs-number">1</span>)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input<span class="hljs-number">-93</span><span class="hljs-number">-7</span>b87b85a20b2&gt; <span class="hljs-keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 arr - arr.mean(1)</span><br><span class="line">ValueError: operands could <span class="hljs-keyword">not</span> be broadcast together <span class="hljs-keyword">with</span> shapes (<span class="hljs-number">4</span>,<span class="hljs-number">3</span>) (<span class="hljs-number">4</span>,)</span><br></pre></td></tr></table></figure>

<p>人们经常需要通过算术运算过程将较低维度的数组在除0轴以外的其他轴向上广播。根据广播的原则，较小数组的“广播维”必须为1。在上面那个行距平化的例子中，这就意味着要将行平均值的形状变成(4,1)而不是(4,)：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: arr - arr.mean(<span class="hljs-number">1</span>).reshape((<span class="hljs-number">4</span>, <span class="hljs-number">1</span>))</span><br><span class="line">Out[<span class="hljs-number">94</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.2095</span>,  <span class="hljs-number">1.1334</span>, <span class="hljs-number">-0.9239</span>],</span><br><span class="line">       [ <span class="hljs-number">0.8562</span>, <span class="hljs-number">-0.6828</span>, <span class="hljs-number">-0.1734</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3386</span>,  <span class="hljs-number">1.0823</span>, <span class="hljs-number">-0.7438</span>],</span><br><span class="line">       [ <span class="hljs-number">0.3234</span>, <span class="hljs-number">-0.8599</span>,  <span class="hljs-number">0.5365</span>]])</span><br></pre></td></tr></table></figure>

<p>对于三维的情况，在三维中的任何一维上广播其实也就是将数据重塑为兼容的形状而已。图A-7说明了要在三维数组各维度上广播的形状需求。</p>
<p><img src="/images/blog/7178691-b40936aab8e757d0.webp" alt="img"></p>
<p>图A-7：能在该三维数组上广播的二维数组的形状</p>
<p>于是就有了一个非常普遍的问题（尤其是在通用算法中），即专门为了广播而添加一个长度为1的新轴。虽然reshape是一个办法，但插入轴需要构造一个表示新形状的元组。这是一个很郁闷的过程。因此，NumPy数组提供了一种通过索引机制插入轴的特殊语法。下面这段代码通过特殊的np.newaxis属性以及“全”切片来插入新轴：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">95</span>]: arr = np.zeros((<span class="hljs-number">4</span>, <span class="hljs-number">4</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">96</span>]: arr_3d = arr[:, np.newaxis, :]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: arr_3d.shape</span><br><span class="line">Out[<span class="hljs-number">97</span>]: (<span class="hljs-number">4</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: arr_1d = np.random.normal(size=<span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: arr_1d[:, np.newaxis]</span><br><span class="line">Out[<span class="hljs-number">99</span>]: </span><br><span class="line">array([[<span class="hljs-number">-2.3594</span>],</span><br><span class="line">       [<span class="hljs-number">-0.1995</span>],</span><br><span class="line">       [<span class="hljs-number">-1.542</span> ]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: arr_1d[np.newaxis, :]</span><br><span class="line">Out[<span class="hljs-number">100</span>]: array([[<span class="hljs-number">-2.3594</span>, <span class="hljs-number">-0.1995</span>, <span class="hljs-number">-1.542</span> ]])</span><br></pre></td></tr></table></figure>

<p>因此，如果我们有一个三维数组，并希望对轴2进行距平化，那么只需要编写下面这样的代码就可以了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: arr = np.random.randn(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: depth_means = arr.mean(<span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: depth_means</span><br><span class="line">Out[<span class="hljs-number">103</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.4735</span>,  <span class="hljs-number">0.3971</span>, <span class="hljs-number">-0.0228</span>,  <span class="hljs-number">0.2001</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3521</span>, <span class="hljs-number">-0.281</span> , <span class="hljs-number">-0.071</span> , <span class="hljs-number">-0.1586</span>],</span><br><span class="line">       [ <span class="hljs-number">0.6245</span>,  <span class="hljs-number">0.6047</span>,  <span class="hljs-number">0.4396</span>, <span class="hljs-number">-0.2846</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">104</span>]: depth_means.shape</span><br><span class="line">Out[<span class="hljs-number">104</span>]: (<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">105</span>]: demeaned = arr - depth_means[:, :, np.newaxis]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: demeaned.mean(<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">106</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, <span class="hljs-number">-0.</span>, <span class="hljs-number">-0.</span>],</span><br><span class="line">       [ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, <span class="hljs-number">-0.</span>,  <span class="hljs-number">0.</span>],</span><br><span class="line">       [ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, <span class="hljs-number">-0.</span>, <span class="hljs-number">-0.</span>]])</span><br></pre></td></tr></table></figure>

<p>有些读者可能会想，在对指定轴进行距平化时，有没有一种既通用又不牺牲性能的方法呢？实际上是有的，但需要一些索引方面的技巧：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">demean_axis</span><span class="hljs-params">(arr, axis=<span class="hljs-number">0</span>)</span>:</span></span><br><span class="line">    means = arr.mean(axis)</span><br><span class="line"></span><br><span class="line">    <span class="hljs-comment"># This generalizes things like [:, :, np.newaxis] to N dimensions</span></span><br><span class="line">    indexer = [slice(<span class="hljs-literal">None</span>)] * arr.ndim</span><br><span class="line">    indexer[axis] = np.newaxis</span><br><span class="line">    <span class="hljs-keyword">return</span> arr - means[indexer]</span><br></pre></td></tr></table></figure>

<h2 id="通过广播设置数组的值"><a href="#通过广播设置数组的值" class="headerlink" title="通过广播设置数组的值"></a>通过广播设置数组的值</h2><p>算术运算所遵循的广播原则同样也适用于通过索引机制设置数组值的操作。对于最简单的情况，我们可以这样做：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">107</span>]: arr = np.zeros((<span class="hljs-number">4</span>, <span class="hljs-number">3</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">108</span>]: arr[:] = <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">109</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">109</span>]: </span><br><span class="line">array([[ <span class="hljs-number">5.</span>,  <span class="hljs-number">5.</span>,  <span class="hljs-number">5.</span>],</span><br><span class="line">       [ <span class="hljs-number">5.</span>,  <span class="hljs-number">5.</span>,  <span class="hljs-number">5.</span>],</span><br><span class="line">       [ <span class="hljs-number">5.</span>,  <span class="hljs-number">5.</span>,  <span class="hljs-number">5.</span>],</span><br><span class="line">       [ <span class="hljs-number">5.</span>,  <span class="hljs-number">5.</span>,  <span class="hljs-number">5.</span>]])</span><br></pre></td></tr></table></figure>

<p>但是，假设我们想要用一个一维数组来设置目标数组的各列，只要保证形状兼容就可以了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">110</span>]: col = np.array([<span class="hljs-number">1.28</span>, <span class="hljs-number">-0.42</span>, <span class="hljs-number">0.44</span>, <span class="hljs-number">1.6</span>])</span><br><span class="line">In [<span class="hljs-number">111</span>]: arr[:] = col[:, np.newaxis]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">112</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.28</span>,  <span class="hljs-number">1.28</span>,  <span class="hljs-number">1.28</span>],</span><br><span class="line">       [<span class="hljs-number">-0.42</span>, <span class="hljs-number">-0.42</span>, <span class="hljs-number">-0.42</span>],</span><br><span class="line">       [ <span class="hljs-number">0.44</span>,  <span class="hljs-number">0.44</span>,  <span class="hljs-number">0.44</span>],</span><br><span class="line">       [ <span class="hljs-number">1.6</span> ,  <span class="hljs-number">1.6</span> ,  <span class="hljs-number">1.6</span> ]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: arr[:<span class="hljs-number">2</span>] = [[<span class="hljs-number">-1.37</span>], [<span class="hljs-number">0.509</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">114</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">114</span>]: </span><br><span class="line">array([[<span class="hljs-number">-1.37</span> , <span class="hljs-number">-1.37</span> , <span class="hljs-number">-1.37</span> ],</span><br><span class="line">       [ <span class="hljs-number">0.509</span>,  <span class="hljs-number">0.509</span>,  <span class="hljs-number">0.509</span>],</span><br><span class="line">       [ <span class="hljs-number">0.44</span> ,  <span class="hljs-number">0.44</span> ,  <span class="hljs-number">0.44</span> ],</span><br><span class="line">       [ <span class="hljs-number">1.6</span>  ,  <span class="hljs-number">1.6</span>  ,  <span class="hljs-number">1.6</span>  ]])</span><br></pre></td></tr></table></figure>

<h1 id="A-4-ufunc高级应用"><a href="#A-4-ufunc高级应用" class="headerlink" title="A.4 ufunc高级应用"></a>A.4 ufunc高级应用</h1><p>虽然许多NumPy用户只会用到通用函数所提供的快速的元素级运算，但通用函数实际上还有一些高级用法能使我们丢开循环而编写出更为简洁的代码。</p>
<h2 id="ufunc实例方法"><a href="#ufunc实例方法" class="headerlink" title="ufunc实例方法"></a>ufunc实例方法</h2><p>NumPy的各个二元ufunc都有一些用于执行特定矢量化运算的特殊方法。表A-2汇总了这些方法，下面我将通过几个具体的例子对它们进行说明。</p>
<p>reduce接受一个数组参数，并通过一系列的二元运算对其值进行聚合（可指明轴向）。例如，我们可以用np.add.reduce对数组中各个元素进行求和：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">115</span>]: arr = np.arange(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: np.add.reduce(arr)</span><br><span class="line">Out[<span class="hljs-number">116</span>]: <span class="hljs-number">45</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">117</span>]: arr.sum()</span><br><span class="line">Out[<span class="hljs-number">117</span>]: <span class="hljs-number">45</span></span><br></pre></td></tr></table></figure>

<p>起始值取决于ufunc（对于add的情况，就是0）。如果设置了轴号，约简运算就会沿该轴向执行。这就使你能用一种比较简洁的方式得到某些问题的答案。在下面这个例子中，我们用np.logical_and检查数组各行中的值是否是有序的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">118</span>]: np.random.seed(<span class="hljs-number">12346</span>)  <span class="hljs-comment"># for reproducibility</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">119</span>]: arr = np.random.randn(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">120</span>]: arr[::<span class="hljs-number">2</span>].sort(<span class="hljs-number">1</span>) <span class="hljs-comment"># sort a few rows</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">121</span>]: arr[:, :<span class="hljs-number">-1</span>] &lt; arr[:, <span class="hljs-number">1</span>:]</span><br><span class="line">Out[<span class="hljs-number">121</span>]: </span><br><span class="line">array([[ <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>],</span><br><span class="line">       [<span class="hljs-literal">False</span>,  <span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>],</span><br><span class="line">       [ <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>],</span><br><span class="line">       [ <span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>,  <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>],</span><br><span class="line">       [ <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>,  <span class="hljs-literal">True</span>]], dtype=bool)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: np.logical_and.reduce(arr[:, :<span class="hljs-number">-1</span>] &lt; arr[:, <span class="hljs-number">1</span>:], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">122</span>]: array([ <span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>,  <span class="hljs-literal">True</span>, <span class="hljs-literal">False</span>,  <span class="hljs-literal">True</span>], dtype=bool)</span><br></pre></td></tr></table></figure>

<p>注意，logical_and.reduce跟all方法是等价的。</p>
<p>ccumulate跟reduce的关系就像cumsum跟sum的关系那样。它产生一个跟原数组大小相同的中间“累计”值数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">123</span>]: arr = np.arange(<span class="hljs-number">15</span>).reshape((<span class="hljs-number">3</span>, <span class="hljs-number">5</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">124</span>]: np.add.accumulate(arr, axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">124</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">10</span>],</span><br><span class="line">       [ <span class="hljs-number">5</span>, <span class="hljs-number">11</span>, <span class="hljs-number">18</span>, <span class="hljs-number">26</span>, <span class="hljs-number">35</span>],</span><br><span class="line">       [<span class="hljs-number">10</span>, <span class="hljs-number">21</span>, <span class="hljs-number">33</span>, <span class="hljs-number">46</span>, <span class="hljs-number">60</span>]])</span><br></pre></td></tr></table></figure>

<p>outer用于计算两个数组的叉积：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">125</span>]: arr = np.arange(<span class="hljs-number">3</span>).repeat([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">126</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">126</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">127</span>]: np.multiply.outer(arr, np.arange(<span class="hljs-number">5</span>))</span><br><span class="line">Out[<span class="hljs-number">127</span>]: </span><br><span class="line">array([[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],</span><br><span class="line">       [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],</span><br><span class="line">       [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>],</span><br><span class="line">       [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>],</span><br><span class="line">       [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>]])</span><br></pre></td></tr></table></figure>

<p>outer输出结果的维度是两个输入数据的维度之和：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">128</span>]: x, y = np.random.randn(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), np.random.randn(<span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">129</span>]: result = np.subtract.outer(x, y)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">130</span>]: result.shape</span><br><span class="line">Out[<span class="hljs-number">130</span>]: (<span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>)</span><br></pre></td></tr></table></figure>

<p>最后一个方法reduceat用于计算“局部约简”，其实就是一个对数据各切片进行聚合的groupby运算。它接受一组用于指示如何对值进行拆分和聚合的“面元边界”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">131</span>]: arr = np.arange(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: np.add.reduceat(arr, [<span class="hljs-number">0</span>, <span class="hljs-number">5</span>, <span class="hljs-number">8</span>])</span><br><span class="line">Out[<span class="hljs-number">132</span>]: array([<span class="hljs-number">10</span>, <span class="hljs-number">18</span>, <span class="hljs-number">17</span>])</span><br></pre></td></tr></table></figure>

<p>最终结果是在arr[0:5]、arr[5:8]以及arr[8:]上执行的约简。跟其他方法一样，这里也可以传入一个axis参数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">133</span>]: arr = np.multiply.outer(np.arange(<span class="hljs-number">4</span>), np.arange(<span class="hljs-number">5</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">134</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>],</span><br><span class="line">       [ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">4</span>],</span><br><span class="line">       [ <span class="hljs-number">0</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">8</span>],</span><br><span class="line">       [ <span class="hljs-number">0</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">12</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">135</span>]: np.add.reduceat(arr, [<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">135</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>,  <span class="hljs-number">0</span>],</span><br><span class="line">       [ <span class="hljs-number">1</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">4</span>],</span><br><span class="line">       [ <span class="hljs-number">2</span>, <span class="hljs-number">10</span>,  <span class="hljs-number">8</span>],</span><br><span class="line">       [ <span class="hljs-number">3</span>, <span class="hljs-number">15</span>, <span class="hljs-number">12</span>]])</span><br></pre></td></tr></table></figure>

<p>表A-2总结了部分的ufunc方法。</p>
<p><img src="/images/blog/7178691-c997bd45000f7b72.webp" alt="img"></p>
<p>表A ufunc方法</p>
<h2 id="编写新的ufunc"><a href="#编写新的ufunc" class="headerlink" title="编写新的ufunc"></a>编写新的ufunc</h2><p>有多种方法可以让你编写自己的NumPy ufuncs。最常见的是使用NumPy C API，但它超越了本书的范围。在本节，我们讲纯粹的Python ufunc。</p>
<p>numpy.frompyfunc接受一个Python函数以及两个分别表示输入输出参数数量的参数。例如，下面是一个能够实现元素级加法的简单函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">136</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_elements</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">   .....:     <span class="hljs-keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: add_them = np.frompyfunc(add_elements, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">138</span>]: add_them(np.arange(<span class="hljs-number">8</span>), np.arange(<span class="hljs-number">8</span>))</span><br><span class="line">Out[<span class="hljs-number">138</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">6</span>, <span class="hljs-number">8</span>, <span class="hljs-number">10</span>, <span class="hljs-number">12</span>, <span class="hljs-number">14</span>], dtype=object)</span><br></pre></td></tr></table></figure>

<p>用frompyfunc创建的函数总是返回Python对象数组，这一点很不方便。幸运的是，还有另一个办法，即numpy.vectorize。虽然没有frompyfunc那么强大，但可以让你指定输出类型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">139</span>]: add_them = np.vectorize(add_elements, otypes=[np.float64])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">140</span>]: add_them(np.arange(<span class="hljs-number">8</span>), np.arange(<span class="hljs-number">8</span>))</span><br><span class="line">Out[<span class="hljs-number">140</span>]: array([  <span class="hljs-number">0.</span>,   <span class="hljs-number">2.</span>,   <span class="hljs-number">4.</span>,   <span class="hljs-number">6.</span>,   <span class="hljs-number">8.</span>,  <span class="hljs-number">10.</span>,  <span class="hljs-number">12.</span>,  <span class="hljs-number">14.</span>])</span><br></pre></td></tr></table></figure>

<p>虽然这两个函数提供了一种创建ufunc型函数的手段，但它们非常慢，因为它们在计算每个元素时都要执行一次Python函数调用，这就会比NumPy自带的基于C的ufunc慢很多：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">141</span>]: arr = np.random.randn(<span class="hljs-number">10000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">142</span>]: %timeit add_them(arr, arr)</span><br><span class="line"><span class="hljs-number">4.12</span> ms +- <span class="hljs-number">182</span> us per loop (mean +- std. dev. of <span class="hljs-number">7</span> runs, <span class="hljs-number">100</span> loops each)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">143</span>]: %timeit np.add(arr, arr)</span><br><span class="line"><span class="hljs-number">6.89</span> us +- <span class="hljs-number">504</span> ns per loop (mean +- std. dev. of <span class="hljs-number">7</span> runs, <span class="hljs-number">100000</span> loops each)</span><br></pre></td></tr></table></figure>

<p>本章的后面，我会介绍使用Numba（<a href="http://numba.pydata.org/），创建快速Python" target="_blank" rel="noopener">http://numba.pydata.org/），创建快速Python</a> ufuncs。</p>
<h1 id="A-5-结构化和记录式数组"><a href="#A-5-结构化和记录式数组" class="headerlink" title="A.5 结构化和记录式数组"></a>A.5 结构化和记录式数组</h1><p>你可能已经注意到了，到目前为止我们所讨论的ndarray都是一种同质数据容器，也就是说，在它所表示的内存块中，各元素占用的字节数相同（具体根据dtype而定）。从表面上看，它似乎不能用于表示异质或表格型的数据。结构化数组是一种特殊的ndarray，其中的各个元素可以被看做C语言中的结构体（struct，这就是“结构化”的由来）或SQL表中带有多个命名字段的行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">144</span>]: dtype = [(<span class="hljs-string">'x'</span>, np.float64), (<span class="hljs-string">'y'</span>, np.int32)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">145</span>]: sarr = np.array([(<span class="hljs-number">1.5</span>, <span class="hljs-number">6</span>), (np.pi, <span class="hljs-number">-2</span>)], dtype=dtype)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">146</span>]: sarr</span><br><span class="line">Out[<span class="hljs-number">146</span>]: </span><br><span class="line">array([( <span class="hljs-number">1.5</span>   ,  <span class="hljs-number">6</span>), ( <span class="hljs-number">3.1416</span>, <span class="hljs-number">-2</span>)],</span><br><span class="line">      dtype=[(<span class="hljs-string">'x'</span>, <span class="hljs-string">'&lt;f8'</span>), (<span class="hljs-string">'y'</span>, <span class="hljs-string">'&lt;i4'</span>)])</span><br></pre></td></tr></table></figure>

<p>定义结构化dtype（请参考NumPy的在线文档）的方式有很多。最典型的办法是元组列表，各元组的格式为(field_name,field_data_type)。这样，数组的元素就成了元组式的对象，该对象中各个元素可以像字典那样进行访问：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">147</span>]: sarr[<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">147</span>]: ( <span class="hljs-number">1.5</span>, <span class="hljs-number">6</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">148</span>]: sarr[<span class="hljs-number">0</span>][<span class="hljs-string">'y'</span>]</span><br><span class="line">Out[<span class="hljs-number">148</span>]: <span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<p>字段名保存在dtype.names属性中。在访问结构化数组的某个字段时，返回的是该数据的视图，所以不会发生数据复制：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">149</span>]: sarr[<span class="hljs-string">'x'</span>]</span><br><span class="line">Out[<span class="hljs-number">149</span>]: array([ <span class="hljs-number">1.5</span>   ,  <span class="hljs-number">3.1416</span>])</span><br></pre></td></tr></table></figure>

<h2 id="嵌套dtype和多维字段"><a href="#嵌套dtype和多维字段" class="headerlink" title="嵌套dtype和多维字段"></a>嵌套dtype和多维字段</h2><p>在定义结构化dtype时，你可以再设置一个形状（可以是一个整数，也可以是一个元组）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">150</span>]: dtype = [(<span class="hljs-string">'x'</span>, np.int64, <span class="hljs-number">3</span>), (<span class="hljs-string">'y'</span>, np.int32)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">151</span>]: arr = np.zeros(<span class="hljs-number">4</span>, dtype=dtype)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">152</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">152</span>]: </span><br><span class="line">array([([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-number">0</span>), ([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-number">0</span>), ([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-number">0</span>), ([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], <span class="hljs-number">0</span>)],</span><br><span class="line">      dtype=[(<span class="hljs-string">'x'</span>, <span class="hljs-string">'&lt;i8'</span>, (<span class="hljs-number">3</span>,)), (<span class="hljs-string">'y'</span>, <span class="hljs-string">'&lt;i4'</span>)])</span><br></pre></td></tr></table></figure>

<p>在这种情况下，各个记录的x字段所表示的是一个长度为3的数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">153</span>]: arr[<span class="hljs-number">0</span>][<span class="hljs-string">'x'</span>]</span><br><span class="line">Out[<span class="hljs-number">153</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>这样，访问arr[‘x’]即可得到一个二维数组，而不是前面那个例子中的一维数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">154</span>]: arr[<span class="hljs-string">'x'</span>]</span><br><span class="line">Out[<span class="hljs-number">154</span>]: </span><br><span class="line">array([[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],</span><br><span class="line">       [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],</span><br><span class="line">       [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],</span><br><span class="line">       [<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>]])</span><br></pre></td></tr></table></figure>

<p>这就使你能用单个数组的内存块存放复杂的嵌套结构。你还可以嵌套dtype，作出更复杂的结构。下面是一个简单的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">155</span>]: dtype = [(<span class="hljs-string">'x'</span>, [(<span class="hljs-string">'a'</span>, <span class="hljs-string">'f8'</span>), (<span class="hljs-string">'b'</span>, <span class="hljs-string">'f4'</span>)]), (<span class="hljs-string">'y'</span>, np.int32)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">156</span>]: data = np.array([((<span class="hljs-number">1</span>, <span class="hljs-number">2</span>), <span class="hljs-number">5</span>), ((<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), <span class="hljs-number">6</span>)], dtype=dtype)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">157</span>]: data[<span class="hljs-string">'x'</span>]</span><br><span class="line">Out[<span class="hljs-number">157</span>]: </span><br><span class="line">array([( <span class="hljs-number">1.</span>,  <span class="hljs-number">2.</span>), ( <span class="hljs-number">3.</span>,  <span class="hljs-number">4.</span>)],</span><br><span class="line">      dtype=[(<span class="hljs-string">'a'</span>, <span class="hljs-string">'&lt;f8'</span>), (<span class="hljs-string">'b'</span>, <span class="hljs-string">'&lt;f4'</span>)])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: data[<span class="hljs-string">'y'</span>]</span><br><span class="line">Out[<span class="hljs-number">158</span>]: array([<span class="hljs-number">5</span>, <span class="hljs-number">6</span>], dtype=int32)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">159</span>]: data[<span class="hljs-string">'x'</span>][<span class="hljs-string">'a'</span>]</span><br><span class="line">Out[<span class="hljs-number">159</span>]: array([ <span class="hljs-number">1.</span>,  <span class="hljs-number">3.</span>])</span><br></pre></td></tr></table></figure>

<p>pandas的DataFrame并不直接支持该功能，但它的分层索引机制跟这个差不多。</p>
<h2 id="为什么要用结构化数组"><a href="#为什么要用结构化数组" class="headerlink" title="为什么要用结构化数组"></a>为什么要用结构化数组</h2><p>跟pandas的DataFrame相比，NumPy的结构化数组是一种相对较低级的工具。它可以将单个内存块解释为带有任意复杂嵌套列的表格型结构。由于数组中的每个元素在内存中都被表示为固定的字节数，所以结构化数组能够提供非常快速高效的磁盘数据读写（包括内存映像）、网络传输等功能。</p>
<p>结构化数组的另一个常见用法是，将数据文件写成定长记录字节流，这是C和C++代码中常见的数据序列化手段（业界许多历史系统中都能找得到）。只要知道文件的格式（记录的大小、元素的顺序、字节数以及数据类型等），就可以用np.fromfile将数据读入内存。这种用法超出了本书的范围，知道这点就可以了。</p>
<h1 id="A-6-更多有关排序的话题"><a href="#A-6-更多有关排序的话题" class="headerlink" title="A.6 更多有关排序的话题"></a>A.6 更多有关排序的话题</h1><p>跟Python内置的列表一样，ndarray的sort实例方法也是就地排序。也就是说，数组内容的重新排列是不会产生新数组的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">160</span>]: arr = np.random.randn(<span class="hljs-number">6</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">161</span>]: arr.sort()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">162</span>]: array([<span class="hljs-number">-1.082</span> ,  <span class="hljs-number">0.3759</span>,  <span class="hljs-number">0.8014</span>,  <span class="hljs-number">1.1397</span>,  <span class="hljs-number">1.2888</span>,  <span class="hljs-number">1.8413</span>])</span><br></pre></td></tr></table></figure>

<p>在对数组进行就地排序时要注意一点，如果目标数组只是一个视图，则原始数组将会被修改：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">163</span>]: arr = np.random.randn(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">164</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">164</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.3318</span>, <span class="hljs-number">-1.4711</span>,  <span class="hljs-number">0.8705</span>, <span class="hljs-number">-0.0847</span>, <span class="hljs-number">-1.1329</span>],</span><br><span class="line">       [<span class="hljs-number">-1.0111</span>, <span class="hljs-number">-0.3436</span>,  <span class="hljs-number">2.1714</span>,  <span class="hljs-number">0.1234</span>, <span class="hljs-number">-0.0189</span>],</span><br><span class="line">       [ <span class="hljs-number">0.1773</span>,  <span class="hljs-number">0.7424</span>,  <span class="hljs-number">0.8548</span>,  <span class="hljs-number">1.038</span> , <span class="hljs-number">-0.329</span> ]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">165</span>]: arr[:, <span class="hljs-number">0</span>].sort()  <span class="hljs-comment"># Sort first column values in-place</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">166</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">166</span>]: </span><br><span class="line">array([[<span class="hljs-number">-1.0111</span>, <span class="hljs-number">-1.4711</span>,  <span class="hljs-number">0.8705</span>, <span class="hljs-number">-0.0847</span>, <span class="hljs-number">-1.1329</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3318</span>, <span class="hljs-number">-0.3436</span>,  <span class="hljs-number">2.1714</span>,  <span class="hljs-number">0.1234</span>, <span class="hljs-number">-0.0189</span>],</span><br><span class="line">       [ <span class="hljs-number">0.1773</span>,  <span class="hljs-number">0.7424</span>,  <span class="hljs-number">0.8548</span>,  <span class="hljs-number">1.038</span> , <span class="hljs-number">-0.329</span> ]])</span><br></pre></td></tr></table></figure>

<p>相反，numpy.sort会为原数组创建一个已排序副本。另外，它所接受的参数（比如kind）跟ndarray.sort一样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">167</span>]: arr = np.random.randn(<span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">168</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">168</span>]: array([<span class="hljs-number">-1.1181</span>, <span class="hljs-number">-0.2415</span>, <span class="hljs-number">-2.0051</span>,  <span class="hljs-number">0.7379</span>, <span class="hljs-number">-1.0614</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">169</span>]: np.sort(arr)</span><br><span class="line">Out[<span class="hljs-number">169</span>]: array([<span class="hljs-number">-2.0051</span>, <span class="hljs-number">-1.1181</span>, <span class="hljs-number">-1.0614</span>, <span class="hljs-number">-0.2415</span>,  <span class="hljs-number">0.7379</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">170</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">170</span>]: array([<span class="hljs-number">-1.1181</span>, <span class="hljs-number">-0.2415</span>, <span class="hljs-number">-2.0051</span>,  <span class="hljs-number">0.7379</span>, <span class="hljs-number">-1.0614</span>])</span><br></pre></td></tr></table></figure>

<p>这两个排序方法都可以接受一个axis参数，以便沿指定轴向对各块数据进行单独排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">171</span>]: arr = np.random.randn(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">172</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">172</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.5955</span>, <span class="hljs-number">-0.2682</span>,  <span class="hljs-number">1.3389</span>, <span class="hljs-number">-0.1872</span>,  <span class="hljs-number">0.9111</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3215</span>,  <span class="hljs-number">1.0054</span>, <span class="hljs-number">-0.5168</span>,  <span class="hljs-number">1.1925</span>, <span class="hljs-number">-0.1989</span>],</span><br><span class="line">       [ <span class="hljs-number">0.3969</span>, <span class="hljs-number">-1.7638</span>,  <span class="hljs-number">0.6071</span>, <span class="hljs-number">-0.2222</span>, <span class="hljs-number">-0.2171</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">173</span>]: arr.sort(axis=<span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">174</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">174</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.2682</span>, <span class="hljs-number">-0.1872</span>,  <span class="hljs-number">0.5955</span>,  <span class="hljs-number">0.9111</span>,  <span class="hljs-number">1.3389</span>],</span><br><span class="line">       [<span class="hljs-number">-0.5168</span>, <span class="hljs-number">-0.3215</span>, <span class="hljs-number">-0.1989</span>,  <span class="hljs-number">1.0054</span>,  <span class="hljs-number">1.1925</span>],</span><br><span class="line">       [<span class="hljs-number">-1.7638</span>, <span class="hljs-number">-0.2222</span>, <span class="hljs-number">-0.2171</span>,  <span class="hljs-number">0.3969</span>,  <span class="hljs-number">0.6071</span>]])</span><br></pre></td></tr></table></figure>

<p>你可能注意到了，这两个排序方法都不可以被设置为降序。其实这也无所谓，因为数组切片会产生视图（也就是说，不会产生副本，也不需要任何其他的计算工作）。许多Python用户都很熟悉一个有关列表的小技巧：values[::-1]可以返回一个反序的列表。对ndarray也是如此：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">175</span>]: arr[:, ::<span class="hljs-number">-1</span>]</span><br><span class="line">Out[<span class="hljs-number">175</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.3389</span>,  <span class="hljs-number">0.9111</span>,  <span class="hljs-number">0.5955</span>, <span class="hljs-number">-0.1872</span>, <span class="hljs-number">-0.2682</span>],</span><br><span class="line">       [ <span class="hljs-number">1.1925</span>,  <span class="hljs-number">1.0054</span>, <span class="hljs-number">-0.1989</span>, <span class="hljs-number">-0.3215</span>, <span class="hljs-number">-0.5168</span>],</span><br><span class="line">       [ <span class="hljs-number">0.6071</span>,  <span class="hljs-number">0.3969</span>, <span class="hljs-number">-0.2171</span>, <span class="hljs-number">-0.2222</span>, <span class="hljs-number">-1.7638</span>]])</span><br></pre></td></tr></table></figure>

<h2 id="间接排序：argsort和lexsort"><a href="#间接排序：argsort和lexsort" class="headerlink" title="间接排序：argsort和lexsort"></a>间接排序：argsort和lexsort</h2><p>在数据分析工作中，常常需要根据一个或多个键对数据集进行排序。例如，一个有关学生信息的数据表可能需要以姓和名进行排序（先姓后名）。这就是间接排序的一个例子，如果你阅读过有关pandas的章节，那就已经见过不少高级例子了。给定一个或多个键，你就可以得到一个由整数组成的索引数组（我亲切地称之为索引器），其中的索引值说明了数据在新顺序下的位置。argsort和numpy.lexsort就是实现该功能的两个主要方法。下面是一个简单的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">176</span>]: values = np.array([<span class="hljs-number">5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">177</span>]: indexer = values.argsort()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">178</span>]: indexer</span><br><span class="line">Out[<span class="hljs-number">178</span>]: array([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">179</span>]: values[indexer]</span><br><span class="line">Out[<span class="hljs-number">179</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>])</span><br></pre></td></tr></table></figure>

<p>一个更复杂的例子，下面这段代码根据数组的第一行对其进行排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">180</span>]: arr = np.random.randn(<span class="hljs-number">3</span>, <span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">181</span>]: arr[<span class="hljs-number">0</span>] = values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">182</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">182</span>]: </span><br><span class="line">array([[ <span class="hljs-number">5.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">1.</span>    ,  <span class="hljs-number">3.</span>    ,  <span class="hljs-number">2.</span>    ],</span><br><span class="line">       [<span class="hljs-number">-0.3636</span>, <span class="hljs-number">-0.1378</span>,  <span class="hljs-number">2.1777</span>, <span class="hljs-number">-0.4728</span>,  <span class="hljs-number">0.8356</span>],</span><br><span class="line">       [<span class="hljs-number">-0.2089</span>,  <span class="hljs-number">0.2316</span>,  <span class="hljs-number">0.728</span> , <span class="hljs-number">-1.3918</span>,  <span class="hljs-number">1.9956</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">183</span>]: arr[:, arr[<span class="hljs-number">0</span>].argsort()]</span><br><span class="line">Out[<span class="hljs-number">183</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">1.</span>    ,  <span class="hljs-number">2.</span>    ,  <span class="hljs-number">3.</span>    ,  <span class="hljs-number">5.</span>    ],</span><br><span class="line">       [<span class="hljs-number">-0.1378</span>,  <span class="hljs-number">2.1777</span>,  <span class="hljs-number">0.8356</span>, <span class="hljs-number">-0.4728</span>, <span class="hljs-number">-0.3636</span>],</span><br><span class="line">       [ <span class="hljs-number">0.2316</span>,  <span class="hljs-number">0.728</span> ,  <span class="hljs-number">1.9956</span>, <span class="hljs-number">-1.3918</span>, <span class="hljs-number">-0.2089</span>]])</span><br></pre></td></tr></table></figure>

<p>lexsort跟argsort差不多，只不过它可以一次性对多个键数组执行间接排序（字典序）。假设我们想对一些以姓和名标识的数据进行排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">184</span>]: first_name = np.array([<span class="hljs-string">'Bob'</span>, <span class="hljs-string">'Jane'</span>, <span class="hljs-string">'Steve'</span>, <span class="hljs-string">'Bill'</span>, <span class="hljs-string">'Barbara'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">185</span>]: last_name = np.array([<span class="hljs-string">'Jones'</span>, <span class="hljs-string">'Arnold'</span>, <span class="hljs-string">'Arnold'</span>, <span class="hljs-string">'Jones'</span>, <span class="hljs-string">'Walters'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">186</span>]: sorter = np.lexsort((first_name, last_name))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">187</span>]: sorter</span><br><span class="line">Out[<span class="hljs-number">187</span>]: array([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">4</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">188</span>]: zip(last_name[sorter], first_name[sorter])</span><br><span class="line">Out[<span class="hljs-number">188</span>]: &lt;zip at <span class="hljs-number">0x7fa203eda1c8</span>&gt;</span><br></pre></td></tr></table></figure>

<p>刚开始使用lexsort的时候可能会比较容易头晕，这是因为键的应用顺序是从最后一个传入的算起的。不难看出，last_name是先于first_name被应用的。</p>
<blockquote>
<p>笔记：Series和DataFrame的sort_index以及Series的order方法就是通过这些函数的变体（它们还必须考虑缺失值）实现的。</p>
</blockquote>
<h2 id="其他排序算法"><a href="#其他排序算法" class="headerlink" title="其他排序算法"></a>其他排序算法</h2><p>稳定的（stable）排序算法会保持等价元素的相对位置。对于相对位置具有实际意义的那些间接排序而言，这一点非常重要：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">189</span>]: values = np.array([<span class="hljs-string">'2:first'</span>, <span class="hljs-string">'2:second'</span>, <span class="hljs-string">'1:first'</span>, <span class="hljs-string">'1:second'</span>,</span><br><span class="line">.....:                    <span class="hljs-string">'1:third'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">190</span>]: key = np.array([<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">191</span>]: indexer = key.argsort(kind=<span class="hljs-string">'mergesort'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">192</span>]: indexer</span><br><span class="line">Out[<span class="hljs-number">192</span>]: array([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">193</span>]: values.take(indexer)</span><br><span class="line">Out[<span class="hljs-number">193</span>]: </span><br><span class="line">array([<span class="hljs-string">'1:first'</span>, <span class="hljs-string">'1:second'</span>, <span class="hljs-string">'1:third'</span>, <span class="hljs-string">'2:first'</span>, <span class="hljs-string">'2:second'</span>],</span><br><span class="line">      dtype=<span class="hljs-string">'&lt;U8'</span>)</span><br></pre></td></tr></table></figure>

<p>mergesort（合并排序）是唯一的稳定排序，它保证有O(n log n)的性能（空间复杂度），但是其平均性能比默认的quicksort（快速排序）要差。表A-3列出了可用的排序算法及其相关的性能指标。大部分用户完全不需要知道这些东西，但了解一下总是好的。</p>
<p><img src="/images/blog/7178691-970f54f58b6b3356.webp" alt="img"></p>
<p>表A-3 数组排序算法</p>
<h2 id="部分排序数组"><a href="#部分排序数组" class="headerlink" title="部分排序数组"></a>部分排序数组</h2><p>排序的目的之一可能是确定数组中最大或最小的元素。NumPy有两个优化方法，numpy.partition和np.argpartition，可以在第k个最小元素划分的数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">194</span>]: np.random.seed(<span class="hljs-number">12345</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">195</span>]: arr = np.random.randn(<span class="hljs-number">20</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">196</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">196</span>]: </span><br><span class="line">array([<span class="hljs-number">-0.2047</span>,  <span class="hljs-number">0.4789</span>, <span class="hljs-number">-0.5194</span>, <span class="hljs-number">-0.5557</span>,  <span class="hljs-number">1.9658</span>,  <span class="hljs-number">1.3934</span>,  <span class="hljs-number">0.0929</span>,</span><br><span class="line">        <span class="hljs-number">0.2817</span>,  <span class="hljs-number">0.769</span> ,  <span class="hljs-number">1.2464</span>,  <span class="hljs-number">1.0072</span>, <span class="hljs-number">-1.2962</span>,  <span class="hljs-number">0.275</span> ,  <span class="hljs-number">0.2289</span>,</span><br><span class="line">        <span class="hljs-number">1.3529</span>,  <span class="hljs-number">0.8864</span>, <span class="hljs-number">-2.0016</span>, <span class="hljs-number">-0.3718</span>,  <span class="hljs-number">1.669</span> , <span class="hljs-number">-0.4386</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">197</span>]: np.partition(arr, <span class="hljs-number">3</span>)</span><br><span class="line">Out[<span class="hljs-number">197</span>]: </span><br><span class="line">array([<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-1.2962</span>, <span class="hljs-number">-0.5557</span>, <span class="hljs-number">-0.5194</span>, <span class="hljs-number">-0.3718</span>, <span class="hljs-number">-0.4386</span>, <span class="hljs-number">-0.2047</span>,</span><br><span class="line">        <span class="hljs-number">0.2817</span>,  <span class="hljs-number">0.769</span> ,  <span class="hljs-number">0.4789</span>,  <span class="hljs-number">1.0072</span>,  <span class="hljs-number">0.0929</span>,  <span class="hljs-number">0.275</span> ,  <span class="hljs-number">0.2289</span>,</span><br><span class="line">        <span class="hljs-number">1.3529</span>,  <span class="hljs-number">0.8864</span>,  <span class="hljs-number">1.3934</span>,  <span class="hljs-number">1.9658</span>,  <span class="hljs-number">1.669</span> ,  <span class="hljs-number">1.2464</span>])</span><br></pre></td></tr></table></figure>

<p>当你调用partition(arr, 3)，结果中的头三个元素是最小的三个，没有特定的顺序。numpy.argpartition与numpy.argsort相似，会返回索引，重排数据为等价的顺序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">198</span>]: indices = np.argpartition(arr, <span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">199</span>]: indices</span><br><span class="line">Out[<span class="hljs-number">199</span>]: </span><br><span class="line">array([<span class="hljs-number">16</span>, <span class="hljs-number">11</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">2</span>, <span class="hljs-number">17</span>, <span class="hljs-number">19</span>,  <span class="hljs-number">0</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">1</span>, <span class="hljs-number">10</span>,  <span class="hljs-number">6</span>, <span class="hljs-number">12</span>, <span class="hljs-number">13</span>, <span class="hljs-number">14</span>, <span class="hljs-number">15</span>,  <span class="hljs-number">5</span>,</span><br><span class="line">        <span class="hljs-number">4</span>, <span class="hljs-number">18</span>,  <span class="hljs-number">9</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">200</span>]: arr.take(indices)</span><br><span class="line">Out[<span class="hljs-number">200</span>]: </span><br><span class="line">array([<span class="hljs-number">-2.0016</span>, <span class="hljs-number">-1.2962</span>, <span class="hljs-number">-0.5557</span>, <span class="hljs-number">-0.5194</span>, <span class="hljs-number">-0.3718</span>, <span class="hljs-number">-0.4386</span>, <span class="hljs-number">-0.2047</span>,</span><br><span class="line">        <span class="hljs-number">0.2817</span>,  <span class="hljs-number">0.769</span> ,  <span class="hljs-number">0.4789</span>,  <span class="hljs-number">1.0072</span>,  <span class="hljs-number">0.0929</span>,  <span class="hljs-number">0.275</span> ,  <span class="hljs-number">0.2289</span>,</span><br><span class="line">        <span class="hljs-number">1.3529</span>,  <span class="hljs-number">0.8864</span>,  <span class="hljs-number">1.3934</span>,  <span class="hljs-number">1.9658</span>,  <span class="hljs-number">1.669</span> ,  <span class="hljs-number">1.2464</span>])</span><br></pre></td></tr></table></figure>

<h2 id="numpy-searchsorted：在有序数组中查找元素"><a href="#numpy-searchsorted：在有序数组中查找元素" class="headerlink" title="numpy.searchsorted：在有序数组中查找元素"></a>numpy.searchsorted：在有序数组中查找元素</h2><p>searchsorted是一个在有序数组上执行二分查找的数组方法，只要将值插入到它返回的那个位置就能维持数组的有序性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">201</span>]: arr = np.array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>, <span class="hljs-number">12</span>, <span class="hljs-number">15</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">202</span>]: arr.searchsorted(<span class="hljs-number">9</span>)</span><br><span class="line">Out[<span class="hljs-number">202</span>]: <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<p>你可以传入一组值就能得到一组索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">203</span>]: arr.searchsorted([<span class="hljs-number">0</span>, <span class="hljs-number">8</span>, <span class="hljs-number">11</span>, <span class="hljs-number">16</span>])</span><br><span class="line">Out[<span class="hljs-number">203</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>])</span><br></pre></td></tr></table></figure>

<p>从上面的结果中可以看出，对于元素0，searchsorted会返回0。这是因为其默认行为是返回相等值组的左侧索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">204</span>]: arr = np.array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">205</span>]: arr.searchsorted([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>])</span><br><span class="line">Out[<span class="hljs-number">205</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">3</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">206</span>]: arr.searchsorted([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], side=<span class="hljs-string">'right'</span>)</span><br><span class="line">Out[<span class="hljs-number">206</span>]: array([<span class="hljs-number">3</span>, <span class="hljs-number">7</span>])</span><br></pre></td></tr></table></figure>

<p>再来看searchsorted的另一个用法，假设我们有一个数据数组（其中的值在0到10000之间），还有一个表示“面元边界”的数组，我们希望用它将数据数组拆分开：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">207</span>]: data = np.floor(np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">10000</span>, size=<span class="hljs-number">50</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">208</span>]: bins = np.array([<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">5000</span>, <span class="hljs-number">10000</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">209</span>]: data</span><br><span class="line">Out[<span class="hljs-number">209</span>]: </span><br><span class="line">array([ <span class="hljs-number">9940.</span>,  <span class="hljs-number">6768.</span>,  <span class="hljs-number">7908.</span>,  <span class="hljs-number">1709.</span>,   <span class="hljs-number">268.</span>,  <span class="hljs-number">8003.</span>, <span class="hljs-number">9037.</span>,   <span class="hljs-number">246.</span>,</span><br><span class="line">        <span class="hljs-number">4917.</span>,  <span class="hljs-number">5262.</span>,  <span class="hljs-number">5963.</span>,   <span class="hljs-number">519.</span>,  <span class="hljs-number">8950.</span>,  <span class="hljs-number">7282.</span>,  <span class="hljs-number">8183.</span>,  <span class="hljs-number">5002.</span>,</span><br><span class="line">        <span class="hljs-number">8101.</span>,   <span class="hljs-number">959.</span>,  <span class="hljs-number">2189.</span>,  <span class="hljs-number">2587.</span>,  <span class="hljs-number">4681.</span>,  <span class="hljs-number">4593.</span>,  <span class="hljs-number">7095.</span>,  <span class="hljs-number">1780.</span>,</span><br><span class="line">        <span class="hljs-number">5314.</span>,  <span class="hljs-number">1677.</span>,  <span class="hljs-number">7688.</span>,  <span class="hljs-number">9281.</span>,  <span class="hljs-number">6094.</span>,  <span class="hljs-number">1501.</span>,  <span class="hljs-number">4896.</span>,  <span class="hljs-number">3773.</span>,</span><br><span class="line">        <span class="hljs-number">8486.</span>,  <span class="hljs-number">9110.</span>,  <span class="hljs-number">3838.</span>,  <span class="hljs-number">3154.</span>,  <span class="hljs-number">5683.</span>,  <span class="hljs-number">1878.</span>,  <span class="hljs-number">1258.</span>,  <span class="hljs-number">6875.</span>,</span><br><span class="line">        <span class="hljs-number">7996.</span>,  <span class="hljs-number">5735.</span>,  <span class="hljs-number">9732.</span>,  <span class="hljs-number">6340.</span>,  <span class="hljs-number">8884.</span>,  <span class="hljs-number">4954.</span>,  <span class="hljs-number">3516.</span>,  <span class="hljs-number">7142.</span>,</span><br><span class="line">        <span class="hljs-number">5039.</span>,  <span class="hljs-number">2256.</span>])</span><br></pre></td></tr></table></figure>

<p>然后，为了得到各数据点所属区间的编号（其中1表示面元[0,100)），我们可以直接使用searchsorted：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">210</span>]: labels = bins.searchsorted(data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">211</span>]: labels</span><br><span class="line">Out[<span class="hljs-number">211</span>]: </span><br><span class="line">array([<span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>,</span><br><span class="line">       <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>,</span><br><span class="line">       <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>, <span class="hljs-number">3</span>])</span><br></pre></td></tr></table></figure>

<p>通过pandas的groupby使用该结果即可非常轻松地对原数据集进行拆分：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">212</span>]: pd.Series(data).groupby(labels).mean()</span><br><span class="line">Out[<span class="hljs-number">212</span>]: </span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">498.000000</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">3064.277778</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">7389.035714</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<h1 id="A-7-用Numba编写快速NumPy函数"><a href="#A-7-用Numba编写快速NumPy函数" class="headerlink" title="A.7 用Numba编写快速NumPy函数"></a>A.7 用Numba编写快速NumPy函数</h1><p>Numba是一个开源项目，它可以利用CPUs、GPUs或其它硬件为类似NumPy的数据创建快速函数。它使用了LLVM项目（<a href="http://llvm.org/），将Python代码转换为机器代码。" target="_blank" rel="noopener">http://llvm.org/），将Python代码转换为机器代码。</a></p>
<p>为了介绍Numba，来考虑一个纯粹的Python函数，它使用for循环计算表达式(x - y).mean()：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mean_distance</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">    nx = len(x)</span><br><span class="line">    result = <span class="hljs-number">0.0</span></span><br><span class="line">    count = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(nx):</span><br><span class="line">        result += x[i] - y[i]</span><br><span class="line">        count += <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-keyword">return</span> result / count</span><br></pre></td></tr></table></figure>

<p>这个函数很慢：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">209</span>]: x = np.random.randn(<span class="hljs-number">10000000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">210</span>]: y = np.random.randn(<span class="hljs-number">10000000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">211</span>]: %timeit mean_distance(x, y)</span><br><span class="line"><span class="hljs-number">1</span> loop, best of <span class="hljs-number">3</span>: <span class="hljs-number">2</span> s per loop</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">212</span>]: %timeit (x - y).mean()</span><br><span class="line"><span class="hljs-number">100</span> loops, best of <span class="hljs-number">3</span>: <span class="hljs-number">14.7</span> ms per loop</span><br></pre></td></tr></table></figure>

<p>NumPy的版本要比它快过100倍。我们可以转换这个函数为编译的Numba函数，使用numba.jit函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">213</span>]: <span class="hljs-keyword">import</span> numba <span class="hljs-keyword">as</span> nb</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">214</span>]: numba_mean_distance = nb.jit(mean_distance)</span><br></pre></td></tr></table></figure>

<p>也可以写成装饰器：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-meta">@nb.jit</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mean_distance</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">    nx = len(x)</span><br><span class="line">    result = <span class="hljs-number">0.0</span></span><br><span class="line">    count = <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(nx):</span><br><span class="line">        result += x[i] - y[i]</span><br><span class="line">        count += <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-keyword">return</span> result / count</span><br></pre></td></tr></table></figure>

<p>它要比矢量化的NumPy快：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">215</span>]: %timeit numba_mean_distance(x, y)</span><br><span class="line"><span class="hljs-number">100</span> loops, best of <span class="hljs-number">3</span>: <span class="hljs-number">10.3</span> ms per loop</span><br></pre></td></tr></table></figure>

<p>Numba不能编译Python代码，但它支持纯Python写的一个部分，可以编写数值算法。</p>
<p>Numba是一个深厚的库，支持多种硬件、编译模式和用户插件。它还可以编译NumPy Python API的一部分，而不用for循环。Numba也可以识别可以便以为机器编码的结构体，但是若调用CPython API，它就不知道如何编译。Numba的jit函数有一个选项，nopython=True，它限制了可以被转换为Python代码的代码，这些代码可以编译为LLVM，但没有任何Python C API调用。jit(nopython=True)有一个简短的别名numba.njit。</p>
<p>前面的例子，我们还可以这样写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> float64, njit</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@njit(float64(float64[:], float64[:]))</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">mean_distance</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> (x - y).mean()</span><br></pre></td></tr></table></figure>

<p>我建议你学习Numba的线上文档（<a href="http://numba.pydata.org/）。下一节介绍一个创建自定义Numpy" target="_blank" rel="noopener">http://numba.pydata.org/）。下一节介绍一个创建自定义Numpy</a> ufunc对象的例子。</p>
<h2 id="用Numba创建自定义numpy-ufunc对象"><a href="#用Numba创建自定义numpy-ufunc对象" class="headerlink" title="用Numba创建自定义numpy.ufunc对象"></a>用Numba创建自定义numpy.ufunc对象</h2><p>numba.vectorize创建了一个编译的NumPy ufunc，它与内置的ufunc很像。考虑一个numpy.add的Python例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> numba <span class="hljs-keyword">import</span> vectorize</span><br><span class="line"></span><br><span class="line"><span class="hljs-meta">@vectorize</span></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">nb_add</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> x + y</span><br></pre></td></tr></table></figure>

<p>现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">13</span>]: x = np.arange(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: nb_add(x, x)</span><br><span class="line">Out[<span class="hljs-number">14</span>]: array([  <span class="hljs-number">0.</span>,   <span class="hljs-number">2.</span>,   <span class="hljs-number">4.</span>,   <span class="hljs-number">6.</span>,   <span class="hljs-number">8.</span>,  <span class="hljs-number">10.</span>,  <span class="hljs-number">12.</span>,  <span class="hljs-number">14.</span>,  <span class="hljs-number">16.</span>,  <span class="hljs-number">18.</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: nb_add.accumulate(x, <span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">15</span>]: array([  <span class="hljs-number">0.</span>,   <span class="hljs-number">1.</span>,   <span class="hljs-number">3.</span>,   <span class="hljs-number">6.</span>,  <span class="hljs-number">10.</span>,  <span class="hljs-number">15.</span>,  <span class="hljs-number">21.</span>,  <span class="hljs-number">28.</span>,  <span class="hljs-number">36.</span>,  <span class="hljs-number">45.</span>])</span><br></pre></td></tr></table></figure>

<h1 id="A-8-高级数组输入输出"><a href="#A-8-高级数组输入输出" class="headerlink" title="A.8 高级数组输入输出"></a>A.8 高级数组输入输出</h1><p>我在第4章中讲过，np.save和np.load可用于读写磁盘上以二进制格式存储的数组。其实还有一些工具可用于更为复杂的场景。尤其是内存映像（memory map），它使你能处理在内存中放不下的数据集。</p>
<h2 id="内存映像文件"><a href="#内存映像文件" class="headerlink" title="内存映像文件"></a>内存映像文件</h2><p>内存映像文件是一种将磁盘上的非常大的二进制数据文件当做内存中的数组进行处理的方式。NumPy实现了一个类似于ndarray的memmap对象，它允许将大文件分成小段进行读写，而不是一次性将整个数组读入内存。另外，memmap也拥有跟普通数组一样的方法，因此，基本上只要是能用于ndarray的算法就也能用于memmap。</p>
<p>要创建一个内存映像，可以使用函数np.memmap并传入一个文件路径、数据类型、形状以及文件模式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">214</span>]: mmap = np.memmap(<span class="hljs-string">'mymmap'</span>, dtype=<span class="hljs-string">'float64'</span>, mode=<span class="hljs-string">'w+'</span>,</span><br><span class="line">   .....:                  shape=(<span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">215</span>]: mmap</span><br><span class="line">Out[<span class="hljs-number">215</span>]: </span><br><span class="line">memmap([[ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, ...,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>],</span><br><span class="line">        [ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, ...,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>],</span><br><span class="line">        [ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, ...,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>],</span><br><span class="line">        ..., </span><br><span class="line">        [ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, ...,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>],</span><br><span class="line">        [ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, ...,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>],</span><br><span class="line">        [ <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>, ...,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>,  <span class="hljs-number">0.</span>]])</span><br></pre></td></tr></table></figure>

<p>对memmap切片将会返回磁盘上的数据的视图：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">216</span>]: section = mmap[:<span class="hljs-number">5</span>]</span><br></pre></td></tr></table></figure>

<p>如果将数据赋值给这些视图：数据会先被缓存在内存中（就像是Python的文件对象），调用flush即可将其写入磁盘：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">217</span>]: section[:] = np.random.randn(<span class="hljs-number">5</span>, <span class="hljs-number">10000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">218</span>]: mmap.flush()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">219</span>]: mmap</span><br><span class="line">Out[<span class="hljs-number">219</span>]: </span><br><span class="line">memmap([[ <span class="hljs-number">0.7584</span>, <span class="hljs-number">-0.6605</span>,  <span class="hljs-number">0.8626</span>, ...,  <span class="hljs-number">0.6046</span>, <span class="hljs-number">-0.6212</span>,  <span class="hljs-number">2.0542</span>],</span><br><span class="line">        [<span class="hljs-number">-1.2113</span>, <span class="hljs-number">-1.0375</span>,  <span class="hljs-number">0.7093</span>, ..., <span class="hljs-number">-1.4117</span>, <span class="hljs-number">-0.1719</span>, <span class="hljs-number">-0.8957</span>],</span><br><span class="line">        [<span class="hljs-number">-0.1419</span>, <span class="hljs-number">-0.3375</span>,  <span class="hljs-number">0.4329</span>, ...,  <span class="hljs-number">1.2914</span>, <span class="hljs-number">-0.752</span> , <span class="hljs-number">-0.44</span>  ],</span><br><span class="line">        ..., </span><br><span class="line">        [ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    , ...,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ],</span><br><span class="line">        [ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    , ...,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ],</span><br><span class="line">        [ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    , ...,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">220</span>]: <span class="hljs-keyword">del</span> mmap</span><br></pre></td></tr></table></figure>

<p>只要某个内存映像超出了作用域，它就会被垃圾回收器回收，之前对其所做的任何修改都会被写入磁盘。当打开一个已经存在的内存映像时，仍然需要指明数据类型和形状，因为磁盘上的那个文件只是一块二进制数据而已，没有任何元数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">221</span>]: mmap = np.memmap(<span class="hljs-string">'mymmap'</span>, dtype=<span class="hljs-string">'float64'</span>, shape=(<span class="hljs-number">10000</span>, <span class="hljs-number">10000</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">222</span>]: mmap</span><br><span class="line">Out[<span class="hljs-number">222</span>]: </span><br><span class="line">memmap([[ <span class="hljs-number">0.7584</span>, <span class="hljs-number">-0.6605</span>,  <span class="hljs-number">0.8626</span>, ...,  <span class="hljs-number">0.6046</span>, <span class="hljs-number">-0.6212</span>,  <span class="hljs-number">2.0542</span>],</span><br><span class="line">        [<span class="hljs-number">-1.2113</span>, <span class="hljs-number">-1.0375</span>,  <span class="hljs-number">0.7093</span>, ..., <span class="hljs-number">-1.4117</span>, <span class="hljs-number">-0.1719</span>, <span class="hljs-number">-0.8957</span>],</span><br><span class="line">        [<span class="hljs-number">-0.1419</span>, <span class="hljs-number">-0.3375</span>,  <span class="hljs-number">0.4329</span>, ...,  <span class="hljs-number">1.2914</span>, <span class="hljs-number">-0.752</span> , <span class="hljs-number">-0.44</span>  ],</span><br><span class="line">        ..., </span><br><span class="line">        [ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    , ...,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ],</span><br><span class="line">        [ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    , ...,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ],</span><br><span class="line">        [ <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    , ...,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ,  <span class="hljs-number">0.</span>    ]])</span><br></pre></td></tr></table></figure>

<p>内存映像可以使用前面介绍的结构化或嵌套dtype。</p>
<h2 id="HDF5及其他数组存储方式"><a href="#HDF5及其他数组存储方式" class="headerlink" title="HDF5及其他数组存储方式"></a>HDF5及其他数组存储方式</h2><p>PyTables和h5py这两个Python项目可以将NumPy的数组数据存储为高效且可压缩的HDF5格式（HDF意思是“层次化数据格式”）。你可以安全地将好几百GB甚至TB的数据存储为HDF5格式。要学习Python使用HDF5，请参考pandas线上文档。</p>
<h1 id="A-9-性能建议"><a href="#A-9-性能建议" class="headerlink" title="A.9 性能建议"></a>A.9 性能建议</h1><p>使用NumPy的代码的性能一般都很不错，因为数组运算一般都比纯Python循环快得多。下面大致列出了一些需要注意的事项：</p>
<ul>
<li>将Python循环和条件逻辑转换为数组运算和布尔数组运算。</li>
<li>尽量使用广播。</li>
<li>避免复制数据，尽量使用数组视图（即切片）。</li>
<li>利用ufunc及其各种方法。</li>
</ul>
<p>如果单用NumPy无论如何都达不到所需的性能指标，就可以考虑一下用C、Fortran或Cython（等下会稍微介绍一下）来编写代码。我自己在工作中经常会用到Cython（<a href="http://cython.org/" target="_blank" rel="noopener">http://cython.org</a>），因为它不用花费我太多精力就能得到C语言那样的性能。</p>
<h2 id="连续内存的重要性"><a href="#连续内存的重要性" class="headerlink" title="连续内存的重要性"></a>连续内存的重要性</h2><p>虽然这个话题有点超出本书的范围，但还是要提一下，因为在某些应用场景中，数组的内存布局可以对计算速度造成极大的影响。这是因为性能差别在一定程度上跟CPU的高速缓存（cache）体系有关。运算过程中访问连续内存块（例如，对以C顺序存储的数组的行求和）一般是最快的，因为内存子系统会将适当的内存块缓存到超高速的L1或L2CPU Cache中。此外，NumPy的C语言基础代码（某些）对连续存储的情况进行了优化处理，这样就能避免一些跨越式的内存访问。</p>
<p>一个数组的内存布局是连续的，就是说元素是以它们在数组中出现的顺序（即Fortran型（列优先）或C型（行优先））存储在内存中的。默认情况下，NumPy数组是以C型连续的方式创建的。列优先的数组（比如C型连续数组的转置）也被称为Fortran型连续。通过ndarray的flags属性即可查看这些信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">225</span>]: arr_c = np.ones((<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>), order=<span class="hljs-string">'C'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">226</span>]: arr_f = np.ones((<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>), order=<span class="hljs-string">'F'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">227</span>]: arr_c.flags</span><br><span class="line"></span><br><span class="line">Out[<span class="hljs-number">227</span>]: </span><br><span class="line">  C_CONTIGUOUS : <span class="hljs-literal">True</span></span><br><span class="line">  F_CONTIGUOUS : <span class="hljs-literal">False</span></span><br><span class="line">  OWNDATA : <span class="hljs-literal">True</span></span><br><span class="line">  WRITEABLE : <span class="hljs-literal">True</span></span><br><span class="line">  ALIGNED : <span class="hljs-literal">True</span></span><br><span class="line">  UPDATEIFCOPY : <span class="hljs-literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">228</span>]: arr_f.flags</span><br><span class="line">Out[<span class="hljs-number">228</span>]: </span><br><span class="line">  C_CONTIGUOUS : <span class="hljs-literal">False</span></span><br><span class="line">  F_CONTIGUOUS : <span class="hljs-literal">True</span></span><br><span class="line">  OWNDATA : <span class="hljs-literal">True</span></span><br><span class="line">  WRITEABLE : <span class="hljs-literal">True</span></span><br><span class="line">  ALIGNED : <span class="hljs-literal">True</span></span><br><span class="line">  UPDATEIFCOPY : <span class="hljs-literal">False</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">229</span>]: arr_f.flags.f_contiguous</span><br><span class="line">Out[<span class="hljs-number">229</span>]: <span class="hljs-literal">True</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，对两个数组的行进行求和计算，理论上说，arr_c会比arr_f快，因为arr_c的行在内存中是连续的。我们可以在IPython中用%timeit来确认一下：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">230</span>]: %timeit arr_c.sum(<span class="hljs-number">1</span>)</span><br><span class="line"><span class="hljs-number">784</span> us +- <span class="hljs-number">10.4</span> us per loop (mean +- std. dev. of <span class="hljs-number">7</span> runs, <span class="hljs-number">1000</span> loops each)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">231</span>]: %timeit arr_f.sum(<span class="hljs-number">1</span>)</span><br><span class="line"><span class="hljs-number">934</span> us +- <span class="hljs-number">29</span> us per loop (mean +- std. dev. of <span class="hljs-number">7</span> runs, <span class="hljs-number">1000</span> loops each)</span><br></pre></td></tr></table></figure>

<p>如果想从NumPy中提升性能，这里就应该是下手的地方。如果数组的内存顺序不符合你的要求，使用copy并传入’C’或’F’即可解决该问题：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">232</span>]: arr_f.copy(<span class="hljs-string">'C'</span>).flags</span><br><span class="line">Out[<span class="hljs-number">232</span>]: </span><br><span class="line">  C_CONTIGUOUS : <span class="hljs-literal">True</span></span><br><span class="line">  F_CONTIGUOUS : <span class="hljs-literal">False</span></span><br><span class="line">  OWNDATA : <span class="hljs-literal">True</span></span><br><span class="line">  WRITEABLE : <span class="hljs-literal">True</span></span><br><span class="line">  ALIGNED : <span class="hljs-literal">True</span></span><br><span class="line">  UPDATEIFCOPY : <span class="hljs-literal">False</span></span><br></pre></td></tr></table></figure>

<p>注意，在构造数组的视图时，其结果不一定是连续的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">233</span>]: arr_c[:<span class="hljs-number">50</span>].flags.contiguous</span><br><span class="line">Out[<span class="hljs-number">233</span>]: <span class="hljs-literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">234</span>]: arr_c[:, :<span class="hljs-number">50</span>].flags</span><br><span class="line">Out[<span class="hljs-number">234</span>]: </span><br><span class="line">  C_CONTIGUOUS : <span class="hljs-literal">False</span></span><br><span class="line">  F_CONTIGUOUS : <span class="hljs-literal">False</span></span><br><span class="line">  OWNDATA : <span class="hljs-literal">False</span></span><br><span class="line">  WRITEABLE : <span class="hljs-literal">True</span></span><br><span class="line">  ALIGNED : <span class="hljs-literal">True</span></span><br><span class="line">  UPDATEIFCOPY : <span class="hljs-literal">False</span></span><br></pre></td></tr></table></figure>
        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 8614 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%20%E9%99%84%E5%BD%95B%20%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8EIPython%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%88%E5%AE%8C%EF%BC%89/">《利用Python进行数据分析·第2版》 附录B 更多关于IPython的内容（完）</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
附录B 更多关于IPython的内容（完）</p>
<hr>
<p>第2章中，我们学习了IPython shell和Jupyter notebook的基础。本章中，我们会探索IPython更深层次的功能，可以从控制台或在jupyter使用。</p>
<h1 id="B-1-使用命令历史"><a href="#B-1-使用命令历史" class="headerlink" title="B.1 使用命令历史"></a>B.1 使用命令历史</h1><p>Ipython维护了一个位于磁盘的小型数据库，用于保存执行的每条指令。它的用途有：</p>
<ul>
<li>只用最少的输入，就能搜索、补全和执行先前运行过的指令；</li>
<li>在不同session间保存命令历史；</li>
<li>将日志输入/输出历史到一个文件</li>
</ul>
<p>这些功能在shell中，要比notebook更为有用，因为notebook从设计上是将输入和输出的代码放到每个代码格子中。</p>
<h2 id="搜索和重复使用命令历史"><a href="#搜索和重复使用命令历史" class="headerlink" title="搜索和重复使用命令历史"></a>搜索和重复使用命令历史</h2><p>Ipython可以让你搜索和执行之前的代码或其他命令。这个功能非常有用，因为你可能需要重复执行同样的命令，例如%run命令，或其它代码。假设你必须要执行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In[<span class="hljs-number">7</span>]: %run first/second/third/data_script.py</span><br></pre></td></tr></table></figure>

<p>运行成功，然后检查结果，发现计算有错。解决完问题，然后修改了data_script.py，你就可以输入一些%run命令，然后按Ctrl+P或上箭头。这样就可以搜索历史命令，匹配输入字符的命令。多次按Ctrl+P或上箭头，会继续搜索命令。如果你要执行你想要执行的命令，不要害怕。你可以按下Ctrl-N或下箭头，向前移动历史命令。这样做了几次后，你可以不假思索地按下这些键！</p>
<p>Ctrl-R可以带来如同Unix风格shell（比如bash shell）的readline的部分增量搜索功能。在Windows上，readline功能是被IPython模仿的。要使用这个功能，先按Ctrl-R，然后输入一些包含于输入行的想要搜索的字符：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">1</span>]: a_command = foo(x, y, z)</span><br><span class="line"></span><br><span class="line">(reverse-i-search)`com<span class="hljs-string">': a_command = foo(x, y, z)</span></span><br></pre></td></tr></table></figure>

<p>Ctrl-R会循环历史，找到匹配字符的每一行。</p>
<h2 id="输入和输出变量"><a href="#输入和输出变量" class="headerlink" title="输入和输出变量"></a>输入和输出变量</h2><p>忘记将函数调用的结果分配给变量是非常烦人的。IPython的一个session会在一个特殊变量，存储输入和输出Python对象的引用。前面两个输出会分别存储在 _（一个下划线）和 __（两个下划线）变量：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: <span class="hljs-number">2</span> ** <span class="hljs-number">27</span></span><br><span class="line">Out[<span class="hljs-number">24</span>]: <span class="hljs-number">134217728</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: _</span><br><span class="line">Out[<span class="hljs-number">25</span>]: <span class="hljs-number">134217728</span></span><br></pre></td></tr></table></figure>

<p>输入变量是存储在名字类似_iX的变量中，X是输入行的编号。对于每个输入变量，都有一个对应的输出变量_X。因此在输入第27行之后，会有两个新变量_27 （输出）和_i27（输入）:</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">26</span>]: foo = <span class="hljs-string">'bar'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: foo</span><br><span class="line">Out[<span class="hljs-number">27</span>]: <span class="hljs-string">'bar'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: _i27</span><br><span class="line">Out[<span class="hljs-number">28</span>]: <span class="hljs-string">u'foo'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">29</span>]: _27</span><br><span class="line">Out[<span class="hljs-number">29</span>]: <span class="hljs-string">'bar'</span></span><br></pre></td></tr></table></figure>

<p>因为输入变量是字符串，它们可以用Python的exec关键字再次执行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">30</span>]: exec(_i27)</span><br></pre></td></tr></table></figure>

<p>这里，_i27是在In [27]输入的代码。</p>
<p>有几个魔术函数可以让你利用输入和输出历史。%hist可以打印所有或部分的输入历史，加上或不加上编号。%reset可以清理交互命名空间，或输入和输出缓存。%xdel魔术函数可以去除IPython中对一个特别对象的所有引用。对于关于这些魔术方法的更多内容，请查看文档。</p>
<blockquote>
<p>警告：当处理非常大的数据集时，要记住IPython的输入和输出的历史会造成被引用的对象不被垃圾回收（释放内存），即使你使用del关键字从交互命名空间删除变量。在这种情况下，小心使用xdel %和%reset可以帮助你避免陷入内存问题。</p>
</blockquote>
<h1 id="B-2-与操作系统交互"><a href="#B-2-与操作系统交互" class="headerlink" title="B.2 与操作系统交互"></a>B.2 与操作系统交互</h1><p>IPython的另一个功能是无缝连接文件系统和操作系统。这意味着，在同时做其它事时，无需退出IPython，就可以像Windows或Unix使用命令行操作，包括shell命令、更改目录、用Python对象（列表或字符串）存储结果。它还有简单的命令别名和目录书签功能。</p>
<p>表B-1总结了调用shell命令的魔术函数和语法。我会在下面几节介绍这些功能。</p>
<p><img src="/images/blog/7178691-4da7ee14be2da211-1576024711936.webp" alt="img"></p>
<p>表B-1 IPython系统相关命令</p>
<h2 id="Shell命令和别名"><a href="#Shell命令和别名" class="headerlink" title="Shell命令和别名"></a>Shell命令和别名</h2><p>用叹号开始一行，是告诉IPython执行叹号后面的所有内容。这意味着你可以删除文件（取决于操作系统，用rm或del）、改变目录或执行任何其他命令。</p>
<p>通过给变量加上叹号，你可以在一个变量中存储命令的控制台输出。例如，在我联网的基于Linux的主机上，我可以获得IP地址为Python变量：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">1</span>]: ip_info = !ifconfig wlan0 | grep <span class="hljs-string">"inet "</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">2</span>]: ip_info[<span class="hljs-number">0</span>].strip()</span><br><span class="line">Out[<span class="hljs-number">2</span>]: <span class="hljs-string">'inet addr:10.0.0.11  Bcast:10.0.0.255  Mask:255.255.255.0'</span></span><br></pre></td></tr></table></figure>

<p>返回的Python对象ip_info实际上是一个自定义的列表类型，它包含着多种版本的控制台输出。</p>
<p>当使用！，IPython还可以替换定义在当前环境的Python值。要这么做，可以在变量名前面加上$符号：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">3</span>]: foo = <span class="hljs-string">'test*'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">4</span>]: !ls $foo</span><br><span class="line">test4.py  test.py  test.xml</span><br></pre></td></tr></table></figure>

<p>%alias魔术函数可以自定义shell命令的快捷方式。看一个简单的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">1</span>]: %alias ll ls -l</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">2</span>]: ll /usr</span><br><span class="line">total <span class="hljs-number">332</span></span><br><span class="line">drwxr-xr-x   <span class="hljs-number">2</span> root root  <span class="hljs-number">69632</span> <span class="hljs-number">2012</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span> <span class="hljs-number">20</span>:<span class="hljs-number">36</span> bin/</span><br><span class="line">drwxr-xr-x   <span class="hljs-number">2</span> root root   <span class="hljs-number">4096</span> <span class="hljs-number">2010</span><span class="hljs-number">-08</span><span class="hljs-number">-23</span> <span class="hljs-number">12</span>:<span class="hljs-number">05</span> games/</span><br><span class="line">drwxr-xr-x <span class="hljs-number">123</span> root root  <span class="hljs-number">20480</span> <span class="hljs-number">2011</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">18</span>:<span class="hljs-number">08</span> include/</span><br><span class="line">drwxr-xr-x <span class="hljs-number">265</span> root root <span class="hljs-number">126976</span> <span class="hljs-number">2012</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span> <span class="hljs-number">20</span>:<span class="hljs-number">36</span> lib/</span><br><span class="line">drwxr-xr-x  <span class="hljs-number">44</span> root root  <span class="hljs-number">69632</span> <span class="hljs-number">2011</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span> <span class="hljs-number">18</span>:<span class="hljs-number">08</span> lib32/</span><br><span class="line">lrwxrwxrwx   1 root root      3 2010-08-23 16:02 lib64 -&gt; lib/</span><br><span class="line">drwxr-xr-x  <span class="hljs-number">15</span> root root   <span class="hljs-number">4096</span> <span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-13</span> <span class="hljs-number">19</span>:<span class="hljs-number">03</span> local/</span><br><span class="line">drwxr-xr-x   <span class="hljs-number">2</span> root root  <span class="hljs-number">12288</span> <span class="hljs-number">2012</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">32</span> sbin/</span><br><span class="line">drwxr-xr-x <span class="hljs-number">387</span> root root  <span class="hljs-number">12288</span> <span class="hljs-number">2011</span><span class="hljs-number">-11</span><span class="hljs-number">-04</span> <span class="hljs-number">22</span>:<span class="hljs-number">53</span> share/</span><br><span class="line">drwxrwsr-x  <span class="hljs-number">24</span> root src    <span class="hljs-number">4096</span> <span class="hljs-number">2011</span><span class="hljs-number">-07</span><span class="hljs-number">-17</span> <span class="hljs-number">18</span>:<span class="hljs-number">38</span> src/</span><br></pre></td></tr></table></figure>

<p>你可以执行多个命令，就像在命令行中一样，只需用分号隔开：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">558</span>]: %alias test_alias (cd examples; ls; cd ..)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">559</span>]: test_alias</span><br><span class="line">macrodata.csv  spx.csv  tips.csv</span><br></pre></td></tr></table></figure>

<p>当session结束，你定义的别名就会失效。要创建恒久的别名，需要使用配置。</p>
<h2 id="目录书签系统"><a href="#目录书签系统" class="headerlink" title="目录书签系统"></a>目录书签系统</h2><p>IPython有一个简单的目录书签系统，可以让你保存常用目录的别名，这样在跳来跳去的时候会非常方便。例如，假设你想创建一个书签，指向本书的补充内容：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">6</span>]: %bookmark py4da /home/wesm/code/pydata-book</span><br></pre></td></tr></table></figure>

<p>这么做之后，当使用%cd魔术命令，就可以使用定义的书签：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">7</span>]: cd py4da</span><br><span class="line">(bookmark:py4da) -&gt; /home/wesm/code/pydata-book</span><br><span class="line">/home/wesm/code/pydata-book</span><br></pre></td></tr></table></figure>

<p>如果书签的名字，与当前工作目录的一个目录重名，你可以使用-b标志来覆写，使用书签的位置。使用%bookmark的-l选项，可以列出所有的书签：</p>
<figure class="highlight hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">8</span>]: %bookmark -l</span><br><span class="line">Current bookmarks:</span><br><span class="line">py4da -&gt; /home/wesm/code/pydata-book-source</span><br></pre></td></tr></table></figure>

<p>书签，和别名不同，在session之间是保持的。</p>
<h1 id="B-3-软件开发工具"><a href="#B-3-软件开发工具" class="headerlink" title="B.3 软件开发工具"></a>B.3 软件开发工具</h1><p>除了作为优秀的交互式计算和数据探索环境，IPython也是有效的Python软件开发工具。在数据分析中，最重要的是要有正确的代码。幸运的是，IPython紧密集成了和加强了Python内置的pdb调试器。第二，需要快速的代码。对于这点，IPython有易于使用的代码计时和分析工具。我会详细介绍这些工具。</p>
<h2 id="交互调试器"><a href="#交互调试器" class="headerlink" title="交互调试器"></a>交互调试器</h2><p>IPython的调试器用tab补全、语法增强、逐行异常追踪增强了pdb。调试代码的最佳时间就是刚刚发生错误。异常发生之后就输入%debug，就启动了调试器，进入抛出异常的堆栈框架：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">2</span>]: run examples/ipython_bug.py</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">AssertionError                            Traceback (most recent call last)</span><br><span class="line">/home/wesm/code/pydata-book/examples/ipython_bug.py <span class="hljs-keyword">in</span> &lt;module&gt;()</span><br><span class="line">     <span class="hljs-number">13</span>     throws_an_exception()</span><br><span class="line">     <span class="hljs-number">14</span></span><br><span class="line">---&gt; 15 calling_things()</span><br><span class="line"></span><br><span class="line">/home/wesm/code/pydata-book/examples/ipython_bug.py <span class="hljs-keyword">in</span> calling_things()</span><br><span class="line"><span class="hljs-number">11</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calling_things</span><span class="hljs-params">()</span>:</span></span><br><span class="line">     <span class="hljs-number">12</span>     works_fine()</span><br><span class="line">---&gt; 13     throws_an_exception()</span><br><span class="line">     <span class="hljs-number">14</span></span><br><span class="line">     <span class="hljs-number">15</span> calling_things()</span><br><span class="line"></span><br><span class="line">/home/wesm/code/pydata-book/examples/ipython_bug.py <span class="hljs-keyword">in</span> throws_an_exception()</span><br><span class="line">      <span class="hljs-number">7</span>     a = <span class="hljs-number">5</span></span><br><span class="line">      <span class="hljs-number">8</span>     b = <span class="hljs-number">6</span></span><br><span class="line">----&gt; 9     assert(a + b == 10)</span><br><span class="line">     <span class="hljs-number">10</span></span><br><span class="line">     <span class="hljs-number">11</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calling_things</span><span class="hljs-params">()</span>:</span></span><br><span class="line"></span><br><span class="line">AssertionError:</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">3</span>]: %debug</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">9</span>)throws_an_exception()</span><br><span class="line">      <span class="hljs-number">8</span>     b = <span class="hljs-number">6</span></span><br><span class="line">----&gt; 9     assert(a + b == 10)</span><br><span class="line">     <span class="hljs-number">10</span></span><br><span class="line"></span><br><span class="line">ipdb&gt;</span><br></pre></td></tr></table></figure>

<p>一旦进入调试器，你就可以执行任意的Python代码，在每个堆栈框架中检查所有的对象和数据（解释器会保持它们活跃）。默认是从错误发生的最低级开始。通过u（up）和d（down），你可以在不同等级的堆栈踪迹切换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipdb&gt; u</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">13</span>)calling_things()</span><br><span class="line">     <span class="hljs-number">12</span>     works_fine()</span><br><span class="line">---&gt; 13     throws_an_exception()</span><br><span class="line">     <span class="hljs-number">14</span></span><br></pre></td></tr></table></figure>

<p>执行%pdb命令，可以在发生任何异常时让IPython自动启动调试器，许多用户会发现这个功能非常好用。</p>
<p>用调试器帮助开发代码也很容易，特别是当你希望设置断点或在函数和脚本间移动，以检查每个阶段的状态。有多种方法可以实现。第一种是使用%run和-d，它会在执行传入脚本的任何代码之前调用调试器。你必须马上按s（step）以进入脚本：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">5</span>]: run -d examples/ipython_bug.py</span><br><span class="line">Breakpoint <span class="hljs-number">1</span> at /home/wesm/code/pydata-book/examples/ipython_bug.py:<span class="hljs-number">1</span></span><br><span class="line">NOTE: Enter <span class="hljs-string">'c'</span> at the ipdb&gt;  prompt to start your script.</span><br><span class="line">&gt; &lt;string&gt;(<span class="hljs-number">1</span>)&lt;module&gt;()</span><br><span class="line"></span><br><span class="line">ipdb&gt; s</span><br><span class="line">--Call--</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">1</span>)&lt;module&gt;()</span><br><span class="line">1---&gt; 1 def works_fine():</span><br><span class="line">      <span class="hljs-number">2</span>     a = <span class="hljs-number">5</span></span><br><span class="line">      <span class="hljs-number">3</span>     b = <span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<p>然后，你就可以决定如何工作。例如，在前面的异常，我们可以设置一个断点，就在调用works_fine之前，然后运行脚本，在遇到断点时按c（continue）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ipdb&gt; b <span class="hljs-number">12</span></span><br><span class="line">ipdb&gt; c</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">12</span>)calling_things()</span><br><span class="line">     <span class="hljs-number">11</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">calling_things</span><span class="hljs-params">()</span>:</span></span><br><span class="line">2--&gt; 12     works_fine()</span><br><span class="line">     <span class="hljs-number">13</span>     throws_an_exception()</span><br></pre></td></tr></table></figure>

<p>这时，你可以step进入works_fine()，或通过按n（next）执行works_fine()，进入下一行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipdb&gt; n</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">13</span>)calling_things()</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">12</span>     works_fine()</span><br><span class="line">---&gt; 13     throws_an_exception()</span><br><span class="line">     <span class="hljs-number">14</span></span><br></pre></td></tr></table></figure>

<p>然后，我们可以进入throws_an_exception，到达发生错误的一行，查看变量。注意，调试器的命令是在变量名之前，在变量名前面加叹号！可以查看内容：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">ipdb&gt; s</span><br><span class="line">--Call--</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">6</span>)throws_an_exception()</span><br><span class="line">      <span class="hljs-number">5</span></span><br><span class="line">----&gt; 6 def throws_an_exception():</span><br><span class="line">      <span class="hljs-number">7</span>     a = <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">ipdb&gt; n</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">7</span>)throws_an_exception()</span><br><span class="line">      <span class="hljs-number">6</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">throws_an_exception</span><span class="hljs-params">()</span>:</span></span><br><span class="line">----&gt; 7     a = 5</span><br><span class="line">      <span class="hljs-number">8</span>     b = <span class="hljs-number">6</span></span><br><span class="line"></span><br><span class="line">ipdb&gt; n</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">8</span>)throws_an_exception()</span><br><span class="line">      <span class="hljs-number">7</span>     a = <span class="hljs-number">5</span></span><br><span class="line">----&gt; 8     b = 6</span><br><span class="line">      <span class="hljs-number">9</span>     <span class="hljs-keyword">assert</span>(a + b == <span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">ipdb&gt; n</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">9</span>)throws_an_exception()</span><br><span class="line">      <span class="hljs-number">8</span>     b = <span class="hljs-number">6</span></span><br><span class="line">----&gt; 9     assert(a + b == 10)</span><br><span class="line">     <span class="hljs-number">10</span></span><br><span class="line"></span><br><span class="line">ipdb&gt; !a</span><br><span class="line"><span class="hljs-number">5</span></span><br><span class="line">ipdb&gt; !b</span><br><span class="line"><span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<p>提高使用交互式调试器的熟练度需要练习和经验。表B-2，列出了所有调试器命令。如果你习惯了IDE，你可能觉得终端的调试器在一开始会不顺手，但会觉得越来越好用。一些Python的IDEs有很好的GUI调试器，选择顺手的就好。</p>
<p><img src="/images/blog/7178691-90a4b17e20b5b03a-1576024711942.webp" alt="img"></p>
<p>表B-2 IPython调试器命令</p>
<h2 id="使用调试器的其它方式"><a href="#使用调试器的其它方式" class="headerlink" title="使用调试器的其它方式"></a>使用调试器的其它方式</h2><p>还有一些其它工作可以用到调试器。第一个是使用特殊的set_trace函数（根据pdb.set_trace命名的），这是一个简装的断点。还有两种方法是你可能想用的（像我一样，将其添加到IPython的配置）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> IPython.core.debugger <span class="hljs-keyword">import</span> Pdb</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">set_trace</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    Pdb(color_scheme=<span class="hljs-string">'Linux'</span>).set_trace(sys._getframe().f_back)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">debug</span><span class="hljs-params">(f, *args, **kwargs)</span>:</span></span><br><span class="line">    pdb = Pdb(color_scheme=<span class="hljs-string">'Linux'</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> pdb.runcall(f, *args, **kwargs)</span><br></pre></td></tr></table></figure>

<p>第一个函数set_trace非常简单。如果你想暂时停下来进行仔细检查（比如发生异常之前），可以在代码的任何位置使用set_trace：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">7</span>]: run examples/ipython_bug.py</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">16</span>)calling_things()</span><br><span class="line">     <span class="hljs-number">15</span>     set_trace()</span><br><span class="line">---&gt; 16     throws_an_exception()</span><br><span class="line">     <span class="hljs-number">17</span></span><br></pre></td></tr></table></figure>

<p>按c（continue）可以让代码继续正常行进。</p>
<p>我们刚看的debug函数，可以让你方便的在调用任何函数时使用调试器。假设我们写了一个下面的函数，想逐步分析它的逻辑：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span><span class="hljs-params">(x, y, z=<span class="hljs-number">1</span>)</span>:</span></span><br><span class="line">    tmp = x + y</span><br><span class="line">    <span class="hljs-keyword">return</span> tmp / z</span><br></pre></td></tr></table></figure>

<p>普通地使用f，就会像f(1, 2, z=3)。而要想进入f，将f作为第一个参数传递给debug，再将位置和关键词参数传递给f：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">6</span>]: debug(f, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, z=<span class="hljs-number">3</span>)</span><br><span class="line">&gt; &lt;ipython-input&gt;(<span class="hljs-number">2</span>)f()</span><br><span class="line">      <span class="hljs-number">1</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span><span class="hljs-params">(x, y, z)</span>:</span></span><br><span class="line">----&gt; 2     tmp = x + y</span><br><span class="line">      <span class="hljs-number">3</span>     <span class="hljs-keyword">return</span> tmp / z</span><br><span class="line"></span><br><span class="line">ipdb&gt;</span><br></pre></td></tr></table></figure>

<p>这两个简单方法节省了我平时的大量时间。</p>
<p>最后，调试器可以和%run一起使用。脚本通过运行%run -d，就可以直接进入调试器，随意设置断点并启动脚本：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">1</span>]: %run -d examples/ipython_bug.py</span><br><span class="line">Breakpoint <span class="hljs-number">1</span> at /home/wesm/code/pydata-book/examples/ipython_bug.py:<span class="hljs-number">1</span></span><br><span class="line">NOTE: Enter <span class="hljs-string">'c'</span> at the ipdb&gt;  prompt to start your script.</span><br><span class="line">&gt; &lt;string&gt;(<span class="hljs-number">1</span>)&lt;module&gt;()</span><br><span class="line"></span><br><span class="line">ipdb&gt;</span><br></pre></td></tr></table></figure>

<p>加上-b和行号，可以预设一个断点：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">2</span>]: %run -d -b2 examples/ipython_bug.py</span><br><span class="line"></span><br><span class="line">Breakpoint <span class="hljs-number">1</span> at /home/wesm/code/pydata-book/examples/ipython_bug.py:<span class="hljs-number">2</span></span><br><span class="line">NOTE: Enter <span class="hljs-string">'c'</span> at the ipdb&gt;  prompt to start your script.</span><br><span class="line">&gt; &lt;string&gt;(<span class="hljs-number">1</span>)&lt;module&gt;()</span><br><span class="line"></span><br><span class="line">ipdb&gt; c</span><br><span class="line">&gt; /home/wesm/code/pydata-book/examples/ipython_bug.py(<span class="hljs-number">2</span>)works_fine()</span><br><span class="line">      <span class="hljs-number">1</span> <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">works_fine</span><span class="hljs-params">()</span>:</span></span><br><span class="line">1---&gt; 2     a = 5</span><br><span class="line">      <span class="hljs-number">3</span>     b = <span class="hljs-number">6</span></span><br><span class="line"></span><br><span class="line">ipdb&gt;</span><br></pre></td></tr></table></figure>

<h2 id="代码计时：-time-和-timeit"><a href="#代码计时：-time-和-timeit" class="headerlink" title="代码计时：%time 和 %timeit"></a>代码计时：%time 和 %timeit</h2><p>对于大型和长时间运行的数据分析应用，你可能希望测量不同组件或单独函数调用语句的执行时间。你可能想知道哪个函数占用的时间最长。幸运的是，IPython可以让你开发和测试代码时，很容易地获得这些信息。</p>
<p>手动用time模块和它的函数time.clock和time.time给代码计时，既单调又重复，因为必须要写一些无趣的模板化代码：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> time</span><br><span class="line">start = time.time()</span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(iterations):</span><br><span class="line">    <span class="hljs-comment"># some code to run here</span></span><br><span class="line">elapsed_per = (time.time() - start) / iterations</span><br></pre></td></tr></table></figure>

<p>因为这是一个很普通的操作，IPython有两个魔术函数，%time和%timeit，可以自动化这个过程。</p>
<p>%time会运行一次语句，报告总共的执行时间。假设我们有一个大的字符串列表，我们想比较不同的可以挑选出特定开头字符串的方法。这里有一个含有600000字符串的列表，和两个方法，用以选出foo开头的字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># a very large list of strings</span></span><br><span class="line">strings = [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'foobar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'qux'</span>,</span><br><span class="line">           <span class="hljs-string">'python'</span>, <span class="hljs-string">'Guido Van Rossum'</span>] * <span class="hljs-number">100000</span></span><br><span class="line"></span><br><span class="line">method1 = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> strings <span class="hljs-keyword">if</span> x.startswith(<span class="hljs-string">'foo'</span>)]</span><br><span class="line"></span><br><span class="line">method2 = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> strings <span class="hljs-keyword">if</span> x[:<span class="hljs-number">3</span>] == <span class="hljs-string">'foo'</span>]</span><br></pre></td></tr></table></figure>

<p>看起来它们的性能应该是同级别的，但事实呢？用%time进行一下测量：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">561</span>]: %time method1 = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> strings <span class="hljs-keyword">if</span> x.startswith(<span class="hljs-string">'foo'</span>)]</span><br><span class="line">CPU times: user <span class="hljs-number">0.19</span> s, sys: <span class="hljs-number">0.00</span> s, total: <span class="hljs-number">0.19</span> s</span><br><span class="line">Wall time: <span class="hljs-number">0.19</span> s</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">562</span>]: %time method2 = [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> strings <span class="hljs-keyword">if</span> x[:<span class="hljs-number">3</span>] == <span class="hljs-string">'foo'</span>]</span><br><span class="line">CPU times: user <span class="hljs-number">0.09</span> s, sys: <span class="hljs-number">0.00</span> s, total: <span class="hljs-number">0.09</span> s</span><br><span class="line">Wall time: <span class="hljs-number">0.09</span> s</span><br></pre></td></tr></table></figure>

<p>Wall time（wall-clock time的简写）是主要关注的。第一个方法是第二个方法的两倍多，但是这种测量方法并不准确。如果用%time多次测量，你就会发现结果是变化的。要想更准确，可以使用%timeit魔术函数。给出任意一条语句，它能多次运行这条语句以得到一个更为准确的时间：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">563</span>]: %timeit [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> strings <span class="hljs-keyword">if</span> x.startswith(<span class="hljs-string">'foo'</span>)]</span><br><span class="line"><span class="hljs-number">10</span> loops, best of <span class="hljs-number">3</span>: <span class="hljs-number">159</span> ms per loop</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">564</span>]: %timeit [x <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> strings <span class="hljs-keyword">if</span> x[:<span class="hljs-number">3</span>] == <span class="hljs-string">'foo'</span>]</span><br><span class="line"><span class="hljs-number">10</span> loops, best of <span class="hljs-number">3</span>: <span class="hljs-number">59.3</span> ms per loop</span><br></pre></td></tr></table></figure>

<p>这个例子说明了解Python标准库、NumPy、pandas和其它库的性能是很有价值的。在大型数据分析中，这些毫秒的时间就会累积起来！</p>
<p>%timeit特别适合分析执行时间短的语句和函数，即使是微秒或纳秒。这些时间可能看起来毫不重要，但是一个20微秒的函数执行1百万次就比一个5微秒的函数长15秒。在上一个例子中，我们可以直接比较两个字符串操作，以了解它们的性能特点：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">565</span>]: x = <span class="hljs-string">'foobar'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">566</span>]: y = <span class="hljs-string">'foo'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">567</span>]: %timeit x.startswith(y)</span><br><span class="line"><span class="hljs-number">1000000</span> loops, best of <span class="hljs-number">3</span>: <span class="hljs-number">267</span> ns per loop</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">568</span>]: %timeit x[:<span class="hljs-number">3</span>] == y</span><br><span class="line"><span class="hljs-number">10000000</span> loops, best of <span class="hljs-number">3</span>: <span class="hljs-number">147</span> ns per loop</span><br></pre></td></tr></table></figure>

<h2 id="基础分析：-prun和-run-p"><a href="#基础分析：-prun和-run-p" class="headerlink" title="基础分析：%prun和%run -p"></a>基础分析：%prun和%run -p</h2><p>分析代码与代码计时关系很紧密，除了它关注的是“时间花在了哪里”。Python主要的分析工具是cProfile模块，它并不局限于IPython。cProfile会执行一个程序或任意的代码块，并会跟踪每个函数执行的时间。</p>
<p>使用cProfile的通常方式是在命令行中运行一整段程序，输出每个函数的累积时间。假设我们有一个简单的在循环中进行线型代数运算的脚本（计算一系列的100×100矩阵的最大绝对特征值）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"><span class="hljs-keyword">from</span> numpy.linalg <span class="hljs-keyword">import</span> eigvals</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">run_experiment</span><span class="hljs-params">(niter=<span class="hljs-number">100</span>)</span>:</span></span><br><span class="line">    K = <span class="hljs-number">100</span></span><br><span class="line">    results = []</span><br><span class="line">    <span class="hljs-keyword">for</span> _ <span class="hljs-keyword">in</span> xrange(niter):</span><br><span class="line">        mat = np.random.randn(K, K)</span><br><span class="line">        max_eigenvalue = np.abs(eigvals(mat)).max()</span><br><span class="line">        results.append(max_eigenvalue)</span><br><span class="line">    <span class="hljs-keyword">return</span> results</span><br><span class="line">some_results = run_experiment()</span><br><span class="line"><span class="hljs-keyword">print</span> <span class="hljs-string">'Largest one we saw: %s'</span> % np.max(some_results)</span><br></pre></td></tr></table></figure>

<p>你可以用cProfile运行这个脚本，使用下面的命令行：</p>
<figure class="highlight css hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-selector-tag">python</span> <span class="hljs-selector-tag">-m</span> <span class="hljs-selector-tag">cProfile</span> <span class="hljs-selector-tag">cprof_example</span><span class="hljs-selector-class">.py</span></span><br></pre></td></tr></table></figure>

<p>运行之后，你会发现输出是按函数名排序的。这样要看出谁耗费的时间多有点困难，最好用-s指定排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">$ python -m cProfile -s cumulative cprof_example.py</span><br><span class="line">Largest one we saw: <span class="hljs-number">11.923204422</span></span><br><span class="line">    <span class="hljs-number">15116</span> function calls (<span class="hljs-number">14927</span> primitive calls) <span class="hljs-keyword">in</span> <span class="hljs-number">0.720</span> seconds</span><br><span class="line"></span><br><span class="line">Ordered by: cumulative time</span><br><span class="line"></span><br><span class="line">ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.721</span>    <span class="hljs-number">0.721</span> cprof_example.py:<span class="hljs-number">1</span>(&lt;module&gt;)</span><br><span class="line">   <span class="hljs-number">100</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.586</span>    <span class="hljs-number">0.006</span> linalg.py:<span class="hljs-number">702</span>(eigvals)</span><br><span class="line">   <span class="hljs-number">200</span>    <span class="hljs-number">0.572</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.572</span>    <span class="hljs-number">0.003</span> &#123;numpy.linalg.lapack_lite.dgeev&#125;</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.002</span>    <span class="hljs-number">0.002</span>    <span class="hljs-number">0.075</span>    <span class="hljs-number">0.075</span> __init__.py:<span class="hljs-number">106</span>(&lt;module&gt;)</span><br><span class="line">   <span class="hljs-number">100</span>    <span class="hljs-number">0.059</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.059</span>    <span class="hljs-number">0.001</span> &#123;method <span class="hljs-string">'randn'</span>)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.044</span>    <span class="hljs-number">0.044</span> add_newdocs.py:<span class="hljs-number">9</span>(&lt;module&gt;)</span><br><span class="line">     <span class="hljs-number">2</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.037</span>    <span class="hljs-number">0.019</span> __init__.py:<span class="hljs-number">1</span>(&lt;module&gt;)</span><br><span class="line">     <span class="hljs-number">2</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.002</span>    <span class="hljs-number">0.030</span>    <span class="hljs-number">0.015</span> __init__.py:<span class="hljs-number">2</span>(&lt;module&gt;)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.030</span>    <span class="hljs-number">0.030</span> type_check.py:<span class="hljs-number">3</span>(&lt;module&gt;)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.021</span>    <span class="hljs-number">0.021</span> __init__.py:<span class="hljs-number">15</span>(&lt;module&gt;)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.013</span>    <span class="hljs-number">0.013</span>    <span class="hljs-number">0.013</span>    <span class="hljs-number">0.013</span> numeric.py:<span class="hljs-number">1</span>(&lt;module&gt;)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.009</span>    <span class="hljs-number">0.009</span> __init__.py:<span class="hljs-number">6</span>(&lt;module&gt;)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.008</span>    <span class="hljs-number">0.008</span> __init__.py:<span class="hljs-number">45</span>(&lt;module&gt;)</span><br><span class="line">   <span class="hljs-number">262</span>    <span class="hljs-number">0.005</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.007</span>    <span class="hljs-number">0.000</span> function_base.py:<span class="hljs-number">3178</span>(add_newdoc)</span><br><span class="line">   <span class="hljs-number">100</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.005</span>    <span class="hljs-number">0.000</span> linalg.py:<span class="hljs-number">162</span>(_assertFinite)</span><br></pre></td></tr></table></figure>

<p>只显示出前15行。扫描cumtime列，可以容易地看出每个函数用了多少时间。如果一个函数调用了其它函数，计时并不会停止。cProfile会记录每个函数的起始和结束时间，使用它们进行计时。</p>
<p>除了在命令行中使用，cProfile也可以在程序中使用，分析任意代码块，而不必运行新进程。Ipython的%prun和%run -p，有便捷的接口实现这个功能。%prun使用类似cProfile的命令行选项，但是可以分析任意Python语句，而不用整个py文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">4</span>]: %prun -l <span class="hljs-number">7</span> -s cumulative run_experiment()</span><br><span class="line">         <span class="hljs-number">4203</span> function calls <span class="hljs-keyword">in</span> <span class="hljs-number">0.643</span> seconds</span><br><span class="line"></span><br><span class="line">Ordered by: cumulative time</span><br><span class="line">List reduced <span class="hljs-keyword">from</span> <span class="hljs-number">32</span> to <span class="hljs-number">7</span> due to restriction &lt;<span class="hljs-number">7</span>&gt;</span><br><span class="line">ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.643</span>    <span class="hljs-number">0.643</span> &lt;string&gt;:<span class="hljs-number">1</span>(&lt;module&gt;)</span><br><span class="line">     <span class="hljs-number">1</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.643</span>    <span class="hljs-number">0.643</span> cprof_example.py:<span class="hljs-number">4</span>(run_experiment)</span><br><span class="line">   <span class="hljs-number">100</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.583</span>    <span class="hljs-number">0.006</span> linalg.py:<span class="hljs-number">702</span>(eigvals)</span><br><span class="line">   <span class="hljs-number">200</span>    <span class="hljs-number">0.569</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.569</span>    <span class="hljs-number">0.003</span> &#123;numpy.linalg.lapack_lite.dgeev&#125;</span><br><span class="line">   <span class="hljs-number">100</span>    <span class="hljs-number">0.058</span>    <span class="hljs-number">0.001</span>    <span class="hljs-number">0.058</span>    <span class="hljs-number">0.001</span> &#123;method <span class="hljs-string">'randn'</span>&#125;</span><br><span class="line">   <span class="hljs-number">100</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.005</span>    <span class="hljs-number">0.000</span> linalg.py:<span class="hljs-number">162</span>(_assertFinite)</span><br><span class="line">   <span class="hljs-number">200</span>    <span class="hljs-number">0.002</span>    <span class="hljs-number">0.000</span>    <span class="hljs-number">0.002</span>    <span class="hljs-number">0.000</span> &#123;method <span class="hljs-string">'all'</span> of <span class="hljs-string">'numpy.ndarray'</span>&#125;</span><br></pre></td></tr></table></figure>

<p>相似的，调用<code>%run -p -s cumulative cprof_example.py</code>有和命令行相似的作用，只是你不用离开Ipython。</p>
<p>在Jupyter notebook中，你可以使用%%prun魔术方法（两个%）来分析一整段代码。这会弹出一个带有分析输出的独立窗口。便于快速回答一些问题，比如“为什么这段代码用了这么长时间”？</p>
<p>使用IPython或Jupyter，还有一些其它工具可以让分析工作更便于理解。其中之一是SnakeViz（<a href="https://github.com/jiffyclub/snakeviz/），它会使用d3.js产生一个分析结果的交互可视化界面。" target="_blank" rel="noopener">https://github.com/jiffyclub/snakeviz/），它会使用d3.js产生一个分析结果的交互可视化界面。</a></p>
<h2 id="逐行分析函数"><a href="#逐行分析函数" class="headerlink" title="逐行分析函数"></a>逐行分析函数</h2><p>有些情况下，用%prun（或其它基于cProfile的分析方法）得到的信息，不能获得函数执行时间的整个过程，或者结果过于复杂，加上函数名，很难进行解读。对于这种情况，有一个小库叫做line_profiler（可以通过PyPI或包管理工具获得）。它包含IPython插件，可以启用一个新的魔术函数%lprun，可以对一个函数或多个函数进行逐行分析。你可以通过修改IPython配置（查看IPython文档或本章后面的配置小节）加入下面这行，启用这个插件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># A list of dotted module names of IPython extensions to load.</span></span><br><span class="line">c.TerminalIPythonApp.extensions = [<span class="hljs-string">'line_profiler'</span>]</span><br></pre></td></tr></table></figure>

<p>你还可以运行命令：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%load_ext line_profiler</span><br></pre></td></tr></table></figure>

<p>line_profiler也可以在程序中使用（查看完整文档），但是在IPython中使用是最为强大的。假设你有一个带有下面代码的模块prof_mod，做一些NumPy数组操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> numpy.random <span class="hljs-keyword">import</span> randn</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_and_sum</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">    added = x + y</span><br><span class="line">    summed = added.sum(axis=<span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> summed</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call_function</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    x = randn(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>)</span><br><span class="line">    y = randn(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> add_and_sum(x, y)</span><br></pre></td></tr></table></figure>

<p>如果想了解add_and_sum函数的性能，%prun可以给出下面内容：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">569</span>]: %run prof_mod</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">570</span>]: x = randn(<span class="hljs-number">3000</span>, <span class="hljs-number">3000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">571</span>]: y = randn(<span class="hljs-number">3000</span>, <span class="hljs-number">3000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">572</span>]: %prun add_and_sum(x, y)</span><br><span class="line">         <span class="hljs-number">4</span> function calls <span class="hljs-keyword">in</span> <span class="hljs-number">0.049</span> seconds</span><br><span class="line">   Ordered by: internal time</span><br><span class="line">   ncalls  tottime  percall  cumtime  percall filename:lineno(function)</span><br><span class="line">        <span class="hljs-number">1</span>    <span class="hljs-number">0.036</span>    <span class="hljs-number">0.036</span>    <span class="hljs-number">0.046</span>    <span class="hljs-number">0.046</span> prof_mod.py:<span class="hljs-number">3</span>(add_and_sum)</span><br><span class="line">        <span class="hljs-number">1</span>    <span class="hljs-number">0.009</span>    <span class="hljs-number">0.009</span>    <span class="hljs-number">0.009</span>    <span class="hljs-number">0.009</span> &#123;method <span class="hljs-string">'sum'</span> of <span class="hljs-string">'numpy.ndarray'</span>&#125;</span><br><span class="line">        <span class="hljs-number">1</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.003</span>    <span class="hljs-number">0.049</span>    <span class="hljs-number">0.049</span> &lt;string&gt;:<span class="hljs-number">1</span>(&lt;module&gt;)</span><br></pre></td></tr></table></figure>

<p>上面的做法启发性不大。激活了IPython插件line_profiler，新的命令%lprun就能用了。使用中的不同点是，我们必须告诉%lprun要分析的函数是哪个。语法是：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%lprun -f func1 -f func2 statement_to_profile</span><br></pre></td></tr></table></figure>

<p>我们想分析add_and_sum，运行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">573</span>]: %lprun -f add_and_sum add_and_sum(x, y)</span><br><span class="line">Timer unit: <span class="hljs-number">1e-06</span> s</span><br><span class="line">File: prof_mod.py</span><br><span class="line">Function: add_and_sum at line <span class="hljs-number">3</span></span><br><span class="line">Total time: <span class="hljs-number">0.045936</span> s</span><br><span class="line">Line <span class="hljs-comment">#      Hits         Time  Per Hit   % Time  Line Contents</span></span><br><span class="line">==============================================================</span><br><span class="line">     <span class="hljs-number">3</span>                                           <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_and_sum</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">     <span class="hljs-number">4</span>         <span class="hljs-number">1</span>        <span class="hljs-number">36510</span>  <span class="hljs-number">36510.0</span>     <span class="hljs-number">79.5</span>      added = x + y</span><br><span class="line">     <span class="hljs-number">5</span>         <span class="hljs-number">1</span>         <span class="hljs-number">9425</span>   <span class="hljs-number">9425.0</span>     <span class="hljs-number">20.5</span>      summed = added.sum(axis=<span class="hljs-number">1</span>)</span><br><span class="line">     <span class="hljs-number">6</span>         <span class="hljs-number">1</span>            <span class="hljs-number">1</span>      <span class="hljs-number">1.0</span>      <span class="hljs-number">0.0</span>      <span class="hljs-keyword">return</span> summed</span><br></pre></td></tr></table></figure>

<p>这样就容易诠释了。我们分析了和代码语句中一样的函数。看之前的模块代码，我们可以调用call_function并对它和add_and_sum进行分析，得到一个完整的代码性能概括：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">574</span>]: %lprun -f add_and_sum -f call_function call_function()</span><br><span class="line">Timer unit: <span class="hljs-number">1e-06</span> s</span><br><span class="line">File: prof_mod.py</span><br><span class="line">Function: add_and_sum at line <span class="hljs-number">3</span></span><br><span class="line">Total time: <span class="hljs-number">0.005526</span> s</span><br><span class="line">Line <span class="hljs-comment">#      Hits         Time  Per Hit   % Time  Line Contents</span></span><br><span class="line">==============================================================</span><br><span class="line">     <span class="hljs-number">3</span>                                           <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_and_sum</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">     <span class="hljs-number">4</span>         <span class="hljs-number">1</span>         <span class="hljs-number">4375</span>   <span class="hljs-number">4375.0</span>     <span class="hljs-number">79.2</span>      added = x + y</span><br><span class="line">     <span class="hljs-number">5</span>         <span class="hljs-number">1</span>         <span class="hljs-number">1149</span>   <span class="hljs-number">1149.0</span>     <span class="hljs-number">20.8</span>      summed = added.sum(axis=<span class="hljs-number">1</span>)</span><br><span class="line">     <span class="hljs-number">6</span>         <span class="hljs-number">1</span>            <span class="hljs-number">2</span>      <span class="hljs-number">2.0</span>      <span class="hljs-number">0.0</span>      <span class="hljs-keyword">return</span> summed</span><br><span class="line">File: prof_mod.py</span><br><span class="line">Function: call_function at line <span class="hljs-number">8</span></span><br><span class="line">Total time: <span class="hljs-number">0.121016</span> s</span><br><span class="line">Line <span class="hljs-comment">#      Hits         Time  Per Hit   % Time  Line Contents</span></span><br><span class="line">==============================================================</span><br><span class="line">     <span class="hljs-number">8</span>                                           <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">call_function</span><span class="hljs-params">()</span>:</span></span><br><span class="line">     <span class="hljs-number">9</span>         <span class="hljs-number">1</span>        <span class="hljs-number">57169</span>  <span class="hljs-number">57169.0</span>     <span class="hljs-number">47.2</span>      x = randn(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>)</span><br><span class="line">    <span class="hljs-number">10</span>         <span class="hljs-number">1</span>        <span class="hljs-number">58304</span>  <span class="hljs-number">58304.0</span>     <span class="hljs-number">48.2</span>      y = randn(<span class="hljs-number">1000</span>, <span class="hljs-number">1000</span>)</span><br><span class="line">    <span class="hljs-number">11</span>         <span class="hljs-number">1</span>         <span class="hljs-number">5543</span>   <span class="hljs-number">5543.0</span>      <span class="hljs-number">4.6</span>      <span class="hljs-keyword">return</span> add_and_sum(x, y)</span><br></pre></td></tr></table></figure>

<p>我的经验是用%prun (cProfile)进行宏观分析，%lprun (line_profiler)做微观分析。最好对这两个工具都了解清楚。</p>
<blockquote>
<p>笔记：使用%lprun必须要指明函数名的原因是追踪每行的执行时间的损耗过多。追踪无用的函数会显著地改变结果。</p>
</blockquote>
<h1 id="B-4-使用IPython高效开发的技巧"><a href="#B-4-使用IPython高效开发的技巧" class="headerlink" title="B.4 使用IPython高效开发的技巧"></a>B.4 使用IPython高效开发的技巧</h1><p>方便快捷地写代码、调试和使用是每个人的目标。除了代码风格，流程细节（比如代码重载）也需要一些调整。</p>
<p>因此，这一节的内容更像是门艺术而不是科学，还需要你不断的试验，以达成高效。最终，你要能结构优化代码，并且能省时省力地检查程序或函数的结果。我发现用IPython设计的软件比起命令行，要更适合工作。尤其是当发生错误时，你需要检查自己或别人写的数月或数年前写的代码的错误。</p>
<h2 id="重载模块依赖"><a href="#重载模块依赖" class="headerlink" title="重载模块依赖"></a>重载模块依赖</h2><p>在Python中，当你输入import some_lib，some_lib中的代码就会被执行，所有的变量、函数和定义的引入，就会被存入到新创建的some_lib模块命名空间。当下一次输入some_lib，就会得到一个已存在的模块命名空间的引用。潜在的问题是当你%run一个脚本，它依赖于另一个模块，而这个模块做过修改，就会产生问题。假设我在test_script.py中有如下代码：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> some_lib</span><br><span class="line"></span><br><span class="line">x = <span class="hljs-number">5</span></span><br><span class="line">y = [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]</span><br><span class="line">result = some_lib.get_answer(x, y)</span><br></pre></td></tr></table></figure>

<p>如果你运行过了%run test_script.py，然后修改了some_lib.py，下一次再执行%run test_script.py，还会得到旧版本的some_lib.py，这是因为Python模块系统的“一次加载”机制。这一点区分了Python和其它数据分析环境，比如MATLAB，它会自动传播代码修改。解决这个问题，有多种方法。第一种是在标准库importlib模块中使用reload函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> some_lib</span><br><span class="line"><span class="hljs-keyword">import</span> importlib</span><br><span class="line"></span><br><span class="line">importlib.reload(some_lib)</span><br></pre></td></tr></table></figure>

<p>这可以保证每次运行test_script.py时可以加载最新的some_lib.py。很明显，如果依赖更深，在各处都使用reload是非常麻烦的。对于这个问题，IPython有一个特殊的dreload函数（它不是魔术函数）重载深层的模块。如果我运行过some_lib.py，然后输入dreload(some_lib)，就会尝试重载some_lib和它的依赖。不过，这个方法不适用于所有场景，但比重启IPython强多了。</p>
<h2 id="代码设计技巧"><a href="#代码设计技巧" class="headerlink" title="代码设计技巧"></a>代码设计技巧</h2><p>对于这单，没有简单的对策，但是有一些原则，是我在工作中发现很好用的。</p>
<h2 id="保持相关对象和数据活跃"><a href="#保持相关对象和数据活跃" class="headerlink" title="保持相关对象和数据活跃"></a>保持相关对象和数据活跃</h2><p>为命令行写一个下面示例中的程序是很少见的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> my_functions <span class="hljs-keyword">import</span> g</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">f</span><span class="hljs-params">(x, y)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> g(x + y)</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">main</span><span class="hljs-params">()</span>:</span></span><br><span class="line">    x = <span class="hljs-number">6</span></span><br><span class="line">    y = <span class="hljs-number">7.5</span></span><br><span class="line">    result = x + y</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">if</span> __name__ == <span class="hljs-string">'__main__'</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>

<p>在IPython中运行这个程序会发生问题，你发现是什么了吗？运行之后，任何定义在main函数中的结果和对象都不能在IPython中被访问到。更好的方法是将main中的代码直接在模块的命名空间中执行（或者在<code>__name__ == &#39;__main__&#39;:</code>中，如果你想让这个模块可以被引用）。这样，当你%rundiamante，就可以查看所有定义在main中的变量。这等价于在Jupyter notebook的代码格中定义一个顶级变量。</p>
<h2 id="扁平优于嵌套"><a href="#扁平优于嵌套" class="headerlink" title="扁平优于嵌套"></a>扁平优于嵌套</h2><p>深层嵌套的代码总让我联想到洋葱皮。当测试或调试一个函数时，你需要剥多少层洋葱皮才能到达目标代码呢？“扁平优于嵌套”是Python之禅的一部分，它也适用于交互式代码开发。尽量将函数和类去耦合和模块化，有利于测试（如果你是在写单元测试）、调试和交互式使用。</p>
<h2 id="克服对大文件的恐惧"><a href="#克服对大文件的恐惧" class="headerlink" title="克服对大文件的恐惧"></a>克服对大文件的恐惧</h2><p>如果你之前是写JAVA（或者其它类似的语言），你可能被告知要让文件简短。在多数语言中，这都是合理的建议：太长会让人感觉是坏代码，意味着重构和重组是必要的。但是，在用IPython开发时，运行10个相关联的小文件（小于100行），比起两个或三个长文件，会让你更头疼。更少的文件意味着重载更少的模块和更少的编辑时在文件中跳转。我发现维护大模块，每个模块都是紧密组织的，会更实用和Pythonic。经过方案迭代，有时会将大文件分解成小文件。</p>
<p>我不建议极端化这条建议，那样会形成一个单独的超大文件。找到一个合理和直观的大型代码模块库和封装结构往往需要一点工作，但这在团队工作中非常重要。每个模块都应该结构紧密，并且应该能直观地找到负责每个功能领域功能和类。</p>
<h1 id="B-5-IPython高级功能"><a href="#B-5-IPython高级功能" class="headerlink" title="B.5 IPython高级功能"></a>B.5 IPython高级功能</h1><p>要全面地使用IPython系统需要用另一种稍微不同的方式写代码，或深入IPython的配置。</p>
<h2 id="让类是对IPython友好的"><a href="#让类是对IPython友好的" class="headerlink" title="让类是对IPython友好的"></a>让类是对IPython友好的</h2><p>IPython会尽可能地在控制台美化展示每个字符串。对于许多对象，比如字典、列表和元组，内置的pprint模块可以用来美化格式。但是，在用户定义的类中，你必自己生成字符串。假设有一个下面的简单的类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Message</span>:</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, msg)</span>:</span></span><br><span class="line">        self.msg = msg</span><br></pre></td></tr></table></figure>

<p>如果这么写，就会发现默认的输出不够美观：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">576</span>]: x = Message(<span class="hljs-string">'I have a secret'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">577</span>]: x</span><br><span class="line">Out[<span class="hljs-number">577</span>]: &lt;__main__.Message instance at <span class="hljs-number">0x60ebbd8</span>&gt;</span><br></pre></td></tr></table></figure>

<p>IPython会接收<strong>repr</strong>魔术方法返回的字符串（通过output = repr(obj)），并在控制台打印出来。因此，我们可以添加一个简单的<strong>repr</strong>方法到前面的类中，以得到一个更有用的输出：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Message</span>:</span></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__init__</span><span class="hljs-params">(self, msg)</span>:</span></span><br><span class="line">        self.msg = msg</span><br><span class="line"></span><br><span class="line">    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">__repr__</span><span class="hljs-params">(self)</span>:</span></span><br><span class="line">        <span class="hljs-keyword">return</span> <span class="hljs-string">'Message: %s'</span> % self.msg</span><br><span class="line">In [<span class="hljs-number">579</span>]: x = Message(<span class="hljs-string">'I have a secret'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">580</span>]: x</span><br><span class="line">Out[<span class="hljs-number">580</span>]: Message: I have a secret</span><br></pre></td></tr></table></figure>

<h2 id="文件和配置"><a href="#文件和配置" class="headerlink" title="文件和配置"></a>文件和配置</h2><p>通过扩展配置系统，大多数IPython和Jupyter notebook的外观（颜色、提示符、行间距等等）和动作都是可以配置的。通过配置，你可以做到：</p>
<ul>
<li>改变颜色主题</li>
<li>改变输入和输出提示符，或删除输出之后、输入之前的空行</li>
<li>执行任意Python语句（例如，引入总是要使用的代码或者每次加载IPython都要运行的内容）</li>
<li>启用IPython总是要运行的插件，比如line_profiler中的%lprun魔术函数</li>
<li>启用Jupyter插件</li>
<li>定义自己的魔术函数或系统别名</li>
</ul>
<p>IPython的配置存储在特殊的ipython_config.py文件中，它通常是在用户home目录的.ipython/文件夹中。配置是通过一个特殊文件。当你启动IPython，就会默认加载这个存储在profile_default文件夹中的默认文件。因此，在我的Linux系统，完整的IPython配置文件路径是：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/wesm/.ipython/profile_default/ipython_config.py</span><br></pre></td></tr></table></figure>

<p>要启动这个文件，运行下面的命令：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipython profile create</span><br></pre></td></tr></table></figure>

<p>这个文件中的内容留给读者自己探索。这个文件有注释，解释了每个配置选项的作用。另一点，可以有多个配置文件。假设你想要另一个IPython配置文件，专门是为另一个应用或项目的。创建一个新的配置文件很简单，如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ipython profile create secret_project</span><br></pre></td></tr></table></figure>

<p>做完之后，在新创建的profile_secret_project目录便捷配置文件，然后如下启动IPython：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ ipython --profile=secret_project</span><br><span class="line">Python <span class="hljs-number">3.5</span><span class="hljs-number">.1</span> | packaged by conda-forge | (default, May <span class="hljs-number">20</span> <span class="hljs-number">2016</span>, <span class="hljs-number">05</span>:<span class="hljs-number">22</span>:<span class="hljs-number">56</span>)</span><br><span class="line">Type <span class="hljs-string">"copyright"</span>, <span class="hljs-string">"credits"</span> <span class="hljs-keyword">or</span> <span class="hljs-string">"license"</span> <span class="hljs-keyword">for</span> more information.</span><br><span class="line"></span><br><span class="line">IPython <span class="hljs-number">5.1</span><span class="hljs-number">.0</span> -- An enhanced Interactive Python.</span><br><span class="line">?         -&gt; Introduction and overview of IPython's features.</span><br><span class="line">%quickref -&gt; Quick reference.</span><br><span class="line">help      -&gt; Python's own help system.</span><br><span class="line">object?   -&gt; Details about 'object', use 'object??' for extra details.</span><br><span class="line"></span><br><span class="line">IPython profile: secret_project</span><br></pre></td></tr></table></figure>

<p>和之前一样，IPython的文档是一个极好的学习配置文件的资源。</p>
<p>配置Jupyter有些不同，因为你可以使用除了Python的其它语言。要创建一个类似的Jupyter配置文件，运行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter notebook --generate-config</span><br></pre></td></tr></table></figure>

<p>这样会在home目录的.jupyter/jupyter_notebook_config.py创建配置文件。编辑完之后，可以将它重命名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ mv ~/.jupyter/jupyter_notebook_config.py ~/.jupyter/my_custom_config.py</span><br></pre></td></tr></table></figure>

<p>打开Jupyter之后，你可以添加–config参数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jupyter notebook --config=~/.jupyter/my_custom_config.py</span><br></pre></td></tr></table></figure>

<h1 id="B-6-总结"><a href="#B-6-总结" class="headerlink" title="B.6 总结"></a>B.6 总结</h1><p>学习过本书中的代码案例，你的Python技能得到了一定的提升，我建议你持续学习IPython和Jupyter。因为这两个项目的设计初衷就是提高生产率的，你可能还会发现一些工具，可以让你更便捷地使用Python和计算库。</p>
<p>你可以在nbviewer（<a href="https://nbviewer.jupyter.org/）上找到更多有趣的Jupyter" target="_blank" rel="noopener">https://nbviewer.jupyter.org/）上找到更多有趣的Jupyter</a> notebooks。</p>
<hr>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
附录B 更多关于IPython的内容（完）</p>
<hr>
<blockquote>
<p>后记：经过三个月，总算翻译完成了这本书。工作砌码，回家码字。最大的改变是，十个手指头，除了两个大拇指和右手的小拇指，其它指尖竟然掉皮、磨出了茧。好长时间，只要手一沾水，就会起皱。读者们持续的阅读、点赞、留言、指出错误，让我感觉是和很多人一起完成一项有意义的事情。Thanks all！</p>
</blockquote>
<blockquote>
<p>后记2：2018年8月5日，做完了第一次校阅。</p>
</blockquote>
<p><img src="/images/blog/7178691-260d699e695f8e81.webp" alt="img"></p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 8350 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC10%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E8%81%9A%E5%90%88%E4%B8%8E%E5%88%86%E7%BB%84%E8%BF%90%E7%AE%97/">《利用Python进行数据分析·第2版》第10章 数据聚合与分组运算</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
第10章 数据聚合与分组运算
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>对数据集进行分组并对各组应用一个函数（无论是聚合还是转换），通常是数据分析工作中的重要环节。在将数据集加载、融合、准备好之后，通常就是计算分组统计或生成透视表。pandas提供了一个灵活高效的gruopby功能，它使你能以一种自然的方式对数据集进行切片、切块、摘要等操作。</p>
<p>关系型数据库和SQL（Structured Query Language，结构化查询语言）能够如此流行的原因之一就是其能够方便地对数据进行连接、过滤、转换和聚合。但是，像SQL这样的查询语言所能执行的分组运算的种类很有限。在本章中你将会看到，由于Python和pandas强大的表达能力，我们可以执行复杂得多的分组运算（利用任何可以接受pandas对象或NumPy数组的函数）。在本章中，你将会学到：</p>
<ul>
<li>使用一个或多个键（形式可以是函数、数组或DataFrame列名）分割pandas对象。</li>
<li>计算分组的概述统计，比如数量、平均值或标准差，或是用户定义的函数。</li>
<li>应用组内转换或其他运算，如规格化、线性回归、排名或选取子集等。</li>
<li>计算透视表或交叉表。</li>
<li>执行分位数分析以及其它统计分组分析。</li>
</ul>
<blockquote>
<p>笔记：对时间序列数据的聚合（groupby的特殊用法之一）也称作重采样（resampling），本书将在第11章中单独对其进行讲解。</p>
</blockquote>
<h1 id="10-1-GroupBy机制"><a href="#10-1-GroupBy机制" class="headerlink" title="10.1 GroupBy机制"></a>10.1 GroupBy机制</h1><p>Hadley Wickham（许多热门R语言包的作者）创造了一个用于表示分组运算的术语”split-apply-combine”（拆分－应用－合并）。第一个阶段，pandas对象（无论是Series、DataFrame还是其他的）中的数据会根据你所提供的一个或多个键被拆分（split）为多组。拆分操作是在对象的特定轴上执行的。例如，DataFrame可以在其行（axis=0）或列（axis=1）上进行分组。然后，将一个函数应用（apply）到各个分组并产生一个新值。最后，所有这些函数的执行结果会被合并（combine）到最终的结果对象中。结果对象的形式一般取决于数据上所执行的操作。图10-1大致说明了一个简单的分组聚合过程。</p>
<p><img src="/images/blog/7178691-e5c671e09ecf94be.webp" alt="img"></p>
<p>图10-1 分组聚合演示</p>
<p>分组键可以有多种形式，且类型不必相同：</p>
<ul>
<li>列表或数组，其长度与待分组的轴一样。</li>
<li>表示DataFrame某个列名的值。</li>
<li>字典或Series，给出待分组轴上的值与分组名之间的对应关系。</li>
<li>函数，用于处理轴索引或索引中的各个标签。</li>
</ul>
<p>注意，后三种都只是快捷方式而已，其最终目的仍然是产生一组用于拆分对象的值。如果觉得这些东西看起来很抽象，不用担心，我将在本章中给出大量有关于此的示例。首先来看看下面这个非常简单的表格型数据集（以DataFrame的形式）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'key1'</span> : [<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>],</span><br><span class="line">   ....:                    <span class="hljs-string">'key2'</span> : [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'one'</span>],</span><br><span class="line">   ....:                    <span class="hljs-string">'data1'</span> : np.random.randn(<span class="hljs-number">5</span>),</span><br><span class="line">   ....:                    <span class="hljs-string">'data2'</span> : np.random.randn(<span class="hljs-number">5</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: df</span><br><span class="line">Out[<span class="hljs-number">11</span>]: </span><br><span class="line">      data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>    a  one</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>    a  two</span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one</span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>    b  two</span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>    a  one</span><br></pre></td></tr></table></figure>

<p>假设你想要按key1进行分组，并计算data1列的平均值。实现该功能的方式有很多，而我们这里要用的是：访问data1，并根据key1调用groupby：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: grouped = df[<span class="hljs-string">'data1'</span>].groupby(df[<span class="hljs-string">'key1'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: grouped</span><br><span class="line">Out[<span class="hljs-number">13</span>]: &lt;pandas.core.groupby.SeriesGroupBy object at <span class="hljs-number">0x7faa31537390</span>&gt;</span><br></pre></td></tr></table></figure>

<p>变量grouped是一个GroupBy对象。它实际上还没有进行任何计算，只是含有一些有关分组键df[‘key1’]的中间数据而已。换句话说，该对象已经有了接下来对各分组执行运算所需的一切信息。例如，我们可以调用GroupBy的mean方法来计算分组平均值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">14</span>]: grouped.mean()</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">key1</span><br><span class="line">a    <span class="hljs-number">0.746672</span></span><br><span class="line">b   <span class="hljs-number">-0.537585</span></span><br><span class="line">Name: data1, dtype: float64</span><br></pre></td></tr></table></figure>

<p>稍后我将详细讲解.mean()的调用过程。这里最重要的是，数据（Series）根据分组键进行了聚合，产生了一个新的Series，其索引为key1列中的唯一值。之所以结果中索引的名称为key1，是因为原始DataFrame的列df[‘key1’]就叫这个名字。</p>
<p>如果我们一次传入多个数组的列表，就会得到不同的结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: means = df[<span class="hljs-string">'data1'</span>].groupby([df[<span class="hljs-string">'key1'</span>], df[<span class="hljs-string">'key2'</span>]]).mean()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: means</span><br><span class="line">Out[<span class="hljs-number">16</span>]: </span><br><span class="line">key1  key2</span><br><span class="line">a     one     <span class="hljs-number">0.880536</span></span><br><span class="line">      two     <span class="hljs-number">0.478943</span></span><br><span class="line">b     one    <span class="hljs-number">-0.519439</span></span><br><span class="line">      two    <span class="hljs-number">-0.555730</span></span><br><span class="line">Name: data1, dtype: float64</span><br></pre></td></tr></table></figure>

<p>这里，我通过两个键对数据进行了分组，得到的Series具有一个层次化索引（由唯一的键对组成）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: means.unstack()</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line">key2       one       two</span><br><span class="line">key1                    </span><br><span class="line">a     <span class="hljs-number">0.880536</span>  <span class="hljs-number">0.478943</span></span><br><span class="line">b    <span class="hljs-number">-0.519439</span> <span class="hljs-number">-0.555730</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，分组键均为Series。实际上，分组键可以是任何长度适当的数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: states = np.array([<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'California'</span>, <span class="hljs-string">'California'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: years = np.array([<span class="hljs-number">2005</span>, <span class="hljs-number">2005</span>, <span class="hljs-number">2006</span>, <span class="hljs-number">2005</span>, <span class="hljs-number">2006</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: df[<span class="hljs-string">'data1'</span>].groupby([states, years]).mean()</span><br><span class="line">Out[<span class="hljs-number">20</span>]: </span><br><span class="line">California  <span class="hljs-number">2005</span>    <span class="hljs-number">0.478943</span></span><br><span class="line">            <span class="hljs-number">2006</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line">Ohio        <span class="hljs-number">2005</span>   <span class="hljs-number">-0.380219</span></span><br><span class="line">            <span class="hljs-number">2006</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">Name: data1, dtype: float64</span><br></pre></td></tr></table></figure>

<p>通常，分组信息就位于相同的要处理DataFrame中。这里，你还可以将列名（可以是字符串、数字或其他Python对象）用作分组键：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">21</span>]: df.groupby(<span class="hljs-string">'key1'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">         data1     data2</span><br><span class="line">key1</span><br><span class="line">a     <span class="hljs-number">0.746672</span>  <span class="hljs-number">0.910916</span></span><br><span class="line">b    <span class="hljs-number">-0.537585</span>  <span class="hljs-number">0.525384</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: df.groupby([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>]).mean()</span><br><span class="line">Out[<span class="hljs-number">22</span>]: </span><br><span class="line">              data1     data2</span><br><span class="line">key1 key2                    </span><br><span class="line">a    one   <span class="hljs-number">0.880536</span>  <span class="hljs-number">1.319920</span></span><br><span class="line">     two   <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span></span><br><span class="line">b    one  <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span></span><br><span class="line">     two  <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span></span><br></pre></td></tr></table></figure>

<p>你可能已经注意到了，第一个例子在执行df.groupby(‘key1’).mean()时，结果中没有key2列。这是因为df[‘key2’]不是数值数据（俗称“麻烦列”），所以被从结果中排除了。默认情况下，所有数值列都会被聚合，虽然有时可能会被过滤为一个子集，稍后就会碰到。</p>
<p>无论你准备拿groupby做什么，都有可能会用到GroupBy的size方法，它可以返回一个含有分组大小的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">23</span>]: df.groupby([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>]).size()</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">key1  key2</span><br><span class="line">a     one     <span class="hljs-number">2</span></span><br><span class="line">      two     <span class="hljs-number">1</span></span><br><span class="line">b     one     <span class="hljs-number">1</span></span><br><span class="line">      two     <span class="hljs-number">1</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>注意，任何分组关键词中的缺失值，都会被从结果中除去。</p>
<h2 id="对分组进行迭代"><a href="#对分组进行迭代" class="headerlink" title="对分组进行迭代"></a>对分组进行迭代</h2><p>GroupBy对象支持迭代，可以产生一组二元元组（由分组名和数据块组成）。看下面的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: <span class="hljs-keyword">for</span> name, group <span class="hljs-keyword">in</span> df.groupby(<span class="hljs-string">'key1'</span>):</span><br><span class="line">   ....:     print(name)</span><br><span class="line">   ....:     print(group)</span><br><span class="line">   ....:</span><br><span class="line">a</span><br><span class="line">      data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>    a  one</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>    a  two</span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>    a  one</span><br><span class="line">b</span><br><span class="line">      data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one</span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>    b  two</span><br></pre></td></tr></table></figure>

<p>对于多重键的情况，元组的第一个元素将会是由键值组成的元组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: <span class="hljs-keyword">for</span> (k1, k2), group <span class="hljs-keyword">in</span> df.groupby([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>]):</span><br><span class="line">   ....:     print((k1, k2))</span><br><span class="line">   ....:     print(group)</span><br><span class="line">   ....:</span><br><span class="line">(<span class="hljs-string">'a'</span>, <span class="hljs-string">'one'</span>)</span><br><span class="line">      data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>    a  one</span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>    a  one</span><br><span class="line">(<span class="hljs-string">'a'</span>, <span class="hljs-string">'two'</span>)</span><br><span class="line">      data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>    a  two</span><br><span class="line">(<span class="hljs-string">'b'</span>, <span class="hljs-string">'one'</span>)</span><br><span class="line">      data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one</span><br><span class="line">(<span class="hljs-string">'b'</span>, <span class="hljs-string">'two'</span>)</span><br><span class="line">     data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.55573</span>  <span class="hljs-number">0.769023</span>    b  two</span><br></pre></td></tr></table></figure>

<p>当然，你可以对这些数据片段做任何操作。有一个你可能会觉得有用的运算：将这些数据片段做成一个字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">26</span>]: pieces = dict(list(df.groupby(<span class="hljs-string">'key1'</span>)))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: pieces[<span class="hljs-string">'b'</span>]</span><br><span class="line">Out[<span class="hljs-number">27</span>]: </span><br><span class="line">      data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one</span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>    b  two</span><br></pre></td></tr></table></figure>

<p>groupby默认是在axis=0上进行分组的，通过设置也可以在其他任何轴上进行分组。拿上面例子中的df来说，我们可以根据dtype对列进行分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">28</span>]: df.dtypes</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">data1    float64</span><br><span class="line">data2    float64</span><br><span class="line">key1      object</span><br><span class="line">key2      object</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">29</span>]: grouped = df.groupby(df.dtypes, axis=<span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>可以如下打印分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">30</span>]: <span class="hljs-keyword">for</span> dtype, group <span class="hljs-keyword">in</span> grouped:</span><br><span class="line">   ....:     print(dtype)</span><br><span class="line">   ....:     print(group)</span><br><span class="line">   ....:</span><br><span class="line">float64</span><br><span class="line">      data1     data2</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span></span><br><span class="line">object</span><br><span class="line">  key1 key2</span><br><span class="line"><span class="hljs-number">0</span>    a  one</span><br><span class="line"><span class="hljs-number">1</span>    a  two</span><br><span class="line"><span class="hljs-number">2</span>    b  one</span><br><span class="line"><span class="hljs-number">3</span>    b  two</span><br><span class="line"><span class="hljs-number">4</span>    a  one</span><br></pre></td></tr></table></figure>

<h2 id="选取一列或列的子集"><a href="#选取一列或列的子集" class="headerlink" title="选取一列或列的子集"></a>选取一列或列的子集</h2><p>对于由DataFrame产生的GroupBy对象，如果用一个（单个字符串）或一组（字符串数组）列名对其进行索引，就能实现选取部分列进行聚合的目的。也就是说：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df.groupby(<span class="hljs-string">'key1'</span>)[<span class="hljs-string">'data1'</span>]</span><br><span class="line">df.groupby(<span class="hljs-string">'key1'</span>)[[<span class="hljs-string">'data2'</span>]]</span><br></pre></td></tr></table></figure>

<p>是以下代码的语法糖：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df[<span class="hljs-string">'data1'</span>].groupby(df[<span class="hljs-string">'key1'</span>])</span><br><span class="line">df[[<span class="hljs-string">'data2'</span>]].groupby(df[<span class="hljs-string">'key1'</span>])</span><br></pre></td></tr></table></figure>

<p>尤其对于大数据集，很可能只需要对部分列进行聚合。例如，在前面那个数据集中，如果只需计算data2列的平均值并以DataFrame形式得到结果，可以这样写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: df.groupby([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>])[[<span class="hljs-string">'data2'</span>]].mean()</span><br><span class="line">Out[<span class="hljs-number">31</span>]: </span><br><span class="line">              data2</span><br><span class="line">key1 key2          </span><br><span class="line">a    one   <span class="hljs-number">1.319920</span></span><br><span class="line">     two   <span class="hljs-number">0.092908</span></span><br><span class="line">b    one   <span class="hljs-number">0.281746</span></span><br><span class="line">     two   <span class="hljs-number">0.769023</span></span><br></pre></td></tr></table></figure>

<p>这种索引操作所返回的对象是一个已分组的DataFrame（如果传入的是列表或数组）或已分组的Series（如果传入的是标量形式的单个列名）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">32</span>]: s_grouped = df.groupby([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>])[<span class="hljs-string">'data2'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">33</span>]: s_grouped</span><br><span class="line">Out[<span class="hljs-number">33</span>]: &lt;pandas.core.groupby.SeriesGroupBy object at <span class="hljs-number">0x7faa30c78da0</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: s_grouped.mean()</span><br><span class="line">Out[<span class="hljs-number">34</span>]: </span><br><span class="line">key1  key2</span><br><span class="line">a     one     <span class="hljs-number">1.319920</span></span><br><span class="line">      two     <span class="hljs-number">0.092908</span></span><br><span class="line">b     one     <span class="hljs-number">0.281746</span></span><br><span class="line">      two     <span class="hljs-number">0.769023</span></span><br><span class="line">Name: data2, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="通过字典或Series进行分组"><a href="#通过字典或Series进行分组" class="headerlink" title="通过字典或Series进行分组"></a>通过字典或Series进行分组</h2><p>除数组以外，分组信息还可以其他形式存在。来看另一个示例DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: people = pd.DataFrame(np.random.randn(<span class="hljs-number">5</span>, <span class="hljs-number">5</span>),</span><br><span class="line">   ....:                       columns=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>],</span><br><span class="line">   ....:                       index=[<span class="hljs-string">'Joe'</span>, <span class="hljs-string">'Steve'</span>, <span class="hljs-string">'Wes'</span>, <span class="hljs-string">'Jim'</span>, <span class="hljs-string">'Travis'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: people.iloc[<span class="hljs-number">2</span>:<span class="hljs-number">3</span>, [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>]] = np.nan <span class="hljs-comment"># Add a few NA values</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: people</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">               a         b         c         d         e</span><br><span class="line">Joe     <span class="hljs-number">1.007189</span> <span class="hljs-number">-1.296221</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line">Steve   <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span></span><br><span class="line">Wes    <span class="hljs-number">-0.539741</span>       NaN       NaN <span class="hljs-number">-1.021228</span> <span class="hljs-number">-0.577087</span></span><br><span class="line">Jim     <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">0.000940</span>  <span class="hljs-number">1.343810</span></span><br><span class="line">Travis <span class="hljs-number">-0.713544</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-2.370232</span> <span class="hljs-number">-1.860761</span> <span class="hljs-number">-0.860757</span></span><br></pre></td></tr></table></figure>

<p>现在，假设已知列的分组关系，并希望根据分组计算列的和：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">38</span>]: mapping = &#123;<span class="hljs-string">'a'</span>: <span class="hljs-string">'red'</span>, <span class="hljs-string">'b'</span>: <span class="hljs-string">'red'</span>, <span class="hljs-string">'c'</span>: <span class="hljs-string">'blue'</span>,</span><br><span class="line">   ....:            <span class="hljs-string">'d'</span>: <span class="hljs-string">'blue'</span>, <span class="hljs-string">'e'</span>: <span class="hljs-string">'red'</span>, <span class="hljs-string">'f'</span> : <span class="hljs-string">'orange'</span>&#125;</span><br></pre></td></tr></table></figure>

<p>现在，你可以将这个字典传给groupby，来构造数组，但我们可以直接传递字典（我包含了键“f”来强调，存在未使用的分组键是可以的）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: by_column = people.groupby(mapping, axis=<span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: by_column.sum()</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">            blue       red</span><br><span class="line">Joe     <span class="hljs-number">0.503905</span>  <span class="hljs-number">1.063885</span></span><br><span class="line">Steve   <span class="hljs-number">1.297183</span> <span class="hljs-number">-1.553778</span></span><br><span class="line">Wes    <span class="hljs-number">-1.021228</span> <span class="hljs-number">-1.116829</span></span><br><span class="line">Jim     <span class="hljs-number">0.524712</span>  <span class="hljs-number">1.770545</span></span><br><span class="line">Travis <span class="hljs-number">-4.230992</span> <span class="hljs-number">-2.405455</span></span><br></pre></td></tr></table></figure>

<p>Series也有同样的功能，它可以被看做一个固定大小的映射：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">41</span>]: map_series = pd.Series(mapping)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: map_series</span><br><span class="line">Out[<span class="hljs-number">42</span>]: </span><br><span class="line">a       red</span><br><span class="line">b       red</span><br><span class="line">c      blue</span><br><span class="line">d      blue</span><br><span class="line">e       red</span><br><span class="line">f    orange</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: people.groupby(map_series, axis=<span class="hljs-number">1</span>).count()</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line">        blue  red</span><br><span class="line">Joe        <span class="hljs-number">2</span>    <span class="hljs-number">3</span></span><br><span class="line">Steve      <span class="hljs-number">2</span>    <span class="hljs-number">3</span></span><br><span class="line">Wes        <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line">Jim        <span class="hljs-number">2</span>    <span class="hljs-number">3</span></span><br><span class="line">Travis     <span class="hljs-number">2</span>    <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<h2 id="通过函数进行分组"><a href="#通过函数进行分组" class="headerlink" title="通过函数进行分组"></a>通过函数进行分组</h2><p>比起使用字典或Series，使用Python函数是一种更原生的方法定义分组映射。任何被当做分组键的函数都会在各个索引值上被调用一次，其返回值就会被用作分组名称。具体点说，以上一小节的示例DataFrame为例，其索引值为人的名字。你可以计算一个字符串长度的数组，更简单的方法是传入len函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: people.groupby(len).sum()</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line">          a         b         c         d         e</span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">0.591569</span> <span class="hljs-number">-0.993608</span>  <span class="hljs-number">0.798764</span> <span class="hljs-number">-0.791374</span>  <span class="hljs-number">2.119639</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span></span><br><span class="line"><span class="hljs-number">6</span> <span class="hljs-number">-0.713544</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-2.370232</span> <span class="hljs-number">-1.860761</span> <span class="hljs-number">-0.860757</span></span><br></pre></td></tr></table></figure>

<p>将函数跟数组、列表、字典、Series混合使用也不是问题，因为任何东西在内部都会被转换为数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: key_list = [<span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'two'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: people.groupby([len, key_list]).min()</span><br><span class="line">Out[<span class="hljs-number">46</span>]: </span><br><span class="line">              a         b         c         d         e</span><br><span class="line"><span class="hljs-number">3</span> one <span class="hljs-number">-0.539741</span> <span class="hljs-number">-1.296221</span>  <span class="hljs-number">0.274992</span> <span class="hljs-number">-1.021228</span> <span class="hljs-number">-0.577087</span></span><br><span class="line">  two  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">0.000940</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">5</span> one  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span></span><br><span class="line"><span class="hljs-number">6</span> two <span class="hljs-number">-0.713544</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-2.370232</span> <span class="hljs-number">-1.860761</span> <span class="hljs-number">-0.860757</span></span><br></pre></td></tr></table></figure>

<h2 id="根据索引级别分组"><a href="#根据索引级别分组" class="headerlink" title="根据索引级别分组"></a>根据索引级别分组</h2><p>层次化索引数据集最方便的地方就在于它能够根据轴索引的一个级别进行聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">47</span>]: columns = pd.MultiIndex.from_arrays([[<span class="hljs-string">'US'</span>, <span class="hljs-string">'US'</span>, <span class="hljs-string">'US'</span>, <span class="hljs-string">'JP'</span>, <span class="hljs-string">'JP'</span>],</span><br><span class="line">   ....:                                     [<span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>]],</span><br><span class="line">   ....:                                     names=[<span class="hljs-string">'cty'</span>, <span class="hljs-string">'tenor'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: hier_df = pd.DataFrame(np.random.randn(<span class="hljs-number">4</span>, <span class="hljs-number">5</span>), columns=columns)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">49</span>]: hier_df</span><br><span class="line">Out[<span class="hljs-number">49</span>]: </span><br><span class="line">cty          US                            JP          </span><br><span class="line">tenor         <span class="hljs-number">1</span>         <span class="hljs-number">3</span>         <span class="hljs-number">5</span>         <span class="hljs-number">1</span>         <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0.560145</span> <span class="hljs-number">-1.265934</span>  <span class="hljs-number">0.119827</span> <span class="hljs-number">-1.063512</span>  <span class="hljs-number">0.332883</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">-2.359419</span> <span class="hljs-number">-0.199543</span> <span class="hljs-number">-1.541996</span> <span class="hljs-number">-0.970736</span> <span class="hljs-number">-1.307030</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">0.286350</span>  <span class="hljs-number">0.377984</span> <span class="hljs-number">-0.753887</span>  <span class="hljs-number">0.331286</span>  <span class="hljs-number">1.349742</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">0.069877</span>  <span class="hljs-number">0.246674</span> <span class="hljs-number">-0.011862</span>  <span class="hljs-number">1.004812</span>  <span class="hljs-number">1.327195</span></span><br></pre></td></tr></table></figure>

<p>要根据级别分组，使用level关键字传递级别序号或名字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: hier_df.groupby(level=<span class="hljs-string">'cty'</span>, axis=<span class="hljs-number">1</span>).count()</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">cty  JP  US</span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<h1 id="10-2-数据聚合"><a href="#10-2-数据聚合" class="headerlink" title="10.2 数据聚合"></a>10.2 数据聚合</h1><p>聚合指的是任何能够从数组产生标量值的数据转换过程。之前的例子已经用过一些，比如mean、count、min以及sum等。你可能想知道在GroupBy对象上调用mean()时究竟发生了什么。许多常见的聚合运算（如表10-1所示）都有进行优化。然而，除了这些方法，你还可以使用其它的。</p>
<p><img src="/images/blog/7178691-ba8de524e08b1b6f.webp" alt="img"></p>
<p>表10-1 经过优化的groupby方法</p>
<p>你可以使用自己发明的聚合运算，还可以调用分组对象上已经定义好的任何方法。例如，quantile可以计算Series或DataFrame列的样本分位数。</p>
<p>虽然quantile并没有明确地实现于GroupBy，但它是一个Series方法，所以这里是能用的。实际上，GroupBy会高效地对Series进行切片，然后对各片调用piece.quantile(0.9)，最后将这些结果组装成最终结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">51</span>]: df</span><br><span class="line">Out[<span class="hljs-number">51</span>]: </span><br><span class="line">      data1     data2 key1 key2</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">1.393406</span>    a  one</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">0.092908</span>    a  two</span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span>  <span class="hljs-number">0.281746</span>    b  one</span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.769023</span>    b  two</span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span>  <span class="hljs-number">1.246435</span>    a  one</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">52</span>]: grouped = df.groupby(<span class="hljs-string">'key1'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: grouped[<span class="hljs-string">'data1'</span>].quantile(<span class="hljs-number">0.9</span>)</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">key1</span><br><span class="line">a    <span class="hljs-number">1.668413</span></span><br><span class="line">b   <span class="hljs-number">-0.523068</span></span><br><span class="line">Name: data1, dtype: float64</span><br></pre></td></tr></table></figure>

<p>如果要使用你自己的聚合函数，只需将其传入aggregate或agg方法即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">peak_to_peak</span><span class="hljs-params">(arr)</span>:</span></span><br><span class="line">   ....:     <span class="hljs-keyword">return</span> arr.max() - arr.min()</span><br><span class="line">In [<span class="hljs-number">55</span>]: grouped.agg(peak_to_peak)</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line">         data1     data2</span><br><span class="line">key1                    </span><br><span class="line">a     <span class="hljs-number">2.170488</span>  <span class="hljs-number">1.300498</span></span><br><span class="line">b     <span class="hljs-number">0.036292</span>  <span class="hljs-number">0.487276</span></span><br></pre></td></tr></table></figure>

<p>你可能注意到注意，有些方法（如describe）也是可以用在这里的，即使严格来讲，它们并非聚合运算：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: grouped.describe()</span><br><span class="line">Out[<span class="hljs-number">56</span>]: </span><br><span class="line">     data1                                                              \</span><br><span class="line">     count      mean       std       min       <span class="hljs-number">25</span>%       <span class="hljs-number">50</span>%       <span class="hljs-number">75</span>%   </span><br><span class="line">key1                                                                     </span><br><span class="line">a      <span class="hljs-number">3.0</span>  <span class="hljs-number">0.746672</span>  <span class="hljs-number">1.109736</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.137118</span>  <span class="hljs-number">0.478943</span>  <span class="hljs-number">1.222362</span>   </span><br><span class="line">b      <span class="hljs-number">2.0</span> <span class="hljs-number">-0.537585</span>  <span class="hljs-number">0.025662</span> <span class="hljs-number">-0.555730</span> <span class="hljs-number">-0.546657</span> <span class="hljs-number">-0.537585</span> <span class="hljs-number">-0.528512</span>   </span><br><span class="line">               data2                                                    \</span><br><span class="line">max count      mean       std       min       <span class="hljs-number">25</span>%       <span class="hljs-number">50</span>%   </span><br><span class="line">key1                                                                     </span><br><span class="line">a     <span class="hljs-number">1.965781</span>   <span class="hljs-number">3.0</span>  <span class="hljs-number">0.910916</span>  <span class="hljs-number">0.712217</span>  <span class="hljs-number">0.092908</span>  <span class="hljs-number">0.669671</span>  <span class="hljs-number">1.246435</span>   </span><br><span class="line">b    <span class="hljs-number">-0.519439</span>   <span class="hljs-number">2.0</span>  <span class="hljs-number">0.525384</span>  <span class="hljs-number">0.344556</span>  <span class="hljs-number">0.281746</span>  <span class="hljs-number">0.403565</span>  <span class="hljs-number">0.525384</span>   </span><br><span class="line">                          </span><br><span class="line">           <span class="hljs-number">75</span>%       max  </span><br><span class="line">key1                      </span><br><span class="line">a     <span class="hljs-number">1.319920</span>  <span class="hljs-number">1.393406</span>  </span><br><span class="line">b     <span class="hljs-number">0.647203</span>  <span class="hljs-number">0.769023</span></span><br></pre></td></tr></table></figure>

<p>在后面的10.3节，我将详细说明这到底是怎么回事。</p>
<blockquote>
<p>笔记：自定义聚合函数要比表10-1中那些经过优化的函数慢得多。这是因为在构造中间分组数据块时存在非常大的开销（函数调用、数据重排等）。</p>
</blockquote>
<h2 id="面向列的多函数应用"><a href="#面向列的多函数应用" class="headerlink" title="面向列的多函数应用"></a>面向列的多函数应用</h2><p>回到前面小费的例子。使用read_csv导入数据之后，我们添加了一个小费百分比的列tip_pct：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">57</span>]: tips = pd.read_csv(<span class="hljs-string">'examples/tips.csv'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Add tip percentage of total bill</span></span><br><span class="line">In [<span class="hljs-number">58</span>]: tips[<span class="hljs-string">'tip_pct'</span>] = tips[<span class="hljs-string">'tip'</span>] / tips[<span class="hljs-string">'total_bill'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: tips[:<span class="hljs-number">6</span>]</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line">   total_bill   tip smoker  day    time  size   tip_pct</span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">16.99</span>  <span class="hljs-number">1.01</span>     No  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.059447</span></span><br><span class="line"><span class="hljs-number">1</span>       <span class="hljs-number">10.34</span>  <span class="hljs-number">1.66</span>     No  Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.160542</span></span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">21.01</span>  <span class="hljs-number">3.50</span>     No  Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.166587</span></span><br><span class="line"><span class="hljs-number">3</span>       <span class="hljs-number">23.68</span>  <span class="hljs-number">3.31</span>     No  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.139780</span></span><br><span class="line"><span class="hljs-number">4</span>       <span class="hljs-number">24.59</span>  <span class="hljs-number">3.61</span>     No  Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.146808</span></span><br><span class="line"><span class="hljs-number">5</span>       <span class="hljs-number">25.29</span>  <span class="hljs-number">4.71</span>     No  Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.186240</span></span><br></pre></td></tr></table></figure>

<p>你已经看到，对Series或DataFrame列的聚合运算其实就是使用aggregate（使用自定义函数）或调用诸如mean、std之类的方法。然而，你可能希望对不同的列使用不同的聚合函数，或一次应用多个函数。其实这也好办，我将通过一些示例来进行讲解。首先，我根据天和smoker对tips进行分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: grouped = tips.groupby([<span class="hljs-string">'day'</span>, <span class="hljs-string">'smoker'</span>])</span><br></pre></td></tr></table></figure>

<p>注意，对于表10-1中的那些描述统计，可以将函数名以字符串的形式传入：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">61</span>]: grouped_pct = grouped[<span class="hljs-string">'tip_pct'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: grouped_pct.agg(<span class="hljs-string">'mean'</span>)</span><br><span class="line">Out[<span class="hljs-number">62</span>]: </span><br><span class="line">day   smoker</span><br><span class="line">Fri   No        <span class="hljs-number">0.151650</span></span><br><span class="line">      Yes       <span class="hljs-number">0.174783</span></span><br><span class="line">Sat   No        <span class="hljs-number">0.158048</span></span><br><span class="line">      Yes       <span class="hljs-number">0.147906</span></span><br><span class="line">Sun   No        <span class="hljs-number">0.160113</span></span><br><span class="line">      Yes       <span class="hljs-number">0.187250</span></span><br><span class="line">Thur  No        <span class="hljs-number">0.160298</span></span><br><span class="line">      Yes       <span class="hljs-number">0.163863</span></span><br><span class="line">Name: tip_pct, dtype: float64</span><br></pre></td></tr></table></figure>

<p>如果传入一组函数或函数名，得到的DataFrame的列就会以相应的函数命名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">63</span>]: grouped_pct.agg([<span class="hljs-string">'mean'</span>, <span class="hljs-string">'std'</span>, peak_to_peak])</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line">                 mean       std  peak_to_peak</span><br><span class="line">day  smoker                                  </span><br><span class="line">Fri  No      <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.028123</span>      <span class="hljs-number">0.067349</span></span><br><span class="line">     Yes     <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.051293</span>      <span class="hljs-number">0.159925</span></span><br><span class="line">Sat  No      <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.039767</span>      <span class="hljs-number">0.235193</span></span><br><span class="line">     Yes     <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.061375</span>      <span class="hljs-number">0.290095</span></span><br><span class="line">Sun  No      <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.042347</span>      <span class="hljs-number">0.193226</span></span><br><span class="line">     Yes     <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.154134</span>      <span class="hljs-number">0.644685</span></span><br><span class="line">Thur No      <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.038774</span>      <span class="hljs-number">0.193350</span></span><br><span class="line">     Yes     <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.039389</span>      <span class="hljs-number">0.151240</span></span><br></pre></td></tr></table></figure>

<p>这里，我们传递了一组聚合函数进行聚合，独立对数据分组进行评估。</p>
<p>你并非一定要接受GroupBy自动给出的那些列名，特别是lambda函数，它们的名称是’<lambda>‘，这样的辨识度就很低了（通过函数的<strong>name</strong>属性看看就知道了）。因此，如果传入的是一个由(name,function)元组组成的列表，则各元组的第一个元素就会被用作DataFrame的列名（可以将这种二元元组列表看做一个有序映射）：</lambda></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">64</span>]: grouped_pct.agg([(<span class="hljs-string">'foo'</span>, <span class="hljs-string">'mean'</span>), (<span class="hljs-string">'bar'</span>, np.std)])</span><br><span class="line">Out[<span class="hljs-number">64</span>]: </span><br><span class="line">                  foo       bar</span><br><span class="line">day  smoker                    </span><br><span class="line">Fri  No      <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.028123</span></span><br><span class="line">     Yes     <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.051293</span></span><br><span class="line">Sat  No      <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.039767</span></span><br><span class="line">     Yes     <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.061375</span></span><br><span class="line">Sun  No      <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.042347</span></span><br><span class="line">     Yes     <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.154134</span></span><br><span class="line">Thur No      <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.038774</span></span><br><span class="line">     Yes     <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.039389</span></span><br></pre></td></tr></table></figure>

<p>对于DataFrame，你还有更多选择，你可以定义一组应用于全部列的一组函数，或不同的列应用不同的函数。假设我们想要对tip_pct和total_bill列计算三个统计信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: functions = [<span class="hljs-string">'count'</span>, <span class="hljs-string">'mean'</span>, <span class="hljs-string">'max'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">66</span>]: result = grouped[<span class="hljs-string">'tip_pct'</span>, <span class="hljs-string">'total_bill'</span>].agg(functions)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: result</span><br><span class="line">Out[<span class="hljs-number">67</span>]: </span><br><span class="line">            tip_pct                     total_bill                  </span><br><span class="line">              count      mean       max      count       mean    max</span><br><span class="line">day  smoker                                                         </span><br><span class="line">Fri  No           <span class="hljs-number">4</span>  <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.187735</span>          <span class="hljs-number">4</span>  <span class="hljs-number">18.420000</span>  <span class="hljs-number">22.75</span></span><br><span class="line">     Yes         <span class="hljs-number">15</span>  <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.263480</span>         <span class="hljs-number">15</span>  <span class="hljs-number">16.813333</span>  <span class="hljs-number">40.17</span></span><br><span class="line">Sat  No          <span class="hljs-number">45</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.291990</span>         <span class="hljs-number">45</span>  <span class="hljs-number">19.661778</span>  <span class="hljs-number">48.33</span></span><br><span class="line">     Yes         <span class="hljs-number">42</span>  <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.325733</span>         <span class="hljs-number">42</span>  <span class="hljs-number">21.276667</span>  <span class="hljs-number">50.81</span></span><br><span class="line">Sun  No          <span class="hljs-number">57</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.252672</span>         <span class="hljs-number">57</span>  <span class="hljs-number">20.506667</span>  <span class="hljs-number">48.17</span></span><br><span class="line">     Yes         <span class="hljs-number">19</span>  <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.710345</span>         <span class="hljs-number">19</span>  <span class="hljs-number">24.120000</span>  <span class="hljs-number">45.35</span></span><br><span class="line">Thur No          <span class="hljs-number">45</span>  <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.266312</span>         <span class="hljs-number">45</span>  <span class="hljs-number">17.113111</span>  <span class="hljs-number">41.19</span></span><br><span class="line">     Yes         <span class="hljs-number">17</span>  <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.241255</span>         <span class="hljs-number">17</span>  <span class="hljs-number">19.190588</span>  <span class="hljs-number">43.11</span></span><br></pre></td></tr></table></figure>

<p>如你所见，结果DataFrame拥有层次化的列，这相当于分别对各列进行聚合，然后用concat将结果组装到一起，使用列名用作keys参数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: result[<span class="hljs-string">'tip_pct'</span>]</span><br><span class="line">Out[<span class="hljs-number">68</span>]: </span><br><span class="line">             count      mean       max</span><br><span class="line">day  smoker                           </span><br><span class="line">Fri  No          <span class="hljs-number">4</span>  <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.187735</span></span><br><span class="line">     Yes        <span class="hljs-number">15</span>  <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.263480</span></span><br><span class="line">Sat  No         <span class="hljs-number">45</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.291990</span></span><br><span class="line">     Yes        <span class="hljs-number">42</span>  <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.325733</span></span><br><span class="line">Sun  No         <span class="hljs-number">57</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.252672</span></span><br><span class="line">     Yes        <span class="hljs-number">19</span>  <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.710345</span></span><br><span class="line">Thur No         <span class="hljs-number">45</span>  <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.266312</span></span><br><span class="line">     Yes        <span class="hljs-number">17</span>  <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.241255</span></span><br></pre></td></tr></table></figure>

<p>跟前面一样，这里也可以传入带有自定义名称的一组元组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: ftuples = [(<span class="hljs-string">'Durchschnitt'</span>, <span class="hljs-string">'mean'</span>),(<span class="hljs-string">'Abweichung'</span>, np.var)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: grouped[<span class="hljs-string">'tip_pct'</span>, <span class="hljs-string">'total_bill'</span>].agg(ftuples)</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">                 tip_pct              total_bill            </span><br><span class="line">            Durchschnitt Abweichung Durchschnitt  Abweichung</span><br><span class="line">day  smoker                                                 </span><br><span class="line">Fri  No         <span class="hljs-number">0.151650</span>   <span class="hljs-number">0.000791</span>    <span class="hljs-number">18.420000</span>   <span class="hljs-number">25.596333</span></span><br><span class="line">     Yes        <span class="hljs-number">0.174783</span>   <span class="hljs-number">0.002631</span>    <span class="hljs-number">16.813333</span>   <span class="hljs-number">82.562438</span></span><br><span class="line">Sat  No         <span class="hljs-number">0.158048</span>   <span class="hljs-number">0.001581</span>    <span class="hljs-number">19.661778</span>   <span class="hljs-number">79.908965</span></span><br><span class="line">     Yes        <span class="hljs-number">0.147906</span>   <span class="hljs-number">0.003767</span>    <span class="hljs-number">21.276667</span>  <span class="hljs-number">101.387535</span></span><br><span class="line">Sun  No         <span class="hljs-number">0.160113</span>   <span class="hljs-number">0.001793</span>    <span class="hljs-number">20.506667</span>   <span class="hljs-number">66.099980</span></span><br><span class="line">     Yes        <span class="hljs-number">0.187250</span>   <span class="hljs-number">0.023757</span>    <span class="hljs-number">24.120000</span>  <span class="hljs-number">109.046044</span></span><br><span class="line">Thur No         <span class="hljs-number">0.160298</span>   <span class="hljs-number">0.001503</span>    <span class="hljs-number">17.113111</span>   <span class="hljs-number">59.625081</span></span><br><span class="line">     Yes        <span class="hljs-number">0.163863</span>   <span class="hljs-number">0.001551</span>    <span class="hljs-number">19.190588</span>   <span class="hljs-number">69.808518</span></span><br></pre></td></tr></table></figure>

<p>现在，假设你想要对一个列或不同的列应用不同的函数。具体的办法是向agg传入一个从列名映射到函数的字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">71</span>]: grouped.agg(&#123;<span class="hljs-string">'tip'</span> : np.max, <span class="hljs-string">'size'</span> : <span class="hljs-string">'sum'</span>&#125;)</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line">               tip  size</span><br><span class="line">day  smoker             </span><br><span class="line">Fri  No       <span class="hljs-number">3.50</span>     <span class="hljs-number">9</span></span><br><span class="line">     Yes      <span class="hljs-number">4.73</span>    <span class="hljs-number">31</span></span><br><span class="line">Sat  No       <span class="hljs-number">9.00</span>   <span class="hljs-number">115</span></span><br><span class="line">     Yes     <span class="hljs-number">10.00</span>   <span class="hljs-number">104</span></span><br><span class="line">Sun  No       <span class="hljs-number">6.00</span>   <span class="hljs-number">167</span></span><br><span class="line">     Yes      <span class="hljs-number">6.50</span>    <span class="hljs-number">49</span></span><br><span class="line">Thur No       <span class="hljs-number">6.70</span>   <span class="hljs-number">112</span></span><br><span class="line">     Yes      <span class="hljs-number">5.00</span>    <span class="hljs-number">40</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: grouped.agg(&#123;<span class="hljs-string">'tip_pct'</span> : [<span class="hljs-string">'min'</span>, <span class="hljs-string">'max'</span>, <span class="hljs-string">'mean'</span>, <span class="hljs-string">'std'</span>],</span><br><span class="line">   ....:              <span class="hljs-string">'size'</span> : <span class="hljs-string">'sum'</span>&#125;)</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line">              tip_pct                               size</span><br><span class="line">                  min       max      mean       std  sum</span><br><span class="line">day  smoker                                             </span><br><span class="line">Fri  No      <span class="hljs-number">0.120385</span>  <span class="hljs-number">0.187735</span>  <span class="hljs-number">0.151650</span>  <span class="hljs-number">0.028123</span>    <span class="hljs-number">9</span></span><br><span class="line">     Yes     <span class="hljs-number">0.103555</span>  <span class="hljs-number">0.263480</span>  <span class="hljs-number">0.174783</span>  <span class="hljs-number">0.051293</span>   <span class="hljs-number">31</span></span><br><span class="line">Sat  No      <span class="hljs-number">0.056797</span>  <span class="hljs-number">0.291990</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.039767</span>  <span class="hljs-number">115</span></span><br><span class="line">     Yes     <span class="hljs-number">0.035638</span>  <span class="hljs-number">0.325733</span>  <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.061375</span>  <span class="hljs-number">104</span></span><br><span class="line">Sun  No      <span class="hljs-number">0.059447</span>  <span class="hljs-number">0.252672</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.042347</span>  <span class="hljs-number">167</span></span><br><span class="line">     Yes     <span class="hljs-number">0.065660</span>  <span class="hljs-number">0.710345</span>  <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.154134</span>   <span class="hljs-number">49</span></span><br><span class="line">Thur No      <span class="hljs-number">0.072961</span>  <span class="hljs-number">0.266312</span>  <span class="hljs-number">0.160298</span>  <span class="hljs-number">0.038774</span>  <span class="hljs-number">112</span></span><br><span class="line">     Yes     <span class="hljs-number">0.090014</span>  <span class="hljs-number">0.241255</span>  <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.039389</span>   <span class="hljs-number">40</span></span><br></pre></td></tr></table></figure>

<p>只有将多个函数应用到至少一列时，DataFrame才会拥有层次化的列。</p>
<h2 id="以“没有行索引”的形式返回聚合数据"><a href="#以“没有行索引”的形式返回聚合数据" class="headerlink" title="以“没有行索引”的形式返回聚合数据"></a>以“没有行索引”的形式返回聚合数据</h2><p>到目前为止，所有示例中的聚合数据都有由唯一的分组键组成的索引（可能还是层次化的）。由于并不总是需要如此，所以你可以向groupby传入as_index=False以禁用该功能：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: tips.groupby([<span class="hljs-string">'day'</span>, <span class="hljs-string">'smoker'</span>], as_index=<span class="hljs-literal">False</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">73</span>]: </span><br><span class="line">    day smoker  total_bill       tip      size   tip_pct</span><br><span class="line"><span class="hljs-number">0</span>   Fri     No   <span class="hljs-number">18.420000</span>  <span class="hljs-number">2.812500</span>  <span class="hljs-number">2.250000</span>  <span class="hljs-number">0.151650</span></span><br><span class="line"><span class="hljs-number">1</span>   Fri    Yes   <span class="hljs-number">16.813333</span>  <span class="hljs-number">2.714000</span>  <span class="hljs-number">2.066667</span>  <span class="hljs-number">0.174783</span></span><br><span class="line"><span class="hljs-number">2</span>   Sat     No   <span class="hljs-number">19.661778</span>  <span class="hljs-number">3.102889</span>  <span class="hljs-number">2.555556</span>  <span class="hljs-number">0.158048</span></span><br><span class="line"><span class="hljs-number">3</span>   Sat    Yes   <span class="hljs-number">21.276667</span>  <span class="hljs-number">2.875476</span>  <span class="hljs-number">2.476190</span>  <span class="hljs-number">0.147906</span></span><br><span class="line"><span class="hljs-number">4</span>   Sun     No   <span class="hljs-number">20.506667</span>  <span class="hljs-number">3.167895</span>  <span class="hljs-number">2.929825</span>  <span class="hljs-number">0.160113</span></span><br><span class="line"><span class="hljs-number">5</span>   Sun    Yes   <span class="hljs-number">24.120000</span>  <span class="hljs-number">3.516842</span>  <span class="hljs-number">2.578947</span>  <span class="hljs-number">0.187250</span></span><br><span class="line"><span class="hljs-number">6</span>  Thur     No   <span class="hljs-number">17.113111</span>  <span class="hljs-number">2.673778</span>  <span class="hljs-number">2.488889</span>  <span class="hljs-number">0.160298</span></span><br><span class="line"><span class="hljs-number">7</span>  Thur    Yes   <span class="hljs-number">19.190588</span>  <span class="hljs-number">3.030000</span>  <span class="hljs-number">2.352941</span>  <span class="hljs-number">0.163863</span></span><br></pre></td></tr></table></figure>

<p>当然，对结果调用reset_index也能得到这种形式的结果。使用as_index=False方法可以避免一些不必要的计算。</p>
<h1 id="10-3-apply：一般性的“拆分－应用－合并”"><a href="#10-3-apply：一般性的“拆分－应用－合并”" class="headerlink" title="10.3 apply：一般性的“拆分－应用－合并”"></a>10.3 apply：一般性的“拆分－应用－合并”</h1><p>最通用的GroupBy方法是apply，本节剩余部分将重点讲解它。如图10-2所示，apply会将待处理的对象拆分成多个片段，然后对各片段调用传入的函数，最后尝试将各片段组合到一起。</p>
<p><img src="/images/blog/7178691-7e8bb217f599b4ae.webp" alt="img"></p>
<p>图10-2 分组聚合示例</p>
<p>回到之前那个小费数据集，假设你想要根据分组选出最高的5个tip_pct值。首先，编写一个选取指定列具有最大值的行的函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">top</span><span class="hljs-params">(df, n=<span class="hljs-number">5</span>, column=<span class="hljs-string">'tip_pct'</span>)</span>:</span></span><br><span class="line">   ....:     <span class="hljs-keyword">return</span> df.sort_values(by=column)[-n:]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">75</span>]: top(tips, n=<span class="hljs-number">6</span>)</span><br><span class="line">Out[<span class="hljs-number">75</span>]: </span><br><span class="line">     total_bill   tip smoker  day    time  size   tip_pct</span><br><span class="line"><span class="hljs-number">109</span>       <span class="hljs-number">14.31</span>  <span class="hljs-number">4.00</span>    Yes  Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.279525</span></span><br><span class="line"><span class="hljs-number">183</span>       <span class="hljs-number">23.17</span>  <span class="hljs-number">6.50</span>    Yes  Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.280535</span></span><br><span class="line"><span class="hljs-number">232</span>       <span class="hljs-number">11.61</span>  <span class="hljs-number">3.39</span>     No  Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.291990</span></span><br><span class="line"><span class="hljs-number">67</span>         <span class="hljs-number">3.07</span>  <span class="hljs-number">1.00</span>    Yes  Sat  Dinner     <span class="hljs-number">1</span>  <span class="hljs-number">0.325733</span></span><br><span class="line"><span class="hljs-number">178</span>        <span class="hljs-number">9.60</span>  <span class="hljs-number">4.00</span>    Yes  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.416667</span></span><br><span class="line"><span class="hljs-number">172</span>        <span class="hljs-number">7.25</span>  <span class="hljs-number">5.15</span>    Yes  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.710345</span></span><br></pre></td></tr></table></figure>

<p>现在，如果对smoker分组并用该函数调用apply，就会得到：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">76</span>]: tips.groupby(<span class="hljs-string">'smoker'</span>).apply(top)</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">            total_bill   tip smoker   day    time  size   tip_pct</span><br><span class="line">smoker                                                           </span><br><span class="line">No     <span class="hljs-number">88</span>        <span class="hljs-number">24.71</span>  <span class="hljs-number">5.85</span>     No  Thur   Lunch     <span class="hljs-number">2</span>  <span class="hljs-number">0.236746</span></span><br><span class="line">       <span class="hljs-number">185</span>       <span class="hljs-number">20.69</span>  <span class="hljs-number">5.00</span>     No   Sun  Dinner     <span class="hljs-number">5</span>  <span class="hljs-number">0.241663</span></span><br><span class="line">       <span class="hljs-number">51</span>        <span class="hljs-number">10.29</span>  <span class="hljs-number">2.60</span>     No   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.252672</span></span><br><span class="line">       <span class="hljs-number">149</span>        <span class="hljs-number">7.51</span>  <span class="hljs-number">2.00</span>     No  Thur   Lunch     <span class="hljs-number">2</span>  <span class="hljs-number">0.266312</span></span><br><span class="line">       <span class="hljs-number">232</span>       <span class="hljs-number">11.61</span>  <span class="hljs-number">3.39</span>     No   Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.291990</span></span><br><span class="line">Yes    <span class="hljs-number">109</span>       <span class="hljs-number">14.31</span>  <span class="hljs-number">4.00</span>    Yes   Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.279525</span></span><br><span class="line">       <span class="hljs-number">183</span>       <span class="hljs-number">23.17</span>  <span class="hljs-number">6.50</span>    Yes   Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.280535</span></span><br><span class="line">       <span class="hljs-number">67</span>         <span class="hljs-number">3.07</span>  <span class="hljs-number">1.00</span>    Yes   Sat  Dinner     <span class="hljs-number">1</span>  <span class="hljs-number">0.325733</span></span><br><span class="line">       <span class="hljs-number">178</span>        <span class="hljs-number">9.60</span>  <span class="hljs-number">4.00</span>    Yes   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.416667</span></span><br><span class="line">       <span class="hljs-number">172</span>        <span class="hljs-number">7.25</span>  <span class="hljs-number">5.15</span>    Yes   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.710345</span></span><br></pre></td></tr></table></figure>

<p>这里发生了什么？top函数在DataFrame的各个片段上调用，然后结果由pandas.concat组装到一起，并以分组名称进行了标记。于是，最终结果就有了一个层次化索引，其内层索引值来自原DataFrame。</p>
<p>如果传给apply的函数能够接受其他参数或关键字，则可以将这些内容放在函数名后面一并传入：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">77</span>]: tips.groupby([<span class="hljs-string">'smoker'</span>, <span class="hljs-string">'day'</span>]).apply(top, n=<span class="hljs-number">1</span>, column=<span class="hljs-string">'total_bill'</span>)</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">                 total_bill    tip smoker   day    time  size   tip_pct</span><br><span class="line">smoker day                                                             </span><br><span class="line">No     Fri  <span class="hljs-number">94</span>        <span class="hljs-number">22.75</span>   <span class="hljs-number">3.25</span>     No   Fri  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.142857</span></span><br><span class="line">       Sat  <span class="hljs-number">212</span>       <span class="hljs-number">48.33</span>   <span class="hljs-number">9.00</span>     No   Sat  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.186220</span></span><br><span class="line">       Sun  <span class="hljs-number">156</span>       <span class="hljs-number">48.17</span>   <span class="hljs-number">5.00</span>     No   Sun  Dinner     <span class="hljs-number">6</span>  <span class="hljs-number">0.103799</span></span><br><span class="line">       Thur <span class="hljs-number">142</span>       <span class="hljs-number">41.19</span>   <span class="hljs-number">5.00</span>     No  Thur   Lunch     <span class="hljs-number">5</span>  <span class="hljs-number">0.121389</span></span><br><span class="line">Yes    Fri  <span class="hljs-number">95</span>        <span class="hljs-number">40.17</span>   <span class="hljs-number">4.73</span>    Yes   Fri  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.117750</span></span><br><span class="line">       Sat  <span class="hljs-number">170</span>       <span class="hljs-number">50.81</span>  <span class="hljs-number">10.00</span>    Yes   Sat  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.196812</span></span><br><span class="line">       Sun  <span class="hljs-number">182</span>       <span class="hljs-number">45.35</span>   <span class="hljs-number">3.50</span>    Yes   Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.077178</span></span><br><span class="line">       Thur <span class="hljs-number">197</span>       <span class="hljs-number">43.11</span>   <span class="hljs-number">5.00</span>    Yes  Thur   Lunch     <span class="hljs-number">4</span>  <span class="hljs-number">0.115982</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：除这些基本用法之外，能否充分发挥apply的威力很大程度上取决于你的创造力。传入的那个函数能做什么全由你说了算，它只需返回一个pandas对象或标量值即可。本章后续部分的示例主要用于讲解如何利用groupby解决各种各样的问题。</p>
</blockquote>
<p>可能你已经想起来了，之前我在GroupBy对象上调用过describe：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">78</span>]: result = tips.groupby(<span class="hljs-string">'smoker'</span>)[<span class="hljs-string">'tip_pct'</span>].describe()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">79</span>]: result</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line">        count      mean       std       min       <span class="hljs-number">25</span>%       <span class="hljs-number">50</span>%       <span class="hljs-number">75</span>%  \</span><br><span class="line">smoker                                                                      </span><br><span class="line">No      <span class="hljs-number">151.0</span>  <span class="hljs-number">0.159328</span>  <span class="hljs-number">0.039910</span>  <span class="hljs-number">0.056797</span>  <span class="hljs-number">0.136906</span>  <span class="hljs-number">0.155625</span>  <span class="hljs-number">0.185014</span>   </span><br><span class="line">Yes      <span class="hljs-number">93.0</span>  <span class="hljs-number">0.163196</span>  <span class="hljs-number">0.085119</span>  <span class="hljs-number">0.035638</span>  <span class="hljs-number">0.106771</span>  <span class="hljs-number">0.153846</span>  <span class="hljs-number">0.195059</span>   </span><br><span class="line">             max  </span><br><span class="line">smoker</span><br><span class="line"></span><br><span class="line">No      <span class="hljs-number">0.291990</span>  </span><br><span class="line">Yes     <span class="hljs-number">0.710345</span>  </span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">80</span>]: result.unstack(<span class="hljs-string">'smoker'</span>)</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">       smoker</span><br><span class="line">count  No        <span class="hljs-number">151.000000</span></span><br><span class="line">       Yes        <span class="hljs-number">93.000000</span></span><br><span class="line">mean   No          <span class="hljs-number">0.159328</span></span><br><span class="line">       Yes         <span class="hljs-number">0.163196</span></span><br><span class="line">std    No          <span class="hljs-number">0.039910</span></span><br><span class="line">       Yes         <span class="hljs-number">0.085119</span></span><br><span class="line">min    No          <span class="hljs-number">0.056797</span></span><br><span class="line">       Yes         <span class="hljs-number">0.035638</span></span><br><span class="line"><span class="hljs-number">25</span>%    No          <span class="hljs-number">0.136906</span></span><br><span class="line">       Yes         <span class="hljs-number">0.106771</span></span><br><span class="line"><span class="hljs-number">50</span>%    No          <span class="hljs-number">0.155625</span></span><br><span class="line">       Yes         <span class="hljs-number">0.153846</span></span><br><span class="line"><span class="hljs-number">75</span>%    No          <span class="hljs-number">0.185014</span></span><br><span class="line">       Yes         <span class="hljs-number">0.195059</span></span><br><span class="line">max    No          <span class="hljs-number">0.291990</span></span><br><span class="line">       Yes         <span class="hljs-number">0.710345</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>在GroupBy中，当你调用诸如describe之类的方法时，实际上只是应用了下面两条代码的快捷方式而已：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">f = <span class="hljs-keyword">lambda</span> x: x.describe()</span><br><span class="line">grouped.apply(f)</span><br></pre></td></tr></table></figure>

<h2 id="禁止分组键"><a href="#禁止分组键" class="headerlink" title="禁止分组键"></a>禁止分组键</h2><p>从上面的例子中可以看出，分组键会跟原始对象的索引共同构成结果对象中的层次化索引。将group_keys=False传入groupby即可禁止该效果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">81</span>]: tips.groupby(<span class="hljs-string">'smoker'</span>, group_keys=<span class="hljs-literal">False</span>).apply(top)</span><br><span class="line">Out[<span class="hljs-number">81</span>]: </span><br><span class="line">     total_bill   tip smoker   day    time  size   tip_pct</span><br><span class="line"><span class="hljs-number">88</span>        <span class="hljs-number">24.71</span>  <span class="hljs-number">5.85</span>     No  Thur   Lunch     <span class="hljs-number">2</span>  <span class="hljs-number">0.236746</span></span><br><span class="line"><span class="hljs-number">185</span>       <span class="hljs-number">20.69</span>  <span class="hljs-number">5.00</span>     No   Sun  Dinner     <span class="hljs-number">5</span>  <span class="hljs-number">0.241663</span></span><br><span class="line"><span class="hljs-number">51</span>        <span class="hljs-number">10.29</span>  <span class="hljs-number">2.60</span>     No   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.252672</span></span><br><span class="line"><span class="hljs-number">149</span>        <span class="hljs-number">7.51</span>  <span class="hljs-number">2.00</span>     No  Thur   Lunch     <span class="hljs-number">2</span>  <span class="hljs-number">0.266312</span></span><br><span class="line"><span class="hljs-number">232</span>       <span class="hljs-number">11.61</span>  <span class="hljs-number">3.39</span>     No   Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.291990</span></span><br><span class="line"><span class="hljs-number">109</span>       <span class="hljs-number">14.31</span>  <span class="hljs-number">4.00</span>    Yes   Sat  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.279525</span></span><br><span class="line"><span class="hljs-number">183</span>       <span class="hljs-number">23.17</span>  <span class="hljs-number">6.50</span>    Yes   Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.280535</span></span><br><span class="line"><span class="hljs-number">67</span>         <span class="hljs-number">3.07</span>  <span class="hljs-number">1.00</span>    Yes   Sat  Dinner     <span class="hljs-number">1</span>  <span class="hljs-number">0.325733</span></span><br><span class="line"><span class="hljs-number">178</span>        <span class="hljs-number">9.60</span>  <span class="hljs-number">4.00</span>    Yes   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.416667</span></span><br><span class="line"><span class="hljs-number">172</span>        <span class="hljs-number">7.25</span>  <span class="hljs-number">5.15</span>    Yes   Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.710345</span></span><br></pre></td></tr></table></figure>

<h2 id="分位数和桶分析"><a href="#分位数和桶分析" class="headerlink" title="分位数和桶分析"></a>分位数和桶分析</h2><p>我曾在第8章中讲过，pandas有一些能根据指定面元或样本分位数将数据拆分成多块的工具（比如cut和qcut）。将这些函数跟groupby结合起来，就能非常轻松地实现对数据集的桶（bucket）或分位数（quantile）分析了。以下面这个简单的随机数据集为例，我们利用cut将其装入长度相等的桶中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: frame = pd.DataFrame(&#123;<span class="hljs-string">'data1'</span>: np.random.randn(<span class="hljs-number">1000</span>),</span><br><span class="line">   ....:                       <span class="hljs-string">'data2'</span>: np.random.randn(<span class="hljs-number">1000</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: quartiles = pd.cut(frame.data1, <span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: quartiles[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">84</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]</span><br><span class="line"><span class="hljs-number">1</span>    (<span class="hljs-number">-2.956</span>, <span class="hljs-number">-1.23</span>]</span><br><span class="line"><span class="hljs-number">2</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]</span><br><span class="line"><span class="hljs-number">3</span>     (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]</span><br><span class="line"><span class="hljs-number">4</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]</span><br><span class="line"><span class="hljs-number">5</span>     (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]</span><br><span class="line"><span class="hljs-number">6</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]</span><br><span class="line"><span class="hljs-number">7</span>     (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]</span><br><span class="line"><span class="hljs-number">8</span>     (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]</span><br><span class="line"><span class="hljs-number">9</span>     (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]</span><br><span class="line">Name: data1, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">-2.956</span>, <span class="hljs-number">-1.23</span>] &lt; (<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>] &lt; (<span class="hljs-number">0.489</span>, <span class="hljs-number">2.</span></span><br><span class="line"><span class="hljs-number">208</span>] &lt; (<span class="hljs-number">2.208</span>, <span class="hljs-number">3.928</span>]]</span><br></pre></td></tr></table></figure>

<p>由cut返回的Categorical对象可直接传递到groupby。因此，我们可以像下面这样对data2列做一些统计计算：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_stats</span><span class="hljs-params">(group)</span>:</span></span><br><span class="line">   ....:     <span class="hljs-keyword">return</span> &#123;<span class="hljs-string">'min'</span>: group.min(), <span class="hljs-string">'max'</span>: group.max(),</span><br><span class="line">   ....:             <span class="hljs-string">'count'</span>: group.count(), <span class="hljs-string">'mean'</span>: group.mean()&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: grouped = frame.data2.groupby(quartiles)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">87</span>]: grouped.apply(get_stats).unstack()</span><br><span class="line">Out[<span class="hljs-number">87</span>]: </span><br><span class="line">                 count       max      mean       min</span><br><span class="line">data1                                               </span><br><span class="line">(<span class="hljs-number">-2.956</span>, <span class="hljs-number">-1.23</span>]   <span class="hljs-number">95.0</span>  <span class="hljs-number">1.670835</span> <span class="hljs-number">-0.039521</span> <span class="hljs-number">-3.399312</span></span><br><span class="line">(<span class="hljs-number">-1.23</span>, <span class="hljs-number">0.489</span>]   <span class="hljs-number">598.0</span>  <span class="hljs-number">3.260383</span> <span class="hljs-number">-0.002051</span> <span class="hljs-number">-2.989741</span></span><br><span class="line">(<span class="hljs-number">0.489</span>, <span class="hljs-number">2.208</span>]   <span class="hljs-number">297.0</span>  <span class="hljs-number">2.954439</span>  <span class="hljs-number">0.081822</span> <span class="hljs-number">-3.745356</span></span><br><span class="line">(<span class="hljs-number">2.208</span>, <span class="hljs-number">3.928</span>]    <span class="hljs-number">10.0</span>  <span class="hljs-number">1.765640</span>  <span class="hljs-number">0.024750</span> <span class="hljs-number">-1.929776</span></span><br></pre></td></tr></table></figure>

<p>这些都是长度相等的桶。要根据样本分位数得到大小相等的桶，使用qcut即可。传入labels=False即可只获取分位数的编号：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Return quantile numbers</span></span><br><span class="line">In [<span class="hljs-number">88</span>]: grouping = pd.qcut(frame.data1, <span class="hljs-number">10</span>, labels=<span class="hljs-literal">False</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: grouped = frame.data2.groupby(grouping)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: grouped.apply(get_stats).unstack()</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">       count       max      mean       min</span><br><span class="line">data1                                     </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">1.670835</span> <span class="hljs-number">-0.049902</span> <span class="hljs-number">-3.399312</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.628441</span>  <span class="hljs-number">0.030989</span> <span class="hljs-number">-1.950098</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.527939</span> <span class="hljs-number">-0.067179</span> <span class="hljs-number">-2.925113</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">3.260383</span>  <span class="hljs-number">0.065713</span> <span class="hljs-number">-2.315555</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.074345</span> <span class="hljs-number">-0.111653</span> <span class="hljs-number">-2.047939</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.184810</span>  <span class="hljs-number">0.052130</span> <span class="hljs-number">-2.989741</span></span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.458842</span> <span class="hljs-number">-0.021489</span> <span class="hljs-number">-2.223506</span></span><br><span class="line"><span class="hljs-number">7</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.954439</span> <span class="hljs-number">-0.026459</span> <span class="hljs-number">-3.056990</span></span><br><span class="line"><span class="hljs-number">8</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.735527</span>  <span class="hljs-number">0.103406</span> <span class="hljs-number">-3.745356</span></span><br><span class="line"><span class="hljs-number">9</span>      <span class="hljs-number">100.0</span>  <span class="hljs-number">2.377020</span>  <span class="hljs-number">0.220122</span> <span class="hljs-number">-2.064111</span></span><br></pre></td></tr></table></figure>

<p>我们会在第12章详细讲解pandas的Categorical类型。</p>
<h2 id="示例：用特定于分组的值填充缺失值"><a href="#示例：用特定于分组的值填充缺失值" class="headerlink" title="示例：用特定于分组的值填充缺失值"></a>示例：用特定于分组的值填充缺失值</h2><p>对于缺失数据的清理工作，有时你会用dropna将其替换掉，而有时则可能会希望用一个固定值或由数据集本身所衍生出来的值去填充NA值。这时就得使用fillna这个工具了。在下面这个例子中，我用平均值去填充NA值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: s = pd.Series(np.random.randn(<span class="hljs-number">6</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: s[::<span class="hljs-number">2</span>] = np.nan</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: s</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line"><span class="hljs-number">0</span>         NaN</span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">-0.125921</span></span><br><span class="line"><span class="hljs-number">2</span>         NaN</span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">-0.884475</span></span><br><span class="line"><span class="hljs-number">4</span>         NaN</span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">0.227290</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">94</span>]: s.fillna(s.mean())</span><br><span class="line">Out[<span class="hljs-number">94</span>]: </span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">-0.261035</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">-0.125921</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">-0.261035</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">-0.884475</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">-0.261035</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">0.227290</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>假设你需要对不同的分组填充不同的值。一种方法是将数据分组，并使用apply和一个能够对各数据块调用fillna的函数即可。下面是一些有关美国几个州的示例数据，这些州又被分为东部和西部：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">95</span>]: states = [<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'New York'</span>, <span class="hljs-string">'Vermont'</span>, <span class="hljs-string">'Florida'</span>,</span><br><span class="line">   ....:           <span class="hljs-string">'Oregon'</span>, <span class="hljs-string">'Nevada'</span>, <span class="hljs-string">'California'</span>, <span class="hljs-string">'Idaho'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">96</span>]: group_key = [<span class="hljs-string">'East'</span>] * <span class="hljs-number">4</span> + [<span class="hljs-string">'West'</span>] * <span class="hljs-number">4</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: data = pd.Series(np.random.randn(<span class="hljs-number">8</span>), index=states)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: data</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">Ohio          <span class="hljs-number">0.922264</span></span><br><span class="line">New York     <span class="hljs-number">-2.153545</span></span><br><span class="line">Vermont      <span class="hljs-number">-0.365757</span></span><br><span class="line">Florida      <span class="hljs-number">-0.375842</span></span><br><span class="line">Oregon        <span class="hljs-number">0.329939</span></span><br><span class="line">Nevada        <span class="hljs-number">0.981994</span></span><br><span class="line">California    <span class="hljs-number">1.105913</span></span><br><span class="line">Idaho        <span class="hljs-number">-1.613716</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>[‘East’] * 4产生了一个列表，包括了[‘East’]中元素的四个拷贝。将这些列表串联起来。</p>
<p>将一些值设为缺失：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">99</span>]: data[[<span class="hljs-string">'Vermont'</span>, <span class="hljs-string">'Nevada'</span>, <span class="hljs-string">'Idaho'</span>]] = np.nan</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: data</span><br><span class="line">Out[<span class="hljs-number">100</span>]: </span><br><span class="line">Ohio          <span class="hljs-number">0.922264</span></span><br><span class="line">New York     <span class="hljs-number">-2.153545</span></span><br><span class="line">Vermont            NaN</span><br><span class="line">Florida      <span class="hljs-number">-0.375842</span></span><br><span class="line">Oregon        <span class="hljs-number">0.329939</span></span><br><span class="line">Nevada             NaN</span><br><span class="line">California    <span class="hljs-number">1.105913</span></span><br><span class="line">Idaho              NaN</span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">101</span>]: data.groupby(group_key).mean()</span><br><span class="line">Out[<span class="hljs-number">101</span>]: </span><br><span class="line">East   <span class="hljs-number">-0.535707</span></span><br><span class="line">West    <span class="hljs-number">0.717926</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>我们可以用分组平均值去填充NA值:</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">102</span>]: fill_mean = <span class="hljs-keyword">lambda</span> g: g.fillna(g.mean())</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: data.groupby(group_key).apply(fill_mean)</span><br><span class="line">Out[<span class="hljs-number">103</span>]: </span><br><span class="line">Ohio          <span class="hljs-number">0.922264</span></span><br><span class="line">New York     <span class="hljs-number">-2.153545</span></span><br><span class="line">Vermont      <span class="hljs-number">-0.535707</span></span><br><span class="line">Florida      <span class="hljs-number">-0.375842</span></span><br><span class="line">Oregon        <span class="hljs-number">0.329939</span></span><br><span class="line">Nevada        <span class="hljs-number">0.717926</span></span><br><span class="line">California    <span class="hljs-number">1.105913</span></span><br><span class="line">Idaho         <span class="hljs-number">0.717926</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>另外，也可以在代码中预定义各组的填充值。由于分组具有一个name属性，所以我们可以拿来用一下：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">104</span>]: fill_values = &#123;<span class="hljs-string">'East'</span>: <span class="hljs-number">0.5</span>, <span class="hljs-string">'West'</span>: <span class="hljs-number">-1</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">105</span>]: fill_func = <span class="hljs-keyword">lambda</span> g: g.fillna(fill_values[g.name])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: data.groupby(group_key).apply(fill_func)</span><br><span class="line">Out[<span class="hljs-number">106</span>]: </span><br><span class="line">Ohio          <span class="hljs-number">0.922264</span></span><br><span class="line">New York     <span class="hljs-number">-2.153545</span></span><br><span class="line">Vermont       <span class="hljs-number">0.500000</span></span><br><span class="line">Florida      <span class="hljs-number">-0.375842</span></span><br><span class="line">Oregon        <span class="hljs-number">0.329939</span></span><br><span class="line">Nevada       <span class="hljs-number">-1.000000</span></span><br><span class="line">California    <span class="hljs-number">1.105913</span></span><br><span class="line">Idaho        <span class="hljs-number">-1.000000</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="示例：随机采样和排列"><a href="#示例：随机采样和排列" class="headerlink" title="示例：随机采样和排列"></a>示例：随机采样和排列</h2><p>假设你想要从一个大数据集中随机抽取（进行替换或不替换）样本以进行蒙特卡罗模拟（Monte Carlo simulation）或其他分析工作。“抽取”的方式有很多，这里使用的方法是对Series使用sample方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Hearts, Spades, Clubs, Diamonds</span></span><br><span class="line">suits = [<span class="hljs-string">'H'</span>, <span class="hljs-string">'S'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>]</span><br><span class="line">card_val = (list(range(<span class="hljs-number">1</span>, <span class="hljs-number">11</span>)) + [<span class="hljs-number">10</span>] * <span class="hljs-number">3</span>) * <span class="hljs-number">4</span></span><br><span class="line">base_names = [<span class="hljs-string">'A'</span>] + list(range(<span class="hljs-number">2</span>, <span class="hljs-number">11</span>)) + [<span class="hljs-string">'J'</span>, <span class="hljs-string">'K'</span>, <span class="hljs-string">'Q'</span>]</span><br><span class="line">cards = []</span><br><span class="line"><span class="hljs-keyword">for</span> suit <span class="hljs-keyword">in</span> [<span class="hljs-string">'H'</span>, <span class="hljs-string">'S'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>]:</span><br><span class="line">    cards.extend(str(num) + suit <span class="hljs-keyword">for</span> num <span class="hljs-keyword">in</span> base_names)</span><br><span class="line"></span><br><span class="line">deck = pd.Series(card_val, index=cards)</span><br></pre></td></tr></table></figure>

<p>现在我有了一个长度为52的Series，其索引包括牌名，值则是21点或其他游戏中用于计分的点数（为了简单起见，我当A的点数为1）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: deck[:<span class="hljs-number">13</span>]</span><br><span class="line">Out[<span class="hljs-number">108</span>]: </span><br><span class="line">AH      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>H      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>H      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>H      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">5</span>H      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">6</span>H      <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">7</span>H      <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">8</span>H      <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">9</span>H      <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">10</span>H    <span class="hljs-number">10</span></span><br><span class="line">JH     <span class="hljs-number">10</span></span><br><span class="line">KH     <span class="hljs-number">10</span></span><br><span class="line">QH     <span class="hljs-number">10</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>现在，根据我上面所讲的，从整副牌中抽出5张，代码如下：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">draw</span><span class="hljs-params">(deck, n=<span class="hljs-number">5</span>)</span>:</span></span><br><span class="line">   .....:     <span class="hljs-keyword">return</span> deck.sample(n)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: draw(deck)</span><br><span class="line">Out[<span class="hljs-number">110</span>]: </span><br><span class="line">AD     <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">8</span>C     <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">5</span>H     <span class="hljs-number">5</span></span><br><span class="line">KC    <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">2</span>C     <span class="hljs-number">2</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>假设你想要从每种花色中随机抽取两张牌。由于花色是牌名的最后一个字符，所以我们可以据此进行分组，并使用apply：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">111</span>]: get_suit = <span class="hljs-keyword">lambda</span> card: card[<span class="hljs-number">-1</span>] <span class="hljs-comment"># last letter is suit</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: deck.groupby(get_suit).apply(draw, n=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">112</span>]: </span><br><span class="line">C  <span class="hljs-number">2</span>C     <span class="hljs-number">2</span></span><br><span class="line">   <span class="hljs-number">3</span>C     <span class="hljs-number">3</span></span><br><span class="line">D  KD    <span class="hljs-number">10</span></span><br><span class="line">   <span class="hljs-number">8</span>D     <span class="hljs-number">8</span></span><br><span class="line">H  KH    <span class="hljs-number">10</span></span><br><span class="line">   <span class="hljs-number">3</span>H     <span class="hljs-number">3</span></span><br><span class="line">S  <span class="hljs-number">2</span>S     <span class="hljs-number">2</span></span><br><span class="line">   <span class="hljs-number">4</span>S     <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>或者，也可以这样写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">113</span>]: deck.groupby(get_suit, group_keys=<span class="hljs-literal">False</span>).apply(draw, n=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">113</span>]: </span><br><span class="line">KC    <span class="hljs-number">10</span></span><br><span class="line">JC    <span class="hljs-number">10</span></span><br><span class="line">AD     <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">5</span>D     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">5</span>H     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">6</span>H     <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">7</span>S     <span class="hljs-number">7</span></span><br><span class="line">KS    <span class="hljs-number">10</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h2 id="示例：分组加权平均数和相关系数"><a href="#示例：分组加权平均数和相关系数" class="headerlink" title="示例：分组加权平均数和相关系数"></a>示例：分组加权平均数和相关系数</h2><p>根据groupby的“拆分－应用－合并”范式，可以进行DataFrame的列与列之间或两个Series之间的运算（比如分组加权平均）。以下面这个数据集为例，它含有分组键、值以及一些权重值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">114</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'category'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>,</span><br><span class="line">   .....:                                 <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'data'</span>: np.random.randn(<span class="hljs-number">8</span>),</span><br><span class="line">   .....:                    <span class="hljs-string">'weights'</span>: np.random.rand(<span class="hljs-number">8</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">115</span>]: df</span><br><span class="line">Out[<span class="hljs-number">115</span>]: </span><br><span class="line">  category      data   weights</span><br><span class="line"><span class="hljs-number">0</span>        a  <span class="hljs-number">1.561587</span>  <span class="hljs-number">0.957515</span></span><br><span class="line"><span class="hljs-number">1</span>        a  <span class="hljs-number">1.219984</span>  <span class="hljs-number">0.347267</span></span><br><span class="line"><span class="hljs-number">2</span>        a <span class="hljs-number">-0.482239</span>  <span class="hljs-number">0.581362</span></span><br><span class="line"><span class="hljs-number">3</span>        a  <span class="hljs-number">0.315667</span>  <span class="hljs-number">0.217091</span></span><br><span class="line"><span class="hljs-number">4</span>        b <span class="hljs-number">-0.047852</span>  <span class="hljs-number">0.894406</span></span><br><span class="line"><span class="hljs-number">5</span>        b <span class="hljs-number">-0.454145</span>  <span class="hljs-number">0.918564</span></span><br><span class="line"><span class="hljs-number">6</span>        b <span class="hljs-number">-0.556774</span>  <span class="hljs-number">0.277825</span></span><br><span class="line"><span class="hljs-number">7</span>        b  <span class="hljs-number">0.253321</span>  <span class="hljs-number">0.955905</span></span><br></pre></td></tr></table></figure>

<p>然后可以利用category计算分组加权平均数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">116</span>]: grouped = df.groupby(<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">117</span>]: get_wavg = <span class="hljs-keyword">lambda</span> g: np.average(g[<span class="hljs-string">'data'</span>], weights=g[<span class="hljs-string">'weights'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">118</span>]: grouped.apply(get_wavg)</span><br><span class="line">Out[<span class="hljs-number">118</span>]:</span><br><span class="line">category</span><br><span class="line">a    <span class="hljs-number">0.811643</span></span><br><span class="line">b   <span class="hljs-number">-0.122262</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>另一个例子，考虑一个来自Yahoo!Finance的数据集，其中含有几只股票和标准普尔500指数（符号SPX）的收盘价：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">119</span>]: close_px = pd.read_csv(<span class="hljs-string">'examples/stock_px_2.csv'</span>, parse_dates=<span class="hljs-literal">True</span>,</span><br><span class="line">   .....:                        index_col=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">120</span>]: close_px.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">DatetimeIndex</span>:</span> <span class="hljs-number">2214</span> entries, <span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span> to <span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-14</span></span><br><span class="line">Data columns (total <span class="hljs-number">4</span> columns):</span><br><span class="line">AAPL    <span class="hljs-number">2214</span> non-null float64</span><br><span class="line">MSFT    <span class="hljs-number">2214</span> non-null float64</span><br><span class="line">XOM     <span class="hljs-number">2214</span> non-null float64</span><br><span class="line">SPX     <span class="hljs-number">2214</span> non-null float64</span><br><span class="line">dtypes: float64(<span class="hljs-number">4</span>)</span><br><span class="line">memory usage: <span class="hljs-number">86.5</span> KB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">121</span>]: close_px[<span class="hljs-number">-4</span>:]</span><br><span class="line">Out[<span class="hljs-number">121</span>]: </span><br><span class="line">              AAPL   MSFT    XOM      SPX</span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-11</span>  <span class="hljs-number">400.29</span>  <span class="hljs-number">27.00</span>  <span class="hljs-number">76.27</span>  <span class="hljs-number">1195.54</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-12</span>  <span class="hljs-number">402.19</span>  <span class="hljs-number">26.96</span>  <span class="hljs-number">77.16</span>  <span class="hljs-number">1207.25</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-13</span>  <span class="hljs-number">408.43</span>  <span class="hljs-number">27.18</span>  <span class="hljs-number">76.37</span>  <span class="hljs-number">1203.66</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-14</span>  <span class="hljs-number">422.00</span>  <span class="hljs-number">27.27</span>  <span class="hljs-number">78.11</span>  <span class="hljs-number">1224.58</span></span><br></pre></td></tr></table></figure>

<p>来做一个比较有趣的任务：计算一个由日收益率（通过百分数变化计算）与SPX之间的年度相关系数组成的DataFrame。下面是一个实现办法，我们先创建一个函数，用它计算每列和SPX列的成对相关系数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">122</span>]: spx_corr = <span class="hljs-keyword">lambda</span> x: x.corrwith(x[<span class="hljs-string">'SPX'</span>])</span><br></pre></td></tr></table></figure>

<p>接下来，我们使用pct_change计算close_px的百分比变化：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">123</span>]: rets = close_px.pct_change().dropna()</span><br></pre></td></tr></table></figure>

<p>最后，我们用年对百分比变化进行分组，可以用一个一行的函数，从每行的标签返回每个datetime标签的year属性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">124</span>]: get_year = <span class="hljs-keyword">lambda</span> x: x.year</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: by_year = rets.groupby(get_year)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">126</span>]: by_year.apply(spx_corr)</span><br><span class="line">Out[<span class="hljs-number">126</span>]: </span><br><span class="line">          AAPL      MSFT       XOM  SPX</span><br><span class="line"><span class="hljs-number">2003</span>  <span class="hljs-number">0.541124</span>  <span class="hljs-number">0.745174</span>  <span class="hljs-number">0.661265</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2004</span>  <span class="hljs-number">0.374283</span>  <span class="hljs-number">0.588531</span>  <span class="hljs-number">0.557742</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2005</span>  <span class="hljs-number">0.467540</span>  <span class="hljs-number">0.562374</span>  <span class="hljs-number">0.631010</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2006</span>  <span class="hljs-number">0.428267</span>  <span class="hljs-number">0.406126</span>  <span class="hljs-number">0.518514</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2007</span>  <span class="hljs-number">0.508118</span>  <span class="hljs-number">0.658770</span>  <span class="hljs-number">0.786264</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2008</span>  <span class="hljs-number">0.681434</span>  <span class="hljs-number">0.804626</span>  <span class="hljs-number">0.828303</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2009</span>  <span class="hljs-number">0.707103</span>  <span class="hljs-number">0.654902</span>  <span class="hljs-number">0.797921</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2010</span>  <span class="hljs-number">0.710105</span>  <span class="hljs-number">0.730118</span>  <span class="hljs-number">0.839057</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2011</span>  <span class="hljs-number">0.691931</span>  <span class="hljs-number">0.800996</span>  <span class="hljs-number">0.859975</span>  <span class="hljs-number">1.0</span></span><br></pre></td></tr></table></figure>

<p>当然，你还可以计算列与列之间的相关系数。这里，我们计算Apple和Microsoft的年相关系数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">127</span>]: by_year.apply(<span class="hljs-keyword">lambda</span> g: g[<span class="hljs-string">'AAPL'</span>].corr(g[<span class="hljs-string">'MSFT'</span>]))</span><br><span class="line">Out[<span class="hljs-number">127</span>]: </span><br><span class="line"><span class="hljs-number">2003</span>    <span class="hljs-number">0.480868</span></span><br><span class="line"><span class="hljs-number">2004</span>    <span class="hljs-number">0.259024</span></span><br><span class="line"><span class="hljs-number">2005</span>    <span class="hljs-number">0.300093</span></span><br><span class="line"><span class="hljs-number">2006</span>    <span class="hljs-number">0.161735</span></span><br><span class="line"><span class="hljs-number">2007</span>    <span class="hljs-number">0.417738</span></span><br><span class="line"><span class="hljs-number">2008</span>    <span class="hljs-number">0.611901</span></span><br><span class="line"><span class="hljs-number">2009</span>    <span class="hljs-number">0.432738</span></span><br><span class="line"><span class="hljs-number">2010</span>    <span class="hljs-number">0.571946</span></span><br><span class="line"><span class="hljs-number">2011</span>    <span class="hljs-number">0.581987</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="示例：组级别的线性回归"><a href="#示例：组级别的线性回归" class="headerlink" title="示例：组级别的线性回归"></a>示例：组级别的线性回归</h2><p>顺着上一个例子继续，你可以用groupby执行更为复杂的分组统计分析，只要函数返回的是pandas对象或标量值即可。例如，我可以定义下面这个regress函数（利用statsmodels计量经济学库）对各数据块执行普通最小二乘法（Ordinary Least Squares，OLS）回归：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm</span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">regress</span><span class="hljs-params">(data, yvar, xvars)</span>:</span></span><br><span class="line">    Y = data[yvar]</span><br><span class="line">    X = data[xvars]</span><br><span class="line">    X[<span class="hljs-string">'intercept'</span>] = <span class="hljs-number">1.</span></span><br><span class="line">    result = sm.OLS(Y, X).fit()</span><br><span class="line">    <span class="hljs-keyword">return</span> result.params</span><br></pre></td></tr></table></figure>

<p>现在，为了按年计算AAPL对SPX收益率的线性回归，执行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">129</span>]: by_year.apply(regress, <span class="hljs-string">'AAPL'</span>, [<span class="hljs-string">'SPX'</span>])</span><br><span class="line">Out[<span class="hljs-number">129</span>]: </span><br><span class="line">           SPX  intercept</span><br><span class="line"><span class="hljs-number">2003</span>  <span class="hljs-number">1.195406</span>   <span class="hljs-number">0.000710</span></span><br><span class="line"><span class="hljs-number">2004</span>  <span class="hljs-number">1.363463</span>   <span class="hljs-number">0.004201</span></span><br><span class="line"><span class="hljs-number">2005</span>  <span class="hljs-number">1.766415</span>   <span class="hljs-number">0.003246</span></span><br><span class="line"><span class="hljs-number">2006</span>  <span class="hljs-number">1.645496</span>   <span class="hljs-number">0.000080</span></span><br><span class="line"><span class="hljs-number">2007</span>  <span class="hljs-number">1.198761</span>   <span class="hljs-number">0.003438</span></span><br><span class="line"><span class="hljs-number">2008</span>  <span class="hljs-number">0.968016</span>  <span class="hljs-number">-0.001110</span></span><br><span class="line"><span class="hljs-number">2009</span>  <span class="hljs-number">0.879103</span>   <span class="hljs-number">0.002954</span></span><br><span class="line"><span class="hljs-number">2010</span>  <span class="hljs-number">1.052608</span>   <span class="hljs-number">0.001261</span></span><br><span class="line"><span class="hljs-number">2011</span>  <span class="hljs-number">0.806605</span>   <span class="hljs-number">0.001514</span></span><br></pre></td></tr></table></figure>

<h1 id="10-4-透视表和交叉表"><a href="#10-4-透视表和交叉表" class="headerlink" title="10.4 透视表和交叉表"></a>10.4 透视表和交叉表</h1><p>透视表（pivot table）是各种电子表格程序和其他数据分析软件中一种常见的数据汇总工具。它根据一个或多个键对数据进行聚合，并根据行和列上的分组键将数据分配到各个矩形区域中。在Python和pandas中，可以通过本章所介绍的groupby功能以及（能够利用层次化索引的）重塑运算制作透视表。DataFrame有一个pivot_table方法，此外还有一个顶级的pandas.pivot_table函数。除能为groupby提供便利之外，pivot_table还可以添加分项小计，也叫做margins。</p>
<p>回到小费数据集，假设我想要根据day和smoker计算分组平均数（pivot_table的默认聚合类型），并将day和smoker放到行上：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">130</span>]: tips.pivot_table(index=[<span class="hljs-string">'day'</span>, <span class="hljs-string">'smoker'</span>])</span><br><span class="line">Out[<span class="hljs-number">130</span>]: </span><br><span class="line">                 size       tip   tip_pct  total_bill</span><br><span class="line">day  smoker                                          </span><br><span class="line">Fri  No      <span class="hljs-number">2.250000</span>  <span class="hljs-number">2.812500</span>  <span class="hljs-number">0.151650</span>   <span class="hljs-number">18.420000</span></span><br><span class="line">     Yes     <span class="hljs-number">2.066667</span>  <span class="hljs-number">2.714000</span>  <span class="hljs-number">0.174783</span>   <span class="hljs-number">16.813333</span></span><br><span class="line">Sat  No      <span class="hljs-number">2.555556</span>  <span class="hljs-number">3.102889</span>  <span class="hljs-number">0.158048</span>   <span class="hljs-number">19.661778</span></span><br><span class="line">     Yes     <span class="hljs-number">2.476190</span>  <span class="hljs-number">2.875476</span>  <span class="hljs-number">0.147906</span>   <span class="hljs-number">21.276667</span></span><br><span class="line">Sun  No      <span class="hljs-number">2.929825</span>  <span class="hljs-number">3.167895</span>  <span class="hljs-number">0.160113</span>   <span class="hljs-number">20.506667</span></span><br><span class="line">     Yes     <span class="hljs-number">2.578947</span>  <span class="hljs-number">3.516842</span>  <span class="hljs-number">0.187250</span>   <span class="hljs-number">24.120000</span></span><br><span class="line">Thur No      <span class="hljs-number">2.488889</span>  <span class="hljs-number">2.673778</span>  <span class="hljs-number">0.160298</span>   <span class="hljs-number">17.113111</span></span><br><span class="line">     Yes     <span class="hljs-number">2.352941</span>  <span class="hljs-number">3.030000</span>  <span class="hljs-number">0.163863</span>   <span class="hljs-number">19.190588</span></span><br></pre></td></tr></table></figure>

<p>可以用groupby直接来做。现在，假设我们只想聚合tip_pct和size，而且想根据time进行分组。我将smoker放到列上，把day放到行上：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">131</span>]: tips.pivot_table([<span class="hljs-string">'tip_pct'</span>, <span class="hljs-string">'size'</span>], index=[<span class="hljs-string">'time'</span>, <span class="hljs-string">'day'</span>],</span><br><span class="line">   .....:                  columns=<span class="hljs-string">'smoker'</span>)</span><br><span class="line">Out[<span class="hljs-number">131</span>]: </span><br><span class="line">                 size             tip_pct          </span><br><span class="line">smoker             No       Yes        No       Yes</span><br><span class="line">time   day                                         </span><br><span class="line">Dinner Fri   <span class="hljs-number">2.000000</span>  <span class="hljs-number">2.222222</span>  <span class="hljs-number">0.139622</span>  <span class="hljs-number">0.165347</span></span><br><span class="line">       Sat   <span class="hljs-number">2.555556</span>  <span class="hljs-number">2.476190</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.147906</span></span><br><span class="line">       Sun   <span class="hljs-number">2.929825</span>  <span class="hljs-number">2.578947</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.187250</span></span><br><span class="line">       Thur  <span class="hljs-number">2.000000</span>       NaN  <span class="hljs-number">0.159744</span>       NaN</span><br><span class="line">Lunch  Fri   <span class="hljs-number">3.000000</span>  <span class="hljs-number">1.833333</span>  <span class="hljs-number">0.187735</span>  <span class="hljs-number">0.188937</span></span><br><span class="line">       Thur  <span class="hljs-number">2.500000</span>  <span class="hljs-number">2.352941</span>  <span class="hljs-number">0.160311</span>  <span class="hljs-number">0.163863</span></span><br></pre></td></tr></table></figure>

<p>还可以对这个表作进一步的处理，传入margins=True添加分项小计。这将会添加标签为All的行和列，其值对应于单个等级中所有数据的分组统计：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">132</span>]: tips.pivot_table([<span class="hljs-string">'tip_pct'</span>, <span class="hljs-string">'size'</span>], index=[<span class="hljs-string">'time'</span>, <span class="hljs-string">'day'</span>],</span><br><span class="line">   .....:                  columns=<span class="hljs-string">'smoker'</span>, margins=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">132</span>]: </span><br><span class="line">                 size                       tip_pct                    </span><br><span class="line">smoker             No       Yes       All        No       Yes       All</span><br><span class="line">time   day                                                             </span><br><span class="line">Dinner Fri   <span class="hljs-number">2.000000</span>  <span class="hljs-number">2.222222</span>  <span class="hljs-number">2.166667</span>  <span class="hljs-number">0.139622</span>  <span class="hljs-number">0.165347</span>  <span class="hljs-number">0.158916</span></span><br><span class="line">       Sat   <span class="hljs-number">2.555556</span>  <span class="hljs-number">2.476190</span>  <span class="hljs-number">2.517241</span>  <span class="hljs-number">0.158048</span>  <span class="hljs-number">0.147906</span>  <span class="hljs-number">0.153152</span></span><br><span class="line">       Sun   <span class="hljs-number">2.929825</span>  <span class="hljs-number">2.578947</span>  <span class="hljs-number">2.842105</span>  <span class="hljs-number">0.160113</span>  <span class="hljs-number">0.187250</span>  <span class="hljs-number">0.166897</span></span><br><span class="line">       Thur  <span class="hljs-number">2.000000</span>       NaN  <span class="hljs-number">2.000000</span>  <span class="hljs-number">0.159744</span>       NaN  <span class="hljs-number">0.159744</span></span><br><span class="line">Lunch  Fri   <span class="hljs-number">3.000000</span>  <span class="hljs-number">1.833333</span>  <span class="hljs-number">2.000000</span>  <span class="hljs-number">0.187735</span>  <span class="hljs-number">0.188937</span>  <span class="hljs-number">0.188765</span></span><br><span class="line">       Thur  <span class="hljs-number">2.500000</span>  <span class="hljs-number">2.352941</span>  <span class="hljs-number">2.459016</span>  <span class="hljs-number">0.160311</span>  <span class="hljs-number">0.163863</span>  <span class="hljs-number">0.161301</span></span><br><span class="line">All          <span class="hljs-number">2.668874</span>  <span class="hljs-number">2.408602</span>  <span class="hljs-number">2.569672</span>  <span class="hljs-number">0.159328</span>  <span class="hljs-number">0.163196</span>  <span class="hljs-number">0.160803</span></span><br></pre></td></tr></table></figure>

<p>这里，All值为平均数：不单独考虑烟民与非烟民（All列），不单独考虑行分组两个级别中的任何单项（All行）。</p>
<p>要使用其他的聚合函数，将其传给aggfunc即可。例如，使用count或len可以得到有关分组大小的交叉表（计数或频率）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">133</span>]: tips.pivot_table(<span class="hljs-string">'tip_pct'</span>, index=[<span class="hljs-string">'time'</span>, <span class="hljs-string">'smoker'</span>], columns=<span class="hljs-string">'day'</span>,</span><br><span class="line">   .....:                  aggfunc=len, margins=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">day             Fri   Sat   Sun  Thur    All</span><br><span class="line">time   smoker                               </span><br><span class="line">Dinner No       <span class="hljs-number">3.0</span>  <span class="hljs-number">45.0</span>  <span class="hljs-number">57.0</span>   <span class="hljs-number">1.0</span>  <span class="hljs-number">106.0</span></span><br><span class="line">       Yes      <span class="hljs-number">9.0</span>  <span class="hljs-number">42.0</span>  <span class="hljs-number">19.0</span>   NaN   <span class="hljs-number">70.0</span></span><br><span class="line">Lunch  No       <span class="hljs-number">1.0</span>   NaN   NaN  <span class="hljs-number">44.0</span>   <span class="hljs-number">45.0</span></span><br><span class="line">       Yes      <span class="hljs-number">6.0</span>   NaN   NaN  <span class="hljs-number">17.0</span>   <span class="hljs-number">23.0</span></span><br><span class="line">All            <span class="hljs-number">19.0</span>  <span class="hljs-number">87.0</span>  <span class="hljs-number">76.0</span>  <span class="hljs-number">62.0</span>  <span class="hljs-number">244.0</span></span><br></pre></td></tr></table></figure>

<p>如果存在空的组合（也就是NA），你可能会希望设置一个fill_value：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">134</span>]: tips.pivot_table(<span class="hljs-string">'tip_pct'</span>, index=[<span class="hljs-string">'time'</span>, <span class="hljs-string">'size'</span>, <span class="hljs-string">'smoker'</span>],</span><br><span class="line">   .....:                  columns=<span class="hljs-string">'day'</span>, aggfunc=<span class="hljs-string">'mean'</span>, fill_value=<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">134</span>]: </span><br><span class="line">day                      Fri       Sat       Sun      Thur</span><br><span class="line">time   size smoker                                        </span><br><span class="line">Dinner <span class="hljs-number">1</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.137931</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">            Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.325733</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">       <span class="hljs-number">2</span>    No      <span class="hljs-number">0.139622</span>  <span class="hljs-number">0.162705</span>  <span class="hljs-number">0.168859</span>  <span class="hljs-number">0.159744</span></span><br><span class="line">            Yes     <span class="hljs-number">0.171297</span>  <span class="hljs-number">0.148668</span>  <span class="hljs-number">0.207893</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">       <span class="hljs-number">3</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.154661</span>  <span class="hljs-number">0.152663</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">            Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.144995</span>  <span class="hljs-number">0.152660</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">       <span class="hljs-number">4</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.150096</span>  <span class="hljs-number">0.148143</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">            Yes     <span class="hljs-number">0.117750</span>  <span class="hljs-number">0.124515</span>  <span class="hljs-number">0.193370</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">       <span class="hljs-number">5</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.206928</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.106572</span>  <span class="hljs-number">0.065660</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-meta">... </span>                     ...       ...       ...       ...</span><br><span class="line">Lunch  <span class="hljs-number">1</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.181728</span></span><br><span class="line">            Yes     <span class="hljs-number">0.223776</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">       <span class="hljs-number">2</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.166005</span></span><br><span class="line">            Yes     <span class="hljs-number">0.181969</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.158843</span></span><br><span class="line">       <span class="hljs-number">3</span>    No      <span class="hljs-number">0.187735</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.084246</span></span><br><span class="line">            Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.204952</span></span><br><span class="line">       <span class="hljs-number">4</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.138919</span></span><br><span class="line">            Yes     <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.155410</span></span><br><span class="line">       <span class="hljs-number">5</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.121389</span></span><br><span class="line">       <span class="hljs-number">6</span>    No      <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.173706</span></span><br><span class="line">[<span class="hljs-number">21</span> rows x <span class="hljs-number">4</span> columns]</span><br></pre></td></tr></table></figure>

<p>pivot_table的参数说明请参见表10-2。</p>
<p><img src="/images/blog/7178691-c9e01844c4803a42.webp" alt="img"></p>
<p>表10-2 pivot_table的选项</p>
<h2 id="交叉表：crosstab"><a href="#交叉表：crosstab" class="headerlink" title="交叉表：crosstab"></a>交叉表：crosstab</h2><p>交叉表（cross-tabulation，简称crosstab）是一种用于计算分组频率的特殊透视表。看下面的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">138</span>]: data</span><br><span class="line">Out[<span class="hljs-number">138</span>]:</span><br><span class="line">   Sample Nationality    Handedness</span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">1</span>         USA  Right-handed</span><br><span class="line"><span class="hljs-number">1</span>       <span class="hljs-number">2</span>       Japan   Left-handed</span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">3</span>         USA  Right-handed</span><br><span class="line"><span class="hljs-number">3</span>       <span class="hljs-number">4</span>       Japan  Right-handed</span><br><span class="line"><span class="hljs-number">4</span>       <span class="hljs-number">5</span>       Japan   Left-handed</span><br><span class="line"><span class="hljs-number">5</span>       <span class="hljs-number">6</span>       Japan  Right-handed</span><br><span class="line"><span class="hljs-number">6</span>       <span class="hljs-number">7</span>         USA  Right-handed</span><br><span class="line"><span class="hljs-number">7</span>       <span class="hljs-number">8</span>         USA   Left-handed</span><br><span class="line"><span class="hljs-number">8</span>       <span class="hljs-number">9</span>       Japan  Right-handed</span><br><span class="line"><span class="hljs-number">9</span>      <span class="hljs-number">10</span>         USA  Right-handed</span><br></pre></td></tr></table></figure>

<p>作为调查分析的一部分，我们可能想要根据国籍和用手习惯对这段数据进行统计汇总。虽然可以用pivot_table实现该功能，但是pandas.crosstab函数会更方便：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">139</span>]: pd.crosstab(data.Nationality, data.Handedness, margins=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">139</span>]: </span><br><span class="line">Handedness   Left-handed  Right-handed  All</span><br><span class="line">Nationality</span><br><span class="line">Japan                  <span class="hljs-number">2</span>             <span class="hljs-number">3</span>    <span class="hljs-number">5</span></span><br><span class="line">USA                    <span class="hljs-number">1</span>             <span class="hljs-number">4</span>    <span class="hljs-number">5</span></span><br><span class="line">All                    <span class="hljs-number">3</span>             <span class="hljs-number">7</span>   <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>crosstab的前两个参数可以是数组或Series，或是数组列表。就像小费数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">140</span>]: pd.crosstab([tips.time, tips.day], tips.smoker, margins=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">140</span>]: </span><br><span class="line">smoker        No  Yes  All</span><br><span class="line">time   day                </span><br><span class="line">Dinner Fri     <span class="hljs-number">3</span>    <span class="hljs-number">9</span>   <span class="hljs-number">12</span></span><br><span class="line">       Sat    <span class="hljs-number">45</span>   <span class="hljs-number">42</span>   <span class="hljs-number">87</span></span><br><span class="line">       Sun    <span class="hljs-number">57</span>   <span class="hljs-number">19</span>   <span class="hljs-number">76</span></span><br><span class="line">       Thur    <span class="hljs-number">1</span>    <span class="hljs-number">0</span>    <span class="hljs-number">1</span></span><br><span class="line">Lunch  Fri     <span class="hljs-number">1</span>    <span class="hljs-number">6</span>    <span class="hljs-number">7</span></span><br><span class="line">       Thur   <span class="hljs-number">44</span>   <span class="hljs-number">17</span>   <span class="hljs-number">61</span></span><br><span class="line">All          <span class="hljs-number">151</span>   <span class="hljs-number">93</span>  <span class="hljs-number">244</span></span><br></pre></td></tr></table></figure>

<h1 id="10-5-总结"><a href="#10-5-总结" class="headerlink" title="10.5 总结"></a>10.5 总结</h1><p>掌握pandas数据分组工具既有助于数据清理，也有助于建模或统计分析工作。在第14章，我们会看几个例子，对真实数据使用groupby。</p>
<p>在下一章，我们将关注时间序列数据。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    29 分钟 读完 (大约 4421 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC12%E7%AB%A0%20pandas%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">《利用Python进行数据分析·第2版》第12章 pandas高级应用</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
第12章 pandas高级应用
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>前面的章节关注于不同类型的数据规整流程和NumPy、pandas与其它库的特点。随着时间的发展，pandas发展出了更多适合高级用户的功能。本章就要深入学习pandas的高级功能。</p>
<h1 id="12-1-分类数据"><a href="#12-1-分类数据" class="headerlink" title="12.1 分类数据"></a>12.1 分类数据</h1><p>这一节介绍的是pandas的分类类型。我会向你展示通过使用它，提高性能和内存的使用率。我还会介绍一些在统计和机器学习中使用分类数据的工具。</p>
<h2 id="背景和目的"><a href="#背景和目的" class="headerlink" title="背景和目的"></a>背景和目的</h2><p>表中的一列通常会有重复的包含不同值的小集合的情况。我们已经学过了unique和value_counts，它们可以从数组提取出不同的值，并分别计算频率：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np; <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: values = pd.Series([<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'apple'</span>,</span><br><span class="line">   ....:                     <span class="hljs-string">'apple'</span>] * <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: values</span><br><span class="line">Out[<span class="hljs-number">12</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">2</span>     apple</span><br><span class="line"><span class="hljs-number">3</span>     apple</span><br><span class="line"><span class="hljs-number">4</span>     apple</span><br><span class="line"><span class="hljs-number">5</span>    orange</span><br><span class="line"><span class="hljs-number">6</span>     apple</span><br><span class="line"><span class="hljs-number">7</span>     apple</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: pd.unique(values)</span><br><span class="line">Out[<span class="hljs-number">13</span>]: array([<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>], dtype=object)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: pd.value_counts(values)</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">apple     <span class="hljs-number">6</span></span><br><span class="line">orange    <span class="hljs-number">2</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>许多数据系统（数据仓库、统计计算或其它应用）都发展出了特定的表征重复值的方法，以进行高效的存储和计算。在数据仓库中，最好的方法是使用所谓的包含不同值的维表(Dimension Table)，将主要的参数存储为引用维表整数键：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: values = pd.Series([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>] * <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: dim = pd.Series([<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: values</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">6</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">7</span>    <span class="hljs-number">0</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">18</span>]: dim</span><br><span class="line">Out[<span class="hljs-number">18</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>可以使用take方法存储原始的字符串Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">19</span>]: dim.take(values)</span><br><span class="line">Out[<span class="hljs-number">19</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>这种用整数表示的方法称为分类或字典编码表示法。不同值得数组称为分类、字典或数据级。本书中，我们使用分类的说法。表示分类的整数值称为分类编码或简单地称为编码。</p>
<p>分类表示可以在进行分析时大大的提高性能。你也可以在保持编码不变的情况下，对分类进行转换。一些相对简单的转变例子包括：</p>
<ul>
<li>重命名分类。</li>
<li>加入一个新的分类，不改变已经存在的分类的顺序或位置。</li>
</ul>
<h2 id="pandas的分类类型"><a href="#pandas的分类类型" class="headerlink" title="pandas的分类类型"></a>pandas的分类类型</h2><p>pandas有一个特殊的分类类型，用于保存使用整数分类表示法的数据。看一个之前的Series例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">20</span>]: fruits = [<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>, <span class="hljs-string">'apple'</span>, <span class="hljs-string">'apple'</span>] * <span class="hljs-number">2</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: N = len(fruits)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'fruit'</span>: fruits,</span><br><span class="line">   ....:                    <span class="hljs-string">'basket_id'</span>: np.arange(N),</span><br><span class="line">   ....:                    <span class="hljs-string">'count'</span>: np.random.randint(<span class="hljs-number">3</span>, <span class="hljs-number">15</span>, size=N),</span><br><span class="line">   ....:                    <span class="hljs-string">'weight'</span>: np.random.uniform(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>, size=N)&#125;,</span><br><span class="line">   ....:                   columns=[<span class="hljs-string">'basket_id'</span>, <span class="hljs-string">'fruit'</span>, <span class="hljs-string">'count'</span>, <span class="hljs-string">'weight'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: df</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">   basket_id   fruit  count    weight</span><br><span class="line"><span class="hljs-number">0</span>          <span class="hljs-number">0</span>   apple      <span class="hljs-number">5</span>  <span class="hljs-number">3.858058</span></span><br><span class="line"><span class="hljs-number">1</span>          <span class="hljs-number">1</span>  orange      <span class="hljs-number">8</span>  <span class="hljs-number">2.612708</span></span><br><span class="line"><span class="hljs-number">2</span>          <span class="hljs-number">2</span>   apple      <span class="hljs-number">4</span>  <span class="hljs-number">2.995627</span></span><br><span class="line"><span class="hljs-number">3</span>          <span class="hljs-number">3</span>   apple      <span class="hljs-number">7</span>  <span class="hljs-number">2.614279</span></span><br><span class="line"><span class="hljs-number">4</span>          <span class="hljs-number">4</span>   apple     <span class="hljs-number">12</span>  <span class="hljs-number">2.990859</span></span><br><span class="line"><span class="hljs-number">5</span>          <span class="hljs-number">5</span>  orange      <span class="hljs-number">8</span>  <span class="hljs-number">3.845227</span></span><br><span class="line"><span class="hljs-number">6</span>          <span class="hljs-number">6</span>   apple      <span class="hljs-number">5</span>  <span class="hljs-number">0.033553</span></span><br><span class="line"><span class="hljs-number">7</span>          <span class="hljs-number">7</span>   apple      <span class="hljs-number">4</span>  <span class="hljs-number">0.425778</span></span><br></pre></td></tr></table></figure>

<p>这里，df[‘fruit’]是一个Python字符串对象的数组。我们可以通过调用它，将它转变为分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: fruit_cat = df[<span class="hljs-string">'fruit'</span>].astype(<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: fruit_cat</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">2</span>     apple</span><br><span class="line"><span class="hljs-number">3</span>     apple</span><br><span class="line"><span class="hljs-number">4</span>     apple</span><br><span class="line"><span class="hljs-number">5</span>    orange</span><br><span class="line"><span class="hljs-number">6</span>     apple</span><br><span class="line"><span class="hljs-number">7</span>     apple</span><br><span class="line">Name: fruit, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">2</span>, object): [apple, orange]</span><br></pre></td></tr></table></figure>

<p>fruit_cat的值不是NumPy数组，而是一个pandas.Categorical实例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">26</span>]: c = fruit_cat.values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: type(c)</span><br><span class="line">Out[<span class="hljs-number">27</span>]: pandas.core.categorical.Categorical</span><br></pre></td></tr></table></figure>

<p>分类对象有categories和codes属性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">28</span>]: c.categories</span><br><span class="line">Out[<span class="hljs-number">28</span>]: Index([<span class="hljs-string">'apple'</span>, <span class="hljs-string">'orange'</span>], dtype=<span class="hljs-string">'object'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">29</span>]: c.codes</span><br><span class="line">Out[<span class="hljs-number">29</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>], dtype=int8)</span><br></pre></td></tr></table></figure>

<p>你可将DataFrame的列通过分配转换结果，转换为分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">30</span>]: df[<span class="hljs-string">'fruit'</span>] = df[<span class="hljs-string">'fruit'</span>].astype(<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: df.fruit</span><br><span class="line">Out[<span class="hljs-number">31</span>]:</span><br><span class="line"><span class="hljs-number">0</span>     apple</span><br><span class="line"><span class="hljs-number">1</span>    orange</span><br><span class="line"><span class="hljs-number">2</span>     apple</span><br><span class="line"><span class="hljs-number">3</span>     apple</span><br><span class="line"><span class="hljs-number">4</span>     apple</span><br><span class="line"><span class="hljs-number">5</span>    orange</span><br><span class="line"><span class="hljs-number">6</span>     apple</span><br><span class="line"><span class="hljs-number">7</span>     apple</span><br><span class="line">Name: fruit, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">2</span>, object): [apple, orange]</span><br></pre></td></tr></table></figure>

<p>你还可以从其它Python序列直接创建pandas.Categorical：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">32</span>]: my_categories = pd.Categorical([<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">33</span>]: my_categories</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">[foo, bar, baz, foo, bar]</span><br><span class="line">Categories (<span class="hljs-number">3</span>, object): [bar, baz, foo]</span><br></pre></td></tr></table></figure>

<p>如果你已经从其它源获得了分类编码，你还可以使用from_codes构造器：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">34</span>]: categories = [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">35</span>]: codes = [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: my_cats_2 = pd.Categorical.from_codes(codes, categories)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: my_cats_2</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">[foo, bar, baz, foo, foo, bar]</span><br><span class="line">Categories (<span class="hljs-number">3</span>, object): [foo, bar, baz]</span><br></pre></td></tr></table></figure>

<p>与显示指定不同，分类变换不认定指定的分类顺序。因此取决于输入数据的顺序，categories数组的顺序会不同。当使用from_codes或其它的构造器时，你可以指定分类一个有意义的顺序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">38</span>]: ordered_cat = pd.Categorical.from_codes(codes, categories,</span><br><span class="line">   ....:                                         ordered=<span class="hljs-literal">True</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">39</span>]: ordered_cat</span><br><span class="line">Out[<span class="hljs-number">39</span>]: </span><br><span class="line">[foo, bar, baz, foo, foo, bar]</span><br><span class="line">Categories (<span class="hljs-number">3</span>, object): [foo &lt; bar &lt; baz]</span><br></pre></td></tr></table></figure>

<p>输出[foo &lt; bar &lt; baz]指明‘foo’位于‘bar’的前面，以此类推。无序的分类实例可以通过as_ordered排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">40</span>]: my_cats_2.as_ordered()</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">[foo, bar, baz, foo, foo, bar]</span><br><span class="line">Categories (<span class="hljs-number">3</span>, object): [foo &lt; bar &lt; baz]</span><br></pre></td></tr></table></figure>

<p>最后要注意，分类数据不需要字符串，尽管我仅仅展示了字符串的例子。分类数组可以包括任意不可变类型。</p>
<h2 id="用分类进行计算"><a href="#用分类进行计算" class="headerlink" title="用分类进行计算"></a>用分类进行计算</h2><p>与非编码版本（比如字符串数组）相比，使用pandas的Categorical有些类似。某些pandas组件，比如groupby函数，更适合进行分类。还有一些函数可以使用有序标志位。</p>
<p>来看一些随机的数值数据，使用pandas.qcut面元函数。它会返回pandas.Categorical，我们之前使用过pandas.cut，但没解释分类是如何工作的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">41</span>]: np.random.seed(<span class="hljs-number">12345</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: draws = np.random.randn(<span class="hljs-number">1000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: draws[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">43</span>]: array([<span class="hljs-number">-0.2047</span>,  <span class="hljs-number">0.4789</span>, <span class="hljs-number">-0.5194</span>, <span class="hljs-number">-0.5557</span>,  <span class="hljs-number">1.9658</span>])</span><br></pre></td></tr></table></figure>

<p>计算这个数据的分位面元，提取一些统计信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: bins = pd.qcut(draws, <span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">45</span>]: bins</span><br><span class="line">Out[<span class="hljs-number">45</span>]: </span><br><span class="line">[(<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>], (<span class="hljs-number">-0.0101</span>, <span class="hljs-number">0.63</span>], (<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>], (<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>], (<span class="hljs-number">0.63</span>,</span><br><span class="line"> <span class="hljs-number">3.928</span>], ..., (<span class="hljs-number">-0.0101</span>, <span class="hljs-number">0.63</span>], (<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>], (<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.684</span>], (<span class="hljs-number">-0.0101</span>, <span class="hljs-number">0.63</span></span><br><span class="line">], (<span class="hljs-number">0.63</span>, <span class="hljs-number">3.928</span>]]</span><br><span class="line">Length: <span class="hljs-number">1000</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.684</span>] &lt; (<span class="hljs-number">-0.684</span>, <span class="hljs-number">-0.0101</span>] &lt; (<span class="hljs-number">-0.010</span></span><br><span class="line"><span class="hljs-number">1</span>, <span class="hljs-number">0.63</span>] &lt;</span><br><span class="line">                                    (<span class="hljs-number">0.63</span>, <span class="hljs-number">3.928</span>]]</span><br></pre></td></tr></table></figure>

<p>虽然有用，确切的样本分位数与分位的名称相比，不利于生成汇总。我们可以使用labels参数qcut，实现目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">46</span>]: bins = pd.qcut(draws, <span class="hljs-number">4</span>, labels=[<span class="hljs-string">'Q1'</span>, <span class="hljs-string">'Q2'</span>, <span class="hljs-string">'Q3'</span>, <span class="hljs-string">'Q4'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: bins</span><br><span class="line">Out[<span class="hljs-number">47</span>]: </span><br><span class="line">[Q2, Q3, Q2, Q2, Q4, ..., Q3, Q2, Q1, Q3, Q4]</span><br><span class="line">Length: <span class="hljs-number">1000</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [Q1 &lt; Q2 &lt; Q3 &lt; Q4]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: bins.codes[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">48</span>]: array([<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>], dtype=int8)</span><br></pre></td></tr></table></figure>

<p>加上标签的面元分类不包含数据面元边界的信息，因此可以使用groupby提取一些汇总信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: bins = pd.Series(bins, name=<span class="hljs-string">'quartile'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">50</span>]: results = (pd.Series(draws)</span><br><span class="line">   ....:            .groupby(bins)</span><br><span class="line">   ....:            .agg([<span class="hljs-string">'count'</span>, <span class="hljs-string">'min'</span>, <span class="hljs-string">'max'</span>])</span><br><span class="line">   ....:            .reset_index())</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: results</span><br><span class="line">Out[<span class="hljs-number">51</span>]: </span><br><span class="line">  quartile  count       min       max</span><br><span class="line"><span class="hljs-number">0</span>       Q1    <span class="hljs-number">250</span> <span class="hljs-number">-2.949343</span> <span class="hljs-number">-0.685484</span></span><br><span class="line"><span class="hljs-number">1</span>       Q2    <span class="hljs-number">250</span> <span class="hljs-number">-0.683066</span> <span class="hljs-number">-0.010115</span></span><br><span class="line"><span class="hljs-number">2</span>       Q3    <span class="hljs-number">250</span> <span class="hljs-number">-0.010032</span>  <span class="hljs-number">0.628894</span></span><br><span class="line"><span class="hljs-number">3</span>       Q4    <span class="hljs-number">250</span>  <span class="hljs-number">0.634238</span>  <span class="hljs-number">3.927528</span></span><br></pre></td></tr></table></figure>

<p>分位数列保存了原始的面元分类信息，包括排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">52</span>]: results[<span class="hljs-string">'quartile'</span>]</span><br><span class="line">Out[<span class="hljs-number">52</span>]:</span><br><span class="line"><span class="hljs-number">0</span>    Q1</span><br><span class="line"><span class="hljs-number">1</span>    Q2</span><br><span class="line"><span class="hljs-number">2</span>    Q3</span><br><span class="line"><span class="hljs-number">3</span>    Q4</span><br><span class="line">Name: quartile, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [Q1 &lt; Q2 &lt; Q3 &lt; Q4]</span><br></pre></td></tr></table></figure>

<h2 id="用分类提高性能"><a href="#用分类提高性能" class="headerlink" title="用分类提高性能"></a>用分类提高性能</h2><p>如果你是在一个特定数据集上做大量分析，将其转换为分类可以极大地提高效率。DataFrame列的分类使用的内存通常少的多。来看一些包含一千万元素的Series，和一些不同的分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">53</span>]: N = <span class="hljs-number">10000000</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">54</span>]: draws = pd.Series(np.random.randn(N))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: labels = pd.Series([<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'qux'</span>] * (N // <span class="hljs-number">4</span>))</span><br></pre></td></tr></table></figure>

<p>现在，将标签转换为分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: categories = labels.astype(<span class="hljs-string">'category'</span>)</span><br></pre></td></tr></table></figure>

<p>这时，可以看到标签使用的内存远比分类多：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">57</span>]: labels.memory_usage()</span><br><span class="line">Out[<span class="hljs-number">57</span>]: <span class="hljs-number">80000080</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: categories.memory_usage()</span><br><span class="line">Out[<span class="hljs-number">58</span>]: <span class="hljs-number">10000272</span></span><br></pre></td></tr></table></figure>

<p>转换为分类不是没有代价的，但这是一次性的代价：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">59</span>]: %time _ = labels.astype(<span class="hljs-string">'category'</span>)</span><br><span class="line">CPU times: user <span class="hljs-number">490</span> ms, sys: <span class="hljs-number">240</span> ms, total: <span class="hljs-number">730</span> ms</span><br><span class="line">Wall time: <span class="hljs-number">726</span> ms</span><br></pre></td></tr></table></figure>

<p>GroupBy使用分类操作明显更快，是因为底层的算法使用整数编码数组，而不是字符串数组。</p>
<h2 id="分类方法"><a href="#分类方法" class="headerlink" title="分类方法"></a>分类方法</h2><p>包含分类数据的Series有一些特殊的方法，类似于Series.str字符串方法。它还提供了方便的分类和编码的使用方法。看下面的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: s = pd.Series([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>] * <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: cat_s = s.astype(<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: cat_s</span><br><span class="line">Out[<span class="hljs-number">62</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">2</span>    c</span><br><span class="line"><span class="hljs-number">3</span>    d</span><br><span class="line"><span class="hljs-number">4</span>    a</span><br><span class="line"><span class="hljs-number">5</span>    b</span><br><span class="line"><span class="hljs-number">6</span>    c</span><br><span class="line"><span class="hljs-number">7</span>    d</span><br><span class="line">dtype: category</span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [a, b, c, d]</span><br></pre></td></tr></table></figure>

<p>特别的cat属性提供了分类方法的入口：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">63</span>]: cat_s.cat.codes</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">6</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">7</span>    <span class="hljs-number">3</span></span><br><span class="line">dtype: int8</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">64</span>]: cat_s.cat.categories</span><br><span class="line">Out[<span class="hljs-number">64</span>]: Index([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>], dtype=<span class="hljs-string">'object'</span>)</span><br></pre></td></tr></table></figure>

<p>假设我们知道这个数据的实际分类集，超出了数据中的四个值。我们可以使用set_categories方法改变它们：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: actual_categories = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">66</span>]: cat_s2 = cat_s.cat.set_categories(actual_categories)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: cat_s2</span><br><span class="line">Out[<span class="hljs-number">67</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">2</span>    c</span><br><span class="line"><span class="hljs-number">3</span>    d</span><br><span class="line"><span class="hljs-number">4</span>    a</span><br><span class="line"><span class="hljs-number">5</span>    b</span><br><span class="line"><span class="hljs-number">6</span>    c</span><br><span class="line"><span class="hljs-number">7</span>    d</span><br><span class="line">dtype: category</span><br><span class="line">Categories (<span class="hljs-number">5</span>, object): [a, b, c, d, e]</span><br></pre></td></tr></table></figure>

<p>虽然数据看起来没变，新的分类将反映在它们的操作中。例如，如果有的话，value_counts表示分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: cat_s.value_counts()</span><br><span class="line">Out[<span class="hljs-number">68</span>]: </span><br><span class="line">d    <span class="hljs-number">2</span></span><br><span class="line">c    <span class="hljs-number">2</span></span><br><span class="line">b    <span class="hljs-number">2</span></span><br><span class="line">a    <span class="hljs-number">2</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">69</span>]: cat_s2.value_counts()</span><br><span class="line">Out[<span class="hljs-number">69</span>]: </span><br><span class="line">d    <span class="hljs-number">2</span></span><br><span class="line">c    <span class="hljs-number">2</span></span><br><span class="line">b    <span class="hljs-number">2</span></span><br><span class="line">a    <span class="hljs-number">2</span></span><br><span class="line">e    <span class="hljs-number">0</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>在大数据集中，分类经常作为节省内存和高性能的便捷工具。过滤完大DataFrame或Series之后，许多分类可能不会出现在数据中。我们可以使用remove_unused_categories方法删除没看到的分类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">70</span>]: cat_s3 = cat_s[cat_s.isin([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: cat_s3</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">4</span>    a</span><br><span class="line"><span class="hljs-number">5</span>    b</span><br><span class="line">dtype: category</span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [a, b, c, d]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: cat_s3.cat.remove_unused_categories()</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">4</span>    a</span><br><span class="line"><span class="hljs-number">5</span>    b</span><br><span class="line">dtype: category</span><br><span class="line">Categories (<span class="hljs-number">2</span>, object): [a, b]</span><br></pre></td></tr></table></figure>

<p>表12-1列出了可用的分类方法。</p>
<p><img src="/images/blog/7178691-6c602152c2bba658.webp" alt="img"></p>
<p>表12-1 pandas的Series的分类方法</p>
<h2 id="为建模创建虚拟变量"><a href="#为建模创建虚拟变量" class="headerlink" title="为建模创建虚拟变量"></a>为建模创建虚拟变量</h2><p>当你使用统计或机器学习工具时，通常会将分类数据转换为虚拟变量，也称为one-hot编码。这包括创建一个不同类别的列的DataFrame；这些列包含给定分类的1s，其它为0。</p>
<p>看前面的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: cat_s = pd.Series([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>] * <span class="hljs-number">2</span>, dtype=<span class="hljs-string">'category'</span>)</span><br></pre></td></tr></table></figure>

<p>前面的第7章提到过，pandas.get_dummies函数可以转换这个分类数据为包含虚拟变量的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: pd.get_dummies(cat_s)</span><br><span class="line">Out[<span class="hljs-number">74</span>]: </span><br><span class="line">   a  b  c  d</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">7</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="12-2-GroupBy高级应用"><a href="#12-2-GroupBy高级应用" class="headerlink" title="12.2 GroupBy高级应用"></a>12.2 GroupBy高级应用</h1><p>尽管我们在第10章已经深度学习了Series和DataFrame的Groupby方法，还有一些方法也是很有用的。</p>
<h2 id="分组转换和“解封”GroupBy"><a href="#分组转换和“解封”GroupBy" class="headerlink" title="分组转换和“解封”GroupBy"></a>分组转换和“解封”GroupBy</h2><p>在第10章，我们在分组操作中学习了apply方法，进行转换。还有另一个transform方法，它与apply很像，但是对使用的函数有一定限制：</p>
<ul>
<li>它可以产生向分组形状广播标量值</li>
<li>它可以产生一个和输入组形状相同的对象</li>
<li>它不能修改输入</li>
</ul>
<p>来看一个简单的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>] * <span class="hljs-number">4</span>,</span><br><span class="line">   ....:                    <span class="hljs-string">'value'</span>: np.arange(<span class="hljs-number">12.</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: df</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">   key  value</span><br><span class="line"><span class="hljs-number">0</span>    a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">1</span>    b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>    c    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    a    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">4</span>    b    <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">5</span>    c    <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">6</span>    a    <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">7</span>    b    <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">8</span>    c    <span class="hljs-number">8.0</span></span><br><span class="line"><span class="hljs-number">9</span>    a    <span class="hljs-number">9.0</span></span><br><span class="line"><span class="hljs-number">10</span>   b   <span class="hljs-number">10.0</span></span><br><span class="line"><span class="hljs-number">11</span>   c   <span class="hljs-number">11.0</span></span><br></pre></td></tr></table></figure>

<p>按键进行分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">77</span>]: g = df.groupby(<span class="hljs-string">'key'</span>).value</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: g.mean()</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">key</span><br><span class="line">a    <span class="hljs-number">4.5</span></span><br><span class="line">b    <span class="hljs-number">5.5</span></span><br><span class="line">c    <span class="hljs-number">6.5</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>假设我们想产生一个和df[‘value’]形状相同的Series，但值替换为按键分组的平均值。我们可以传递函数lambda x: x.mean()进行转换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: g.transform(<span class="hljs-keyword">lambda</span> x: x.mean())</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">6.5</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>对于内置的聚合函数，我们可以传递一个字符串假名作为GroupBy的agg方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">80</span>]: g.transform(<span class="hljs-string">'mean'</span>)</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">6.5</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>与apply类似，transform的函数会返回Series，但是结果必须与输入大小相同。举个例子，我们可以用lambda函数将每个分组乘以2：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">81</span>]: g.transform(<span class="hljs-keyword">lambda</span> x: x * <span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">81</span>]: </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">8.0</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">10.0</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">12.0</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">14.0</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">16.0</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">18.0</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">20.0</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">22.0</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>再举一个复杂的例子，我们可以计算每个分组的降序排名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: g.transform(<span class="hljs-keyword">lambda</span> x: x.rank(ascending=<span class="hljs-literal">False</span>))</span><br><span class="line">Out[<span class="hljs-number">82</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">1.0</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>看一个由简单聚合构造的的分组转换函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">normalize</span><span class="hljs-params">(x)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> (x - x.mean()) / x.std()</span><br></pre></td></tr></table></figure>

<p>我们用transform或apply可以获得等价的结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">84</span>]: g.transform(normalize)</span><br><span class="line">Out[<span class="hljs-number">84</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">1.161895</span></span><br><span class="line">Name: value, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: g.apply(normalize)</span><br><span class="line">Out[<span class="hljs-number">85</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">1.161895</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>内置的聚合函数，比如mean或sum，通常比apply函数快，也比transform快。这允许我们进行一个所谓的解封（unwrapped）分组操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: g.transform(<span class="hljs-string">'mean'</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">1</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">5</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">6.5</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">5.5</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">6.5</span></span><br><span class="line">Name: value, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">87</span>]: normalized = (df[<span class="hljs-string">'value'</span>] - g.transform(<span class="hljs-string">'mean'</span>)) / g.transform(<span class="hljs-string">'std'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: normalized</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">-1.161895</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">-0.387298</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">7</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">8</span>     <span class="hljs-number">0.387298</span></span><br><span class="line"><span class="hljs-number">9</span>     <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">10</span>    <span class="hljs-number">1.161895</span></span><br><span class="line"><span class="hljs-number">11</span>    <span class="hljs-number">1.161895</span></span><br><span class="line">Name: value, dtype: float64</span><br></pre></td></tr></table></figure>

<p>解封分组操作可能包括多个分组聚合，但是矢量化操作还是会带来收益。</p>
<h2 id="分组的时间重采样"><a href="#分组的时间重采样" class="headerlink" title="分组的时间重采样"></a>分组的时间重采样</h2><p>对于时间序列数据，resample方法从语义上是一个基于内在时间的分组操作。下面是一个示例表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">89</span>]: N = <span class="hljs-number">15</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: times = pd.date_range(<span class="hljs-string">'2017-05-20 00:00'</span>, freq=<span class="hljs-string">'1min'</span>, periods=N)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">91</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'time'</span>: times,</span><br><span class="line">   ....:                    <span class="hljs-string">'value'</span>: np.arange(N)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: df</span><br><span class="line">Out[<span class="hljs-number">92</span>]: </span><br><span class="line">                  time  value</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">00</span>      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00</span>      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">04</span>:<span class="hljs-number">00</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00</span>      <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">7</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">00</span>      <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">8</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">08</span>:<span class="hljs-number">00</span>      <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">9</span>  <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">09</span>:<span class="hljs-number">00</span>      <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">10</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>     <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">11</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">00</span>     <span class="hljs-number">11</span></span><br><span class="line"><span class="hljs-number">12</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">12</span>:<span class="hljs-number">00</span>     <span class="hljs-number">12</span></span><br><span class="line"><span class="hljs-number">13</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">13</span>:<span class="hljs-number">00</span>     <span class="hljs-number">13</span></span><br><span class="line"><span class="hljs-number">14</span> <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">14</span>:<span class="hljs-number">00</span>     <span class="hljs-number">14</span></span><br></pre></td></tr></table></figure>

<p>这里，我们可以用time作为索引，然后重采样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">93</span>]: df.set_index(<span class="hljs-string">'time'</span>).resample(<span class="hljs-string">'5min'</span>).count()</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line">                     value</span><br><span class="line">time                      </span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>      <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>假设DataFrame包含多个时间序列，用一个额外的分组键的列进行标记：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: df2 = pd.DataFrame(&#123;<span class="hljs-string">'time'</span>: times.repeat(<span class="hljs-number">3</span>),</span><br><span class="line">   ....:                     <span class="hljs-string">'key'</span>: np.tile([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>], N),</span><br><span class="line">   ....:                     <span class="hljs-string">'value'</span>: np.arange(N * <span class="hljs-number">3.</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: df2[:<span class="hljs-number">7</span>]</span><br><span class="line">Out[<span class="hljs-number">95</span>]: </span><br><span class="line">  key                time  value</span><br><span class="line"><span class="hljs-number">0</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">1</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">4</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">5</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">6</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">00</span>    <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>要对每个key值进行相同的重采样，我们引入pandas.TimeGrouper对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: time_key = pd.TimeGrouper(<span class="hljs-string">'5min'</span>)</span><br></pre></td></tr></table></figure>

<p>我们然后设定时间索引，用key和time_key分组，然后聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">97</span>]: resampled = (df2.set_index(<span class="hljs-string">'time'</span>)</span><br><span class="line">   ....:              .groupby([<span class="hljs-string">'key'</span>, time_key])</span><br><span class="line">   ....:              .sum())</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: resampled</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">                         value</span><br><span class="line">key time                      </span><br><span class="line">a   <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">30.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">105.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">180.0</span></span><br><span class="line">b   <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">35.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">110.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">185.0</span></span><br><span class="line">c   <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">40.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">115.0</span></span><br><span class="line">    <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">190.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: resampled.reset_index()</span><br><span class="line">Out[<span class="hljs-number">99</span>]:</span><br><span class="line">key                time  value</span><br><span class="line"><span class="hljs-number">0</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">30.0</span></span><br><span class="line"><span class="hljs-number">1</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">105.0</span></span><br><span class="line"><span class="hljs-number">2</span>   a <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">180.0</span></span><br><span class="line"><span class="hljs-number">3</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">35.0</span></span><br><span class="line"><span class="hljs-number">4</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">110.0</span></span><br><span class="line"><span class="hljs-number">5</span>   b <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">185.0</span></span><br><span class="line"><span class="hljs-number">6</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">40.0</span></span><br><span class="line"><span class="hljs-number">7</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>  <span class="hljs-number">115.0</span></span><br><span class="line"><span class="hljs-number">8</span>   c <span class="hljs-number">2017</span><span class="hljs-number">-05</span><span class="hljs-number">-20</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>  <span class="hljs-number">190.0</span></span><br></pre></td></tr></table></figure>

<p>使用TimeGrouper的限制是时间必须是Series或DataFrame的索引。</p>
<h1 id="12-3-链式编程技术"><a href="#12-3-链式编程技术" class="headerlink" title="12.3 链式编程技术"></a>12.3 链式编程技术</h1><p>当对数据集进行一系列变换时，你可能发现创建的多个临时变量其实并没有在分析中用到。看下面的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">df = load_data()</span><br><span class="line">df2 = df[df[<span class="hljs-string">'col2'</span>] &lt; <span class="hljs-number">0</span>]</span><br><span class="line">df2[<span class="hljs-string">'col1_demeaned'</span>] = df2[<span class="hljs-string">'col1'</span>] - df2[<span class="hljs-string">'col1'</span>].mean()</span><br><span class="line">result = df2.groupby(<span class="hljs-string">'key'</span>).col1_demeaned.std()</span><br></pre></td></tr></table></figure>

<p>虽然这里没有使用真实的数据，这个例子却指出了一些新方法。首先，DataFrame.assign方法是一个df[k] = v形式的函数式的列分配方法。它不是就地修改对象，而是返回新的修改过的DataFrame。因此，下面的语句是等价的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Usual non-functional way</span></span><br><span class="line">df2 = df.copy()</span><br><span class="line">df2[<span class="hljs-string">'k'</span>] = v</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Functional assign way</span></span><br><span class="line">df2 = df.assign(k=v)</span><br></pre></td></tr></table></figure>

<p>就地分配可能会比assign快，但是assign可以方便地进行链式编程：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = (df2.assign(col1_demeaned=df2.col1 - df2.col2.mean())</span><br><span class="line">          .groupby(<span class="hljs-string">'key'</span>)</span><br><span class="line">          .col1_demeaned.std())</span><br></pre></td></tr></table></figure>

<p>我使用外括号，这样便于添加换行符。</p>
<p>使用链式编程时要注意，你可能会需要涉及临时对象。在前面的例子中，我们不能使用load_data的结果，直到它被赋值给临时变量df。为了这么做，assign和许多其它pandas函数可以接收类似函数的参数，即可调用对象（callable）。为了展示可调用对象，看一个前面例子的片段：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df = load_data()</span><br><span class="line">df2 = df[df[<span class="hljs-string">'col2'</span>] &lt; <span class="hljs-number">0</span>]</span><br></pre></td></tr></table></figure>

<p>它可以重写为：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">df = (load_data()</span><br><span class="line">      [<span class="hljs-keyword">lambda</span> x: x[<span class="hljs-string">'col2'</span>] &lt; <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>这里，load_data的结果没有赋值给某个变量，因此传递到[ ]的函数在这一步被绑定到了对象。</p>
<p>我们可以把整个过程写为一个单链表达式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">result = (load_data()</span><br><span class="line">          [<span class="hljs-keyword">lambda</span> x: x.col2 &lt; <span class="hljs-number">0</span>]</span><br><span class="line">          .assign(col1_demeaned=<span class="hljs-keyword">lambda</span> x: x.col1 - x.col1.mean())</span><br><span class="line">          .groupby(<span class="hljs-string">'key'</span>)</span><br><span class="line">          .col1_demeaned.std())</span><br></pre></td></tr></table></figure>

<p>是否将代码写成这种形式只是习惯而已，将它分开成若干步可以提高可读性。</p>
<h2 id="管道方法"><a href="#管道方法" class="headerlink" title="管道方法"></a>管道方法</h2><p>你可以用Python内置的pandas函数和方法，用带有可调用对象的链式编程做许多工作。但是，有时你需要使用自己的函数，或是第三方库的函数。这时就要用到管道方法。</p>
<p>看下面的函数调用：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">a = f(df, arg1=v1)</span><br><span class="line">b = g(a, v2, arg3=v3)</span><br><span class="line">c = h(b, arg4=v4)</span><br></pre></td></tr></table></figure>

<p>当使用接收、返回Series或DataFrame对象的函数式，你可以调用pipe将其重写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">result = (df.pipe(f, arg1=v1)</span><br><span class="line">          .pipe(g, v2, arg3=v3)</span><br><span class="line">          .pipe(h, arg4=v4))</span><br></pre></td></tr></table></figure>

<p>f(df)和df.pipe(f)是等价的，但是pipe使得链式声明更容易。</p>
<p>pipe的另一个有用的地方是提炼操作为可复用的函数。看一个从列减去分组方法的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">g = df.groupby([<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>])</span><br><span class="line">df[<span class="hljs-string">'col1'</span>] = df[<span class="hljs-string">'col1'</span>] - g.transform(<span class="hljs-string">'mean'</span>)</span><br></pre></td></tr></table></figure>

<p>假设你想转换多列，并修改分组的键。另外，你想用链式编程做这个转换。下面就是一个方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">group_demean</span><span class="hljs-params">(df, by, cols)</span>:</span></span><br><span class="line">    result = df.copy()</span><br><span class="line">    g = df.groupby(by)</span><br><span class="line">    <span class="hljs-keyword">for</span> c <span class="hljs-keyword">in</span> cols:</span><br><span class="line">        result[c] = df[c] - g[c].transform(<span class="hljs-string">'mean'</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> result</span><br></pre></td></tr></table></figure>

<p>然后可以写为：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">result = (df[df.col1 &lt; <span class="hljs-number">0</span>]</span><br><span class="line">          .pipe(group_demean, [<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>], [<span class="hljs-string">'col1'</span>]))</span><br></pre></td></tr></table></figure>

<h1 id="12-4-总结"><a href="#12-4-总结" class="headerlink" title="12.4 总结"></a>12.4 总结</h1><p>和其它许多开源项目一样，pandas仍然在不断的变化和进步中。和本书中其它地方一样，这里的重点是放在接下来几年不会发生什么改变且稳定的功能。</p>
<p>为了深入学习pandas的知识，我建议你学习官方文档，并阅读开发团队发布的文档更新。我们还邀请你加入pandas的开发工作：修改bug、创建新功能、完善文档。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    35 分钟 读完 (大约 5202 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC13%E7%AB%A0%20Python%E5%BB%BA%E6%A8%A1%E5%BA%93%E4%BB%8B%E7%BB%8D/">《利用Python进行数据分析·第2版》第13章 Python建模库介绍</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
第13章 Python建模库介绍
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。</p>
<p>开发模型选用什么库取决于应用本身。许多统计问题可以用简单方法解决，比如普通的最小二乘回归，其它问题可能需要复杂的机器学习方法。幸运的是，Python已经成为了运用这些分析方法的语言之一，因此读完此书，你可以探索许多工具。</p>
<p>本章中，我会回顾一些pandas的特点，在你胶着于pandas数据规整和模型拟合和评分时，它们可能派上用场。然后我会简短介绍两个流行的建模工具，statsmodels和scikit-learn。这二者每个都值得再写一本书，我就不做全面的介绍，而是建议你学习两个项目的线上文档和其它基于Python的数据科学、统计和机器学习的书籍。</p>
<h1 id="13-1-pandas与模型代码的接口"><a href="#13-1-pandas与模型代码的接口" class="headerlink" title="13.1 pandas与模型代码的接口"></a>13.1 pandas与模型代码的接口</h1><p>模型开发的通常工作流是使用pandas进行数据加载和清洗，然后切换到建模库进行建模。开发模型的重要一环是机器学习中的“特征工程”。它可以描述从原始数据集中提取信息的任何数据转换或分析，这些数据集可能在建模中有用。本书中学习的数据聚合和GroupBy工具常用于特征工程中。</p>
<p>优秀的特征工程超出了本书的范围，我会尽量直白地介绍一些用于数据操作和建模切换的方法。</p>
<p>pandas与其它分析库通常是靠NumPy的数组联系起来的。将DataFrame转换为NumPy数组，可以使用.values属性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">0.01</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">0.</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">-1.5</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">3.6</span>, <span class="hljs-number">1.3</span>, <span class="hljs-number">-2.</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: data</span><br><span class="line">Out[<span class="hljs-number">13</span>]: </span><br><span class="line">   x0    x1    y</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: data.columns</span><br><span class="line">Out[<span class="hljs-number">14</span>]: Index([<span class="hljs-string">'x0'</span>, <span class="hljs-string">'x1'</span>, <span class="hljs-string">'y'</span>], dtype=<span class="hljs-string">'object'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: data.values</span><br><span class="line">Out[<span class="hljs-number">15</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>, <span class="hljs-number">-1.5</span> ],</span><br><span class="line">       [ <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>,  <span class="hljs-number">0.</span>  ],</span><br><span class="line">       [ <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>,  <span class="hljs-number">3.6</span> ],</span><br><span class="line">       [ <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ,  <span class="hljs-number">1.3</span> ],</span><br><span class="line">       [ <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  , <span class="hljs-number">-2.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>要转换回DataFrame，可以传递一个二维ndarray，可带有列名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">16</span>]: df2 = pd.DataFrame(data.values, columns=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line">   one   two  three</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">0.01</span>   <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">2.0</span> <span class="hljs-number">-0.01</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">3.0</span>  <span class="hljs-number">0.25</span>    <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">4.0</span> <span class="hljs-number">-4.10</span>    <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">0.00</span>   <span class="hljs-number">-2.0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：最好当数据是均匀的时候使用.values属性。例如，全是数值类型。如果数据是不均匀的，结果会是Python对象的ndarray：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: df3 = data.copy()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: df3[<span class="hljs-string">'strings'</span>] = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: df3</span><br><span class="line">Out[<span class="hljs-number">20</span>]: </span><br><span class="line">  x0    x1    y strings</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>       a</span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>       b</span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>       c</span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>       d</span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>       e</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: df3.values</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">array([[<span class="hljs-number">1</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">-1.5</span>, <span class="hljs-string">'a'</span>],</span><br><span class="line">      [<span class="hljs-number">2</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.0</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">      [<span class="hljs-number">3</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">3.6</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">      [<span class="hljs-number">4</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">1.3</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">      [<span class="hljs-number">5</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">-2.0</span>, <span class="hljs-string">'e'</span>]], dtype=object)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对于一些模型，你可能只想使用列的子集。我建议你使用loc，用values作索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">22</span>]: model_cols = [<span class="hljs-string">'x0'</span>, <span class="hljs-string">'x1'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: data.loc[:, model_cols].values</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>],</span><br><span class="line">       [ <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ],</span><br><span class="line">       [ <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>一些库原生支持pandas，会自动完成工作：从DataFrame转换到NumPy，将模型的参数名添加到输出表的列或Series。其它情况，你可以手工进行“元数据管理”。</p>
<p>在第12章，我们学习了pandas的Categorical类型和pandas.get_dummies函数。假设数据集中有一个非数值列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: data[<span class="hljs-string">'category'</span>] = pd.Categorical([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                                   categories=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: data</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">   x0    x1    y category</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>        a</span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>        b</span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>        a</span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>        a</span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>        b</span><br></pre></td></tr></table></figure>

<p>如果我们想替换category列为虚变量，我们可以创建虚变量，删除category列，然后添加到结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">26</span>]: dummies = pd.get_dummies(data.category, prefix=<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: data_with_dummies = data.drop(<span class="hljs-string">'category'</span>, axis=<span class="hljs-number">1</span>).join(dummies)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: data_with_dummies</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">   x0    x1    y  category_a  category_b</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>用虚变量拟合某些统计模型会有一些细微差别。当你不只有数字列时，使用Patsy（下一节的主题）可能更简单，更不容易出错。</p>
<h1 id="13-2-用Patsy创建模型描述"><a href="#13-2-用Patsy创建模型描述" class="headerlink" title="13.2 用Patsy创建模型描述"></a>13.2 用Patsy创建模型描述</h1><p>Patsy是Python的一个库，使用简短的字符串“公式语法”描述统计模型（尤其是线性模型），可能是受到了R和S统计编程语言的公式语法的启发。</p>
<p>Patsy适合描述statsmodels的线性模型，因此我会关注于它的主要特点，让你尽快掌握。Patsy的公式是一个特殊的字符串语法，如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y ~ x0 + x1</span><br></pre></td></tr></table></figure>

<p>a+b不是将a与b相加的意思，而是为模型创建的设计矩阵。patsy.dmatrices函数接收一个公式字符串和一个数据集（可以是DataFrame或数组的字典），为线性模型创建设计矩阵：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">0.01</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">0.</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">-1.5</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">3.6</span>, <span class="hljs-number">1.3</span>, <span class="hljs-number">-2.</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: data</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">   x0    x1    y</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: <span class="hljs-keyword">import</span> patsy</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ x0 + x1'</span>, data)</span><br></pre></td></tr></table></figure>

<p>现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: y</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">1</span>)</span><br><span class="line">     y</span><br><span class="line">  <span class="hljs-number">-1.5</span></span><br><span class="line">   <span class="hljs-number">0.0</span></span><br><span class="line">   <span class="hljs-number">3.6</span></span><br><span class="line">   <span class="hljs-number">1.3</span></span><br><span class="line">  <span class="hljs-number">-2.0</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'y'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: X</span><br><span class="line">Out[<span class="hljs-number">34</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  x0     x1</span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">1</span>   <span class="hljs-number">0.01</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">2</span>  <span class="hljs-number">-0.01</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">3</span>   <span class="hljs-number">0.25</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">4</span>  <span class="hljs-number">-4.10</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">5</span>   <span class="hljs-number">0.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'x1'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>这些Patsy的DesignMatrix实例是NumPy的ndarray，带有附加元数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: np.asarray(y)</span><br><span class="line">Out[<span class="hljs-number">35</span>]: </span><br><span class="line">array([[<span class="hljs-number">-1.5</span>],</span><br><span class="line">       [ <span class="hljs-number">0.</span> ],</span><br><span class="line">       [ <span class="hljs-number">3.6</span>],</span><br><span class="line">       [ <span class="hljs-number">1.3</span>],</span><br><span class="line">       [<span class="hljs-number">-2.</span> ]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: np.asarray(X)</span><br><span class="line">Out[<span class="hljs-number">36</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>你可能想Intercept是哪里来的。这是线性模型（比如普通最小二乘回归）的惯例用法。添加 +0 到模型可以不显示intercept：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">37</span>]: patsy.dmatrices(<span class="hljs-string">'y ~ x0 + x1 + 0'</span>, data)[<span class="hljs-number">1</span>]</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  x0     x1</span><br><span class="line">   <span class="hljs-number">1</span>   <span class="hljs-number">0.01</span></span><br><span class="line">   <span class="hljs-number">2</span>  <span class="hljs-number">-0.01</span></span><br><span class="line">   <span class="hljs-number">3</span>   <span class="hljs-number">0.25</span></span><br><span class="line">   <span class="hljs-number">4</span>  <span class="hljs-number">-4.10</span></span><br><span class="line">   <span class="hljs-number">5</span>   <span class="hljs-number">0.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x1'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy对象可以直接传递到算法（比如numpy.linalg.lstsq）中，它执行普通最小二乘回归：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">38</span>]: coef, resid, _, _ = np.linalg.lstsq(X, y)</span><br></pre></td></tr></table></figure>

<p>模型的元数据保留在design_info属性中，因此你可以重新附加列名到拟合系数，以获得一个Series，例如：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: coef</span><br><span class="line">Out[<span class="hljs-number">39</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.3129</span>],</span><br><span class="line">       [<span class="hljs-number">-0.0791</span>],</span><br><span class="line">       [<span class="hljs-number">-0.2655</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: coef = pd.Series(coef.squeeze(), index=X.design_info.column_names)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: coef</span><br><span class="line">Out[<span class="hljs-number">41</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.312910</span></span><br><span class="line">x0          <span class="hljs-number">-0.079106</span></span><br><span class="line">x1          <span class="hljs-number">-0.265464</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="用Patsy公式进行数据转换"><a href="#用Patsy公式进行数据转换" class="headerlink" title="用Patsy公式进行数据转换"></a>用Patsy公式进行数据转换</h2><p>你可以将Python代码与patsy公式结合。在评估公式时，库将尝试查找在封闭作用域内使用的函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">42</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ x0 + np.log(np.abs(x1) + 1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: X</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  x0  np.log(np.abs(x1) + <span class="hljs-number">1</span>)</span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">1</span>                 <span class="hljs-number">0.00995</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">2</span>                 <span class="hljs-number">0.00995</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">3</span>                 <span class="hljs-number">0.22314</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">4</span>                 <span class="hljs-number">1.62924</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">5</span>                 <span class="hljs-number">0.00000</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'np.log(np.abs(x1) + 1)'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>常见的变量转换包括标准化（平均值为0，方差为1）和中心化（减去平均值）。Patsy有内置的函数进行这样的工作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ standardize(x0) + center(x1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">45</span>]: X</span><br><span class="line">Out[<span class="hljs-number">45</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  standardize(x0)  center(x1)</span><br><span class="line">          <span class="hljs-number">1</span>         <span class="hljs-number">-1.41421</span>        <span class="hljs-number">0.78</span></span><br><span class="line">          <span class="hljs-number">1</span>         <span class="hljs-number">-0.70711</span>        <span class="hljs-number">0.76</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0.00000</span>        <span class="hljs-number">1.02</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0.70711</span>       <span class="hljs-number">-3.33</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1.41421</span>        <span class="hljs-number">0.77</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'standardize(x0)'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'center(x1)'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>作为建模的一步，你可能拟合模型到一个数据集，然后用另一个数据集评估模型。另一个数据集可能是剩余的部分或是新数据。当执行中心化和标准化转变，用新数据进行预测要格外小心。因为你必须使用平均值或标准差转换新数据集，这也称作状态转换。</p>
<p>patsy.build_design_matrices函数可以使用原始样本数据集的保存信息，来转换新数据，：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">46</span>]: new_data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">3.1</span>, <span class="hljs-number">-0.5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2.3</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: new_X = patsy.build_design_matrices([X.design_info], new_data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: new_X</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line">[DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>)</span><br><span class="line">   Intercept  standardize(x0)  center(x1)</span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">2.12132</span>        <span class="hljs-number">3.87</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">2.82843</span>        <span class="hljs-number">0.27</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">3.53553</span>        <span class="hljs-number">0.77</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">4.24264</span>        <span class="hljs-number">3.07</span></span><br><span class="line">   Terms:</span><br><span class="line">     <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">     <span class="hljs-string">'standardize(x0)'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">     <span class="hljs-string">'center(x1)'</span> (column <span class="hljs-number">2</span>)]</span><br></pre></td></tr></table></figure>

<p>因为Patsy中的加号不是加法的意义，当你按照名称将数据集的列相加时，你必须用特殊I函数将它们封装起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ I(x0 + x1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">50</span>]: X</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  I(x0 + x1)</span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">1.01</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">1.99</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">3.25</span></span><br><span class="line">          <span class="hljs-number">1</span>       <span class="hljs-number">-0.10</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">5.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'I(x0 + x1)'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy的patsy.builtins模块还有一些其它的内置转换。请查看线上文档。</p>
<p>分类数据有一个特殊的转换类，下面进行讲解。</p>
<h2 id="分类数据和Patsy"><a href="#分类数据和Patsy" class="headerlink" title="分类数据和Patsy"></a>分类数据和Patsy</h2><p>非数值数据可以用多种方式转换为模型设计矩阵。完整的讲解超出了本书范围，最好和统计课一起学习。</p>
<p>当你在Patsy公式中使用非数值数据，它们会默认转换为虚变量。如果有截距，会去掉一个，避免共线性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">51</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'key1'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'key2'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'v1'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'v2'</span>: [<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2.5</span>, <span class="hljs-number">-0.5</span>, <span class="hljs-number">4.0</span>, <span class="hljs-number">-1.2</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">-1.7</span>]</span><br><span class="line">   ....: &#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">52</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: X</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  key1[T.b]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>如果你从模型中忽略截距，每个分类值的列都会包括在设计矩阵的模型中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + 0'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: X</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  key1[a]  key1[b]</span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'key1'</span> (columns <span class="hljs-number">0</span>:<span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>使用C函数，数值列可以截取为分类量：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ C(key2)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">57</span>]: X</span><br><span class="line">Out[<span class="hljs-number">57</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  C(key2)[T<span class="hljs-number">.1</span>]</span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'C(key2)'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>当你在模型中使用多个分类名，事情就会变复杂，因为会包括key1:key2形式的相交部分，它可以用在方差（ANOVA）模型分析中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">58</span>]: data[<span class="hljs-string">'key2'</span>] = data[<span class="hljs-string">'key2'</span>].map(&#123;<span class="hljs-number">0</span>: <span class="hljs-string">'zero'</span>, <span class="hljs-number">1</span>: <span class="hljs-string">'one'</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: data</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line">  key1  key2  v1   v2</span><br><span class="line"><span class="hljs-number">0</span>    a  zero   <span class="hljs-number">1</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    a   one   <span class="hljs-number">2</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>    b  zero   <span class="hljs-number">3</span>  <span class="hljs-number">2.5</span></span><br><span class="line"><span class="hljs-number">3</span>    b   one   <span class="hljs-number">4</span> <span class="hljs-number">-0.5</span></span><br><span class="line"><span class="hljs-number">4</span>    a  zero   <span class="hljs-number">5</span>  <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">5</span>    b   one   <span class="hljs-number">6</span> <span class="hljs-number">-1.2</span></span><br><span class="line"><span class="hljs-number">6</span>    a  zero   <span class="hljs-number">7</span>  <span class="hljs-number">0.2</span></span><br><span class="line"><span class="hljs-number">7</span>    b  zero   <span class="hljs-number">8</span> <span class="hljs-number">-1.7</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + key2'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: X</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  key1[T.b]  key2[T.zero]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'key2'</span> (column <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + key2 + key1:key2'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: X</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">4</span>)</span><br><span class="line">  Intercept  key1[T.b]  key2[T.zero]</span><br><span class="line">key1[T.b]:key2[T.zero]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'key2'</span> (column <span class="hljs-number">2</span>)</span><br><span class="line">    <span class="hljs-string">'key1:key2'</span> (column <span class="hljs-number">3</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy提供转换分类数据的其它方法，包括以特定顺序转换。请参阅线上文档。</p>
<h1 id="13-3-statsmodels介绍"><a href="#13-3-statsmodels介绍" class="headerlink" title="13.3 statsmodels介绍"></a>13.3 statsmodels介绍</h1><p>statsmodels是Python进行拟合多种统计模型、进行统计试验和数据探索可视化的库。Statsmodels包含许多经典的统计方法，但没有贝叶斯方法和机器学习模型。</p>
<p>statsmodels包含的模型有：</p>
<ul>
<li>线性模型，广义线性模型和健壮线性模型</li>
<li>线性混合效应模型</li>
<li>方差（ANOVA）方法分析</li>
<li>时间序列过程和状态空间模型</li>
<li>广义矩估计</li>
</ul>
<p>下面，我会使用一些基本的statsmodels工具，探索Patsy公式和pandasDataFrame对象如何使用模型接口。</p>
<h2 id="估计线性模型"><a href="#估计线性模型" class="headerlink" title="估计线性模型"></a>估计线性模型</h2><p>statsmodels有多种线性回归模型，包括从基本（比如普通最小二乘）到复杂（比如迭代加权最小二乘法）的。</p>
<p>statsmodels的线性模型有两种不同的接口：基于数组和基于公式。它们可以通过API模块引入：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm</span><br><span class="line"><span class="hljs-keyword">import</span> statsmodels.formula.api <span class="hljs-keyword">as</span> smf</span><br></pre></td></tr></table></figure>

<p>为了展示它们的使用方法，我们从一些随机数据生成一个线性模型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dnorm</span><span class="hljs-params">(mean, variance, size=<span class="hljs-number">1</span>)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">if</span> isinstance(size, int):</span><br><span class="line">        size = size,</span><br><span class="line">    <span class="hljs-keyword">return</span> mean + np.sqrt(variance) * np.random.randn(*size)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># For reproducibility</span></span><br><span class="line">np.random.seed(<span class="hljs-number">12345</span>)</span><br><span class="line"></span><br><span class="line">N = <span class="hljs-number">100</span></span><br><span class="line">X = np.c_[dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.4</span>, size=N),</span><br><span class="line">          dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>, size=N),</span><br><span class="line">          dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, size=N)]</span><br><span class="line">eps = dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, size=N)</span><br><span class="line">beta = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.5</span>]</span><br><span class="line"></span><br><span class="line">y = np.dot(X, beta) + eps</span><br></pre></td></tr></table></figure>

<p>这里，我使用了“真实”模型和可知参数beta。此时，dnorm可用来生成正态分布数据，带有特定均值和方差。现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: X[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">66</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.1295</span>, <span class="hljs-number">-1.2128</span>,  <span class="hljs-number">0.5042</span>],</span><br><span class="line">       [ <span class="hljs-number">0.3029</span>, <span class="hljs-number">-0.4357</span>, <span class="hljs-number">-0.2542</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3285</span>, <span class="hljs-number">-0.0253</span>,  <span class="hljs-number">0.1384</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3515</span>, <span class="hljs-number">-0.7196</span>, <span class="hljs-number">-0.2582</span>],</span><br><span class="line">       [ <span class="hljs-number">1.2433</span>, <span class="hljs-number">-0.3738</span>, <span class="hljs-number">-0.5226</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: y[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">67</span>]: array([ <span class="hljs-number">0.4279</span>, <span class="hljs-number">-0.6735</span>, <span class="hljs-number">-0.0909</span>, <span class="hljs-number">-0.4895</span>,<span class="hljs-number">-0.1289</span>])</span><br></pre></td></tr></table></figure>

<p>像之前Patsy看到的，线性模型通常要拟合一个截距。sm.add_constant函数可以添加一个截距的列到现存的矩阵：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: X_model = sm.add_constant(X)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">69</span>]: X_model[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">69</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.1295</span>, <span class="hljs-number">-1.2128</span>,  <span class="hljs-number">0.5042</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    ,  <span class="hljs-number">0.3029</span>, <span class="hljs-number">-0.4357</span>, <span class="hljs-number">-0.2542</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.3285</span>, <span class="hljs-number">-0.0253</span>,  <span class="hljs-number">0.1384</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.3515</span>, <span class="hljs-number">-0.7196</span>, <span class="hljs-number">-0.2582</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    ,  <span class="hljs-number">1.2433</span>, <span class="hljs-number">-0.3738</span>, <span class="hljs-number">-0.5226</span>]])</span><br></pre></td></tr></table></figure>

<p>sm.OLS类可以拟合一个普通最小二乘回归：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">70</span>]: model = sm.OLS(y, X)</span><br></pre></td></tr></table></figure>

<p>这个模型的fit方法返回了一个回归结果对象，它包含估计的模型参数和其它内容：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">71</span>]: results = model.fit()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">72</span>]: array([ <span class="hljs-number">0.1783</span>,  <span class="hljs-number">0.223</span> ,  <span class="hljs-number">0.501</span> ])</span><br></pre></td></tr></table></figure>

<p>对结果使用summary方法可以打印模型的详细诊断结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: print(results.summary())</span><br><span class="line">OLS Regression Results                            </span><br><span class="line">==============================================================================</span><br><span class="line">Dep. Variable:                      y   R-squared:                       <span class="hljs-number">0.430</span></span><br><span class="line">Model:                            OLS   Adj. R-squared:                  <span class="hljs-number">0.413</span></span><br><span class="line">Method:                 Least Squares   F-statistic:                     <span class="hljs-number">24.42</span></span><br><span class="line">Date:                Mon, <span class="hljs-number">25</span> Sep <span class="hljs-number">2017</span>   Prob (F-statistic):           <span class="hljs-number">7.44e-12</span></span><br><span class="line">Time:                        <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">15</span>   Log-Likelihood:                <span class="hljs-number">-34.305</span></span><br><span class="line">No. Observations:                 <span class="hljs-number">100</span>   AIC:                             <span class="hljs-number">74.61</span></span><br><span class="line">Df Residuals:                      <span class="hljs-number">97</span>   BIC:                             <span class="hljs-number">82.42</span></span><br><span class="line">Df Model:                           <span class="hljs-number">3</span>                                         </span><br><span class="line">Covariance Type:            nonrobust                                         </span><br><span class="line">==============================================================================</span><br><span class="line">                 coef    std err          t      P&gt;|t|      [<span class="hljs-number">0.025</span>      <span class="hljs-number">0.975</span>]</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">x1             <span class="hljs-number">0.1783</span>      <span class="hljs-number">0.053</span>      <span class="hljs-number">3.364</span>      <span class="hljs-number">0.001</span>       <span class="hljs-number">0.073</span>       <span class="hljs-number">0.283</span></span><br><span class="line">x2             <span class="hljs-number">0.2230</span>      <span class="hljs-number">0.046</span>      <span class="hljs-number">4.818</span>      <span class="hljs-number">0.000</span>       <span class="hljs-number">0.131</span>       <span class="hljs-number">0.315</span></span><br><span class="line">x3             <span class="hljs-number">0.5010</span>      <span class="hljs-number">0.080</span>      <span class="hljs-number">6.237</span>      <span class="hljs-number">0.000</span>       <span class="hljs-number">0.342</span>       <span class="hljs-number">0.660</span></span><br><span class="line">==============================================================================</span><br><span class="line">Omnibus:                        <span class="hljs-number">4.662</span>   Durbin-Watson:                   <span class="hljs-number">2.201</span></span><br><span class="line">Prob(Omnibus):                  <span class="hljs-number">0.097</span>   Jarque-Bera (JB):                <span class="hljs-number">4.098</span></span><br><span class="line">Skew:                           <span class="hljs-number">0.481</span>   Prob(JB):                        <span class="hljs-number">0.129</span></span><br><span class="line">Kurtosis:                       <span class="hljs-number">3.243</span>   Cond. No.</span><br><span class="line"><span class="hljs-number">1.74</span></span><br><span class="line">==============================================================================</span><br><span class="line">Warnings:</span><br><span class="line">[<span class="hljs-number">1</span>] Standard Errors assume that the covariance matrix of the errors <span class="hljs-keyword">is</span> correctly </span><br><span class="line">specified.</span><br></pre></td></tr></table></figure>

<p>这里的参数名为通用名x1, x2等等。假设所有的模型参数都在一个DataFrame中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: data = pd.DataFrame(X, columns=[<span class="hljs-string">'col0'</span>, <span class="hljs-string">'col1'</span>, <span class="hljs-string">'col2'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">75</span>]: data[<span class="hljs-string">'y'</span>] = y</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: data[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">       col0      col1      col2         y</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.129468</span> <span class="hljs-number">-1.212753</span>  <span class="hljs-number">0.504225</span>  <span class="hljs-number">0.427863</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.302910</span> <span class="hljs-number">-0.435742</span> <span class="hljs-number">-0.254180</span> <span class="hljs-number">-0.673480</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.328522</span> <span class="hljs-number">-0.025302</span>  <span class="hljs-number">0.138351</span> <span class="hljs-number">-0.090878</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.351475</span> <span class="hljs-number">-0.719605</span> <span class="hljs-number">-0.258215</span> <span class="hljs-number">-0.489494</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.243269</span> <span class="hljs-number">-0.373799</span> <span class="hljs-number">-0.522629</span> <span class="hljs-number">-0.128941</span></span><br></pre></td></tr></table></figure>

<p>现在，我们使用statsmodels的公式API和Patsy的公式字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">77</span>]: results = smf.ols(<span class="hljs-string">'y ~ col0 + col1 + col2'</span>, data=data).fit()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.033559</span></span><br><span class="line">col0         <span class="hljs-number">0.176149</span></span><br><span class="line">col1         <span class="hljs-number">0.224826</span></span><br><span class="line">col2         <span class="hljs-number">0.514808</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">79</span>]: results.tvalues</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.952188</span></span><br><span class="line">col0         <span class="hljs-number">3.319754</span></span><br><span class="line">col1         <span class="hljs-number">4.850730</span></span><br><span class="line">col2         <span class="hljs-number">6.303971</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>观察下statsmodels是如何返回Series结果的，附带有DataFrame的列名。当使用公式和pandas对象时，我们不需要使用add_constant。</p>
<p>给出一个样本外数据，你可以根据估计的模型参数计算预测值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">80</span>]: results.predict(data[:<span class="hljs-number">5</span>])</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">-0.002327</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">-0.141904</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">0.041226</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">-0.323070</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">-0.100535</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>statsmodels的线性模型结果还有其它的分析、诊断和可视化工具。除了普通最小二乘模型，还有其它的线性模型。</p>
<h2 id="估计时间序列过程"><a href="#估计时间序列过程" class="headerlink" title="估计时间序列过程"></a>估计时间序列过程</h2><p>statsmodels的另一模型类是进行时间序列分析，包括自回归过程、卡尔曼滤波和其它态空间模型，和多元自回归模型。</p>
<p>用自回归结构和噪声来模拟一些时间序列数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">init_x = <span class="hljs-number">4</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> random</span><br><span class="line">values = [init_x, init_x]</span><br><span class="line">N = <span class="hljs-number">1000</span></span><br><span class="line"></span><br><span class="line">b0 = <span class="hljs-number">0.8</span></span><br><span class="line">b1 = <span class="hljs-number">-0.4</span></span><br><span class="line">noise = dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, N)</span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(N):</span><br><span class="line">    new_x = values[<span class="hljs-number">-1</span>] * b0 + values[<span class="hljs-number">-2</span>] * b1 + noise[i]</span><br><span class="line">    values.append(new_x)</span><br></pre></td></tr></table></figure>

<p>这个数据有AR(2)结构（两个延迟），参数是0.8和-0.4。拟合AR模型时，你可能不知道滞后项的个数，因此可以用较多的滞后量来拟合这个模型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: MAXLAGS = <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: model = sm.tsa.AR(values)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: results = model.fit(MAXLAGS)</span><br></pre></td></tr></table></figure>

<p>结果中的估计参数首先是截距，其次是前两个参数的估计值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">85</span>]: array([<span class="hljs-number">-0.0062</span>,  <span class="hljs-number">0.7845</span>, <span class="hljs-number">-0.4085</span>, <span class="hljs-number">-0.0136</span>,  <span class="hljs-number">0.015</span> ,  <span class="hljs-number">0.0143</span>])</span><br></pre></td></tr></table></figure>

<p>更多的细节以及如何解释结果超出了本书的范围，可以通过statsmodels文档学习更多。</p>
<h1 id="13-4-scikit-learn介绍"><a href="#13-4-scikit-learn介绍" class="headerlink" title="13.4 scikit-learn介绍"></a>13.4 scikit-learn介绍</h1><p>scikit-learn是一个广泛使用、用途多样的Python机器学习库。它包含多种标准监督和非监督机器学习方法和模型选择和评估、数据转换、数据加载和模型持久化工具。这些模型可以用于分类、聚合、预测和其它任务。</p>
<p>机器学习方面的学习和应用scikit-learn和TensorFlow解决实际问题的线上和纸质资料很多。本节中，我会简要介绍scikit-learn API的风格。</p>
<p>写作此书的时候，scikit-learn并没有和pandas深度结合，但是有些第三方包在开发中。尽管如此，pandas非常适合在模型拟合前处理数据集。</p>
<p>举个例子，我用一个Kaggle竞赛的经典数据集，关于泰坦尼克号乘客的生还率。我们用pandas加载测试和训练数据集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: train = pd.read_csv(<span class="hljs-string">'datasets/titanic/train.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">87</span>]: test = pd.read_csv(<span class="hljs-string">'datasets/titanic/test.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: train[:<span class="hljs-number">4</span>]</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">   PassengerId  Survived  Pclass  \</span><br><span class="line"><span class="hljs-number">0</span>            <span class="hljs-number">1</span>         <span class="hljs-number">0</span>       <span class="hljs-number">3</span>   </span><br><span class="line"><span class="hljs-number">1</span>            <span class="hljs-number">2</span>         <span class="hljs-number">1</span>       <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">2</span>            <span class="hljs-number">3</span>         <span class="hljs-number">1</span>       <span class="hljs-number">3</span>   </span><br><span class="line"><span class="hljs-number">3</span>            <span class="hljs-number">4</span>         <span class="hljs-number">1</span>       <span class="hljs-number">1</span>   </span><br><span class="line">                                                Name     Sex   Age  SibSp  \</span><br><span class="line"><span class="hljs-number">0</span>                            Braund, Mr. Owen Harris    male  <span class="hljs-number">22.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">1</span>  Cumings, Mrs. John Bradley (Florence Briggs Th...  female  <span class="hljs-number">38.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">2</span>                             Heikkinen, Miss. Laina  female  <span class="hljs-number">26.0</span>      <span class="hljs-number">0</span>   </span><br><span class="line"><span class="hljs-number">3</span>       Futrelle, Mrs. Jacques Heath (Lily May Peel)  female  <span class="hljs-number">35.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line">   Parch            Ticket     Fare Cabin Embarked  </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>         A/<span class="hljs-number">5</span> <span class="hljs-number">21171</span>   <span class="hljs-number">7.2500</span>   NaN        S  </span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">0</span>          PC <span class="hljs-number">17599</span>  <span class="hljs-number">71.2833</span>   C85        C  </span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">0</span>  STON/O2. <span class="hljs-number">3101282</span>   <span class="hljs-number">7.9250</span>   NaN        S  </span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">0</span>            <span class="hljs-number">113803</span>  <span class="hljs-number">53.1000</span>  C123        S</span><br></pre></td></tr></table></figure>

<p>statsmodels和scikit-learn通常不能接收缺失数据，因此我们要查看列是否包含缺失值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">89</span>]: train.isnull().sum()</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">PassengerId      <span class="hljs-number">0</span></span><br><span class="line">Survived         <span class="hljs-number">0</span></span><br><span class="line">Pclass           <span class="hljs-number">0</span></span><br><span class="line">Name             <span class="hljs-number">0</span></span><br><span class="line">Sex              <span class="hljs-number">0</span></span><br><span class="line">Age            <span class="hljs-number">177</span></span><br><span class="line">SibSp            <span class="hljs-number">0</span></span><br><span class="line">Parch            <span class="hljs-number">0</span></span><br><span class="line">Ticket           <span class="hljs-number">0</span></span><br><span class="line">Fare             <span class="hljs-number">0</span></span><br><span class="line">Cabin          <span class="hljs-number">687</span></span><br><span class="line">Embarked         <span class="hljs-number">2</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: test.isnull().sum()</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">PassengerId      <span class="hljs-number">0</span></span><br><span class="line">Pclass           <span class="hljs-number">0</span></span><br><span class="line">Name             <span class="hljs-number">0</span></span><br><span class="line">Sex              <span class="hljs-number">0</span></span><br><span class="line">Age             <span class="hljs-number">86</span></span><br><span class="line">SibSp            <span class="hljs-number">0</span></span><br><span class="line">Parch            <span class="hljs-number">0</span></span><br><span class="line">Ticket           <span class="hljs-number">0</span></span><br><span class="line">Fare             <span class="hljs-number">1</span></span><br><span class="line">Cabin          <span class="hljs-number">327</span></span><br><span class="line">Embarked         <span class="hljs-number">0</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>在统计和机器学习的例子中，根据数据中的特征，一个典型的任务是预测乘客能否生还。模型现在训练数据集中拟合，然后用样本外测试数据集评估。</p>
<p>我想用年龄作为预测值，但是它包含缺失值。缺失数据补全的方法有多种，我用的是一种简单方法，用训练数据集的中位数补全两个表的空值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: impute_value = train[<span class="hljs-string">'Age'</span>].median()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: train[<span class="hljs-string">'Age'</span>] = train[<span class="hljs-string">'Age'</span>].fillna(impute_value)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: test[<span class="hljs-string">'Age'</span>] = test[<span class="hljs-string">'Age'</span>].fillna(impute_value)</span><br></pre></td></tr></table></figure>

<p>现在我们需要指定模型。我增加了一个列IsFemale，作为“Sex”列的编码：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: train[<span class="hljs-string">'IsFemale'</span>] = (train[<span class="hljs-string">'Sex'</span>] == <span class="hljs-string">'female'</span>).astype(int)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: test[<span class="hljs-string">'IsFemale'</span>] = (test[<span class="hljs-string">'Sex'</span>] == <span class="hljs-string">'female'</span>).astype(int)</span><br></pre></td></tr></table></figure>

<p>然后，我们确定一些模型变量，并创建NumPy数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: predictors = [<span class="hljs-string">'Pclass'</span>, <span class="hljs-string">'IsFemale'</span>, <span class="hljs-string">'Age'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: X_train = train[predictors].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: X_test = test[predictors].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: y_train = train[<span class="hljs-string">'Survived'</span>].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: X_train[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">100</span>]: </span><br><span class="line">array([[  <span class="hljs-number">3.</span>,   <span class="hljs-number">0.</span>,  <span class="hljs-number">22.</span>],</span><br><span class="line">       [  <span class="hljs-number">1.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">38.</span>],</span><br><span class="line">       [  <span class="hljs-number">3.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">26.</span>],</span><br><span class="line">       [  <span class="hljs-number">1.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">35.</span>],</span><br><span class="line">       [  <span class="hljs-number">3.</span>,   <span class="hljs-number">0.</span>,  <span class="hljs-number">35.</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">101</span>]: y_train[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">101</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>我不能保证这是一个好模型，但它的特征都符合。我们用scikit-learn的LogisticRegression模型，创建一个模型实例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">102</span>]: <span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: model = LogisticRegression()</span><br></pre></td></tr></table></figure>

<p>与statsmodels类似，我们可以用模型的fit方法，将它拟合到训练数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">104</span>]: model.fit(X_train, y_train)</span><br><span class="line">Out[<span class="hljs-number">104</span>]: </span><br><span class="line">LogisticRegression(C=<span class="hljs-number">1.0</span>, class_weight=<span class="hljs-literal">None</span>, dual=<span class="hljs-literal">False</span>, fit_intercept=<span class="hljs-literal">True</span>,</span><br><span class="line">          intercept_scaling=<span class="hljs-number">1</span>, max_iter=<span class="hljs-number">100</span>, multi_class=<span class="hljs-string">'ovr'</span>, n_jobs=<span class="hljs-number">1</span>,</span><br><span class="line">          penalty=<span class="hljs-string">'l2'</span>, random_state=<span class="hljs-literal">None</span>, solver=<span class="hljs-string">'liblinear'</span>, tol=<span class="hljs-number">0.0001</span>,</span><br><span class="line">          verbose=<span class="hljs-number">0</span>, warm_start=<span class="hljs-literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>现在，我们可以用model.predict，对测试数据进行预测：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: y_predict = model.predict(X_test)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: y_predict[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">106</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>如果你有测试数据集的真实值，你可以计算准确率或其它错误度量值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(y_true == y_predict).mean()</span><br></pre></td></tr></table></figure>

<p>在实际中，模型训练经常有许多额外的复杂因素。许多模型有可以调节的参数，有些方法（比如交叉验证）可以用来进行参数调节，避免对训练数据过拟合。这通常可以提高预测性或对新数据的健壮性。</p>
<p>交叉验证通过分割训练数据来模拟样本外预测。基于模型的精度得分（比如均方差），可以对模型参数进行网格搜索。有些模型，如logistic回归，有内置的交叉验证的估计类。例如，logisticregressioncv类可以用一个参数指定网格搜索对模型的正则化参数C的粒度：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">107</span>]: <span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegressionCV</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">108</span>]: model_cv = LogisticRegressionCV(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">109</span>]: model_cv.fit(X_train, y_train)</span><br><span class="line">Out[<span class="hljs-number">109</span>]: </span><br><span class="line">LogisticRegressionCV(Cs=<span class="hljs-number">10</span>, class_weight=<span class="hljs-literal">None</span>, cv=<span class="hljs-literal">None</span>, dual=<span class="hljs-literal">False</span>,</span><br><span class="line">           fit_intercept=<span class="hljs-literal">True</span>, intercept_scaling=<span class="hljs-number">1.0</span>, max_iter=<span class="hljs-number">100</span>,</span><br><span class="line">           multi_class=<span class="hljs-string">'ovr'</span>, n_jobs=<span class="hljs-number">1</span>, penalty=<span class="hljs-string">'l2'</span>, random_state=<span class="hljs-literal">None</span>,</span><br><span class="line">           refit=<span class="hljs-literal">True</span>, scoring=<span class="hljs-literal">None</span>, solver=<span class="hljs-string">'lbfgs'</span>, tol=<span class="hljs-number">0.0001</span>, verbose=<span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>要手动进行交叉验证，你可以使用cross_val_score帮助函数，它可以处理数据分割。例如，要交叉验证我们的带有四个不重叠训练数据的模型，可以这样做：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">110</span>]: <span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">111</span>]: model = LogisticRegression(C=<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: scores = cross_val_score(model, X_train, y_train, cv=<span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: scores</span><br><span class="line">Out[<span class="hljs-number">113</span>]: array([ <span class="hljs-number">0.7723</span>,  <span class="hljs-number">0.8027</span>,  <span class="hljs-number">0.7703</span>,  <span class="hljs-number">0.7883</span>])</span><br></pre></td></tr></table></figure>

<p>默认的评分指标取决于模型本身，但是可以明确指定一个评分。交叉验证过的模型需要更长时间来训练，但会有更高的模型性能。</p>
<h1 id="13-5-继续学习"><a href="#13-5-继续学习" class="headerlink" title="13.5 继续学习"></a>13.5 继续学习</h1><p>我只是介绍了一些Python建模库的表面内容，现在有越来越多的框架用于各种统计和机器学习，它们都是用Python或Python用户界面实现的。</p>
<p>这本书的重点是数据规整，有其它的书是关注建模和数据科学工具的。其中优秀的有：</p>
<ul>
<li>Andreas Mueller and Sarah Guido (O’Reilly)的 《Introduction to Machine Learning with Python》</li>
<li>Jake VanderPlas (O’Reilly)的 《Python Data Science Handbook》</li>
<li>Joel Grus (O’Reilly) 的 《Data Science from Scratch: First Principles》</li>
<li>Sebastian Raschka (Packt Publishing) 的《Python Machine Learning》</li>
<li>Aurélien Géron (O’Reilly) 的《Hands-On Machine Learning with Scikit-Learn and TensorFlow》</li>
</ul>
<p>虽然书是学习的好资源，但是随着底层开源软件的发展，书的内容会过时。最好是不断熟悉各种统计和机器学习框架的文档，学习最新的功能和API。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7475 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC6%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E5%8A%A0%E8%BD%BD%E3%80%81%E5%AD%98%E5%82%A8%E4%B8%8E%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F/">《利用Python进行数据分析·第2版》第6章 数据加载、存储与文件格式</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
第6章 数据加载、存储与文件格式
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>访问数据是使用本书所介绍的这些工具的第一步。我会着重介绍pandas的数据输入与输出，虽然别的库中也有不少以此为目的的工具。</p>
<p>输入输出通常可以划分为几个大类：读取文本文件和其他更高效的磁盘存储格式，加载数据库中的数据，利用Web API操作网络资源。</p>
<h1 id="6-1-读写文本格式的数据"><a href="#6-1-读写文本格式的数据" class="headerlink" title="6.1 读写文本格式的数据"></a>6.1 读写文本格式的数据</h1><p>pandas提供了一些用于将表格型数据读取为DataFrame对象的函数。表6-1对它们进行了总结，其中read_csv和read_table可能会是你今后用得最多的。</p>
<p><img src="/images/blog/7178691-958f849e6067b19b.webp" alt="img"></p>
<p>表6-1 pandas中的解析函数</p>
<p>我将大致介绍一下这些函数在将文本数据转换为DataFrame时所用到的一些技术。这些函数的选项可以划分为以下几个大类：</p>
<ul>
<li>索引：将一个或多个列当做返回的DataFrame处理，以及是否从文件、用户获取列名。</li>
<li>类型推断和数据转换：包括用户定义值的转换、和自定义的缺失值标记列表等。</li>
<li>日期解析：包括组合功能，比如将分散在多个列中的日期时间信息组合成结果中的单个列。</li>
<li>迭代：支持对大文件进行逐块迭代。</li>
<li>不规整数据问题：跳过一些行、页脚、注释或其他一些不重要的东西（比如由成千上万个逗号隔开的数值数据）。</li>
</ul>
<p>因为工作中实际碰到的数据可能十分混乱，一些数据加载函数（尤其是read_csv）的选项逐渐变得复杂起来。面对不同的参数，感到头痛很正常（read_csv有超过50个参数）。pandas文档有这些参数的例子，如果你感到阅读某个文件很难，可以通过相似的足够多的例子找到正确的参数。</p>
<p>其中一些函数，比如pandas.read_csv，有类型推断功能，因为列数据的类型不属于数据类型。也就是说，你不需要指定列的类型到底是数值、整数、布尔值，还是字符串。其它的数据格式，如HDF5、Feather和msgpack，会在格式中存储数据类型。</p>
<p>日期和其他自定义类型的处理需要多花点工夫才行。首先我们来看一个以逗号分隔的（CSV）文本文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">8</span>]: !cat examples/ex1.csv</span><br><span class="line">a,b,c,d,message</span><br><span class="line"><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,hello</span><br><span class="line"><span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：这里，我用的是Unix的cat shell命令将文件的原始内容打印到屏幕上。如果你用的是Windows，你可以使用type达到同样的效果。</p>
</blockquote>
<p>由于该文件以逗号分隔，所以我们可以使用read_csv将其读入一个DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">9</span>]: df = pd.read_csv(<span class="hljs-string">'examples/ex1.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">10</span>]: df</span><br><span class="line">Out[<span class="hljs-number">10</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>我们还可以使用read_table，并指定分隔符：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">11</span>]: pd.read_table(<span class="hljs-string">'examples/ex1.csv'</span>, sep=<span class="hljs-string">','</span>)</span><br><span class="line">Out[<span class="hljs-number">11</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>并不是所有文件都有标题行。看看下面这个文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: !cat examples/ex2.csv</span><br><span class="line"><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,hello</span><br><span class="line"><span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<p>读入该文件的办法有两个。你可以让pandas为其分配默认的列名，也可以自己定义列名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">13</span>]: pd.read_csv(<span class="hljs-string">'examples/ex2.csv'</span>, header=<span class="hljs-literal">None</span>)</span><br><span class="line">Out[<span class="hljs-number">13</span>]: </span><br><span class="line">   <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>  hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>  world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>    foo</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: pd.read_csv(<span class="hljs-string">'examples/ex2.csv'</span>, names=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'message'</span>])</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>假设你希望将message列做成DataFrame的索引。你可以明确表示要将该列放到索引4的位置上，也可以通过index_col参数指定”message”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: names = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'message'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: pd.read_csv(<span class="hljs-string">'examples/ex2.csv'</span>, names=names, index_col=<span class="hljs-string">'message'</span>)</span><br><span class="line">Out[<span class="hljs-number">16</span>]: </span><br><span class="line">         a   b   c   d</span><br><span class="line">message               </span><br><span class="line">hello    <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span></span><br><span class="line">world    <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span></span><br><span class="line">foo      <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span></span><br></pre></td></tr></table></figure>

<p>如果希望将多个列做成一个层次化索引，只需传入由列编号或列名组成的列表即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: !cat examples/csv_mindex.csv</span><br><span class="line">key1,key2,value1,value2</span><br><span class="line">one,a,<span class="hljs-number">1</span>,<span class="hljs-number">2</span></span><br><span class="line">one,b,<span class="hljs-number">3</span>,<span class="hljs-number">4</span></span><br><span class="line">one,c,<span class="hljs-number">5</span>,<span class="hljs-number">6</span></span><br><span class="line">one,d,<span class="hljs-number">7</span>,<span class="hljs-number">8</span></span><br><span class="line">two,a,<span class="hljs-number">9</span>,<span class="hljs-number">10</span></span><br><span class="line">two,b,<span class="hljs-number">11</span>,<span class="hljs-number">12</span></span><br><span class="line">two,c,<span class="hljs-number">13</span>,<span class="hljs-number">14</span></span><br><span class="line">two,d,<span class="hljs-number">15</span>,<span class="hljs-number">16</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">18</span>]: parsed = pd.read_csv(<span class="hljs-string">'examples/csv_mindex.csv'</span>,</span><br><span class="line">   ....:                      index_col=[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: parsed</span><br><span class="line">Out[<span class="hljs-number">19</span>]: </span><br><span class="line">           value1  value2</span><br><span class="line">key1 key2                </span><br><span class="line">one  a          <span class="hljs-number">1</span>       <span class="hljs-number">2</span></span><br><span class="line">     b          <span class="hljs-number">3</span>       <span class="hljs-number">4</span></span><br><span class="line">     c          <span class="hljs-number">5</span>       <span class="hljs-number">6</span></span><br><span class="line">     d          <span class="hljs-number">7</span>       <span class="hljs-number">8</span></span><br><span class="line">two  a          <span class="hljs-number">9</span>      <span class="hljs-number">10</span></span><br><span class="line">     b         <span class="hljs-number">11</span>      <span class="hljs-number">12</span></span><br><span class="line">     c         <span class="hljs-number">13</span>      <span class="hljs-number">14</span></span><br><span class="line">     d         <span class="hljs-number">15</span>      <span class="hljs-number">16</span></span><br></pre></td></tr></table></figure>

<p>有些情况下，有些表格可能不是用固定的分隔符去分隔字段的（比如空白符或其它模式）。看看下面这个文本文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">20</span>]: list(open(<span class="hljs-string">'examples/ex3.txt'</span>))</span><br><span class="line">Out[<span class="hljs-number">20</span>]: </span><br><span class="line">[<span class="hljs-string">'            A         B         C\n'</span>,</span><br><span class="line"> <span class="hljs-string">'aaa -0.264438 -1.026059 -0.619500\n'</span>,</span><br><span class="line"> <span class="hljs-string">'bbb  0.927272  0.302904 -0.032399\n'</span>,</span><br><span class="line"> <span class="hljs-string">'ccc -0.264273 -0.386314 -0.217601\n'</span>,</span><br><span class="line"> <span class="hljs-string">'ddd -0.871858 -0.348382  1.100491\n'</span>]</span><br></pre></td></tr></table></figure>

<p>虽然可以手动对数据进行规整，这里的字段是被数量不同的空白字符间隔开的。这种情况下，你可以传递一个正则表达式作为read_table的分隔符。可以用正则表达式表达为\s+，于是有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">21</span>]: result = pd.read_table(<span class="hljs-string">'examples/ex3.txt'</span>, sep=<span class="hljs-string">'\s+'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: result</span><br><span class="line">Out[<span class="hljs-number">22</span>]: </span><br><span class="line">            A         B         C</span><br><span class="line">aaa <span class="hljs-number">-0.264438</span> <span class="hljs-number">-1.026059</span> <span class="hljs-number">-0.619500</span></span><br><span class="line">bbb  <span class="hljs-number">0.927272</span>  <span class="hljs-number">0.302904</span> <span class="hljs-number">-0.032399</span></span><br><span class="line">ccc <span class="hljs-number">-0.264273</span> <span class="hljs-number">-0.386314</span> <span class="hljs-number">-0.217601</span></span><br><span class="line">ddd <span class="hljs-number">-0.871858</span> <span class="hljs-number">-0.348382</span>  <span class="hljs-number">1.100491</span></span><br></pre></td></tr></table></figure>

<p>这里，由于列名比数据行的数量少，所以read_table推断第一列应该是DataFrame的索引。</p>
<p>这些解析器函数还有许多参数可以帮助你处理各种各样的异形文件格式（表6-2列出了一些）。比如说，你可以用skiprows跳过文件的第一行、第三行和第四行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">23</span>]: !cat examples/ex4.csv</span><br><span class="line"><span class="hljs-comment"># hey!</span></span><br><span class="line">a,b,c,d,message</span><br><span class="line"><span class="hljs-comment"># just wanted to make things more difficult for you</span></span><br><span class="line"><span class="hljs-comment"># who reads CSV files with computers, anyway?</span></span><br><span class="line"><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,hello</span><br><span class="line"><span class="hljs-number">5</span>,<span class="hljs-number">6</span>,<span class="hljs-number">7</span>,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,foo</span><br><span class="line">In [<span class="hljs-number">24</span>]: pd.read_csv(<span class="hljs-string">'examples/ex4.csv'</span>, skiprows=[<span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>])</span><br><span class="line">Out[<span class="hljs-number">24</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>缺失值处理是文件解析任务中的一个重要组成部分。缺失数据经常是要么没有（空字符串），要么用某个标记值表示。默认情况下，pandas会用一组经常出现的标记值进行识别，比如NA及NULL：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: !cat examples/ex5.csv</span><br><span class="line">something,a,b,c,d,message</span><br><span class="line">one,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>,NA</span><br><span class="line">two,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,,<span class="hljs-number">8</span>,world</span><br><span class="line">three,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11</span>,<span class="hljs-number">12</span>,foo</span><br><span class="line">In [<span class="hljs-number">26</span>]: result = pd.read_csv(<span class="hljs-string">'examples/ex5.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: result</span><br><span class="line">Out[<span class="hljs-number">27</span>]: </span><br><span class="line">  something  a   b     c   d message</span><br><span class="line"><span class="hljs-number">0</span>       one  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3.0</span>   <span class="hljs-number">4</span>     NaN</span><br><span class="line"><span class="hljs-number">1</span>       two  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   NaN   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>     three  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">12</span>     foo</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: pd.isnull(result)</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">   something      a      b      c      d  message</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>     <span class="hljs-literal">True</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>   <span class="hljs-literal">True</span>  <span class="hljs-literal">False</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>  <span class="hljs-literal">False</span>    <span class="hljs-literal">False</span></span><br></pre></td></tr></table></figure>

<p>na_values可以用一个列表或集合的字符串表示缺失值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: result = pd.read_csv(<span class="hljs-string">'examples/ex5.csv'</span>, na_values=[<span class="hljs-string">'NULL'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: result</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">  something  a   b     c   d message</span><br><span class="line"><span class="hljs-number">0</span>       one  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3.0</span>   <span class="hljs-number">4</span>     NaN</span><br><span class="line"><span class="hljs-number">1</span>       two  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   NaN   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>     three  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>字典的各列可以使用不同的NA标记值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: sentinels = &#123;<span class="hljs-string">'message'</span>: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'NA'</span>], <span class="hljs-string">'something'</span>: [<span class="hljs-string">'two'</span>]&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: pd.read_csv(<span class="hljs-string">'examples/ex5.csv'</span>, na_values=sentinels)</span><br><span class="line">Out[<span class="hljs-number">32</span>]:</span><br><span class="line">something  a   b     c   d message</span><br><span class="line"><span class="hljs-number">0</span>       one  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3.0</span>   <span class="hljs-number">4</span>     NaN</span><br><span class="line"><span class="hljs-number">1</span>       NaN  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   NaN   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>     three  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">12</span>     NaN</span><br></pre></td></tr></table></figure>

<p>表6-2列出了pandas.read_csv和pandas.read_table常用的选项。</p>
<p><img src="/images/blog/7178691-082daf4a00ed9494.webp" alt="img"></p>
<p><img src="/images/blog/7178691-f2bcc0a703c7236f.webp" alt="img"></p>
<p><img src="/images/blog/7178691-597327ade3e94c7a.webp" alt="img"></p>
<h2 id="逐块读取文本文件"><a href="#逐块读取文本文件" class="headerlink" title="逐块读取文本文件"></a>逐块读取文本文件</h2><p>在处理很大的文件时，或找出大文件中的参数集以便于后续处理时，你可能只想读取文件的一小部分或逐块对文件进行迭代。</p>
<p>在看大文件之前，我们先设置pandas显示地更紧些：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: pd.options.display.max_rows = <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>然后有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">34</span>]: result = pd.read_csv(<span class="hljs-string">'examples/ex6.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">35</span>]: result</span><br><span class="line">Out[<span class="hljs-number">35</span>]: </span><br><span class="line">           one       two     three      four key</span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-number">0.467976</span> <span class="hljs-number">-0.038649</span> <span class="hljs-number">-0.295344</span> <span class="hljs-number">-1.824726</span>   L</span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-0.358893</span>  <span class="hljs-number">1.404453</span>  <span class="hljs-number">0.704965</span> <span class="hljs-number">-0.200638</span>   B</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">-0.501840</span>  <span class="hljs-number">0.659254</span> <span class="hljs-number">-0.421691</span> <span class="hljs-number">-0.057688</span>   G</span><br><span class="line"><span class="hljs-number">3</span>     <span class="hljs-number">0.204886</span>  <span class="hljs-number">1.074134</span>  <span class="hljs-number">1.388361</span> <span class="hljs-number">-0.982404</span>   R</span><br><span class="line"><span class="hljs-number">4</span>     <span class="hljs-number">0.354628</span> <span class="hljs-number">-0.133116</span>  <span class="hljs-number">0.283763</span> <span class="hljs-number">-0.837063</span>   Q</span><br><span class="line"><span class="hljs-meta">... </span>       ...       ...       ...       ...  ..</span><br><span class="line"><span class="hljs-number">9995</span>  <span class="hljs-number">2.311896</span> <span class="hljs-number">-0.417070</span> <span class="hljs-number">-1.409599</span> <span class="hljs-number">-0.515821</span>   L</span><br><span class="line"><span class="hljs-number">9996</span> <span class="hljs-number">-0.479893</span> <span class="hljs-number">-0.650419</span>  <span class="hljs-number">0.745152</span> <span class="hljs-number">-0.646038</span>   E</span><br><span class="line"><span class="hljs-number">9997</span>  <span class="hljs-number">0.523331</span>  <span class="hljs-number">0.787112</span>  <span class="hljs-number">0.486066</span>  <span class="hljs-number">1.093156</span>   K</span><br><span class="line"><span class="hljs-number">9998</span> <span class="hljs-number">-0.362559</span>  <span class="hljs-number">0.598894</span> <span class="hljs-number">-1.843201</span>  <span class="hljs-number">0.887292</span>   G</span><br><span class="line"><span class="hljs-number">9999</span> <span class="hljs-number">-0.096376</span> <span class="hljs-number">-1.012999</span> <span class="hljs-number">-0.657431</span> <span class="hljs-number">-0.573315</span>   <span class="hljs-number">0</span></span><br><span class="line">[<span class="hljs-number">10000</span> rows x <span class="hljs-number">5</span> columns]</span><br><span class="line">If you want to only read a small</span><br></pre></td></tr></table></figure>

<p>如果只想读取几行（避免读取整个文件），通过nrows进行指定即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">36</span>]: pd.read_csv(<span class="hljs-string">'examples/ex6.csv'</span>, nrows=<span class="hljs-number">5</span>)</span><br><span class="line">Out[<span class="hljs-number">36</span>]: </span><br><span class="line">        one       two     three      four key</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.467976</span> <span class="hljs-number">-0.038649</span> <span class="hljs-number">-0.295344</span> <span class="hljs-number">-1.824726</span>   L</span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.358893</span>  <span class="hljs-number">1.404453</span>  <span class="hljs-number">0.704965</span> <span class="hljs-number">-0.200638</span>   B</span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.501840</span>  <span class="hljs-number">0.659254</span> <span class="hljs-number">-0.421691</span> <span class="hljs-number">-0.057688</span>   G</span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">0.204886</span>  <span class="hljs-number">1.074134</span>  <span class="hljs-number">1.388361</span> <span class="hljs-number">-0.982404</span>   R</span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.354628</span> <span class="hljs-number">-0.133116</span>  <span class="hljs-number">0.283763</span> <span class="hljs-number">-0.837063</span>   Q</span><br></pre></td></tr></table></figure>

<p>要逐块读取文件，可以指定chunksize（行数）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">874</span>]: chunker = pd.read_csv(<span class="hljs-string">'ch06/ex6.csv'</span>, chunksize=<span class="hljs-number">1000</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">875</span>]: chunker</span><br><span class="line">Out[<span class="hljs-number">875</span>]: &lt;pandas.io.parsers.TextParser at <span class="hljs-number">0x8398150</span>&gt;</span><br></pre></td></tr></table></figure>

<p>read_csv所返回的这个TextParser对象使你可以根据chunksize对文件进行逐块迭代。比如说，我们可以迭代处理ex6.csv，将值计数聚合到”key”列中，如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chunker = pd.read_csv(<span class="hljs-string">'examples/ex6.csv'</span>, chunksize=<span class="hljs-number">1000</span>)</span><br><span class="line"></span><br><span class="line">tot = pd.Series([])</span><br><span class="line"><span class="hljs-keyword">for</span> piece <span class="hljs-keyword">in</span> chunker:</span><br><span class="line">    tot = tot.add(piece[<span class="hljs-string">'key'</span>].value_counts(), fill_value=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">tot = tot.sort_values(ascending=<span class="hljs-literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>然后有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">40</span>]: tot[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">E    <span class="hljs-number">368.0</span></span><br><span class="line">X    <span class="hljs-number">364.0</span></span><br><span class="line">L    <span class="hljs-number">346.0</span></span><br><span class="line">O    <span class="hljs-number">343.0</span></span><br><span class="line">Q    <span class="hljs-number">340.0</span></span><br><span class="line">M    <span class="hljs-number">338.0</span></span><br><span class="line">J    <span class="hljs-number">337.0</span></span><br><span class="line">F    <span class="hljs-number">335.0</span></span><br><span class="line">K    <span class="hljs-number">334.0</span></span><br><span class="line">H    <span class="hljs-number">330.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>TextParser还有一个get_chunk方法，它使你可以读取任意大小的块。</p>
<h2 id="将数据写出到文本格式"><a href="#将数据写出到文本格式" class="headerlink" title="将数据写出到文本格式"></a>将数据写出到文本格式</h2><p>数据也可以被输出为分隔符格式的文本。我们再来看看之前读过的一个CSV文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">41</span>]: data = pd.read_csv(<span class="hljs-string">'examples/ex5.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: data</span><br><span class="line">Out[<span class="hljs-number">42</span>]: </span><br><span class="line">  something  a   b     c   d message</span><br><span class="line"><span class="hljs-number">0</span>       one  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3.0</span>   <span class="hljs-number">4</span>     NaN</span><br><span class="line"><span class="hljs-number">1</span>       two  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   NaN   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>     three  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11.0</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>利用DataFrame的to_csv方法，我们可以将数据写到一个以逗号分隔的文件中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">43</span>]: data.to_csv(<span class="hljs-string">'examples/out.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">44</span>]: !cat examples/out.csv</span><br><span class="line">,something,a,b,c,d,message</span><br><span class="line"><span class="hljs-number">0</span>,one,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3.0</span>,<span class="hljs-number">4</span>,</span><br><span class="line"><span class="hljs-number">1</span>,two,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">2</span>,three,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11.0</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<p>当然，还可以使用其他分隔符（由于这里直接写出到sys.stdout，所以仅仅是打印出文本结果而已）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: <span class="hljs-keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: data.to_csv(sys.stdout, sep=<span class="hljs-string">'|'</span>)</span><br><span class="line">|something|a|b|c|d|message</span><br><span class="line"><span class="hljs-number">0</span>|one|<span class="hljs-number">1</span>|<span class="hljs-number">2</span>|<span class="hljs-number">3.0</span>|<span class="hljs-number">4</span>|</span><br><span class="line"><span class="hljs-number">1</span>|two|<span class="hljs-number">5</span>|<span class="hljs-number">6</span>||<span class="hljs-number">8</span>|world</span><br><span class="line"><span class="hljs-number">2</span>|three|<span class="hljs-number">9</span>|<span class="hljs-number">10</span>|<span class="hljs-number">11.0</span>|<span class="hljs-number">12</span>|foo</span><br></pre></td></tr></table></figure>

<p>缺失值在输出结果中会被表示为空字符串。你可能希望将其表示为别的标记值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">47</span>]: data.to_csv(sys.stdout, na_rep=<span class="hljs-string">'NULL'</span>)</span><br><span class="line">,something,a,b,c,d,message</span><br><span class="line"><span class="hljs-number">0</span>,one,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3.0</span>,<span class="hljs-number">4</span>,NULL</span><br><span class="line"><span class="hljs-number">1</span>,two,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,NULL,<span class="hljs-number">8</span>,world</span><br><span class="line"><span class="hljs-number">2</span>,three,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11.0</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<p>如果没有设置其他选项，则会写出行和列的标签。当然，它们也都可以被禁用：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">48</span>]: data.to_csv(sys.stdout, index=<span class="hljs-literal">False</span>, header=<span class="hljs-literal">False</span>)</span><br><span class="line">one,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3.0</span>,<span class="hljs-number">4</span>,</span><br><span class="line">two,<span class="hljs-number">5</span>,<span class="hljs-number">6</span>,,<span class="hljs-number">8</span>,world</span><br><span class="line">three,<span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11.0</span>,<span class="hljs-number">12</span>,foo</span><br></pre></td></tr></table></figure>

<p>此外，你还可以只写出一部分的列，并以你指定的顺序排列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: data.to_csv(sys.stdout, index=<span class="hljs-literal">False</span>, columns=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>])</span><br><span class="line">a,b,c</span><br><span class="line"><span class="hljs-number">1</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">5</span>,<span class="hljs-number">6</span>,</span><br><span class="line"><span class="hljs-number">9</span>,<span class="hljs-number">10</span>,<span class="hljs-number">11.0</span></span><br></pre></td></tr></table></figure>

<p>Series也有一个to_csv方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: dates = pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">7</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: ts = pd.Series(np.arange(<span class="hljs-number">7</span>), index=dates)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">52</span>]: ts.to_csv(<span class="hljs-string">'examples/tseries.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: !cat examples/tseries.csv</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>,<span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>,<span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>,<span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>,<span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>,<span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>,<span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>,<span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<h2 id="处理分隔符格式"><a href="#处理分隔符格式" class="headerlink" title="处理分隔符格式"></a>处理分隔符格式</h2><p>大部分存储在磁盘上的表格型数据都能用pandas.read_table进行加载。然而，有时还是需要做一些手工处理。由于接收到含有畸形行的文件而使read_table出毛病的情况并不少见。为了说明这些基本工具，看看下面这个简单的CSV文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: !cat examples/ex7.csv</span><br><span class="line"><span class="hljs-string">"a"</span>,<span class="hljs-string">"b"</span>,<span class="hljs-string">"c"</span></span><br><span class="line"><span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>,<span class="hljs-string">"3"</span></span><br><span class="line"><span class="hljs-string">"1"</span>,<span class="hljs-string">"2"</span>,<span class="hljs-string">"3"</span></span><br></pre></td></tr></table></figure>

<p>对于任何单字符分隔符文件，可以直接使用Python内置的csv模块。将任意已打开的文件或文件型的对象传给csv.reader：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> csv</span><br><span class="line">f = open(<span class="hljs-string">'examples/ex7.csv'</span>)</span><br><span class="line"></span><br><span class="line">reader = csv.reader(f)</span><br></pre></td></tr></table></figure>

<p>对这个reader进行迭代将会为每行产生一个元组（并移除了所有的引号）：对这个reader进行迭代将会为每行产生一个元组（并移除了所有的引号）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> reader:</span><br><span class="line">   ....:     print(line)</span><br><span class="line">[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>]</span><br><span class="line">[<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>]</span><br><span class="line">[<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>]</span><br></pre></td></tr></table></figure>

<p>现在，为了使数据格式合乎要求，你需要对其做一些整理工作。我们一步一步来做。首先，读取文件到一个多行的列表中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">57</span>]: <span class="hljs-keyword">with</span> open(<span class="hljs-string">'examples/ex7.csv'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">   ....:     lines = list(csv.reader(f))</span><br></pre></td></tr></table></figure>

<p>然后，我们将这些行分为标题行和数据行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">58</span>]: header, values = lines[<span class="hljs-number">0</span>], lines[<span class="hljs-number">1</span>:]</span><br></pre></td></tr></table></figure>

<p>然后，我们可以用字典构造式和zip(*values)，后者将行转置为列，创建数据列的字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">59</span>]: data_dict = &#123;h: v <span class="hljs-keyword">for</span> h, v <span class="hljs-keyword">in</span> zip(header, zip(*values))&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: data_dict</span><br><span class="line">Out[<span class="hljs-number">60</span>]: &#123;<span class="hljs-string">'a'</span>: (<span class="hljs-string">'1'</span>, <span class="hljs-string">'1'</span>), <span class="hljs-string">'b'</span>: (<span class="hljs-string">'2'</span>, <span class="hljs-string">'2'</span>), <span class="hljs-string">'c'</span>: (<span class="hljs-string">'3'</span>, <span class="hljs-string">'3'</span>)&#125;</span><br></pre></td></tr></table></figure>

<p>CSV文件的形式有很多。只需定义csv.Dialect的一个子类即可定义出新格式（如专门的分隔符、字符串引用约定、行结束符等）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">my_dialect</span><span class="hljs-params">(csv.Dialect)</span>:</span></span><br><span class="line">    lineterminator = <span class="hljs-string">'\n'</span></span><br><span class="line">    delimiter = <span class="hljs-string">';'</span></span><br><span class="line">    quotechar = <span class="hljs-string">'"'</span></span><br><span class="line">    quoting = csv.QUOTE_MINIMAL</span><br><span class="line">reader = csv.reader(f, dialect=my_dialect)</span><br></pre></td></tr></table></figure>

<p>各个CSV语支的参数也可以用关键字的形式提供给csv.reader，而无需定义子类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">reader = csv.reader(f, delimiter=<span class="hljs-string">'|'</span>)</span><br></pre></td></tr></table></figure>

<p>可用的选项（csv.Dialect的属性）及其功能如表6-3所示。</p>
<p><img src="/images/blog/7178691-7a1cee622459072b.webp" alt="img"></p>
<blockquote>
<p>笔记：对于那些使用复杂分隔符或多字符分隔符的文件，csv模块就无能为力了。这种情况下，你就只能使用字符串的split方法或正则表达式方法re.split进行行拆分和其他整理工作了。</p>
</blockquote>
<p>要手工输出分隔符文件，你可以使用csv.writer。它接受一个已打开且可写的文件对象以及跟csv.reader相同的那些语支和格式化选项：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">with</span> open(<span class="hljs-string">'mydata.csv'</span>, <span class="hljs-string">'w'</span>) <span class="hljs-keyword">as</span> f:</span><br><span class="line">    writer = csv.writer(f, dialect=my_dialect)</span><br><span class="line">    writer.writerow((<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>))</span><br><span class="line">    writer.writerow((<span class="hljs-string">'1'</span>, <span class="hljs-string">'2'</span>, <span class="hljs-string">'3'</span>))</span><br><span class="line">    writer.writerow((<span class="hljs-string">'4'</span>, <span class="hljs-string">'5'</span>, <span class="hljs-string">'6'</span>))</span><br><span class="line">    writer.writerow((<span class="hljs-string">'7'</span>, <span class="hljs-string">'8'</span>, <span class="hljs-string">'9'</span>))</span><br></pre></td></tr></table></figure>

<h2 id="JSON数据"><a href="#JSON数据" class="headerlink" title="JSON数据"></a>JSON数据</h2><p>JSON（JavaScript Object Notation的简称）已经成为通过HTTP请求在Web浏览器和其他应用程序之间发送数据的标准格式之一。它是一种比表格型文本格式（如CSV）灵活得多的数据格式。下面是一个例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">obj = <span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">&#123;"name": "Wes",</span></span><br><span class="line"><span class="hljs-string"> "places_lived": ["United States", "Spain", "Germany"],</span></span><br><span class="line"><span class="hljs-string"> "pet": null,</span></span><br><span class="line"><span class="hljs-string"> "siblings": [&#123;"name": "Scott", "age": 30, "pets": ["Zeus", "Zuko"]&#125;,</span></span><br><span class="line"><span class="hljs-string">              &#123;"name": "Katie", "age": 38,</span></span><br><span class="line"><span class="hljs-string">               "pets": ["Sixes", "Stache", "Cisco"]&#125;]</span></span><br><span class="line"><span class="hljs-string">&#125;</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br></pre></td></tr></table></figure>

<p>除其空值null和一些其他的细微差别（如列表末尾不允许存在多余的逗号）之外，JSON非常接近于有效的Python代码。基本类型有对象（字典）、数组（列表）、字符串、数值、布尔值以及null。对象中所有的键都必须是字符串。许多Python库都可以读写JSON数据。我将使用json，因为它是构建于Python标准库中的。通过json.loads即可将JSON字符串转换成Python形式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: <span class="hljs-keyword">import</span> json</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: result = json.loads(obj)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">64</span>]: result</span><br><span class="line">Out[<span class="hljs-number">64</span>]: </span><br><span class="line">&#123;<span class="hljs-string">'name'</span>: <span class="hljs-string">'Wes'</span>,</span><br><span class="line"> <span class="hljs-string">'pet'</span>: <span class="hljs-literal">None</span>,</span><br><span class="line"> <span class="hljs-string">'places_lived'</span>: [<span class="hljs-string">'United States'</span>, <span class="hljs-string">'Spain'</span>, <span class="hljs-string">'Germany'</span>],</span><br><span class="line"> <span class="hljs-string">'siblings'</span>: [&#123;<span class="hljs-string">'age'</span>: <span class="hljs-number">30</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'Scott'</span>, <span class="hljs-string">'pets'</span>: [<span class="hljs-string">'Zeus'</span>, <span class="hljs-string">'Zuko'</span>]&#125;,</span><br><span class="line">  &#123;<span class="hljs-string">'age'</span>: <span class="hljs-number">38</span>, <span class="hljs-string">'name'</span>: <span class="hljs-string">'Katie'</span>, <span class="hljs-string">'pets'</span>: [<span class="hljs-string">'Sixes'</span>, <span class="hljs-string">'Stache'</span>, <span class="hljs-string">'Cisco'</span>]&#125;]&#125;</span><br></pre></td></tr></table></figure>

<p>json.dumps则将Python对象转换成JSON格式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: asjson = json.dumps(result)</span><br></pre></td></tr></table></figure>

<p>如何将（一个或一组）JSON对象转换为DataFrame或其他便于分析的数据结构就由你决定了。最简单方便的方式是：向DataFrame构造器传入一个字典的列表（就是原先的JSON对象），并选取数据字段的子集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: siblings = pd.DataFrame(result[<span class="hljs-string">'siblings'</span>], columns=[<span class="hljs-string">'name'</span>, <span class="hljs-string">'age'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: siblings</span><br><span class="line">Out[<span class="hljs-number">67</span>]: </span><br><span class="line">    name  age</span><br><span class="line"><span class="hljs-number">0</span>  Scott   <span class="hljs-number">30</span></span><br><span class="line"><span class="hljs-number">1</span>  Katie   <span class="hljs-number">38</span></span><br></pre></td></tr></table></figure>

<p>pandas.read_json可以自动将特别格式的JSON数据集转换为Series或DataFrame。例如：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: !cat examples/example.json</span><br><span class="line">[&#123;<span class="hljs-string">"a"</span>: <span class="hljs-number">1</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">2</span>, <span class="hljs-string">"c"</span>: <span class="hljs-number">3</span>&#125;,</span><br><span class="line"> &#123;<span class="hljs-string">"a"</span>: <span class="hljs-number">4</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">5</span>, <span class="hljs-string">"c"</span>: <span class="hljs-number">6</span>&#125;,</span><br><span class="line"> &#123;<span class="hljs-string">"a"</span>: <span class="hljs-number">7</span>, <span class="hljs-string">"b"</span>: <span class="hljs-number">8</span>, <span class="hljs-string">"c"</span>: <span class="hljs-number">9</span>&#125;]</span><br></pre></td></tr></table></figure>

<p>pandas.read_json的默认选项假设JSON数组中的每个对象是表格中的一行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: data = pd.read_json(<span class="hljs-string">'examples/example.json'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: data</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">   a  b  c</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">7</span>  <span class="hljs-number">8</span>  <span class="hljs-number">9</span></span><br></pre></td></tr></table></figure>

<p>第7章中关于USDA Food Database的那个例子进一步讲解了JSON数据的读取和处理（包括嵌套记录）。</p>
<p>如果你需要将数据从pandas输出到JSON，可以使用to_json方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">71</span>]: print(data.to_json())</span><br><span class="line">&#123;<span class="hljs-string">"a"</span>:&#123;<span class="hljs-string">"0"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"1"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"2"</span>:<span class="hljs-number">7</span>&#125;,<span class="hljs-string">"b"</span>:&#123;<span class="hljs-string">"0"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"1"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"2"</span>:<span class="hljs-number">8</span>&#125;,<span class="hljs-string">"c"</span>:&#123;<span class="hljs-string">"0"</span>:<span class="hljs-number">3</span>,<span class="hljs-string">"1"</span>:<span class="hljs-number">6</span>,<span class="hljs-string">"2"</span>:<span class="hljs-number">9</span>&#125;&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: print(data.to_json(orient=<span class="hljs-string">'records'</span>))</span><br><span class="line">[&#123;<span class="hljs-string">"a"</span>:<span class="hljs-number">1</span>,<span class="hljs-string">"b"</span>:<span class="hljs-number">2</span>,<span class="hljs-string">"c"</span>:<span class="hljs-number">3</span>&#125;,&#123;<span class="hljs-string">"a"</span>:<span class="hljs-number">4</span>,<span class="hljs-string">"b"</span>:<span class="hljs-number">5</span>,<span class="hljs-string">"c"</span>:<span class="hljs-number">6</span>&#125;,&#123;<span class="hljs-string">"a"</span>:<span class="hljs-number">7</span>,<span class="hljs-string">"b"</span>:<span class="hljs-number">8</span>,<span class="hljs-string">"c"</span>:<span class="hljs-number">9</span>&#125;]</span><br></pre></td></tr></table></figure>

<h2 id="XML和HTML：Web信息收集"><a href="#XML和HTML：Web信息收集" class="headerlink" title="XML和HTML：Web信息收集"></a>XML和HTML：Web信息收集</h2><p>Python有许多可以读写常见的HTML和XML格式数据的库，包括lxml、Beautiful Soup和html5lib。lxml的速度比较快，但其它的库处理有误的HTML或XML文件更好。</p>
<p>pandas有一个内置的功能，read_html，它可以使用lxml和Beautiful Soup自动将HTML文件中的表格解析为DataFrame对象。为了进行展示，我从美国联邦存款保险公司下载了一个HTML文件（pandas文档中也使用过），它记录了银行倒闭的情况。首先，你需要安装read_html用到的库：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda install lxml</span><br><span class="line">pip install beautifulsoup4 html5lib</span><br></pre></td></tr></table></figure>

<p>如果你用的不是conda，可以使用<code>pip install lxml</code>。</p>
<p>pandas.read_html有一些选项，默认条件下，它会搜索、尝试解析<table>标签内的的表格数据。结果是一个列表的DataFrame对象：</table></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: tables = pd.read_html(<span class="hljs-string">'examples/fdic_failed_bank_list.html'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">74</span>]: len(tables)</span><br><span class="line">Out[<span class="hljs-number">74</span>]: <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">75</span>]: failures = tables[<span class="hljs-number">0</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: failures.head()</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">                      Bank Name             City  ST   CERT  \</span><br><span class="line"><span class="hljs-number">0</span>                   Allied Bank         Mulberry  AR     <span class="hljs-number">91</span>   </span><br><span class="line"><span class="hljs-number">1</span>  The Woodbury Banking Company         Woodbury  GA  <span class="hljs-number">11297</span>   </span><br><span class="line"><span class="hljs-number">2</span>        First CornerStone Bank  King of Prussia  PA  <span class="hljs-number">35312</span>   </span><br><span class="line"><span class="hljs-number">3</span>            Trust Company Bank          Memphis  TN   <span class="hljs-number">9956</span>   </span><br><span class="line"><span class="hljs-number">4</span>    North Milwaukee State Bank        Milwaukee  WI  <span class="hljs-number">20364</span>   </span><br><span class="line">                 Acquiring Institution        Closing Date       Updated Date  </span><br><span class="line"><span class="hljs-number">0</span>                         Today<span class="hljs-string">'s Bank  September 23, 2016  November 17, 2016  </span></span><br><span class="line"><span class="hljs-string">1                          United Bank     August 19, 2016  November 17, 2016  </span></span><br><span class="line"><span class="hljs-string">2  First-Citizens Bank &amp; Trust Company         May 6, 2016  September 6, 2016  </span></span><br><span class="line"><span class="hljs-string">3           The Bank of Fayette County      April 29, 2016  September 6, 2016  </span></span><br><span class="line"><span class="hljs-string">4  First-Citizens Bank &amp; Trust Company      March 11, 2016      June 16, 2016</span></span><br></pre></td></tr></table></figure>

<p>因为failures有许多列，pandas插入了一个换行符\。</p>
<p>这里，我们可以做一些数据清洗和分析（后面章节会进一步讲解），比如计算按年份计算倒闭的银行数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">77</span>]: close_timestamps = pd.to_datetime(failures[<span class="hljs-string">'Closing Date'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: close_timestamps.dt.year.value_counts()</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line"><span class="hljs-number">2010</span>    <span class="hljs-number">157</span></span><br><span class="line"><span class="hljs-number">2009</span>    <span class="hljs-number">140</span></span><br><span class="line"><span class="hljs-number">2011</span>     <span class="hljs-number">92</span></span><br><span class="line"><span class="hljs-number">2012</span>     <span class="hljs-number">51</span></span><br><span class="line"><span class="hljs-number">2008</span>     <span class="hljs-number">25</span></span><br><span class="line">       ... </span><br><span class="line"><span class="hljs-number">2004</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2001</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2007</span>      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2003</span>      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span>      <span class="hljs-number">2</span></span><br><span class="line">Name: Closing Date, Length: <span class="hljs-number">15</span>, dtype: int64</span><br></pre></td></tr></table></figure>

<h2 id="利用lxml-objectify解析XML"><a href="#利用lxml-objectify解析XML" class="headerlink" title="利用lxml.objectify解析XML"></a>利用lxml.objectify解析XML</h2><p>XML（Extensible Markup Language）是另一种常见的支持分层、嵌套数据以及元数据的结构化数据格式。本书所使用的这些文件实际上来自于一个很大的XML文档。</p>
<p>前面，我介绍了pandas.read_html函数，它可以使用lxml或Beautiful Soup从HTML解析数据。XML和HTML的结构很相似，但XML更为通用。这里，我会用一个例子演示如何利用lxml从XML格式解析数据。</p>
<p>纽约大都会运输署发布了一些有关其公交和列车服务的数据资料（<a href="http://www.mta.info/developers/download.html）。这里，我们将看看包含在一组XML文件中的运行情况数据。每项列车或公交服务都有各自的文件（如Metro-North" target="_blank" rel="noopener">http://www.mta.info/developers/download.html）。这里，我们将看看包含在一组XML文件中的运行情况数据。每项列车或公交服务都有各自的文件（如Metro-North</a> Railroad的文件是Performance_MNR.xml），其中每条XML记录就是一条月度数据，如下所示：</p>
<figure class="highlight xml hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-tag">&lt;<span class="hljs-name">INDICATOR</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">INDICATOR_SEQ</span>&gt;</span>373889<span class="hljs-tag">&lt;/<span class="hljs-name">INDICATOR_SEQ</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">PARENT_SEQ</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">PARENT_SEQ</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">AGENCY_NAME</span>&gt;</span>Metro-North Railroad<span class="hljs-tag">&lt;/<span class="hljs-name">AGENCY_NAME</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">INDICATOR_NAME</span>&gt;</span>Escalator Availability<span class="hljs-tag">&lt;/<span class="hljs-name">INDICATOR_NAME</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">DESCRIPTION</span>&gt;</span>Percent of the time that escalators are operational</span><br><span class="line">  systemwide. The availability rate is based on physical observations performed</span><br><span class="line">  the morning of regular business days only. This is a new indicator the agency</span><br><span class="line">  began reporting in 2009.<span class="hljs-tag">&lt;/<span class="hljs-name">DESCRIPTION</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">PERIOD_YEAR</span>&gt;</span>2011<span class="hljs-tag">&lt;/<span class="hljs-name">PERIOD_YEAR</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">PERIOD_MONTH</span>&gt;</span>12<span class="hljs-tag">&lt;/<span class="hljs-name">PERIOD_MONTH</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">CATEGORY</span>&gt;</span>Service Indicators<span class="hljs-tag">&lt;/<span class="hljs-name">CATEGORY</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">FREQUENCY</span>&gt;</span>M<span class="hljs-tag">&lt;/<span class="hljs-name">FREQUENCY</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">DESIRED_CHANGE</span>&gt;</span>U<span class="hljs-tag">&lt;/<span class="hljs-name">DESIRED_CHANGE</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">INDICATOR_UNIT</span>&gt;</span>%<span class="hljs-tag">&lt;/<span class="hljs-name">INDICATOR_UNIT</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">DECIMAL_PLACES</span>&gt;</span>1<span class="hljs-tag">&lt;/<span class="hljs-name">DECIMAL_PLACES</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">YTD_TARGET</span>&gt;</span>97.00<span class="hljs-tag">&lt;/<span class="hljs-name">YTD_TARGET</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">YTD_ACTUAL</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">YTD_ACTUAL</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">MONTHLY_TARGET</span>&gt;</span>97.00<span class="hljs-tag">&lt;/<span class="hljs-name">MONTHLY_TARGET</span>&gt;</span></span><br><span class="line">  <span class="hljs-tag">&lt;<span class="hljs-name">MONTHLY_ACTUAL</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">MONTHLY_ACTUAL</span>&gt;</span></span><br><span class="line"><span class="hljs-tag">&lt;/<span class="hljs-name">INDICATOR</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们先用lxml.objectify解析该文件，然后通过getroot得到该XML文件的根节点的引用：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> lxml <span class="hljs-keyword">import</span> objectify</span><br><span class="line"></span><br><span class="line">path = <span class="hljs-string">'datasets/mta_perf/Performance_MNR.xml'</span></span><br><span class="line">parsed = objectify.parse(open(path))</span><br><span class="line">root = parsed.getroot()</span><br></pre></td></tr></table></figure>

<p>root.INDICATOR返回一个用于产生各个<indicator>XML元素的生成器。对于每条记录，我们可以用标记名（如YTD_ACTUAL）和数据值填充一个字典（排除几个标记）：</indicator></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">data = []</span><br><span class="line"></span><br><span class="line">skip_fields = [<span class="hljs-string">'PARENT_SEQ'</span>, <span class="hljs-string">'INDICATOR_SEQ'</span>,</span><br><span class="line">               <span class="hljs-string">'DESIRED_CHANGE'</span>, <span class="hljs-string">'DECIMAL_PLACES'</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> elt <span class="hljs-keyword">in</span> root.INDICATOR:</span><br><span class="line">    el_data = &#123;&#125;</span><br><span class="line">    <span class="hljs-keyword">for</span> child <span class="hljs-keyword">in</span> elt.getchildren():</span><br><span class="line">        <span class="hljs-keyword">if</span> child.tag <span class="hljs-keyword">in</span> skip_fields:</span><br><span class="line">            <span class="hljs-keyword">continue</span></span><br><span class="line">        el_data[child.tag] = child.pyval</span><br><span class="line">    data.append(el_data)</span><br></pre></td></tr></table></figure>

<p>最后，将这组字典转换为一个DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">81</span>]: perf = pd.DataFrame(data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">82</span>]: perf.head()</span><br><span class="line">Out[<span class="hljs-number">82</span>]:</span><br><span class="line">Empty DataFrame</span><br><span class="line">Columns: []</span><br><span class="line">Index: []</span><br></pre></td></tr></table></figure>

<p>XML数据可以比本例复杂得多。每个标记都可以有元数据。看看下面这个HTML的链接标签（它也算是一段有效的XML）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> StringIO</span><br><span class="line">tag = <span class="hljs-string">'&lt;a href="http://www.google.com"&gt;Google&lt;/a&gt;'</span></span><br><span class="line">root = objectify.parse(StringIO(tag)).getroot()</span><br></pre></td></tr></table></figure>

<p>现在就可以访问标签或链接文本中的任何字段了（如href）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">84</span>]: root</span><br><span class="line">Out[<span class="hljs-number">84</span>]: &lt;Element a at <span class="hljs-number">0x7f6b15817748</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: root.get(<span class="hljs-string">'href'</span>)</span><br><span class="line">Out[<span class="hljs-number">85</span>]: <span class="hljs-string">'http://www.google.com'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: root.text</span><br><span class="line">Out[<span class="hljs-number">86</span>]: <span class="hljs-string">'Google'</span></span><br></pre></td></tr></table></figure>

<h1 id="6-2-二进制数据格式"><a href="#6-2-二进制数据格式" class="headerlink" title="6.2 二进制数据格式"></a>6.2 二进制数据格式</h1><p>实现数据的高效二进制格式存储最简单的办法之一是使用Python内置的pickle序列化。pandas对象都有一个用于将数据以pickle格式保存到磁盘上的to_pickle方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: frame = pd.read_csv(<span class="hljs-string">'examples/ex1.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: frame.to_pickle(<span class="hljs-string">'examples/frame_pickle'</span>)</span><br></pre></td></tr></table></figure>

<p>你可以通过pickle直接读取被pickle化的数据，或是使用更为方便的pandas.read_pickle：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">90</span>]: pd.read_pickle(<span class="hljs-string">'examples/frame_pickle'</span>)</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：pickle仅建议用于短期存储格式。其原因是很难保证该格式永远是稳定的；今天pickle的对象可能无法被后续版本的库unpickle出来。虽然我尽力保证这种事情不会发生在pandas中，但是今后的某个时候说不定还是得“打破”该pickle格式。</p>
</blockquote>
<p>pandas内置支持两个二进制数据格式：HDF5和MessagePack。下一节，我会给出几个HDF5的例子，但我建议你尝试下不同的文件格式，看看它们的速度以及是否适合你的分析工作。pandas或NumPy数据的其它存储格式有：</p>
<ul>
<li>bcolz：一种可压缩的列存储二进制格式，基于Blosc压缩库。</li>
<li>Feather：我与R语言社区的Hadley Wickham设计的一种跨语言的列存储文件格式。Feather使用了Apache Arrow的列式内存格式。</li>
</ul>
<h2 id="使用HDF5格式"><a href="#使用HDF5格式" class="headerlink" title="使用HDF5格式"></a>使用HDF5格式</h2><p>HDF5是一种存储大规模科学数组数据的非常好的文件格式。它可以被作为C标准库，带有许多语言的接口，如Java、Python和MATLAB等。HDF5中的HDF指的是层次型数据格式（hierarchical data format）。每个HDF5文件都含有一个文件系统式的节点结构，它使你能够存储多个数据集并支持元数据。与其他简单格式相比，HDF5支持多种压缩器的即时压缩，还能更高效地存储重复模式数据。对于那些非常大的无法直接放入内存的数据集，HDF5就是不错的选择，因为它可以高效地分块读写。</p>
<p>虽然可以用PyTables或h5py库直接访问HDF5文件，pandas提供了更为高级的接口，可以简化存储Series和DataFrame对象。HDFStore类可以像字典一样，处理低级的细节：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">92</span>]: frame = pd.DataFrame(&#123;<span class="hljs-string">'a'</span>: np.random.randn(<span class="hljs-number">100</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: store = pd.HDFStore(<span class="hljs-string">'mydata.h5'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">94</span>]: store[<span class="hljs-string">'obj1'</span>] = frame</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: store[<span class="hljs-string">'obj1_col'</span>] = frame[<span class="hljs-string">'a'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">96</span>]: store</span><br><span class="line">Out[<span class="hljs-number">96</span>]: </span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">io</span>.<span class="hljs-title">pytables</span>.<span class="hljs-title">HDFStore</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">File</span> <span class="hljs-title">path</span>:</span> mydata.h5</span><br><span class="line">/obj1                frame        (shape-&gt;[100,1])                               </span><br><span class="line">        </span><br><span class="line">/obj1_col            series       (shape-&gt;[100])                                 </span><br><span class="line">        </span><br><span class="line">/obj2                frame_table  (typ-&gt;appendable,nrows-&gt;100,ncols-&gt;1,indexers-&gt;</span><br><span class="line">[index])</span><br><span class="line">/obj3                frame_table  (typ-&gt;appendable,nrows-&gt;100,ncols-&gt;1,indexers-&gt;</span><br><span class="line">[index])</span><br></pre></td></tr></table></figure>

<p>HDF5文件中的对象可以通过与字典一样的API进行获取：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">97</span>]: store[<span class="hljs-string">'obj1'</span>]</span><br><span class="line">Out[<span class="hljs-number">97</span>]: </span><br><span class="line">           a</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">1.965781</span></span><br><span class="line">..       ...</span><br><span class="line"><span class="hljs-number">95</span>  <span class="hljs-number">0.795253</span></span><br><span class="line"><span class="hljs-number">96</span>  <span class="hljs-number">0.118110</span></span><br><span class="line"><span class="hljs-number">97</span> <span class="hljs-number">-0.748532</span></span><br><span class="line"><span class="hljs-number">98</span>  <span class="hljs-number">0.584970</span></span><br><span class="line"><span class="hljs-number">99</span>  <span class="hljs-number">0.152677</span></span><br><span class="line">[<span class="hljs-number">100</span> rows x <span class="hljs-number">1</span> columns]</span><br></pre></td></tr></table></figure>

<p>HDFStore支持两种存储模式，’fixed’和’table’。后者通常会更慢，但是支持使用特殊语法进行查询操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">98</span>]: store.put(<span class="hljs-string">'obj2'</span>, frame, format=<span class="hljs-string">'table'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: store.select(<span class="hljs-string">'obj2'</span>, where=[<span class="hljs-string">'index &gt;= 10 and index &lt;= 15'</span>])</span><br><span class="line">Out[<span class="hljs-number">99</span>]: </span><br><span class="line">           a</span><br><span class="line"><span class="hljs-number">10</span>  <span class="hljs-number">1.007189</span></span><br><span class="line"><span class="hljs-number">11</span> <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">12</span>  <span class="hljs-number">0.274992</span></span><br><span class="line"><span class="hljs-number">13</span>  <span class="hljs-number">0.228913</span></span><br><span class="line"><span class="hljs-number">14</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">15</span>  <span class="hljs-number">0.886429</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: store.close()</span><br></pre></td></tr></table></figure>

<p>put是store[‘obj2’] = frame方法的显示版本，允许我们设置其它的选项，比如格式。</p>
<p>pandas.read_hdf函数可以快捷使用这些工具：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: frame.to_hdf(<span class="hljs-string">'mydata.h5'</span>, <span class="hljs-string">'obj3'</span>, format=<span class="hljs-string">'table'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: pd.read_hdf(<span class="hljs-string">'mydata.h5'</span>, <span class="hljs-string">'obj3'</span>, where=[<span class="hljs-string">'index &lt; 5'</span>])</span><br><span class="line">Out[<span class="hljs-number">102</span>]: </span><br><span class="line">          a</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.965781</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：如果你要处理的数据位于远程服务器，比如Amazon S3或HDFS，使用专门为分布式存储（比如Apache Parquet）的二进制格式也许更加合适。Python的Parquet和其它存储格式还在不断的发展之中，所以这本书中没有涉及。</p>
</blockquote>
<p>如果需要本地处理海量数据，我建议你好好研究一下PyTables和h5py，看看它们能满足你的哪些需求。。由于许多数据分析问题都是IO密集型（而不是CPU密集型），利用HDF5这样的工具能显著提升应用程序的效率。</p>
<blockquote>
<p>注意：HDF5不是数据库。它最适合用作“一次写多次读”的数据集。虽然数据可以在任何时候被添加到文件中，但如果同时发生多个写操作，文件就可能会被破坏。</p>
</blockquote>
<h2 id="读取Microsoft-Excel文件"><a href="#读取Microsoft-Excel文件" class="headerlink" title="读取Microsoft Excel文件"></a>读取Microsoft Excel文件</h2><p>pandas的ExcelFile类或pandas.read_excel函数支持读取存储在Excel 2003（或更高版本）中的表格型数据。这两个工具分别使用扩展包xlrd和openpyxl读取XLS和XLSX文件。你可以用pip或conda安装它们。</p>
<p>要使用ExcelFile，通过传递xls或xlsx路径创建一个实例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">104</span>]: xlsx = pd.ExcelFile(<span class="hljs-string">'examples/ex1.xlsx'</span>)</span><br></pre></td></tr></table></figure>

<p>存储在表单中的数据可以read_excel读取到DataFrame（原书这里写的是用parse解析，但代码中用的是read_excel，是个笔误：只换了代码，没有改文字）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: pd.read_excel(xlsx, <span class="hljs-string">'Sheet1'</span>)</span><br><span class="line">Out[<span class="hljs-number">105</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>如果要读取一个文件中的多个表单，创建ExcelFile会更快，但你也可以将文件名传递到pandas.read_excel：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">106</span>]: frame = pd.read_excel(<span class="hljs-string">'examples/ex1.xlsx'</span>, <span class="hljs-string">'Sheet1'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">107</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">107</span>]: </span><br><span class="line">   a   b   c   d message</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>   hello</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span>   <span class="hljs-number">8</span>   world</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span>  <span class="hljs-number">12</span>     foo</span><br></pre></td></tr></table></figure>

<p>如果要将pandas数据写入为Excel格式，你必须首先创建一个ExcelWriter，然后使用pandas对象的to_excel方法将数据写入到其中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: writer = pd.ExcelWriter(<span class="hljs-string">'examples/ex2.xlsx'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">109</span>]: frame.to_excel(writer, <span class="hljs-string">'Sheet1'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: writer.save()</span><br></pre></td></tr></table></figure>

<p>你还可以不使用ExcelWriter，而是传递文件的路径到to_excel：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">111</span>]: frame.to_excel(<span class="hljs-string">'examples/ex2.xlsx'</span>)</span><br></pre></td></tr></table></figure>

<h1 id="6-3-Web-APIs交互"><a href="#6-3-Web-APIs交互" class="headerlink" title="6.3 Web APIs交互"></a>6.3 Web APIs交互</h1><p>许多网站都有一些通过JSON或其他格式提供数据的公共API。通过Python访问这些API的办法有不少。一个简单易用的办法（推荐）是requests包（<a href="http://docs.python-requests.org/" target="_blank" rel="noopener">http://docs.python-requests.org</a>）。</p>
<p>为了搜索最新的30个GitHub上的pandas主题，我们可以发一个HTTP GET请求，使用requests扩展库：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">113</span>]: <span class="hljs-keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">114</span>]: url = <span class="hljs-string">'https://api.github.com/repos/pandas-dev/pandas/issues'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">115</span>]: resp = requests.get(url)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: resp</span><br><span class="line">Out[<span class="hljs-number">116</span>]: &lt;Response [<span class="hljs-number">200</span>]&gt;</span><br></pre></td></tr></table></figure>

<p>响应对象的json方法会返回一个包含被解析过的JSON字典，加载到一个Python对象中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">117</span>]: data = resp.json()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">118</span>]: data[<span class="hljs-number">0</span>][<span class="hljs-string">'title'</span>]</span><br><span class="line">Out[<span class="hljs-number">118</span>]: <span class="hljs-string">'Period does not round down for frequencies less that 1 hour'</span></span><br></pre></td></tr></table></figure>

<p>data中的每个元素都是一个包含所有GitHub主题页数据（不包含评论）的字典。我们可以直接传递数据到DataFrame，并提取感兴趣的字段：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">119</span>]: issues = pd.DataFrame(data, columns=[<span class="hljs-string">'number'</span>, <span class="hljs-string">'title'</span>,</span><br><span class="line">   .....:                                      <span class="hljs-string">'labels'</span>, <span class="hljs-string">'state'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">120</span>]: issues</span><br><span class="line">Out[<span class="hljs-number">120</span>]:</span><br><span class="line">    number                                              title  \</span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">17666</span>  Period does <span class="hljs-keyword">not</span> round down <span class="hljs-keyword">for</span> frequencies les...   </span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">17665</span>           DOC: improve docstring of function where   </span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">17664</span>               COMPAT: skip <span class="hljs-number">32</span>-bit test on int repr   </span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">17662</span>                          implement Delegator <span class="hljs-class"><span class="hljs-keyword">class</span></span></span><br><span class="line"><span class="hljs-class">4    17654  <span class="hljs-title">BUG</span>:</span> Fix series rename called <span class="hljs-keyword">with</span> str alterin...   </span><br><span class="line">..     ...                                                ...   </span><br><span class="line"><span class="hljs-number">25</span>   <span class="hljs-number">17603</span>  BUG: Correctly localize naive datetime strings...   </span><br><span class="line">26   17599                     core.dtypes.generic --&gt; cython   </span><br><span class="line"><span class="hljs-number">27</span>   <span class="hljs-number">17596</span>   Merge cdate_range functionality into bdate_range   </span><br><span class="line"><span class="hljs-number">28</span>   <span class="hljs-number">17587</span>  Time Grouper bug fix when applied <span class="hljs-keyword">for</span> list gro...   </span><br><span class="line"><span class="hljs-number">29</span>   <span class="hljs-number">17583</span>  BUG: fix tz-aware DatetimeIndex + TimedeltaInd...   </span><br><span class="line">                                               labels state  </span><br><span class="line"><span class="hljs-number">0</span>                                                  []  open  </span><br><span class="line"><span class="hljs-number">1</span>   [&#123;<span class="hljs-string">'id'</span>: <span class="hljs-number">134699</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://api.github.com...  open  </span></span><br><span class="line"><span class="hljs-string">2   [&#123;'</span>id<span class="hljs-string">': 563047854, '</span>url<span class="hljs-string">': '</span>https://api.github....  open  </span><br><span class="line"><span class="hljs-number">3</span>                                                  []  open  </span><br><span class="line"><span class="hljs-number">4</span>   [&#123;<span class="hljs-string">'id'</span>: <span class="hljs-number">76811</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://api.github.com/...  open  </span></span><br><span class="line"><span class="hljs-string">..                                                ...   ...  </span></span><br><span class="line"><span class="hljs-string">25  [&#123;'</span>id<span class="hljs-string">': 76811, '</span>url<span class="hljs-string">': '</span>https://api.github.com/...  open  </span><br><span class="line"><span class="hljs-number">26</span>  [&#123;<span class="hljs-string">'id'</span>: <span class="hljs-number">49094459</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://api.github.c...  open  </span></span><br><span class="line"><span class="hljs-string">27  [&#123;'</span>id<span class="hljs-string">': 35818298, '</span>url<span class="hljs-string">': '</span>https://api.github.c...  open  </span><br><span class="line"><span class="hljs-number">28</span>  [&#123;<span class="hljs-string">'id'</span>: <span class="hljs-number">233160</span>, <span class="hljs-string">'url'</span>: <span class="hljs-string">'https://api.github.com...  open  </span></span><br><span class="line"><span class="hljs-string">29  [&#123;'</span>id<span class="hljs-string">': 76811, '</span>url<span class="hljs-string">': '</span>https://api.github.com/...  open  </span><br><span class="line">[<span class="hljs-number">30</span> rows x <span class="hljs-number">4</span> columns]</span><br></pre></td></tr></table></figure>

<p>花费一些精力，你就可以创建一些更高级的常见的Web API的接口，返回DataFrame对象，方便进行分析。</p>
<h1 id="6-4-数据库交互"><a href="#6-4-数据库交互" class="headerlink" title="6.4 数据库交互"></a>6.4 数据库交互</h1><p>在商业场景下，大多数数据可能不是存储在文本或Excel文件中。基于SQL的关系型数据库（如SQL Server、PostgreSQL和MySQL等）使用非常广泛，其它一些数据库也很流行。数据库的选择通常取决于性能、数据完整性以及应用程序的伸缩性需求。</p>
<p>将数据从SQL加载到DataFrame的过程很简单，此外pandas还有一些能够简化该过程的函数。例如，我将使用SQLite数据库（通过Python内置的sqlite3驱动器）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">121</span>]: <span class="hljs-keyword">import</span> sqlite3</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: query = <span class="hljs-string">"""</span></span><br><span class="line"><span class="hljs-string">   .....: CREATE TABLE test</span></span><br><span class="line"><span class="hljs-string">   .....: (a VARCHAR(20), b VARCHAR(20),</span></span><br><span class="line"><span class="hljs-string">   .....:  c REAL,        d INTEGER</span></span><br><span class="line"><span class="hljs-string">   .....: );"""</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">123</span>]: con = sqlite3.connect(<span class="hljs-string">'mydata.sqlite'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">124</span>]: con.execute(query)</span><br><span class="line">Out[<span class="hljs-number">124</span>]: &lt;sqlite3.Cursor at <span class="hljs-number">0x7f6b12a50f10</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: con.commit()</span><br></pre></td></tr></table></figure>

<p>然后插入几行数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">126</span>]: data = [(<span class="hljs-string">'Atlanta'</span>, <span class="hljs-string">'Georgia'</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">6</span>),</span><br><span class="line">   .....:         (<span class="hljs-string">'Tallahassee'</span>, <span class="hljs-string">'Florida'</span>, <span class="hljs-number">2.6</span>, <span class="hljs-number">3</span>),</span><br><span class="line">   .....:         (<span class="hljs-string">'Sacramento'</span>, <span class="hljs-string">'California'</span>, <span class="hljs-number">1.7</span>, <span class="hljs-number">5</span>)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">127</span>]: stmt = <span class="hljs-string">"INSERT INTO test VALUES(?, ?, ?, ?)"</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">128</span>]: con.executemany(stmt, data)</span><br><span class="line">Out[<span class="hljs-number">128</span>]: &lt;sqlite3.Cursor at <span class="hljs-number">0x7f6b15c66ce0</span>&gt;</span><br></pre></td></tr></table></figure>

<p>从表中选取数据时，大部分Python SQL驱动器（PyODBC、psycopg2、MySQLdb、pymssql等）都会返回一个元组列表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">130</span>]: cursor = con.execute(<span class="hljs-string">'select * from test'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">131</span>]: rows = cursor.fetchall()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: rows</span><br><span class="line">Out[<span class="hljs-number">132</span>]: </span><br><span class="line">[(<span class="hljs-string">'Atlanta'</span>, <span class="hljs-string">'Georgia'</span>, <span class="hljs-number">1.25</span>, <span class="hljs-number">6</span>),</span><br><span class="line"> (<span class="hljs-string">'Tallahassee'</span>, <span class="hljs-string">'Florida'</span>, <span class="hljs-number">2.6</span>, <span class="hljs-number">3</span>),</span><br><span class="line"> (<span class="hljs-string">'Sacramento'</span>, <span class="hljs-string">'California'</span>, <span class="hljs-number">1.7</span>, <span class="hljs-number">5</span>)]</span><br></pre></td></tr></table></figure>

<p>你可以将这个元组列表传给DataFrame构造器，但还需要列名（位于光标的description属性中）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">133</span>]: cursor.description</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">((<span class="hljs-string">'a'</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>),</span><br><span class="line"> (<span class="hljs-string">'b'</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>),</span><br><span class="line"> (<span class="hljs-string">'c'</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>),</span><br><span class="line"> (<span class="hljs-string">'d'</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>, <span class="hljs-literal">None</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: pd.DataFrame(rows, columns=[x[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> cursor.description])</span><br><span class="line">Out[<span class="hljs-number">134</span>]: </span><br><span class="line">             a           b     c  d</span><br><span class="line"><span class="hljs-number">0</span>      Atlanta     Georgia  <span class="hljs-number">1.25</span>  <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">1</span>  Tallahassee     Florida  <span class="hljs-number">2.60</span>  <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2</span>   Sacramento  California  <span class="hljs-number">1.70</span>  <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>这种数据规整操作相当多，你肯定不想每查一次数据库就重写一次。<a href="http://www.sqlalchemy.org/" target="_blank" rel="noopener">SQLAlchemy项目</a>是一个流行的Python SQL工具，它抽象出了SQL数据库中的许多常见差异。pandas有一个read_sql函数，可以让你轻松的从SQLAlchemy连接读取数据。这里，我们用SQLAlchemy连接SQLite数据库，并从之前创建的表读取数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">135</span>]: <span class="hljs-keyword">import</span> sqlalchemy <span class="hljs-keyword">as</span> sqla</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">136</span>]: db = sqla.create_engine(<span class="hljs-string">'sqlite:///mydata.sqlite'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: pd.read_sql(<span class="hljs-string">'select * from test'</span>, db)</span><br><span class="line">Out[<span class="hljs-number">137</span>]: </span><br><span class="line">             a           b     c  d</span><br><span class="line"><span class="hljs-number">0</span>      Atlanta     Georgia  <span class="hljs-number">1.25</span>  <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">1</span>  Tallahassee     Florida  <span class="hljs-number">2.60</span>  <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2</span>   Sacramento  California  <span class="hljs-number">1.70</span>  <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<h1 id="6-5-总结"><a href="#6-5-总结" class="headerlink" title="6.5 总结"></a>6.5 总结</h1><p>访问数据通常是数据分析的第一步。在本章中，我们已经学了一些有用的工具。在接下来的章节中，我们将深入研究数据规整、数据可视化、时间序列分析和其它主题。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7477 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC7%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E6%B8%85%E6%B4%97%E5%92%8C%E5%87%86%E5%A4%87/">《利用Python进行数据分析·第2版》第7章 数据清洗和准备</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
第7章 数据清洗和准备
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>在数据分析和建模的过程中，相当多的时间要用在数据准备上：加载、清理、转换以及重塑。这些工作会占到分析师时间的80%或更多。有时，存储在文件和数据库中的数据的格式不适合某个特定的任务。许多研究者都选择使用通用编程语言（如Python、Perl、R或Java）或UNIX文本处理工具（如sed或awk）对数据格式进行专门处理。幸运的是，pandas和内置的Python标准库提供了一组高级的、灵活的、快速的工具，可以让你轻松地将数据规整为想要的格式。</p>
<p>如果你发现了一种本书或pandas库中没有的数据操作方式，请在邮件列表或GitHub网站上提出。实际上，pandas的许多设计和实现都是由真实应用的需求所驱动的。</p>
<p>在本章中，我会讨论处理缺失数据、重复数据、字符串操作和其它分析数据转换的工具。下一章，我会关注于用多种方法合并、重塑数据集。</p>
<h1 id="7-1-处理缺失数据"><a href="#7-1-处理缺失数据" class="headerlink" title="7.1 处理缺失数据"></a>7.1 处理缺失数据</h1><p>在许多数据分析工作中，缺失数据是经常发生的。pandas的目标之一就是尽量轻松地处理缺失数据。例如，pandas对象的所有描述性统计默认都不包括缺失数据。</p>
<p>缺失数据在pandas中呈现的方式有些不完美，但对于大多数用户可以保证功能正常。对于数值数据，pandas使用浮点值NaN（Not a Number）表示缺失数据。我们称其为哨兵值，可以方便的检测出来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: string_data = pd.Series([<span class="hljs-string">'aardvark'</span>, <span class="hljs-string">'artichoke'</span>, np.nan, <span class="hljs-string">'avocado'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: string_data</span><br><span class="line">Out[<span class="hljs-number">11</span>]:</span><br><span class="line"><span class="hljs-number">0</span>     aardvark</span><br><span class="line"><span class="hljs-number">1</span>    artichoke</span><br><span class="line"><span class="hljs-number">2</span>          NaN</span><br><span class="line"><span class="hljs-number">3</span>      avocado</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: string_data.isnull()</span><br><span class="line">Out[<span class="hljs-number">12</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-literal">True</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-literal">False</span></span><br><span class="line">dtype: bool</span><br></pre></td></tr></table></figure>

<p>在pandas中，我们采用了R语言中的惯用法，即将缺失值表示为NA，它表示不可用not available。在统计应用中，NA数据可能是不存在的数据或者虽然存在，但是没有观察到（例如，数据采集中发生了问题）。当进行数据清洗以进行分析时，最好直接对缺失数据进行分析，以判断数据采集的问题或缺失数据可能导致的偏差。</p>
<p>Python内置的None值在对象数组中也可以作为NA：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">13</span>]: string_data[<span class="hljs-number">0</span>] = <span class="hljs-literal">None</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: string_data.isnull()</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     <span class="hljs-literal">True</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">2</span>     <span class="hljs-literal">True</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-literal">False</span></span><br><span class="line">dtype: bool</span><br></pre></td></tr></table></figure>

<p>pandas项目中还在不断优化内部细节以更好处理缺失数据，像用户API功能，例如pandas.isnull，去除了许多恼人的细节。表7-1列出了一些关于缺失数据处理的函数。</p>
<p><img src="/images/blog/7178691-1a0f73e5bb26ea21.webp" alt="img"></p>
<p>表7-1 NA处理方法</p>
<h2 id="滤除缺失数据"><a href="#滤除缺失数据" class="headerlink" title="滤除缺失数据"></a>滤除缺失数据</h2><p>过滤掉缺失数据的办法有很多种。你可以通过pandas.isnull或布尔索引的手工方法，但dropna可能会更实用一些。对于一个Series，dropna返回一个仅含非空数据和索引值的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: <span class="hljs-keyword">from</span> numpy <span class="hljs-keyword">import</span> nan <span class="hljs-keyword">as</span> NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: data = pd.Series([<span class="hljs-number">1</span>, NA, <span class="hljs-number">3.5</span>, NA, <span class="hljs-number">7</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: data.dropna()</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">7.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>这等价于：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: data[data.notnull()]</span><br><span class="line">Out[<span class="hljs-number">18</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">7.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>而对于DataFrame对象，事情就有点复杂了。你可能希望丢弃全NA或含有NA的行或列。dropna默认丢弃任何含有缺失值的行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">19</span>]: data = pd.DataFrame([[<span class="hljs-number">1.</span>, <span class="hljs-number">6.5</span>, <span class="hljs-number">3.</span>], [<span class="hljs-number">1.</span>, NA, NA],</span><br><span class="line">   ....:                      [NA, NA, NA], [NA, <span class="hljs-number">6.5</span>, <span class="hljs-number">3.</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: cleaned = data.dropna()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: data</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line"><span class="hljs-number">2</span>  NaN  NaN  NaN</span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: cleaned</span><br><span class="line">Out[<span class="hljs-number">22</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>传入how=’all’将只丢弃全为NA的那些行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">23</span>]: data.dropna(how=<span class="hljs-string">'all'</span>)</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>用这种方式丢弃列，只需传入axis=1即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: data[<span class="hljs-number">4</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: data</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span>   <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span> NaN</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span>  NaN  NaN NaN</span><br><span class="line"><span class="hljs-number">2</span>  NaN  NaN  NaN NaN</span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span> NaN</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">26</span>]: data.dropna(axis=<span class="hljs-number">1</span>, how=<span class="hljs-string">'all'</span>)</span><br><span class="line">Out[<span class="hljs-number">26</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line"><span class="hljs-number">2</span>  NaN  NaN  NaN</span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.5</span>  <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>另一个滤除DataFrame行的问题涉及时间序列数据。假设你只想留下一部分观测数据，可以用thresh参数实现此目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">27</span>]: df = pd.DataFrame(np.random.randn(<span class="hljs-number">7</span>, <span class="hljs-number">3</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: df.iloc[:<span class="hljs-number">4</span>, <span class="hljs-number">1</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">29</span>]: df.iloc[:<span class="hljs-number">2</span>, <span class="hljs-number">2</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: df</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>       NaN       NaN</span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.555730</span>       NaN       NaN</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>       NaN  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>       NaN <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: df.dropna()</span><br><span class="line">Out[<span class="hljs-number">31</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: df.dropna(thresh=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">32</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>       NaN  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>       NaN <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br></pre></td></tr></table></figure>

<h2 id="填充缺失数据"><a href="#填充缺失数据" class="headerlink" title="填充缺失数据"></a>填充缺失数据</h2><p>你可能不想滤除缺失数据（有可能会丢弃跟它有关的其他数据），而是希望通过其他方式填补那些“空洞”。对于大多数情况而言，fillna方法是最主要的函数。通过一个常数调用fillna就会将缺失值替换为那个常数值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: df.fillna(<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">0.000000</span> <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br></pre></td></tr></table></figure>

<p>若是通过一个字典调用fillna，就可以实现对不同的列填充不同的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">34</span>]: df.fillna(&#123;<span class="hljs-number">1</span>: <span class="hljs-number">0.5</span>, <span class="hljs-number">2</span>: <span class="hljs-number">0</span>&#125;)</span><br><span class="line">Out[<span class="hljs-number">34</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.500000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.500000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>  <span class="hljs-number">0.500000</span>  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">0.500000</span> <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br></pre></td></tr></table></figure>

<p>fillna默认会返回新对象，但也可以对现有对象进行就地修改：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: _ = df.fillna(<span class="hljs-number">0</span>, inplace=<span class="hljs-literal">True</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: df</span><br><span class="line">Out[<span class="hljs-number">36</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.555730</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.000000</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.092908</span>  <span class="hljs-number">0.000000</span>  <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">0.000000</span> <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.274992</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span> <span class="hljs-number">-0.371843</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br></pre></td></tr></table></figure>

<p>对reindexing有效的那些插值方法也可用于fillna：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">37</span>]: df = pd.DataFrame(np.random.randn(<span class="hljs-number">6</span>, <span class="hljs-number">3</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: df.iloc[<span class="hljs-number">2</span>:, <span class="hljs-number">1</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">39</span>]: df.iloc[<span class="hljs-number">4</span>:, <span class="hljs-number">2</span>] = NA</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: df</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.476985</span>  <span class="hljs-number">3.248944</span> <span class="hljs-number">-1.021228</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.577087</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.523772</span>       NaN  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.713544</span>       NaN <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">-1.860761</span>       NaN       NaN</span><br><span class="line"><span class="hljs-number">5</span> <span class="hljs-number">-1.265934</span>       NaN       NaN</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: df.fillna(method=<span class="hljs-string">'ffill'</span>)</span><br><span class="line">Out[<span class="hljs-number">41</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.476985</span>  <span class="hljs-number">3.248944</span> <span class="hljs-number">-1.021228</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.577087</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.713544</span>  <span class="hljs-number">0.124121</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">-1.860761</span>  <span class="hljs-number">0.124121</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">5</span> <span class="hljs-number">-1.265934</span>  <span class="hljs-number">0.124121</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: df.fillna(method=<span class="hljs-string">'ffill'</span>, limit=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">42</span>]: </span><br><span class="line">          <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.476985</span>  <span class="hljs-number">3.248944</span> <span class="hljs-number">-1.021228</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.577087</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.713544</span>  <span class="hljs-number">0.124121</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">-1.860761</span>       NaN <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">5</span> <span class="hljs-number">-1.265934</span>       NaN <span class="hljs-number">-2.370232</span></span><br></pre></td></tr></table></figure>

<p>只要有些创新，你就可以利用fillna实现许多别的功能。比如说，你可以传入Series的平均值或中位数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">43</span>]: data = pd.Series([<span class="hljs-number">1.</span>, NA, <span class="hljs-number">3.5</span>, NA, <span class="hljs-number">7</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">44</span>]: data.fillna(data.mean())</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.000000</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">3.833333</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">3.500000</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">3.833333</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">7.000000</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>表7-2列出了fillna的参考。</p>
<p><img src="/images/blog/7178691-0bf235386a64c3b5.webp" alt="img"></p>
<p><img src="/images/blog/7178691-4edd39e68f4dc530.webp" alt="img"></p>
<p>fillna函数参数</p>
<h1 id="7-2-数据转换"><a href="#7-2-数据转换" class="headerlink" title="7.2 数据转换"></a>7.2 数据转换</h1><p>本章到目前为止介绍的都是数据的重排。另一类重要操作则是过滤、清理以及其他的转换工作。</p>
<h2 id="移除重复数据"><a href="#移除重复数据" class="headerlink" title="移除重复数据"></a>移除重复数据</h2><p>DataFrame中出现重复行有多种原因。下面就是一个例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: data = pd.DataFrame(&#123;<span class="hljs-string">'k1'</span>: [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>] * <span class="hljs-number">3</span> + [<span class="hljs-string">'two'</span>],</span><br><span class="line">   ....:                      <span class="hljs-string">'k2'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">4</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: data</span><br><span class="line">Out[<span class="hljs-number">46</span>]: </span><br><span class="line">    k1  k2</span><br><span class="line"><span class="hljs-number">0</span>  one   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>  two   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  one   <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  two   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>  one   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">5</span>  two   <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">6</span>  two   <span class="hljs-number">4</span></span><br></pre></td></tr></table></figure>

<p>DataFrame的duplicated方法返回一个布尔型Series，表示各行是否是重复行（前面出现过的行）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">47</span>]: data.duplicated()</span><br><span class="line">Out[<span class="hljs-number">47</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-literal">False</span></span><br><span class="line"><span class="hljs-number">6</span>     <span class="hljs-literal">True</span></span><br><span class="line">dtype: bool</span><br></pre></td></tr></table></figure>

<p>还有一个与此相关的drop_duplicates方法，它会返回一个DataFrame，重复的数组会标为False：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">48</span>]: data.drop_duplicates()</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line">    k1  k2</span><br><span class="line"><span class="hljs-number">0</span>  one   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>  two   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  one   <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  two   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>  one   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">5</span>  two   <span class="hljs-number">4</span></span><br></pre></td></tr></table></figure>

<p>这两个方法默认会判断全部列，你也可以指定部分列进行重复项判断。假设我们还有一列值，且只希望根据k1列过滤重复项：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: data[<span class="hljs-string">'v1'</span>] = range(<span class="hljs-number">7</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">50</span>]: data.drop_duplicates([<span class="hljs-string">'k1'</span>])</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">    k1  k2  v1</span><br><span class="line"><span class="hljs-number">0</span>  one   <span class="hljs-number">1</span>   <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  two   <span class="hljs-number">1</span>   <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>duplicated和drop_duplicates默认保留的是第一个出现的值组合。传入keep=’last’则保留最后一个：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">51</span>]: data.drop_duplicates([<span class="hljs-string">'k1'</span>, <span class="hljs-string">'k2'</span>], keep=<span class="hljs-string">'last'</span>)</span><br><span class="line">Out[<span class="hljs-number">51</span>]: </span><br><span class="line">    k1  k2  v1</span><br><span class="line"><span class="hljs-number">0</span>  one   <span class="hljs-number">1</span>   <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  two   <span class="hljs-number">1</span>   <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  one   <span class="hljs-number">2</span>   <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  two   <span class="hljs-number">3</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>  one   <span class="hljs-number">3</span>   <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">6</span>  two   <span class="hljs-number">4</span>   <span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<h2 id="利用函数或映射进行数据转换"><a href="#利用函数或映射进行数据转换" class="headerlink" title="利用函数或映射进行数据转换"></a>利用函数或映射进行数据转换</h2><p>对于许多数据集，你可能希望根据数组、Series或DataFrame列中的值来实现转换工作。我们来看看下面这组有关肉类的数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">52</span>]: data = pd.DataFrame(&#123;<span class="hljs-string">'food'</span>: [<span class="hljs-string">'bacon'</span>, <span class="hljs-string">'pulled pork'</span>, <span class="hljs-string">'bacon'</span>,</span><br><span class="line">   ....:                               <span class="hljs-string">'Pastrami'</span>, <span class="hljs-string">'corned beef'</span>, <span class="hljs-string">'Bacon'</span>,</span><br><span class="line">   ....:                               <span class="hljs-string">'pastrami'</span>, <span class="hljs-string">'honey ham'</span>, <span class="hljs-string">'nova lox'</span>],</span><br><span class="line">   ....:                      <span class="hljs-string">'ounces'</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">3</span>, <span class="hljs-number">12</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7.5</span>, <span class="hljs-number">8</span>, <span class="hljs-number">3</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: data</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">          food  ounces</span><br><span class="line"><span class="hljs-number">0</span>        bacon     <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">1</span>  pulled pork     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">2</span>        bacon    <span class="hljs-number">12.0</span></span><br><span class="line"><span class="hljs-number">3</span>     Pastrami     <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">4</span>  corned beef     <span class="hljs-number">7.5</span></span><br><span class="line"><span class="hljs-number">5</span>        Bacon     <span class="hljs-number">8.0</span></span><br><span class="line"><span class="hljs-number">6</span>     pastrami     <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">7</span>    honey ham     <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">8</span>     nova lox     <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>假设你想要添加一列表示该肉类食物来源的动物类型。我们先编写一个不同肉类到动物的映射：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meat_to_animal = &#123;</span><br><span class="line">  <span class="hljs-string">'bacon'</span>: <span class="hljs-string">'pig'</span>,</span><br><span class="line">  <span class="hljs-string">'pulled pork'</span>: <span class="hljs-string">'pig'</span>,</span><br><span class="line">  <span class="hljs-string">'pastrami'</span>: <span class="hljs-string">'cow'</span>,</span><br><span class="line">  <span class="hljs-string">'corned beef'</span>: <span class="hljs-string">'cow'</span>,</span><br><span class="line">  <span class="hljs-string">'honey ham'</span>: <span class="hljs-string">'pig'</span>,</span><br><span class="line">  <span class="hljs-string">'nova lox'</span>: <span class="hljs-string">'salmon'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Series的map方法可以接受一个函数或含有映射关系的字典型对象，但是这里有一个小问题，即有些肉类的首字母大写了，而另一些则没有。因此，我们还需要使用Series的str.lower方法，将各个值转换为小写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">55</span>]: lowercased = data[<span class="hljs-string">'food'</span>].str.lower()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">56</span>]: lowercased</span><br><span class="line">Out[<span class="hljs-number">56</span>]: </span><br><span class="line"><span class="hljs-number">0</span>          bacon</span><br><span class="line"><span class="hljs-number">1</span>    pulled pork</span><br><span class="line"><span class="hljs-number">2</span>          bacon</span><br><span class="line"><span class="hljs-number">3</span>       pastrami</span><br><span class="line"><span class="hljs-number">4</span>    corned beef</span><br><span class="line"><span class="hljs-number">5</span>          bacon</span><br><span class="line"><span class="hljs-number">6</span>       pastrami</span><br><span class="line"><span class="hljs-number">7</span>      honey ham</span><br><span class="line"><span class="hljs-number">8</span>       nova lox</span><br><span class="line">Name: food, dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">57</span>]: data[<span class="hljs-string">'animal'</span>] = lowercased.map(meat_to_animal)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: data</span><br><span class="line">Out[<span class="hljs-number">58</span>]: </span><br><span class="line">          food  ounces  animal</span><br><span class="line"><span class="hljs-number">0</span>        bacon     <span class="hljs-number">4.0</span>     pig</span><br><span class="line"><span class="hljs-number">1</span>  pulled pork     <span class="hljs-number">3.0</span>     pig</span><br><span class="line"><span class="hljs-number">2</span>        bacon    <span class="hljs-number">12.0</span>     pig</span><br><span class="line"><span class="hljs-number">3</span>     Pastrami     <span class="hljs-number">6.0</span>     cow</span><br><span class="line"><span class="hljs-number">4</span>  corned beef     <span class="hljs-number">7.5</span>     cow</span><br><span class="line"><span class="hljs-number">5</span>        Bacon     <span class="hljs-number">8.0</span>     pig</span><br><span class="line"><span class="hljs-number">6</span>     pastrami     <span class="hljs-number">3.0</span>     cow</span><br><span class="line"><span class="hljs-number">7</span>    honey ham     <span class="hljs-number">5.0</span>     pig</span><br><span class="line"><span class="hljs-number">8</span>     nova lox     <span class="hljs-number">6.0</span>  salmon</span><br></pre></td></tr></table></figure>

<p>我们也可以传入一个能够完成全部这些工作的函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">59</span>]: data[<span class="hljs-string">'food'</span>].map(<span class="hljs-keyword">lambda</span> x: meat_to_animal[x.lower()])</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line"><span class="hljs-number">0</span>       pig</span><br><span class="line"><span class="hljs-number">1</span>       pig</span><br><span class="line"><span class="hljs-number">2</span>       pig</span><br><span class="line"><span class="hljs-number">3</span>       cow</span><br><span class="line"><span class="hljs-number">4</span>       cow</span><br><span class="line"><span class="hljs-number">5</span>       pig</span><br><span class="line"><span class="hljs-number">6</span>       cow</span><br><span class="line"><span class="hljs-number">7</span>       pig</span><br><span class="line"><span class="hljs-number">8</span>    salmon</span><br><span class="line">Name: food, dtype: object</span><br></pre></td></tr></table></figure>

<p>使用map是一种实现元素级转换以及其他数据清理工作的便捷方式。</p>
<h2 id="替换值"><a href="#替换值" class="headerlink" title="替换值"></a>替换值</h2><p>利用fillna方法填充缺失数据可以看做值替换的一种特殊情况。前面已经看到，map可用于修改对象的数据子集，而replace则提供了一种实现该功能的更简单、更灵活的方式。我们来看看下面这个Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: data = pd.Series([<span class="hljs-number">1.</span>, <span class="hljs-number">-999.</span>, <span class="hljs-number">2.</span>, <span class="hljs-number">-999.</span>, <span class="hljs-number">-1000.</span>, <span class="hljs-number">3.</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: data</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">-999.0</span></span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">-999.0</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">-1000.0</span></span><br><span class="line"><span class="hljs-number">5</span>       <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>-999这个值可能是一个表示缺失数据的标记值。要将其替换为pandas能够理解的NA值，我们可以利用replace来产生一个新的Series（除非传入inplace=True）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: data.replace(<span class="hljs-number">-999</span>, np.nan)</span><br><span class="line">Out[<span class="hljs-number">62</span>]: </span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>       NaN</span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>       NaN</span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">-1000.0</span></span><br><span class="line"><span class="hljs-number">5</span>       <span class="hljs-number">3.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>如果你希望一次性替换多个值，可以传入一个由待替换值组成的列表以及一个替换值：：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">63</span>]: data.replace([<span class="hljs-number">-999</span>, <span class="hljs-number">-1000</span>], np.nan)</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    NaN</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    NaN</span><br><span class="line"><span class="hljs-number">4</span>    NaN</span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">3.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>要让每个值有不同的替换值，可以传递一个替换列表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">64</span>]: data.replace([<span class="hljs-number">-999</span>, <span class="hljs-number">-1000</span>], [np.nan, <span class="hljs-number">0</span>])</span><br><span class="line">Out[<span class="hljs-number">64</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    NaN</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    NaN</span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">3.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>传入的参数也可以是字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: data.replace(&#123;<span class="hljs-number">-999</span>: np.nan, <span class="hljs-number">-1000</span>: <span class="hljs-number">0</span>&#125;)</span><br><span class="line">Out[<span class="hljs-number">65</span>]: </span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    NaN</span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">3</span>    NaN</span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">3.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：data.replace方法与data.str.replace不同，后者做的是字符串的元素级替换。我们会在后面学习Series的字符串方法。</p>
</blockquote>
<h2 id="重命名轴索引"><a href="#重命名轴索引" class="headerlink" title="重命名轴索引"></a>重命名轴索引</h2><p>跟Series中的值一样，轴标签也可以通过函数或映射进行转换，从而得到一个新的不同标签的对象。轴还可以被就地修改，而无需新建一个数据结构。接下来看看下面这个简单的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: data = pd.DataFrame(np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">3</span>, <span class="hljs-number">4</span>)),</span><br><span class="line">   ....:                     index=[<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Colorado'</span>, <span class="hljs-string">'New York'</span>],</span><br><span class="line">   ....:                     columns=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>])</span><br></pre></td></tr></table></figure>

<p>跟Series一样，轴索引也有一个map方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">67</span>]: transform = <span class="hljs-keyword">lambda</span> x: x[:<span class="hljs-number">4</span>].upper()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">68</span>]: data.index.map(transform)</span><br><span class="line">Out[<span class="hljs-number">68</span>]: Index([<span class="hljs-string">'OHIO'</span>, <span class="hljs-string">'COLO'</span>, <span class="hljs-string">'NEW '</span>], dtype=<span class="hljs-string">'object'</span>)</span><br></pre></td></tr></table></figure>

<p>你可以将其赋值给index，这样就可以对DataFrame进行就地修改：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: data.index = data.index.map(transform)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: data</span><br><span class="line">Out[<span class="hljs-number">70</span>]:</span><br><span class="line">one  two  three  four</span><br><span class="line">OHIO    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span>     <span class="hljs-number">3</span></span><br><span class="line">COLO    <span class="hljs-number">4</span>    <span class="hljs-number">5</span>      <span class="hljs-number">6</span>     <span class="hljs-number">7</span></span><br><span class="line">NEW     <span class="hljs-number">8</span>    <span class="hljs-number">9</span>     <span class="hljs-number">10</span>    <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>如果想要创建数据集的转换版（而不是修改原始数据），比较实用的方法是rename：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">71</span>]: data.rename(index=str.title, columns=str.upper)</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line">      ONE  TWO  THREE  FOUR</span><br><span class="line">Ohio    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span>     <span class="hljs-number">3</span></span><br><span class="line">Colo    <span class="hljs-number">4</span>    <span class="hljs-number">5</span>      <span class="hljs-number">6</span>     <span class="hljs-number">7</span></span><br><span class="line">New     <span class="hljs-number">8</span>    <span class="hljs-number">9</span>     <span class="hljs-number">10</span>    <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>特别说明一下，rename可以结合字典型对象实现对部分轴标签的更新：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">72</span>]: data.rename(index=&#123;<span class="hljs-string">'OHIO'</span>: <span class="hljs-string">'INDIANA'</span>&#125;,</span><br><span class="line">   ....:             columns=&#123;<span class="hljs-string">'three'</span>: <span class="hljs-string">'peekaboo'</span>&#125;)</span><br><span class="line">Out[<span class="hljs-number">72</span>]:</span><br><span class="line">one  two  peekaboo  four</span><br><span class="line">INDIANA    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>         <span class="hljs-number">2</span>     <span class="hljs-number">3</span></span><br><span class="line">COLO       <span class="hljs-number">4</span>    <span class="hljs-number">5</span>         <span class="hljs-number">6</span>     <span class="hljs-number">7</span></span><br><span class="line">NEW        <span class="hljs-number">8</span>    <span class="hljs-number">9</span>        <span class="hljs-number">10</span>    <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>rename可以实现复制DataFrame并对其索引和列标签进行赋值。如果希望就地修改某个数据集，传入inplace=True即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: data.rename(index=&#123;<span class="hljs-string">'OHIO'</span>: <span class="hljs-string">'INDIANA'</span>&#125;, inplace=<span class="hljs-literal">True</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">74</span>]: data</span><br><span class="line">Out[<span class="hljs-number">74</span>]: </span><br><span class="line">         one  two  three  four</span><br><span class="line">INDIANA    <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span>     <span class="hljs-number">3</span></span><br><span class="line">COLO       <span class="hljs-number">4</span>    <span class="hljs-number">5</span>      <span class="hljs-number">6</span>     <span class="hljs-number">7</span></span><br><span class="line">NEW        <span class="hljs-number">8</span>    <span class="hljs-number">9</span>     <span class="hljs-number">10</span>    <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<h2 id="离散化和面元划分"><a href="#离散化和面元划分" class="headerlink" title="离散化和面元划分"></a>离散化和面元划分</h2><p>为了便于分析，连续数据常常被离散化或拆分为“面元”（bin）。假设有一组人员数据，而你希望将它们划分为不同的年龄组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: ages = [<span class="hljs-number">20</span>, <span class="hljs-number">22</span>, <span class="hljs-number">25</span>, <span class="hljs-number">27</span>, <span class="hljs-number">21</span>, <span class="hljs-number">23</span>, <span class="hljs-number">37</span>, <span class="hljs-number">31</span>, <span class="hljs-number">61</span>, <span class="hljs-number">45</span>, <span class="hljs-number">41</span>, <span class="hljs-number">32</span>]</span><br></pre></td></tr></table></figure>

<p>接下来将这些数据划分为“18到25”、“26到35”、“35到60”以及“60以上”几个面元。要实现该功能，你需要使用pandas的cut函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">76</span>]: bins = [<span class="hljs-number">18</span>, <span class="hljs-number">25</span>, <span class="hljs-number">35</span>, <span class="hljs-number">60</span>, <span class="hljs-number">100</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: cats = pd.cut(ages, bins)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: cats</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">[(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], (<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], (<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>], (<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], ..., (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>], (<span class="hljs-number">60</span>, <span class="hljs-number">100</span>], (<span class="hljs-number">35</span>,<span class="hljs-number">60</span>], (<span class="hljs-number">35</span>, <span class="hljs-number">60</span>], (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>]]</span><br><span class="line">Length: <span class="hljs-number">12</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[int64]): [(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>] &lt; (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>] &lt; (<span class="hljs-number">35</span>, <span class="hljs-number">60</span>] &lt; (<span class="hljs-number">60</span>, <span class="hljs-number">100</span>]]</span><br></pre></td></tr></table></figure>

<p>pandas返回的是一个特殊的Categorical对象。结果展示了pandas.cut划分的面元。你可以将其看做一组表示面元名称的字符串。它的底层含有一个表示不同分类名称的类型数组，以及一个codes属性中的年龄数据的标签：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: cats.codes</span><br><span class="line">Out[<span class="hljs-number">79</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>], dtype=int8)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">80</span>]: cats.categories</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">IntervalIndex([(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>], (<span class="hljs-number">25</span>, <span class="hljs-number">35</span>], (<span class="hljs-number">35</span>, <span class="hljs-number">60</span>], (<span class="hljs-number">60</span>, <span class="hljs-number">100</span>]]</span><br><span class="line">              closed=<span class="hljs-string">'right'</span>,</span><br><span class="line">              dtype=<span class="hljs-string">'interval[int64]'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">81</span>]: pd.value_counts(cats)</span><br><span class="line">Out[<span class="hljs-number">81</span>]: </span><br><span class="line">(<span class="hljs-number">18</span>, <span class="hljs-number">25</span>]     <span class="hljs-number">5</span></span><br><span class="line">(<span class="hljs-number">35</span>, <span class="hljs-number">60</span>]     <span class="hljs-number">3</span></span><br><span class="line">(<span class="hljs-number">25</span>, <span class="hljs-number">35</span>]     <span class="hljs-number">3</span></span><br><span class="line">(<span class="hljs-number">60</span>, <span class="hljs-number">100</span>]    <span class="hljs-number">1</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>pd.value_counts(cats)是pandas.cut结果的面元计数。</p>
<p>跟“区间”的数学符号一样，圆括号表示开端，而方括号则表示闭端（包括）。哪边是闭端可以通过right=False进行修改：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: pd.cut(ages, [<span class="hljs-number">18</span>, <span class="hljs-number">26</span>, <span class="hljs-number">36</span>, <span class="hljs-number">61</span>, <span class="hljs-number">100</span>], right=<span class="hljs-literal">False</span>)</span><br><span class="line">Out[<span class="hljs-number">82</span>]: </span><br><span class="line">[[<span class="hljs-number">18</span>, <span class="hljs-number">26</span>), [<span class="hljs-number">18</span>, <span class="hljs-number">26</span>), [<span class="hljs-number">18</span>, <span class="hljs-number">26</span>), [<span class="hljs-number">26</span>, <span class="hljs-number">36</span>), [<span class="hljs-number">18</span>, <span class="hljs-number">26</span>), ..., [<span class="hljs-number">26</span>, <span class="hljs-number">36</span>), [<span class="hljs-number">61</span>, <span class="hljs-number">100</span>), [<span class="hljs-number">36</span>,</span><br><span class="line"> <span class="hljs-number">61</span>), [<span class="hljs-number">36</span>, <span class="hljs-number">61</span>), [<span class="hljs-number">26</span>, <span class="hljs-number">36</span>)]</span><br><span class="line">Length: <span class="hljs-number">12</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[int64]): [[<span class="hljs-number">18</span>, <span class="hljs-number">26</span>) &lt; [<span class="hljs-number">26</span>, <span class="hljs-number">36</span>) &lt; [<span class="hljs-number">36</span>, <span class="hljs-number">61</span>) &lt; [<span class="hljs-number">61</span>, <span class="hljs-number">100</span>)]</span><br></pre></td></tr></table></figure>

<p>你可 以通过传递一个列表或数组到labels，设置自己的面元名称：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">83</span>]: group_names = [<span class="hljs-string">'Youth'</span>, <span class="hljs-string">'YoungAdult'</span>, <span class="hljs-string">'MiddleAged'</span>, <span class="hljs-string">'Senior'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: pd.cut(ages, bins, labels=group_names)</span><br><span class="line">Out[<span class="hljs-number">84</span>]: </span><br><span class="line">[Youth, Youth, Youth, YoungAdult, Youth, ..., YoungAdult, Senior, MiddleAged, Mid</span><br><span class="line">dleAged, YoungAdult]</span><br><span class="line">Length: <span class="hljs-number">12</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, object): [Youth &lt; YoungAdult &lt; MiddleAged &lt; Senior]</span><br></pre></td></tr></table></figure>

<p>如果向cut传入的是面元的数量而不是确切的面元边界，则它会根据数据的最小值和最大值计算等长面元。下面这个例子中，我们将一些均匀分布的数据分成四组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: data = np.random.rand(<span class="hljs-number">20</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: pd.cut(data, <span class="hljs-number">4</span>, precision=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line">[(<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.76</span>, <span class="hljs-number">0.97</span>], (<span class="hljs-number">0.76</span>, <span class="hljs-number">0.97</span>], (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], ..., (<span class="hljs-number">0.34</span></span><br><span class="line">, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.55</span>, <span class="hljs-number">0.76</span>], (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>], (<span class="hljs-number">0.12</span>, <span class="hljs-number">0.34</span>]]</span><br><span class="line">Length: <span class="hljs-number">20</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">0.12</span>, <span class="hljs-number">0.34</span>] &lt; (<span class="hljs-number">0.34</span>, <span class="hljs-number">0.55</span>] &lt; (<span class="hljs-number">0.55</span>, <span class="hljs-number">0.76</span>] &lt; </span><br><span class="line">(<span class="hljs-number">0.76</span>, <span class="hljs-number">0.97</span>]]</span><br></pre></td></tr></table></figure>

<p>选项precision=2，限定小数只有两位。</p>
<p>qcut是一个非常类似于cut的函数，它可以根据样本分位数对数据进行面元划分。根据数据的分布情况，cut可能无法使各个面元中含有相同数量的数据点。而qcut由于使用的是样本分位数，因此可以得到大小基本相等的面元：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: data = np.random.randn(<span class="hljs-number">1000</span>)  <span class="hljs-comment"># Normally distributed</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: cats = pd.qcut(data, <span class="hljs-number">4</span>)  <span class="hljs-comment"># Cut into quartiles</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: cats</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">[(<span class="hljs-number">-0.0265</span>, <span class="hljs-number">0.62</span>], (<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>], (<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>], (<span class="hljs-number">-0.0265</span>, <span class="hljs-number">0.62</span>]</span><br><span class="line">, ..., (<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.68</span>], (<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>], (<span class="hljs-number">-0.68</span>,</span><br><span class="line"> <span class="hljs-number">-0.0265</span>]]</span><br><span class="line">Length: <span class="hljs-number">1000</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.68</span>] &lt; (<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>] &lt; (<span class="hljs-number">-0.0265</span>,</span><br><span class="line"> <span class="hljs-number">0.62</span>] &lt;</span><br><span class="line">                                    (<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: pd.value_counts(cats)</span><br><span class="line">Out[<span class="hljs-number">90</span>]:</span><br><span class="line">(<span class="hljs-number">0.62</span>, <span class="hljs-number">3.928</span>]       <span class="hljs-number">250</span></span><br><span class="line">(<span class="hljs-number">-0.0265</span>, <span class="hljs-number">0.62</span>]     <span class="hljs-number">250</span></span><br><span class="line">(<span class="hljs-number">-0.68</span>, <span class="hljs-number">-0.0265</span>]    <span class="hljs-number">250</span></span><br><span class="line">(<span class="hljs-number">-2.95</span>, <span class="hljs-number">-0.68</span>]      <span class="hljs-number">250</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>与cut类似，你也可以传递自定义的分位数（0到1之间的数值，包含端点）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: pd.qcut(data, [<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, <span class="hljs-number">0.5</span>, <span class="hljs-number">0.9</span>, <span class="hljs-number">1.</span>])</span><br><span class="line">Out[<span class="hljs-number">91</span>]: </span><br><span class="line">[(<span class="hljs-number">-0.0265</span>, <span class="hljs-number">1.286</span>], (<span class="hljs-number">-0.0265</span>, <span class="hljs-number">1.286</span>], (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-0.0265</span>, <span class="hljs-number">1.286</span>], (<span class="hljs-number">-0.026</span></span><br><span class="line"><span class="hljs-number">5</span>, <span class="hljs-number">1.286</span>], ..., (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>], (<span class="hljs-number">-2.95</span>, <span class="hljs-number">-1.187</span>], (<span class="hljs-number">-0.0265</span>, </span><br><span class="line"><span class="hljs-number">1.286</span>], (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>]]</span><br><span class="line">Length: <span class="hljs-number">1000</span></span><br><span class="line">Categories (<span class="hljs-number">4</span>, interval[float64]): [(<span class="hljs-number">-2.95</span>, <span class="hljs-number">-1.187</span>] &lt; (<span class="hljs-number">-1.187</span>, <span class="hljs-number">-0.0265</span>] &lt; (<span class="hljs-number">-0.026</span></span><br><span class="line"><span class="hljs-number">5</span>, <span class="hljs-number">1.286</span>] &lt;</span><br><span class="line">                                    (<span class="hljs-number">1.286</span>, <span class="hljs-number">3.928</span>]]</span><br></pre></td></tr></table></figure>

<p>本章稍后在讲解聚合和分组运算时会再次用到cut和qcut，因为这两个离散化函数对分位和分组分析非常重要。</p>
<h2 id="检测和过滤异常值"><a href="#检测和过滤异常值" class="headerlink" title="检测和过滤异常值"></a>检测和过滤异常值</h2><p>过滤或变换异常值（outlier）在很大程度上就是运用数组运算。来看一个含有正态分布数据的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">92</span>]: data = pd.DataFrame(np.random.randn(<span class="hljs-number">1000</span>, <span class="hljs-number">4</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: data.describe()</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line">                 <span class="hljs-number">0</span>            <span class="hljs-number">1</span>            <span class="hljs-number">2</span>            <span class="hljs-number">3</span></span><br><span class="line">count  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span></span><br><span class="line">mean      <span class="hljs-number">0.049091</span>     <span class="hljs-number">0.026112</span>    <span class="hljs-number">-0.002544</span>    <span class="hljs-number">-0.051827</span></span><br><span class="line">std       <span class="hljs-number">0.996947</span>     <span class="hljs-number">1.007458</span>     <span class="hljs-number">0.995232</span>     <span class="hljs-number">0.998311</span></span><br><span class="line">min      <span class="hljs-number">-3.645860</span>    <span class="hljs-number">-3.184377</span>    <span class="hljs-number">-3.745356</span>    <span class="hljs-number">-3.428254</span></span><br><span class="line"><span class="hljs-number">25</span>%      <span class="hljs-number">-0.599807</span>    <span class="hljs-number">-0.612162</span>    <span class="hljs-number">-0.687373</span>    <span class="hljs-number">-0.747478</span></span><br><span class="line"><span class="hljs-number">50</span>%       <span class="hljs-number">0.047101</span>    <span class="hljs-number">-0.013609</span>    <span class="hljs-number">-0.022158</span>    <span class="hljs-number">-0.088274</span></span><br><span class="line"><span class="hljs-number">75</span>%       <span class="hljs-number">0.756646</span>     <span class="hljs-number">0.695298</span>     <span class="hljs-number">0.699046</span>     <span class="hljs-number">0.623331</span></span><br><span class="line">max       <span class="hljs-number">2.653656</span>     <span class="hljs-number">3.525865</span>     <span class="hljs-number">2.735527</span>     <span class="hljs-number">3.366626</span></span><br></pre></td></tr></table></figure>

<p>假设你想要找出某列中绝对值大小超过3的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: col = data[<span class="hljs-number">2</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: col[np.abs(col) &gt; <span class="hljs-number">3</span>]</span><br><span class="line">Out[<span class="hljs-number">95</span>]: </span><br><span class="line"><span class="hljs-number">41</span>    <span class="hljs-number">-3.399312</span></span><br><span class="line"><span class="hljs-number">136</span>   <span class="hljs-number">-3.745356</span></span><br><span class="line">Name: <span class="hljs-number">2</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>要选出全部含有“超过3或－3的值”的行，你可以在布尔型DataFrame中使用any方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: data[(np.abs(data) &gt; <span class="hljs-number">3</span>).any(<span class="hljs-number">1</span>)]</span><br><span class="line">Out[<span class="hljs-number">96</span>]: </span><br><span class="line">            <span class="hljs-number">0</span>         <span class="hljs-number">1</span>         <span class="hljs-number">2</span>         <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">41</span>   <span class="hljs-number">0.457246</span> <span class="hljs-number">-0.025907</span> <span class="hljs-number">-3.399312</span> <span class="hljs-number">-0.974657</span></span><br><span class="line"><span class="hljs-number">60</span>   <span class="hljs-number">1.951312</span>  <span class="hljs-number">3.260383</span>  <span class="hljs-number">0.963301</span>  <span class="hljs-number">1.201206</span></span><br><span class="line"><span class="hljs-number">136</span>  <span class="hljs-number">0.508391</span> <span class="hljs-number">-0.196713</span> <span class="hljs-number">-3.745356</span> <span class="hljs-number">-1.520113</span></span><br><span class="line"><span class="hljs-number">235</span> <span class="hljs-number">-0.242459</span> <span class="hljs-number">-3.056990</span>  <span class="hljs-number">1.918403</span> <span class="hljs-number">-0.578828</span></span><br><span class="line"><span class="hljs-number">258</span>  <span class="hljs-number">0.682841</span>  <span class="hljs-number">0.326045</span>  <span class="hljs-number">0.425384</span> <span class="hljs-number">-3.428254</span></span><br><span class="line"><span class="hljs-number">322</span>  <span class="hljs-number">1.179227</span> <span class="hljs-number">-3.184377</span>  <span class="hljs-number">1.369891</span> <span class="hljs-number">-1.074833</span></span><br><span class="line"><span class="hljs-number">544</span> <span class="hljs-number">-3.548824</span>  <span class="hljs-number">1.553205</span> <span class="hljs-number">-2.186301</span>  <span class="hljs-number">1.277104</span></span><br><span class="line"><span class="hljs-number">635</span> <span class="hljs-number">-0.578093</span>  <span class="hljs-number">0.193299</span>  <span class="hljs-number">1.397822</span>  <span class="hljs-number">3.366626</span></span><br><span class="line"><span class="hljs-number">782</span> <span class="hljs-number">-0.207434</span>  <span class="hljs-number">3.525865</span>  <span class="hljs-number">0.283070</span>  <span class="hljs-number">0.544635</span></span><br><span class="line"><span class="hljs-number">803</span> <span class="hljs-number">-3.645860</span>  <span class="hljs-number">0.255475</span> <span class="hljs-number">-0.549574</span> <span class="hljs-number">-1.907459</span></span><br></pre></td></tr></table></figure>

<p>根据这些条件，就可以对值进行设置。下面的代码可以将值限制在区间－3到3以内：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">97</span>]: data[np.abs(data) &gt; <span class="hljs-number">3</span>] = np.sign(data) * <span class="hljs-number">3</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: data.describe()</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">                 <span class="hljs-number">0</span>            <span class="hljs-number">1</span>            <span class="hljs-number">2</span>            <span class="hljs-number">3</span></span><br><span class="line">count  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span>  <span class="hljs-number">1000.000000</span></span><br><span class="line">mean      <span class="hljs-number">0.050286</span>     <span class="hljs-number">0.025567</span>    <span class="hljs-number">-0.001399</span>    <span class="hljs-number">-0.051765</span></span><br><span class="line">std       <span class="hljs-number">0.992920</span>     <span class="hljs-number">1.004214</span>     <span class="hljs-number">0.991414</span>     <span class="hljs-number">0.995761</span></span><br><span class="line">min      <span class="hljs-number">-3.000000</span>    <span class="hljs-number">-3.000000</span>    <span class="hljs-number">-3.000000</span>    <span class="hljs-number">-3.000000</span></span><br><span class="line"><span class="hljs-number">25</span>%      <span class="hljs-number">-0.599807</span>    <span class="hljs-number">-0.612162</span>    <span class="hljs-number">-0.687373</span>    <span class="hljs-number">-0.747478</span></span><br><span class="line"><span class="hljs-number">50</span>%       <span class="hljs-number">0.047101</span>    <span class="hljs-number">-0.013609</span>    <span class="hljs-number">-0.022158</span>    <span class="hljs-number">-0.088274</span></span><br><span class="line"><span class="hljs-number">75</span>%       <span class="hljs-number">0.756646</span>     <span class="hljs-number">0.695298</span>     <span class="hljs-number">0.699046</span>     <span class="hljs-number">0.623331</span></span><br><span class="line">max       <span class="hljs-number">2.653656</span>     <span class="hljs-number">3.000000</span>     <span class="hljs-number">2.735527</span>     <span class="hljs-number">3.000000</span></span><br></pre></td></tr></table></figure>

<p>根据数据的值是正还是负，np.sign(data)可以生成1和-1：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">99</span>]: np.sign(data).head()</span><br><span class="line">Out[<span class="hljs-number">99</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-1.0</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">-1.0</span>  <span class="hljs-number">1.0</span> <span class="hljs-number">-1.0</span> <span class="hljs-number">-1.0</span></span><br></pre></td></tr></table></figure>

<h2 id="排列和随机采样"><a href="#排列和随机采样" class="headerlink" title="排列和随机采样"></a>排列和随机采样</h2><p>利用numpy.random.permutation函数可以轻松实现对Series或DataFrame的列的排列工作（permuting，随机重排序）。通过需要排列的轴的长度调用permutation，可产生一个表示新顺序的整数数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">100</span>]: df = pd.DataFrame(np.arange(<span class="hljs-number">5</span> * <span class="hljs-number">4</span>).reshape((<span class="hljs-number">5</span>, <span class="hljs-number">4</span>)))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">101</span>]: sampler = np.random.permutation(<span class="hljs-number">5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: sampler</span><br><span class="line">Out[<span class="hljs-number">102</span>]: array([<span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">4</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>然后就可以在基于iloc的索引操作或take函数中使用该数组了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">103</span>]: df</span><br><span class="line">Out[<span class="hljs-number">103</span>]: </span><br><span class="line">    <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">4</span>   <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">8</span>   <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">12</span>  <span class="hljs-number">13</span>  <span class="hljs-number">14</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">16</span>  <span class="hljs-number">17</span>  <span class="hljs-number">18</span>  <span class="hljs-number">19</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">104</span>]: df.take(sampler)</span><br><span class="line">Out[<span class="hljs-number">104</span>]: </span><br><span class="line">    <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">12</span>  <span class="hljs-number">13</span>  <span class="hljs-number">14</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">4</span>   <span class="hljs-number">5</span>   <span class="hljs-number">6</span>   <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">16</span>  <span class="hljs-number">17</span>  <span class="hljs-number">18</span>  <span class="hljs-number">19</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">8</span>   <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span></span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<p>如果不想用替换的方式选取随机子集，可以在Series和DataFrame上使用sample方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: df.sample(n=<span class="hljs-number">3</span>)</span><br><span class="line">Out[<span class="hljs-number">105</span>]: </span><br><span class="line">    <span class="hljs-number">0</span>   <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">12</span>  <span class="hljs-number">13</span>  <span class="hljs-number">14</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">16</span>  <span class="hljs-number">17</span>  <span class="hljs-number">18</span>  <span class="hljs-number">19</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">8</span>   <span class="hljs-number">9</span>  <span class="hljs-number">10</span>  <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>要通过替换的方式产生样本（允许重复选择），可以传递replace=True到sample：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">106</span>]: choices = pd.Series([<span class="hljs-number">5</span>, <span class="hljs-number">7</span>, <span class="hljs-number">-1</span>, <span class="hljs-number">6</span>, <span class="hljs-number">4</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">107</span>]: draws = choices.sample(n=<span class="hljs-number">10</span>, replace=<span class="hljs-literal">True</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">108</span>]: draws</span><br><span class="line">Out[<span class="hljs-number">108</span>]: </span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">-1</span></span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h2 id="计算指标-哑变量"><a href="#计算指标-哑变量" class="headerlink" title="计算指标/哑变量"></a>计算指标/哑变量</h2><p>另一种常用于统计建模或机器学习的转换方式是：将分类变量（categorical variable）转换为“哑变量”或“指标矩阵”。</p>
<p>如果DataFrame的某一列中含有k个不同的值，则可以派生出一个k列矩阵或DataFrame（其值全为1和0）。pandas有一个get_dummies函数可以实现该功能（其实自己动手做一个也不难）。使用之前的一个DataFrame例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'data1'</span>: range(<span class="hljs-number">6</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: pd.get_dummies(df[<span class="hljs-string">'key'</span>])</span><br><span class="line">Out[<span class="hljs-number">110</span>]: </span><br><span class="line">   a  b  c</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>有时候，你可能想给指标DataFrame的列加上一个前缀，以便能够跟其他数据进行合并。get_dummies的prefix参数可以实现该功能：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">111</span>]: dummies = pd.get_dummies(df[<span class="hljs-string">'key'</span>], prefix=<span class="hljs-string">'key'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: df_with_dummy = df[[<span class="hljs-string">'data1'</span>]].join(dummies)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: df_with_dummy</span><br><span class="line">Out[<span class="hljs-number">113</span>]: </span><br><span class="line">   data1  key_a  key_b  key_c</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">3</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span>      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>      <span class="hljs-number">0</span>      <span class="hljs-number">1</span>      <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>如果DataFrame中的某行同属于多个分类，则事情就会有点复杂。看一下MovieLens 1M数据集，14章会更深入地研究它：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">114</span>]: mnames = [<span class="hljs-string">'movie_id'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'genres'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">115</span>]: movies = pd.read_table(<span class="hljs-string">'datasets/movielens/movies.dat'</span>, sep=<span class="hljs-string">'::'</span>,</span><br><span class="line">   .....:                        header=<span class="hljs-literal">None</span>, names=mnames)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: movies[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">116</span>]: </span><br><span class="line">   movie_id                               title                        genres</span><br><span class="line"><span class="hljs-number">0</span>         <span class="hljs-number">1</span>                    Toy Story (<span class="hljs-number">1995</span>)   Animation|Children<span class="hljs-string">'s|Comedy</span></span><br><span class="line"><span class="hljs-string">1         2                      Jumanji (1995)  Adventure|Children'</span>s|Fantasy</span><br><span class="line"><span class="hljs-number">2</span>         <span class="hljs-number">3</span>             Grumpier Old Men (<span class="hljs-number">1995</span>)                Comedy|Romance</span><br><span class="line"><span class="hljs-number">3</span>         <span class="hljs-number">4</span>            Waiting to Exhale (<span class="hljs-number">1995</span>)                  Comedy|Drama</span><br><span class="line"><span class="hljs-number">4</span>         <span class="hljs-number">5</span>  Father of the Bride Part II (<span class="hljs-number">1995</span>)                        Comedy</span><br><span class="line"><span class="hljs-number">5</span>         <span class="hljs-number">6</span>                         Heat (<span class="hljs-number">1995</span>)         Action|Crime|Thriller</span><br><span class="line"><span class="hljs-number">6</span>         <span class="hljs-number">7</span>                      Sabrina (<span class="hljs-number">1995</span>)                Comedy|Romance</span><br><span class="line"><span class="hljs-number">7</span>         <span class="hljs-number">8</span>                 Tom <span class="hljs-keyword">and</span> Huck (<span class="hljs-number">1995</span>)          Adventure|Children<span class="hljs-string">'s</span></span><br><span class="line"><span class="hljs-string">8         9                 Sudden Death (1995)</span></span><br><span class="line"><span class="hljs-string">Action</span></span><br><span class="line"><span class="hljs-string">9        10                    GoldenEye (1995)     Action|Adventure|Thriller</span></span><br></pre></td></tr></table></figure>

<p>要为每个genre添加指标变量就需要做一些数据规整操作。首先，我们从数据集中抽取出不同的genre值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">117</span>]: all_genres = []</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">118</span>]: <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> movies.genres:</span><br><span class="line">   .....:     all_genres.extend(x.split(<span class="hljs-string">'|'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">119</span>]: genres = pd.unique(all_genres)</span><br></pre></td></tr></table></figure>

<p>现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">120</span>]: genres</span><br><span class="line">Out[<span class="hljs-number">120</span>]: </span><br><span class="line">array([<span class="hljs-string">'Animation'</span>, <span class="hljs-string">"Children's"</span>, <span class="hljs-string">'Comedy'</span>, <span class="hljs-string">'Adventure'</span>, <span class="hljs-string">'Fantasy'</span>,</span><br><span class="line">       <span class="hljs-string">'Romance'</span>, <span class="hljs-string">'Drama'</span>, <span class="hljs-string">'Action'</span>, <span class="hljs-string">'Crime'</span>, <span class="hljs-string">'Thriller'</span>,<span class="hljs-string">'Horror'</span>,</span><br><span class="line">       <span class="hljs-string">'Sci-Fi'</span>, <span class="hljs-string">'Documentary'</span>, <span class="hljs-string">'War'</span>, <span class="hljs-string">'Musical'</span>, <span class="hljs-string">'Mystery'</span>, <span class="hljs-string">'Film-Noir'</span>,</span><br><span class="line">       <span class="hljs-string">'Western'</span>], dtype=object)</span><br></pre></td></tr></table></figure>

<p>构建指标DataFrame的方法之一是从一个全零DataFrame开始：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">121</span>]: zero_matrix = np.zeros((len(movies), len(genres)))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: dummies = pd.DataFrame(zero_matrix, columns=genres)</span><br></pre></td></tr></table></figure>

<p>现在，迭代每一部电影，并将dummies各行的条目设为1。要这么做，我们使用dummies.columns来计算每个类型的列索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">123</span>]: gen = movies.genres[<span class="hljs-number">0</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">124</span>]: gen.split(<span class="hljs-string">'|'</span>)</span><br><span class="line">Out[<span class="hljs-number">124</span>]: [<span class="hljs-string">'Animation'</span>, <span class="hljs-string">"Children's"</span>, <span class="hljs-string">'Comedy'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: dummies.columns.get_indexer(gen.split(<span class="hljs-string">'|'</span>))</span><br><span class="line">Out[<span class="hljs-number">125</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>])</span><br></pre></td></tr></table></figure>

<p>然后，根据索引，使用.iloc设定值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">126</span>]: <span class="hljs-keyword">for</span> i, gen <span class="hljs-keyword">in</span> enumerate(movies.genres):</span><br><span class="line">   .....:     indices = dummies.columns.get_indexer(gen.split(<span class="hljs-string">'|'</span>))</span><br><span class="line">   .....:     dummies.iloc[i, indices] = <span class="hljs-number">1</span></span><br><span class="line">   .....:</span><br></pre></td></tr></table></figure>

<p>然后，和以前一样，再将其与movies合并起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">127</span>]: movies_windic = movies.join(dummies.add_prefix(<span class="hljs-string">'Genre_'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">128</span>]: movies_windic.iloc[<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">128</span>]: </span><br><span class="line">movie_id                                       <span class="hljs-number">1</span></span><br><span class="line">title                           Toy Story (<span class="hljs-number">1995</span>)</span><br><span class="line">genres               Animation|Children<span class="hljs-string">'s|Comedy</span></span><br><span class="line"><span class="hljs-string">Genre_Animation                                1</span></span><br><span class="line"><span class="hljs-string">Genre_Children'</span>s                               <span class="hljs-number">1</span></span><br><span class="line">Genre_Comedy                                   <span class="hljs-number">1</span></span><br><span class="line">Genre_Adventure                                <span class="hljs-number">0</span></span><br><span class="line">Genre_Fantasy                                  <span class="hljs-number">0</span></span><br><span class="line">Genre_Romance                                  <span class="hljs-number">0</span></span><br><span class="line">Genre_Drama                                    <span class="hljs-number">0</span></span><br><span class="line">                                ...             </span><br><span class="line">Genre_Crime                                    <span class="hljs-number">0</span></span><br><span class="line">Genre_Thriller                                 <span class="hljs-number">0</span></span><br><span class="line">Genre_Horror                                   <span class="hljs-number">0</span></span><br><span class="line">Genre_Sci-Fi                                   <span class="hljs-number">0</span></span><br><span class="line">Genre_Documentary                              <span class="hljs-number">0</span></span><br><span class="line">Genre_War                                      <span class="hljs-number">0</span></span><br><span class="line">Genre_Musical                                  <span class="hljs-number">0</span></span><br><span class="line">Genre_Mystery                                  <span class="hljs-number">0</span></span><br><span class="line">Genre_Film-Noir                                <span class="hljs-number">0</span></span><br><span class="line">Genre_Western                                  <span class="hljs-number">0</span></span><br><span class="line">Name: <span class="hljs-number">0</span>, Length: <span class="hljs-number">21</span>, dtype: object</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：对于很大的数据，用这种方式构建多成员指标变量就会变得非常慢。最好使用更低级的函数，将其写入NumPy数组，然后结果包装在DataFrame中。</p>
</blockquote>
<p>一个对统计应用有用的秘诀是：结合get_dummies和诸如cut之类的离散化函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">129</span>]: np.random.seed(<span class="hljs-number">12345</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">130</span>]: values = np.random.rand(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">131</span>]: values</span><br><span class="line">Out[<span class="hljs-number">131</span>]: </span><br><span class="line">array([ <span class="hljs-number">0.9296</span>,  <span class="hljs-number">0.3164</span>,  <span class="hljs-number">0.1839</span>,  <span class="hljs-number">0.2046</span>,  <span class="hljs-number">0.5677</span>,  <span class="hljs-number">0.5955</span>,  <span class="hljs-number">0.9645</span>,</span><br><span class="line">        <span class="hljs-number">0.6532</span>,  <span class="hljs-number">0.7489</span>,  <span class="hljs-number">0.6536</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: bins = [<span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">0.4</span>, <span class="hljs-number">0.6</span>, <span class="hljs-number">0.8</span>, <span class="hljs-number">1</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">133</span>]: pd.get_dummies(pd.cut(values, bins))</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">   (<span class="hljs-number">0.0</span>, <span class="hljs-number">0.2</span>]  (<span class="hljs-number">0.2</span>, <span class="hljs-number">0.4</span>]  (<span class="hljs-number">0.4</span>, <span class="hljs-number">0.6</span>]  (<span class="hljs-number">0.6</span>, <span class="hljs-number">0.8</span>]  (<span class="hljs-number">0.8</span>, <span class="hljs-number">1.0</span>]</span><br><span class="line"><span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">6</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">7</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">8</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">9</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>我们用numpy.random.seed，使这个例子具有确定性。本书后面会介绍pandas.get_dummies。</p>
<h1 id="7-3-字符串操作"><a href="#7-3-字符串操作" class="headerlink" title="7.3 字符串操作"></a>7.3 字符串操作</h1><p>Python能够成为流行的数据处理语言，部分原因是其简单易用的字符串和文本处理功能。大部分文本运算都直接做成了字符串对象的内置方法。对于更为复杂的模式匹配和文本操作，则可能需要用到正则表达式。pandas对此进行了加强，它使你能够对整组数据应用字符串表达式和正则表达式，而且能处理烦人的缺失数据。</p>
<h2 id="字符串对象方法"><a href="#字符串对象方法" class="headerlink" title="字符串对象方法"></a>字符串对象方法</h2><p>对于许多字符串处理和脚本应用，内置的字符串方法已经能够满足要求了。例如，以逗号分隔的字符串可以用split拆分成数段：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">134</span>]: val = <span class="hljs-string">'a,b,  guido'</span></span><br><span class="line">In [<span class="hljs-number">135</span>]: val.split(<span class="hljs-string">','</span>)</span><br><span class="line">Out[<span class="hljs-number">135</span>]: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'  guido'</span>]</span><br></pre></td></tr></table></figure>

<p>split常常与strip一起使用，以去除空白符（包括换行符）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">136</span>]: pieces = [x.strip() <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> val.split(<span class="hljs-string">','</span>)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: pieces</span><br><span class="line">Out[<span class="hljs-number">137</span>]: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'guido'</span>]</span><br></pre></td></tr></table></figure>

<p>利用加法，可以将这些子字符串以双冒号分隔符的形式连接起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">138</span>]: first, second, third = pieces</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">139</span>]: first + <span class="hljs-string">'::'</span> + second + <span class="hljs-string">'::'</span> + third</span><br><span class="line">Out[<span class="hljs-number">139</span>]: <span class="hljs-string">'a::b::guido'</span></span><br></pre></td></tr></table></figure>

<p>但这种方式并不是很实用。一种更快更符合Python风格的方式是，向字符串”::”的join方法传入一个列表或元组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">140</span>]: <span class="hljs-string">'::'</span>.join(pieces)</span><br><span class="line">Out[<span class="hljs-number">140</span>]: <span class="hljs-string">'a::b::guido'</span></span><br></pre></td></tr></table></figure>

<p>其它方法关注的是子串定位。检测子串的最佳方式是利用Python的in关键字，还可以使用index和find：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">141</span>]: <span class="hljs-string">'guido'</span> <span class="hljs-keyword">in</span> val</span><br><span class="line">Out[<span class="hljs-number">141</span>]: <span class="hljs-literal">True</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">142</span>]: val.index(<span class="hljs-string">','</span>)</span><br><span class="line">Out[<span class="hljs-number">142</span>]: <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">143</span>]: val.find(<span class="hljs-string">':'</span>)</span><br><span class="line">Out[<span class="hljs-number">143</span>]: <span class="hljs-number">-1</span></span><br></pre></td></tr></table></figure>

<p>注意find和index的区别：如果找不到字符串，index将会引发一个异常（而不是返回－1）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">144</span>]: val.index(<span class="hljs-string">':'</span>)</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">ValueError                                Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input<span class="hljs-number">-144</span><span class="hljs-number">-280</span>f8b2856ce&gt; <span class="hljs-keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 val.index(':')</span><br><span class="line">ValueError: substring <span class="hljs-keyword">not</span> found</span><br></pre></td></tr></table></figure>

<p>与此相关，count可以返回指定子串的出现次数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">145</span>]: val.count(<span class="hljs-string">','</span>)</span><br><span class="line">Out[<span class="hljs-number">145</span>]: <span class="hljs-number">2</span></span><br></pre></td></tr></table></figure>

<p>replace用于将指定模式替换为另一个模式。通过传入空字符串，它也常常用于删除模式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">146</span>]: val.replace(<span class="hljs-string">','</span>, <span class="hljs-string">'::'</span>)</span><br><span class="line">Out[<span class="hljs-number">146</span>]: <span class="hljs-string">'a::b::  guido'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">147</span>]: val.replace(<span class="hljs-string">','</span>, <span class="hljs-string">''</span>)</span><br><span class="line">Out[<span class="hljs-number">147</span>]: <span class="hljs-string">'ab  guido'</span></span><br></pre></td></tr></table></figure>

<p>表7-3列出了Python内置的字符串方法。</p>
<p>这些运算大部分都能使用正则表达式实现（马上就会看到）。</p>
<p><img src="/images/blog/7178691-087fe67bf6db0701.webp" alt="img"></p>
<p><img src="/images/blog/7178691-d1f0d4ed3e895016.webp" alt="img"></p>
<p>casefold 将字符转换为小写，并将任何特定区域的变量字符组合转换成一个通用的可比较形式。</p>
<h2 id="正则表达式"><a href="#正则表达式" class="headerlink" title="正则表达式"></a>正则表达式</h2><p>正则表达式提供了一种灵活的在文本中搜索或匹配（通常比前者复杂）字符串模式的方式。正则表达式，常称作regex，是根据正则表达式语言编写的字符串。Python内置的re模块负责对字符串应用正则表达式。我将通过一些例子说明其使用方法。</p>
<blockquote>
<p>笔记：正则表达式的编写技巧可以自成一章，超出了本书的范围。从网上和其它书可以找到许多非常不错的教程和参考资料。</p>
</blockquote>
<p>re模块的函数可以分为三个大类：模式匹配、替换以及拆分。当然，它们之间是相辅相成的。一个regex描述了需要在文本中定位的一个模式，它可以用于许多目的。我们先来看一个简单的例子：假设我想要拆分一个字符串，分隔符为数量不定的一组空白符（制表符、空格、换行符等）。描述一个或多个空白符的regex是\s+：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">148</span>]: <span class="hljs-keyword">import</span> re</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">149</span>]: text = <span class="hljs-string">"foo    bar\t baz  \tqux"</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">150</span>]: re.split(<span class="hljs-string">'\s+'</span>, text)</span><br><span class="line">Out[<span class="hljs-number">150</span>]: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'qux'</span>]</span><br></pre></td></tr></table></figure>

<p>调用re.split(‘\s+’,text)时，正则表达式会先被编译，然后再在text上调用其split方法。你可以用re.compile自己编译regex以得到一个可重用的regex对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">151</span>]: regex = re.compile(<span class="hljs-string">'\s+'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">152</span>]: regex.split(text)</span><br><span class="line">Out[<span class="hljs-number">152</span>]: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>, <span class="hljs-string">'qux'</span>]</span><br></pre></td></tr></table></figure>

<p>如果只希望得到匹配regex的所有模式，则可以使用findall方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">153</span>]: regex.findall(text)</span><br><span class="line">Out[<span class="hljs-number">153</span>]: [<span class="hljs-string">'    '</span>, <span class="hljs-string">'\t '</span>, <span class="hljs-string">'  \t'</span>]</span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：如果想避免正则表达式中不需要的转义（\），则可以使用原始字符串字面量如r’C:\x’（也可以编写其等价式’C:\x’）。</p>
</blockquote>
<p>如果打算对许多字符串应用同一条正则表达式，强烈建议通过re.compile创建regex对象。这样将可以节省大量的CPU时间。</p>
<p>match和search跟findall功能类似。findall返回的是字符串中所有的匹配项，而search则只返回第一个匹配项。match更加严格，它只匹配字符串的首部。来看一个小例子，假设我们有一段文本以及一条能够识别大部分电子邮件地址的正则表达式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">text = <span class="hljs-string">"""Dave dave@google.com</span></span><br><span class="line"><span class="hljs-string">Steve steve@gmail.com</span></span><br><span class="line"><span class="hljs-string">Rob rob@gmail.com</span></span><br><span class="line"><span class="hljs-string">Ryan ryan@yahoo.com</span></span><br><span class="line"><span class="hljs-string">"""</span></span><br><span class="line">pattern = <span class="hljs-string">r'[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]&#123;2,4&#125;'</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># re.IGNORECASE makes the regex case-insensitive</span></span><br><span class="line">regex = re.compile(pattern, flags=re.IGNORECASE)</span><br></pre></td></tr></table></figure>

<p>对text使用findall将得到一组电子邮件地址：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">155</span>]: regex.findall(text)</span><br><span class="line">Out[<span class="hljs-number">155</span>]: </span><br><span class="line">[<span class="hljs-string">'dave@google.com'</span>,</span><br><span class="line"> <span class="hljs-string">'steve@gmail.com'</span>,</span><br><span class="line"> <span class="hljs-string">'rob@gmail.com'</span>,</span><br><span class="line"> <span class="hljs-string">'ryan@yahoo.com'</span>]</span><br></pre></td></tr></table></figure>

<p>search返回的是文本中第一个电子邮件地址（以特殊的匹配项对象形式返回）。对于上面那个regex，匹配项对象只能告诉我们模式在原字符串中的起始和结束位置：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">156</span>]: m = regex.search(text)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">157</span>]: m</span><br><span class="line">Out[<span class="hljs-number">157</span>]: &lt;_sre.SRE_Match object; span=(<span class="hljs-number">5</span>, <span class="hljs-number">20</span>), match=<span class="hljs-string">'dave@google.com'</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: text[m.start():m.end()]</span><br><span class="line">Out[<span class="hljs-number">158</span>]: <span class="hljs-string">'dave@google.com'</span></span><br></pre></td></tr></table></figure>

<p>regex.match则将返回None，因为它只匹配出现在字符串开头的模式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">159</span>]: print(regex.match(text))</span><br><span class="line"><span class="hljs-literal">None</span></span><br></pre></td></tr></table></figure>

<p>相关的，sub方法可以将匹配到的模式替换为指定字符串，并返回所得到的新字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">160</span>]: print(regex.sub(<span class="hljs-string">'REDACTED'</span>, text))</span><br><span class="line">Dave REDACTED</span><br><span class="line">Steve REDACTED</span><br><span class="line">Rob REDACTED</span><br><span class="line">Ryan REDACTED</span><br></pre></td></tr></table></figure>

<p>假设你不仅想要找出电子邮件地址，还想将各个地址分成3个部分：用户名、域名以及域后缀。要实现此功能，只需将待分段的模式的各部分用圆括号包起来即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">161</span>]: pattern = <span class="hljs-string">r'([A-Z0-9._%+-]+)@([A-Z0-9.-]+)\.([A-Z]&#123;2,4&#125;)'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: regex = re.compile(pattern, flags=re.IGNORECASE)</span><br></pre></td></tr></table></figure>

<p>由这种修改过的正则表达式所产生的匹配项对象，可以通过其groups方法返回一个由模式各段组成的元组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">163</span>]: m = regex.match(<span class="hljs-string">'wesm@bright.net'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">164</span>]: m.groups()</span><br><span class="line">Out[<span class="hljs-number">164</span>]: (<span class="hljs-string">'wesm'</span>, <span class="hljs-string">'bright'</span>, <span class="hljs-string">'net'</span>)</span><br></pre></td></tr></table></figure>

<p>对于带有分组功能的模式，findall会返回一个元组列表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">165</span>]: regex.findall(text)</span><br><span class="line">Out[<span class="hljs-number">165</span>]:</span><br><span class="line">[(<span class="hljs-string">'dave'</span>, <span class="hljs-string">'google'</span>, <span class="hljs-string">'com'</span>),</span><br><span class="line"> (<span class="hljs-string">'steve'</span>, <span class="hljs-string">'gmail'</span>, <span class="hljs-string">'com'</span>),</span><br><span class="line"> (<span class="hljs-string">'rob'</span>, <span class="hljs-string">'gmail'</span>, <span class="hljs-string">'com'</span>),</span><br><span class="line"> (<span class="hljs-string">'ryan'</span>, <span class="hljs-string">'yahoo'</span>, <span class="hljs-string">'com'</span>)]</span><br></pre></td></tr></table></figure>

<p>sub还能通过诸如\1、\2之类的特殊符号访问各匹配项中的分组。符号\1对应第一个匹配的组，\2对应第二个匹配的组，以此类推：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">166</span>]: print(regex.sub(<span class="hljs-string">r'Username: \1, Domain: \2, Suffix: \3'</span>, text))</span><br><span class="line">Dave Username: dave, Domain: google, Suffix: com</span><br><span class="line">Steve Username: steve, Domain: gmail, Suffix: com</span><br><span class="line">Rob Username: rob, Domain: gmail, Suffix: com</span><br><span class="line">Ryan Username: ryan, Domain: yahoo, Suffix: com</span><br></pre></td></tr></table></figure>

<p>Python中还有许多的正则表达式，但大部分都超出了本书的范围。表7-4是一个简要概括。</p>
<p><img src="/images/blog/7178691-efbb80a793759fc0.webp" alt="img"></p>
<h2 id="pandas的矢量化字符串函数"><a href="#pandas的矢量化字符串函数" class="headerlink" title="pandas的矢量化字符串函数"></a>pandas的矢量化字符串函数</h2><p>清理待分析的散乱数据时，常常需要做一些字符串规整化工作。更为复杂的情况是，含有字符串的列有时还含有缺失数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">167</span>]: data = &#123;<span class="hljs-string">'Dave'</span>: <span class="hljs-string">'dave@google.com'</span>, <span class="hljs-string">'Steve'</span>: <span class="hljs-string">'steve@gmail.com'</span>,</span><br><span class="line">   .....:         <span class="hljs-string">'Rob'</span>: <span class="hljs-string">'rob@gmail.com'</span>, <span class="hljs-string">'Wes'</span>: np.nan&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">168</span>]: data = pd.Series(data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">169</span>]: data</span><br><span class="line">Out[<span class="hljs-number">169</span>]: </span><br><span class="line">Dave     dave@google.com</span><br><span class="line">Rob        rob@gmail.com</span><br><span class="line">Steve    steve@gmail.com</span><br><span class="line">Wes                  NaN</span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">170</span>]: data.isnull()</span><br><span class="line">Out[<span class="hljs-number">170</span>]: </span><br><span class="line">Dave     <span class="hljs-literal">False</span></span><br><span class="line">Rob      <span class="hljs-literal">False</span></span><br><span class="line">Steve    <span class="hljs-literal">False</span></span><br><span class="line">Wes       <span class="hljs-literal">True</span></span><br><span class="line">dtype: bool</span><br></pre></td></tr></table></figure>

<p>通过data.map，所有字符串和正则表达式方法都能被应用于（传入lambda表达式或其他函数）各个值，但是如果存在NA（null）就会报错。为了解决这个问题，Series有一些能够跳过NA值的面向数组方法，进行字符串操作。通过Series的str属性即可访问这些方法。例如，我们可以通过str.contains检查各个电子邮件地址是否含有”gmail”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">171</span>]: data.str.contains(<span class="hljs-string">'gmail'</span>)</span><br><span class="line">Out[<span class="hljs-number">171</span>]: </span><br><span class="line">Dave     <span class="hljs-literal">False</span></span><br><span class="line">Rob       <span class="hljs-literal">True</span></span><br><span class="line">Steve     <span class="hljs-literal">True</span></span><br><span class="line">Wes        NaN</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>也可以使用正则表达式，还可以加上任意re选项（如IGNORECASE）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">172</span>]: pattern</span><br><span class="line">Out[<span class="hljs-number">172</span>]: <span class="hljs-string">'([A-Z0-9._%+-]+)@([A-Z0-9.-]+)\\.([A-Z]&#123;2,4&#125;)'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">173</span>]: data.str.findall(pattern, flags=re.IGNORECASE)</span><br><span class="line">Out[<span class="hljs-number">173</span>]: </span><br><span class="line">Dave     [(dave, google, com)]</span><br><span class="line">Rob        [(rob, gmail, com)]</span><br><span class="line">Steve    [(steve, gmail, com)]</span><br><span class="line">Wes                        NaN</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>有两个办法可以实现矢量化的元素获取操作：要么使用str.get，要么在str属性上使用索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">174</span>]: matches = data.str.match(pattern, flags=re.IGNORECASE)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">175</span>]: matches</span><br><span class="line">Out[<span class="hljs-number">175</span>]: </span><br><span class="line">Dave     <span class="hljs-literal">True</span></span><br><span class="line">Rob      <span class="hljs-literal">True</span></span><br><span class="line">Steve    <span class="hljs-literal">True</span></span><br><span class="line">Wes       NaN</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>要访问嵌入列表中的元素，我们可以传递索引到这两个函数中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">176</span>]: matches.str.get(<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">176</span>]: </span><br><span class="line">Dave    NaN</span><br><span class="line">Rob     NaN</span><br><span class="line">Steve   NaN</span><br><span class="line">Wes     NaN</span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">177</span>]: matches.str[<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">177</span>]: </span><br><span class="line">Dave    NaN</span><br><span class="line">Rob     NaN</span><br><span class="line">Steve   NaN</span><br><span class="line">Wes     NaN</span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>你可以利用这种方法对字符串进行截取：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">178</span>]: data.str[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">178</span>]: </span><br><span class="line">Dave     dave@</span><br><span class="line">Rob      rob@g</span><br><span class="line">Steve    steve</span><br><span class="line">Wes        NaN</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>表7-5介绍了更多的pandas字符串方法。</p>
<p><img src="/images/blog/7178691-a634364ed6d5d5c5.webp" alt="img"></p>
<p>表7-5 部分矢量化字符串方法</p>
<h1 id="7-4-总结"><a href="#7-4-总结" class="headerlink" title="7.4 总结"></a>7.4 总结</h1><p>高效的数据准备可以让你将更多的时间用于数据分析，花较少的时间用于准备工作，这样就可以极大地提高生产力。我们在本章中学习了许多工具，但覆盖并不全面。下一章，我们会学习pandas的聚合与分组。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 7946 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC9%E7%AB%A0%20%E7%BB%98%E5%9B%BE%E5%92%8C%E5%8F%AF%E8%A7%86%E5%8C%96/">《利用Python进行数据分析·第2版》第9章 绘图和可视化</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
第9章 绘图和可视化
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>信息可视化（也叫绘图）是数据分析中最重要的工作之一。它可能是探索过程的一部分，例如，帮助我们找出异常值、必要的数据转换、得出有关模型的idea等。另外，做一个可交互的数据可视化也许是工作的最终目标。Python有许多库进行静态或动态的数据可视化，但我这里重要关注于matplotlib（<a href="http://matplotlib.org/）和基于它的库。" target="_blank" rel="noopener">http://matplotlib.org/）和基于它的库。</a></p>
<p>matplotlib是一个用于创建出版质量图表的桌面绘图包（主要是2D方面）。该项目是由John Hunter于2002年启动的，其目的是为Python构建一个MATLAB式的绘图接口。matplotlib和IPython社区进行合作，简化了从IPython shell（包括现在的Jupyter notebook）进行交互式绘图。matplotlib支持各种操作系统上许多不同的GUI后端，而且还能将图片导出为各种常见的矢量（vector）和光栅（raster）图：PDF、SVG、JPG、PNG、BMP、GIF等。除了几张，本书中的大部分图都是用它生成的。</p>
<p>随着时间的发展，matplotlib衍生出了多个数据可视化的工具集，它们使用matplotlib作为底层。其中之一是seaborn（<a href="http://seaborn.pydata.org/），本章后面会学习它。" target="_blank" rel="noopener">http://seaborn.pydata.org/），本章后面会学习它。</a></p>
<p>学习本章代码案例的最简单方法是在Jupyter notebook进行交互式绘图。在Jupyter notebook中执行下面的语句：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%matplotlib notebook</span><br></pre></td></tr></table></figure>

<h1 id="9-1-matplotlib-API入门"><a href="#9-1-matplotlib-API入门" class="headerlink" title="9.1 matplotlib API入门"></a>9.1 matplotlib API入门</h1><p>matplotlib的通常引入约定是：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">11</span>]: <span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt</span><br></pre></td></tr></table></figure>

<p>在Jupyter中运行%matplotlib notebook（或在IPython中运行%matplotlib），就可以创建一个简单的图形。如果一切设置正确，会看到图9-1：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: data = np.arange(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: data</span><br><span class="line">Out[<span class="hljs-number">14</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: plt.plot(data)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-7032e333a6ecdd37.webp" alt="img"></p>
<p>图9-1 简单的线图</p>
<p>虽然seaborn这样的库和pandas的内置绘图函数能够处理许多普通的绘图任务，但如果需要自定义一些高级功能的话就必须学习matplotlib API。</p>
<blockquote>
<p>笔记：虽然本书没有详细地讨论matplotlib的各种功能，但足以将你引入门。matplotlib的示例库和文档是学习高级特性的最好资源。</p>
</blockquote>
<h2 id="Figure和Subplot"><a href="#Figure和Subplot" class="headerlink" title="Figure和Subplot"></a>Figure和Subplot</h2><p>matplotlib的图像都位于Figure对象中。你可以用plt.figure创建一个新的Figure：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">16</span>]: fig = plt.figure()</span><br></pre></td></tr></table></figure>

<p>如果用的是IPython，这时会弹出一个空窗口，但在Jupyter中，必须再输入更多命令才能看到。plt.figure有一些选项，特别是figsize，它用于确保当图片保存到磁盘时具有一定的大小和纵横比。</p>
<p>不能通过空Figure绘图。必须用add_subplot创建一个或多个subplot才行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: ax1 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>这条代码的意思是：图像应该是2×2的（即最多4张图），且当前选中的是4个subplot中的第一个（编号从1开始）。如果再把后面两个subplot也创建出来，最终得到的图像如图9-2所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: ax2 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: ax3 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-b8cff158e64eae74.webp" alt="img"></p>
<p>图9-2 带有三个subplot的Figure</p>
<blockquote>
<p>提示：使用Jupyter notebook有一点不同，即每个小窗重新执行后，图形会被重置。因此，对于复杂的图形，，你必须将所有的绘图命令存在一个小窗里。</p>
</blockquote>
<p>这里，我们运行同一个小窗里的所有命令：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax1 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>)</span><br><span class="line">ax2 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>)</span><br><span class="line">ax3 = fig.add_subplot(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>)</span><br></pre></td></tr></table></figure>

<p>如果这时执行一条绘图命令（如plt.plot([1.5, 3.5, -2, 1.6])），matplotlib就会在最后一个用过的subplot（如果没有则创建一个）上进行绘制，隐藏创建figure和subplot的过程。因此，如果我们执行下列命令，你就会得到如图9-3所示的结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">20</span>]: plt.plot(np.random.randn(<span class="hljs-number">50</span>).cumsum(), <span class="hljs-string">'k--'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-7bcbd5e56fdbbd92.webp" alt="img"></p>
<p>图9-3 绘制一次之后的图像</p>
<p>“k–”是一个线型选项，用于告诉matplotlib绘制黑色虚线图。上面那些由fig.add_subplot所返回的对象是AxesSubplot对象，直接调用它们的实例方法就可以在其它空着的格子里面画图了，如图9-4所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">21</span>]: ax1.hist(np.random.randn(<span class="hljs-number">100</span>), bins=<span class="hljs-number">20</span>, color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: ax2.scatter(np.arange(<span class="hljs-number">30</span>), np.arange(<span class="hljs-number">30</span>) + <span class="hljs-number">3</span> * np.random.randn(<span class="hljs-number">30</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-2297bcaf355db24c.webp" alt="img"></p>
<p>图9-4 继续绘制两次之后的图像</p>
<p>你可以在matplotlib的文档中找到各种图表类型。</p>
<p>创建包含subplot网格的figure是一个非常常见的任务，matplotlib有一个更为方便的方法plt.subplots，它可以创建一个新的Figure，并返回一个含有已创建的subplot对象的NumPy数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: axes</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">array([[&lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb626374048</span>&gt;,</span><br><span class="line">        &lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb62625db00</span>&gt;,</span><br><span class="line">        &lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb6262f6c88</span>&gt;],</span><br><span class="line">       [&lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb6261a36a0</span>&gt;,</span><br><span class="line">        &lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb626181860</span>&gt;,</span><br><span class="line">        &lt;matplotlib.axes._subplots.AxesSubplot object at <span class="hljs-number">0x7fb6260fd4e0</span>&gt;]], dtype</span><br><span class="line">=object)</span><br></pre></td></tr></table></figure>

<p>这是非常实用的，因为可以轻松地对axes数组进行索引，就好像是一个二维数组一样，例如axes[0,1]。你还可以通过sharex和sharey指定subplot应该具有相同的X轴或Y轴。在比较相同范围的数据时，这也是非常实用的，否则，matplotlib会自动缩放各图表的界限。有关该方法的更多信息，请参见表9-1。</p>
<p><img src="/images/blog/7178691-88bb55faca7d01ba.webp" alt="img"></p>
<p>表9-1 pyplot.subplots的选项</p>
<h2 id="调整subplot周围的间距"><a href="#调整subplot周围的间距" class="headerlink" title="调整subplot周围的间距"></a>调整subplot周围的间距</h2><p>默认情况下，matplotlib会在subplot外围留下一定的边距，并在subplot之间留下一定的间距。间距跟图像的高度和宽度有关，因此，如果你调整了图像大小（不管是编程还是手工），间距也会自动调整。利用Figure的subplots_adjust方法可以轻而易举地修改间距，此外，它也是个顶级函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">subplots_adjust(left=<span class="hljs-literal">None</span>, bottom=<span class="hljs-literal">None</span>, right=<span class="hljs-literal">None</span>, top=<span class="hljs-literal">None</span>,</span><br><span class="line">                wspace=<span class="hljs-literal">None</span>, hspace=<span class="hljs-literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>wspace和hspace用于控制宽度和高度的百分比，可以用作subplot之间的间距。下面是一个简单的例子，其中我将间距收缩到了0（如图9-5所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>, sharex=<span class="hljs-literal">True</span>, sharey=<span class="hljs-literal">True</span>)</span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):</span><br><span class="line">    <span class="hljs-keyword">for</span> j <span class="hljs-keyword">in</span> range(<span class="hljs-number">2</span>):</span><br><span class="line">        axes[i, j].hist(np.random.randn(<span class="hljs-number">500</span>), bins=<span class="hljs-number">50</span>, color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.5</span>)</span><br><span class="line">plt.subplots_adjust(wspace=<span class="hljs-number">0</span>, hspace=<span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-80be7ffc3dec88a5.webp" alt="img"></p>
<p>图9-5 各subplot之间没有间距</p>
<p>不难看出，其中的轴标签重叠了。matplotlib不会检查标签是否重叠，所以对于这种情况，你只能自己设定刻度位置和刻度标签。后面几节将会详细介绍该内容。</p>
<h2 id="颜色、标记和线型"><a href="#颜色、标记和线型" class="headerlink" title="颜色、标记和线型"></a>颜色、标记和线型</h2><p>matplotlib的plot函数接受一组X和Y坐标，还可以接受一个表示颜色和线型的字符串缩写。例如，要根据x和y绘制绿色虚线，你可以执行如下代码：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ax.plot(x, y, <span class="hljs-string">'g--'</span>)</span><br></pre></td></tr></table></figure>

<p>这种在一个字符串中指定颜色和线型的方式非常方便。在实际中，如果你是用代码绘图，你可能不想通过处理字符串来获得想要的格式。通过下面这种更为明确的方式也能得到同样的效果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ax.plot(x, y, linestyle=<span class="hljs-string">'--'</span>, color=<span class="hljs-string">'g'</span>)</span><br></pre></td></tr></table></figure>

<p>常用的颜色可以使用颜色缩写，你也可以指定颜色码（例如，’#CECECE’）。你可以通过查看plot的文档字符串查看所有线型的合集（在IPython和Jupyter中使用plot?）。</p>
<p>线图可以使用标记强调数据点。因为matplotlib可以创建连续线图，在点之间进行插值，因此有时可能不太容易看出真实数据点的位置。标记也可以放到格式字符串中，但标记类型和线型必须放在颜色后面（见图9-6）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">30</span>]: <span class="hljs-keyword">from</span> numpy.random <span class="hljs-keyword">import</span> randn</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: plt.plot(randn(<span class="hljs-number">30</span>).cumsum(), <span class="hljs-string">'ko--'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-404d816f3e1d6621.webp" alt="img"></p>
<p>图9-6 带有标记的线型图示例</p>
<p>还可以将其写成更为明确的形式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plot(randn(<span class="hljs-number">30</span>).cumsum(), color=<span class="hljs-string">'k'</span>, linestyle=<span class="hljs-string">'dashed'</span>, marker=<span class="hljs-string">'o'</span>)</span><br></pre></td></tr></table></figure>

<p>在线型图中，非实际数据点默认是按线性方式插值的。可以通过drawstyle选项修改（见图9-7）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: data = np.random.randn(<span class="hljs-number">30</span>).cumsum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: plt.plot(data, <span class="hljs-string">'k--'</span>, label=<span class="hljs-string">'Default'</span>)</span><br><span class="line">Out[<span class="hljs-number">34</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624d86160</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">35</span>]: plt.plot(data, <span class="hljs-string">'k-'</span>, drawstyle=<span class="hljs-string">'steps-post'</span>, label=<span class="hljs-string">'steps-post'</span>)</span><br><span class="line">Out[<span class="hljs-number">35</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624d869e8</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: plt.legend(loc=<span class="hljs-string">'best'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-3ec7642e1a592f08.webp" alt="img"></p>
<p>图9-7 不同drawstyle选项的线型图</p>
<p>你可能注意到运行上面代码时有输出&lt;matplotlib.lines.Line2D at …&gt;。matplotlib会返回引用了新添加的子组件的对象。大多数时候，你可以放心地忽略这些输出。这里，因为我们传递了label参数到plot，我们可以创建一个plot图例，指明每条使用plt.legend的线。</p>
<blockquote>
<p>笔记：你必须调用plt.legend（或使用ax.legend，如果引用了轴的话）来创建图例，无论你绘图时是否传递label标签选项。</p>
</blockquote>
<h2 id="刻度、标签和图例"><a href="#刻度、标签和图例" class="headerlink" title="刻度、标签和图例"></a>刻度、标签和图例</h2><p>对于大多数的图表装饰项，其主要实现方式有二：使用过程型的pyplot接口（例如，matplotlib.pyplot）以及更为面向对象的原生matplotlib API。</p>
<p>pyplot接口的设计目的就是交互式使用，含有诸如xlim、xticks和xticklabels之类的方法。它们分别控制图表的范围、刻度位置、刻度标签等。其使用方式有以下两种：</p>
<ul>
<li>调用时不带参数，则返回当前的参数值（例如，plt.xlim()返回当前的X轴绘图范围）。</li>
<li>调用时带参数，则设置参数值（例如，plt.xlim([0,10])会将X轴的范围设置为0到10）。</li>
</ul>
<p>所有这些方法都是对当前或最近创建的AxesSubplot起作用的。它们各自对应subplot对象上的两个方法，以xlim为例，就是ax.get_xlim和ax.set_xlim。我更喜欢使用subplot的实例方法（因为我喜欢明确的事情，而且在处理多个subplot时这样也更清楚一些）。当然你完全可以选择自己觉得方便的那个。</p>
<h2 id="设置标题、轴标签、刻度以及刻度标签"><a href="#设置标题、轴标签、刻度以及刻度标签" class="headerlink" title="设置标题、轴标签、刻度以及刻度标签"></a>设置标题、轴标签、刻度以及刻度标签</h2><p>为了说明自定义轴，我将创建一个简单的图像并绘制一段随机漫步（如图9-8所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">37</span>]: fig = plt.figure()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: ax = fig.add_subplot(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">39</span>]: ax.plot(np.random.randn(<span class="hljs-number">1000</span>).cumsum())</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-caf9300dacb61fa4.webp" alt="img"></p>
<p>图9-8 用于演示xticks的简单线型图（带有标签）</p>
<p>要改变x轴刻度，最简单的办法是使用set_xticks和set_xticklabels。前者告诉matplotlib要将刻度放在数据范围中的哪些位置，默认情况下，这些位置也就是刻度标签。但我们可以通过set_xticklabels将任何其他的值用作标签：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">40</span>]: ticks = ax.set_xticks([<span class="hljs-number">0</span>, <span class="hljs-number">250</span>, <span class="hljs-number">500</span>, <span class="hljs-number">750</span>, <span class="hljs-number">1000</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: labels = ax.set_xticklabels([<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>, <span class="hljs-string">'five'</span>],</span><br><span class="line">   ....:                             rotation=<span class="hljs-number">30</span>, fontsize=<span class="hljs-string">'small'</span>)</span><br></pre></td></tr></table></figure>

<p>rotation选项设定x刻度标签倾斜30度。最后，再用set_xlabel为X轴设置一个名称，并用set_title设置一个标题（见图9-9的结果）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">42</span>]: ax.set_title(<span class="hljs-string">'My first matplotlib plot'</span>)</span><br><span class="line">Out[<span class="hljs-number">42</span>]: &lt;matplotlib.text.Text at <span class="hljs-number">0x7fb624d055f8</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: ax.set_xlabel(<span class="hljs-string">'Stages'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-741f968323bd818f.webp" alt="img"></p>
<p>图9-9 用于演示xticks的简单线型图</p>
<p>Y轴的修改方式与此类似，只需将上述代码中的x替换为y即可。轴的类有集合方法，可以批量设定绘图选项。前面的例子，也可以写为：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">props = &#123;</span><br><span class="line">    <span class="hljs-string">'title'</span>: <span class="hljs-string">'My first matplotlib plot'</span>,</span><br><span class="line">    <span class="hljs-string">'xlabel'</span>: <span class="hljs-string">'Stages'</span></span><br><span class="line">&#125;</span><br><span class="line">ax.set(**props)</span><br></pre></td></tr></table></figure>

<h2 id="添加图例"><a href="#添加图例" class="headerlink" title="添加图例"></a>添加图例</h2><p>图例（legend）是另一种用于标识图表元素的重要工具。添加图例的方式有多种。最简单的是在添加subplot的时候传入label参数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: <span class="hljs-keyword">from</span> numpy.random <span class="hljs-keyword">import</span> randn</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">45</span>]: fig = plt.figure(); ax = fig.add_subplot(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: ax.plot(randn(<span class="hljs-number">1000</span>).cumsum(), <span class="hljs-string">'k'</span>, label=<span class="hljs-string">'one'</span>)</span><br><span class="line">Out[<span class="hljs-number">46</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624bdf860</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: ax.plot(randn(<span class="hljs-number">1000</span>).cumsum(), <span class="hljs-string">'k--'</span>, label=<span class="hljs-string">'two'</span>)</span><br><span class="line">Out[<span class="hljs-number">47</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624be90f0</span>&gt;]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: ax.plot(randn(<span class="hljs-number">1000</span>).cumsum(), <span class="hljs-string">'k.'</span>, label=<span class="hljs-string">'three'</span>)</span><br><span class="line">Out[<span class="hljs-number">48</span>]: [&lt;matplotlib.lines.Line2D at <span class="hljs-number">0x7fb624be9160</span>&gt;]</span><br></pre></td></tr></table></figure>

<p>在此之后，你可以调用ax.legend()或plt.legend()来自动创建图例（结果见图9-10）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: ax.legend(loc=<span class="hljs-string">'best'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-651ff89750c0a89b.webp" alt="img"></p>
<p>图9-10 带有三条线以及图例的简单线型图</p>
<p>legend方法有几个其它的loc位置参数选项。请查看文档字符串（使用ax.legend?）。</p>
<p>loc告诉matplotlib要将图例放在哪。如果你不是吹毛求疵的话，”best”是不错的选择，因为它会选择最不碍事的位置。要从图例中去除一个或多个元素，不传入label或传入label=’<em>nolegend</em>‘即可。（中文第一版这里把best错写成了beat）</p>
<h2 id="注解以及在Subplot上绘图"><a href="#注解以及在Subplot上绘图" class="headerlink" title="注解以及在Subplot上绘图"></a>注解以及在Subplot上绘图</h2><p>除标准的绘图类型，你可能还希望绘制一些子集的注解，可能是文本、箭头或其他图形等。注解和文字可以通过text、arrow和annotate函数进行添加。text可以将文本绘制在图表的指定坐标(x,y)，还可以加上一些自定义格式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ax.text(x, y, <span class="hljs-string">'Hello world!'</span>,</span><br><span class="line">        family=<span class="hljs-string">'monospace'</span>, fontsize=<span class="hljs-number">10</span>)</span><br></pre></td></tr></table></figure>

<p>注解中可以既含有文本也含有箭头。例如，我们根据最近的标准普尔500指数价格（来自Yahoo!Finance）绘制一张曲线图，并标出2008年到2009年金融危机期间的一些重要日期。你可以在Jupyter notebook的一个小窗中试验这段代码（图9-11是结果）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">data = pd.read_csv(<span class="hljs-string">'examples/spx.csv'</span>, index_col=<span class="hljs-number">0</span>, parse_dates=<span class="hljs-literal">True</span>)</span><br><span class="line">spx = data[<span class="hljs-string">'SPX'</span>]</span><br><span class="line"></span><br><span class="line">spx.plot(ax=ax, style=<span class="hljs-string">'k-'</span>)</span><br><span class="line"></span><br><span class="line">crisis_data = [</span><br><span class="line">    (datetime(<span class="hljs-number">2007</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>), <span class="hljs-string">'Peak of bull market'</span>),</span><br><span class="line">    (datetime(<span class="hljs-number">2008</span>, <span class="hljs-number">3</span>, <span class="hljs-number">12</span>), <span class="hljs-string">'Bear Stearns Fails'</span>),</span><br><span class="line">    (datetime(<span class="hljs-number">2008</span>, <span class="hljs-number">9</span>, <span class="hljs-number">15</span>), <span class="hljs-string">'Lehman Bankruptcy'</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> date, label <span class="hljs-keyword">in</span> crisis_data:</span><br><span class="line">    ax.annotate(label, xy=(date, spx.asof(date) + <span class="hljs-number">75</span>),</span><br><span class="line">                xytext=(date, spx.asof(date) + <span class="hljs-number">225</span>),</span><br><span class="line">                arrowprops=dict(facecolor=<span class="hljs-string">'black'</span>, headwidth=<span class="hljs-number">4</span>, width=<span class="hljs-number">2</span>,</span><br><span class="line">                                headlength=<span class="hljs-number">4</span>),</span><br><span class="line">                horizontalalignment=<span class="hljs-string">'left'</span>, verticalalignment=<span class="hljs-string">'top'</span>)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Zoom in on 2007-2010</span></span><br><span class="line">ax.set_xlim([<span class="hljs-string">'1/1/2007'</span>, <span class="hljs-string">'1/1/2011'</span>])</span><br><span class="line">ax.set_ylim([<span class="hljs-number">600</span>, <span class="hljs-number">1800</span>])</span><br><span class="line"></span><br><span class="line">ax.set_title(<span class="hljs-string">'Important dates in the 2008-2009 financial crisis'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-3127eaa51f5e4c2c.webp" alt="img"></p>
<p>图9-11 2008-2009年金融危机期间的重要日期</p>
<p>这张图中有几个重要的点要强调：ax.annotate方法可以在指定的x和y坐标轴绘制标签。我们使用set_xlim和set_ylim人工设定起始和结束边界，而不使用matplotlib的默认方法。最后，用ax.set_title添加图标标题。</p>
<p>更多有关注解的示例，请访问matplotlib的在线示例库。</p>
<p>图形的绘制要麻烦一些。matplotlib有一些表示常见图形的对象。这些对象被称为块（patch）。其中有些（如Rectangle和Circle），可以在matplotlib.pyplot中找到，但完整集合位于matplotlib.patches。</p>
<p>要在图表中添加一个图形，你需要创建一个块对象shp，然后通过ax.add_patch(shp)将其添加到subplot中（如图9-12所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">fig = plt.figure()</span><br><span class="line">ax = fig.add_subplot(<span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">rect = plt.Rectangle((<span class="hljs-number">0.2</span>, <span class="hljs-number">0.75</span>), <span class="hljs-number">0.4</span>, <span class="hljs-number">0.15</span>, color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.3</span>)</span><br><span class="line">circ = plt.Circle((<span class="hljs-number">0.7</span>, <span class="hljs-number">0.2</span>), <span class="hljs-number">0.15</span>, color=<span class="hljs-string">'b'</span>, alpha=<span class="hljs-number">0.3</span>)</span><br><span class="line">pgon = plt.Polygon([[<span class="hljs-number">0.15</span>, <span class="hljs-number">0.15</span>], [<span class="hljs-number">0.35</span>, <span class="hljs-number">0.4</span>], [<span class="hljs-number">0.2</span>, <span class="hljs-number">0.6</span>]],</span><br><span class="line">                   color=<span class="hljs-string">'g'</span>, alpha=<span class="hljs-number">0.5</span>)</span><br><span class="line"></span><br><span class="line">ax.add_patch(rect)</span><br><span class="line">ax.add_patch(circ)</span><br><span class="line">ax.add_patch(pgon)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-1f8a3d7a3a02d7d8.webp" alt="img"></p>
<p>图9-12 由三个块图形组成的图</p>
<p>如果查看许多常见图表对象的具体实现代码，你就会发现它们其实就是由块patch组装而成的。</p>
<h2 id="将图表保存到文件"><a href="#将图表保存到文件" class="headerlink" title="将图表保存到文件"></a>将图表保存到文件</h2><p>利用plt.savefig可以将当前图表保存到文件。该方法相当于Figure对象的实例方法savefig。例如，要将图表保存为SVG文件，你只需输入：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.savefig(<span class="hljs-string">'figpath.svg'</span>)</span><br></pre></td></tr></table></figure>

<p>文件类型是通过文件扩展名推断出来的。因此，如果你使用的是.pdf，就会得到一个PDF文件。我在发布图片时最常用到两个重要的选项是dpi（控制“每英寸点数”分辨率）和bbox_inches（可以剪除当前图表周围的空白部分）。要得到一张带有最小白边且分辨率为400DPI的PNG图片，你可以：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.savefig(<span class="hljs-string">'figpath.png'</span>, dpi=<span class="hljs-number">400</span>, bbox_inches=<span class="hljs-string">'tight'</span>)</span><br></pre></td></tr></table></figure>

<p>savefig并非一定要写入磁盘，也可以写入任何文件型的对象，比如BytesIO：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> io <span class="hljs-keyword">import</span> BytesIO</span><br><span class="line">buffer = BytesIO()</span><br><span class="line">plt.savefig(buffer)</span><br><span class="line">plot_data = buffer.getvalue()</span><br></pre></td></tr></table></figure>

<p>表9-2列出了savefig的其它选项。</p>
<p><img src="/images/blog/7178691-4bee796bf7262423.webp" alt="img"></p>
<p>表9-2 Figure.savefig的选项</p>
<h2 id="matplotlib配置"><a href="#matplotlib配置" class="headerlink" title="matplotlib配置"></a>matplotlib配置</h2><p>matplotlib自带一些配色方案，以及为生成出版质量的图片而设定的默认配置信息。幸运的是，几乎所有默认行为都能通过一组全局参数进行自定义，它们可以管理图像大小、subplot边距、配色方案、字体大小、网格类型等。一种Python编程方式配置系统的方法是使用rc方法。例如，要将全局的图像默认大小设置为10×10，你可以执行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">plt.rc(<span class="hljs-string">'figure'</span>, figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">10</span>))</span><br></pre></td></tr></table></figure>

<p>rc的第一个参数是希望自定义的对象，如’figure’、’axes’、’xtick’、’ytick’、’grid’、’legend’等。其后可以跟上一系列的关键字参数。一个简单的办法是将这些选项写成一个字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">font_options = &#123;<span class="hljs-string">'family'</span> : <span class="hljs-string">'monospace'</span>,</span><br><span class="line">                <span class="hljs-string">'weight'</span> : <span class="hljs-string">'bold'</span>,</span><br><span class="line">                <span class="hljs-string">'size'</span>   : <span class="hljs-string">'small'</span>&#125;</span><br><span class="line">plt.rc(<span class="hljs-string">'font'</span>, **font_options)</span><br></pre></td></tr></table></figure>

<p>要了解全部的自定义选项，请查阅matplotlib的配置文件matplotlibrc（位于matplotlib/mpl-data目录中）。如果对该文件进行了自定义，并将其放在你自己的.matplotlibrc目录中，则每次使用matplotlib时就会加载该文件。</p>
<p>下一节，我们会看到，seaborn包有若干内置的绘图主题或类型，它们使用了matplotlib的内部配置。</p>
<h1 id="9-2-使用pandas和seaborn绘图"><a href="#9-2-使用pandas和seaborn绘图" class="headerlink" title="9.2 使用pandas和seaborn绘图"></a>9.2 使用pandas和seaborn绘图</h1><p>matplotlib实际上是一种比较低级的工具。要绘制一张图表，你组装一些基本组件就行：数据展示（即图表类型：线型图、柱状图、盒形图、散布图、等值线图等）、图例、标题、刻度标签以及其他注解型信息。</p>
<p>在pandas中，我们有多列数据，还有行和列标签。pandas自身就有内置的方法，用于简化从DataFrame和Series绘制图形。另一个库seaborn（<a href="https://seaborn.pydata.org/），由Michael" target="_blank" rel="noopener">https://seaborn.pydata.org/），由Michael</a> Waskom创建的静态图形库。Seaborn简化了许多常见可视类型的创建。</p>
<blockquote>
<p>提示：引入seaborn会修改matplotlib默认的颜色方案和绘图类型，以提高可读性和美观度。即使你不使用seaborn API，你可能也会引入seaborn，作为提高美观度和绘制常见matplotlib图形的简化方法。</p>
</blockquote>
<h2 id="线型图"><a href="#线型图" class="headerlink" title="线型图"></a>线型图</h2><p>Series和DataFrame都有一个用于生成各类图表的plot方法。默认情况下，它们所生成的是线型图（如图9-13所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: s = pd.Series(np.random.randn(<span class="hljs-number">10</span>).cumsum(), index=np.arange(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">10</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: s.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-f28e5ab2ac94c7a2.webp" alt="img"></p>
<p>图9-13 简单的Series图表示例</p>
<p>该Series对象的索引会被传给matplotlib，并用以绘制X轴。可以通过use_index=False禁用该功能。X轴的刻度和界限可以通过xticks和xlim选项进行调节，Y轴就用yticks和ylim。plot参数的完整列表请参见表9-3。我只会讲解其中几个，剩下的就留给读者自己去研究了。</p>
<p><img src="/images/blog/7178691-6d9fbf863c09370a.webp" alt="img"></p>
<p><img src="/images/blog/7178691-44e50562aeb5eb49.webp" alt="img"></p>
<p>表9-3 Series.plot方法的参数</p>
<p>pandas的大部分绘图方法都有一个可选的ax参数，它可以是一个matplotlib的subplot对象。这使你能够在网格布局中更为灵活地处理subplot的位置。</p>
<p>DataFrame的plot方法会在一个subplot中为各列绘制一条线，并自动创建图例（如图9-14所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: df = pd.DataFrame(np.random.randn(<span class="hljs-number">10</span>, <span class="hljs-number">4</span>).cumsum(<span class="hljs-number">0</span>),</span><br><span class="line">   ....:                   columns=[<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>],</span><br><span class="line">   ....:                   index=np.arange(<span class="hljs-number">0</span>, <span class="hljs-number">100</span>, <span class="hljs-number">10</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: df.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-a1234d5e5ee41a40.webp" alt="img"></p>
<p>图9-14 简单的DataFrame绘图</p>
<p>plot属性包含一批不同绘图类型的方法。例如，df.plot()等价于df.plot.line()。后面会学习这些方法。</p>
<blockquote>
<p>笔记：plot的其他关键字参数会被传给相应的matplotlib绘图函数，所以要更深入地自定义图表，就必须学习更多有关matplotlib API的知识。</p>
</blockquote>
<p>DataFrame还有一些用于对列进行灵活处理的选项，例如，是要将所有列都绘制到一个subplot中还是创建各自的subplot。详细信息请参见表9-4。</p>
<p><img src="/images/blog/7178691-96651ecaa90f1c68.webp" alt="img"></p>
<p>表9-4 专用于DataFrame的plot参数</p>
<blockquote>
<p>注意： 有关时间序列的绘图，请见第11章。</p>
</blockquote>
<h2 id="柱状图"><a href="#柱状图" class="headerlink" title="柱状图"></a>柱状图</h2><p>plot.bar()和plot.barh()分别绘制水平和垂直的柱状图。这时，Series和DataFrame的索引将会被用作X（bar）或Y（barh）刻度（如图9-15所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">64</span>]: fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">65</span>]: data = pd.Series(np.random.rand(<span class="hljs-number">16</span>), index=list(<span class="hljs-string">'abcdefghijklmnop'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">66</span>]: data.plot.bar(ax=axes[<span class="hljs-number">0</span>], color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.7</span>)</span><br><span class="line">Out[<span class="hljs-number">66</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7fb62493d470</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: data.plot.barh(ax=axes[<span class="hljs-number">1</span>], color=<span class="hljs-string">'k'</span>, alpha=<span class="hljs-number">0.7</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-cd54c7ccfa3f0687.webp" alt="img"></p>
<p>图9-15 水平和垂直的柱状图</p>
<p>color=’k’和alpha=0.7设定了图形的颜色为黑色，并使用部分的填充透明度。对于DataFrame，柱状图会将每一行的值分为一组，并排显示，如图9-16所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: df = pd.DataFrame(np.random.rand(<span class="hljs-number">6</span>, <span class="hljs-number">4</span>),</span><br><span class="line">   ....:                   index=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>, <span class="hljs-string">'five'</span>, <span class="hljs-string">'six'</span>],</span><br><span class="line">   ....:                   columns=pd.Index([<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>, <span class="hljs-string">'D'</span>], name=<span class="hljs-string">'Genus'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: df</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">Genus         A         B         C         D</span><br><span class="line">one    <span class="hljs-number">0.370670</span>  <span class="hljs-number">0.602792</span>  <span class="hljs-number">0.229159</span>  <span class="hljs-number">0.486744</span></span><br><span class="line">two    <span class="hljs-number">0.420082</span>  <span class="hljs-number">0.571653</span>  <span class="hljs-number">0.049024</span>  <span class="hljs-number">0.880592</span></span><br><span class="line">three  <span class="hljs-number">0.814568</span>  <span class="hljs-number">0.277160</span>  <span class="hljs-number">0.880316</span>  <span class="hljs-number">0.431326</span></span><br><span class="line">four   <span class="hljs-number">0.374020</span>  <span class="hljs-number">0.899420</span>  <span class="hljs-number">0.460304</span>  <span class="hljs-number">0.100843</span></span><br><span class="line">five   <span class="hljs-number">0.433270</span>  <span class="hljs-number">0.125107</span>  <span class="hljs-number">0.494675</span>  <span class="hljs-number">0.961825</span></span><br><span class="line">six    <span class="hljs-number">0.601648</span>  <span class="hljs-number">0.478576</span>  <span class="hljs-number">0.205690</span>  <span class="hljs-number">0.560547</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: df.plot.bar()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-bfc141acb37d99b5.webp" alt="img"></p>
<p>图9-16 DataFrame的柱状图</p>
<p>注意，DataFrame各列的名称”Genus”被用作了图例的标题。</p>
<p>设置stacked=True即可为DataFrame生成堆积柱状图，这样每行的值就会被堆积在一起（如图9-17所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: df.plot.barh(stacked=<span class="hljs-literal">True</span>, alpha=<span class="hljs-number">0.5</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-c19e4246eb897978.webp" alt="img"></p>
<p>图9-17 DataFrame的堆积柱状图</p>
<blockquote>
<p>笔记：柱状图有一个非常不错的用法：利用value_counts图形化显示Series中各值的出现频率，比如s.value_counts().plot.bar()。</p>
</blockquote>
<p>再以本书前面用过的那个有关小费的数据集为例，假设我们想要做一张堆积柱状图以展示每天各种聚会规模的数据点的百分比。我用read_csv将数据加载进来，然后根据日期和聚会规模创建一张交叉表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: tips = pd.read_csv(<span class="hljs-string">'examples/tips.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: party_counts = pd.crosstab(tips[<span class="hljs-string">'day'</span>], tips[<span class="hljs-string">'size'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: party_counts</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">size  <span class="hljs-number">1</span>   <span class="hljs-number">2</span>   <span class="hljs-number">3</span>   <span class="hljs-number">4</span>  <span class="hljs-number">5</span>  <span class="hljs-number">6</span></span><br><span class="line">day                      </span><br><span class="line">Fri   <span class="hljs-number">1</span>  <span class="hljs-number">16</span>   <span class="hljs-number">1</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line">Sat   <span class="hljs-number">2</span>  <span class="hljs-number">53</span>  <span class="hljs-number">18</span>  <span class="hljs-number">13</span>  <span class="hljs-number">1</span>  <span class="hljs-number">0</span></span><br><span class="line">Sun   <span class="hljs-number">0</span>  <span class="hljs-number">39</span>  <span class="hljs-number">15</span>  <span class="hljs-number">18</span>  <span class="hljs-number">3</span>  <span class="hljs-number">1</span></span><br><span class="line">Thur  <span class="hljs-number">1</span>  <span class="hljs-number">48</span>   <span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">1</span>  <span class="hljs-number">3</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Not many 1- and 6-person parties</span></span><br><span class="line">In [<span class="hljs-number">78</span>]: party_counts = party_counts.loc[:, <span class="hljs-number">2</span>:<span class="hljs-number">5</span>]</span><br></pre></td></tr></table></figure>

<p>然后进行规格化，使得各行的和为1，并生成图表（如图9-18所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Normalize to sum to 1</span></span><br><span class="line">In [<span class="hljs-number">79</span>]: party_pcts = party_counts.div(party_counts.sum(<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">80</span>]: party_pcts</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">size         <span class="hljs-number">2</span>         <span class="hljs-number">3</span>         <span class="hljs-number">4</span>         <span class="hljs-number">5</span></span><br><span class="line">day                                         </span><br><span class="line">Fri   <span class="hljs-number">0.888889</span>  <span class="hljs-number">0.055556</span>  <span class="hljs-number">0.055556</span>  <span class="hljs-number">0.000000</span></span><br><span class="line">Sat   <span class="hljs-number">0.623529</span>  <span class="hljs-number">0.211765</span>  <span class="hljs-number">0.152941</span>  <span class="hljs-number">0.011765</span></span><br><span class="line">Sun   <span class="hljs-number">0.520000</span>  <span class="hljs-number">0.200000</span>  <span class="hljs-number">0.240000</span>  <span class="hljs-number">0.040000</span></span><br><span class="line">Thur  <span class="hljs-number">0.827586</span>  <span class="hljs-number">0.068966</span>  <span class="hljs-number">0.086207</span>  <span class="hljs-number">0.017241</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">81</span>]: party_pcts.plot.bar()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-2918f67936823834.webp" alt="img"></p>
<p>图9-18 每天各种聚会规模的比例</p>
<p>于是，通过该数据集就可以看出，聚会规模在周末会变大。</p>
<p>对于在绘制一个图形之前，需要进行合计的数据，使用seaborn可以减少工作量。用seaborn来看每天的小费比例（图9-19是结果）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">83</span>]: <span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: tips[<span class="hljs-string">'tip_pct'</span>] = tips[<span class="hljs-string">'tip'</span>] / (tips[<span class="hljs-string">'total_bill'</span>] - tips[<span class="hljs-string">'tip'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: tips.head()</span><br><span class="line">Out[<span class="hljs-number">85</span>]: </span><br><span class="line">   total_bill   tip smoker  day    time  size   tip_pct</span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">16.99</span>  <span class="hljs-number">1.01</span>     No  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.063204</span></span><br><span class="line"><span class="hljs-number">1</span>       <span class="hljs-number">10.34</span>  <span class="hljs-number">1.66</span>     No  Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.191244</span></span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">21.01</span>  <span class="hljs-number">3.50</span>     No  Sun  Dinner     <span class="hljs-number">3</span>  <span class="hljs-number">0.199886</span></span><br><span class="line"><span class="hljs-number">3</span>       <span class="hljs-number">23.68</span>  <span class="hljs-number">3.31</span>     No  Sun  Dinner     <span class="hljs-number">2</span>  <span class="hljs-number">0.162494</span></span><br><span class="line"><span class="hljs-number">4</span>       <span class="hljs-number">24.59</span>  <span class="hljs-number">3.61</span>     No  Sun  Dinner     <span class="hljs-number">4</span>  <span class="hljs-number">0.172069</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: sns.barplot(x=<span class="hljs-string">'tip_pct'</span>, y=<span class="hljs-string">'day'</span>, data=tips, orient=<span class="hljs-string">'h'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-c33e8b3add99904b.webp" alt="img"></p>
<p>图9-19 小费的每日比例，带有误差条</p>
<p>seaborn的绘制函数使用data参数，它可能是pandas的DataFrame。其它的参数是关于列的名字。因为一天的每个值有多次观察，柱状图的值是tip_pct的平均值。绘制在柱状图上的黑线代表95%置信区间（可以通过可选参数配置）。</p>
<p>seaborn.barplot有颜色选项，使我们能够通过一个额外的值设置（见图9-20）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">88</span>]: sns.barplot(x=<span class="hljs-string">'tip_pct'</span>, y=<span class="hljs-string">'day'</span>, hue=<span class="hljs-string">'time'</span>, data=tips, orient=<span class="hljs-string">'h'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-06abe2f070222115.webp" alt="img"></p>
<p>图9-20 根据天和时间的小费比例</p>
<p>注意，seaborn已经自动修改了图形的美观度：默认调色板，图形背景和网格线的颜色。你可以用seaborn.set在不同的图形外观之间切换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">90</span>]: sns.set(style=<span class="hljs-string">"whitegrid"</span>)</span><br></pre></td></tr></table></figure>

<h2 id="直方图和密度图"><a href="#直方图和密度图" class="headerlink" title="直方图和密度图"></a>直方图和密度图</h2><p>直方图（histogram）是一种可以对值频率进行离散化显示的柱状图。数据点被拆分到离散的、间隔均匀的面元中，绘制的是各面元中数据点的数量。再以前面那个小费数据为例，通过在Series使用plot.hist方法，我们可以生成一张“小费占消费总额百分比”的直方图（如图9-21所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">92</span>]: tips[<span class="hljs-string">'tip_pct'</span>].plot.hist(bins=<span class="hljs-number">50</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-255279376f7649a3.webp" alt="img"></p>
<p>图9-21 小费百分比的直方图</p>
<p>与此相关的一种图表类型是密度图，它是通过计算“可能会产生观测数据的连续概率分布的估计”而产生的。一般的过程是将该分布近似为一组核（即诸如正态分布之类的较为简单的分布）。因此，密度图也被称作KDE（Kernel Density Estimate，核密度估计）图。使用plot.kde和标准混合正态分布估计即可生成一张密度图（见图9-22）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: tips[<span class="hljs-string">'tip_pct'</span>].plot.density()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-ee929d033159516a.webp" alt="img"></p>
<p>图9-22 小费百分比的密度图</p>
<p>seaborn的distplot方法绘制直方图和密度图更加简单，还可以同时画出直方图和连续密度估计图。作为例子，考虑一个双峰分布，由两个不同的标准正态分布组成（见图9-23）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: comp1 = np.random.normal(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, size=<span class="hljs-number">200</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: comp2 = np.random.normal(<span class="hljs-number">10</span>, <span class="hljs-number">2</span>, size=<span class="hljs-number">200</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: values = pd.Series(np.concatenate([comp1, comp2]))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: sns.distplot(values, bins=<span class="hljs-number">100</span>, color=<span class="hljs-string">'k'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-975f04d750c4efe2.webp" alt="img"></p>
<p>图9-23 标准混合密度估计的标准直方图</p>
<h2 id="散布图或点图"><a href="#散布图或点图" class="headerlink" title="散布图或点图"></a>散布图或点图</h2><p>点图或散布图是观察两个一维数据序列之间的关系的有效手段。在下面这个例子中，我加载了来自statsmodels项目的macrodata数据集，选择了几个变量，然后计算对数差：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">100</span>]: macro = pd.read_csv(<span class="hljs-string">'examples/macrodata.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">101</span>]: data = macro[[<span class="hljs-string">'cpi'</span>, <span class="hljs-string">'m1'</span>, <span class="hljs-string">'tbilrate'</span>, <span class="hljs-string">'unemp'</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: trans_data = np.log(data).diff().dropna()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: trans_data[<span class="hljs-number">-5</span>:]</span><br><span class="line">Out[<span class="hljs-number">103</span>]: </span><br><span class="line">          cpi        m1  tbilrate     unemp</span><br><span class="line"><span class="hljs-number">198</span> <span class="hljs-number">-0.007904</span>  <span class="hljs-number">0.045361</span> <span class="hljs-number">-0.396881</span>  <span class="hljs-number">0.105361</span></span><br><span class="line"><span class="hljs-number">199</span> <span class="hljs-number">-0.021979</span>  <span class="hljs-number">0.066753</span> <span class="hljs-number">-2.277267</span>  <span class="hljs-number">0.139762</span></span><br><span class="line"><span class="hljs-number">200</span>  <span class="hljs-number">0.002340</span>  <span class="hljs-number">0.010286</span>  <span class="hljs-number">0.606136</span>  <span class="hljs-number">0.160343</span></span><br><span class="line"><span class="hljs-number">201</span>  <span class="hljs-number">0.008419</span>  <span class="hljs-number">0.037461</span> <span class="hljs-number">-0.200671</span>  <span class="hljs-number">0.127339</span></span><br><span class="line"><span class="hljs-number">202</span>  <span class="hljs-number">0.008894</span>  <span class="hljs-number">0.012202</span> <span class="hljs-number">-0.405465</span>  <span class="hljs-number">0.042560</span></span><br></pre></td></tr></table></figure>

<p>然后可以使用seaborn的regplot方法，它可以做一个散布图，并加上一条线性回归的线（见图9-24）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: sns.regplot(<span class="hljs-string">'m1'</span>, <span class="hljs-string">'unemp'</span>, data=trans_data)</span><br><span class="line">Out[<span class="hljs-number">105</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7fb613720be0</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: plt.title(<span class="hljs-string">'Changes in log %s versus log %s'</span> % (<span class="hljs-string">'m1'</span>, <span class="hljs-string">'unemp'</span>))</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-2133d20739478a80.webp" alt="img"></p>
<p>图9-24 seaborn的回归/散布图</p>
<p>在探索式数据分析工作中，同时观察一组变量的散布图是很有意义的，这也被称为散布图矩阵（scatter plot matrix）。纯手工创建这样的图表很费工夫，所以seaborn提供了一个便捷的pairplot函数，它支持在对角线上放置每个变量的直方图或密度估计（见图9-25）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">107</span>]: sns.pairplot(trans_data, diag_kind=<span class="hljs-string">'kde'</span>, plot_kws=&#123;<span class="hljs-string">'alpha'</span>: <span class="hljs-number">0.2</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-20aa530a44e06f61.webp" alt="img"></p>
<p>图9-25 statsmodels macro data的散布图矩阵</p>
<p>你可能注意到了plot_kws参数。它可以让我们传递配置选项到非对角线元素上的图形使用。对于更详细的配置选项，可以查阅seaborn.pairplot文档字符串。</p>
<h2 id="分面网格（facet-grid）和类型数据"><a href="#分面网格（facet-grid）和类型数据" class="headerlink" title="分面网格（facet grid）和类型数据"></a>分面网格（facet grid）和类型数据</h2><p>要是数据集有额外的分组维度呢？有多个分类变量的数据可视化的一种方法是使用小面网格。seaborn有一个有用的内置函数factorplot，可以简化制作多种分面图（见图9-26）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: sns.factorplot(x=<span class="hljs-string">'day'</span>, y=<span class="hljs-string">'tip_pct'</span>, hue=<span class="hljs-string">'time'</span>, col=<span class="hljs-string">'smoker'</span>,</span><br><span class="line">  .....:                kind=<span class="hljs-string">'bar'</span>, data=tips[tips.tip_pct &lt; <span class="hljs-number">1</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-737ba19a0cbdd46f.webp" alt="img"></p>
<p>图9-26 按照天/时间/吸烟者的小费百分比</p>
<p>除了在分面中用不同的颜色按时间分组，我们还可以通过给每个时间值添加一行来扩展分面网格：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: sns.factorplot(x=<span class="hljs-string">'day'</span>, y=<span class="hljs-string">'tip_pct'</span>, row=<span class="hljs-string">'time'</span>,</span><br><span class="line">   .....:                col=<span class="hljs-string">'smoker'</span>,</span><br><span class="line">   .....:                kind=<span class="hljs-string">'bar'</span>, data=tips[tips.tip_pct &lt; <span class="hljs-number">1</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-4e52192441c609f7.webp" alt="img"></p>
<p>图9-27 按天的tip_pct，通过time/smoker分面</p>
<p>factorplot支持其它的绘图类型，你可能会用到。例如，盒图（它可以显示中位数，四分位数，和异常值）就是一个有用的可视化类型（见图9-28）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">110</span>]: sns.factorplot(x=<span class="hljs-string">'tip_pct'</span>, y=<span class="hljs-string">'day'</span>, kind=<span class="hljs-string">'box'</span>,</span><br><span class="line">   .....:                data=tips[tips.tip_pct &lt; <span class="hljs-number">0.5</span>])</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-356fb27a7c658920.webp" alt="img"></p>
<p>图9-28 按天的tip_pct的盒图</p>
<p>使用更通用的seaborn.FacetGrid类，你可以创建自己的分面网格。请查阅seaborn的文档（<a href="https://seaborn.pydata.org/）。" target="_blank" rel="noopener">https://seaborn.pydata.org/）。</a></p>
<h1 id="9-3-其它的Python可视化工具"><a href="#9-3-其它的Python可视化工具" class="headerlink" title="9.3 其它的Python可视化工具"></a>9.3 其它的Python可视化工具</h1><p>与其它开源库类似，Python创建图形的方式非常多（根本罗列不完）。自从2010年，许多开发工作都集中在创建交互式图形以便在Web上发布。利用工具如Boken（<a href="https://bokeh.pydata.org/en/latest/）和Plotly（https://github.com/plotly/plotly.py），现在可以创建动态交互图形，用于网页浏览器。" target="_blank" rel="noopener">https://bokeh.pydata.org/en/latest/）和Plotly（https://github.com/plotly/plotly.py），现在可以创建动态交互图形，用于网页浏览器。</a></p>
<p>对于创建用于打印或网页的静态图形，我建议默认使用matplotlib和附加的库，比如pandas和seaborn。对于其它数据可视化要求，学习其它的可用工具可能是有用的。我鼓励你探索绘图的生态系统，因为它将持续发展。</p>
<h1 id="9-4-总结"><a href="#9-4-总结" class="headerlink" title="9.4 总结"></a>9.4 总结</h1><p>本章的目的是熟悉一些基本的数据可视化操作，使用pandas，matplotlib，和seaborn。如果视觉显示数据分析的结果对你的工作很重要，我鼓励你寻求更多的资源来了解更高效的数据可视化。这是一个活跃的研究领域，你可以通过在线和纸质的形式学习许多优秀的资源。</p>
<p>下一章，我们将重点放在pandas的数据聚合和分组操作上。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 6710 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC8%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E8%A7%84%E6%95%B4%EF%BC%9A%E8%81%9A%E5%90%88%E3%80%81%E5%90%88%E5%B9%B6%E5%92%8C%E9%87%8D%E5%A1%91/">《利用Python进行数据分析·第2版》第8章 数据规整：聚合、合并和重塑</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
第8章 数据规整：聚合、合并和重塑
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>在许多应用中，数据可能分散在许多文件或数据库中，存储的形式也不利于分析。本章关注可以聚合、合并、重塑数据的方法。</p>
<p>首先，我会介绍pandas的层次化索引，它广泛用于以上操作。然后，我深入介绍了一些特殊的数据操作。在第14章，你可以看到这些工具的多种应用。</p>
<h1 id="8-1-层次化索引"><a href="#8-1-层次化索引" class="headerlink" title="8.1 层次化索引"></a>8.1 层次化索引</h1><p>层次化索引（hierarchical indexing）是pandas的一项重要功能，它使你能在一个轴上拥有多个（两个以上）索引级别。抽象点说，它使你能以低维度形式处理高维度数据。我们先来看一个简单的例子：创建一个Series，并用一个由列表或数组组成的列表作为索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">9</span>]: data = pd.Series(np.random.randn(<span class="hljs-number">9</span>),</span><br><span class="line">   ...:                  index=[[<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">   ...:                         [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">10</span>]: data</span><br><span class="line">Out[<span class="hljs-number">10</span>]: </span><br><span class="line">a  <span class="hljs-number">1</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.478943</span></span><br><span class="line">   <span class="hljs-number">3</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line">b  <span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">c  <span class="hljs-number">1</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.092908</span></span><br><span class="line">d  <span class="hljs-number">2</span>    <span class="hljs-number">0.281746</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">0.769023</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>看到的结果是经过美化的带有MultiIndex索引的Series的格式。索引之间的“间隔”表示“直接使用上面的标签”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">11</span>]: data.index</span><br><span class="line">Out[<span class="hljs-number">11</span>]: </span><br><span class="line">MultiIndex(levels=[[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]],</span><br><span class="line">           labels=[[<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">3</span>], [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]])</span><br></pre></td></tr></table></figure>

<p>对于一个层次化索引的对象，可以使用所谓的部分索引，使用它选取数据子集的操作更简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: data[<span class="hljs-string">'b'</span>]</span><br><span class="line">Out[<span class="hljs-number">12</span>]: </span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: data[<span class="hljs-string">'b'</span>:<span class="hljs-string">'c'</span>]</span><br><span class="line">Out[<span class="hljs-number">13</span>]: </span><br><span class="line">b  <span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">c  <span class="hljs-number">1</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.092908</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: data.loc[[<span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>]]</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">b  <span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">d  <span class="hljs-number">2</span>    <span class="hljs-number">0.281746</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">0.769023</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>有时甚至还可以在“内层”中进行选取：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">15</span>]: data.loc[:, <span class="hljs-number">2</span>]</span><br><span class="line">Out[<span class="hljs-number">15</span>]: </span><br><span class="line">a    <span class="hljs-number">0.478943</span></span><br><span class="line">c    <span class="hljs-number">0.092908</span></span><br><span class="line">d    <span class="hljs-number">0.281746</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>层次化索引在数据重塑和基于分组的操作（如透视表生成）中扮演着重要的角色。例如，可以通过unstack方法将这段数据重新安排到一个DataFrame中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">16</span>]: data.unstack()</span><br><span class="line">Out[<span class="hljs-number">16</span>]: </span><br><span class="line">          <span class="hljs-number">1</span>         <span class="hljs-number">2</span>         <span class="hljs-number">3</span></span><br><span class="line">a <span class="hljs-number">-0.204708</span>  <span class="hljs-number">0.478943</span> <span class="hljs-number">-0.519439</span></span><br><span class="line">b <span class="hljs-number">-0.555730</span>       NaN  <span class="hljs-number">1.965781</span></span><br><span class="line">c  <span class="hljs-number">1.393406</span>  <span class="hljs-number">0.092908</span>       NaN</span><br><span class="line">d       NaN  <span class="hljs-number">0.281746</span>  <span class="hljs-number">0.769023</span></span><br></pre></td></tr></table></figure>

<p>unstack的逆运算是stack：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: data.unstack().stack()</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line">a  <span class="hljs-number">1</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.478943</span></span><br><span class="line">   <span class="hljs-number">3</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line">b  <span class="hljs-number">1</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">c  <span class="hljs-number">1</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">   <span class="hljs-number">2</span>    <span class="hljs-number">0.092908</span></span><br><span class="line">d  <span class="hljs-number">2</span>    <span class="hljs-number">0.281746</span></span><br><span class="line">   <span class="hljs-number">3</span>    <span class="hljs-number">0.769023</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>stack和unstack将在本章后面详细讲解。</p>
<p>对于一个DataFrame，每条轴都可以有分层索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: frame = pd.DataFrame(np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">4</span>, <span class="hljs-number">3</span>)),</span><br><span class="line">   ....:                      index=[[<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>], [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>]],</span><br><span class="line">   ....:                      columns=[[<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Colorado'</span>],</span><br><span class="line">   ....:                               [<span class="hljs-string">'Green'</span>, <span class="hljs-string">'Red'</span>, <span class="hljs-string">'Green'</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">19</span>]: </span><br><span class="line">     Ohio     Colorado</span><br><span class="line">    Green Red    Green</span><br><span class="line">a <span class="hljs-number">1</span>     <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line">  <span class="hljs-number">2</span>     <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line">b <span class="hljs-number">1</span>     <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line">  <span class="hljs-number">2</span>     <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>各层都可以有名字（可以是字符串，也可以是别的Python对象）。如果指定了名称，它们就会显示在控制台输出中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">20</span>]: frame.index.names = [<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: frame.columns.names = [<span class="hljs-string">'state'</span>, <span class="hljs-string">'color'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">22</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">22</span>]: </span><br><span class="line">state      Ohio     Colorado</span><br><span class="line">color     Green Red    Green</span><br><span class="line">key1 key2                   </span><br><span class="line">a    <span class="hljs-number">1</span>        <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line">     <span class="hljs-number">2</span>        <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line">b    <span class="hljs-number">1</span>        <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line">     <span class="hljs-number">2</span>        <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：小心区分索引名state、color与行标签。</p>
</blockquote>
<p>有了部分列索引，因此可以轻松选取列分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">23</span>]: frame[<span class="hljs-string">'Ohio'</span>]</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">color      Green  Red</span><br><span class="line">key1 key2            </span><br><span class="line">a    <span class="hljs-number">1</span>         <span class="hljs-number">0</span>    <span class="hljs-number">1</span></span><br><span class="line">     <span class="hljs-number">2</span>         <span class="hljs-number">3</span>    <span class="hljs-number">4</span></span><br><span class="line">b    <span class="hljs-number">1</span>         <span class="hljs-number">6</span>    <span class="hljs-number">7</span></span><br><span class="line">     <span class="hljs-number">2</span>         <span class="hljs-number">9</span>   <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>可以单独创建MultiIndex然后复用。上面那个DataFrame中的（带有分级名称）列可以这样创建：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MultiIndex.from_arrays([[<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Colorado'</span>], [<span class="hljs-string">'Green'</span>, <span class="hljs-string">'Red'</span>, <span class="hljs-string">'Green'</span>]],</span><br><span class="line">                       names=[<span class="hljs-string">'state'</span>, <span class="hljs-string">'color'</span>])</span><br></pre></td></tr></table></figure>

<h2 id="重排与分级排序"><a href="#重排与分级排序" class="headerlink" title="重排与分级排序"></a>重排与分级排序</h2><p>有时，你需要重新调整某条轴上各级别的顺序，或根据指定级别上的值对数据进行排序。swaplevel接受两个级别编号或名称，并返回一个互换了级别的新对象（但数据不会发生变化）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: frame.swaplevel(<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>)</span><br><span class="line">Out[<span class="hljs-number">24</span>]: </span><br><span class="line">state      Ohio     Colorado</span><br><span class="line">color     Green Red    Green</span><br><span class="line">key2 key1                   </span><br><span class="line"><span class="hljs-number">1</span>    a        <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>    a        <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1</span>    b        <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">2</span>    b        <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>而sort_index则根据单个级别中的值对数据进行排序。交换级别时，常常也会用到sort_index，这样最终结果就是按照指定顺序进行字母排序了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: frame.sort_index(level=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">state      Ohio     Colorado</span><br><span class="line">color     Green Red    Green</span><br><span class="line">key1 key2                   </span><br><span class="line">a    <span class="hljs-number">1</span>        <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line">b    <span class="hljs-number">1</span>        <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line">a    <span class="hljs-number">2</span>        <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line">b    <span class="hljs-number">2</span>        <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">26</span>]: frame.swaplevel(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>).sort_index(level=<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">26</span>]: </span><br><span class="line">state      Ohio     Colorado</span><br><span class="line">color     Green Red    Green</span><br><span class="line">key2 key1                   </span><br><span class="line"><span class="hljs-number">1</span>    a        <span class="hljs-number">0</span>   <span class="hljs-number">1</span>        <span class="hljs-number">2</span></span><br><span class="line">     b        <span class="hljs-number">6</span>   <span class="hljs-number">7</span>        <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">2</span>    a        <span class="hljs-number">3</span>   <span class="hljs-number">4</span>        <span class="hljs-number">5</span></span><br><span class="line">     b        <span class="hljs-number">9</span>  <span class="hljs-number">10</span>       <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<h2 id="根据级别汇总统计"><a href="#根据级别汇总统计" class="headerlink" title="根据级别汇总统计"></a>根据级别汇总统计</h2><p>许多对DataFrame和Series的描述和汇总统计都有一个level选项，它用于指定在某条轴上求和的级别。再以上面那个DataFrame为例，我们可以根据行或列上的级别来进行求和：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">27</span>]: frame.sum(level=<span class="hljs-string">'key2'</span>)</span><br><span class="line">Out[<span class="hljs-number">27</span>]: </span><br><span class="line">state  Ohio     Colorado</span><br><span class="line">color Green Red    Green</span><br><span class="line">key2                    </span><br><span class="line"><span class="hljs-number">1</span>         <span class="hljs-number">6</span>   <span class="hljs-number">8</span>       <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">2</span>        <span class="hljs-number">12</span>  <span class="hljs-number">14</span>       <span class="hljs-number">16</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: frame.sum(level=<span class="hljs-string">'color'</span>, axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">color      Green  Red</span><br><span class="line">key1 key2            </span><br><span class="line">a    <span class="hljs-number">1</span>         <span class="hljs-number">2</span>    <span class="hljs-number">1</span></span><br><span class="line">     <span class="hljs-number">2</span>         <span class="hljs-number">8</span>    <span class="hljs-number">4</span></span><br><span class="line">b    <span class="hljs-number">1</span>        <span class="hljs-number">14</span>    <span class="hljs-number">7</span></span><br><span class="line">     <span class="hljs-number">2</span>        <span class="hljs-number">20</span>   <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>这其实是利用了pandas的groupby功能，本书稍后将对其进行详细讲解。</p>
<h2 id="使用DataFrame的列进行索引"><a href="#使用DataFrame的列进行索引" class="headerlink" title="使用DataFrame的列进行索引"></a>使用DataFrame的列进行索引</h2><p>人们经常想要将DataFrame的一个或多个列当做行索引来用，或者可能希望将行索引变成DataFrame的列。以下面这个DataFrame为例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: frame = pd.DataFrame(&#123;<span class="hljs-string">'a'</span>: range(<span class="hljs-number">7</span>), <span class="hljs-string">'b'</span>: range(<span class="hljs-number">7</span>, <span class="hljs-number">0</span>, <span class="hljs-number">-1</span>),</span><br><span class="line">   ....:                       <span class="hljs-string">'c'</span>: [<span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'two'</span>,</span><br><span class="line">   ....:                             <span class="hljs-string">'two'</span>, <span class="hljs-string">'two'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'d'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">   a  b    c  d</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">7</span>  one  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">6</span>  one  <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  one  <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  two  <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">4</span>  <span class="hljs-number">3</span>  two  <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">5</span>  <span class="hljs-number">5</span>  <span class="hljs-number">2</span>  two  <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">6</span>  <span class="hljs-number">6</span>  <span class="hljs-number">1</span>  two  <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<p>DataFrame的set_index函数会将其一个或多个列转换为行索引，并创建一个新的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: frame2 = frame.set_index([<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: frame2</span><br><span class="line">Out[<span class="hljs-number">32</span>]: </span><br><span class="line">       a  b</span><br><span class="line">c   d      </span><br><span class="line">one <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">7</span></span><br><span class="line">    <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">6</span></span><br><span class="line">    <span class="hljs-number">2</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span></span><br><span class="line">two <span class="hljs-number">0</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span></span><br><span class="line">    <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">3</span></span><br><span class="line">    <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">2</span></span><br><span class="line">    <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，那些列会从DataFrame中移除，但也可以将其保留下来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: frame.set_index([<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>], drop=<span class="hljs-literal">False</span>)</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">       a  b    c  d</span><br><span class="line">c   d              </span><br><span class="line">one <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">7</span>  one  <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">6</span>  one  <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-number">2</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  one  <span class="hljs-number">2</span></span><br><span class="line">two <span class="hljs-number">0</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span>  two  <span class="hljs-number">0</span></span><br><span class="line">    <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">3</span>  two  <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">2</span>  two  <span class="hljs-number">2</span></span><br><span class="line">    <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">1</span>  two  <span class="hljs-number">3</span></span><br></pre></td></tr></table></figure>

<p>reset_index的功能跟set_index刚好相反，层次化索引的级别会被转移到列里面：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">34</span>]: frame2.reset_index()</span><br><span class="line">Out[<span class="hljs-number">34</span>]:</span><br><span class="line">c  d  a  b</span><br><span class="line"><span class="hljs-number">0</span>  one  <span class="hljs-number">0</span>  <span class="hljs-number">0</span>  <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">1</span>  one  <span class="hljs-number">1</span>  <span class="hljs-number">1</span>  <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">2</span>  one  <span class="hljs-number">2</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">3</span>  two  <span class="hljs-number">0</span>  <span class="hljs-number">3</span>  <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">4</span>  two  <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">5</span>  two  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">6</span>  two  <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<h1 id="8-2-合并数据集"><a href="#8-2-合并数据集" class="headerlink" title="8.2 合并数据集"></a>8.2 合并数据集</h1><p>pandas对象中的数据可以通过一些方式进行合并：</p>
<ul>
<li>pandas.merge可根据一个或多个键将不同DataFrame中的行连接起来。SQL或其他关系型数据库的用户对此应该会比较熟悉，因为它实现的就是数据库的join操作。</li>
<li>pandas.concat可以沿着一条轴将多个对象堆叠到一起。</li>
<li>实例方法combine_first可以将重复数据拼接在一起，用一个对象中的值填充另一个对象中的缺失值。</li>
</ul>
<p>我将分别对它们进行讲解，并给出一些例子。本书剩余部分的示例中将经常用到它们。</p>
<h2 id="数据库风格的DataFrame合并"><a href="#数据库风格的DataFrame合并" class="headerlink" title="数据库风格的DataFrame合并"></a>数据库风格的DataFrame合并</h2><p>数据集的合并（merge）或连接（join）运算是通过一个或多个键将行连接起来的。这些运算是关系型数据库（基于SQL）的核心。pandas的merge函数是对数据应用这些算法的主要切入点。</p>
<p>以一个简单的例子开始：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: df1 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data1'</span>: range(<span class="hljs-number">7</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: df2 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data2'</span>: range(<span class="hljs-number">3</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">   data1 key</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>   a</span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">3</span>   c</span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   a</span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   a</span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">6</span>   b</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">38</span>]: </span><br><span class="line">   data2 key</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   a</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>   d</span><br></pre></td></tr></table></figure>

<p>这是一种多对一的合并。df1中的数据有多个被标记为a和b的行，而df2中key列的每个值则仅对应一行。对这些对象调用merge即可得到：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: pd.merge(df1, df2)</span><br><span class="line">Out[<span class="hljs-number">39</span>]: </span><br><span class="line">   data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">6</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">2</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   a      <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>注意，我并没有指明要用哪个列进行连接。如果没有指定，merge就会将重叠列的列名当做键。不过，最好明确指定一下：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">40</span>]: pd.merge(df1, df2, on=<span class="hljs-string">'key'</span>)</span><br><span class="line">Out[<span class="hljs-number">40</span>]: </span><br><span class="line">   data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">6</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">2</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   a      <span class="hljs-number">0</span></span><br></pre></td></tr></table></figure>

<p>如果两个对象的列名不同，也可以分别进行指定：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">41</span>]: df3 = pd.DataFrame(&#123;<span class="hljs-string">'lkey'</span>: [<span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data1'</span>: range(<span class="hljs-number">7</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: df4 = pd.DataFrame(&#123;<span class="hljs-string">'rkey'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data2'</span>: range(<span class="hljs-number">3</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: pd.merge(df3, df4, left_on=<span class="hljs-string">'lkey'</span>, right_on=<span class="hljs-string">'rkey'</span>)</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line">   data1 lkey  data2 rkey</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>    b      <span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>    b      <span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">6</span>    b      <span class="hljs-number">1</span>    b</span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">2</span>    a      <span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>    a      <span class="hljs-number">0</span>    a</span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>    a      <span class="hljs-number">0</span>    a</span><br></pre></td></tr></table></figure>

<p>可能你已经注意到了，结果里面c和d以及与之相关的数据消失了。默认情况下，merge做的是“内连接”；结果中的键是交集。其他方式还有”left”、”right”以及”outer”。外连接求取的是键的并集，组合了左连接和右连接的效果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: pd.merge(df1, df2, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line">   data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>    <span class="hljs-number">0.0</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    <span class="hljs-number">1.0</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">6.0</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">3</span>    <span class="hljs-number">2.0</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">4</span>    <span class="hljs-number">4.0</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>    <span class="hljs-number">5.0</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">6</span>    <span class="hljs-number">3.0</span>   c    NaN</span><br><span class="line"><span class="hljs-number">7</span>    NaN   d    <span class="hljs-number">2.0</span></span><br></pre></td></tr></table></figure>

<p>表8-1对这些选项进行了总结。</p>
<p><img src="/images/blog/7178691-e49b3341f4a3c90e.webp" alt="img"></p>
<p>表8-1 不同的连接类型</p>
<p>多对多的合并有些不直观。看下面的例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: df1 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data1'</span>: range(<span class="hljs-number">6</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">46</span>]: df2 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">   ....:                     <span class="hljs-string">'data2'</span>: range(<span class="hljs-number">5</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">47</span>]: </span><br><span class="line">   data1 key</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>   a</span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">3</span>   c</span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   a</span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   b</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line">   data2 key</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   a</span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1</span>   b</span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">2</span>   a</span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">3</span>   b</span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">4</span>   d</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">49</span>]: pd.merge(df1, df2, on=<span class="hljs-string">'key'</span>, how=<span class="hljs-string">'left'</span>)</span><br><span class="line">Out[<span class="hljs-number">49</span>]: </span><br><span class="line">    data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>       <span class="hljs-number">0</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>       <span class="hljs-number">0</span>   b    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">2</span>       <span class="hljs-number">1</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">3</span>       <span class="hljs-number">1</span>   b    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">4</span>       <span class="hljs-number">2</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>       <span class="hljs-number">2</span>   a    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">6</span>       <span class="hljs-number">3</span>   c    NaN</span><br><span class="line"><span class="hljs-number">7</span>       <span class="hljs-number">4</span>   a    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">8</span>       <span class="hljs-number">4</span>   a    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">9</span>       <span class="hljs-number">5</span>   b    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">10</span>      <span class="hljs-number">5</span>   b    <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>多对多连接产生的是行的笛卡尔积。由于左边的DataFrame有3个”b”行，右边的有2个，所以最终结果中就有6个”b”行。连接方式只影响出现在结果中的不同的键的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: pd.merge(df1, df2, how=<span class="hljs-string">'inner'</span>)</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">   data1 key  data2</span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">0</span>   b      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">1</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">1</span>   b      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">5</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">5</span>   b      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">2</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">7</span>      <span class="hljs-number">2</span>   a      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">8</span>      <span class="hljs-number">4</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">9</span>      <span class="hljs-number">4</span>   a      <span class="hljs-number">2</span></span><br></pre></td></tr></table></figure>

<p>要根据多个键进行合并，传入一个由列名组成的列表即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">51</span>]: left = pd.DataFrame(&#123;<span class="hljs-string">'key1'</span>: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>],</span><br><span class="line">   ....:                      <span class="hljs-string">'key2'</span>: [<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'one'</span>],</span><br><span class="line">   ....:                      <span class="hljs-string">'lval'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">52</span>]: right = pd.DataFrame(&#123;<span class="hljs-string">'key1'</span>: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'bar'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'key2'</span>: [<span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'rval'</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: pd.merge(left, right, on=[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>], how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">  key1 key2  lval  rval</span><br><span class="line"><span class="hljs-number">0</span>  foo  one   <span class="hljs-number">1.0</span>   <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">1</span>  foo  one   <span class="hljs-number">1.0</span>   <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">2</span>  foo  two   <span class="hljs-number">2.0</span>   NaN</span><br><span class="line"><span class="hljs-number">3</span>  bar  one   <span class="hljs-number">3.0</span>   <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">4</span>  bar  two   NaN   <span class="hljs-number">7.0</span></span><br></pre></td></tr></table></figure>

<p>结果中会出现哪些键组合取决于所选的合并方式，你可以这样来理解：多个键形成一系列元组，并将其当做单个连接键（当然，实际上并不是这么回事）。</p>
<blockquote>
<p>注意：在进行列－列连接时，DataFrame对象中的索引会被丢弃。</p>
</blockquote>
<p>对于合并运算需要考虑的最后一个问题是对重复列名的处理。虽然你可以手工处理列名重叠的问题（查看前面介绍的重命名轴标签），但merge有一个更实用的suffixes选项，用于指定附加到左右两个DataFrame对象的重叠列名上的字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: pd.merge(left, right, on=<span class="hljs-string">'key1'</span>)</span><br><span class="line">Out[<span class="hljs-number">54</span>]: </span><br><span class="line">  key1 key2_x  lval key2_y  rval</span><br><span class="line"><span class="hljs-number">0</span>  foo    one     <span class="hljs-number">1</span>    one     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">1</span>  foo    one     <span class="hljs-number">1</span>    one     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2</span>  foo    two     <span class="hljs-number">2</span>    one     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">3</span>  foo    two     <span class="hljs-number">2</span>    one     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">4</span>  bar    one     <span class="hljs-number">3</span>    one     <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">5</span>  bar    one     <span class="hljs-number">3</span>    two     <span class="hljs-number">7</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: pd.merge(left, right, on=<span class="hljs-string">'key1'</span>, suffixes=(<span class="hljs-string">'_left'</span>, <span class="hljs-string">'_right'</span>))</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line">  key1 key2_left  lval key2_right  rval</span><br><span class="line"><span class="hljs-number">0</span>  foo       one     <span class="hljs-number">1</span>        one     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">1</span>  foo       one     <span class="hljs-number">1</span>        one     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2</span>  foo       two     <span class="hljs-number">2</span>        one     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">3</span>  foo       two     <span class="hljs-number">2</span>        one     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">4</span>  bar       one     <span class="hljs-number">3</span>        one     <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">5</span>  bar       one     <span class="hljs-number">3</span>        two     <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<p>merge的参数请参见表8-2。使用DataFrame的行索引合并是下一节的主题。</p>
<p>表8-2 merge函数的参数</p>
<p><img src="/images/blog/7178691-35ca716a4f1b8475.webp" alt="img"></p>
<p><img src="/images/blog/7178691-c86672e733ceccd9.webp" alt="img"></p>
<p>indicator 添加特殊的列_merge，它可以指明每个行的来源，它的值有left_only、right_only或both，根据每行的合并数据的来源。</p>
<h2 id="索引上的合并"><a href="#索引上的合并" class="headerlink" title="索引上的合并"></a>索引上的合并</h2><p>有时候，DataFrame中的连接键位于其索引中。在这种情况下，你可以传入left_index=True或right_index=True（或两个都传）以说明索引应该被用作连接键：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: left1 = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'value'</span>: range(<span class="hljs-number">6</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">57</span>]: right1 = pd.DataFrame(&#123;<span class="hljs-string">'group_val'</span>: [<span class="hljs-number">3.5</span>, <span class="hljs-number">7</span>]&#125;, index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: left1</span><br><span class="line">Out[<span class="hljs-number">58</span>]:</span><br><span class="line"></span><br><span class="line">  key  value</span><br><span class="line"><span class="hljs-number">0</span>   a      <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>   b      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>   a      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">3</span>   a      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">4</span>   b      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">5</span>   c      <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: right1</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line">   group_val</span><br><span class="line">a        <span class="hljs-number">3.5</span></span><br><span class="line">b        <span class="hljs-number">7.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: pd.merge(left1, right1, left_on=<span class="hljs-string">'key'</span>, right_index=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">60</span>]: </span><br><span class="line">  key  value  group_val</span><br><span class="line"><span class="hljs-number">0</span>   a      <span class="hljs-number">0</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">2</span>   a      <span class="hljs-number">2</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">3</span>   a      <span class="hljs-number">3</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">1</span>   b      <span class="hljs-number">1</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">4</span>   b      <span class="hljs-number">4</span>        <span class="hljs-number">7.0</span></span><br></pre></td></tr></table></figure>

<p>由于默认的merge方法是求取连接键的交集，因此你可以通过外连接的方式得到它们的并集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">61</span>]: pd.merge(left1, right1, left_on=<span class="hljs-string">'key'</span>, right_index=<span class="hljs-literal">True</span>, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line">  key  value  group_val</span><br><span class="line"><span class="hljs-number">0</span>   a      <span class="hljs-number">0</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">2</span>   a      <span class="hljs-number">2</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">3</span>   a      <span class="hljs-number">3</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">1</span>   b      <span class="hljs-number">1</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">4</span>   b      <span class="hljs-number">4</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">5</span>   c      <span class="hljs-number">5</span>        NaN</span><br></pre></td></tr></table></figure>

<p>对于层次化索引的数据，事情就有点复杂了，因为索引的合并默认是多键合并：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">62</span>]: lefth = pd.DataFrame(&#123;<span class="hljs-string">'key1'</span>: [<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>,</span><br><span class="line">   ....:                                <span class="hljs-string">'Nevada'</span>, <span class="hljs-string">'Nevada'</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'key2'</span>: [<span class="hljs-number">2000</span>, <span class="hljs-number">2001</span>, <span class="hljs-number">2002</span>, <span class="hljs-number">2001</span>, <span class="hljs-number">2002</span>],</span><br><span class="line">   ....:                       <span class="hljs-string">'data'</span>: np.arange(<span class="hljs-number">5.</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: righth = pd.DataFrame(np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">6</span>, <span class="hljs-number">2</span>)),</span><br><span class="line">   ....:                       index=[[<span class="hljs-string">'Nevada'</span>, <span class="hljs-string">'Nevada'</span>, <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>,</span><br><span class="line">   ....:                               <span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Ohio'</span>],</span><br><span class="line">   ....:                              [<span class="hljs-number">2001</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">2000</span>, <span class="hljs-number">2001</span>, <span class="hljs-number">2002</span>]],</span><br><span class="line">   ....:                       columns=[<span class="hljs-string">'event1'</span>, <span class="hljs-string">'event2'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">64</span>]: lefth</span><br><span class="line">Out[<span class="hljs-number">64</span>]: </span><br><span class="line">   data    key1  key2</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">1.0</span>    Ohio  <span class="hljs-number">2001</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">2.0</span>    Ohio  <span class="hljs-number">2002</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">3.0</span>  Nevada  <span class="hljs-number">2001</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">4.0</span>  Nevada  <span class="hljs-number">2002</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">65</span>]: righth</span><br><span class="line">Out[<span class="hljs-number">65</span>]: </span><br><span class="line">             event1  event2</span><br><span class="line">Nevada <span class="hljs-number">2001</span>       <span class="hljs-number">0</span>       <span class="hljs-number">1</span></span><br><span class="line">       <span class="hljs-number">2000</span>       <span class="hljs-number">2</span>       <span class="hljs-number">3</span></span><br><span class="line">Ohio   <span class="hljs-number">2000</span>       <span class="hljs-number">4</span>       <span class="hljs-number">5</span></span><br><span class="line">       <span class="hljs-number">2000</span>       <span class="hljs-number">6</span>       <span class="hljs-number">7</span></span><br><span class="line">       <span class="hljs-number">2001</span>       <span class="hljs-number">8</span>       <span class="hljs-number">9</span></span><br><span class="line">       <span class="hljs-number">2002</span>      <span class="hljs-number">10</span>      <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<p>这种情况下，你必须以列表的形式指明用作合并键的多个列（注意用how=’outer’对重复索引值的处理）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: pd.merge(lefth, righth, left_on=[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>], right_index=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">66</span>]: </span><br><span class="line">   data    key1  key2  event1  event2</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span>       <span class="hljs-number">4</span>       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span>       <span class="hljs-number">6</span>       <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">1.0</span>    Ohio  <span class="hljs-number">2001</span>       <span class="hljs-number">8</span>       <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">2.0</span>    Ohio  <span class="hljs-number">2002</span>      <span class="hljs-number">10</span>      <span class="hljs-number">11</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">3.0</span>  Nevada  <span class="hljs-number">2001</span>       <span class="hljs-number">0</span>       <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: pd.merge(lefth, righth, left_on=[<span class="hljs-string">'key1'</span>, <span class="hljs-string">'key2'</span>],</span><br><span class="line">   ....:          right_index=<span class="hljs-literal">True</span>, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">67</span>]: </span><br><span class="line">   data    key1  key2  event1  event2</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span>     <span class="hljs-number">4.0</span>     <span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">0.0</span>    Ohio  <span class="hljs-number">2000</span>     <span class="hljs-number">6.0</span>     <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">1.0</span>    Ohio  <span class="hljs-number">2001</span>     <span class="hljs-number">8.0</span>     <span class="hljs-number">9.0</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">2.0</span>    Ohio  <span class="hljs-number">2002</span>    <span class="hljs-number">10.0</span>    <span class="hljs-number">11.0</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">3.0</span>  Nevada  <span class="hljs-number">2001</span>     <span class="hljs-number">0.0</span>     <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">4.0</span>  Nevada  <span class="hljs-number">2002</span>     NaN     NaN</span><br><span class="line"><span class="hljs-number">4</span>   NaN  Nevada  <span class="hljs-number">2000</span>     <span class="hljs-number">2.0</span>     <span class="hljs-number">3.0</span></span><br></pre></td></tr></table></figure>

<p>同时使用合并双方的索引也没问题：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: left2 = pd.DataFrame([[<span class="hljs-number">1.</span>, <span class="hljs-number">2.</span>], [<span class="hljs-number">3.</span>, <span class="hljs-number">4.</span>], [<span class="hljs-number">5.</span>, <span class="hljs-number">6.</span>]],</span><br><span class="line">   ....:                      index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'e'</span>],</span><br><span class="line">   ....:                      columns=[<span class="hljs-string">'Ohio'</span>, <span class="hljs-string">'Nevada'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">69</span>]: right2 = pd.DataFrame([[<span class="hljs-number">7.</span>, <span class="hljs-number">8.</span>], [<span class="hljs-number">9.</span>, <span class="hljs-number">10.</span>], [<span class="hljs-number">11.</span>, <span class="hljs-number">12.</span>], [<span class="hljs-number">13</span>, <span class="hljs-number">14</span>]],</span><br><span class="line">   ....:                       index=[<span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>],</span><br><span class="line">   ....:                       columns=[<span class="hljs-string">'Missouri'</span>, <span class="hljs-string">'Alabama'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: left2</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">   Ohio  Nevada</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span></span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span></span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: right2</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line">   Missouri  Alabama</span><br><span class="line">b       <span class="hljs-number">7.0</span>      <span class="hljs-number">8.0</span></span><br><span class="line">c       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span></span><br><span class="line">d      <span class="hljs-number">11.0</span>     <span class="hljs-number">12.0</span></span><br><span class="line">e      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: pd.merge(left2, right2, how=<span class="hljs-string">'outer'</span>, left_index=<span class="hljs-literal">True</span>, right_index=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line">   Ohio  Nevada  Missouri  Alabama</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span>       NaN      NaN</span><br><span class="line">b   NaN     NaN       <span class="hljs-number">7.0</span>      <span class="hljs-number">8.0</span></span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span>       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span></span><br><span class="line">d   NaN     NaN      <span class="hljs-number">11.0</span>     <span class="hljs-number">12.0</span></span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span>      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span></span><br></pre></td></tr></table></figure>

<p>DataFrame还有一个便捷的join实例方法，它能更为方便地实现按索引合并。它还可用于合并多个带有相同或相似索引的DataFrame对象，但要求没有重叠的列。在上面那个例子中，我们可以编写：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: left2.join(right2, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">73</span>]: </span><br><span class="line">   Ohio  Nevada  Missouri  Alabama</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span>       NaN      NaN</span><br><span class="line">b   NaN     NaN       <span class="hljs-number">7.0</span>      <span class="hljs-number">8.0</span></span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span>       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span></span><br><span class="line">d   NaN     NaN      <span class="hljs-number">11.0</span>     <span class="hljs-number">12.0</span></span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span>      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span></span><br></pre></td></tr></table></figure>

<p>因为一些历史版本的遗留原因，DataFrame的join方法默认使用的是左连接，保留左边表的行索引。它还支持在调用的DataFrame的列上，连接传递的DataFrame索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: left1.join(right1, on=<span class="hljs-string">'key'</span>)</span><br><span class="line">Out[<span class="hljs-number">74</span>]: </span><br><span class="line">  key  value  group_val</span><br><span class="line"><span class="hljs-number">0</span>   a      <span class="hljs-number">0</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">1</span>   b      <span class="hljs-number">1</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">2</span>   a      <span class="hljs-number">2</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">3</span>   a      <span class="hljs-number">3</span>        <span class="hljs-number">3.5</span></span><br><span class="line"><span class="hljs-number">4</span>   b      <span class="hljs-number">4</span>        <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-number">5</span>   c      <span class="hljs-number">5</span>        NaN</span><br></pre></td></tr></table></figure>

<p>最后，对于简单的索引合并，你还可以向join传入一组DataFrame，下一节会介绍更为通用的concat函数，也能实现此功能：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">75</span>]: another = pd.DataFrame([[<span class="hljs-number">7.</span>, <span class="hljs-number">8.</span>], [<span class="hljs-number">9.</span>, <span class="hljs-number">10.</span>], [<span class="hljs-number">11.</span>, <span class="hljs-number">12.</span>], [<span class="hljs-number">16.</span>, <span class="hljs-number">17.</span>]],</span><br><span class="line">   ....:                        index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'f'</span>],</span><br><span class="line">   ....:                        columns=[<span class="hljs-string">'New York'</span>,</span><br><span class="line"><span class="hljs-string">'Oregon'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: another</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">   New York  Oregon</span><br><span class="line">a       <span class="hljs-number">7.0</span>     <span class="hljs-number">8.0</span></span><br><span class="line">c       <span class="hljs-number">9.0</span>    <span class="hljs-number">10.0</span></span><br><span class="line">e      <span class="hljs-number">11.0</span>    <span class="hljs-number">12.0</span></span><br><span class="line">f      <span class="hljs-number">16.0</span>    <span class="hljs-number">17.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: left2.join([right2, another])</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">   Ohio  Nevada  Missouri  Alabama  New York  Oregon</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span>       NaN      NaN       <span class="hljs-number">7.0</span>     <span class="hljs-number">8.0</span></span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span>       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span>       <span class="hljs-number">9.0</span>    <span class="hljs-number">10.0</span></span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span>      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span>      <span class="hljs-number">11.0</span>    <span class="hljs-number">12.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: left2.join([right2, another], how=<span class="hljs-string">'outer'</span>)</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">   Ohio  Nevada  Missouri  Alabama  New York  Oregon</span><br><span class="line">a   <span class="hljs-number">1.0</span>     <span class="hljs-number">2.0</span>       NaN      NaN       <span class="hljs-number">7.0</span>     <span class="hljs-number">8.0</span></span><br><span class="line">b   NaN     NaN       <span class="hljs-number">7.0</span>      <span class="hljs-number">8.0</span>       NaN     NaN</span><br><span class="line">c   <span class="hljs-number">3.0</span>     <span class="hljs-number">4.0</span>       <span class="hljs-number">9.0</span>     <span class="hljs-number">10.0</span>       <span class="hljs-number">9.0</span>    <span class="hljs-number">10.0</span></span><br><span class="line">d   NaN     NaN      <span class="hljs-number">11.0</span>     <span class="hljs-number">12.0</span>       NaN     NaN</span><br><span class="line">e   <span class="hljs-number">5.0</span>     <span class="hljs-number">6.0</span>      <span class="hljs-number">13.0</span>     <span class="hljs-number">14.0</span>      <span class="hljs-number">11.0</span>    <span class="hljs-number">12.0</span></span><br><span class="line">f   NaN     NaN       NaN      NaN      <span class="hljs-number">16.0</span>    <span class="hljs-number">17.0</span></span><br></pre></td></tr></table></figure>

<h2 id="轴向连接"><a href="#轴向连接" class="headerlink" title="轴向连接"></a>轴向连接</h2><p>另一种数据合并运算也被称作连接（concatenation）、绑定（binding）或堆叠（stacking）。NumPy的concatenation函数可以用NumPy数组来做：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: arr = np.arange(<span class="hljs-number">12</span>).reshape((<span class="hljs-number">3</span>, <span class="hljs-number">4</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">80</span>]: arr</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],</span><br><span class="line">       [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],</span><br><span class="line">       [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">81</span>]: np.concatenate([arr, arr], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">81</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>,  <span class="hljs-number">0</span>,  <span class="hljs-number">1</span>,  <span class="hljs-number">2</span>,  <span class="hljs-number">3</span>],</span><br><span class="line">       [ <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>,  <span class="hljs-number">4</span>,  <span class="hljs-number">5</span>,  <span class="hljs-number">6</span>,  <span class="hljs-number">7</span>],</span><br><span class="line">       [ <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>,  <span class="hljs-number">8</span>,  <span class="hljs-number">9</span>, <span class="hljs-number">10</span>, <span class="hljs-number">11</span>]])</span><br></pre></td></tr></table></figure>

<p>对于pandas对象（如Series和DataFrame），带有标签的轴使你能够进一步推广数组的连接运算。具体点说，你还需要考虑以下这些东西：</p>
<ul>
<li>如果对象在其它轴上的索引不同，我们应该合并这些轴的不同元素还是只使用交集？</li>
<li>连接的数据集是否需要在结果对象中可识别？</li>
<li>连接轴中保存的数据是否需要保留？许多情况下，DataFrame默认的整数标签最好在连接时删掉。</li>
</ul>
<p>pandas的concat函数提供了一种能够解决这些问题的可靠方式。我将给出一些例子来讲解其使用方式。假设有三个没有重叠索引的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: s1 = pd.Series([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>], index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: s2 = pd.Series([<span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>], index=[<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: s3 = pd.Series([<span class="hljs-number">5</span>, <span class="hljs-number">6</span>], index=[<span class="hljs-string">'f'</span>, <span class="hljs-string">'g'</span>])</span><br></pre></td></tr></table></figure>

<p>对这些对象调用concat可以将值和索引粘合在一起：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: pd.concat([s1, s2, s3])</span><br><span class="line">Out[<span class="hljs-number">85</span>]: </span><br><span class="line">a    <span class="hljs-number">0</span></span><br><span class="line">b    <span class="hljs-number">1</span></span><br><span class="line">c    <span class="hljs-number">2</span></span><br><span class="line">d    <span class="hljs-number">3</span></span><br><span class="line">e    <span class="hljs-number">4</span></span><br><span class="line">f    <span class="hljs-number">5</span></span><br><span class="line">g    <span class="hljs-number">6</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>默认情况下，concat是在axis=0上工作的，最终产生一个新的Series。如果传入axis=1，则结果就会变成一个DataFrame（axis=1是列）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: pd.concat([s1, s2, s3], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span>    <span class="hljs-number">2</span></span><br><span class="line">a  <span class="hljs-number">0.0</span>  NaN  NaN</span><br><span class="line">b  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line">c  NaN  <span class="hljs-number">2.0</span>  NaN</span><br><span class="line">d  NaN  <span class="hljs-number">3.0</span>  NaN</span><br><span class="line">e  NaN  <span class="hljs-number">4.0</span>  NaN</span><br><span class="line">f  NaN  NaN  <span class="hljs-number">5.0</span></span><br><span class="line">g  NaN  NaN  <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>这种情况下，另外的轴上没有重叠，从索引的有序并集（外连接）上就可以看出来。传入join=’inner’即可得到它们的交集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: s4 = pd.concat([s1, s3])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: s4</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">a    <span class="hljs-number">0</span></span><br><span class="line">b    <span class="hljs-number">1</span></span><br><span class="line">f    <span class="hljs-number">5</span></span><br><span class="line">g    <span class="hljs-number">6</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: pd.concat([s1, s4], axis=<span class="hljs-number">1</span>)</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br><span class="line">a  <span class="hljs-number">0.0</span>  <span class="hljs-number">0</span></span><br><span class="line">b  <span class="hljs-number">1.0</span>  <span class="hljs-number">1</span></span><br><span class="line">f  NaN  <span class="hljs-number">5</span></span><br><span class="line">g  NaN  <span class="hljs-number">6</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: pd.concat([s1, s4], axis=<span class="hljs-number">1</span>, join=<span class="hljs-string">'inner'</span>)</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">   <span class="hljs-number">0</span>  <span class="hljs-number">1</span></span><br><span class="line">a  <span class="hljs-number">0</span>  <span class="hljs-number">0</span></span><br><span class="line">b  <span class="hljs-number">1</span>  <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>在这个例子中，f和g标签消失了，是因为使用的是join=’inner’选项。</p>
<p>你可以通过join_axes指定要在其它轴上使用的索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: pd.concat([s1, s4], axis=<span class="hljs-number">1</span>, join_axes=[[<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'e'</span>]])</span><br><span class="line">Out[<span class="hljs-number">91</span>]: </span><br><span class="line">     <span class="hljs-number">0</span>    <span class="hljs-number">1</span></span><br><span class="line">a  <span class="hljs-number">0.0</span>  <span class="hljs-number">0.0</span></span><br><span class="line">c  NaN  NaN</span><br><span class="line">b  <span class="hljs-number">1.0</span>  <span class="hljs-number">1.0</span></span><br><span class="line">e  NaN  NaN</span><br></pre></td></tr></table></figure>

<p>不过有个问题，参与连接的片段在结果中区分不开。假设你想要在连接轴上创建一个层次化索引。使用keys参数即可达到这个目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">92</span>]: result = pd.concat([s1, s1, s3], keys=[<span class="hljs-string">'one'</span>,<span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: result</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line">one    a    <span class="hljs-number">0</span></span><br><span class="line">       b    <span class="hljs-number">1</span></span><br><span class="line">two    a    <span class="hljs-number">0</span></span><br><span class="line">       b    <span class="hljs-number">1</span></span><br><span class="line">three  f    <span class="hljs-number">5</span></span><br><span class="line">       g    <span class="hljs-number">6</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">94</span>]: result.unstack()</span><br><span class="line">Out[<span class="hljs-number">94</span>]: </span><br><span class="line">         a    b    f    g</span><br><span class="line">one    <span class="hljs-number">0.0</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line">two    <span class="hljs-number">0.0</span>  <span class="hljs-number">1.0</span>  NaN  NaN</span><br><span class="line">three  NaN  NaN  <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>如果沿着axis=1对Series进行合并，则keys就会成为DataFrame的列头：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">95</span>]: pd.concat([s1, s2, s3], axis=<span class="hljs-number">1</span>, keys=[<span class="hljs-string">'one'</span>,<span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>])</span><br><span class="line">Out[<span class="hljs-number">95</span>]: </span><br><span class="line">   one  two  three</span><br><span class="line">a  <span class="hljs-number">0.0</span>  NaN    NaN</span><br><span class="line">b  <span class="hljs-number">1.0</span>  NaN    NaN</span><br><span class="line">c  NaN  <span class="hljs-number">2.0</span>    NaN</span><br><span class="line">d  NaN  <span class="hljs-number">3.0</span>    NaN</span><br><span class="line">e  NaN  <span class="hljs-number">4.0</span>    NaN</span><br><span class="line">f  NaN  NaN    <span class="hljs-number">5.0</span></span><br><span class="line">g  NaN  NaN    <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>同样的逻辑也适用于DataFrame对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: df1 = pd.DataFrame(np.arange(<span class="hljs-number">6</span>).reshape(<span class="hljs-number">3</span>, <span class="hljs-number">2</span>), index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">   ....:                    columns=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: df2 = pd.DataFrame(<span class="hljs-number">5</span> + np.arange(<span class="hljs-number">4</span>).reshape(<span class="hljs-number">2</span>, <span class="hljs-number">2</span>), index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">   ....:                    columns=[<span class="hljs-string">'three'</span>, <span class="hljs-string">'four'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">   one  two</span><br><span class="line">a    <span class="hljs-number">0</span>    <span class="hljs-number">1</span></span><br><span class="line">b    <span class="hljs-number">2</span>    <span class="hljs-number">3</span></span><br><span class="line">c    <span class="hljs-number">4</span>    <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">99</span>]: </span><br><span class="line">   three  four</span><br><span class="line">a      <span class="hljs-number">5</span>     <span class="hljs-number">6</span></span><br><span class="line">c      <span class="hljs-number">7</span>     <span class="hljs-number">8</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: pd.concat([df1, df2], axis=<span class="hljs-number">1</span>, keys=[<span class="hljs-string">'level1'</span>, <span class="hljs-string">'level2'</span>])</span><br><span class="line">Out[<span class="hljs-number">100</span>]: </span><br><span class="line">  level1     level2     </span><br><span class="line">     one two  three four</span><br><span class="line">a      <span class="hljs-number">0</span>   <span class="hljs-number">1</span>    <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line">b      <span class="hljs-number">2</span>   <span class="hljs-number">3</span>    NaN  NaN</span><br><span class="line">c      <span class="hljs-number">4</span>   <span class="hljs-number">5</span>    <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span></span><br></pre></td></tr></table></figure>

<p>如果传入的不是列表而是一个字典，则字典的键就会被当做keys选项的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: pd.concat(&#123;<span class="hljs-string">'level1'</span>: df1, <span class="hljs-string">'level2'</span>: df2&#125;, axis=<span class="hljs-number">1</span>)</span><br><span class="line"></span><br><span class="line">Out[<span class="hljs-number">101</span>]: </span><br><span class="line">  level1     level2     </span><br><span class="line">     one two  three four</span><br><span class="line">a      <span class="hljs-number">0</span>   <span class="hljs-number">1</span>    <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line">b      <span class="hljs-number">2</span>   <span class="hljs-number">3</span>    NaN  NaN</span><br><span class="line">c      <span class="hljs-number">4</span>   <span class="hljs-number">5</span>    <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span></span><br></pre></td></tr></table></figure>

<p>此外还有两个用于管理层次化索引创建方式的参数（参见表8-3）。举个例子，我们可以用names参数命名创建的轴级别：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">102</span>]: pd.concat([df1, df2], axis=<span class="hljs-number">1</span>, keys=[<span class="hljs-string">'level1'</span>, <span class="hljs-string">'level2'</span>],</span><br><span class="line">   .....:           names=[<span class="hljs-string">'upper'</span>, <span class="hljs-string">'lower'</span>])</span><br><span class="line">Out[<span class="hljs-number">102</span>]: </span><br><span class="line">upper level1     level2     </span><br><span class="line">lower    one two  three four</span><br><span class="line">a          <span class="hljs-number">0</span>   <span class="hljs-number">1</span>    <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line">b          <span class="hljs-number">2</span>   <span class="hljs-number">3</span>    NaN  NaN</span><br><span class="line">c          <span class="hljs-number">4</span>   <span class="hljs-number">5</span>    <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span></span><br></pre></td></tr></table></figure>

<p>最后一个关于DataFrame的问题是，DataFrame的行索引不包含任何相关数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">103</span>]: df1 = pd.DataFrame(np.random.randn(<span class="hljs-number">3</span>, <span class="hljs-number">4</span>), columns=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">104</span>]: df2 = pd.DataFrame(np.random.randn(<span class="hljs-number">2</span>, <span class="hljs-number">3</span>), columns=[<span class="hljs-string">'b'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'a'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">105</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">105</span>]: </span><br><span class="line">          a         b         c         d</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">1.007189</span> <span class="hljs-number">-1.296221</span>  <span class="hljs-number">0.274992</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">106</span>]: </span><br><span class="line">          b         d         a</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">0.476985</span>  <span class="hljs-number">3.248944</span> <span class="hljs-number">-1.021228</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">-0.577087</span>  <span class="hljs-number">0.124121</span>  <span class="hljs-number">0.302614</span></span><br></pre></td></tr></table></figure>

<p>在这种情况下，传入ignore_index=True即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">107</span>]: pd.concat([df1, df2], ignore_index=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">107</span>]: </span><br><span class="line">          a         b         c         d</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.246435</span>  <span class="hljs-number">1.007189</span> <span class="hljs-number">-1.296221</span>  <span class="hljs-number">0.274992</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.228913</span>  <span class="hljs-number">1.352917</span>  <span class="hljs-number">0.886429</span> <span class="hljs-number">-2.001637</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.371843</span>  <span class="hljs-number">1.669025</span> <span class="hljs-number">-0.438570</span> <span class="hljs-number">-0.539741</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-1.021228</span>  <span class="hljs-number">0.476985</span>       NaN  <span class="hljs-number">3.248944</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">0.302614</span> <span class="hljs-number">-0.577087</span>       NaN  <span class="hljs-number">0.124121</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-339436563b519415.webp" alt="img"></p>
<p>表8-3 concat函数的参数</p>
<h2 id="合并重叠数据"><a href="#合并重叠数据" class="headerlink" title="合并重叠数据"></a>合并重叠数据</h2><p>还有一种数据组合问题不能用简单的合并（merge）或连接（concatenation）运算来处理。比如说，你可能有索引全部或部分重叠的两个数据集。举个有启发性的例子，我们使用NumPy的where函数，它表示一种等价于面向数组的if-else：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: a = pd.Series([np.nan, <span class="hljs-number">2.5</span>, np.nan, <span class="hljs-number">3.5</span>, <span class="hljs-number">4.5</span>, np.nan],</span><br><span class="line">   .....:               index=[<span class="hljs-string">'f'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">109</span>]: b = pd.Series(np.arange(len(a), dtype=np.float64),</span><br><span class="line">   .....:               index=[<span class="hljs-string">'f'</span>, <span class="hljs-string">'e'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: b[<span class="hljs-number">-1</span>] = np.nan</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">111</span>]: a</span><br><span class="line">Out[<span class="hljs-number">111</span>]: </span><br><span class="line">f    NaN</span><br><span class="line">e    <span class="hljs-number">2.5</span></span><br><span class="line">d    NaN</span><br><span class="line">c    <span class="hljs-number">3.5</span></span><br><span class="line">b    <span class="hljs-number">4.5</span></span><br><span class="line">a    NaN</span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: b</span><br><span class="line">Out[<span class="hljs-number">112</span>]: </span><br><span class="line">f    <span class="hljs-number">0.0</span></span><br><span class="line">e    <span class="hljs-number">1.0</span></span><br><span class="line">d    <span class="hljs-number">2.0</span></span><br><span class="line">c    <span class="hljs-number">3.0</span></span><br><span class="line">b    <span class="hljs-number">4.0</span></span><br><span class="line">a    NaN</span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: np.where(pd.isnull(a), b, a)</span><br><span class="line">Out[<span class="hljs-number">113</span>]: array([ <span class="hljs-number">0.</span> ,  <span class="hljs-number">2.5</span>,  <span class="hljs-number">2.</span> ,  <span class="hljs-number">3.5</span>,  <span class="hljs-number">4.5</span>,  nan])</span><br></pre></td></tr></table></figure>

<p>Series有一个combine_first方法，实现的也是一样的功能，还带有pandas的数据对齐：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">114</span>]: b[:<span class="hljs-number">-2</span>].combine_first(a[<span class="hljs-number">2</span>:])</span><br><span class="line">Out[<span class="hljs-number">114</span>]: </span><br><span class="line">a    NaN</span><br><span class="line">b    <span class="hljs-number">4.5</span></span><br><span class="line">c    <span class="hljs-number">3.0</span></span><br><span class="line">d    <span class="hljs-number">2.0</span></span><br><span class="line">e    <span class="hljs-number">1.0</span></span><br><span class="line">f    <span class="hljs-number">0.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>对于DataFrame，combine_first自然也会在列上做同样的事情，因此你可以将其看做：用传递对象中的数据为调用对象的缺失数据“打补丁”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">115</span>]: df1 = pd.DataFrame(&#123;<span class="hljs-string">'a'</span>: [<span class="hljs-number">1.</span>, np.nan, <span class="hljs-number">5.</span>, np.nan],</span><br><span class="line">   .....:                     <span class="hljs-string">'b'</span>: [np.nan, <span class="hljs-number">2.</span>, np.nan, <span class="hljs-number">6.</span>],</span><br><span class="line">   .....:                     <span class="hljs-string">'c'</span>: range(<span class="hljs-number">2</span>, <span class="hljs-number">18</span>, <span class="hljs-number">4</span>)&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: df2 = pd.DataFrame(&#123;<span class="hljs-string">'a'</span>: [<span class="hljs-number">5.</span>, <span class="hljs-number">4.</span>, np.nan, <span class="hljs-number">3.</span>, <span class="hljs-number">7.</span>],</span><br><span class="line">   .....:                     <span class="hljs-string">'b'</span>: [np.nan, <span class="hljs-number">3.</span>, <span class="hljs-number">4.</span>, <span class="hljs-number">6.</span>, <span class="hljs-number">8.</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">117</span>]: df1</span><br><span class="line">Out[<span class="hljs-number">117</span>]: </span><br><span class="line">     a    b   c</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  NaN   <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">1</span>  NaN  <span class="hljs-number">2.0</span>   <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">5.0</span>  NaN  <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">3</span>  NaN  <span class="hljs-number">6.0</span>  <span class="hljs-number">14</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">118</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">118</span>]: </span><br><span class="line">     a    b</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">5.0</span>  NaN</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">4.0</span>  <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">2</span>  NaN  <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">3.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">119</span>]: df1.combine_first(df2)</span><br><span class="line">Out[<span class="hljs-number">119</span>]: </span><br><span class="line">     a    b     c</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  NaN   <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">4.0</span>  <span class="hljs-number">2.0</span>   <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">4.0</span>  <span class="hljs-number">10.0</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">3.0</span>  <span class="hljs-number">6.0</span>  <span class="hljs-number">14.0</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">7.0</span>  <span class="hljs-number">8.0</span>   NaN</span><br></pre></td></tr></table></figure>

<h1 id="8-3-重塑和轴向旋转"><a href="#8-3-重塑和轴向旋转" class="headerlink" title="8.3 重塑和轴向旋转"></a>8.3 重塑和轴向旋转</h1><p>有许多用于重新排列表格型数据的基础运算。这些函数也称作重塑（reshape）或轴向旋转（pivot）运算。</p>
<h2 id="重塑层次化索引"><a href="#重塑层次化索引" class="headerlink" title="重塑层次化索引"></a>重塑层次化索引</h2><p>层次化索引为DataFrame数据的重排任务提供了一种具有良好一致性的方式。主要功能有二：</p>
<ul>
<li>stack：将数据的列“旋转”为行。</li>
<li>unstack：将数据的行“旋转”为列。</li>
</ul>
<p>我将通过一系列的范例来讲解这些操作。接下来看一个简单的DataFrame，其中的行列索引均为字符串数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">120</span>]: data = pd.DataFrame(np.arange(<span class="hljs-number">6</span>).reshape((<span class="hljs-number">2</span>, <span class="hljs-number">3</span>)),</span><br><span class="line">   .....:                     index=pd.Index([<span class="hljs-string">'Ohio'</span>,<span class="hljs-string">'Colorado'</span>], name=<span class="hljs-string">'state'</span>),</span><br><span class="line">   .....:                     columns=pd.Index([<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>],</span><br><span class="line">   .....:                     name=<span class="hljs-string">'number'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">121</span>]: data</span><br><span class="line">Out[<span class="hljs-number">121</span>]: </span><br><span class="line">number    one  two  three</span><br><span class="line">state                    </span><br><span class="line">Ohio        <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span></span><br><span class="line">Colorado    <span class="hljs-number">3</span>    <span class="hljs-number">4</span>      <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>对该数据使用stack方法即可将列转换为行，得到一个Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">122</span>]: result = data.stack()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">123</span>]: result</span><br><span class="line">Out[<span class="hljs-number">123</span>]: </span><br><span class="line">state     number</span><br><span class="line">Ohio      one       <span class="hljs-number">0</span></span><br><span class="line">          two       <span class="hljs-number">1</span></span><br><span class="line">          three     <span class="hljs-number">2</span></span><br><span class="line">Colorado  one       <span class="hljs-number">3</span></span><br><span class="line">          two       <span class="hljs-number">4</span></span><br><span class="line">          three     <span class="hljs-number">5</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>对于一个层次化索引的Series，你可以用unstack将其重排为一个DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">124</span>]: result.unstack()</span><br><span class="line">Out[<span class="hljs-number">124</span>]: </span><br><span class="line">number    one  two  three</span><br><span class="line">state                    </span><br><span class="line">Ohio        <span class="hljs-number">0</span>    <span class="hljs-number">1</span>      <span class="hljs-number">2</span></span><br><span class="line">Colorado    <span class="hljs-number">3</span>    <span class="hljs-number">4</span>      <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>默认情况下，unstack操作的是最内层（stack也是如此）。传入分层级别的编号或名称即可对其它级别进行unstack操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">125</span>]: result.unstack(<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">125</span>]: </span><br><span class="line">state   Ohio  Colorado</span><br><span class="line">number                </span><br><span class="line">one        <span class="hljs-number">0</span>         <span class="hljs-number">3</span></span><br><span class="line">two        <span class="hljs-number">1</span>         <span class="hljs-number">4</span></span><br><span class="line">three      <span class="hljs-number">2</span>         <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">126</span>]: result.unstack(<span class="hljs-string">'state'</span>)</span><br><span class="line">Out[<span class="hljs-number">126</span>]: </span><br><span class="line">state   Ohio  Colorado</span><br><span class="line">number                </span><br><span class="line">one        <span class="hljs-number">0</span>         <span class="hljs-number">3</span></span><br><span class="line">two        <span class="hljs-number">1</span>         <span class="hljs-number">4</span></span><br><span class="line">three      <span class="hljs-number">2</span>         <span class="hljs-number">5</span></span><br></pre></td></tr></table></figure>

<p>如果不是所有的级别值都能在各分组中找到的话，则unstack操作可能会引入缺失数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">127</span>]: s1 = pd.Series([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>], index=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">128</span>]: s2 = pd.Series([<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>], index=[<span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">129</span>]: data2 = pd.concat([s1, s2], keys=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">130</span>]: data2</span><br><span class="line">Out[<span class="hljs-number">130</span>]: </span><br><span class="line">one  a    <span class="hljs-number">0</span></span><br><span class="line">     b    <span class="hljs-number">1</span></span><br><span class="line">     c    <span class="hljs-number">2</span></span><br><span class="line">     d    <span class="hljs-number">3</span></span><br><span class="line">two  c    <span class="hljs-number">4</span></span><br><span class="line">     d    <span class="hljs-number">5</span></span><br><span class="line">     e    <span class="hljs-number">6</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">131</span>]: data2.unstack()</span><br><span class="line">Out[<span class="hljs-number">131</span>]: </span><br><span class="line">       a    b    c    d    e</span><br><span class="line">one  <span class="hljs-number">0.0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">2.0</span>  <span class="hljs-number">3.0</span>  NaN</span><br><span class="line">two  NaN  NaN  <span class="hljs-number">4.0</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br></pre></td></tr></table></figure>

<p>stack默认会滤除缺失数据，因此该运算是可逆的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">132</span>]: data2.unstack()</span><br><span class="line">Out[<span class="hljs-number">132</span>]: </span><br><span class="line">       a    b    c    d    e</span><br><span class="line">one  <span class="hljs-number">0.0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">2.0</span>  <span class="hljs-number">3.0</span>  NaN</span><br><span class="line">two  NaN  NaN  <span class="hljs-number">4.0</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">6.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">133</span>]: data2.unstack().stack()</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">one  a    <span class="hljs-number">0.0</span></span><br><span class="line">     b    <span class="hljs-number">1.0</span></span><br><span class="line">     c    <span class="hljs-number">2.0</span></span><br><span class="line">     d    <span class="hljs-number">3.0</span></span><br><span class="line">two  c    <span class="hljs-number">4.0</span></span><br><span class="line">     d    <span class="hljs-number">5.0</span></span><br><span class="line">     e    <span class="hljs-number">6.0</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: data2.unstack().stack(dropna=<span class="hljs-literal">False</span>)</span><br><span class="line">Out[<span class="hljs-number">134</span>]: </span><br><span class="line">one  a    <span class="hljs-number">0.0</span></span><br><span class="line">     b    <span class="hljs-number">1.0</span></span><br><span class="line">     c    <span class="hljs-number">2.0</span></span><br><span class="line">     d    <span class="hljs-number">3.0</span></span><br><span class="line">     e    NaN</span><br><span class="line">two  a    NaN</span><br><span class="line">     b    NaN</span><br><span class="line">     c    <span class="hljs-number">4.0</span></span><br><span class="line">     d    <span class="hljs-number">5.0</span></span><br><span class="line">     e    <span class="hljs-number">6.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>在对DataFrame进行unstack操作时，作为旋转轴的级别将会成为结果中的最低级别：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">135</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'left'</span>: result, <span class="hljs-string">'right'</span>: result + <span class="hljs-number">5</span>&#125;,</span><br><span class="line">   .....:                   columns=pd.Index([<span class="hljs-string">'left'</span>, <span class="hljs-string">'right'</span>], name=<span class="hljs-string">'side'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">136</span>]: df</span><br><span class="line">Out[<span class="hljs-number">136</span>]: </span><br><span class="line">side             left  right</span><br><span class="line">state    number             </span><br><span class="line">Ohio     one        <span class="hljs-number">0</span>      <span class="hljs-number">5</span></span><br><span class="line">         two        <span class="hljs-number">1</span>      <span class="hljs-number">6</span></span><br><span class="line">         three      <span class="hljs-number">2</span>      <span class="hljs-number">7</span></span><br><span class="line">Colorado one        <span class="hljs-number">3</span>      <span class="hljs-number">8</span></span><br><span class="line">         two        <span class="hljs-number">4</span>      <span class="hljs-number">9</span></span><br><span class="line">         three      <span class="hljs-number">5</span>     <span class="hljs-number">10</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: df.unstack(<span class="hljs-string">'state'</span>)</span><br><span class="line">Out[<span class="hljs-number">137</span>]: </span><br><span class="line">side   left          right</span><br><span class="line">state  Ohio Colorado  Ohio Colorado</span><br><span class="line">number                             </span><br><span class="line">one       <span class="hljs-number">0</span>        <span class="hljs-number">3</span>     <span class="hljs-number">5</span>        <span class="hljs-number">8</span></span><br><span class="line">two       <span class="hljs-number">1</span>        <span class="hljs-number">4</span>     <span class="hljs-number">6</span>        <span class="hljs-number">9</span></span><br><span class="line">three     <span class="hljs-number">2</span>        <span class="hljs-number">5</span>     <span class="hljs-number">7</span>       <span class="hljs-number">10</span></span><br></pre></td></tr></table></figure>

<p>当调用stack，我们可以指明轴的名字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">138</span>]: df.unstack(<span class="hljs-string">'state'</span>).stack(<span class="hljs-string">'side'</span>)</span><br><span class="line">Out[<span class="hljs-number">138</span>]: </span><br><span class="line">state         Colorado  Ohio</span><br><span class="line">number side                 </span><br><span class="line">one    left          <span class="hljs-number">3</span>     <span class="hljs-number">0</span></span><br><span class="line">       right         <span class="hljs-number">8</span>     <span class="hljs-number">5</span></span><br><span class="line">two    left          <span class="hljs-number">4</span>     <span class="hljs-number">1</span></span><br><span class="line">       right         <span class="hljs-number">9</span>     <span class="hljs-number">6</span></span><br><span class="line">three  left          <span class="hljs-number">5</span>     <span class="hljs-number">2</span></span><br><span class="line">       right        <span class="hljs-number">10</span>     <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<h2 id="将“长格式”旋转为“宽格式”"><a href="#将“长格式”旋转为“宽格式”" class="headerlink" title="将“长格式”旋转为“宽格式”"></a>将“长格式”旋转为“宽格式”</h2><p>多个时间序列数据通常是以所谓的“长格式”（long）或“堆叠格式”（stacked）存储在数据库和CSV中的。我们先加载一些示例数据，做一些时间序列规整和数据清洗：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">139</span>]: data = pd.read_csv(<span class="hljs-string">'examples/macrodata.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">140</span>]: data.head()</span><br><span class="line">Out[<span class="hljs-number">140</span>]: </span><br><span class="line">     year  quarter   realgdp  realcons  realinv  realgovt  realdpi    cpi  \</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">1.0</span>  <span class="hljs-number">2710.349</span>    <span class="hljs-number">1707.4</span>  <span class="hljs-number">286.898</span>   <span class="hljs-number">470.045</span>   <span class="hljs-number">1886.9</span>  <span class="hljs-number">28.98</span>   </span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">2.0</span>  <span class="hljs-number">2778.801</span>    <span class="hljs-number">1733.7</span>  <span class="hljs-number">310.859</span>   <span class="hljs-number">481.301</span>   <span class="hljs-number">1919.7</span>  <span class="hljs-number">29.15</span>   </span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">3.0</span>  <span class="hljs-number">2775.488</span>    <span class="hljs-number">1751.8</span>  <span class="hljs-number">289.226</span>   <span class="hljs-number">491.260</span>   <span class="hljs-number">1916.4</span>  <span class="hljs-number">29.35</span>   </span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">4.0</span>  <span class="hljs-number">2785.204</span>    <span class="hljs-number">1753.7</span>  <span class="hljs-number">299.356</span>   <span class="hljs-number">484.052</span>   <span class="hljs-number">1931.3</span>  <span class="hljs-number">29.37</span>   </span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1960.0</span>      <span class="hljs-number">1.0</span>  <span class="hljs-number">2847.699</span>    <span class="hljs-number">1770.5</span>  <span class="hljs-number">331.722</span>   <span class="hljs-number">462.199</span>   <span class="hljs-number">1955.5</span>  <span class="hljs-number">29.54</span>   </span><br><span class="line">      m1  tbilrate  unemp      pop  infl  realint  </span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">139.7</span>      <span class="hljs-number">2.82</span>    <span class="hljs-number">5.8</span>  <span class="hljs-number">177.146</span>  <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">141.7</span>      <span class="hljs-number">3.08</span>    <span class="hljs-number">5.1</span>  <span class="hljs-number">177.830</span>  <span class="hljs-number">2.34</span>     <span class="hljs-number">0.74</span>  </span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">140.5</span>      <span class="hljs-number">3.82</span>    <span class="hljs-number">5.3</span>  <span class="hljs-number">178.657</span>  <span class="hljs-number">2.74</span>     <span class="hljs-number">1.09</span>  </span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">140.0</span>      <span class="hljs-number">4.33</span>    <span class="hljs-number">5.6</span>  <span class="hljs-number">179.386</span>  <span class="hljs-number">0.27</span>     <span class="hljs-number">4.06</span>  </span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">139.6</span>      <span class="hljs-number">3.50</span>    <span class="hljs-number">5.2</span>  <span class="hljs-number">180.007</span>  <span class="hljs-number">2.31</span>     <span class="hljs-number">1.19</span>  </span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">141</span>]: periods = pd.PeriodIndex(year=data.year, quarter=data.quarter,</span><br><span class="line">   .....:                          name=<span class="hljs-string">'date'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">142</span>]: columns = pd.Index([<span class="hljs-string">'realgdp'</span>, <span class="hljs-string">'infl'</span>, <span class="hljs-string">'unemp'</span>], name=<span class="hljs-string">'item'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">143</span>]: data = data.reindex(columns=columns)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">144</span>]: data.index = periods.to_timestamp(<span class="hljs-string">'D'</span>, <span class="hljs-string">'end'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">145</span>]: ldata = data.stack().reset_index().rename(columns=&#123;<span class="hljs-number">0</span>: <span class="hljs-string">'value'</span>&#125;)</span><br></pre></td></tr></table></figure>

<p>这就是多个时间序列（或者其它带有两个或多个键的可观察数据，这里，我们的键是date和item）的长格式。表中的每行代表一次观察。</p>
<p>关系型数据库（如MySQL）中的数据经常都是这样存储的，因为固定架构（即列名和数据类型）有一个好处：随着表中数据的添加，item列中的值的种类能够增加。在前面的例子中，date和item通常就是主键（用关系型数据库的说法），不仅提供了关系完整性，而且提供了更为简单的查询支持。有的情况下，使用这样的数据会很麻烦，你可能会更喜欢DataFrame，不同的item值分别形成一列，date列中的时间戳则用作索引。DataFrame的pivot方法完全可以实现这个转换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">147</span>]: pivoted = ldata.pivot(<span class="hljs-string">'date'</span>, <span class="hljs-string">'item'</span>, <span class="hljs-string">'value'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">148</span>]: pivoted</span><br><span class="line">Out[<span class="hljs-number">148</span>]: </span><br><span class="line">item        infl    realgdp  unemp</span><br><span class="line">date                              </span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.00</span>   <span class="hljs-number">2710.349</span>    <span class="hljs-number">5.8</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.34</span>   <span class="hljs-number">2778.801</span>    <span class="hljs-number">5.1</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.74</span>   <span class="hljs-number">2775.488</span>    <span class="hljs-number">5.3</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.27</span>   <span class="hljs-number">2785.204</span>    <span class="hljs-number">5.6</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.31</span>   <span class="hljs-number">2847.699</span>    <span class="hljs-number">5.2</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">0.14</span>   <span class="hljs-number">2834.390</span>    <span class="hljs-number">5.2</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.70</span>   <span class="hljs-number">2839.022</span>    <span class="hljs-number">5.6</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">1.21</span>   <span class="hljs-number">2802.616</span>    <span class="hljs-number">6.3</span></span><br><span class="line"><span class="hljs-number">1961</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span> <span class="hljs-number">-0.40</span>   <span class="hljs-number">2819.264</span>    <span class="hljs-number">6.8</span></span><br><span class="line"><span class="hljs-number">1961</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">1.47</span>   <span class="hljs-number">2872.005</span>    <span class="hljs-number">7.0</span></span><br><span class="line"><span class="hljs-meta">... </span>         ...        ...    ...</span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.75</span>  <span class="hljs-number">13203.977</span>    <span class="hljs-number">4.5</span></span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">3.45</span>  <span class="hljs-number">13321.109</span>    <span class="hljs-number">4.7</span></span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">6.38</span>  <span class="hljs-number">13391.249</span>    <span class="hljs-number">4.8</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.82</span>  <span class="hljs-number">13366.865</span>    <span class="hljs-number">4.9</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">8.53</span>  <span class="hljs-number">13415.266</span>    <span class="hljs-number">5.4</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span> <span class="hljs-number">-3.16</span>  <span class="hljs-number">13324.600</span>    <span class="hljs-number">6.0</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">-8.79</span>  <span class="hljs-number">13141.920</span>    <span class="hljs-number">6.9</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.94</span>  <span class="hljs-number">12925.410</span>    <span class="hljs-number">8.1</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">3.37</span>  <span class="hljs-number">12901.504</span>    <span class="hljs-number">9.2</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">3.56</span>  <span class="hljs-number">12990.341</span>    <span class="hljs-number">9.6</span></span><br><span class="line">[<span class="hljs-number">203</span> rows x <span class="hljs-number">3</span> columns]</span><br></pre></td></tr></table></figure>

<p>前两个传递的值分别用作行和列索引，最后一个可选值则是用于填充DataFrame的数据列。假设有两个需要同时重塑的数据列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">149</span>]: ldata[<span class="hljs-string">'value2'</span>] = np.random.randn(len(ldata))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">150</span>]: ldata[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">150</span>]: </span><br><span class="line">        date     item     value    value2</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  realgdp  <span class="hljs-number">2710.349</span>  <span class="hljs-number">0.523772</span></span><br><span class="line"><span class="hljs-number">1</span> <span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>     infl     <span class="hljs-number">0.000</span>  <span class="hljs-number">0.000940</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    unemp     <span class="hljs-number">5.800</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  realgdp  <span class="hljs-number">2778.801</span> <span class="hljs-number">-0.713544</span></span><br><span class="line"><span class="hljs-number">4</span> <span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>     infl     <span class="hljs-number">2.340</span> <span class="hljs-number">-0.831154</span></span><br><span class="line"><span class="hljs-number">5</span> <span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>    unemp     <span class="hljs-number">5.100</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">6</span> <span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  realgdp  <span class="hljs-number">2775.488</span> <span class="hljs-number">-1.860761</span></span><br><span class="line"><span class="hljs-number">7</span> <span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>     infl     <span class="hljs-number">2.740</span> <span class="hljs-number">-0.860757</span></span><br><span class="line"><span class="hljs-number">8</span> <span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>    unemp     <span class="hljs-number">5.300</span>  <span class="hljs-number">0.560145</span></span><br><span class="line"><span class="hljs-number">9</span> <span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  realgdp  <span class="hljs-number">2785.204</span> <span class="hljs-number">-1.265934</span></span><br></pre></td></tr></table></figure>

<p>如果忽略最后一个参数，得到的DataFrame就会带有层次化的列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">151</span>]: pivoted = ldata.pivot(<span class="hljs-string">'date'</span>, <span class="hljs-string">'item'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">152</span>]: pivoted[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">152</span>]: </span><br><span class="line">           value                    value2                    </span><br><span class="line">item        infl   realgdp unemp      infl   realgdp     unemp</span><br><span class="line">date                                                          </span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.00</span>  <span class="hljs-number">2710.349</span>   <span class="hljs-number">5.8</span>  <span class="hljs-number">0.000940</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.34</span>  <span class="hljs-number">2778.801</span>   <span class="hljs-number">5.1</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-0.713544</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.74</span>  <span class="hljs-number">2775.488</span>   <span class="hljs-number">5.3</span> <span class="hljs-number">-0.860757</span> <span class="hljs-number">-1.860761</span>  <span class="hljs-number">0.560145</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.27</span>  <span class="hljs-number">2785.204</span>   <span class="hljs-number">5.6</span>  <span class="hljs-number">0.119827</span> <span class="hljs-number">-1.265934</span> <span class="hljs-number">-1.063512</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.31</span>  <span class="hljs-number">2847.699</span>   <span class="hljs-number">5.2</span> <span class="hljs-number">-2.359419</span>  <span class="hljs-number">0.332883</span> <span class="hljs-number">-0.199543</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">153</span>]: pivoted[<span class="hljs-string">'value'</span>][:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">153</span>]: </span><br><span class="line">item        infl   realgdp  unemp</span><br><span class="line">date                             </span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.00</span>  <span class="hljs-number">2710.349</span>    <span class="hljs-number">5.8</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.34</span>  <span class="hljs-number">2778.801</span>    <span class="hljs-number">5.1</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.74</span>  <span class="hljs-number">2775.488</span>    <span class="hljs-number">5.3</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.27</span>  <span class="hljs-number">2785.204</span>    <span class="hljs-number">5.6</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.31</span>  <span class="hljs-number">2847.699</span>    <span class="hljs-number">5.2</span></span><br></pre></td></tr></table></figure>

<p>注意，pivot其实就是用set_index创建层次化索引，再用unstack重塑：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">154</span>]: unstacked = ldata.set_index([<span class="hljs-string">'date'</span>, <span class="hljs-string">'item'</span>]).unstack(<span class="hljs-string">'item'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">155</span>]: unstacked[:<span class="hljs-number">7</span>]</span><br><span class="line">Out[<span class="hljs-number">155</span>]: </span><br><span class="line">           value                    value2                    </span><br><span class="line">item        infl   realgdp unemp      infl   realgdp     unemp</span><br><span class="line">date                                                          </span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.00</span>  <span class="hljs-number">2710.349</span>   <span class="hljs-number">5.8</span>  <span class="hljs-number">0.000940</span>  <span class="hljs-number">0.523772</span>  <span class="hljs-number">1.343810</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.34</span>  <span class="hljs-number">2778.801</span>   <span class="hljs-number">5.1</span> <span class="hljs-number">-0.831154</span> <span class="hljs-number">-0.713544</span> <span class="hljs-number">-2.370232</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.74</span>  <span class="hljs-number">2775.488</span>   <span class="hljs-number">5.3</span> <span class="hljs-number">-0.860757</span> <span class="hljs-number">-1.860761</span>  <span class="hljs-number">0.560145</span></span><br><span class="line"><span class="hljs-number">1959</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>  <span class="hljs-number">0.27</span>  <span class="hljs-number">2785.204</span>   <span class="hljs-number">5.6</span>  <span class="hljs-number">0.119827</span> <span class="hljs-number">-1.265934</span> <span class="hljs-number">-1.063512</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>  <span class="hljs-number">2.31</span>  <span class="hljs-number">2847.699</span>   <span class="hljs-number">5.2</span> <span class="hljs-number">-2.359419</span>  <span class="hljs-number">0.332883</span> <span class="hljs-number">-0.199543</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>  <span class="hljs-number">0.14</span>  <span class="hljs-number">2834.390</span>   <span class="hljs-number">5.2</span> <span class="hljs-number">-0.970736</span> <span class="hljs-number">-1.541996</span> <span class="hljs-number">-1.307030</span></span><br><span class="line"><span class="hljs-number">1960</span><span class="hljs-number">-09</span><span class="hljs-number">-30</span>  <span class="hljs-number">2.70</span>  <span class="hljs-number">2839.022</span>   <span class="hljs-number">5.6</span>  <span class="hljs-number">0.377984</span>  <span class="hljs-number">0.286350</span> <span class="hljs-number">-0.753887</span></span><br></pre></td></tr></table></figure>

<h2 id="将“宽格式”旋转为“长格式”"><a href="#将“宽格式”旋转为“长格式”" class="headerlink" title="将“宽格式”旋转为“长格式”"></a>将“宽格式”旋转为“长格式”</h2><p>旋转DataFrame的逆运算是pandas.melt。它不是将一列转换到多个新的DataFrame，而是合并多个列成为一个，产生一个比输入长的DataFrame。看一个例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">157</span>]: df = pd.DataFrame(&#123;<span class="hljs-string">'key'</span>: [<span class="hljs-string">'foo'</span>, <span class="hljs-string">'bar'</span>, <span class="hljs-string">'baz'</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'A'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'B'</span>: [<span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>],</span><br><span class="line">   .....:                    <span class="hljs-string">'C'</span>: [<span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: df</span><br><span class="line">Out[<span class="hljs-number">158</span>]: </span><br><span class="line">   A  B  C  key</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">7</span>  foo</span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">8</span>  bar</span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">9</span>  baz</span><br></pre></td></tr></table></figure>

<p>key列可能是分组指标，其它的列是数据值。当使用pandas.melt，我们必须指明哪些列是分组指标。下面使用key作为唯一的分组指标：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">159</span>]: melted = pd.melt(df, [<span class="hljs-string">'key'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">160</span>]: melted</span><br><span class="line">Out[<span class="hljs-number">160</span>]: </span><br><span class="line">   key variable  value</span><br><span class="line"><span class="hljs-number">0</span>  foo        A      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>  bar        A      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>  baz        A      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>  foo        B      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">4</span>  bar        B      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">5</span>  baz        B      <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">6</span>  foo        C      <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">7</span>  bar        C      <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">8</span>  baz        C      <span class="hljs-number">9</span></span><br></pre></td></tr></table></figure>

<p>使用pivot，可以重塑回原来的样子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">161</span>]: reshaped = melted.pivot(<span class="hljs-string">'key'</span>, <span class="hljs-string">'variable'</span>, <span class="hljs-string">'value'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: reshaped</span><br><span class="line">Out[<span class="hljs-number">162</span>]: </span><br><span class="line">variable  A  B  C</span><br><span class="line">key              </span><br><span class="line">bar       <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">8</span></span><br><span class="line">baz       <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">9</span></span><br><span class="line">foo       <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<p>因为pivot的结果从列创建了一个索引，用作行标签，我们可以使用reset_index将数据移回列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">163</span>]: reshaped.reset_index()</span><br><span class="line">Out[<span class="hljs-number">163</span>]: </span><br><span class="line">variable  key  A  B  C</span><br><span class="line"><span class="hljs-number">0</span>         bar  <span class="hljs-number">2</span>  <span class="hljs-number">5</span>  <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">1</span>         baz  <span class="hljs-number">3</span>  <span class="hljs-number">6</span>  <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">2</span>         foo  <span class="hljs-number">1</span>  <span class="hljs-number">4</span>  <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<p>你还可以指定列的子集，作为值的列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">164</span>]: pd.melt(df, id_vars=[<span class="hljs-string">'key'</span>], value_vars=[<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>])</span><br><span class="line">Out[<span class="hljs-number">164</span>]: </span><br><span class="line">   key variable  value</span><br><span class="line"><span class="hljs-number">0</span>  foo        A      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>  bar        A      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>  baz        A      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>  foo        B      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">4</span>  bar        B      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">5</span>  baz        B      <span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<p>pandas.melt也可以不用分组指标：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">165</span>]: pd.melt(df, value_vars=[<span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>, <span class="hljs-string">'C'</span>])</span><br><span class="line">Out[<span class="hljs-number">165</span>]: </span><br><span class="line">  variable  value</span><br><span class="line"><span class="hljs-number">0</span>        A      <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">1</span>        A      <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2</span>        A      <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">3</span>        B      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">4</span>        B      <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">5</span>        B      <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">6</span>        C      <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">7</span>        C      <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">8</span>        C      <span class="hljs-number">9</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">166</span>]: pd.melt(df, value_vars=[<span class="hljs-string">'key'</span>, <span class="hljs-string">'A'</span>, <span class="hljs-string">'B'</span>])</span><br><span class="line">Out[<span class="hljs-number">166</span>]: </span><br><span class="line">  variable value</span><br><span class="line"><span class="hljs-number">0</span>      key   foo</span><br><span class="line"><span class="hljs-number">1</span>      key   bar</span><br><span class="line"><span class="hljs-number">2</span>      key   baz</span><br><span class="line"><span class="hljs-number">3</span>        A     <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">4</span>        A     <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">5</span>        A     <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">6</span>        B     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">7</span>        B     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">8</span>        B     <span class="hljs-number">6</span></span><br></pre></td></tr></table></figure>

<h1 id="8-4-总结"><a href="#8-4-总结" class="headerlink" title="8.4 总结"></a>8.4 总结</h1><p>现在你已经掌握了pandas数据导入、清洗、重塑，我们可以进一步学习matplotlib数据可视化。我们在稍后会回到pandas，学习更高级的分析。</p>

        </div>
        
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous">
            <a class="is-flex-grow has-text-black-ter" href="/">上一页</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/page/3/">下一页</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link has-text-black-ter" href="/">1</a></li>
            
            <li><a class="pagination-link is-current" href="/page/2/">2</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/3/">3</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/4/">4</a></li>
            
        </ul>
    </nav>
</div>
</div>
                        <!-- 修改 -->
    
    
    
    
    <div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
        
            
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar_tiger.jpg" alt="Lanhoo">
                    
                    
                    <p class="is-size-4 is-block">
                        Lanhoo
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Just do it!
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Shenzhen, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        38
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        2
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        17
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/gladall" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/gladall">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Weibo" href="https://weibo.com/gladall">
                
                <i class="fab fa-weibo"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
        
            

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://godweiyang.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">韦阳的博客</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">godweiyang.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://easyhexo.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Easy Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">easyhexo.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


        
            
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">
            <span class="level-start">
                <span class="level-item">数据分析</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">28</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">
            <span class="level-start">
                <span class="level-item">系统配置</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/SQL/" style="font-size: 15.71px;">SQL</a> <a href="/tags/arch/" style="font-size: 11.43px;">arch</a> <a href="/tags/excel/" style="font-size: 11.43px;">excel</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/icarus/" style="font-size: 10px;">icarus</a> <a href="/tags/jupyter/" style="font-size: 10px;">jupyter</a> <a href="/tags/linux/" style="font-size: 12.86px;">linux</a> <a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a> <a href="/tags/matplotlib/" style="font-size: 10px;">matplotlib</a> <a href="/tags/mysql/" style="font-size: 14.29px;">mysql</a> <a href="/tags/pandas/" style="font-size: 18.57px;">pandas</a> <a href="/tags/python/" style="font-size: 17.14px;">python</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/%E5%8D%8E%E5%AE%B9%E9%81%93/" style="font-size: 10px;">华容道</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" style="font-size: 20px;">数据分析</a> <a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 10px;">软件</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 12.86px;">配置</a>
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">18</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
        
            <div class="column-right-shadow is-hidden-widescreen is-sticky">
            
                
            
                
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-10T11:48:06.000Z">2019-11-10</time></div>
                    <a href="/2019/11/10/%E7%94%A8python%E5%86%99%E4%BA%86%E4%B8%80%E4%B8%AA%E8%A7%A3%E6%95%B0%E5%AD%97%E5%8D%8E%E5%AE%B9%E9%81%93%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A8%8B%E5%BA%8F/" class="has-link-black-ter is-size-6">用python写了一个解数字华容道游戏的程序</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-08T01:12:36.000Z">2019-11-08</time></div>
                    <a href="/2019/11/08/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%8C%89%E7%85%A7%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%87%AA%E5%8A%A8%E6%B1%87%E6%80%BB%E7%BB%9F%E8%AE%A1%E7%9A%84%E8%84%9A%E6%9C%AC/" class="has-link-black-ter is-size-6">分享一个按照模板文件格式自动汇总统计的脚本</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:53:33.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC4%E7%AB%A0%20NumPy%E5%9F%BA%E7%A1%80%EF%BC%9A%E6%95%B0%E7%BB%84%E5%92%8C%E7%9F%A2%E9%87%8F%E8%AE%A1%E7%AE%97/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第4章 NumPy基础：数组和矢量计算</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:52:29.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC3%E7%AB%A0%20Python%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%81%E5%87%BD%E6%95%B0%E5%92%8C%E6%96%87%E4%BB%B6/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第3章 Python的数据结构、函数和文件</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:51:17.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC2%E7%AB%A0%20Python%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80%EF%BC%8CIPython%E5%92%8CJupyter%20Notebooks/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第2章 Python语法基础，IPython和Jupyter Notebooks</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

            
            </div>
        
    </div>
    
    
    <!-- 粘贴的部分 -->
    
                        <!-- 修改 -->
    
    
    
    
    <div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right is-sticky">
        
            
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-10T11:48:06.000Z">2019-11-10</time></div>
                    <a href="/2019/11/10/%E7%94%A8python%E5%86%99%E4%BA%86%E4%B8%80%E4%B8%AA%E8%A7%A3%E6%95%B0%E5%AD%97%E5%8D%8E%E5%AE%B9%E9%81%93%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A8%8B%E5%BA%8F/" class="has-link-black-ter is-size-6">用python写了一个解数字华容道游戏的程序</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-08T01:12:36.000Z">2019-11-08</time></div>
                    <a href="/2019/11/08/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%8C%89%E7%85%A7%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%87%AA%E5%8A%A8%E6%B1%87%E6%80%BB%E7%BB%9F%E8%AE%A1%E7%9A%84%E8%84%9A%E6%9C%AC/" class="has-link-black-ter is-size-6">分享一个按照模板文件格式自动汇总统计的脚本</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:53:33.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC4%E7%AB%A0%20NumPy%E5%9F%BA%E7%A1%80%EF%BC%9A%E6%95%B0%E7%BB%84%E5%92%8C%E7%9F%A2%E9%87%8F%E8%AE%A1%E7%AE%97/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第4章 NumPy基础：数组和矢量计算</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:52:29.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC3%E7%AB%A0%20Python%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%81%E5%87%BD%E6%95%B0%E5%92%8C%E6%96%87%E4%BB%B6/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第3章 Python的数据结构、函数和文件</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:51:17.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC2%E7%AB%A0%20Python%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80%EF%BC%8CIPython%E5%92%8CJupyter%20Notebooks/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第2章 Python语法基础，IPython和Jupyter Notebooks</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
        
    </div>
    
    
    <!-- 粘贴的部分 -->
    
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/grid.svg" alt="Lanhoo&#39;s blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Lanhoo&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;" target="_blank" rel="noopener">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

<script>
// [].slice.call(document.querySelectorAll('table')).forEach(function(el){
//     var wrapper = document.createElement('div');
//     wrapper.className = 'table-area';
//     el.parentNode.insertBefore(wrapper, el);
//     el.parentNode.removeChild(el);
//     wrapper.appendChild(el);
// })
// 这是给真正的表格添加样式
$(".content > table").wrap("<div class='table-area'></div>");
$("table.dataframe").wrap("<div class='table-area'></div>");
</script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>