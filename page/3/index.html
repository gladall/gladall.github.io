<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>Lanhoo&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="description9">
<meta property="og:type" content="website">
<meta property="og:title" content="Lanhoo&#39;s blog">
<meta property="og:url" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;page&#x2F;3&#x2F;index.html">
<meta property="og:site_name" content="Lanhoo&#39;s blog">
<meta property="og:description" content="description9">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;images&#x2F;og_image.png">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;images&#x2F;og_image.png">







<link rel="icon" href="/images/grid32.ico">


<!-- 添加用户的样式，用来修改表格样式 -->
<!-- 效果不好，代码块也是表格，把代码块也变了 -->
<link rel="stylesheet" href="/css/user2.css" media="screen" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146455672-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146455672-1');
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="Lanhoo's blog" type="application/atom+xml">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/grid.svg" alt="Lanhoo&#39;s blog" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;" target="_blank" rel="noopener">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <!-- 将main_column_class() 改为 col() -->
                <div class="column is-8-tablet is-8-desktop is-6-widescreen has-order-2 column-main">
    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 11204 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC14%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%A1%88%E4%BE%8B/">《利用Python进行数据分析·第2版》第14章 数据分析案例</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">第11章 时间序列</a>
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
第14章 数据分析案例
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>本书正文的最后一章，我们来看一些真实世界的数据集。对于每个数据集，我们会用之前介绍的方法，从原始数据中提取有意义的内容。展示的方法适用于其它数据集，也包括你的。本章包含了一些各种各样的案例数据集，可以用来练习。</p>
<p>案例数据集可以在Github仓库找到，见第一章。</p>
<h1 id="14-1-来自Bitly的USA-gov数据"><a href="#14-1-来自Bitly的USA-gov数据" class="headerlink" title="14.1 来自Bitly的USA.gov数据"></a>14.1 来自Bitly的USA.gov数据</h1><p>2011年，URL缩短服务Bitly跟美国政府网站USA.gov合作，提供了一份从生成.gov或.mil短链接的用户那里收集来的匿名数据。在2011年，除实时数据之外，还可以下载文本文件形式的每小时快照。写作此书时（2017年），这项服务已经关闭，但我们保存一份数据用于本书的案例。</p>
<p>以每小时快照为例，文件中各行的格式为JSON（即JavaScript Object Notation，这是一种常用的Web数据格式）。例如，如果我们只读取某个文件中的第一行，那么所看到的结果应该是下面这样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">5</span>]: path = <span class="hljs-string">'datasets/bitly_usagov/example.txt'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">6</span>]: open(path).readline()</span><br><span class="line">Out[<span class="hljs-number">6</span>]: <span class="hljs-string">'&#123; "a": "Mozilla\\/5.0 (Windows NT 6.1; WOW64) AppleWebKit\\/535.11</span></span><br><span class="line"><span class="hljs-string">(KHTML, like Gecko) Chrome\\/17.0.963.78 Safari\\/535.11", "c": "US", "nk": 1,</span></span><br><span class="line"><span class="hljs-string">"tz": "America\\/New_York", "gr": "MA", "g": "A6qOVH", "h": "wfLQtf", "l":</span></span><br><span class="line"><span class="hljs-string">"orofrog", "al": "en-US,en;q=0.8", "hh": "1.usa.gov", "r":</span></span><br><span class="line"><span class="hljs-string">"http:\\/\\/www.facebook.com\\/l\\/7AQEFzjSi\\/1.usa.gov\\/wfLQtf", "u":</span></span><br><span class="line"><span class="hljs-string">"http:\\/\\/www.ncbi.nlm.nih.gov\\/pubmed\\/22415991", "t": 1331923247, "hc":</span></span><br><span class="line"><span class="hljs-string">1331822918, "cy": "Danvers", "ll": [ 42.576698, -70.954903 ] &#125;\n'</span></span><br></pre></td></tr></table></figure>

<p>Python有内置或第三方模块可以将JSON字符串转换成Python字典对象。这里，我将使用json模块及其loads函数逐行加载已经下载好的数据文件：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> json</span><br><span class="line">path = <span class="hljs-string">'datasets/bitly_usagov/example.txt'</span></span><br><span class="line">records = [json.loads(line) <span class="hljs-keyword">for</span> line <span class="hljs-keyword">in</span> open(path)]</span><br></pre></td></tr></table></figure>

<p>现在，records对象就成为一组Python字典了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: records[<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">18</span>]:</span><br><span class="line">&#123;<span class="hljs-string">'a'</span>: <span class="hljs-string">'Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko)</span></span><br><span class="line"><span class="hljs-string">Chrome/17.0.963.78 Safari/535.11'</span>,</span><br><span class="line"> <span class="hljs-string">'al'</span>: <span class="hljs-string">'en-US,en;q=0.8'</span>,</span><br><span class="line"> <span class="hljs-string">'c'</span>: <span class="hljs-string">'US'</span>,</span><br><span class="line"> <span class="hljs-string">'cy'</span>: <span class="hljs-string">'Danvers'</span>,</span><br><span class="line"> <span class="hljs-string">'g'</span>: <span class="hljs-string">'A6qOVH'</span>,</span><br><span class="line"> <span class="hljs-string">'gr'</span>: <span class="hljs-string">'MA'</span>,</span><br><span class="line"> <span class="hljs-string">'h'</span>: <span class="hljs-string">'wfLQtf'</span>,</span><br><span class="line"> <span class="hljs-string">'hc'</span>: <span class="hljs-number">1331822918</span>,</span><br><span class="line"> <span class="hljs-string">'hh'</span>: <span class="hljs-string">'1.usa.gov'</span>,</span><br><span class="line"> <span class="hljs-string">'l'</span>: <span class="hljs-string">'orofrog'</span>,</span><br><span class="line"> <span class="hljs-string">'ll'</span>: [<span class="hljs-number">42.576698</span>, <span class="hljs-number">-70.954903</span>],</span><br><span class="line"> <span class="hljs-string">'nk'</span>: <span class="hljs-number">1</span>,</span><br><span class="line"> <span class="hljs-string">'r'</span>: <span class="hljs-string">'http://www.facebook.com/l/7AQEFzjSi/1.usa.gov/wfLQtf'</span>,</span><br><span class="line"> <span class="hljs-string">'t'</span>: <span class="hljs-number">1331923247</span>,</span><br><span class="line"> <span class="hljs-string">'tz'</span>: <span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'u'</span>: <span class="hljs-string">'http://www.ncbi.nlm.nih.gov/pubmed/22415991'</span>&#125;</span><br></pre></td></tr></table></figure>

<h2 id="用纯Python代码对时区进行计数"><a href="#用纯Python代码对时区进行计数" class="headerlink" title="用纯Python代码对时区进行计数"></a>用纯Python代码对时区进行计数</h2><p>假设我们想要知道该数据集中最常出现的是哪个时区（即tz字段），得到答案的办法有很多。首先，我们用列表推导式取出一组时区：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">12</span>]: time_zones = [rec[<span class="hljs-string">'tz'</span>] <span class="hljs-keyword">for</span> rec <span class="hljs-keyword">in</span> records]</span><br><span class="line">---------------------------------------------------------------------------</span><br><span class="line">KeyError                                  Traceback (most recent call last)</span><br><span class="line">&lt;ipython-input<span class="hljs-number">-12</span>-db4fbd348da9&gt; <span class="hljs-keyword">in</span> &lt;module&gt;()</span><br><span class="line">----&gt; 1 time_zones = [rec['tz'] for rec in records]</span><br><span class="line">&lt;ipython-input<span class="hljs-number">-12</span>-db4fbd348da9&gt; <span class="hljs-keyword">in</span> &lt;listcomp&gt;(<span class="hljs-number">.0</span>)</span><br><span class="line">----&gt; 1 time_zones = [rec['tz'] for rec in records]</span><br><span class="line">KeyError: <span class="hljs-string">'tz'</span></span><br></pre></td></tr></table></figure>

<p>晕！原来并不是所有记录都有时区字段。这个好办，只需在列表推导式末尾加上一个if ‘tz’in rec判断即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">13</span>]: time_zones = [rec[<span class="hljs-string">'tz'</span>] <span class="hljs-keyword">for</span> rec <span class="hljs-keyword">in</span> records <span class="hljs-keyword">if</span> <span class="hljs-string">'tz'</span> <span class="hljs-keyword">in</span> rec]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: time_zones[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">14</span>]: </span><br><span class="line">[<span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'America/Denver'</span>,</span><br><span class="line"> <span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'America/Sao_Paulo'</span>,</span><br><span class="line"> <span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'America/New_York'</span>,</span><br><span class="line"> <span class="hljs-string">'Europe/Warsaw'</span>,</span><br><span class="line"> <span class="hljs-string">''</span>,</span><br><span class="line"> <span class="hljs-string">''</span>,</span><br><span class="line"> <span class="hljs-string">''</span>]</span><br></pre></td></tr></table></figure>

<p>只看前10个时区，我们发现有些是未知的（即空的）。虽然可以将它们过滤掉，但现在暂时先留着。接下来，为了对时区进行计数，这里介绍两个办法：一个较难（只使用标准Python库），另一个较简单（使用pandas）。计数的办法之一是在遍历时区的过程中将计数值保存在字典中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_counts</span><span class="hljs-params">(sequence)</span>:</span></span><br><span class="line">    counts = &#123;&#125;</span><br><span class="line">    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> sequence:</span><br><span class="line">        <span class="hljs-keyword">if</span> x <span class="hljs-keyword">in</span> counts:</span><br><span class="line">            counts[x] += <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-keyword">else</span>:</span><br><span class="line">            counts[x] = <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-keyword">return</span> counts</span><br></pre></td></tr></table></figure>

<p>如果使用Python标准库的更高级工具，那么你可能会将代码写得更简洁一些：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> defaultdict</span><br><span class="line"></span><br><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_counts2</span><span class="hljs-params">(sequence)</span>:</span></span><br><span class="line">    counts = defaultdict(int) <span class="hljs-comment"># values will initialize to 0</span></span><br><span class="line">    <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> sequence:</span><br><span class="line">        counts[x] += <span class="hljs-number">1</span></span><br><span class="line">    <span class="hljs-keyword">return</span> counts</span><br></pre></td></tr></table></figure>

<p>我将逻辑写到函数中是为了获得更高的复用性。要用它对时区进行处理，只需将time_zones传入即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">17</span>]: counts = get_counts(time_zones)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">18</span>]: counts[<span class="hljs-string">'America/New_York'</span>]</span><br><span class="line">Out[<span class="hljs-number">18</span>]: <span class="hljs-number">1251</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: len(time_zones)</span><br><span class="line">Out[<span class="hljs-number">19</span>]: <span class="hljs-number">3440</span></span><br></pre></td></tr></table></figure>

<p>如果想要得到前10位的时区及其计数值，我们需要用到一些有关字典的处理技巧：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">top_counts</span><span class="hljs-params">(count_dict, n=<span class="hljs-number">10</span>)</span>:</span></span><br><span class="line">    value_key_pairs = [(count, tz) <span class="hljs-keyword">for</span> tz, count <span class="hljs-keyword">in</span> count_dict.items()]</span><br><span class="line">    value_key_pairs.sort()</span><br><span class="line">    <span class="hljs-keyword">return</span> value_key_pairs[-n:]</span><br></pre></td></tr></table></figure>

<p>然后有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">21</span>]: top_counts(counts)</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">[(<span class="hljs-number">33</span>, <span class="hljs-string">'America/Sao_Paulo'</span>),</span><br><span class="line"> (<span class="hljs-number">35</span>, <span class="hljs-string">'Europe/Madrid'</span>),</span><br><span class="line">(<span class="hljs-number">36</span>, <span class="hljs-string">'Pacific/Honolulu'</span>),</span><br><span class="line"> (<span class="hljs-number">37</span>, <span class="hljs-string">'Asia/Tokyo'</span>),</span><br><span class="line"> (<span class="hljs-number">74</span>, <span class="hljs-string">'Europe/London'</span>),</span><br><span class="line"> (<span class="hljs-number">191</span>, <span class="hljs-string">'America/Denver'</span>),</span><br><span class="line"> (<span class="hljs-number">382</span>, <span class="hljs-string">'America/Los_Angeles'</span>),</span><br><span class="line"> (<span class="hljs-number">400</span>, <span class="hljs-string">'America/Chicago'</span>),</span><br><span class="line"> (<span class="hljs-number">521</span>, <span class="hljs-string">''</span>),</span><br><span class="line"> (<span class="hljs-number">1251</span>, <span class="hljs-string">'America/New_York'</span>)]</span><br></pre></td></tr></table></figure>

<p>如果你搜索Python的标准库，你能找到collections.Counter类，它可以使这项工作更简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">22</span>]: <span class="hljs-keyword">from</span> collections <span class="hljs-keyword">import</span> Counter</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: counts = Counter(time_zones)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">24</span>]: counts.most_common(<span class="hljs-number">10</span>)</span><br><span class="line">Out[<span class="hljs-number">24</span>]: </span><br><span class="line">[(<span class="hljs-string">'America/New_York'</span>, <span class="hljs-number">1251</span>),</span><br><span class="line"> (<span class="hljs-string">''</span>, <span class="hljs-number">521</span>),</span><br><span class="line"> (<span class="hljs-string">'America/Chicago'</span>, <span class="hljs-number">400</span>),</span><br><span class="line"> (<span class="hljs-string">'America/Los_Angeles'</span>, <span class="hljs-number">382</span>),</span><br><span class="line"> (<span class="hljs-string">'America/Denver'</span>, <span class="hljs-number">191</span>),</span><br><span class="line"> (<span class="hljs-string">'Europe/London'</span>, <span class="hljs-number">74</span>),</span><br><span class="line"> (<span class="hljs-string">'Asia/Tokyo'</span>, <span class="hljs-number">37</span>),</span><br><span class="line"> (<span class="hljs-string">'Pacific/Honolulu'</span>, <span class="hljs-number">36</span>),</span><br><span class="line"> (<span class="hljs-string">'Europe/Madrid'</span>, <span class="hljs-number">35</span>),</span><br><span class="line"> (<span class="hljs-string">'America/Sao_Paulo'</span>, <span class="hljs-number">33</span>)]</span><br></pre></td></tr></table></figure>

<h2 id="用pandas对时区进行计数"><a href="#用pandas对时区进行计数" class="headerlink" title="用pandas对时区进行计数"></a>用pandas对时区进行计数</h2><p>从原始记录的集合创建DateFrame，与将记录列表传递到pandas.DataFrame一样简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">26</span>]: frame = pd.DataFrame(records)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: frame.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">RangeIndex</span>:</span> <span class="hljs-number">3560</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">3559</span></span><br><span class="line">Data columns (total <span class="hljs-number">18</span> columns):</span><br><span class="line">_heartbeat_    <span class="hljs-number">120</span> non-null float64</span><br><span class="line">a              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">al             <span class="hljs-number">3094</span> non-null object</span><br><span class="line">c              <span class="hljs-number">2919</span> non-null object</span><br><span class="line">cy             <span class="hljs-number">2919</span> non-null object</span><br><span class="line">g              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">gr             <span class="hljs-number">2919</span> non-null object</span><br><span class="line">h              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">hc             <span class="hljs-number">3440</span> non-null float64</span><br><span class="line">hh             <span class="hljs-number">3440</span> non-null object</span><br><span class="line">kw             <span class="hljs-number">93</span> non-null object</span><br><span class="line">l              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">ll             <span class="hljs-number">2919</span> non-null object</span><br><span class="line">nk             <span class="hljs-number">3440</span> non-null float64</span><br><span class="line">r              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">t              <span class="hljs-number">3440</span> non-null float64</span><br><span class="line">tz             <span class="hljs-number">3440</span> non-null object</span><br><span class="line">u              <span class="hljs-number">3440</span> non-null object</span><br><span class="line">dtypes: float64(<span class="hljs-number">4</span>), object(<span class="hljs-number">14</span>)</span><br><span class="line">memory usage: <span class="hljs-number">500.7</span>+ KB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: frame[<span class="hljs-string">'tz'</span>][:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line"><span class="hljs-number">0</span>     America/New_York</span><br><span class="line"><span class="hljs-number">1</span>       America/Denver</span><br><span class="line"><span class="hljs-number">2</span>     America/New_York</span><br><span class="line"><span class="hljs-number">3</span>    America/Sao_Paulo</span><br><span class="line"><span class="hljs-number">4</span>     America/New_York</span><br><span class="line"><span class="hljs-number">5</span>     America/New_York</span><br><span class="line"><span class="hljs-number">6</span>        Europe/Warsaw</span><br><span class="line"><span class="hljs-number">7</span>                     </span><br><span class="line"><span class="hljs-number">8</span>                     </span><br><span class="line"><span class="hljs-number">9</span>                     </span><br><span class="line">Name: tz, dtype: object</span><br></pre></td></tr></table></figure>

<p>这里frame的输出形式是摘要视图（summary view），主要用于较大的DataFrame对象。我们然后可以对Series使用value_counts方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: tz_counts = frame[<span class="hljs-string">'tz'</span>].value_counts()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: tz_counts[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">America/New_York       <span class="hljs-number">1251</span></span><br><span class="line">                        <span class="hljs-number">521</span></span><br><span class="line">America/Chicago         <span class="hljs-number">400</span></span><br><span class="line">America/Los_Angeles     <span class="hljs-number">382</span></span><br><span class="line">America/Denver          <span class="hljs-number">191</span></span><br><span class="line">Europe/London            <span class="hljs-number">74</span></span><br><span class="line">Asia/Tokyo               <span class="hljs-number">37</span></span><br><span class="line">Pacific/Honolulu         <span class="hljs-number">36</span></span><br><span class="line">Europe/Madrid            <span class="hljs-number">35</span></span><br><span class="line">America/Sao_Paulo        <span class="hljs-number">33</span></span><br><span class="line">Name: tz, dtype: int64</span><br></pre></td></tr></table></figure>

<p>我们可以用matplotlib可视化这个数据。为此，我们先给记录中未知或缺失的时区填上一个替代值。fillna函数可以替换缺失值（NA），而未知值（空字符串）则可以通过布尔型数组索引加以替换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: clean_tz = frame[<span class="hljs-string">'tz'</span>].fillna(<span class="hljs-string">'Missing'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: clean_tz[clean_tz == <span class="hljs-string">''</span>] = <span class="hljs-string">'Unknown'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">33</span>]: tz_counts = clean_tz.value_counts()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: tz_counts[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">34</span>]: </span><br><span class="line">America/New_York       <span class="hljs-number">1251</span></span><br><span class="line">Unknown                 <span class="hljs-number">521</span></span><br><span class="line">America/Chicago         <span class="hljs-number">400</span></span><br><span class="line">America/Los_Angeles     <span class="hljs-number">382</span></span><br><span class="line">America/Denver          <span class="hljs-number">191</span></span><br><span class="line">Missing                 <span class="hljs-number">120</span></span><br><span class="line">Europe/London            <span class="hljs-number">74</span></span><br><span class="line">Asia/Tokyo               <span class="hljs-number">37</span></span><br><span class="line">Pacific/Honolulu         <span class="hljs-number">36</span></span><br><span class="line">Europe/Madrid            <span class="hljs-number">35</span></span><br><span class="line">Name: tz, dtype: int64</span><br></pre></td></tr></table></figure>

<p>此时，我们可以用seaborn包创建水平柱状图（结果见图14-1）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">36</span>]: <span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: subset = tz_counts[:<span class="hljs-number">10</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: sns.barplot(y=subset.index, x=subset.values)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-aa267c1d399a78f0.webp" alt="img"></p>
<p>图14-1 usa.gov示例数据中最常出现的时区</p>
<p>a字段含有执行URL短缩操作的浏览器、设备、应用程序的相关信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: frame[<span class="hljs-string">'a'</span>][<span class="hljs-number">1</span>]</span><br><span class="line">Out[<span class="hljs-number">39</span>]: <span class="hljs-string">'GoogleMaps/RochesterNY'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: frame[<span class="hljs-string">'a'</span>][<span class="hljs-number">50</span>]</span><br><span class="line">Out[<span class="hljs-number">40</span>]: <span class="hljs-string">'Mozilla/5.0 (Windows NT 5.1; rv:10.0.2)</span></span><br><span class="line"><span class="hljs-string">Gecko/20100101 Firefox/10.0.2'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: frame[<span class="hljs-string">'a'</span>][<span class="hljs-number">51</span>][:<span class="hljs-number">50</span>]  <span class="hljs-comment"># long line</span></span><br><span class="line">Out[<span class="hljs-number">41</span>]: <span class="hljs-string">'Mozilla/5.0 (Linux; U; Android 2.2.2; en-us; LG-P9'</span></span><br></pre></td></tr></table></figure>

<p>将这些”agent”字符串中的所有信息都解析出来是一件挺郁闷的工作。一种策略是将这种字符串的第一节（与浏览器大致对应）分离出来并得到另外一份用户行为摘要：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">42</span>]: results = pd.Series([x.split()[<span class="hljs-number">0</span>] <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> frame.a.dropna()])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: results[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line"><span class="hljs-number">0</span>               Mozilla/<span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">1</span>    GoogleMaps/RochesterNY</span><br><span class="line"><span class="hljs-number">2</span>               Mozilla/<span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">3</span>               Mozilla/<span class="hljs-number">5.0</span></span><br><span class="line"><span class="hljs-number">4</span>               Mozilla/<span class="hljs-number">5.0</span></span><br><span class="line">dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">44</span>]: results.value_counts()[:<span class="hljs-number">8</span>]</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line">Mozilla/<span class="hljs-number">5.0</span>                 <span class="hljs-number">2594</span></span><br><span class="line">Mozilla/<span class="hljs-number">4.0</span>                  <span class="hljs-number">601</span></span><br><span class="line">GoogleMaps/RochesterNY       <span class="hljs-number">121</span></span><br><span class="line">Opera/<span class="hljs-number">9.80</span>                    <span class="hljs-number">34</span></span><br><span class="line">TEST_INTERNET_AGENT           <span class="hljs-number">24</span></span><br><span class="line">GoogleProducer                <span class="hljs-number">21</span></span><br><span class="line">Mozilla/<span class="hljs-number">6.0</span>                    <span class="hljs-number">5</span></span><br><span class="line">BlackBerry8520/<span class="hljs-number">5.0</span><span class="hljs-number">.0</span><span class="hljs-number">.681</span>       <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>现在，假设你想按Windows和非Windows用户对时区统计信息进行分解。为了简单起见，我们假定只要agent字符串中含有”Windows”就认为该用户为Windows用户。由于有的agent缺失，所以首先将它们从数据中移除：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: cframe = frame[frame.a.notnull()]</span><br></pre></td></tr></table></figure>

<p>然后计算出各行是否含有Windows的值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">47</span>]: cframe[<span class="hljs-string">'os'</span>] = np.where(cframe[<span class="hljs-string">'a'</span>].str.contains(<span class="hljs-string">'Windows'</span>),</span><br><span class="line">   ....:                         <span class="hljs-string">'Windows'</span>, <span class="hljs-string">'Not Windows'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: cframe[<span class="hljs-string">'os'</span>][:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line"><span class="hljs-number">0</span>        Windows</span><br><span class="line"><span class="hljs-number">1</span>    Not Windows</span><br><span class="line"><span class="hljs-number">2</span>        Windows</span><br><span class="line"><span class="hljs-number">3</span>    Not Windows</span><br><span class="line"><span class="hljs-number">4</span>        Windows</span><br><span class="line">Name: os, dtype: object</span><br></pre></td></tr></table></figure>

<p>接下来就可以根据时区和新得到的操作系统列表对数据进行分组了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: by_tz_os = cframe.groupby([<span class="hljs-string">'tz'</span>, <span class="hljs-string">'os'</span>])</span><br></pre></td></tr></table></figure>

<p>分组计数，类似于value_counts函数，可以用size来计算。并利用unstack对计数结果进行重塑：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: agg_counts = by_tz_os.size().unstack().fillna(<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: agg_counts[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">51</span>]: </span><br><span class="line">os                              Not Windows  Windows</span><br><span class="line">tz                                                  </span><br><span class="line">                                      <span class="hljs-number">245.0</span>    <span class="hljs-number">276.0</span></span><br><span class="line">Africa/Cairo                            <span class="hljs-number">0.0</span>      <span class="hljs-number">3.0</span></span><br><span class="line">Africa/Casablanca                       <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">Africa/Ceuta                            <span class="hljs-number">0.0</span>      <span class="hljs-number">2.0</span></span><br><span class="line">Africa/Johannesburg                     <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">Africa/Lusaka                           <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">America/Anchorage                       <span class="hljs-number">4.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">America/Argentina/Buenos_Aires          <span class="hljs-number">1.0</span>      <span class="hljs-number">0.0</span></span><br><span class="line">America/Argentina/Cordoba               <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br><span class="line">America/Argentina/Mendoza               <span class="hljs-number">0.0</span>      <span class="hljs-number">1.0</span></span><br></pre></td></tr></table></figure>

<p>最后，我们来选取最常出现的时区。为了达到这个目的，我根据agg_counts中的行数构造了一个间接索引数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Use to sort in ascending order</span></span><br><span class="line">In [<span class="hljs-number">52</span>]: indexer = agg_counts.sum(<span class="hljs-number">1</span>).argsort()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: indexer[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">tz</span><br><span class="line">                                  <span class="hljs-number">24</span></span><br><span class="line">Africa/Cairo                      <span class="hljs-number">20</span></span><br><span class="line">Africa/Casablanca                 <span class="hljs-number">21</span></span><br><span class="line">Africa/Ceuta                      <span class="hljs-number">92</span></span><br><span class="line">Africa/Johannesburg               <span class="hljs-number">87</span></span><br><span class="line">Africa/Lusaka                     <span class="hljs-number">53</span></span><br><span class="line">America/Anchorage                 <span class="hljs-number">54</span></span><br><span class="line">America/Argentina/Buenos_Aires    <span class="hljs-number">57</span></span><br><span class="line">America/Argentina/Cordoba         <span class="hljs-number">26</span></span><br><span class="line">America/Argentina/Mendoza         <span class="hljs-number">55</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>然后我通过take按照这个顺序截取了最后10行最大值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: count_subset = agg_counts.take(indexer[<span class="hljs-number">-10</span>:])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: count_subset</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line">os                   Not Windows  Windows</span><br><span class="line">tz                                       </span><br><span class="line">America/Sao_Paulo           <span class="hljs-number">13.0</span>     <span class="hljs-number">20.0</span></span><br><span class="line">Europe/Madrid               <span class="hljs-number">16.0</span>     <span class="hljs-number">19.0</span></span><br><span class="line">Pacific/Honolulu             <span class="hljs-number">0.0</span>     <span class="hljs-number">36.0</span></span><br><span class="line">Asia/Tokyo                   <span class="hljs-number">2.0</span>     <span class="hljs-number">35.0</span></span><br><span class="line">Europe/London               <span class="hljs-number">43.0</span>     <span class="hljs-number">31.0</span></span><br><span class="line">America/Denver             <span class="hljs-number">132.0</span>     <span class="hljs-number">59.0</span></span><br><span class="line">America/Los_Angeles        <span class="hljs-number">130.0</span>    <span class="hljs-number">252.0</span></span><br><span class="line">America/Chicago            <span class="hljs-number">115.0</span>    <span class="hljs-number">285.0</span></span><br><span class="line">                           <span class="hljs-number">245.0</span>    <span class="hljs-number">276.0</span></span><br><span class="line">America/New_York           <span class="hljs-number">339.0</span>    <span class="hljs-number">912.0</span></span><br></pre></td></tr></table></figure>

<p>pandas有一个简便方法nlargest，可以做同样的工作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: agg_counts.sum(<span class="hljs-number">1</span>).nlargest(<span class="hljs-number">10</span>)</span><br><span class="line">Out[<span class="hljs-number">56</span>]: </span><br><span class="line">tz</span><br><span class="line">America/New_York       <span class="hljs-number">1251.0</span></span><br><span class="line">                        <span class="hljs-number">521.0</span></span><br><span class="line">America/Chicago         <span class="hljs-number">400.0</span></span><br><span class="line">America/Los_Angeles     <span class="hljs-number">382.0</span></span><br><span class="line">America/Denver          <span class="hljs-number">191.0</span></span><br><span class="line">Europe/London            <span class="hljs-number">74.0</span></span><br><span class="line">Asia/Tokyo               <span class="hljs-number">37.0</span></span><br><span class="line">Pacific/Honolulu         <span class="hljs-number">36.0</span></span><br><span class="line">Europe/Madrid            <span class="hljs-number">35.0</span></span><br><span class="line">America/Sao_Paulo        <span class="hljs-number">33.0</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>然后，如这段代码所示，可以用柱状图表示。我传递一个额外参数到seaborn的barpolt函数，来画一个堆积条形图（见图14-2）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Rearrange the data for plotting</span></span><br><span class="line">In [<span class="hljs-number">58</span>]: count_subset = count_subset.stack()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: count_subset.name = <span class="hljs-string">'total'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: count_subset = count_subset.reset_index()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: count_subset[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line">                  tz           os  total</span><br><span class="line"><span class="hljs-number">0</span>  America/Sao_Paulo  Not Windows   <span class="hljs-number">13.0</span></span><br><span class="line"><span class="hljs-number">1</span>  America/Sao_Paulo      Windows   <span class="hljs-number">20.0</span></span><br><span class="line"><span class="hljs-number">2</span>      Europe/Madrid  Not Windows   <span class="hljs-number">16.0</span></span><br><span class="line"><span class="hljs-number">3</span>      Europe/Madrid      Windows   <span class="hljs-number">19.0</span></span><br><span class="line"><span class="hljs-number">4</span>   Pacific/Honolulu  Not Windows    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">5</span>   Pacific/Honolulu      Windows   <span class="hljs-number">36.0</span></span><br><span class="line"><span class="hljs-number">6</span>         Asia/Tokyo  Not Windows    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">7</span>         Asia/Tokyo      Windows   <span class="hljs-number">35.0</span></span><br><span class="line"><span class="hljs-number">8</span>      Europe/London  Not Windows   <span class="hljs-number">43.0</span></span><br><span class="line"><span class="hljs-number">9</span>      Europe/London      Windows   <span class="hljs-number">31.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: sns.barplot(x=<span class="hljs-string">'total'</span>, y=<span class="hljs-string">'tz'</span>, hue=<span class="hljs-string">'os'</span>,  data=count_subset)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-053612a5655b68d9.webp" alt="img"></p>
<p>图14-2 最常出现时区的Windows和非Windows用户</p>
<p>这张图不容易看出Windows用户在小分组中的相对比例，因此标准化分组百分比之和为1：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">norm_total</span><span class="hljs-params">(group)</span>:</span></span><br><span class="line">    group[<span class="hljs-string">'normed_total'</span>] = group.total / group.total.sum()</span><br><span class="line">    <span class="hljs-keyword">return</span> group</span><br><span class="line"></span><br><span class="line">results = count_subset.groupby(<span class="hljs-string">'tz'</span>).apply(norm_total)</span><br></pre></td></tr></table></figure>

<p>再次画图，见图14-3：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">65</span>]: sns.barplot(x=<span class="hljs-string">'normed_total'</span>, y=<span class="hljs-string">'tz'</span>, hue=<span class="hljs-string">'os'</span>,  data=results)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-60ee355801daf412.webp" alt="img"></p>
<p>图14-3 最常出现时区的Windows和非Windows用户的百分比</p>
<p>我们还可以用groupby的transform方法，更高效的计算标准化的和：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: g = count_subset.groupby(<span class="hljs-string">'tz'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: results2 = count_subset.total / g.total.transform(<span class="hljs-string">'sum'</span>)</span><br></pre></td></tr></table></figure>

<h1 id="14-2-MovieLens-1M数据集"><a href="#14-2-MovieLens-1M数据集" class="headerlink" title="14.2 MovieLens 1M数据集"></a>14.2 MovieLens 1M数据集</h1><p>GroupLens Research（<a href="http://www.grouplens.org/node/73）采集了一组从20世纪90年末到21世纪初由MovieLens用户提供的电影评分数据。这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。基于机器学习算法的推荐系统一般都会对此类数据感兴趣。虽然我不会在本书中详细介绍机器学习技术，但我会告诉你如何对这种数据进行切片切块以满足实际需求。" target="_blank" rel="noopener">http://www.grouplens.org/node/73）采集了一组从20世纪90年末到21世纪初由MovieLens用户提供的电影评分数据。这些数据中包括电影评分、电影元数据（风格类型和年代）以及关于用户的人口统计学数据（年龄、邮编、性别和职业等）。基于机器学习算法的推荐系统一般都会对此类数据感兴趣。虽然我不会在本书中详细介绍机器学习技术，但我会告诉你如何对这种数据进行切片切块以满足实际需求。</a></p>
<p>MovieLens 1M数据集含有来自6000名用户对4000部电影的100万条评分数据。它分为三个表：评分、用户信息和电影信息。将该数据从zip文件中解压出来之后，可以通过pandas.read_table将各个表分别读到一个pandas DataFrame对象中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Make display smaller</span></span><br><span class="line">pd.options.display.max_rows = <span class="hljs-number">10</span></span><br><span class="line"></span><br><span class="line">unames = [<span class="hljs-string">'user_id'</span>, <span class="hljs-string">'gender'</span>, <span class="hljs-string">'age'</span>, <span class="hljs-string">'occupation'</span>, <span class="hljs-string">'zip'</span>]</span><br><span class="line">users = pd.read_table(<span class="hljs-string">'datasets/movielens/users.dat'</span>, sep=<span class="hljs-string">'::'</span>,</span><br><span class="line">                      header=<span class="hljs-literal">None</span>, names=unames)</span><br><span class="line"></span><br><span class="line">rnames = [<span class="hljs-string">'user_id'</span>, <span class="hljs-string">'movie_id'</span>, <span class="hljs-string">'rating'</span>, <span class="hljs-string">'timestamp'</span>]</span><br><span class="line">ratings = pd.read_table(<span class="hljs-string">'datasets/movielens/ratings.dat'</span>, sep=<span class="hljs-string">'::'</span>,</span><br><span class="line">                        header=<span class="hljs-literal">None</span>, names=rnames)</span><br><span class="line">mnames = [<span class="hljs-string">'movie_id'</span>, <span class="hljs-string">'title'</span>, <span class="hljs-string">'genres'</span>]</span><br><span class="line">movies = pd.read_table(<span class="hljs-string">'datasets/movielens/movies.dat'</span>, sep=<span class="hljs-string">'::'</span>,</span><br><span class="line">                       header=<span class="hljs-literal">None</span>, names=mnames)</span><br></pre></td></tr></table></figure>

<p>利用Python的切片语法，通过查看每个DataFrame的前几行即可验证数据加载工作是否一切顺利：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: users[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">69</span>]: </span><br><span class="line">   user_id gender  age  occupation    zip</span><br><span class="line"><span class="hljs-number">0</span>        <span class="hljs-number">1</span>      F    <span class="hljs-number">1</span>          <span class="hljs-number">10</span>  <span class="hljs-number">48067</span></span><br><span class="line"><span class="hljs-number">1</span>        <span class="hljs-number">2</span>      M   <span class="hljs-number">56</span>          <span class="hljs-number">16</span>  <span class="hljs-number">70072</span></span><br><span class="line"><span class="hljs-number">2</span>        <span class="hljs-number">3</span>      M   <span class="hljs-number">25</span>          <span class="hljs-number">15</span>  <span class="hljs-number">55117</span></span><br><span class="line"><span class="hljs-number">3</span>        <span class="hljs-number">4</span>      M   <span class="hljs-number">45</span>           <span class="hljs-number">7</span>  <span class="hljs-number">02460</span></span><br><span class="line"><span class="hljs-number">4</span>        <span class="hljs-number">5</span>      M   <span class="hljs-number">25</span>          <span class="hljs-number">20</span>  <span class="hljs-number">55455</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: ratings[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line">   user_id  movie_id  rating  timestamp</span><br><span class="line"><span class="hljs-number">0</span>        <span class="hljs-number">1</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978300760</span></span><br><span class="line"><span class="hljs-number">1</span>        <span class="hljs-number">1</span>       <span class="hljs-number">661</span>       <span class="hljs-number">3</span>  <span class="hljs-number">978302109</span></span><br><span class="line"><span class="hljs-number">2</span>        <span class="hljs-number">1</span>       <span class="hljs-number">914</span>       <span class="hljs-number">3</span>  <span class="hljs-number">978301968</span></span><br><span class="line"><span class="hljs-number">3</span>        <span class="hljs-number">1</span>      <span class="hljs-number">3408</span>       <span class="hljs-number">4</span>  <span class="hljs-number">978300275</span></span><br><span class="line"><span class="hljs-number">4</span>        <span class="hljs-number">1</span>      <span class="hljs-number">2355</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978824291</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: movies[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line">   movie_id                               title                        genres</span><br><span class="line"><span class="hljs-number">0</span>         <span class="hljs-number">1</span>                    Toy Story (<span class="hljs-number">1995</span>)   Animation|Children<span class="hljs-string">'s|Comedy</span></span><br><span class="line"><span class="hljs-string">1         2                      Jumanji (1995)  Adventure|Children'</span>s|Fantasy</span><br><span class="line"><span class="hljs-number">2</span>         <span class="hljs-number">3</span>             Grumpier Old Men (<span class="hljs-number">1995</span>)                Comedy|Romance</span><br><span class="line"><span class="hljs-number">3</span>         <span class="hljs-number">4</span>            Waiting to Exhale (<span class="hljs-number">1995</span>)                  Comedy|Drama</span><br><span class="line"><span class="hljs-number">4</span>         <span class="hljs-number">5</span>  Father of the Bride Part II (<span class="hljs-number">1995</span>)                        Comedy</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: ratings</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line">         user_id  movie_id  rating  timestamp</span><br><span class="line"><span class="hljs-number">0</span>              <span class="hljs-number">1</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978300760</span></span><br><span class="line"><span class="hljs-number">1</span>              <span class="hljs-number">1</span>       <span class="hljs-number">661</span>       <span class="hljs-number">3</span>  <span class="hljs-number">978302109</span></span><br><span class="line"><span class="hljs-number">2</span>              <span class="hljs-number">1</span>       <span class="hljs-number">914</span>       <span class="hljs-number">3</span>  <span class="hljs-number">978301968</span></span><br><span class="line"><span class="hljs-number">3</span>              <span class="hljs-number">1</span>      <span class="hljs-number">3408</span>       <span class="hljs-number">4</span>  <span class="hljs-number">978300275</span></span><br><span class="line"><span class="hljs-number">4</span>              <span class="hljs-number">1</span>      <span class="hljs-number">2355</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978824291</span></span><br><span class="line"><span class="hljs-meta">... </span>         ...       ...     ...        ...</span><br><span class="line"><span class="hljs-number">1000204</span>     <span class="hljs-number">6040</span>      <span class="hljs-number">1091</span>       <span class="hljs-number">1</span>  <span class="hljs-number">956716541</span></span><br><span class="line"><span class="hljs-number">1000205</span>     <span class="hljs-number">6040</span>      <span class="hljs-number">1094</span>       <span class="hljs-number">5</span>  <span class="hljs-number">956704887</span></span><br><span class="line"><span class="hljs-number">1000206</span>     <span class="hljs-number">6040</span>       <span class="hljs-number">562</span>       <span class="hljs-number">5</span>  <span class="hljs-number">956704746</span></span><br><span class="line"><span class="hljs-number">1000207</span>     <span class="hljs-number">6040</span>      <span class="hljs-number">1096</span>       <span class="hljs-number">4</span>  <span class="hljs-number">956715648</span></span><br><span class="line"><span class="hljs-number">1000208</span>     <span class="hljs-number">6040</span>      <span class="hljs-number">1097</span>       <span class="hljs-number">4</span>  <span class="hljs-number">956715569</span></span><br><span class="line">[<span class="hljs-number">1000209</span> rows x <span class="hljs-number">4</span> columns]</span><br></pre></td></tr></table></figure>

<p>注意，其中的年龄和职业是以编码形式给出的，它们的具体含义请参考该数据集的README文件。分析散布在三个表中的数据可不是一件轻松的事情。假设我们想要根据性别和年龄计算某部电影的平均得分，如果将所有数据都合并到一个表中的话问题就简单多了。我们先用pandas的merge函数将ratings跟users合并到一起，然后再将movies也合并进去。pandas会根据列名的重叠情况推断出哪些列是合并（或连接）键：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: data = pd.merge(pd.merge(ratings, users), movies)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">74</span>]: data</span><br><span class="line">Out[<span class="hljs-number">74</span>]: </span><br><span class="line">         user_id  movie_id  rating  timestamp gender  age  occupation    zip  \</span><br><span class="line"><span class="hljs-number">0</span>              <span class="hljs-number">1</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978300760</span>      F    <span class="hljs-number">1</span>          <span class="hljs-number">10</span>  <span class="hljs-number">48067</span>   </span><br><span class="line"><span class="hljs-number">1</span>              <span class="hljs-number">2</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978298413</span>      M   <span class="hljs-number">56</span>          <span class="hljs-number">16</span>  <span class="hljs-number">70072</span>   </span><br><span class="line"><span class="hljs-number">2</span>             <span class="hljs-number">12</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">4</span>  <span class="hljs-number">978220179</span>      M   <span class="hljs-number">25</span>          <span class="hljs-number">12</span>  <span class="hljs-number">32793</span>   </span><br><span class="line"><span class="hljs-number">3</span>             <span class="hljs-number">15</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">4</span>  <span class="hljs-number">978199279</span>      M   <span class="hljs-number">25</span>           <span class="hljs-number">7</span>  <span class="hljs-number">22903</span>   </span><br><span class="line"><span class="hljs-number">4</span>             <span class="hljs-number">17</span>      <span class="hljs-number">1193</span>       <span class="hljs-number">5</span>  <span class="hljs-number">978158471</span>      M   <span class="hljs-number">50</span>           <span class="hljs-number">1</span>  <span class="hljs-number">95350</span>   </span><br><span class="line"><span class="hljs-meta">... </span>         ...       ...     ...        ...    ...  ...         ...    ...   </span><br><span class="line"><span class="hljs-number">1000204</span>     <span class="hljs-number">5949</span>      <span class="hljs-number">2198</span>       <span class="hljs-number">5</span>  <span class="hljs-number">958846401</span>      M   <span class="hljs-number">18</span>          <span class="hljs-number">17</span>  <span class="hljs-number">47901</span></span><br><span class="line"><span class="hljs-number">1000205</span>     <span class="hljs-number">5675</span>      <span class="hljs-number">2703</span>       <span class="hljs-number">3</span>  <span class="hljs-number">976029116</span>      M   <span class="hljs-number">35</span>          <span class="hljs-number">14</span>  <span class="hljs-number">30030</span>   </span><br><span class="line"><span class="hljs-number">1000206</span>     <span class="hljs-number">5780</span>      <span class="hljs-number">2845</span>       <span class="hljs-number">1</span>  <span class="hljs-number">958153068</span>      M   <span class="hljs-number">18</span>          <span class="hljs-number">17</span>  <span class="hljs-number">92886</span>   </span><br><span class="line"><span class="hljs-number">1000207</span>     <span class="hljs-number">5851</span>      <span class="hljs-number">3607</span>       <span class="hljs-number">5</span>  <span class="hljs-number">957756608</span>      F   <span class="hljs-number">18</span>          <span class="hljs-number">20</span>  <span class="hljs-number">55410</span>   </span><br><span class="line"><span class="hljs-number">1000208</span>     <span class="hljs-number">5938</span>      <span class="hljs-number">2909</span>       <span class="hljs-number">4</span>  <span class="hljs-number">957273353</span>      M   <span class="hljs-number">25</span>           <span class="hljs-number">1</span>  <span class="hljs-number">35401</span>   </span><br><span class="line">                                               title                genres  </span><br><span class="line"><span class="hljs-number">0</span>             One Flew Over the Cuckoo<span class="hljs-string">'s Nest (1975)                 Drama  </span></span><br><span class="line"><span class="hljs-string">1             One Flew Over the Cuckoo'</span>s Nest (<span class="hljs-number">1975</span>)                 Drama  </span><br><span class="line"><span class="hljs-number">2</span>             One Flew Over the Cuckoo<span class="hljs-string">'s Nest (1975)                 Drama  </span></span><br><span class="line"><span class="hljs-string">3             One Flew Over the Cuckoo'</span>s Nest (<span class="hljs-number">1975</span>)                 Drama  </span><br><span class="line"><span class="hljs-number">4</span>             One Flew Over the Cuckoo<span class="hljs-string">'s Nest (1975)                 Drama  </span></span><br><span class="line"><span class="hljs-string">...                                              ...                   ...  </span></span><br><span class="line"><span class="hljs-string">1000204                           Modulations (1998)           Documentary  </span></span><br><span class="line"><span class="hljs-string">1000205                        Broken Vessels (1998)                 Drama  </span></span><br><span class="line"><span class="hljs-string">1000206                            White Boys (1999)                 Drama  </span></span><br><span class="line"><span class="hljs-string">1000207                     One Little Indian (1973)  Comedy|Drama|Western  </span></span><br><span class="line"><span class="hljs-string">1000208  Five Wives, Three Secretaries and Me (1998)           Documentary  </span></span><br><span class="line"><span class="hljs-string">[1000209 rows x 10 columns]</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">In [75]: data.iloc[0]</span></span><br><span class="line"><span class="hljs-string">Out[75]: </span></span><br><span class="line"><span class="hljs-string">user_id                                            1</span></span><br><span class="line"><span class="hljs-string">movie_id                                        1193</span></span><br><span class="line"><span class="hljs-string">rating                                             5</span></span><br><span class="line"><span class="hljs-string">timestamp                                  978300760</span></span><br><span class="line"><span class="hljs-string">gender                                             F</span></span><br><span class="line"><span class="hljs-string">age                                                1</span></span><br><span class="line"><span class="hljs-string">occupation                                        10</span></span><br><span class="line"><span class="hljs-string">zip                                            48067</span></span><br><span class="line"><span class="hljs-string">title         One Flew Over the Cuckoo'</span>s Nest (<span class="hljs-number">1975</span>)</span><br><span class="line">genres                                         Drama</span><br><span class="line">Name: <span class="hljs-number">0</span>, dtype: object</span><br></pre></td></tr></table></figure>

<p>为了按性别计算每部电影的平均得分，我们可以使用pivot_table方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">76</span>]: mean_ratings = data.pivot_table(<span class="hljs-string">'rating'</span>, index=<span class="hljs-string">'title'</span>,</span><br><span class="line">   ....:                                 columns=<span class="hljs-string">'gender'</span>, aggfunc=<span class="hljs-string">'mean'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: mean_ratings[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">gender                                F         M</span><br><span class="line">title                                            </span><br><span class="line">$<span class="hljs-number">1</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> Duck (<span class="hljs-number">1971</span>)         <span class="hljs-number">3.375000</span>  <span class="hljs-number">2.761905</span></span><br><span class="line"><span class="hljs-string">'Night Mother (1986)           3.388889  3.352941</span></span><br><span class="line"><span class="hljs-string">'</span>Til There Was You (<span class="hljs-number">1997</span>)      <span class="hljs-number">2.675676</span>  <span class="hljs-number">2.733333</span></span><br><span class="line"><span class="hljs-string">'burbs, The (1989)             2.793478  2.962085</span></span><br><span class="line"><span class="hljs-string">...And Justice for All (1979)  3.828571  3.689024</span></span><br></pre></td></tr></table></figure>

<p>该操作产生了另一个DataFrame，其内容为电影平均得分，行标为电影名称（索引），列标为性别。现在，我打算过滤掉评分数据不够250条的电影（随便选的一个数字）。为了达到这个目的，我先对title进行分组，然后利用size()得到一个含有各电影分组大小的Series对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">78</span>]: ratings_by_title = data.groupby(<span class="hljs-string">'title'</span>).size()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">79</span>]: ratings_by_title[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line">title</span><br><span class="line">$<span class="hljs-number">1</span>,<span class="hljs-number">000</span>,<span class="hljs-number">000</span> Duck (<span class="hljs-number">1971</span>)                <span class="hljs-number">37</span></span><br><span class="line"><span class="hljs-string">'Night Mother (1986)                  70</span></span><br><span class="line"><span class="hljs-string">'</span>Til There Was You (<span class="hljs-number">1997</span>)             <span class="hljs-number">52</span></span><br><span class="line"><span class="hljs-string">'burbs, The (1989)                   303</span></span><br><span class="line"><span class="hljs-string">...And Justice for All (1979)        199</span></span><br><span class="line"><span class="hljs-string">1-900 (1994)                           2</span></span><br><span class="line"><span class="hljs-string">10 Things I Hate About You (1999)    700</span></span><br><span class="line"><span class="hljs-string">101 Dalmatians (1961)                565</span></span><br><span class="line"><span class="hljs-string">101 Dalmatians (1996)                364</span></span><br><span class="line"><span class="hljs-string">12 Angry Men (1957)                  616</span></span><br><span class="line"><span class="hljs-string">dtype: int64</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">In [80]: active_titles = ratings_by_title.index[ratings_by_title &gt;= 250]</span></span><br><span class="line"><span class="hljs-string"></span></span><br><span class="line"><span class="hljs-string">In [81]: active_titles</span></span><br><span class="line"><span class="hljs-string">Out[81]: </span></span><br><span class="line"><span class="hljs-string">Index(['</span><span class="hljs-string">'burbs, The (1989)'</span>, <span class="hljs-string">'10 Things I Hate About You (1999)'</span>,</span><br><span class="line">       <span class="hljs-string">'101 Dalmatians (1961)'</span>, <span class="hljs-string">'101 Dalmatians (1996)'</span>, <span class="hljs-string">'12 Angry Men (1957)'</span>,</span><br><span class="line">       <span class="hljs-string">'13th Warrior, The (1999)'</span>, <span class="hljs-string">'2 Days in the Valley (1996)'</span>,</span><br><span class="line">       <span class="hljs-string">'20,000 Leagues Under the Sea (1954)'</span>, <span class="hljs-string">'2001: A Space Odyssey (1968)'</span>,</span><br><span class="line">       <span class="hljs-string">'2010 (1984)'</span>,</span><br><span class="line">       ...</span><br><span class="line"><span class="hljs-string">'X-Men (2000)'</span>, <span class="hljs-string">'Year of Living Dangerously (1982)'</span>,</span><br><span class="line">       <span class="hljs-string">'Yellow Submarine (1968)'</span>, <span class="hljs-string">'You'</span>ve Got Mail (<span class="hljs-number">1998</span>)<span class="hljs-string">',</span></span><br><span class="line"><span class="hljs-string">       '</span>Young Frankenstein (<span class="hljs-number">1974</span>)<span class="hljs-string">', '</span>Young Guns (<span class="hljs-number">1988</span>)<span class="hljs-string">',</span></span><br><span class="line"><span class="hljs-string">       '</span>Young Guns II (<span class="hljs-number">1990</span>)<span class="hljs-string">', '</span>Young Sherlock Holmes (<span class="hljs-number">1985</span>)<span class="hljs-string">',</span></span><br><span class="line"><span class="hljs-string">       '</span>Zero Effect (<span class="hljs-number">1998</span>)<span class="hljs-string">', '</span>eXistenZ (<span class="hljs-number">1999</span>)<span class="hljs-string">'],</span></span><br><span class="line"><span class="hljs-string">      dtype='</span>object<span class="hljs-string">', name='</span>title<span class="hljs-string">', length=1216)</span></span><br></pre></td></tr></table></figure>

<p>标题索引中含有评分数据大于250条的电影名称，然后我们就可以据此从前面的mean_ratings中选取所需的行了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Select rows on the index</span></span><br><span class="line">In [<span class="hljs-number">82</span>]: mean_ratings = mean_ratings.loc[active_titles]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: mean_ratings</span><br><span class="line">Out[<span class="hljs-number">83</span>]: </span><br><span class="line">gender                                    F         M</span><br><span class="line">title                                                </span><br><span class="line"><span class="hljs-string">'burbs, The (1989)                 2.793478  2.962085</span></span><br><span class="line"><span class="hljs-string">10 Things I Hate About You (1999)  3.646552  3.311966</span></span><br><span class="line"><span class="hljs-string">101 Dalmatians (1961)              3.791444  3.500000</span></span><br><span class="line"><span class="hljs-string">101 Dalmatians (1996)              3.240000  2.911215</span></span><br><span class="line"><span class="hljs-string">12 Angry Men (1957)                4.184397  4.328421</span></span><br><span class="line"><span class="hljs-string">...                                     ...       ...</span></span><br><span class="line"><span class="hljs-string">Young Guns (1988)                  3.371795  3.425620</span></span><br><span class="line"><span class="hljs-string">Young Guns II (1990)               2.934783  2.904025</span></span><br><span class="line"><span class="hljs-string">Young Sherlock Holmes (1985)       3.514706  3.363344</span></span><br><span class="line"><span class="hljs-string">Zero Effect (1998)                 3.864407  3.723140</span></span><br><span class="line"><span class="hljs-string">eXistenZ (1999)                    3.098592  3.289086</span></span><br><span class="line"><span class="hljs-string">[1216 rows x 2 columns]</span></span><br></pre></td></tr></table></figure>

<p>为了了解女性观众最喜欢的电影，我们可以对F列降序排列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: top_female_ratings = mean_ratings.sort_values(by=<span class="hljs-string">'F'</span>, ascending=<span class="hljs-literal">False</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">86</span>]: top_female_ratings[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line">gender                                                     F         M</span><br><span class="line">title                                                                 </span><br><span class="line">Close Shave, A (<span class="hljs-number">1995</span>)                               <span class="hljs-number">4.644444</span>  <span class="hljs-number">4.473795</span></span><br><span class="line">Wrong Trousers, The (<span class="hljs-number">1993</span>)                          <span class="hljs-number">4.588235</span>  <span class="hljs-number">4.478261</span></span><br><span class="line">Sunset Blvd. (a.k.a. Sunset Boulevard) (<span class="hljs-number">1950</span>)       <span class="hljs-number">4.572650</span>  <span class="hljs-number">4.464589</span></span><br><span class="line">Wallace &amp; Gromit: The Best of Aardman Animation...  <span class="hljs-number">4.563107</span>  <span class="hljs-number">4.385075</span></span><br><span class="line">Schindle<span class="hljs-string">r's List (1993)                             4.562602  4.491415</span></span><br><span class="line"><span class="hljs-string">Shawshank Redemption, The (1994)                    4.539075  4.560625</span></span><br><span class="line"><span class="hljs-string">Grand Day Out, A (1992)                             4.537879  4.293255</span></span><br><span class="line"><span class="hljs-string">To Kill a Mockingbird (1962)                        4.536667  4.372611</span></span><br><span class="line"><span class="hljs-string">Creature Comforts (1990)                            4.513889  4.272277</span></span><br><span class="line"><span class="hljs-string">Usual Suspects, The (1995)                          4.513317  4.518248</span></span><br></pre></td></tr></table></figure>

<h2 id="计算评分分歧"><a href="#计算评分分歧" class="headerlink" title="计算评分分歧"></a>计算评分分歧</h2><p>假设我们想要找出男性和女性观众分歧最大的电影。一个办法是给mean_ratings加上一个用于存放平均得分之差的列，并对其进行排序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: mean_ratings[<span class="hljs-string">'diff'</span>] = mean_ratings[<span class="hljs-string">'M'</span>] - mean_ratings[<span class="hljs-string">'F'</span>]</span><br></pre></td></tr></table></figure>

<p>按”diff”排序即可得到分歧最大且女性观众更喜欢的电影：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">88</span>]: sorted_by_diff = mean_ratings.sort_values(by=<span class="hljs-string">'diff'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">89</span>]: sorted_by_diff[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">gender                                        F         M      diff</span><br><span class="line">title                                                              </span><br><span class="line">Dirty Dancing (<span class="hljs-number">1987</span>)                   <span class="hljs-number">3.790378</span>  <span class="hljs-number">2.959596</span> <span class="hljs-number">-0.830782</span></span><br><span class="line">Jumpin<span class="hljs-string">' Jack Flash (1986)              3.254717  2.578358 -0.676359</span></span><br><span class="line"><span class="hljs-string">Grease (1978)                          3.975265  3.367041 -0.608224</span></span><br><span class="line"><span class="hljs-string">Little Women (1994)                    3.870588  3.321739 -0.548849</span></span><br><span class="line"><span class="hljs-string">Steel Magnolias (1989)                 3.901734  3.365957 -0.535777</span></span><br><span class="line"><span class="hljs-string">Anastasia (1997)                       3.800000  3.281609 -0.518391</span></span><br><span class="line"><span class="hljs-string">Rocky Horror Picture Show, The (1975)  3.673016  3.160131 -0.512885</span></span><br><span class="line"><span class="hljs-string">Color Purple, The (1985)               4.158192  3.659341 -0.498851</span></span><br><span class="line"><span class="hljs-string">Age of Innocence, The (1993)           3.827068  3.339506 -0.487561</span></span><br><span class="line"><span class="hljs-string">Free Willy (1993)                      2.921348  2.438776 -0.482573</span></span><br></pre></td></tr></table></figure>

<p>对排序结果反序并取出前10行，得到的则是男性观众更喜欢的电影：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Reverse order of rows, take first 10 rows</span></span><br><span class="line">In [<span class="hljs-number">90</span>]: sorted_by_diff[::<span class="hljs-number">-1</span>][:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">gender                                         F         M      diff</span><br><span class="line">title                                                               </span><br><span class="line">Good, The Bad <span class="hljs-keyword">and</span> The Ugly, The (<span class="hljs-number">1966</span>)  <span class="hljs-number">3.494949</span>  <span class="hljs-number">4.221300</span>  <span class="hljs-number">0.726351</span></span><br><span class="line">Kentucky Fried Movie, The (<span class="hljs-number">1977</span>)        <span class="hljs-number">2.878788</span>  <span class="hljs-number">3.555147</span>  <span class="hljs-number">0.676359</span></span><br><span class="line">Dumb &amp; Dumber (<span class="hljs-number">1994</span>)                    <span class="hljs-number">2.697987</span>  <span class="hljs-number">3.336595</span>  <span class="hljs-number">0.638608</span></span><br><span class="line">Longest Day, The (<span class="hljs-number">1962</span>)                 <span class="hljs-number">3.411765</span>  <span class="hljs-number">4.031447</span>  <span class="hljs-number">0.619682</span></span><br><span class="line">Cable Guy, The (<span class="hljs-number">1996</span>)                   <span class="hljs-number">2.250000</span>  <span class="hljs-number">2.863787</span>  <span class="hljs-number">0.613787</span></span><br><span class="line">Evil Dead II (Dead By Dawn) (<span class="hljs-number">1987</span>)      <span class="hljs-number">3.297297</span>  <span class="hljs-number">3.909283</span>  <span class="hljs-number">0.611985</span></span><br><span class="line">Hidden, The (<span class="hljs-number">1987</span>)                      <span class="hljs-number">3.137931</span>  <span class="hljs-number">3.745098</span>  <span class="hljs-number">0.607167</span></span><br><span class="line">Rocky III (<span class="hljs-number">1982</span>)                        <span class="hljs-number">2.361702</span>  <span class="hljs-number">2.943503</span>  <span class="hljs-number">0.581801</span></span><br><span class="line">Caddyshack (<span class="hljs-number">1980</span>)                       <span class="hljs-number">3.396135</span>  <span class="hljs-number">3.969737</span>  <span class="hljs-number">0.573602</span></span><br><span class="line">For a Few Dollars More (<span class="hljs-number">1965</span>)           <span class="hljs-number">3.409091</span>  <span class="hljs-number">3.953795</span>  <span class="hljs-number">0.544704</span></span><br></pre></td></tr></table></figure>

<p>如果只是想要找出分歧最大的电影（不考虑性别因素），则可以计算得分数据的方差或标准差：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Standard deviation of rating grouped by title</span></span><br><span class="line">In [<span class="hljs-number">91</span>]: rating_std_by_title = data.groupby(<span class="hljs-string">'title'</span>)[<span class="hljs-string">'rating'</span>].std()</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Filter down to active_titles</span></span><br><span class="line">In [<span class="hljs-number">92</span>]: rating_std_by_title = rating_std_by_title.loc[active_titles]</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Order Series by value in descending order</span></span><br><span class="line">In [<span class="hljs-number">93</span>]: rating_std_by_title.sort_values(ascending=<span class="hljs-literal">False</span>)[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line">title</span><br><span class="line">Dumb &amp; Dumber (<span class="hljs-number">1994</span>)                     <span class="hljs-number">1.321333</span></span><br><span class="line">Blair Witch Project, The (<span class="hljs-number">1999</span>)          <span class="hljs-number">1.316368</span></span><br><span class="line">Natural Born Killers (<span class="hljs-number">1994</span>)              <span class="hljs-number">1.307198</span></span><br><span class="line">Tank Girl (<span class="hljs-number">1995</span>)                         <span class="hljs-number">1.277695</span></span><br><span class="line">Rocky Horror Picture Show, The (<span class="hljs-number">1975</span>)    <span class="hljs-number">1.260177</span></span><br><span class="line">Eyes Wide Shut (<span class="hljs-number">1999</span>)                    <span class="hljs-number">1.259624</span></span><br><span class="line">Evita (<span class="hljs-number">1996</span>)                             <span class="hljs-number">1.253631</span></span><br><span class="line">Billy Madison (<span class="hljs-number">1995</span>)                     <span class="hljs-number">1.249970</span></span><br><span class="line">Fear <span class="hljs-keyword">and</span> Loathing <span class="hljs-keyword">in</span> Las Vegas (<span class="hljs-number">1998</span>)    <span class="hljs-number">1.246408</span></span><br><span class="line">Bicentennial Man (<span class="hljs-number">1999</span>)                  <span class="hljs-number">1.245533</span></span><br><span class="line">Name: rating, dtype: float64</span><br></pre></td></tr></table></figure>

<p>可能你已经注意到了，电影分类是以竖线（|）分隔的字符串形式给出的。如果想对电影分类进行分析的话，就需要先将其转换成更有用的形式才行。</p>
<h1 id="14-3-1880-2010年间全美婴儿姓名"><a href="#14-3-1880-2010年间全美婴儿姓名" class="headerlink" title="14.3 1880-2010年间全美婴儿姓名"></a>14.3 1880-2010年间全美婴儿姓名</h1><p>美国社会保障总署（SSA）提供了一份从1880年到现在的婴儿名字频率数据。Hadley Wickham（许多流行R包的作者）经常用这份数据来演示R的数据处理功能。</p>
<p>我们要做一些数据规整才能加载这个数据集，这么做就会产生一个如下的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">4</span>]: names.head(<span class="hljs-number">10</span>)</span><br><span class="line">Out[<span class="hljs-number">4</span>]:</span><br><span class="line">        name sex  births  year</span><br><span class="line"><span class="hljs-number">0</span>       Mary   F    <span class="hljs-number">7065</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">1</span>       Anna   F    <span class="hljs-number">2604</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">2</span>       Emma   F    <span class="hljs-number">2003</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">3</span>  Elizabeth   F    <span class="hljs-number">1939</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">4</span>     Minnie   F    <span class="hljs-number">1746</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">5</span>   Margaret   F    <span class="hljs-number">1578</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">6</span>        Ida   F    <span class="hljs-number">1472</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">7</span>      Alice   F    <span class="hljs-number">1414</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">8</span>     Bertha   F    <span class="hljs-number">1320</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">9</span>      Sarah   F    <span class="hljs-number">1288</span>  <span class="hljs-number">1880</span></span><br></pre></td></tr></table></figure>

<p>你可以用这个数据集做很多事，例如：</p>
<ul>
<li>计算指定名字（可以是你自己的，也可以是别人的）的年度比例。</li>
<li>计算某个名字的相对排名。</li>
<li>计算各年度最流行的名字，以及增长或减少最快的名字。</li>
<li>分析名字趋势：元音、辅音、长度、总体多样性、拼写变化、首尾字母等。</li>
<li>分析外源性趋势：圣经中的名字、名人、人口结构变化等。</li>
</ul>
<p>利用前面介绍过的那些工具，这些分析工作都能很轻松地完成，我会讲解其中的一些。</p>
<p>到编写本书时为止，美国社会保障总署将该数据库按年度制成了多个数据文件，其中给出了每个性别/名字组合的出生总数。这些文件的原始档案可以在这里获取：<a href="http://www.ssa.gov/oact/babynames/limits.html。" target="_blank" rel="noopener">http://www.ssa.gov/oact/babynames/limits.html。</a></p>
<p>如果你在阅读本书的时候这个页面已经不见了，也可以用搜索引擎找找。</p>
<p>下载”National data”文件names.zip，解压后的目录中含有一组文件（如yob1880.txt）。我用UNIX的head命令查看了其中一个文件的前10行（在Windows上，你可以用more命令，或直接在文本编辑器中打开）：</p>
<figure class="highlight plain hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [94]: !head -n 10 datasets/babynames/yob1880.txt</span><br><span class="line">Mary,F,7065</span><br><span class="line">Anna,F,2604</span><br><span class="line">Emma,F,2003</span><br><span class="line">Elizabeth,F,1939</span><br><span class="line">Minnie,F,1746</span><br><span class="line">Margaret,F,1578</span><br><span class="line">Ida,F,1472</span><br><span class="line">Alice,F,1414</span><br><span class="line">Bertha,F,1320</span><br><span class="line">Sarah,F,1288</span><br></pre></td></tr></table></figure>

<p>由于这是一个非常标准的以逗号隔开的格式，所以可以用pandas.read_csv将其加载到DataFrame中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">95</span>]: <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">96</span>]: names1880 =</span><br><span class="line">pd.read_csv(<span class="hljs-string">'datasets/babynames/yob1880.txt'</span>,</span><br><span class="line">   ....:                         names=[<span class="hljs-string">'name'</span>, <span class="hljs-string">'sex'</span>, <span class="hljs-string">'births'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: names1880</span><br><span class="line">Out[<span class="hljs-number">97</span>]: </span><br><span class="line">           name sex  births</span><br><span class="line"><span class="hljs-number">0</span>          Mary   F    <span class="hljs-number">7065</span></span><br><span class="line"><span class="hljs-number">1</span>          Anna   F    <span class="hljs-number">2604</span></span><br><span class="line"><span class="hljs-number">2</span>          Emma   F    <span class="hljs-number">2003</span></span><br><span class="line"><span class="hljs-number">3</span>     Elizabeth   F    <span class="hljs-number">1939</span></span><br><span class="line"><span class="hljs-number">4</span>        Minnie   F    <span class="hljs-number">1746</span></span><br><span class="line"><span class="hljs-meta">... </span>        ...  ..     ...</span><br><span class="line"><span class="hljs-number">1995</span>     Woodie   M       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1996</span>     Worthy   M       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1997</span>     Wright   M       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1998</span>       York   M       <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">1999</span>  Zachariah   M       <span class="hljs-number">5</span></span><br><span class="line">[<span class="hljs-number">2000</span> rows x <span class="hljs-number">3</span> columns]</span><br></pre></td></tr></table></figure>

<p>这些文件中仅含有当年出现超过5次的名字。为了简单起见，我们可以用births列的sex分组小计表示该年度的births总计：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">98</span>]: names1880.groupby(<span class="hljs-string">'sex'</span>).births.sum()</span><br><span class="line">Out[<span class="hljs-number">98</span>]: </span><br><span class="line">sex</span><br><span class="line">F     <span class="hljs-number">90993</span></span><br><span class="line">M    <span class="hljs-number">110493</span></span><br><span class="line">Name: births, dtype: int64</span><br></pre></td></tr></table></figure>

<p>由于该数据集按年度被分隔成了多个文件，所以第一件事情就是要将所有数据都组装到一个DataFrame里面，并加上一个year字段。使用pandas.concat即可达到这个目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">years = range(<span class="hljs-number">1880</span>, <span class="hljs-number">2011</span>)</span><br><span class="line"></span><br><span class="line">pieces = []</span><br><span class="line">columns = [<span class="hljs-string">'name'</span>, <span class="hljs-string">'sex'</span>, <span class="hljs-string">'births'</span>]</span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">for</span> year <span class="hljs-keyword">in</span> years:</span><br><span class="line">    path = <span class="hljs-string">'datasets/babynames/yob%d.txt'</span> % year</span><br><span class="line">    frame = pd.read_csv(path, names=columns)</span><br><span class="line"></span><br><span class="line">    frame[<span class="hljs-string">'year'</span>] = year</span><br><span class="line">    pieces.append(frame)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Concatenate everything into a single DataFrame</span></span><br><span class="line">names = pd.concat(pieces, ignore_index=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>这里需要注意几件事情。第一，concat默认是按行将多个DataFrame组合到一起的；第二，必须指定ignore_index=True，因为我们不希望保留read_csv所返回的原始行号。现在我们得到了一个非常大的DataFrame，它含有全部的名字数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">100</span>]: names</span><br><span class="line">Out[<span class="hljs-number">100</span>]: </span><br><span class="line">              name sex  births  year</span><br><span class="line"><span class="hljs-number">0</span>             Mary   F    <span class="hljs-number">7065</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">1</span>             Anna   F    <span class="hljs-number">2604</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">2</span>             Emma   F    <span class="hljs-number">2003</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">3</span>        Elizabeth   F    <span class="hljs-number">1939</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-number">4</span>           Minnie   F    <span class="hljs-number">1746</span>  <span class="hljs-number">1880</span></span><br><span class="line"><span class="hljs-meta">... </span>           ...  ..     ...   ...</span><br><span class="line"><span class="hljs-number">1690779</span>    Zymaire   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line"><span class="hljs-number">1690780</span>     Zyonne   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line"><span class="hljs-number">1690781</span>  Zyquarius   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line"><span class="hljs-number">1690782</span>      Zyran   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line"><span class="hljs-number">1690783</span>      Zzyzx   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span></span><br><span class="line">[<span class="hljs-number">1690784</span> rows x <span class="hljs-number">4</span> columns]</span><br></pre></td></tr></table></figure>

<p>有了这些数据之后，我们就可以利用groupby或pivot_table在year和sex级别上对其进行聚合了，如图14-4所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: total_births = names.pivot_table(<span class="hljs-string">'births'</span>, index=<span class="hljs-string">'year'</span>,</span><br><span class="line">   .....:                                  columns=<span class="hljs-string">'sex'</span>, aggfunc=sum)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: total_births.tail()</span><br><span class="line">Out[<span class="hljs-number">102</span>]: </span><br><span class="line">sex         F        M</span><br><span class="line">year                  </span><br><span class="line"><span class="hljs-number">2006</span>  <span class="hljs-number">1896468</span>  <span class="hljs-number">2050234</span></span><br><span class="line"><span class="hljs-number">2007</span>  <span class="hljs-number">1916888</span>  <span class="hljs-number">2069242</span></span><br><span class="line"><span class="hljs-number">2008</span>  <span class="hljs-number">1883645</span>  <span class="hljs-number">2032310</span></span><br><span class="line"><span class="hljs-number">2009</span>  <span class="hljs-number">1827643</span>  <span class="hljs-number">1973359</span></span><br><span class="line"><span class="hljs-number">2010</span>  <span class="hljs-number">1759010</span>  <span class="hljs-number">1898382</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: total_births.plot(title=<span class="hljs-string">'Total births by sex and year'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-7643b150d88aae11.webp" alt="img"></p>
<p>图14-4 按性别和年度统计的总出生数</p>
<p>下面我们来插入一个prop列，用于存放指定名字的婴儿数相对于总出生数的比例。prop值为0.02表示每100名婴儿中有2名取了当前这个名字。因此，我们先按year和sex分组，然后再将新列加到各个分组上：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">add_prop</span><span class="hljs-params">(group)</span>:</span></span><br><span class="line">    group[<span class="hljs-string">'prop'</span>] = group.births / group.births.sum()</span><br><span class="line">    <span class="hljs-keyword">return</span> group</span><br><span class="line">names = names.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>]).apply(add_prop)</span><br></pre></td></tr></table></figure>

<p>现在，完整的数据集就有了下面这些列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: names</span><br><span class="line">Out[<span class="hljs-number">105</span>]: </span><br><span class="line">              name sex  births  year      prop</span><br><span class="line"><span class="hljs-number">0</span>             Mary   F    <span class="hljs-number">7065</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.077643</span></span><br><span class="line"><span class="hljs-number">1</span>             Anna   F    <span class="hljs-number">2604</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.028618</span></span><br><span class="line"><span class="hljs-number">2</span>             Emma   F    <span class="hljs-number">2003</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.022013</span></span><br><span class="line"><span class="hljs-number">3</span>        Elizabeth   F    <span class="hljs-number">1939</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.021309</span></span><br><span class="line"><span class="hljs-number">4</span>           Minnie   F    <span class="hljs-number">1746</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.019188</span></span><br><span class="line"><span class="hljs-meta">... </span>           ...  ..     ...   ...       ...</span><br><span class="line"><span class="hljs-number">1690779</span>    Zymaire   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line"><span class="hljs-number">1690780</span>     Zyonne   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line"><span class="hljs-number">1690781</span>  Zyquarius   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line"><span class="hljs-number">1690782</span>      Zyran   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line"><span class="hljs-number">1690783</span>      Zzyzx   M       <span class="hljs-number">5</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000003</span></span><br><span class="line">[<span class="hljs-number">1690784</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>在执行这样的分组处理时，一般都应该做一些有效性检查，比如验证所有分组的prop的总和是否为1：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">106</span>]: names.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>]).prop.sum()</span><br><span class="line">Out[<span class="hljs-number">106</span>]: </span><br><span class="line">year  sex</span><br><span class="line"><span class="hljs-number">1880</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">      M      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1881</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">      M      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1882</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">            ... </span><br><span class="line"><span class="hljs-number">2008</span>  M      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2009</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">      M      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">2010</span>  F      <span class="hljs-number">1.0</span></span><br><span class="line">      M      <span class="hljs-number">1.0</span></span><br><span class="line">Name: prop, Length: <span class="hljs-number">262</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>工作完成。为了便于实现更进一步的分析，我需要取出该数据的一个子集：每对sex/year组合的前1000个名字。这又是一个分组操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_top1000</span><span class="hljs-params">(group)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">return</span> group.sort_values(by=<span class="hljs-string">'births'</span>, ascending=<span class="hljs-literal">False</span>)[:<span class="hljs-number">1000</span>]</span><br><span class="line">grouped = names.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>])</span><br><span class="line">top1000 = grouped.apply(get_top1000)</span><br><span class="line"><span class="hljs-comment"># Drop the group index, not needed</span></span><br><span class="line">top1000.reset_index(inplace=<span class="hljs-literal">True</span>, drop=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>如果你喜欢DIY的话，也可以这样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pieces = []</span><br><span class="line"><span class="hljs-keyword">for</span> year, group <span class="hljs-keyword">in</span> names.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>]):</span><br><span class="line">    pieces.append(group.sort_values(by=<span class="hljs-string">'births'</span>, ascending=<span class="hljs-literal">False</span>)[:<span class="hljs-number">1000</span>])</span><br><span class="line">top1000 = pd.concat(pieces, ignore_index=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></table></figure>

<p>现在的结果数据集就小多了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">108</span>]: top1000</span><br><span class="line">Out[<span class="hljs-number">108</span>]: </span><br><span class="line">             name sex  births  year      prop</span><br><span class="line"><span class="hljs-number">0</span>            Mary   F    <span class="hljs-number">7065</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.077643</span></span><br><span class="line"><span class="hljs-number">1</span>            Anna   F    <span class="hljs-number">2604</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.028618</span></span><br><span class="line"><span class="hljs-number">2</span>            Emma   F    <span class="hljs-number">2003</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.022013</span></span><br><span class="line"><span class="hljs-number">3</span>       Elizabeth   F    <span class="hljs-number">1939</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.021309</span></span><br><span class="line"><span class="hljs-number">4</span>          Minnie   F    <span class="hljs-number">1746</span>  <span class="hljs-number">1880</span>  <span class="hljs-number">0.019188</span></span><br><span class="line"><span class="hljs-meta">... </span>          ...  ..     ...   ...       ...</span><br><span class="line"><span class="hljs-number">261872</span>     Camilo   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261873</span>     Destin   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261874</span>     Jaquan   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261875</span>     Jaydan   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261876</span>     Maxton   M     <span class="hljs-number">193</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line">[<span class="hljs-number">261877</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>接下来的数据分析工作就针对这个top1000数据集了。</p>
<h2 id="分析命名趋势"><a href="#分析命名趋势" class="headerlink" title="分析命名趋势"></a>分析命名趋势</h2><p>有了完整的数据集和刚才生成的top1000数据集，我们就可以开始分析各种命名趋势了。首先将前1000个名字分为男女两个部分：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: boys = top1000[top1000.sex == <span class="hljs-string">'M'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">110</span>]: girls = top1000[top1000.sex == <span class="hljs-string">'F'</span>]</span><br></pre></td></tr></table></figure>

<p>这是两个简单的时间序列，只需稍作整理即可绘制出相应的图表（比如每年叫做John和Mary的婴儿数）。我们先生成一张按year和name统计的总出生数透视表：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">111</span>]: total_births = top1000.pivot_table(<span class="hljs-string">'births'</span>, index=<span class="hljs-string">'year'</span>,</span><br><span class="line">   .....:                                    columns=<span class="hljs-string">'name'</span>,</span><br><span class="line">   .....:                                    aggfunc=sum)</span><br></pre></td></tr></table></figure>

<p>现在，我们用DataFrame的plot方法绘制几个名字的曲线图（见图14-5）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">112</span>]: total_births.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">Int64Index</span>:</span> <span class="hljs-number">131</span> entries, <span class="hljs-number">1880</span> to <span class="hljs-number">2010</span></span><br><span class="line">Columns: <span class="hljs-number">6868</span> entries, Aaden to Zuri</span><br><span class="line">dtypes: float64(<span class="hljs-number">6868</span>)</span><br><span class="line">memory usage: <span class="hljs-number">6.9</span> MB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: subset = total_births[[<span class="hljs-string">'John'</span>, <span class="hljs-string">'Harry'</span>, <span class="hljs-string">'Mary'</span>, <span class="hljs-string">'Marilyn'</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">114</span>]: subset.plot(subplots=<span class="hljs-literal">True</span>, figsize=(<span class="hljs-number">12</span>, <span class="hljs-number">10</span>), grid=<span class="hljs-literal">False</span>,</span><br><span class="line">   .....:             title=<span class="hljs-string">"Number of births per year"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-33f0f97656367a53.webp" alt="img"></p>
<p>图14-5 几个男孩和女孩名字随时间变化的使用数量</p>
<p>从图中可以看出，这几个名字在美国人民的心目中已经风光不再了。但事实并非如此简单，我们在下一节中就能知道是怎么一回事了。</p>
<h2 id="评估命名多样性的增长"><a href="#评估命名多样性的增长" class="headerlink" title="评估命名多样性的增长"></a>评估命名多样性的增长</h2><p>一种解释是父母愿意给小孩起常见的名字越来越少。这个假设可以从数据中得到验证。一个办法是计算最流行的1000个名字所占的比例，我按year和sex进行聚合并绘图（见图14-6）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">116</span>]: table = top1000.pivot_table(<span class="hljs-string">'prop'</span>, index=<span class="hljs-string">'year'</span>,</span><br><span class="line">   .....:                             columns=<span class="hljs-string">'sex'</span>, aggfunc=sum)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">117</span>]: table.plot(title=<span class="hljs-string">'Sum of table1000.prop by year and sex'</span>,</span><br><span class="line">   .....:            yticks=np.linspace(<span class="hljs-number">0</span>, <span class="hljs-number">1.2</span>, <span class="hljs-number">13</span>), xticks=range(<span class="hljs-number">1880</span>, <span class="hljs-number">2020</span>, <span class="hljs-number">10</span>)</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-63e1ddc326a033b9.webp" alt="img"></p>
<p>图14-6 分性别统计的前1000个名字在总出生人数中的比例</p>
<p>从图中可以看出，名字的多样性确实出现了增长（前1000项的比例降低）。另一个办法是计算占总出生人数前50%的不同名字的数量，这个数字不太好计算。我们只考虑2010年男孩的名字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">118</span>]: df = boys[boys.year == <span class="hljs-number">2010</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">119</span>]: df</span><br><span class="line">Out[<span class="hljs-number">119</span>]: </span><br><span class="line">           name sex  births  year      prop</span><br><span class="line"><span class="hljs-number">260877</span>    Jacob   M   <span class="hljs-number">21875</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.011523</span></span><br><span class="line"><span class="hljs-number">260878</span>    Ethan   M   <span class="hljs-number">17866</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.009411</span></span><br><span class="line"><span class="hljs-number">260879</span>  Michael   M   <span class="hljs-number">17133</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.009025</span></span><br><span class="line"><span class="hljs-number">260880</span>   Jayden   M   <span class="hljs-number">17030</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.008971</span></span><br><span class="line"><span class="hljs-number">260881</span>  William   M   <span class="hljs-number">16870</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.008887</span></span><br><span class="line"><span class="hljs-meta">... </span>        ...  ..     ...   ...       ...</span><br><span class="line"><span class="hljs-number">261872</span>   Camilo   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261873</span>   Destin   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261874</span>   Jaquan   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261875</span>   Jaydan   M     <span class="hljs-number">194</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line"><span class="hljs-number">261876</span>   Maxton   M     <span class="hljs-number">193</span>  <span class="hljs-number">2010</span>  <span class="hljs-number">0.000102</span></span><br><span class="line">[<span class="hljs-number">1000</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>在对prop降序排列之后，我们想知道前面多少个名字的人数加起来才够50%。虽然编写一个for循环确实也能达到目的，但NumPy有一种更聪明的矢量方式。先计算prop的累计和cumsum，然后再通过searchsorted方法找出0.5应该被插入在哪个位置才能保证不破坏顺序：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">120</span>]: prop_cumsum = df.sort_values(by=<span class="hljs-string">'prop'</span>, ascending=<span class="hljs-literal">False</span>).prop.cumsum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">121</span>]: prop_cumsum[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">121</span>]: </span><br><span class="line"><span class="hljs-number">260877</span>    <span class="hljs-number">0.011523</span></span><br><span class="line"><span class="hljs-number">260878</span>    <span class="hljs-number">0.020934</span></span><br><span class="line"><span class="hljs-number">260879</span>    <span class="hljs-number">0.029959</span></span><br><span class="line"><span class="hljs-number">260880</span>    <span class="hljs-number">0.038930</span></span><br><span class="line"><span class="hljs-number">260881</span>    <span class="hljs-number">0.047817</span></span><br><span class="line"><span class="hljs-number">260882</span>    <span class="hljs-number">0.056579</span></span><br><span class="line"><span class="hljs-number">260883</span>    <span class="hljs-number">0.065155</span></span><br><span class="line"><span class="hljs-number">260884</span>    <span class="hljs-number">0.073414</span></span><br><span class="line"><span class="hljs-number">260885</span>    <span class="hljs-number">0.081528</span></span><br><span class="line"><span class="hljs-number">260886</span>    <span class="hljs-number">0.089621</span></span><br><span class="line">Name: prop, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: prop_cumsum.values.searchsorted(<span class="hljs-number">0.5</span>)</span><br><span class="line">Out[<span class="hljs-number">122</span>]: <span class="hljs-number">116</span></span><br></pre></td></tr></table></figure>

<p>由于数组索引是从0开始的，因此我们要给这个结果加1，即最终结果为117。拿1900年的数据来做个比较，这个数字要小得多：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">123</span>]: df = boys[boys.year == <span class="hljs-number">1900</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">124</span>]: in1900 = df.sort_values(by=<span class="hljs-string">'prop'</span>, ascending=<span class="hljs-literal">False</span>).prop.cumsum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: in1900.values.searchsorted(<span class="hljs-number">0.5</span>) + <span class="hljs-number">1</span></span><br><span class="line">Out[<span class="hljs-number">125</span>]: <span class="hljs-number">25</span></span><br></pre></td></tr></table></figure>

<p>现在就可以对所有year/sex组合执行这个计算了。按这两个字段进行groupby处理，然后用一个函数计算各分组的这个值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_quantile_count</span><span class="hljs-params">(group, q=<span class="hljs-number">0.5</span>)</span>:</span></span><br><span class="line">    group = group.sort_values(by=<span class="hljs-string">'prop'</span>, ascending=<span class="hljs-literal">False</span>)</span><br><span class="line">    <span class="hljs-keyword">return</span> group.prop.cumsum().values.searchsorted(q) + <span class="hljs-number">1</span></span><br><span class="line"></span><br><span class="line">diversity = top1000.groupby([<span class="hljs-string">'year'</span>, <span class="hljs-string">'sex'</span>]).apply(get_quantile_count)</span><br><span class="line">diversity = diversity.unstack(<span class="hljs-string">'sex'</span>)</span><br></pre></td></tr></table></figure>

<p>现在，diversity这个DataFrame拥有两个时间序列（每个性别各一个，按年度索引）。通过IPython，你可以查看其内容，还可以像之前那样绘制图表（如图14-7所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">128</span>]: diversity.head()</span><br><span class="line">Out[<span class="hljs-number">128</span>]: </span><br><span class="line">sex    F   M</span><br><span class="line">year        </span><br><span class="line"><span class="hljs-number">1880</span>  <span class="hljs-number">38</span>  <span class="hljs-number">14</span></span><br><span class="line"><span class="hljs-number">1881</span>  <span class="hljs-number">38</span>  <span class="hljs-number">14</span></span><br><span class="line"><span class="hljs-number">1882</span>  <span class="hljs-number">38</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">1883</span>  <span class="hljs-number">39</span>  <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">1884</span>  <span class="hljs-number">39</span>  <span class="hljs-number">16</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">129</span>]: diversity.plot(title=<span class="hljs-string">"Number of popular names in top 50%"</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-574b53a383cad681.webp" alt="img"></p>
<p>图14-7 按年度统计的密度表</p>
<p>从图中可以看出，女孩名字的多样性总是比男孩的高，而且还在变得越来越高。读者们可以自己分析一下具体是什么在驱动这个多样性（比如拼写形式的变化）。</p>
<h2 id="“最后一个字母”的变革"><a href="#“最后一个字母”的变革" class="headerlink" title="“最后一个字母”的变革"></a>“最后一个字母”的变革</h2><p>2007年，一名婴儿姓名研究人员Laura Wattenberg在她自己的网站上指出（<a href="http://www.babynamewizard.com/" target="_blank" rel="noopener">http://www.babynamewizard.com</a>）：近百年来，男孩名字在最后一个字母上的分布发生了显著的变化。为了了解具体的情况，我首先将全部出生数据在年度、性别以及末字母上进行了聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># extract last letter from name column</span></span><br><span class="line">get_last_letter = <span class="hljs-keyword">lambda</span> x: x[<span class="hljs-number">-1</span>]</span><br><span class="line">last_letters = names.name.map(get_last_letter)</span><br><span class="line">last_letters.name = <span class="hljs-string">'last_letter'</span></span><br><span class="line"></span><br><span class="line">table = names.pivot_table(<span class="hljs-string">'births'</span>, index=last_letters,</span><br><span class="line">                          columns=[<span class="hljs-string">'sex'</span>, <span class="hljs-string">'year'</span>], aggfunc=sum)</span><br></pre></td></tr></table></figure>

<p>然后，我选出具有一定代表性的三年，并输出前面几行：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">131</span>]: subtable = table.reindex(columns=[<span class="hljs-number">1910</span>, <span class="hljs-number">1960</span>, <span class="hljs-number">2010</span>], level=<span class="hljs-string">'year'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: subtable.head()</span><br><span class="line">Out[<span class="hljs-number">132</span>]: </span><br><span class="line">sex                 F                            M                    </span><br><span class="line">year             <span class="hljs-number">1910</span>      <span class="hljs-number">1960</span>      <span class="hljs-number">2010</span>     <span class="hljs-number">1910</span>      <span class="hljs-number">1960</span>      <span class="hljs-number">2010</span></span><br><span class="line">last_letter                                                           </span><br><span class="line">a            <span class="hljs-number">108376.0</span>  <span class="hljs-number">691247.0</span>  <span class="hljs-number">670605.0</span>    <span class="hljs-number">977.0</span>    <span class="hljs-number">5204.0</span>   <span class="hljs-number">28438.0</span></span><br><span class="line">b                 NaN     <span class="hljs-number">694.0</span>     <span class="hljs-number">450.0</span>    <span class="hljs-number">411.0</span>    <span class="hljs-number">3912.0</span>   <span class="hljs-number">38859.0</span></span><br><span class="line">c                 <span class="hljs-number">5.0</span>      <span class="hljs-number">49.0</span>     <span class="hljs-number">946.0</span>    <span class="hljs-number">482.0</span>   <span class="hljs-number">15476.0</span>   <span class="hljs-number">23125.0</span></span><br><span class="line">d              <span class="hljs-number">6750.0</span>    <span class="hljs-number">3729.0</span>    <span class="hljs-number">2607.0</span>  <span class="hljs-number">22111.0</span>  <span class="hljs-number">262112.0</span>   <span class="hljs-number">44398.0</span></span><br><span class="line">e            <span class="hljs-number">133569.0</span>  <span class="hljs-number">435013.0</span>  <span class="hljs-number">313833.0</span>  <span class="hljs-number">28655.0</span>  <span class="hljs-number">178823.0</span>  <span class="hljs-number">129012.0</span></span><br></pre></td></tr></table></figure>

<p>接下来我们需要按总出生数对该表进行规范化处理，以便计算出各性别各末字母占总出生人数的比例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">133</span>]: subtable.sum()</span><br><span class="line">Out[<span class="hljs-number">133</span>]: </span><br><span class="line">sex  year</span><br><span class="line">F    <span class="hljs-number">1910</span>     <span class="hljs-number">396416.0</span></span><br><span class="line">     <span class="hljs-number">1960</span>    <span class="hljs-number">2022062.0</span></span><br><span class="line">     <span class="hljs-number">2010</span>    <span class="hljs-number">1759010.0</span></span><br><span class="line">M    <span class="hljs-number">1910</span>     <span class="hljs-number">194198.0</span></span><br><span class="line">     <span class="hljs-number">1960</span>    <span class="hljs-number">2132588.0</span></span><br><span class="line"><span class="hljs-number">2010</span>    <span class="hljs-number">1898382.0</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: letter_prop = subtable / subtable.sum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">135</span>]: letter_prop</span><br><span class="line">Out[<span class="hljs-number">135</span>]: </span><br><span class="line">sex                 F                             M                    </span><br><span class="line">year             <span class="hljs-number">1910</span>      <span class="hljs-number">1960</span>      <span class="hljs-number">2010</span>      <span class="hljs-number">1910</span>      <span class="hljs-number">1960</span>      <span class="hljs-number">2010</span></span><br><span class="line">last_letter                                                            </span><br><span class="line">a            <span class="hljs-number">0.273390</span>  <span class="hljs-number">0.341853</span>  <span class="hljs-number">0.381240</span>  <span class="hljs-number">0.005031</span>  <span class="hljs-number">0.002440</span>  <span class="hljs-number">0.014980</span></span><br><span class="line">b                 NaN  <span class="hljs-number">0.000343</span>  <span class="hljs-number">0.000256</span>  <span class="hljs-number">0.002116</span>  <span class="hljs-number">0.001834</span>  <span class="hljs-number">0.020470</span></span><br><span class="line">c            <span class="hljs-number">0.000013</span>  <span class="hljs-number">0.000024</span>  <span class="hljs-number">0.000538</span>  <span class="hljs-number">0.002482</span>  <span class="hljs-number">0.007257</span>  <span class="hljs-number">0.012181</span></span><br><span class="line">d            <span class="hljs-number">0.017028</span>  <span class="hljs-number">0.001844</span>  <span class="hljs-number">0.001482</span>  <span class="hljs-number">0.113858</span>  <span class="hljs-number">0.122908</span>  <span class="hljs-number">0.023387</span></span><br><span class="line">e            <span class="hljs-number">0.336941</span>  <span class="hljs-number">0.215133</span>  <span class="hljs-number">0.178415</span>  <span class="hljs-number">0.147556</span>  <span class="hljs-number">0.083853</span>  <span class="hljs-number">0.067959</span></span><br><span class="line"><span class="hljs-meta">... </span>              ...       ...       ...       ...       ...       ...</span><br><span class="line">v                 NaN  <span class="hljs-number">0.000060</span>  <span class="hljs-number">0.000117</span>  <span class="hljs-number">0.000113</span></span><br><span class="line"><span class="hljs-number">0.000037</span>  <span class="hljs-number">0.001434</span></span><br><span class="line">w            <span class="hljs-number">0.000020</span>  <span class="hljs-number">0.000031</span>  <span class="hljs-number">0.001182</span>  <span class="hljs-number">0.006329</span>  <span class="hljs-number">0.007711</span>  <span class="hljs-number">0.016148</span></span><br><span class="line">x            <span class="hljs-number">0.000015</span>  <span class="hljs-number">0.000037</span>  <span class="hljs-number">0.000727</span>  <span class="hljs-number">0.003965</span>  <span class="hljs-number">0.001851</span>  <span class="hljs-number">0.008614</span></span><br><span class="line">y            <span class="hljs-number">0.110972</span>  <span class="hljs-number">0.152569</span>  <span class="hljs-number">0.116828</span>  <span class="hljs-number">0.077349</span>  <span class="hljs-number">0.160987</span>  <span class="hljs-number">0.058168</span></span><br><span class="line">z            <span class="hljs-number">0.002439</span>  <span class="hljs-number">0.000659</span>  <span class="hljs-number">0.000704</span>  <span class="hljs-number">0.000170</span>  <span class="hljs-number">0.000184</span>  <span class="hljs-number">0.001831</span></span><br><span class="line">[<span class="hljs-number">26</span> rows x <span class="hljs-number">6</span> columns]</span><br></pre></td></tr></table></figure>

<p>有了这个字母比例数据之后，就可以生成一张各年度各性别的条形图了，如图14-8所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt</span><br><span class="line"></span><br><span class="line">fig, axes = plt.subplots(<span class="hljs-number">2</span>, <span class="hljs-number">1</span>, figsize=(<span class="hljs-number">10</span>, <span class="hljs-number">8</span>))</span><br><span class="line">letter_prop[<span class="hljs-string">'M'</span>].plot(kind=<span class="hljs-string">'bar'</span>, rot=<span class="hljs-number">0</span>, ax=axes[<span class="hljs-number">0</span>], title=<span class="hljs-string">'Male'</span>)</span><br><span class="line">letter_prop[<span class="hljs-string">'F'</span>].plot(kind=<span class="hljs-string">'bar'</span>, rot=<span class="hljs-number">0</span>, ax=axes[<span class="hljs-number">1</span>], title=<span class="hljs-string">'Female'</span>,</span><br><span class="line">                      legend=<span class="hljs-literal">False</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-67686f38e66ef5f1.webp" alt="img"></p>
<p>图14-8 男孩女孩名字中各个末字母的比例</p>
<p>可以看出，从20世纪60年代开始，以字母”n”结尾的男孩名字出现了显著的增长。回到之前创建的那个完整表，按年度和性别对其进行规范化处理，并在男孩名字中选取几个字母，最后进行转置以便将各个列做成一个时间序列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">138</span>]: letter_prop = table / table.sum()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">139</span>]: dny_ts = letter_prop.loc[[<span class="hljs-string">'d'</span>, <span class="hljs-string">'n'</span>, <span class="hljs-string">'y'</span>], <span class="hljs-string">'M'</span>].T</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">140</span>]: dny_ts.head()</span><br><span class="line">Out[<span class="hljs-number">140</span>]: </span><br><span class="line">last_letter         d         n         y</span><br><span class="line">year                                     </span><br><span class="line"><span class="hljs-number">1880</span>         <span class="hljs-number">0.083055</span>  <span class="hljs-number">0.153213</span>  <span class="hljs-number">0.075760</span></span><br><span class="line"><span class="hljs-number">1881</span>         <span class="hljs-number">0.083247</span>  <span class="hljs-number">0.153214</span>  <span class="hljs-number">0.077451</span></span><br><span class="line"><span class="hljs-number">1882</span>         <span class="hljs-number">0.085340</span>  <span class="hljs-number">0.149560</span>  <span class="hljs-number">0.077537</span></span><br><span class="line"><span class="hljs-number">1883</span>         <span class="hljs-number">0.084066</span>  <span class="hljs-number">0.151646</span>  <span class="hljs-number">0.079144</span></span><br><span class="line"><span class="hljs-number">1884</span>         <span class="hljs-number">0.086120</span>  <span class="hljs-number">0.149915</span>  <span class="hljs-number">0.080405</span></span><br></pre></td></tr></table></figure>

<p>有了这个时间序列的DataFrame之后，就可以通过其plot方法绘制出一张趋势图了（如图14-9所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">143</span>]: dny_ts.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-51c431b2490424c2.webp" alt="img"></p>
<p>图14-9 各年出生的男孩中名字以d/n/y结尾的人数比例</p>
<h2 id="变成女孩名字的男孩名字（以及相反的情况）"><a href="#变成女孩名字的男孩名字（以及相反的情况）" class="headerlink" title="变成女孩名字的男孩名字（以及相反的情况）"></a>变成女孩名字的男孩名字（以及相反的情况）</h2><p>另一个有趣的趋势是，早年流行于男孩的名字近年来“变性了”，例如Lesley或Leslie。回到top1000数据集，找出其中以”lesl”开头的一组名字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">144</span>]: all_names = pd.Series(top1000.name.unique())</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">145</span>]: lesley_like = all_names[all_names.str.lower().str.contains(<span class="hljs-string">'lesl'</span>)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">146</span>]: lesley_like</span><br><span class="line">Out[<span class="hljs-number">146</span>]: </span><br><span class="line"><span class="hljs-number">632</span>     Leslie</span><br><span class="line"><span class="hljs-number">2294</span>    Lesley</span><br><span class="line"><span class="hljs-number">4262</span>    Leslee</span><br><span class="line"><span class="hljs-number">4728</span>     Lesli</span><br><span class="line"><span class="hljs-number">6103</span>     Lesly</span><br><span class="line">dtype: object</span><br></pre></td></tr></table></figure>

<p>然后利用这个结果过滤其他的名字，并按名字分组计算出生数以查看相对频率：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">147</span>]: filtered = top1000[top1000.name.isin(lesley_like)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">148</span>]: filtered.groupby(<span class="hljs-string">'name'</span>).births.sum()</span><br><span class="line">Out[<span class="hljs-number">148</span>]: </span><br><span class="line">name</span><br><span class="line">Leslee      <span class="hljs-number">1082</span></span><br><span class="line">Lesley     <span class="hljs-number">35022</span></span><br><span class="line">Lesli        <span class="hljs-number">929</span></span><br><span class="line">Leslie    <span class="hljs-number">370429</span></span><br><span class="line">Lesly      <span class="hljs-number">10067</span></span><br><span class="line">Name: births, dtype: int64</span><br></pre></td></tr></table></figure>

<p>接下来，我们按性别和年度进行聚合，并按年度进行规范化处理：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">149</span>]: table = filtered.pivot_table(<span class="hljs-string">'births'</span>, index=<span class="hljs-string">'year'</span>,</span><br><span class="line">   .....:                              columns=<span class="hljs-string">'sex'</span>, aggfunc=<span class="hljs-string">'sum'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">150</span>]: table = table.div(table.sum(<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">151</span>]: table.tail()</span><br><span class="line">Out[<span class="hljs-number">151</span>]: </span><br><span class="line">sex     F   M</span><br><span class="line">year         </span><br><span class="line"><span class="hljs-number">2006</span>  <span class="hljs-number">1.0</span> NaN</span><br><span class="line"><span class="hljs-number">2007</span>  <span class="hljs-number">1.0</span> NaN</span><br><span class="line"><span class="hljs-number">2008</span>  <span class="hljs-number">1.0</span> NaN</span><br><span class="line"><span class="hljs-number">2009</span>  <span class="hljs-number">1.0</span> NaN</span><br><span class="line"><span class="hljs-number">2010</span>  <span class="hljs-number">1.0</span> NaN</span><br></pre></td></tr></table></figure>

<p>最后，就可以轻松绘制一张分性别的年度曲线图了（如图2-10所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">153</span>]: table.plot(style=&#123;<span class="hljs-string">'M'</span>: <span class="hljs-string">'k-'</span>, <span class="hljs-string">'F'</span>: <span class="hljs-string">'k--'</span>&#125;)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-b99d98f8bb5fc695.webp" alt="img"></p>
<p>图14-10 各年度使用“Lesley型”名字的男女比例</p>
<h1 id="14-4-USDA食品数据库"><a href="#14-4-USDA食品数据库" class="headerlink" title="14.4 USDA食品数据库"></a>14.4 USDA食品数据库</h1><p>美国农业部（USDA）制作了一份有关食物营养信息的数据库。Ashley Williams制作了该数据的JSON版（<a href="http://ashleyw.co.uk/project/food-nutrient-database）。其中的记录如下所示：" target="_blank" rel="noopener">http://ashleyw.co.uk/project/food-nutrient-database）。其中的记录如下所示：</a></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="hljs-string">"id"</span>: <span class="hljs-number">21441</span>,</span><br><span class="line">  <span class="hljs-string">"description"</span>: <span class="hljs-string">"KENTUCKY FRIED CHICKEN, Fried Chicken, EXTRA CRISPY,</span></span><br><span class="line"><span class="hljs-string">Wing, meat and skin with breading"</span>,</span><br><span class="line">  <span class="hljs-string">"tags"</span>: [<span class="hljs-string">"KFC"</span>],</span><br><span class="line">  <span class="hljs-string">"manufacturer"</span>: <span class="hljs-string">"Kentucky Fried Chicken"</span>,</span><br><span class="line"><span class="hljs-string">"group"</span>: <span class="hljs-string">"Fast Foods"</span>,</span><br><span class="line">  <span class="hljs-string">"portions"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="hljs-string">"amount"</span>: <span class="hljs-number">1</span>,</span><br><span class="line">      <span class="hljs-string">"unit"</span>: <span class="hljs-string">"wing, with skin"</span>,</span><br><span class="line">      <span class="hljs-string">"grams"</span>: <span class="hljs-number">68.0</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  ],</span><br><span class="line">  <span class="hljs-string">"nutrients"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="hljs-string">"value"</span>: <span class="hljs-number">20.8</span>,</span><br><span class="line">      <span class="hljs-string">"units"</span>: <span class="hljs-string">"g"</span>,</span><br><span class="line">      <span class="hljs-string">"description"</span>: <span class="hljs-string">"Protein"</span>,</span><br><span class="line">      <span class="hljs-string">"group"</span>: <span class="hljs-string">"Composition"</span></span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>每种食物都带有若干标识性属性以及两个有关营养成分和分量的列表。这种形式的数据不是很适合分析工作，因此我们需要做一些规整化以使其具有更好用的形式。</p>
<p>从上面列举的那个网址下载并解压数据之后，你可以用任何喜欢的JSON库将其加载到Python中。我用的是Python内置的json模块：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">154</span>]: <span class="hljs-keyword">import</span> json</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">155</span>]: db = json.load(open(<span class="hljs-string">'datasets/usda_food/database.json'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">156</span>]: len(db)</span><br><span class="line">Out[<span class="hljs-number">156</span>]: <span class="hljs-number">6636</span></span><br></pre></td></tr></table></figure>

<p>db中的每个条目都是一个含有某种食物全部数据的字典。nutrients字段是一个字典列表，其中的每个字典对应一种营养成分：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">157</span>]: db[<span class="hljs-number">0</span>].keys()</span><br><span class="line">Out[<span class="hljs-number">157</span>]: dict_keys([<span class="hljs-string">'id'</span>, <span class="hljs-string">'description'</span>, <span class="hljs-string">'tags'</span>, <span class="hljs-string">'manufacturer'</span>, <span class="hljs-string">'group'</span>, <span class="hljs-string">'porti</span></span><br><span class="line"><span class="hljs-string">ons'</span>, <span class="hljs-string">'nutrients'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: db[<span class="hljs-number">0</span>][<span class="hljs-string">'nutrients'</span>][<span class="hljs-number">0</span>]</span><br><span class="line">Out[<span class="hljs-number">158</span>]: </span><br><span class="line">&#123;<span class="hljs-string">'description'</span>: <span class="hljs-string">'Protein'</span>,</span><br><span class="line"> <span class="hljs-string">'group'</span>: <span class="hljs-string">'Composition'</span>,</span><br><span class="line"> <span class="hljs-string">'units'</span>: <span class="hljs-string">'g'</span>,</span><br><span class="line"> <span class="hljs-string">'value'</span>: <span class="hljs-number">25.18</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">159</span>]: nutrients = pd.DataFrame(db[<span class="hljs-number">0</span>][<span class="hljs-string">'nutrients'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">160</span>]: nutrients[:<span class="hljs-number">7</span>]</span><br><span class="line">Out[<span class="hljs-number">160</span>]: </span><br><span class="line">                   description        group units    value</span><br><span class="line"><span class="hljs-number">0</span>                      Protein  Composition     g    <span class="hljs-number">25.18</span></span><br><span class="line"><span class="hljs-number">1</span>            Total lipid (fat)  Composition     g    <span class="hljs-number">29.20</span></span><br><span class="line"><span class="hljs-number">2</span>  Carbohydrate, by difference  Composition     g     <span class="hljs-number">3.06</span></span><br><span class="line"><span class="hljs-number">3</span>                          Ash        Other     g     <span class="hljs-number">3.28</span></span><br><span class="line"><span class="hljs-number">4</span>                       Energy       Energy  kcal   <span class="hljs-number">376.00</span></span><br><span class="line"><span class="hljs-number">5</span>                        Water  Composition     g    <span class="hljs-number">39.28</span></span><br><span class="line"><span class="hljs-number">6</span>                       Energy       Energy    kJ  <span class="hljs-number">1573.00</span></span><br></pre></td></tr></table></figure>

<p>在将字典列表转换为DataFrame时，可以只抽取其中的一部分字段。这里，我们将取出食物的名称、分类、编号以及制造商等信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">161</span>]: info_keys = [<span class="hljs-string">'description'</span>, <span class="hljs-string">'group'</span>, <span class="hljs-string">'id'</span>, <span class="hljs-string">'manufacturer'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: info = pd.DataFrame(db, columns=info_keys)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">163</span>]: info[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">163</span>]: </span><br><span class="line">                          description                   group    id  \</span><br><span class="line"><span class="hljs-number">0</span>                     Cheese, caraway  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1008</span>   </span><br><span class="line"><span class="hljs-number">1</span>                     Cheese, cheddar  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1009</span></span><br><span class="line"><span class="hljs-number">2</span>                        Cheese, edam  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1018</span>   </span><br><span class="line"><span class="hljs-number">3</span>                        Cheese, feta  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1019</span>   </span><br><span class="line"><span class="hljs-number">4</span>  Cheese, mozzarella, part skim milk  Dairy <span class="hljs-keyword">and</span> Egg Products  <span class="hljs-number">1028</span>   </span><br><span class="line">  manufacturer  </span><br><span class="line"><span class="hljs-number">0</span>               </span><br><span class="line"><span class="hljs-number">1</span>               </span><br><span class="line"><span class="hljs-number">2</span>               </span><br><span class="line"><span class="hljs-number">3</span>               </span><br><span class="line"><span class="hljs-number">4</span>               </span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">164</span>]: info.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">RangeIndex</span>:</span> <span class="hljs-number">6636</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">6635</span></span><br><span class="line">Data columns (total <span class="hljs-number">4</span> columns):</span><br><span class="line">description     <span class="hljs-number">6636</span> non-null object</span><br><span class="line">group           <span class="hljs-number">6636</span> non-null object</span><br><span class="line">id              <span class="hljs-number">6636</span> non-null int64</span><br><span class="line">manufacturer    <span class="hljs-number">5195</span> non-null object</span><br><span class="line">dtypes: int64(<span class="hljs-number">1</span>), object(<span class="hljs-number">3</span>)</span><br><span class="line">memory usage: <span class="hljs-number">207.5</span>+ KB</span><br></pre></td></tr></table></figure>

<p>通过value_counts，你可以查看食物类别的分布情况：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">165</span>]: pd.value_counts(info.group)[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">165</span>]: </span><br><span class="line">Vegetables <span class="hljs-keyword">and</span> Vegetable Products    <span class="hljs-number">812</span></span><br><span class="line">Beef Products                        <span class="hljs-number">618</span></span><br><span class="line">Baked Products                       <span class="hljs-number">496</span></span><br><span class="line">Breakfast Cereals                    <span class="hljs-number">403</span></span><br><span class="line">Fast Foods                           <span class="hljs-number">365</span></span><br><span class="line">Legumes <span class="hljs-keyword">and</span> Legume Products          <span class="hljs-number">365</span></span><br><span class="line">Lamb, Veal, <span class="hljs-keyword">and</span> Game Products        <span class="hljs-number">345</span></span><br><span class="line">Sweets                               <span class="hljs-number">341</span></span><br><span class="line">Pork Products                        <span class="hljs-number">328</span></span><br><span class="line">Fruits <span class="hljs-keyword">and</span> Fruit Juices              <span class="hljs-number">328</span></span><br><span class="line">Name: group, dtype: int64</span><br></pre></td></tr></table></figure>

<p>现在，为了对全部营养数据做一些分析，最简单的办法是将所有食物的营养成分整合到一个大表中。我们分几个步骤来实现该目的。首先，将各食物的营养成分列表转换为一个DataFrame，并添加一个表示编号的列，然后将该DataFrame添加到一个列表中。最后通过concat将这些东西连接起来就可以了：</p>
<p>顺利的话，nutrients的结果是：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">167</span>]: nutrients</span><br><span class="line">Out[<span class="hljs-number">167</span>]: </span><br><span class="line">                               description        group units    value     id</span><br><span class="line"><span class="hljs-number">0</span>                                  Protein  Composition     g   <span class="hljs-number">25.180</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">1</span>                        Total lipid (fat)  Composition     g   <span class="hljs-number">29.200</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">2</span>              Carbohydrate, by difference  Composition     g    <span class="hljs-number">3.060</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">3</span>                                      Ash        Other     g    <span class="hljs-number">3.280</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">4</span>                                   Energy       Energy  kcal  <span class="hljs-number">376.000</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-meta">... </span>                                   ...          ...</span><br><span class="line"><span class="hljs-meta">... </span>     ...    ...</span><br><span class="line"><span class="hljs-number">389350</span>                 Vitamin B<span class="hljs-number">-12</span>, added     Vitamins   mcg    <span class="hljs-number">0.000</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389351</span>                         Cholesterol        Other    mg    <span class="hljs-number">0.000</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389352</span>        Fatty acids, total saturated        Other     g    <span class="hljs-number">0.072</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389353</span>  Fatty acids, total monounsaturated        Other     g    <span class="hljs-number">0.028</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389354</span>  Fatty acids, total polyunsaturated        Other     g    <span class="hljs-number">0.041</span>  <span class="hljs-number">43546</span></span><br><span class="line">[<span class="hljs-number">389355</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>我发现这个DataFrame中无论如何都会有一些重复项，所以直接丢弃就可以了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">168</span>]: nutrients.duplicated().sum()  <span class="hljs-comment"># number of duplicates</span></span><br><span class="line">Out[<span class="hljs-number">168</span>]: <span class="hljs-number">14179</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">169</span>]: nutrients = nutrients.drop_duplicates()</span><br></pre></td></tr></table></figure>

<p>由于两个DataFrame对象中都有”group”和”description”，所以为了明确到底谁是谁，我们需要对它们进行重命名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">170</span>]: col_mapping = &#123;<span class="hljs-string">'description'</span> : <span class="hljs-string">'food'</span>,</span><br><span class="line">   .....:                <span class="hljs-string">'group'</span>       : <span class="hljs-string">'fgroup'</span>&#125;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">171</span>]: info = info.rename(columns=col_mapping, copy=<span class="hljs-literal">False</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">172</span>]: info.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">RangeIndex</span>:</span> <span class="hljs-number">6636</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">6635</span></span><br><span class="line">Data columns (total <span class="hljs-number">4</span> columns):</span><br><span class="line">food            <span class="hljs-number">6636</span> non-null object</span><br><span class="line">fgroup          <span class="hljs-number">6636</span> non-null object</span><br><span class="line">id              <span class="hljs-number">6636</span> non-null int64</span><br><span class="line">manufacturer    <span class="hljs-number">5195</span> non-null object</span><br><span class="line">dtypes: int64(<span class="hljs-number">1</span>), object(<span class="hljs-number">3</span>)</span><br><span class="line">memory usage: <span class="hljs-number">207.5</span>+ KB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">173</span>]: col_mapping = &#123;<span class="hljs-string">'description'</span> : <span class="hljs-string">'nutrient'</span>,</span><br><span class="line">   .....:                <span class="hljs-string">'group'</span> : <span class="hljs-string">'nutgroup'</span>&#125;</span><br><span class="line">In [<span class="hljs-number">174</span>]: nutrients = nutrients.rename(columns=col_mapping, copy=<span class="hljs-literal">False</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">175</span>]: nutrients</span><br><span class="line">Out[<span class="hljs-number">175</span>]: </span><br><span class="line">                                  nutrient     nutgroup units    value     id</span><br><span class="line"><span class="hljs-number">0</span>                                  Protein  Composition     g   <span class="hljs-number">25.180</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">1</span>                        Total lipid (fat)  Composition     g   <span class="hljs-number">29.200</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">2</span>              Carbohydrate, by difference  Composition     g    <span class="hljs-number">3.060</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">3</span>                                      Ash        Other     g    <span class="hljs-number">3.280</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-number">4</span>                                   Energy       Energy  kcal  <span class="hljs-number">376.000</span>   <span class="hljs-number">1008</span></span><br><span class="line"><span class="hljs-meta">... </span>                                   ...          ...   ...      ...    ...</span><br><span class="line"><span class="hljs-number">389350</span>                 Vitamin B<span class="hljs-number">-12</span>, added     Vitamins   mcg    <span class="hljs-number">0.000</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389351</span>                         Cholesterol        Other    mg    <span class="hljs-number">0.000</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389352</span>        Fatty acids, total saturated        Other     g    <span class="hljs-number">0.072</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389353</span>  Fatty acids, total monounsaturated        Other     g    <span class="hljs-number">0.028</span>  <span class="hljs-number">43546</span></span><br><span class="line"><span class="hljs-number">389354</span>  Fatty acids, total polyunsaturated        Other     g    <span class="hljs-number">0.041</span>  <span class="hljs-number">43546</span></span><br><span class="line">[<span class="hljs-number">375176</span> rows x <span class="hljs-number">5</span> columns]</span><br></pre></td></tr></table></figure>

<p>做完这些，就可以将info跟nutrients合并起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">176</span>]: ndata = pd.merge(nutrients, info, on=<span class="hljs-string">'id'</span>, how=<span class="hljs-string">'outer'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">177</span>]: ndata.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">Int64Index</span>:</span> <span class="hljs-number">375176</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">375175</span></span><br><span class="line">Data columns (total <span class="hljs-number">8</span> columns):</span><br><span class="line">nutrient        <span class="hljs-number">375176</span> non-null object</span><br><span class="line">nutgroup        <span class="hljs-number">375176</span> non-null object</span><br><span class="line">units           <span class="hljs-number">375176</span> non-null object</span><br><span class="line">value           <span class="hljs-number">375176</span> non-null float64</span><br><span class="line">id              <span class="hljs-number">375176</span> non-null int64</span><br><span class="line">food            <span class="hljs-number">375176</span> non-null object</span><br><span class="line">fgroup          <span class="hljs-number">375176</span> non-null object</span><br><span class="line">manufacturer    <span class="hljs-number">293054</span> non-null object</span><br><span class="line">dtypes: float64(<span class="hljs-number">1</span>), int64(<span class="hljs-number">1</span>), object(<span class="hljs-number">6</span>)</span><br><span class="line">memory usage: <span class="hljs-number">25.8</span>+ MB</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">178</span>]: ndata.iloc[<span class="hljs-number">30000</span>]</span><br><span class="line">Out[<span class="hljs-number">178</span>]: </span><br><span class="line">nutrient                                       Glycine</span><br><span class="line">nutgroup                                   Amino Acids</span><br><span class="line">units                                                g</span><br><span class="line">value                                             <span class="hljs-number">0.04</span></span><br><span class="line">id                                                <span class="hljs-number">6158</span></span><br><span class="line">food            Soup, tomato bisque, canned, condensed</span><br><span class="line">fgroup                      Soups, Sauces, <span class="hljs-keyword">and</span> Gravies</span><br><span class="line">manufacturer                                          </span><br><span class="line">Name: <span class="hljs-number">30000</span>, dtype: object</span><br></pre></td></tr></table></figure>

<p>我们现在可以根据食物分类和营养类型画出一张中位值图（如图14-11所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">180</span>]: result = ndata.groupby([<span class="hljs-string">'nutrient'</span>, <span class="hljs-string">'fgroup'</span>])[<span class="hljs-string">'value'</span>].quantile(<span class="hljs-number">0.5</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">181</span>]: result[<span class="hljs-string">'Zinc, Zn'</span>].sort_values().plot(kind=<span class="hljs-string">'barh'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-99b176d022a444c0.webp" alt="img"></p>
<p>图片14-11 根据营养分类得出的锌中位值</p>
<p>只要稍微动一动脑子，就可以发现各营养成分最为丰富的食物是什么了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">by_nutrient = ndata.groupby([<span class="hljs-string">'nutgroup'</span>, <span class="hljs-string">'nutrient'</span>])</span><br><span class="line"></span><br><span class="line">get_maximum = <span class="hljs-keyword">lambda</span> x: x.loc[x.value.idxmax()]</span><br><span class="line">get_minimum = <span class="hljs-keyword">lambda</span> x: x.loc[x.value.idxmin()]</span><br><span class="line"></span><br><span class="line">max_foods = by_nutrient.apply(get_maximum)[[<span class="hljs-string">'value'</span>, <span class="hljs-string">'food'</span>]]</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># make the food a little smaller</span></span><br><span class="line">max_foods.food = max_foods.food.str[:<span class="hljs-number">50</span>]</span><br></pre></td></tr></table></figure>

<p>由于得到的DataFrame很大，所以不方便在书里面全部打印出来。这里只给出”Amino Acids”营养分组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">183</span>]: max_foods.loc[<span class="hljs-string">'Amino Acids'</span>][<span class="hljs-string">'food'</span>]</span><br><span class="line">Out[<span class="hljs-number">183</span>]: </span><br><span class="line">nutrient</span><br><span class="line">Alanine                          Gelatins, dry powder, unsweetened</span><br><span class="line">Arginine                              Seeds, sesame flour, low-fat</span><br><span class="line">Aspartic acid                                  Soy protein isolate</span><br><span class="line">Cystine               Seeds, cottonseed flour, low fat (glandless)</span><br><span class="line">Glutamic acid                                  Soy protein isolate</span><br><span class="line">                                       ...                        </span><br><span class="line">Serine           Soy protein isolate, PROTEIN TECHNOLOGIES INTE...</span><br><span class="line">Threonine        Soy protein isolate, PROTEIN TECHNOLOGIES INTE...</span><br><span class="line">Tryptophan        Sea lion, Steller, meat <span class="hljs-keyword">with</span> fat (Alaska Native)</span><br><span class="line">Tyrosine         Soy protein isolate, PROTEIN TECHNOLOGIES INTE...</span><br><span class="line">Valine           Soy protein isolate, PROTEIN TECHNOLOGIES INTE...</span><br><span class="line">Name: food, Length: <span class="hljs-number">19</span>, dtype: object</span><br></pre></td></tr></table></figure>

<h1 id="14-5-2012联邦选举委员会数据库"><a href="#14-5-2012联邦选举委员会数据库" class="headerlink" title="14.5 2012联邦选举委员会数据库"></a>14.5 2012联邦选举委员会数据库</h1><p>美国联邦选举委员会发布了有关政治竞选赞助方面的数据。其中包括赞助者的姓名、职业、雇主、地址以及出资额等信息。我们对2012年美国总统大选的数据集比较感兴趣（<a href="http://www.fec.gov/disclosurep/PDownload.do）。我在2012年6月下载的数据集是一个150MB的CSV文件（P00000001-ALL.csv），我们先用pandas.read_csv将其加载进来：" target="_blank" rel="noopener">http://www.fec.gov/disclosurep/PDownload.do）。我在2012年6月下载的数据集是一个150MB的CSV文件（P00000001-ALL.csv），我们先用pandas.read_csv将其加载进来：</a></p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">184</span>]: fec = pd.read_csv(<span class="hljs-string">'datasets/fec/P00000001-ALL.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">185</span>]: fec.info()</span><br><span class="line">&lt;<span class="hljs-class"><span class="hljs-keyword">class</span> '<span class="hljs-title">pandas</span>.<span class="hljs-title">core</span>.<span class="hljs-title">frame</span>.<span class="hljs-title">DataFrame</span>'&gt;</span></span><br><span class="line"><span class="hljs-class"><span class="hljs-title">RangeIndex</span>:</span> <span class="hljs-number">1001731</span> entries, <span class="hljs-number">0</span> to <span class="hljs-number">1001730</span></span><br><span class="line">Data columns (total <span class="hljs-number">16</span> columns):</span><br><span class="line">cmte_id              <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">cand_id              <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">cand_nm              <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">contbr_nm            <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">contbr_city          <span class="hljs-number">1001712</span> non-null object</span><br><span class="line">contbr_st            <span class="hljs-number">1001727</span> non-null object</span><br><span class="line">contbr_zip           <span class="hljs-number">1001620</span> non-null object</span><br><span class="line">contbr_employer      <span class="hljs-number">988002</span> non-null object</span><br><span class="line">contbr_occupation    <span class="hljs-number">993301</span> non-null object</span><br><span class="line">contb_receipt_amt    <span class="hljs-number">1001731</span> non-null float64</span><br><span class="line">contb_receipt_dt     <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">receipt_desc         <span class="hljs-number">14166</span> non-null object</span><br><span class="line">memo_cd              <span class="hljs-number">92482</span> non-null object</span><br><span class="line">memo_text            <span class="hljs-number">97770</span> non-null object</span><br><span class="line">form_tp              <span class="hljs-number">1001731</span> non-null object</span><br><span class="line">file_num             <span class="hljs-number">1001731</span> non-null int64</span><br><span class="line">dtypes: float64(<span class="hljs-number">1</span>), int64(<span class="hljs-number">1</span>), object(<span class="hljs-number">14</span>)</span><br><span class="line">memory usage: <span class="hljs-number">122.3</span>+ MB</span><br></pre></td></tr></table></figure>

<p>该DataFrame中的记录如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">186</span>]: fec.iloc[<span class="hljs-number">123456</span>]</span><br><span class="line">Out[<span class="hljs-number">186</span>]: </span><br><span class="line">cmte_id             C00431445</span><br><span class="line">cand_id             P80003338</span><br><span class="line">cand_nm         Obama, Barack</span><br><span class="line">contbr_nm         ELLMAN, IRA</span><br><span class="line">contbr_city             TEMPE</span><br><span class="line">                    ...      </span><br><span class="line">receipt_desc              NaN</span><br><span class="line">memo_cd                   NaN</span><br><span class="line">memo_text                 NaN</span><br><span class="line">form_tp                 SA17A</span><br><span class="line">file_num               <span class="hljs-number">772372</span></span><br><span class="line">Name: <span class="hljs-number">123456</span>, Length: <span class="hljs-number">16</span>, dtype: object</span><br></pre></td></tr></table></figure>

<p>你可能已经想出了许多办法从这些竞选赞助数据中抽取有关赞助人和赞助模式的统计信息。我将在接下来的内容中介绍几种不同的分析工作（运用到目前为止已经学到的方法）。</p>
<p>不难看出，该数据中没有党派信息，因此最好把它加进去。通过unique，你可以获取全部的候选人名单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">187</span>]: unique_cands = fec.cand_nm.unique()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">188</span>]: unique_cands</span><br><span class="line">Out[<span class="hljs-number">188</span>]: </span><br><span class="line">array([<span class="hljs-string">'Bachmann, Michelle'</span>, <span class="hljs-string">'Romney, Mitt'</span>, <span class="hljs-string">'Obama, Barack'</span>,</span><br><span class="line">       <span class="hljs-string">"Roemer, Charles E. 'Buddy' III"</span>, <span class="hljs-string">'Pawlenty, Timothy'</span>,</span><br><span class="line">       <span class="hljs-string">'Johnson, Gary Earl'</span>, <span class="hljs-string">'Paul, Ron'</span>, <span class="hljs-string">'Santorum, Rick'</span>, <span class="hljs-string">'Cain, Herman'</span>,</span><br><span class="line">       <span class="hljs-string">'Gingrich, Newt'</span>, <span class="hljs-string">'McCotter, Thaddeus G'</span>, <span class="hljs-string">'Huntsman, Jon'</span>,</span><br><span class="line">       <span class="hljs-string">'Perry, Rick'</span>], dtype=object)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">189</span>]: unique_cands[<span class="hljs-number">2</span>]</span><br><span class="line">Out[<span class="hljs-number">189</span>]: <span class="hljs-string">'Obama, Barack'</span></span><br></pre></td></tr></table></figure>

<p>指明党派信息的方法之一是使用字典：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">parties = &#123;<span class="hljs-string">'Bachmann, Michelle'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Cain, Herman'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Gingrich, Newt'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Huntsman, Jon'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Johnson, Gary Earl'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'McCotter, Thaddeus G'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Obama, Barack'</span>: <span class="hljs-string">'Democrat'</span>,</span><br><span class="line">           <span class="hljs-string">'Paul, Ron'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Pawlenty, Timothy'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Perry, Rick'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">"Roemer, Charles E. 'Buddy' III"</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Romney, Mitt'</span>: <span class="hljs-string">'Republican'</span>,</span><br><span class="line">           <span class="hljs-string">'Santorum, Rick'</span>: <span class="hljs-string">'Republican'</span>&#125;</span><br></pre></td></tr></table></figure>

<p>现在，通过这个映射以及Series对象的map方法，你可以根据候选人姓名得到一组党派信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">191</span>]: fec.cand_nm[<span class="hljs-number">123456</span>:<span class="hljs-number">123461</span>]</span><br><span class="line">Out[<span class="hljs-number">191</span>]: </span><br><span class="line"><span class="hljs-number">123456</span>    Obama, Barack</span><br><span class="line"><span class="hljs-number">123457</span>    Obama, Barack</span><br><span class="line"><span class="hljs-number">123458</span>    Obama, Barack</span><br><span class="line"><span class="hljs-number">123459</span>    Obama, Barack</span><br><span class="line"><span class="hljs-number">123460</span>    Obama, Barack</span><br><span class="line">Name: cand_nm, dtype: object</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">192</span>]: fec.cand_nm[<span class="hljs-number">123456</span>:<span class="hljs-number">123461</span>].map(parties)</span><br><span class="line">Out[<span class="hljs-number">192</span>]: </span><br><span class="line"><span class="hljs-number">123456</span>    Democrat</span><br><span class="line"><span class="hljs-number">123457</span>    Democrat</span><br><span class="line"><span class="hljs-number">123458</span>    Democrat</span><br><span class="line"><span class="hljs-number">123459</span>    Democrat</span><br><span class="line"><span class="hljs-number">123460</span>    Democrat</span><br><span class="line">Name: cand_nm, dtype: object</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># Add it as a column</span></span><br><span class="line">In [<span class="hljs-number">193</span>]: fec[<span class="hljs-string">'party'</span>] = fec.cand_nm.map(parties)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">194</span>]: fec[<span class="hljs-string">'party'</span>].value_counts()</span><br><span class="line">Out[<span class="hljs-number">194</span>]: </span><br><span class="line">Democrat      <span class="hljs-number">593746</span></span><br><span class="line">Republican    <span class="hljs-number">407985</span></span><br><span class="line">Name: party, dtype: int64</span><br></pre></td></tr></table></figure>

<p>这里有两个需要注意的地方。第一，该数据既包括赞助也包括退款（负的出资额）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">195</span>]: (fec.contb_receipt_amt &gt; <span class="hljs-number">0</span>).value_counts()</span><br><span class="line">Out[<span class="hljs-number">195</span>]: </span><br><span class="line"><span class="hljs-literal">True</span>     <span class="hljs-number">991475</span></span><br><span class="line"><span class="hljs-literal">False</span>     <span class="hljs-number">10256</span></span><br><span class="line">Name: contb_receipt_amt, dtype: int64</span><br></pre></td></tr></table></figure>

<p>为了简化分析过程，我限定该数据集只能有正的出资额：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">196</span>]: fec = fec[fec.contb_receipt_amt &gt; <span class="hljs-number">0</span>]</span><br></pre></td></tr></table></figure>

<p>由于Barack Obama和Mitt Romney是最主要的两名候选人，所以我还专门准备了一个子集，只包含针对他们两人的竞选活动的赞助信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">197</span>]: fec_mrbo = fec[fec.cand_nm.isin([<span class="hljs-string">'Obama, Barack'</span>,<span class="hljs-string">'Romney, Mitt'</span>])]</span><br></pre></td></tr></table></figure>

<h2 id="根据职业和雇主统计赞助信息"><a href="#根据职业和雇主统计赞助信息" class="headerlink" title="根据职业和雇主统计赞助信息"></a>根据职业和雇主统计赞助信息</h2><p>基于职业的赞助信息统计是另一种经常被研究的统计任务。例如，律师们更倾向于资助民主党，而企业主则更倾向于资助共和党。你可以不相信我，自己看那些数据就知道了。首先，根据职业计算出资总额，这很简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">198</span>]: fec.contbr_occupation.value_counts()[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">198</span>]: </span><br><span class="line">RETIRED                                   <span class="hljs-number">233990</span></span><br><span class="line">INFORMATION REQUESTED                      <span class="hljs-number">35107</span></span><br><span class="line">ATTORNEY                                   <span class="hljs-number">34286</span></span><br><span class="line">HOMEMAKER                                  <span class="hljs-number">29931</span></span><br><span class="line">PHYSICIAN                                  <span class="hljs-number">23432</span></span><br><span class="line">INFORMATION REQUESTED PER BEST EFFORTS     <span class="hljs-number">21138</span></span><br><span class="line">ENGINEER                                   <span class="hljs-number">14334</span></span><br><span class="line">TEACHER                                    <span class="hljs-number">13990</span></span><br><span class="line">CONSULTANT                                 <span class="hljs-number">13273</span></span><br><span class="line">PROFESSOR                                  <span class="hljs-number">12555</span></span><br><span class="line">Name: contbr_occupation, dtype: int64</span><br></pre></td></tr></table></figure>

<p>不难看出，许多职业都涉及相同的基本工作类型，或者同一样东西有多种变体。下面的代码片段可以清理一些这样的数据（将一个职业信息映射到另一个）。注意，这里巧妙地利用了dict.get，它允许没有映射关系的职业也能“通过”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">occ_mapping = &#123;</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED PER BEST EFFORTS'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED (BEST EFFORTS)'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'C.E.O.'</span>: <span class="hljs-string">'CEO'</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># If no mapping provided, return x</span></span><br><span class="line">f = <span class="hljs-keyword">lambda</span> x: occ_mapping.get(x, x)</span><br><span class="line">fec.contbr_occupation = fec.contbr_occupation.map(f)</span><br></pre></td></tr></table></figure>

<p>我对雇主信息也进行了同样的处理：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">emp_mapping = &#123;</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED PER BEST EFFORTS'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'INFORMATION REQUESTED'</span> : <span class="hljs-string">'NOT PROVIDED'</span>,</span><br><span class="line">   <span class="hljs-string">'SELF'</span> : <span class="hljs-string">'SELF-EMPLOYED'</span>,</span><br><span class="line">   <span class="hljs-string">'SELF EMPLOYED'</span> : <span class="hljs-string">'SELF-EMPLOYED'</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># If no mapping provided, return x</span></span><br><span class="line">f = <span class="hljs-keyword">lambda</span> x: emp_mapping.get(x, x)</span><br><span class="line">fec.contbr_employer = fec.contbr_employer.map(f)</span><br></pre></td></tr></table></figure>

<p>现在，你可以通过pivot_table根据党派和职业对数据进行聚合，然后过滤掉总出资额不足200万美元的数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">201</span>]: by_occupation = fec.pivot_table(<span class="hljs-string">'contb_receipt_amt'</span>,</span><br><span class="line">   .....:                                 index=<span class="hljs-string">'contbr_occupation'</span>,</span><br><span class="line">   .....:                                 columns=<span class="hljs-string">'party'</span>, aggfunc=<span class="hljs-string">'sum'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">202</span>]: over_2mm = by_occupation[by_occupation.sum(<span class="hljs-number">1</span>) &gt; <span class="hljs-number">2000000</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">203</span>]: over_2mm</span><br><span class="line">Out[<span class="hljs-number">203</span>]: </span><br><span class="line">party                 Democrat    Republican</span><br><span class="line">contbr_occupation                           </span><br><span class="line">ATTORNEY           <span class="hljs-number">11141982.97</span>  <span class="hljs-number">7.477194e+06</span></span><br><span class="line">CEO                 <span class="hljs-number">2074974.79</span>  <span class="hljs-number">4.211041e+06</span></span><br><span class="line">CONSULTANT          <span class="hljs-number">2459912.71</span>  <span class="hljs-number">2.544725e+06</span></span><br><span class="line">ENGINEER             <span class="hljs-number">951525.55</span>  <span class="hljs-number">1.818374e+06</span></span><br><span class="line">EXECUTIVE           <span class="hljs-number">1355161.05</span>  <span class="hljs-number">4.138850e+06</span></span><br><span class="line"><span class="hljs-meta">... </span>                       ...           ...</span><br><span class="line">PRESIDENT           <span class="hljs-number">1878509.95</span>  <span class="hljs-number">4.720924e+06</span></span><br><span class="line">PROFESSOR           <span class="hljs-number">2165071.08</span>  <span class="hljs-number">2.967027e+05</span></span><br><span class="line">REAL ESTATE          <span class="hljs-number">528902.09</span>  <span class="hljs-number">1.625902e+06</span></span><br><span class="line">RETIRED            <span class="hljs-number">25305116.38</span>  <span class="hljs-number">2.356124e+07</span></span><br><span class="line">SELF-EMPLOYED        <span class="hljs-number">672393.40</span>  <span class="hljs-number">1.640253e+06</span></span><br><span class="line">[<span class="hljs-number">17</span> rows x <span class="hljs-number">2</span> columns]</span><br></pre></td></tr></table></figure>

<p>把这些数据做成柱状图看起来会更加清楚（’barh’表示水平柱状图，如图14-12所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">205</span>]: over_2mm.plot(kind=<span class="hljs-string">'barh'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-d2254e547c6ce537.webp" alt="img"></p>
<p>图14-12 对各党派总出资额最高的职业</p>
<p>你可能还想了解一下对Obama和Romney总出资额最高的职业和企业。为此，我们先对候选人进行分组，然后使用本章前面介绍的类似top的方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">get_top_amounts</span><span class="hljs-params">(group, key, n=<span class="hljs-number">5</span>)</span>:</span></span><br><span class="line">    totals = group.groupby(key)[<span class="hljs-string">'contb_receipt_amt'</span>].sum()</span><br><span class="line">    <span class="hljs-keyword">return</span> totals.nlargest(n)</span><br></pre></td></tr></table></figure>

<p>然后根据职业和雇主进行聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">207</span>]: grouped = fec_mrbo.groupby(<span class="hljs-string">'cand_nm'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">208</span>]: grouped.apply(get_top_amounts, <span class="hljs-string">'contbr_occupation'</span>, n=<span class="hljs-number">7</span>)</span><br><span class="line">Out[<span class="hljs-number">208</span>]: </span><br><span class="line">cand_nm        contbr_occupation    </span><br><span class="line">Obama, Barack  RETIRED                  <span class="hljs-number">25305116.38</span></span><br><span class="line">               ATTORNEY                 <span class="hljs-number">11141982.97</span></span><br><span class="line">               INFORMATION REQUESTED     <span class="hljs-number">4866973.96</span></span><br><span class="line">               HOMEMAKER                 <span class="hljs-number">4248875.80</span></span><br><span class="line">               PHYSICIAN                 <span class="hljs-number">3735124.94</span></span><br><span class="line">                                           ...     </span><br><span class="line">Romney, Mitt   HOMEMAKER                 <span class="hljs-number">8147446.22</span></span><br><span class="line">               ATTORNEY                  <span class="hljs-number">5364718.82</span></span><br><span class="line">               PRESIDENT                 <span class="hljs-number">2491244.89</span></span><br><span class="line">               EXECUTIVE                 <span class="hljs-number">2300947.03</span></span><br><span class="line">               C.E.O.                    <span class="hljs-number">1968386.11</span></span><br><span class="line">Name: contb_receipt_amt, Length: <span class="hljs-number">14</span>, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">209</span>]: grouped.apply(get_top_amounts, <span class="hljs-string">'contbr_employer'</span>, n=<span class="hljs-number">10</span>)</span><br><span class="line">Out[<span class="hljs-number">209</span>]: </span><br><span class="line">cand_nm        contbr_employer      </span><br><span class="line">Obama, Barack  RETIRED                  <span class="hljs-number">22694358.85</span></span><br><span class="line">               SELF-EMPLOYED            <span class="hljs-number">17080985.96</span></span><br><span class="line">               NOT EMPLOYED              <span class="hljs-number">8586308.70</span></span><br><span class="line">               INFORMATION REQUESTED     <span class="hljs-number">5053480.37</span></span><br><span class="line">               HOMEMAKER                 <span class="hljs-number">2605408.54</span></span><br><span class="line">                                           ...     </span><br><span class="line">Romney, Mitt   CREDIT SUISSE              <span class="hljs-number">281150.00</span></span><br><span class="line">               MORGAN STANLEY             <span class="hljs-number">267266.00</span></span><br><span class="line">               GOLDMAN SACH &amp; CO.         <span class="hljs-number">238250.00</span></span><br><span class="line">               BARCLAYS CAPITAL           <span class="hljs-number">162750.00</span></span><br><span class="line">               H.I.G. CAPITAL             <span class="hljs-number">139500.00</span></span><br><span class="line">Name: contb_receipt_amt, Length: <span class="hljs-number">20</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="对出资额分组"><a href="#对出资额分组" class="headerlink" title="对出资额分组"></a>对出资额分组</h2><p>还可以对该数据做另一种非常实用的分析：利用cut函数根据出资额的大小将数据离散化到多个面元中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">210</span>]: bins = np.array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>, <span class="hljs-number">100</span>, <span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>,</span><br><span class="line">   .....:                  <span class="hljs-number">100000</span>, <span class="hljs-number">1000000</span>, <span class="hljs-number">10000000</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">211</span>]: labels = pd.cut(fec_mrbo.contb_receipt_amt, bins)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">212</span>]: labels</span><br><span class="line">Out[<span class="hljs-number">212</span>]: </span><br><span class="line"><span class="hljs-number">411</span>         (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line"><span class="hljs-number">412</span>       (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]</span><br><span class="line"><span class="hljs-number">413</span>       (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]</span><br><span class="line"><span class="hljs-number">414</span>         (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line"><span class="hljs-number">415</span>         (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line">             ...     </span><br><span class="line"><span class="hljs-number">701381</span>      (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line"><span class="hljs-number">701382</span>    (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]</span><br><span class="line"><span class="hljs-number">701383</span>        (<span class="hljs-number">1</span>, <span class="hljs-number">10</span>]</span><br><span class="line"><span class="hljs-number">701384</span>      (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]</span><br><span class="line"><span class="hljs-number">701385</span>    (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]</span><br><span class="line">Name: contb_receipt_amt, Length: <span class="hljs-number">694282</span>, dtype: category</span><br><span class="line">Categories (<span class="hljs-number">8</span>, interval[int64]): [(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>] &lt; (<span class="hljs-number">1</span>, <span class="hljs-number">10</span>] &lt; (<span class="hljs-number">10</span>, <span class="hljs-number">100</span>] &lt; (<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>] &lt; (<span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">000</span>, <span class="hljs-number">10000</span>] &lt;</span><br><span class="line">                                  (<span class="hljs-number">10000</span>, <span class="hljs-number">100000</span>] &lt; (<span class="hljs-number">100000</span>, <span class="hljs-number">1000000</span>] &lt; (<span class="hljs-number">1000000</span>,</span><br><span class="line"> <span class="hljs-number">10000000</span>]]</span><br></pre></td></tr></table></figure>

<p>现在可以根据候选人姓名以及面元标签对奥巴马和罗姆尼数据进行分组，以得到一个柱状图：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">213</span>]: grouped = fec_mrbo.groupby([<span class="hljs-string">'cand_nm'</span>, labels])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">214</span>]: grouped.size().unstack(<span class="hljs-number">0</span>)</span><br><span class="line">Out[<span class="hljs-number">214</span>]: </span><br><span class="line">cand_nm              Obama, Barack  Romney, Mitt</span><br><span class="line">contb_receipt_amt                               </span><br><span class="line">(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]                       <span class="hljs-number">493.0</span>          <span class="hljs-number">77.0</span></span><br><span class="line">(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>]                    <span class="hljs-number">40070.0</span>        <span class="hljs-number">3681.0</span></span><br><span class="line">(<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]                 <span class="hljs-number">372280.0</span>       <span class="hljs-number">31853.0</span></span><br><span class="line">(<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]               <span class="hljs-number">153991.0</span>       <span class="hljs-number">43357.0</span></span><br><span class="line">(<span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>]              <span class="hljs-number">22284.0</span>       <span class="hljs-number">26186.0</span></span><br><span class="line">(<span class="hljs-number">10000</span>, <span class="hljs-number">100000</span>]                <span class="hljs-number">2.0</span>           <span class="hljs-number">1.0</span></span><br><span class="line">(<span class="hljs-number">100000</span>, <span class="hljs-number">1000000</span>]              <span class="hljs-number">3.0</span>           NaN</span><br><span class="line">(<span class="hljs-number">1000000</span>, <span class="hljs-number">10000000</span>]            <span class="hljs-number">4.0</span>           NaN</span><br></pre></td></tr></table></figure>

<p>从这个数据中可以看出，在小额赞助方面，Obama获得的数量比Romney多得多。你还可以对出资额求和并在面元内规格化，以便图形化显示两位候选人各种赞助额度的比例（见图14-13）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">216</span>]: bucket_sums = grouped.contb_receipt_amt.sum().unstack(<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">217</span>]: normed_sums = bucket_sums.div(bucket_sums.sum(axis=<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">218</span>]: normed_sums</span><br><span class="line">Out[<span class="hljs-number">218</span>]: </span><br><span class="line">cand_nm              Obama, Barack  Romney, Mitt</span><br><span class="line">contb_receipt_amt                               </span><br><span class="line">(<span class="hljs-number">0</span>, <span class="hljs-number">1</span>]                    <span class="hljs-number">0.805182</span>      <span class="hljs-number">0.194818</span></span><br><span class="line">(<span class="hljs-number">1</span>, <span class="hljs-number">10</span>]                   <span class="hljs-number">0.918767</span>      <span class="hljs-number">0.081233</span></span><br><span class="line">(<span class="hljs-number">10</span>, <span class="hljs-number">100</span>]                 <span class="hljs-number">0.910769</span>      <span class="hljs-number">0.089231</span></span><br><span class="line">(<span class="hljs-number">100</span>, <span class="hljs-number">1000</span>]               <span class="hljs-number">0.710176</span>      <span class="hljs-number">0.289824</span></span><br><span class="line">(<span class="hljs-number">1000</span>, <span class="hljs-number">10000</span>]             <span class="hljs-number">0.447326</span>      <span class="hljs-number">0.552674</span></span><br><span class="line">(<span class="hljs-number">10000</span>, <span class="hljs-number">100000</span>]           <span class="hljs-number">0.823120</span>      <span class="hljs-number">0.176880</span></span><br><span class="line">(<span class="hljs-number">100000</span>, <span class="hljs-number">1000000</span>]         <span class="hljs-number">1.000000</span>           NaN</span><br><span class="line">(<span class="hljs-number">1000000</span>, <span class="hljs-number">10000000</span>]       <span class="hljs-number">1.000000</span>           NaN</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">219</span>]: normed_sums[:<span class="hljs-number">-2</span>].plot(kind=<span class="hljs-string">'barh'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-77e8c8d3c784692b.webp" alt="img"></p>
<p>图14-13 两位候选人收到的各种捐赠额度的总额比例</p>
<p>我排除了两个最大的面元，因为这些不是由个人捐赠的。</p>
<p>还可以对该分析过程做许多的提炼和改进。比如说，可以根据赞助人的姓名和邮编对数据进行聚合，以便找出哪些人进行了多次小额捐款，哪些人又进行了一次或多次大额捐款。我强烈建议你下载这些数据并自己摸索一下。</p>
<h2 id="根据州统计赞助信息"><a href="#根据州统计赞助信息" class="headerlink" title="根据州统计赞助信息"></a>根据州统计赞助信息</h2><p>根据候选人和州对数据进行聚合是常规操作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">220</span>]: grouped = fec_mrbo.groupby([<span class="hljs-string">'cand_nm'</span>, <span class="hljs-string">'contbr_st'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">221</span>]: totals = grouped.contb_receipt_amt.sum().unstack(<span class="hljs-number">0</span>).fillna(<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">222</span>]: totals = totals[totals.sum(<span class="hljs-number">1</span>) &gt; <span class="hljs-number">100000</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">223</span>]: totals[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">223</span>]: </span><br><span class="line">cand_nm    Obama, Barack  Romney, Mitt</span><br><span class="line">contbr_st                             </span><br><span class="line">AK             <span class="hljs-number">281840.15</span>      <span class="hljs-number">86204.24</span></span><br><span class="line">AL             <span class="hljs-number">543123.48</span>     <span class="hljs-number">527303.51</span></span><br><span class="line">AR             <span class="hljs-number">359247.28</span>     <span class="hljs-number">105556.00</span></span><br><span class="line">AZ            <span class="hljs-number">1506476.98</span>    <span class="hljs-number">1888436.23</span></span><br><span class="line">CA           <span class="hljs-number">23824984.24</span>   <span class="hljs-number">11237636.60</span></span><br><span class="line">CO            <span class="hljs-number">2132429.49</span>    <span class="hljs-number">1506714.12</span></span><br><span class="line">CT            <span class="hljs-number">2068291.26</span>    <span class="hljs-number">3499475.45</span></span><br><span class="line">DC            <span class="hljs-number">4373538.80</span>    <span class="hljs-number">1025137.50</span></span><br><span class="line">DE             <span class="hljs-number">336669.14</span>      <span class="hljs-number">82712.00</span></span><br><span class="line">FL            <span class="hljs-number">7318178.58</span>    <span class="hljs-number">8338458.81</span></span><br></pre></td></tr></table></figure>

<p>如果对各行除以总赞助额，就会得到各候选人在各州的总赞助额比例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">224</span>]: percent = totals.div(totals.sum(<span class="hljs-number">1</span>), axis=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">225</span>]: percent[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">225</span>]: </span><br><span class="line">cand_nm    Obama, Barack  Romney, Mitt</span><br><span class="line">contbr_st                             </span><br><span class="line">AK              <span class="hljs-number">0.765778</span>      <span class="hljs-number">0.234222</span></span><br><span class="line">AL              <span class="hljs-number">0.507390</span>      <span class="hljs-number">0.492610</span></span><br><span class="line">AR              <span class="hljs-number">0.772902</span>      <span class="hljs-number">0.227098</span></span><br><span class="line">AZ              <span class="hljs-number">0.443745</span>      <span class="hljs-number">0.556255</span></span><br><span class="line">CA              <span class="hljs-number">0.679498</span>      <span class="hljs-number">0.320502</span></span><br><span class="line">CO              <span class="hljs-number">0.585970</span>      <span class="hljs-number">0.414030</span></span><br><span class="line">CT              <span class="hljs-number">0.371476</span>      <span class="hljs-number">0.628524</span></span><br><span class="line">DC              <span class="hljs-number">0.810113</span>      <span class="hljs-number">0.189887</span></span><br><span class="line">DE              <span class="hljs-number">0.802776</span>      <span class="hljs-number">0.197224</span></span><br><span class="line">FL              <span class="hljs-number">0.467417</span>      <span class="hljs-number">0.532583</span></span><br></pre></td></tr></table></figure>

<h1 id="14-6-总结"><a href="#14-6-总结" class="headerlink" title="14.6 总结"></a>14.6 总结</h1><p>我们已经完成了正文的最后一章。附录中有一些额外的内容，可能对你有用。</p>
<p>本书第一版出版已经有5年了，Python已经成为了一个流行的、广泛使用的数据分析语言。你从本书中学到的方法，在相当长的一段时间都是可用的。我希望本书介绍的工具和库对你的工作有用。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-05T01:51:29.000Z">2019-10-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 9287 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC11%E7%AB%A0%20%E6%97%B6%E9%97%B4%E5%BA%8F%E5%88%97/">《利用Python进行数据分析·第2版》第11章 时间序列</a>
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/29ece4592178" target="_blank" rel="noopener">简书</a></p>
<p><a href="https://www.jianshu.com/p/04d180d90a3f" target="_blank" rel="noopener">第1章 准备工作</a>
<a href="https://www.jianshu.com/p/fc93e943e94a" target="_blank" rel="noopener">第2章 Python语法基础，IPython和Jupyter</a>
<a href="https://www.jianshu.com/p/b444cda10aa0" target="_blank" rel="noopener">第3章 Python的数据结构、函数和文件</a>
<a href="https://www.jianshu.com/p/a380222a3292" target="_blank" rel="noopener">第4章 NumPy基础：数组和矢量计算</a>
<a href="https://www.jianshu.com/p/161364dd0acf" target="_blank" rel="noopener">第5章 pandas入门</a>
<a href="https://www.jianshu.com/p/047d8c1c7e14" target="_blank" rel="noopener">第6章 数据加载、存储与文件格式</a>
<a href="https://www.jianshu.com/p/ac7bec000dad" target="_blank" rel="noopener">第7章 数据清洗和准备</a>
<a href="https://www.jianshu.com/p/cfc035bae567" target="_blank" rel="noopener">第8章 数据规整：聚合、合并和重塑</a>
<a href="https://www.jianshu.com/p/7a0eafdd1340" target="_blank" rel="noopener">第9章 绘图和可视化</a>
<a href="https://www.jianshu.com/p/b94deb5c7eb1" target="_blank" rel="noopener">第10章 数据聚合与分组运算</a>
第11章 时间序列
<a href="https://www.jianshu.com/p/9d093ebcc5d8" target="_blank" rel="noopener">第12章 pandas高级应用</a>
<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">第13章 Python建模库介绍</a>
<a href="https://www.jianshu.com/p/72b6c83bb69e" target="_blank" rel="noopener">第14章 数据分析案例</a>
<a href="https://www.jianshu.com/p/3c3f7da88516" target="_blank" rel="noopener">附录A NumPy高级应用</a>
<a href="https://www.jianshu.com/p/fb6719a18cea" target="_blank" rel="noopener">附录B 更多关于IPython的内容（完）</a></p>
<hr>
<p>时间序列（time series）数据是一种重要的结构化数据形式，应用于多个领域，包括金融学、经济学、生态学、神经科学、物理学等。在多个时间点观察或测量到的任何事物都可以形成一段时间序列。很多时间序列是固定频率的，也就是说，数据点是根据某种规律定期出现的（比如每15秒、每5分钟、每月出现一次）。时间序列也可以是不定期的，没有固定的时间单位或单位之间的偏移量。时间序列数据的意义取决于具体的应用场景，主要有以下几种：</p>
<ul>
<li>时间戳（timestamp），特定的时刻。</li>
<li>固定时期（period），如2007年1月或2010年全年。</li>
<li>时间间隔（interval），由起始和结束时间戳表示。时期（period）可以被看做间隔（interval）的特例。</li>
<li>实验或过程时间，每个时间点都是相对于特定起始时间的一个度量。例如，从放入烤箱时起，每秒钟饼干的直径。</li>
</ul>
<p>本章主要讲解前3种时间序列。许多技术都可用于处理实验型时间序列，其索引可能是一个整数或浮点数（表示从实验开始算起已经过去的时间）。最简单也最常见的时间序列都是用时间戳进行索引的。</p>
<blockquote>
<p>提示：pandas也支持基于timedeltas的指数，它可以有效代表实验或经过的时间。这本书不涉及timedelta指数，但你可以学习pandas的文档（<a href="http://pandas.pydata.org/）。" target="_blank" rel="noopener">http://pandas.pydata.org/）。</a></p>
</blockquote>
<p>pandas提供了许多内置的时间序列处理工具和数据算法。因此，你可以高效处理非常大的时间序列，轻松地进行切片/切块、聚合、对定期/不定期的时间序列进行重采样等。有些工具特别适合金融和经济应用，你当然也可以用它们来分析服务器日志数据。</p>
<h1 id="11-1-日期和时间数据类型及工具"><a href="#11-1-日期和时间数据类型及工具" class="headerlink" title="11.1 日期和时间数据类型及工具"></a>11.1 日期和时间数据类型及工具</h1><p>Python标准库包含用于日期（date）和时间（time）数据的数据类型，而且还有日历方面的功能。我们主要会用到datetime、time以及calendar模块。datetime.datetime（也可以简写为datetime）是用得最多的数据类型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: now = datetime.now()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: now</span><br><span class="line">Out[<span class="hljs-number">12</span>]: datetime.datetime(<span class="hljs-number">2017</span>, <span class="hljs-number">9</span>, <span class="hljs-number">25</span>, <span class="hljs-number">14</span>, <span class="hljs-number">5</span>, <span class="hljs-number">52</span>, <span class="hljs-number">72973</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: now.year, now.month, now.day</span><br><span class="line">Out[<span class="hljs-number">13</span>]: (<span class="hljs-number">2017</span>, <span class="hljs-number">9</span>, <span class="hljs-number">25</span>)</span><br></pre></td></tr></table></figure>

<p>datetime以毫秒形式存储日期和时间。timedelta表示两个datetime对象之间的时间差：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">14</span>]: delta = datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>) - datetime(<span class="hljs-number">2008</span>, <span class="hljs-number">6</span>, <span class="hljs-number">24</span>, <span class="hljs-number">8</span>, <span class="hljs-number">15</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: delta</span><br><span class="line">Out[<span class="hljs-number">15</span>]: datetime.timedelta(<span class="hljs-number">926</span>, <span class="hljs-number">56700</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">16</span>]: delta.days</span><br><span class="line">Out[<span class="hljs-number">16</span>]: <span class="hljs-number">926</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: delta.seconds</span><br><span class="line">Out[<span class="hljs-number">17</span>]: <span class="hljs-number">56700</span></span><br></pre></td></tr></table></figure>

<p>可以给datetime对象加上（或减去）一个或多个timedelta，这样会产生一个新对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> timedelta</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: start = datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: start + timedelta(<span class="hljs-number">12</span>)</span><br><span class="line">Out[<span class="hljs-number">20</span>]: datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">19</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: start - <span class="hljs-number">2</span> * timedelta(<span class="hljs-number">12</span>)</span><br><span class="line">Out[<span class="hljs-number">21</span>]: datetime.datetime(<span class="hljs-number">2010</span>, <span class="hljs-number">12</span>, <span class="hljs-number">14</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>datetime模块中的数据类型参见表10-1。虽然本章主要讲的是pandas数据类型和高级时间序列处理，但你肯定会在Python的其他地方遇到有关datetime的数据类型。</p>
<p>表11-1 datetime模块中的数据类型</p>
<p><img src="/images/blog/7178691-4af261a305a70aeb.webp" alt="img"></p>
<p>tzinfo 存储时区信息的基本类型</p>
<h2 id="字符串和datetime的相互转换"><a href="#字符串和datetime的相互转换" class="headerlink" title="字符串和datetime的相互转换"></a>字符串和datetime的相互转换</h2><p>利用str或strftime方法（传入一个格式化字符串），datetime对象和pandas的Timestamp对象（稍后就会介绍）可以被格式化为字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">22</span>]: stamp = datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: str(stamp)</span><br><span class="line">Out[<span class="hljs-number">23</span>]: <span class="hljs-string">'2011-01-03 00:00:00'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">24</span>]: stamp.strftime(<span class="hljs-string">'%Y-%m-%d'</span>)</span><br><span class="line">Out[<span class="hljs-number">24</span>]: <span class="hljs-string">'2011-01-03'</span></span><br></pre></td></tr></table></figure>

<p>表11-2列出了全部的格式化编码。</p>
<p>表11-2 datetime格式定义（兼容ISO C89）</p>
<p><img src="/images/blog/7178691-50c751823754df58.webp" alt="img"></p>
<p><img src="/images/blog/7178691-de0181e1f6b45eaf.webp" alt="img"></p>
<p>datetime.strptime可以用这些格式化编码将字符串转换为日期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">25</span>]: value = <span class="hljs-string">'2011-01-03'</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">26</span>]: datetime.strptime(value, <span class="hljs-string">'%Y-%m-%d'</span>)</span><br><span class="line">Out[<span class="hljs-number">26</span>]: datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: datestrs = [<span class="hljs-string">'7/6/2011'</span>, <span class="hljs-string">'8/6/2011'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: [datetime.strptime(x, <span class="hljs-string">'%m/%d/%Y'</span>) <span class="hljs-keyword">for</span> x <span class="hljs-keyword">in</span> datestrs]</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">[datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">7</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>),</span><br><span class="line"> datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">8</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)]</span><br></pre></td></tr></table></figure>

<p>datetime.strptime是通过已知格式进行日期解析的最佳方式。但是每次都要编写格式定义是很麻烦的事情，尤其是对于一些常见的日期格式。这种情况下，你可以用dateutil这个第三方包中的parser.parse方法（pandas中已经自动安装好了）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: <span class="hljs-keyword">from</span> dateutil.parser <span class="hljs-keyword">import</span> parse</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: parse(<span class="hljs-string">'2011-01-03'</span>)</span><br><span class="line">Out[<span class="hljs-number">30</span>]: datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">3</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>dateutil可以解析几乎所有人类能够理解的日期表示形式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">31</span>]: parse(<span class="hljs-string">'Jan 31, 1997 10:45 PM'</span>)</span><br><span class="line">Out[<span class="hljs-number">31</span>]: datetime.datetime(<span class="hljs-number">1997</span>, <span class="hljs-number">1</span>, <span class="hljs-number">31</span>, <span class="hljs-number">22</span>, <span class="hljs-number">45</span>)</span><br></pre></td></tr></table></figure>

<p>在国际通用的格式中，日出现在月的前面很普遍，传入dayfirst=True即可解决这个问题：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">32</span>]: parse(<span class="hljs-string">'6/12/2011'</span>, dayfirst=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">32</span>]: datetime.datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">12</span>, <span class="hljs-number">6</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>pandas通常是用于处理成组日期的，不管这些日期是DataFrame的轴索引还是列。to_datetime方法可以解析多种不同的日期表示形式。对标准日期格式（如ISO8601）的解析非常快：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: datestrs = [<span class="hljs-string">'2011-07-06 12:00:00'</span>, <span class="hljs-string">'2011-08-06 00:00:00'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: pd.to_datetime(datestrs)</span><br><span class="line">Out[<span class="hljs-number">34</span>]: DatetimeIndex([<span class="hljs-string">'2011-07-06 12:00:00'</span>, <span class="hljs-string">'2011-08-06 00:00:00'</span>], dtype=<span class="hljs-string">'dat</span></span><br><span class="line"><span class="hljs-string">etime64[ns]'</span>, freq=<span class="hljs-literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>它还可以处理缺失值（None、空字符串等）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: idx = pd.to_datetime(datestrs + [<span class="hljs-literal">None</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: idx</span><br><span class="line">Out[<span class="hljs-number">36</span>]: DatetimeIndex([<span class="hljs-string">'2011-07-06 12:00:00'</span>, <span class="hljs-string">'2011-08-06 00:00:00'</span>, <span class="hljs-string">'NaT'</span>], dty</span><br><span class="line">pe=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-literal">None</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">37</span>]: idx[<span class="hljs-number">2</span>]</span><br><span class="line">Out[<span class="hljs-number">37</span>]: NaT</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">38</span>]: pd.isnull(idx)</span><br><span class="line">Out[<span class="hljs-number">38</span>]: array([<span class="hljs-literal">False</span>, <span class="hljs-literal">False</span>,  <span class="hljs-literal">True</span>], dtype=bool)</span><br></pre></td></tr></table></figure>

<p>NaT（Not a Time）是pandas中时间戳数据的null值。</p>
<blockquote>
<p>注意：dateutil.parser是一个实用但不完美的工具。比如说，它会把一些原本不是日期的字符串认作是日期（比如”42”会被解析为2042年的今天）。</p>
</blockquote>
<p>datetime对象还有一些特定于当前环境（位于不同国家或使用不同语言的系统）的格式化选项。例如，德语或法语系统所用的月份简写就与英语系统所用的不同。表11-3进行了总结。</p>
<p>表11-3 特定于当前环境的日期格式</p>
<p><img src="/images/blog/7178691-cf0119398273e2b0.webp" alt="img"></p>
<h1 id="11-2-时间序列基础"><a href="#11-2-时间序列基础" class="headerlink" title="11.2 时间序列基础"></a>11.2 时间序列基础</h1><p>pandas最基本的时间序列类型就是以时间戳（通常以Python字符串或datatime对象表示）为索引的Series：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: <span class="hljs-keyword">from</span> datetime <span class="hljs-keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: dates = [datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">2</span>), datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">5</span>),</span><br><span class="line">   ....:          datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>), datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">8</span>),</span><br><span class="line">   ....:          datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">10</span>), datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">12</span>)]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: ts = pd.Series(np.random.randn(<span class="hljs-number">6</span>), index=dates)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">42</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">42</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>这些datetime对象实际上是被放在一个DatetimeIndex中的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">43</span>]: ts.index</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2011-01-02'</span>, <span class="hljs-string">'2011-01-05'</span>, <span class="hljs-string">'2011-01-07'</span>, <span class="hljs-string">'2011-01-08'</span>,</span><br><span class="line">               <span class="hljs-string">'2011-01-10'</span>, <span class="hljs-string">'2011-01-12'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-literal">None</span>)</span><br></pre></td></tr></table></figure>

<p>跟其他Series一样，不同索引的时间序列之间的算术运算会自动按日期对齐：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: ts + ts[::<span class="hljs-number">2</span>]</span><br><span class="line">Out[<span class="hljs-number">44</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.409415</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>         NaN</span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-1.038877</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>         NaN</span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">3.931561</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>         NaN</span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>ts[::2] 是每隔两个取一个。</p>
<p>pandas用NumPy的datetime64数据类型以纳秒形式存储时间戳：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">45</span>]: ts.index.dtype</span><br><span class="line">Out[<span class="hljs-number">45</span>]: dtype(<span class="hljs-string">'&lt;M8[ns]'</span>)</span><br></pre></td></tr></table></figure>

<p>DatetimeIndex中的各个标量值是pandas的Timestamp对象：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">46</span>]: stamp = ts.index[<span class="hljs-number">0</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: stamp</span><br><span class="line">Out[<span class="hljs-number">47</span>]: Timestamp(<span class="hljs-string">'2011-01-02 00:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>只要有需要，TimeStamp可以随时自动转换为datetime对象。此外，它还可以存储频率信息（如果有的话），且知道如何执行时区转换以及其他操作。稍后将对此进行详细讲解。</p>
<h2 id="索引、选取、子集构造"><a href="#索引、选取、子集构造" class="headerlink" title="索引、选取、子集构造"></a>索引、选取、子集构造</h2><p>当你根据标签索引选取数据时，时间序列和其它的pandas.Series很像：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">48</span>]: stamp = ts.index[<span class="hljs-number">2</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">49</span>]: ts[stamp]</span><br><span class="line">Out[<span class="hljs-number">49</span>]: <span class="hljs-number">-0.51943871505673811</span></span><br></pre></td></tr></table></figure>

<p>还有一种更为方便的用法：传入一个可以被解释为日期的字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">50</span>]: ts[<span class="hljs-string">'1/10/2011'</span>]</span><br><span class="line">Out[<span class="hljs-number">50</span>]: <span class="hljs-number">1.9657805725027142</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">51</span>]: ts[<span class="hljs-string">'20110110'</span>]</span><br><span class="line">Out[<span class="hljs-number">51</span>]: <span class="hljs-number">1.9657805725027142</span></span><br></pre></td></tr></table></figure>

<p>对于较长的时间序列，只需传入“年”或“年月”即可轻松选取数据的切片：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">52</span>]: longer_ts = pd.Series(np.random.randn(<span class="hljs-number">1000</span>),</span><br><span class="line">   ....:                       index=pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">1000</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: longer_ts</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.092908</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">0.281746</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.769023</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>    <span class="hljs-number">1.246435</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">1.007189</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>   <span class="hljs-number">-1.296221</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>    <span class="hljs-number">0.274992</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>    <span class="hljs-number">0.228913</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>    <span class="hljs-number">1.352917</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">0.886429</span></span><br><span class="line">                ...   </span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-17</span>   <span class="hljs-number">-0.139298</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-18</span>   <span class="hljs-number">-1.159926</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-19</span>    <span class="hljs-number">0.618965</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-20</span>    <span class="hljs-number">1.373890</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-21</span>   <span class="hljs-number">-0.983505</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-22</span>    <span class="hljs-number">0.930944</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-23</span>   <span class="hljs-number">-0.811676</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-24</span>   <span class="hljs-number">-1.830156</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-25</span>   <span class="hljs-number">-0.138730</span></span><br><span class="line"><span class="hljs-number">2002</span><span class="hljs-number">-09</span><span class="hljs-number">-26</span>    <span class="hljs-number">0.334088</span></span><br><span class="line">Freq: D, Length: <span class="hljs-number">1000</span>, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">54</span>]: longer_ts[<span class="hljs-string">'2001'</span>]</span><br><span class="line">Out[<span class="hljs-number">54</span>]: </span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">1.599534</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">0.474071</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.151326</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>   <span class="hljs-number">-0.542173</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>   <span class="hljs-number">-0.475496</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>    <span class="hljs-number">0.106403</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-1.308228</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>    <span class="hljs-number">2.173185</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>    <span class="hljs-number">0.564561</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>   <span class="hljs-number">-0.190481</span></span><br><span class="line">                ...   </span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-22</span>    <span class="hljs-number">0.000369</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-23</span>    <span class="hljs-number">0.900885</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-24</span>   <span class="hljs-number">-0.454869</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-25</span>   <span class="hljs-number">-0.864547</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-26</span>    <span class="hljs-number">1.129120</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-27</span>    <span class="hljs-number">0.057874</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-28</span>   <span class="hljs-number">-0.433739</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.092698</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-30</span>   <span class="hljs-number">-1.397820</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>    <span class="hljs-number">1.457823</span></span><br><span class="line">Freq: D, Length: <span class="hljs-number">365</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>这里，字符串“2001”被解释成年，并根据它选取时间区间。指定月也同样奏效：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">55</span>]: longer_ts[<span class="hljs-string">'2001-05'</span>]</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.622547</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-02</span>    <span class="hljs-number">0.936289</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.750018</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-04</span>   <span class="hljs-number">-0.056715</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-05</span>    <span class="hljs-number">2.300675</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-06</span>    <span class="hljs-number">0.569497</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-07</span>    <span class="hljs-number">1.489410</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-08</span>    <span class="hljs-number">1.264250</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-09</span>   <span class="hljs-number">-0.761837</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-10</span>   <span class="hljs-number">-0.331617</span></span><br><span class="line">                ...   </span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-22</span>    <span class="hljs-number">0.503699</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-23</span>   <span class="hljs-number">-1.387874</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-24</span>    <span class="hljs-number">0.204851</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-25</span>    <span class="hljs-number">0.603705</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-26</span>    <span class="hljs-number">0.545680</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-27</span>    <span class="hljs-number">0.235477</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-28</span>    <span class="hljs-number">0.111835</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-29</span>   <span class="hljs-number">-1.251504</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-30</span>   <span class="hljs-number">-2.949343</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.634634</span></span><br><span class="line">Freq: D, Length: <span class="hljs-number">31</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>datetime对象也可以进行切片：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: ts[datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">1</span>, <span class="hljs-number">7</span>):]</span><br><span class="line">Out[<span class="hljs-number">56</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>由于大部分时间序列数据都是按照时间先后排序的，因此你也可以用不存在于该时间序列中的时间戳对其进行切片（即范围查询）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">57</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">57</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">58</span>]: ts[<span class="hljs-string">'1/6/2011'</span>:<span class="hljs-string">'1/11/2011'</span>]</span><br><span class="line">Out[<span class="hljs-number">58</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>跟之前一样，你可以传入字符串日期、datetime或Timestamp。注意，这样切片所产生的是原时间序列的视图，跟NumPy数组的切片运算是一样的。</p>
<p>这意味着，没有数据被复制，对切片进行修改会反映到原始数据上。</p>
<p>此外，还有一个等价的实例方法也可以截取两个日期之间TimeSeries：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">59</span>]: ts.truncate(after=<span class="hljs-string">'1/9/2011'</span>)</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>面这些操作对DataFrame也有效。例如，对DataFrame的行进行索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">60</span>]: dates = pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">100</span>, freq=<span class="hljs-string">'W-WED'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: long_df = pd.DataFrame(np.random.randn(<span class="hljs-number">100</span>, <span class="hljs-number">4</span>),</span><br><span class="line">   ....:                        index=dates,</span><br><span class="line">   ....:                        columns=[<span class="hljs-string">'Colorado'</span>, <span class="hljs-string">'Texas'</span>,</span><br><span class="line">   ....:                                 <span class="hljs-string">'New York'</span>, <span class="hljs-string">'Ohio'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: long_df.loc[<span class="hljs-string">'5-2001'</span>]</span><br><span class="line">Out[<span class="hljs-number">62</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-02</span> <span class="hljs-number">-0.006045</span>  <span class="hljs-number">0.490094</span> <span class="hljs-number">-0.277186</span> <span class="hljs-number">-0.707213</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-09</span> <span class="hljs-number">-0.560107</span>  <span class="hljs-number">2.735527</span>  <span class="hljs-number">0.927335</span>  <span class="hljs-number">1.513906</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-16</span>  <span class="hljs-number">0.538600</span>  <span class="hljs-number">1.273768</span>  <span class="hljs-number">0.667876</span> <span class="hljs-number">-0.969206</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-23</span>  <span class="hljs-number">1.676091</span> <span class="hljs-number">-0.817649</span>  <span class="hljs-number">0.050188</span>  <span class="hljs-number">1.951312</span></span><br><span class="line"><span class="hljs-number">2001</span><span class="hljs-number">-05</span><span class="hljs-number">-30</span>  <span class="hljs-number">3.260383</span>  <span class="hljs-number">0.963301</span>  <span class="hljs-number">1.201206</span> <span class="hljs-number">-1.852001</span></span><br></pre></td></tr></table></figure>

<h2 id="带有重复索引的时间序列"><a href="#带有重复索引的时间序列" class="headerlink" title="带有重复索引的时间序列"></a>带有重复索引的时间序列</h2><p>在某些应用场景中，可能会存在多个观测数据落在同一个时间点上的情况。下面就是一个例子：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">63</span>]: dates = pd.DatetimeIndex([<span class="hljs-string">'1/1/2000'</span>, <span class="hljs-string">'1/2/2000'</span>, <span class="hljs-string">'1/2/2000'</span>,</span><br><span class="line">   ....:                           <span class="hljs-string">'1/2/2000'</span>, <span class="hljs-string">'1/3/2000'</span>])</span><br><span class="line">In [<span class="hljs-number">64</span>]: dup_ts = pd.Series(np.arange(<span class="hljs-number">5</span>), index=dates)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">65</span>]: dup_ts</span><br><span class="line">Out[<span class="hljs-number">65</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>通过检查索引的is_unique属性，我们就可以知道它是不是唯一的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: dup_ts.index.is_unique</span><br><span class="line">Out[<span class="hljs-number">66</span>]: <span class="hljs-literal">False</span></span><br></pre></td></tr></table></figure>

<p>对这个时间序列进行索引，要么产生标量值，要么产生切片，具体要看所选的时间点是否重复：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">67</span>]: dup_ts[<span class="hljs-string">'1/3/2000'</span>]  <span class="hljs-comment"># not duplicated</span></span><br><span class="line">Out[<span class="hljs-number">67</span>]: <span class="hljs-number">4</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">68</span>]: dup_ts[<span class="hljs-string">'1/2/2000'</span>]  <span class="hljs-comment"># duplicated</span></span><br><span class="line">Out[<span class="hljs-number">68</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">3</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>假设你想要对具有非唯一时间戳的数据进行聚合。一个办法是使用groupby，并传入level=0：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">69</span>]: grouped = dup_ts.groupby(level=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">70</span>]: grouped.mean()</span><br><span class="line">Out[<span class="hljs-number">70</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">4</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">71</span>]: grouped.count()</span><br><span class="line">Out[<span class="hljs-number">71</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">1</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h1 id="11-3-日期的范围、频率以及移动"><a href="#11-3-日期的范围、频率以及移动" class="headerlink" title="11.3 日期的范围、频率以及移动"></a>11.3 日期的范围、频率以及移动</h1><p>pandas中的原生时间序列一般被认为是不规则的，也就是说，它们没有固定的频率。对于大部分应用程序而言，这是无所谓的。但是，它常常需要以某种相对固定的频率进行分析，比如每日、每月、每15分钟等（这样自然会在时间序列中引入缺失值）。幸运的是，pandas有一整套标准时间序列频率以及用于重采样、频率推断、生成固定频率日期范围的工具。例如，我们可以将之前那个时间序列转换为一个具有固定频率（每日）的时间序列，只需调用resample即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">72</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">72</span>]: </span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.204708</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">0.478943</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-0.519439</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.555730</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.965781</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span>    <span class="hljs-number">1.393406</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">73</span>]: resampler = ts.resample(<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>字符串“D”是每天的意思。</p>
<p>频率的转换（或重采样）是一个比较大的主题，稍后将专门用一节来进行讨论（11.6小节）。这里，我将告诉你如何使用基本的频率和它的倍数。</p>
<h2 id="生成日期范围"><a href="#生成日期范围" class="headerlink" title="生成日期范围"></a>生成日期范围</h2><p>虽然我之前用的时候没有明说，但你可能已经猜到pandas.date_range可用于根据指定的频率生成指定长度的DatetimeIndex：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: index = pd.date_range(<span class="hljs-string">'2012-04-01'</span>, <span class="hljs-string">'2012-06-01'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">75</span>]: index</span><br><span class="line">Out[<span class="hljs-number">75</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-04-01'</span>, <span class="hljs-string">'2012-04-02'</span>, <span class="hljs-string">'2012-04-03'</span>, <span class="hljs-string">'2012-04-04'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-05'</span>, <span class="hljs-string">'2012-04-06'</span>, <span class="hljs-string">'2012-04-07'</span>, <span class="hljs-string">'2012-04-08'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-09'</span>, <span class="hljs-string">'2012-04-10'</span>, <span class="hljs-string">'2012-04-11'</span>, <span class="hljs-string">'2012-04-12'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-13'</span>, <span class="hljs-string">'2012-04-14'</span>, <span class="hljs-string">'2012-04-15'</span>, <span class="hljs-string">'2012-04-16'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-17'</span>, <span class="hljs-string">'2012-04-18'</span>, <span class="hljs-string">'2012-04-19'</span>, <span class="hljs-string">'2012-04-20'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-21'</span>, <span class="hljs-string">'2012-04-22'</span>, <span class="hljs-string">'2012-04-23'</span>, <span class="hljs-string">'2012-04-24'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-25'</span>, <span class="hljs-string">'2012-04-26'</span>, <span class="hljs-string">'2012-04-27'</span>, <span class="hljs-string">'2012-04-28'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-29'</span>, <span class="hljs-string">'2012-04-30'</span>, <span class="hljs-string">'2012-05-01'</span>, <span class="hljs-string">'2012-05-02'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-03'</span>, <span class="hljs-string">'2012-05-04'</span>, <span class="hljs-string">'2012-05-05'</span>, <span class="hljs-string">'2012-05-06'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-07'</span>, <span class="hljs-string">'2012-05-08'</span>, <span class="hljs-string">'2012-05-09'</span>, <span class="hljs-string">'2012-05-10'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-11'</span>, <span class="hljs-string">'2012-05-12'</span>, <span class="hljs-string">'2012-05-13'</span>, <span class="hljs-string">'2012-05-14'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-15'</span>, <span class="hljs-string">'2012-05-16'</span>, <span class="hljs-string">'2012-05-17'</span>, <span class="hljs-string">'2012-05-18'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-19'</span>, <span class="hljs-string">'2012-05-20'</span>, <span class="hljs-string">'2012-05-21'</span>, <span class="hljs-string">'2012-05-22'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-23'</span>, <span class="hljs-string">'2012-05-24'</span>, <span class="hljs-string">'2012-05-25'</span>, <span class="hljs-string">'2012-05-26'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-27'</span>, <span class="hljs-string">'2012-05-28'</span>, <span class="hljs-string">'2012-05-29'</span>, <span class="hljs-string">'2012-05-30'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-31'</span>, <span class="hljs-string">'2012-06-01'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>默认情况下，date_range会产生按天计算的时间点。如果只传入起始或结束日期，那就还得传入一个表示一段时间的数字：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">76</span>]: pd.date_range(start=<span class="hljs-string">'2012-04-01'</span>, periods=<span class="hljs-number">20</span>)</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-04-01'</span>, <span class="hljs-string">'2012-04-02'</span>, <span class="hljs-string">'2012-04-03'</span>, <span class="hljs-string">'2012-04-04'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-05'</span>, <span class="hljs-string">'2012-04-06'</span>, <span class="hljs-string">'2012-04-07'</span>, <span class="hljs-string">'2012-04-08'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-09'</span>, <span class="hljs-string">'2012-04-10'</span>, <span class="hljs-string">'2012-04-11'</span>, <span class="hljs-string">'2012-04-12'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-13'</span>, <span class="hljs-string">'2012-04-14'</span>, <span class="hljs-string">'2012-04-15'</span>, <span class="hljs-string">'2012-04-16'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-04-17'</span>, <span class="hljs-string">'2012-04-18'</span>, <span class="hljs-string">'2012-04-19'</span>, <span class="hljs-string">'2012-04-20'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">77</span>]: pd.date_range(end=<span class="hljs-string">'2012-06-01'</span>, periods=<span class="hljs-number">20</span>)</span><br><span class="line">Out[<span class="hljs-number">77</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-05-13'</span>, <span class="hljs-string">'2012-05-14'</span>, <span class="hljs-string">'2012-05-15'</span>, <span class="hljs-string">'2012-05-16'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-17'</span>, <span class="hljs-string">'2012-05-18'</span>, <span class="hljs-string">'2012-05-19'</span>, <span class="hljs-string">'2012-05-20'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-21'</span>, <span class="hljs-string">'2012-05-22'</span>, <span class="hljs-string">'2012-05-23'</span>, <span class="hljs-string">'2012-05-24'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-25'</span>, <span class="hljs-string">'2012-05-26'</span>, <span class="hljs-string">'2012-05-27'</span>,<span class="hljs-string">'2012-05-28'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-29'</span>, <span class="hljs-string">'2012-05-30'</span>, <span class="hljs-string">'2012-05-31'</span>, <span class="hljs-string">'2012-06-01'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>起始和结束日期定义了日期索引的严格边界。例如，如果你想要生成一个由每月最后一个工作日组成的日期索引，可以传入”BM”频率（表示business end of month，表11-4是频率列表），这样就只会包含时间间隔内（或刚好在边界上的）符合频率要求的日期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">78</span>]: pd.date_range(<span class="hljs-string">'2000-01-01'</span>, <span class="hljs-string">'2000-12-01'</span>, freq=<span class="hljs-string">'BM'</span>)</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2000-01-31'</span>, <span class="hljs-string">'2000-02-29'</span>, <span class="hljs-string">'2000-03-31'</span>, <span class="hljs-string">'2000-04-28'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-05-31'</span>, <span class="hljs-string">'2000-06-30'</span>, <span class="hljs-string">'2000-07-31'</span>, <span class="hljs-string">'2000-08-31'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-09-29'</span>, <span class="hljs-string">'2000-10-31'</span>, <span class="hljs-string">'2000-11-30'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'BM'</span>)</span><br></pre></td></tr></table></figure>

<p>表11-4 基本的时间序列频率（不完整）</p>
<p><img src="/images/blog/7178691-c8614ddbd10793ca.webp" alt="img"></p>
<p><img src="/images/blog/7178691-8da46ba96544b071.webp" alt="img"></p>
<p><img src="/images/blog/7178691-3ca410609195edc4.webp" alt="img"></p>
<p>date_range默认会保留起始和结束时间戳的时间信息（如果有的话）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">79</span>]: pd.date_range(<span class="hljs-string">'2012-05-02 12:56:31'</span>, periods=<span class="hljs-number">5</span>)</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-05-02 12:56:31'</span>, <span class="hljs-string">'2012-05-03 12:56:31'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-04 12:56:31'</span>, <span class="hljs-string">'2012-05-05 12:56:31'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-06 12:56:31'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>有时，虽然起始和结束日期带有时间信息，但你希望产生一组被规范化（normalize）到午夜的时间戳。normalize选项即可实现该功能：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">80</span>]: pd.date_range(<span class="hljs-string">'2012-05-02 12:56:31'</span>, periods=<span class="hljs-number">5</span>, normalize=<span class="hljs-literal">True</span>)</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-05-02'</span>, <span class="hljs-string">'2012-05-03'</span>, <span class="hljs-string">'2012-05-04'</span>, <span class="hljs-string">'2012-05-05'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-05-06'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="频率和日期偏移量"><a href="#频率和日期偏移量" class="headerlink" title="频率和日期偏移量"></a>频率和日期偏移量</h2><p>pandas中的频率是由一个基础频率（base frequency）和一个乘数组成的。基础频率通常以一个字符串别名表示，比如”M”表示每月，”H”表示每小时。对于每个基础频率，都有一个被称为日期偏移量（date offset）的对象与之对应。例如，按小时计算的频率可以用Hour类表示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">81</span>]: <span class="hljs-keyword">from</span> pandas.tseries.offsets <span class="hljs-keyword">import</span> Hour, Minute</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">82</span>]: hour = Hour()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: hour</span><br><span class="line">Out[<span class="hljs-number">83</span>]: &lt;Hour&gt;</span><br></pre></td></tr></table></figure>

<p>传入一个整数即可定义偏移量的倍数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">84</span>]: four_hours = Hour(<span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">85</span>]: four_hours</span><br><span class="line">Out[<span class="hljs-number">85</span>]: &lt;<span class="hljs-number">4</span> * Hours&gt;</span><br></pre></td></tr></table></figure>

<p>一般来说，无需明确创建这样的对象，只需使用诸如”H”或”4H”这样的字符串别名即可。在基础频率前面放上一个整数即可创建倍数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: pd.date_range(<span class="hljs-string">'2000-01-01'</span>, <span class="hljs-string">'2000-01-03 23:59'</span>, freq=<span class="hljs-string">'4h'</span>)</span><br><span class="line">Out[<span class="hljs-number">86</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2000-01-01 00:00:00'</span>, <span class="hljs-string">'2000-01-01 04:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 08:00:00'</span>, <span class="hljs-string">'2000-01-01 12:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 16:00:00'</span>, <span class="hljs-string">'2000-01-01 20:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-02 00:00:00'</span>, <span class="hljs-string">'2000-01-02 04:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-02 08:00:00'</span>, <span class="hljs-string">'2000-01-02 12:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-02 16:00:00'</span>, <span class="hljs-string">'2000-01-02 20:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-03 00:00:00'</span>, <span class="hljs-string">'2000-01-03 04:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-03 08:00:00'</span>, <span class="hljs-string">'2000-01-03 12:00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-03 16:00:00'</span>, <span class="hljs-string">'2000-01-03 20:00:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'4H'</span>)</span><br></pre></td></tr></table></figure>

<p>大部分偏移量对象都可通过加法进行连接：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">87</span>]: Hour(<span class="hljs-number">2</span>) + Minute(<span class="hljs-number">30</span>)</span><br><span class="line">Out[<span class="hljs-number">87</span>]: &lt;<span class="hljs-number">150</span> * Minutes&gt;</span><br></pre></td></tr></table></figure>

<p>同理，你也可以传入频率字符串（如”2h30min”），这种字符串可以被高效地解析为等效的表达式：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">88</span>]: pd.date_range(<span class="hljs-string">'2000-01-01'</span>, periods=<span class="hljs-number">10</span>, freq=<span class="hljs-string">'1h30min'</span>)</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2000-01-01 00:00:00'</span>, <span class="hljs-string">'2000-01-01 01:30:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 03:00:00'</span>, <span class="hljs-string">'2000-01-01 04:30:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 06:00:00'</span>, <span class="hljs-string">'2000-01-01 07:30:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 09:00:00'</span>, <span class="hljs-string">'2000-01-01 10:30:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2000-01-01 12:00:00'</span>, <span class="hljs-string">'2000-01-01 13:30:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns]'</span>, freq=<span class="hljs-string">'90T'</span>)</span><br></pre></td></tr></table></figure>

<p>有些频率所描述的时间点并不是均匀分隔的。例如，”M”（日历月末）和”BM”（每月最后一个工作日）就取决于每月的天数，对于后者，还要考虑月末是不是周末。由于没有更好的术语，我将这些称为锚点偏移量（anchored offset）。</p>
<p>表11-4列出了pandas中的频率代码和日期偏移量类。</p>
<blockquote>
<p>笔记：用户可以根据实际需求自定义一些频率类以便提供pandas所没有的日期逻辑，但具体的细节超出了本书的范围。</p>
</blockquote>
<p>表11-4 时间序列的基础频率</p>
<p><img src="/images/blog/7178691-ff139312cd972204.webp" alt="img"></p>
<p><img src="/images/blog/7178691-adfa57a998c0296e.webp" alt="img"></p>
<p><img src="/images/blog/7178691-d09e577a10d0e6eb.webp" alt="img"></p>
<h2 id="WOM日期"><a href="#WOM日期" class="headerlink" title="WOM日期"></a>WOM日期</h2><p>WOM（Week Of Month）是一种非常实用的频率类，它以WOM开头。它使你能获得诸如“每月第3个星期五”之类的日期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">89</span>]: rng = pd.date_range(<span class="hljs-string">'2012-01-01'</span>, <span class="hljs-string">'2012-09-01'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: list(rng)</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">[Timestamp(<span class="hljs-string">'2012-01-20 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-02-17 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-03-16 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-04-20 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-05-18 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-06-15 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-07-20 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>),</span><br><span class="line"> Timestamp(<span class="hljs-string">'2012-08-17 00:00:00'</span>, freq=<span class="hljs-string">'WOM-3FRI'</span>)]</span><br></pre></td></tr></table></figure>

<h2 id="移动（超前和滞后）数据"><a href="#移动（超前和滞后）数据" class="headerlink" title="移动（超前和滞后）数据"></a>移动（超前和滞后）数据</h2><p>移动（shifting）指的是沿着时间轴将数据前移或后移。Series和DataFrame都有一个shift方法用于执行单纯的前移或后移操作，保持索引不变：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: ts = pd.Series(np.random.randn(<span class="hljs-number">4</span>),</span><br><span class="line">   ....:                index=pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">4</span>, freq=<span class="hljs-string">'M'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">92</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.838639</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line">Freq: M, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: ts.shift(<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">93</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>         NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>         NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.838639</span></span><br><span class="line">Freq: M, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">94</span>]: ts.shift(<span class="hljs-number">-2</span>)</span><br><span class="line">Out[<span class="hljs-number">94</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>         NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>         NaN</span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>当我们这样进行移动时，就会在时间序列的前面或后面产生缺失数据。</p>
<p>shift通常用于计算一个时间序列或多个时间序列（如DataFrame的列）中的百分比变化。可以这样表达：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ts / ts.shift(<span class="hljs-number">1</span>) - <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>由于单纯的移位操作不会修改索引，所以部分数据会被丢弃。因此，如果频率已知，则可以将其传给shift以便实现对时间戳进行位移而不是对数据进行简单位移：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">95</span>]: ts.shift(<span class="hljs-number">2</span>, freq=<span class="hljs-string">'M'</span>)</span><br><span class="line">Out[<span class="hljs-number">95</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.838639</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-05</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-06</span><span class="hljs-number">-30</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>这里还可以使用其他频率，于是你就能非常灵活地对数据进行超前和滞后处理了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: ts.shift(<span class="hljs-number">3</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line">Out[<span class="hljs-number">96</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.838639</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-05</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: ts.shift(<span class="hljs-number">1</span>, freq=<span class="hljs-string">'90T'</span>)</span><br><span class="line">Out[<span class="hljs-number">97</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span> <span class="hljs-number">01</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.066748</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span> <span class="hljs-number">01</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.838639</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span> <span class="hljs-number">01</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.117388</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span> <span class="hljs-number">01</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.517795</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="通过偏移量对日期进行位移"><a href="#通过偏移量对日期进行位移" class="headerlink" title="通过偏移量对日期进行位移"></a>通过偏移量对日期进行位移</h2><p>pandas的日期偏移量还可以用在datetime或Timestamp对象上：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">98</span>]: <span class="hljs-keyword">from</span> pandas.tseries.offsets <span class="hljs-keyword">import</span> Day, MonthEnd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: now = datetime(<span class="hljs-number">2011</span>, <span class="hljs-number">11</span>, <span class="hljs-number">17</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: now + <span class="hljs-number">3</span> * Day()</span><br><span class="line">Out[<span class="hljs-number">100</span>]: Timestamp(<span class="hljs-string">'2011-11-20 00:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>如果加的是锚点偏移量（比如MonthEnd），第一次增量会将原日期向前滚动到符合频率规则的下一个日期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">101</span>]: now + MonthEnd()</span><br><span class="line">Out[<span class="hljs-number">101</span>]: Timestamp(<span class="hljs-string">'2011-11-30 00:00:00'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">102</span>]: now + MonthEnd(<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">102</span>]: Timestamp(<span class="hljs-string">'2011-12-31 00:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>通过锚点偏移量的rollforward和rollback方法，可明确地将日期向前或向后“滚动”：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">103</span>]: offset = MonthEnd()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">104</span>]: offset.rollforward(now)</span><br><span class="line">Out[<span class="hljs-number">104</span>]: Timestamp(<span class="hljs-string">'2011-11-30 00:00:00'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">105</span>]: offset.rollback(now)</span><br><span class="line">Out[<span class="hljs-number">105</span>]: Timestamp(<span class="hljs-string">'2011-10-31 00:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>日期偏移量还有一个巧妙的用法，即结合groupby使用这两个“滚动”方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">106</span>]: ts = pd.Series(np.random.randn(<span class="hljs-number">20</span>),</span><br><span class="line">   .....:                index=pd.date_range(<span class="hljs-string">'1/15/2000'</span>, periods=<span class="hljs-number">20</span>, freq=<span class="hljs-string">'4d'</span>))</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">107</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">107</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>   <span class="hljs-number">-0.116696</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-19</span>    <span class="hljs-number">2.389645</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-23</span>   <span class="hljs-number">-0.932454</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-27</span>   <span class="hljs-number">-0.229331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-1.140330</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-04</span>    <span class="hljs-number">0.439920</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.823758</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-12</span>   <span class="hljs-number">-0.520930</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-16</span>    <span class="hljs-number">0.350282</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-20</span>    <span class="hljs-number">0.204395</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-24</span>    <span class="hljs-number">0.133445</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-28</span>    <span class="hljs-number">0.327905</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.072153</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-07</span>    <span class="hljs-number">0.131678</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span>   <span class="hljs-number">-1.297459</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-15</span>    <span class="hljs-number">0.997747</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-19</span>    <span class="hljs-number">0.870955</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-23</span>   <span class="hljs-number">-0.991253</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-27</span>    <span class="hljs-number">0.151699</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">1.266151</span></span><br><span class="line">Freq: <span class="hljs-number">4</span>D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">108</span>]: ts.groupby(offset.rollforward).mean()</span><br><span class="line">Out[<span class="hljs-number">108</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.005833</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.015894</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.150209</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>当然，更简单、更快速地实现该功能的办法是使用resample（11.6小节将对此进行详细介绍）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">109</span>]: ts.resample(<span class="hljs-string">'M'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">109</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.005833</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.015894</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.150209</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<h1 id="11-4-时区处理"><a href="#11-4-时区处理" class="headerlink" title="11.4 时区处理"></a>11.4 时区处理</h1><p>时间序列处理工作中最让人不爽的就是对时区的处理。许多人都选择以协调世界时（UTC，它是格林尼治标准时间（Greenwich Mean Time）的接替者，目前已经是国际标准了）来处理时间序列。时区是以UTC偏移量的形式表示的。例如，夏令时期间，纽约比UTC慢4小时，而在全年其他时间则比UTC慢5小时。</p>
<p>在Python中，时区信息来自第三方库pytz，它使Python可以使用Olson数据库（汇编了世界时区信息）。这对历史数据非常重要，这是因为由于各地政府的各种突发奇想，夏令时转变日期（甚至UTC偏移量）已经发生过多次改变了。就拿美国来说，DST转变时间自1900年以来就改变过多次！</p>
<p>有关pytz库的更多信息，请查阅其文档。就本书而言，由于pandas包装了pytz的功能，因此你可以不用记忆其API，只要记得时区的名称即可。时区名可以在shell中看到，也可以通过文档查看：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">110</span>]: <span class="hljs-keyword">import</span> pytz</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">111</span>]: pytz.common_timezones[<span class="hljs-number">-5</span>:]</span><br><span class="line">Out[<span class="hljs-number">111</span>]: [<span class="hljs-string">'US/Eastern'</span>, <span class="hljs-string">'US/Hawaii'</span>, <span class="hljs-string">'US/Mountain'</span>, <span class="hljs-string">'US/Pacific'</span>, <span class="hljs-string">'UTC'</span>]</span><br></pre></td></tr></table></figure>

<p>要从pytz中获取时区对象，使用pytz.timezone即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">112</span>]: tz = pytz.timezone(<span class="hljs-string">'America/New_York'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: tz</span><br><span class="line">Out[<span class="hljs-number">113</span>]: &lt;DstTzInfo <span class="hljs-string">'America/New_York'</span> LMT<span class="hljs-number">-1</span> day, <span class="hljs-number">19</span>:<span class="hljs-number">04</span>:<span class="hljs-number">00</span> STD&gt;</span><br></pre></td></tr></table></figure>

<p>pandas中的方法既可以接受时区名也可以接受这些对象。</p>
<h1 id="时区本地化和转换"><a href="#时区本地化和转换" class="headerlink" title="时区本地化和转换"></a>时区本地化和转换</h1><p>默认情况下，pandas中的时间序列是单纯（naive）的时区。看看下面这个时间序列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">114</span>]: rng = pd.date_range(<span class="hljs-string">'3/9/2012 9:30'</span>, periods=<span class="hljs-number">6</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">115</span>]: ts = pd.Series(np.random.randn(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">116</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">116</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br></pre></td></tr></table></figure>

<p>其索引的tz字段为None：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">117</span>]: print(ts.index.tz)</span><br><span class="line"><span class="hljs-literal">None</span></span><br></pre></td></tr></table></figure>

<p>可以用时区集生成日期范围：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">118</span>]: pd.date_range(<span class="hljs-string">'3/9/2012 9:30'</span>, periods=<span class="hljs-number">10</span>, freq=<span class="hljs-string">'D'</span>, tz=<span class="hljs-string">'UTC'</span>)</span><br><span class="line">Out[<span class="hljs-number">118</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-03-09 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-10 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-11 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-12 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-13 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-14 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-15 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-16 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-17 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-18 09:30:00+00:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns, UTC]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>从单纯到本地化的转换是通过tz_localize方法处理的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">119</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">119</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">120</span>]: ts_utc = ts.tz_localize(<span class="hljs-string">'UTC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">121</span>]: ts_utc</span><br><span class="line">Out[<span class="hljs-number">121</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">122</span>]: ts_utc.index</span><br><span class="line">Out[<span class="hljs-number">122</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-03-09 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-10 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-11 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-12 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-13 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-14 09:30:00+00:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns, UTC]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p>一旦时间序列被本地化到某个特定时区，就可以用tz_convert将其转换到别的时区了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">123</span>]: ts_utc.tz_convert(<span class="hljs-string">'America/New_York'</span>)</span><br><span class="line">Out[<span class="hljs-number">123</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">04</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-05</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">04</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-05</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">05</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span><span class="hljs-number">-04</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br></pre></td></tr></table></figure>

<p>对于上面这种时间序列（它跨越了美国东部时区的夏令时转变期），我们可以将其本地化到EST，然后转换为UTC或柏林时间：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">124</span>]: ts_eastern = ts.tz_localize(<span class="hljs-string">'America/New_York'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">125</span>]: ts_eastern.tz_convert(<span class="hljs-string">'UTC'</span>)</span><br><span class="line">Out[<span class="hljs-number">125</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">13</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">13</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">13</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">13</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">126</span>]: ts_eastern.tz_convert(<span class="hljs-string">'Europe/Berlin'</span>)</span><br><span class="line">Out[<span class="hljs-number">126</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">15</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.202469</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-10</span> <span class="hljs-number">15</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.050718</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-11</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.639869</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.597594</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.797246</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">14</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>+<span class="hljs-number">01</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.472879</span></span><br><span class="line">Freq: D, dtype: float64</span><br></pre></td></tr></table></figure>

<p>tz_localize和tz_convert也是DatetimeIndex的实例方法：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">127</span>]: ts.index.tz_localize(<span class="hljs-string">'Asia/Shanghai'</span>)</span><br><span class="line">Out[<span class="hljs-number">127</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-03-09 09:30:00+08:00'</span>, <span class="hljs-string">'2012-03-10 09:30:00+08:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-11 09:30:00+08:00'</span>, <span class="hljs-string">'2012-03-12 09:30:00+08:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-13 09:30:00+08:00'</span>, <span class="hljs-string">'2012-03-14 09:30:00+08:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns, Asia/Shanghai]'</span>, freq=<span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意：对单纯时间戳的本地化操作还会检查夏令时转变期附近容易混淆或不存在的时间。</p>
</blockquote>
<h2 id="操作时区意识型Timestamp对象"><a href="#操作时区意识型Timestamp对象" class="headerlink" title="操作时区意识型Timestamp对象"></a>操作时区意识型Timestamp对象</h2><p>跟时间序列和日期范围差不多，独立的Timestamp对象也能被从单纯型（naive）本地化为时区意识型（time zone-aware），并从一个时区转换到另一个时区：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">128</span>]: stamp = pd.Timestamp(<span class="hljs-string">'2011-03-12 04:00'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">129</span>]: stamp_utc = stamp.tz_localize(<span class="hljs-string">'utc'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">130</span>]: stamp_utc.tz_convert(<span class="hljs-string">'America/New_York'</span>)</span><br><span class="line">Out[<span class="hljs-number">130</span>]: Timestamp(<span class="hljs-string">'2011-03-11 23:00:00-0500'</span>, tz=<span class="hljs-string">'America/New_York'</span>)</span><br></pre></td></tr></table></figure>

<p>在创建Timestamp时，还可以传入一个时区信息：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">131</span>]: stamp_moscow = pd.Timestamp(<span class="hljs-string">'2011-03-12 04:00'</span>, tz=<span class="hljs-string">'Europe/Moscow'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">132</span>]: stamp_moscow</span><br><span class="line">Out[<span class="hljs-number">132</span>]: Timestamp(<span class="hljs-string">'2011-03-12 04:00:00+0300'</span>, tz=<span class="hljs-string">'Europe/Moscow'</span>)</span><br></pre></td></tr></table></figure>

<p>时区意识型Timestamp对象在内部保存了一个UTC时间戳值（自UNIX纪元（1970年1月1日）算起的纳秒数）。这个UTC值在时区转换过程中是不会发生变化的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">133</span>]: stamp_utc.value</span><br><span class="line">Out[<span class="hljs-number">133</span>]: <span class="hljs-number">1299902400000000000</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">134</span>]: stamp_utc.tz_convert(<span class="hljs-string">'America/New_York'</span>).value</span><br><span class="line">Out[<span class="hljs-number">134</span>]: <span class="hljs-number">1299902400000000000</span></span><br></pre></td></tr></table></figure>

<p>当使用pandas的DateOffset对象执行时间算术运算时，运算过程会自动关注是否存在夏令时转变期。这里，我们创建了在DST转变之前的时间戳。首先，来看夏令时转变前的30分钟：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">135</span>]: <span class="hljs-keyword">from</span> pandas.tseries.offsets <span class="hljs-keyword">import</span> Hour</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">136</span>]: stamp = pd.Timestamp(<span class="hljs-string">'2012-03-12 01:30'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">137</span>]: stamp</span><br><span class="line">Out[<span class="hljs-number">137</span>]: Timestamp(<span class="hljs-string">'2012-03-12 01:30:00-0400'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">138</span>]: stamp + Hour()</span><br><span class="line">Out[<span class="hljs-number">138</span>]: Timestamp(<span class="hljs-string">'2012-03-12 02:30:00-0400'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br></pre></td></tr></table></figure>

<p>然后，夏令时转变前90分钟：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">139</span>]: stamp = pd.Timestamp(<span class="hljs-string">'2012-11-04 00:30'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">140</span>]: stamp</span><br><span class="line">Out[<span class="hljs-number">140</span>]: Timestamp(<span class="hljs-string">'2012-11-04 00:30:00-0400'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">141</span>]: stamp + <span class="hljs-number">2</span> * Hour()</span><br><span class="line">Out[<span class="hljs-number">141</span>]: Timestamp(<span class="hljs-string">'2012-11-04 01:30:00-0500'</span>, tz=<span class="hljs-string">'US/Eastern'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="不同时区之间的运算"><a href="#不同时区之间的运算" class="headerlink" title="不同时区之间的运算"></a>不同时区之间的运算</h2><p>如果两个时间序列的时区不同，在将它们合并到一起时，最终结果就会是UTC。由于时间戳其实是以UTC存储的，所以这是一个很简单的运算，并不需要发生任何转换：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">142</span>]: rng = pd.date_range(<span class="hljs-string">'3/7/2012 9:30'</span>, periods=<span class="hljs-number">10</span>, freq=<span class="hljs-string">'B'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">143</span>]: ts = pd.Series(np.random.randn(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">144</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">144</span>]: </span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-07</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.522356</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-08</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.546348</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-09</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.733537</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-12</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">1.302736</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-13</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.022199</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-14</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.364287</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-15</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.922839</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-16</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0.312656</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-19</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-1.128497</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-03</span><span class="hljs-number">-20</span> <span class="hljs-number">09</span>:<span class="hljs-number">30</span>:<span class="hljs-number">00</span>   <span class="hljs-number">-0.333488</span></span><br><span class="line">Freq: B, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">145</span>]: ts1 = ts[:<span class="hljs-number">7</span>].tz_localize(<span class="hljs-string">'Europe/London'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">146</span>]: ts2 = ts1[<span class="hljs-number">2</span>:].tz_convert(<span class="hljs-string">'Europe/Moscow'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">147</span>]: result = ts1 + ts2</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">148</span>]: result.index</span><br><span class="line">Out[<span class="hljs-number">148</span>]: </span><br><span class="line">DatetimeIndex([<span class="hljs-string">'2012-03-07 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-08 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-09 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-12 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-13 09:30:00+00:00'</span>, <span class="hljs-string">'2012-03-14 09:30:00+00:00'</span>,</span><br><span class="line">               <span class="hljs-string">'2012-03-15 09:30:00+00:00'</span>],</span><br><span class="line">              dtype=<span class="hljs-string">'datetime64[ns, UTC]'</span>, freq=<span class="hljs-string">'B'</span>)</span><br></pre></td></tr></table></figure>

<h1 id="11-5-时期及其算术运算"><a href="#11-5-时期及其算术运算" class="headerlink" title="11.5 时期及其算术运算"></a>11.5 时期及其算术运算</h1><p>时期（period）表示的是时间区间，比如数日、数月、数季、数年等。Period类所表示的就是这种数据类型，其构造函数需要用到一个字符串或整数，以及表11-4中的频率：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">149</span>]: p = pd.Period(<span class="hljs-number">2007</span>, freq=<span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">150</span>]: p</span><br><span class="line">Out[<span class="hljs-number">150</span>]: Period(<span class="hljs-string">'2007'</span>, <span class="hljs-string">'A-DEC'</span>)</span><br></pre></td></tr></table></figure>

<p>这里，这个Period对象表示的是从2007年1月1日到2007年12月31日之间的整段时间。只需对Period对象加上或减去一个整数即可达到根据其频率进行位移的效果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">151</span>]: p + <span class="hljs-number">5</span></span><br><span class="line">Out[<span class="hljs-number">151</span>]: Period(<span class="hljs-string">'2012'</span>, <span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">152</span>]: p - <span class="hljs-number">2</span></span><br><span class="line">Out[<span class="hljs-number">152</span>]: Period(<span class="hljs-string">'2005'</span>, <span class="hljs-string">'A-DEC'</span>)</span><br></pre></td></tr></table></figure>

<p>如果两个Period对象拥有相同的频率，则它们的差就是它们之间的单位数量：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">153</span>]: pd.Period(<span class="hljs-string">'2014'</span>, freq=<span class="hljs-string">'A-DEC'</span>) - p</span><br><span class="line">Out[<span class="hljs-number">153</span>]: <span class="hljs-number">7</span></span><br></pre></td></tr></table></figure>

<p>period_range函数可用于创建规则的时期范围：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">154</span>]: rng = pd.period_range(<span class="hljs-string">'2000-01-01'</span>, <span class="hljs-string">'2000-06-30'</span>, freq=<span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">155</span>]: rng</span><br><span class="line">Out[<span class="hljs-number">155</span>]: PeriodIndex([<span class="hljs-string">'2000-01'</span>, <span class="hljs-string">'2000-02'</span>, <span class="hljs-string">'2000-03'</span>, <span class="hljs-string">'2000-04'</span>, <span class="hljs-string">'2000-05'</span>, <span class="hljs-string">'20</span></span><br><span class="line"><span class="hljs-string">00-06'</span>], dtype=<span class="hljs-string">'period[M]'</span>, freq=<span class="hljs-string">'M'</span>)</span><br></pre></td></tr></table></figure>

<p>PeriodIndex类保存了一组Period，它可以在任何pandas数据结构中被用作轴索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">156</span>]: pd.Series(np.random.randn(<span class="hljs-number">6</span>), index=rng)</span><br><span class="line">Out[<span class="hljs-number">156</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.514551</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.559782</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.783408</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span>   <span class="hljs-number">-1.797685</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-05</span>   <span class="hljs-number">-0.172670</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-06</span>    <span class="hljs-number">0.680215</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>如果你有一个字符串数组，你也可以使用PeriodIndex类：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">157</span>]: values = [<span class="hljs-string">'2001Q3'</span>, <span class="hljs-string">'2002Q2'</span>, <span class="hljs-string">'2003Q1'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">158</span>]: index = pd.PeriodIndex(values, freq=<span class="hljs-string">'Q-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">159</span>]: index</span><br><span class="line">Out[<span class="hljs-number">159</span>]: PeriodIndex([<span class="hljs-string">'2001Q3'</span>, <span class="hljs-string">'2002Q2'</span>, <span class="hljs-string">'2003Q1'</span>], dtype=<span class="hljs-string">'period[Q-DEC]'</span>, freq</span><br><span class="line">=<span class="hljs-string">'Q-DEC'</span>)</span><br></pre></td></tr></table></figure>

<h2 id="时期的频率转换"><a href="#时期的频率转换" class="headerlink" title="时期的频率转换"></a>时期的频率转换</h2><p>Period和PeriodIndex对象都可以通过其asfreq方法被转换成别的频率。假设我们有一个年度时期，希望将其转换为当年年初或年末的一个月度时期。该任务非常简单：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">160</span>]: p = pd.Period(<span class="hljs-string">'2007'</span>, freq=<span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">161</span>]: p</span><br><span class="line">Out[<span class="hljs-number">161</span>]: Period(<span class="hljs-string">'2007'</span>, <span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">162</span>]: p.asfreq(<span class="hljs-string">'M'</span>, how=<span class="hljs-string">'start'</span>)</span><br><span class="line">Out[<span class="hljs-number">162</span>]: Period(<span class="hljs-string">'2007-01'</span>, <span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">163</span>]: p.asfreq(<span class="hljs-string">'M'</span>, how=<span class="hljs-string">'end'</span>)</span><br><span class="line">Out[<span class="hljs-number">163</span>]: Period(<span class="hljs-string">'2007-12'</span>, <span class="hljs-string">'M'</span>)</span><br></pre></td></tr></table></figure>

<p>你可以将Period(‘2007’,’A-DEC’)看做一个被划分为多个月度时期的时间段中的游标。图11-1对此进行了说明。对于一个不以12月结束的财政年度，月度子时期的归属情况就不一样了：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">164</span>]: p = pd.Period(<span class="hljs-string">'2007'</span>, freq=<span class="hljs-string">'A-JUN'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">165</span>]: p</span><br><span class="line">Out[<span class="hljs-number">165</span>]: Period(<span class="hljs-string">'2007'</span>, <span class="hljs-string">'A-JUN'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">166</span>]: p.asfreq(<span class="hljs-string">'M'</span>, <span class="hljs-string">'start'</span>)</span><br><span class="line">Out[<span class="hljs-number">166</span>]: Period(<span class="hljs-string">'2006-07'</span>, <span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">167</span>]: p.asfreq(<span class="hljs-string">'M'</span>, <span class="hljs-string">'end'</span>)</span><br><span class="line">Out[<span class="hljs-number">167</span>]: Period(<span class="hljs-string">'2007-06'</span>, <span class="hljs-string">'M'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-d201200d0e65676f.webp" alt="img"></p>
<p>图11-1 Period频率转换示例</p>
<p>在将高频率转换为低频率时，超时期（superperiod）是由子时期（subperiod）所属的位置决定的。例如，在A-JUN频率中，月份“2007年8月”实际上是属于周期“2008年”的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">168</span>]: p = pd.Period(<span class="hljs-string">'Aug-2007'</span>, <span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">169</span>]: p.asfreq(<span class="hljs-string">'A-JUN'</span>)</span><br><span class="line">Out[<span class="hljs-number">169</span>]: Period(<span class="hljs-string">'2008'</span>, <span class="hljs-string">'A-JUN'</span>)</span><br></pre></td></tr></table></figure>

<p>完整的PeriodIndex或TimeSeries的频率转换方式也是如此：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">170</span>]: rng = pd.period_range(<span class="hljs-string">'2006'</span>, <span class="hljs-string">'2009'</span>, freq=<span class="hljs-string">'A-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">171</span>]: ts = pd.Series(np.random.randn(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">172</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">172</span>]: </span><br><span class="line"><span class="hljs-number">2006</span>    <span class="hljs-number">1.607578</span></span><br><span class="line"><span class="hljs-number">2007</span>    <span class="hljs-number">0.200381</span></span><br><span class="line"><span class="hljs-number">2008</span>   <span class="hljs-number">-0.834068</span></span><br><span class="line"><span class="hljs-number">2009</span>   <span class="hljs-number">-0.302988</span></span><br><span class="line">Freq: A-DEC, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">173</span>]: ts.asfreq(<span class="hljs-string">'M'</span>, how=<span class="hljs-string">'start'</span>)</span><br><span class="line">Out[<span class="hljs-number">173</span>]: </span><br><span class="line"><span class="hljs-number">2006</span><span class="hljs-number">-01</span>    <span class="hljs-number">1.607578</span></span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.200381</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.834068</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.302988</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>这里，根据年度时期的第一个月，每年的时期被取代为每月的时期。如果我们想要每年的最后一个工作日，我们可以使用“B”频率，并指明想要该时期的末尾：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">174</span>]: ts.asfreq(<span class="hljs-string">'B'</span>, how=<span class="hljs-string">'end'</span>)</span><br><span class="line"></span><br><span class="line">Out[<span class="hljs-number">174</span>]: </span><br><span class="line"><span class="hljs-number">2006</span><span class="hljs-number">-12</span><span class="hljs-number">-29</span>    <span class="hljs-number">1.607578</span></span><br><span class="line"><span class="hljs-number">2007</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.200381</span></span><br><span class="line"><span class="hljs-number">2008</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.834068</span></span><br><span class="line"><span class="hljs-number">2009</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.302988</span></span><br><span class="line">Freq: B, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="按季度计算的时期频率"><a href="#按季度计算的时期频率" class="headerlink" title="按季度计算的时期频率"></a>按季度计算的时期频率</h2><p>季度型数据在会计、金融等领域中很常见。许多季度型数据都会涉及“财年末”的概念，通常是一年12个月中某月的最后一个日历日或工作日。就这一点来说，时期”2012Q4”根据财年末的不同会有不同的含义。pandas支持12种可能的季度型频率，即Q-JAN到Q-DEC：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">175</span>]: p = pd.Period(<span class="hljs-string">'2012Q4'</span>, freq=<span class="hljs-string">'Q-JAN'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">176</span>]: p</span><br><span class="line">Out[<span class="hljs-number">176</span>]: Period(<span class="hljs-string">'2012Q4'</span>, <span class="hljs-string">'Q-JAN'</span>)</span><br></pre></td></tr></table></figure>

<p>在以1月结束的财年中，2012Q4是从11月到1月（将其转换为日型频率就明白了）。图11-2对此进行了说明：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">177</span>]: p.asfreq(<span class="hljs-string">'D'</span>, <span class="hljs-string">'start'</span>)</span><br><span class="line">Out[<span class="hljs-number">177</span>]: Period(<span class="hljs-string">'2011-11-01'</span>, <span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">178</span>]: p.asfreq(<span class="hljs-string">'D'</span>, <span class="hljs-string">'end'</span>)</span><br><span class="line">Out[<span class="hljs-number">178</span>]: Period(<span class="hljs-string">'2012-01-31'</span>, <span class="hljs-string">'D'</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-e2e1d52c9766f6ff.webp" alt="img"></p>
<p>图11.2 不同季度型频率之间的转换</p>
<p>因此，Period之间的算术运算会非常简单。例如，要获取该季度倒数第二个工作日下午4点的时间戳，你可以这样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">179</span>]: p4pm = (p.asfreq(<span class="hljs-string">'B'</span>, <span class="hljs-string">'e'</span>) - <span class="hljs-number">1</span>).asfreq(<span class="hljs-string">'T'</span>, <span class="hljs-string">'s'</span>) + <span class="hljs-number">16</span> * <span class="hljs-number">60</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">180</span>]: p4pm</span><br><span class="line">Out[<span class="hljs-number">180</span>]: Period(<span class="hljs-string">'2012-01-30 16:00'</span>, <span class="hljs-string">'T'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">181</span>]: p4pm.to_timestamp()</span><br><span class="line">Out[<span class="hljs-number">181</span>]: Timestamp(<span class="hljs-string">'2012-01-30 16:00:00'</span>)</span><br></pre></td></tr></table></figure>

<p>period_range可用于生成季度型范围。季度型范围的算术运算也跟上面是一样的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">182</span>]: rng = pd.period_range(<span class="hljs-string">'2011Q3'</span>, <span class="hljs-string">'2012Q4'</span>, freq=<span class="hljs-string">'Q-JAN'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">183</span>]: ts = pd.Series(np.arange(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">184</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">184</span>]: </span><br><span class="line"><span class="hljs-number">2011</span>Q3    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2011</span>Q4    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2012</span>Q1    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2012</span>Q2    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2012</span>Q3    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2012</span>Q4    <span class="hljs-number">5</span></span><br><span class="line">Freq: Q-JAN, dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">185</span>]: new_rng = (rng.asfreq(<span class="hljs-string">'B'</span>, <span class="hljs-string">'e'</span>) - <span class="hljs-number">1</span>).asfreq(<span class="hljs-string">'T'</span>, <span class="hljs-string">'s'</span>) + <span class="hljs-number">16</span> * <span class="hljs-number">60</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">186</span>]: ts.index = new_rng.to_timestamp()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">187</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">187</span>]:</span><br><span class="line"><span class="hljs-number">2010</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-01</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-04</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-07</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-28</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2012</span><span class="hljs-number">-01</span><span class="hljs-number">-30</span> <span class="hljs-number">16</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">5</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<h2 id="将Timestamp转换为Period（及其反向过程）"><a href="#将Timestamp转换为Period（及其反向过程）" class="headerlink" title="将Timestamp转换为Period（及其反向过程）"></a>将Timestamp转换为Period（及其反向过程）</h2><p>通过使用to_period方法，可以将由时间戳索引的Series和DataFrame对象转换为以时期索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">188</span>]: rng = pd.date_range(<span class="hljs-string">'2000-01-01'</span>, periods=<span class="hljs-number">3</span>, freq=<span class="hljs-string">'M'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">189</span>]: ts = pd.Series(np.random.randn(<span class="hljs-number">3</span>), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">190</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">190</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>    <span class="hljs-number">1.663261</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>   <span class="hljs-number">-0.996206</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">1.521760</span></span><br><span class="line">Freq: M, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">191</span>]: pts = ts.to_period()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">192</span>]: pts</span><br><span class="line">Out[<span class="hljs-number">192</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>    <span class="hljs-number">1.663261</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.996206</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span>    <span class="hljs-number">1.521760</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>由于时期指的是非重叠时间区间，因此对于给定的频率，一个时间戳只能属于一个时期。新PeriodIndex的频率默认是从时间戳推断而来的，你也可以指定任何别的频率。结果中允许存在重复时期：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">193</span>]: rng = pd.date_range(<span class="hljs-string">'1/29/2000'</span>, periods=<span class="hljs-number">6</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">194</span>]: ts2 = pd.Series(np.random.randn(<span class="hljs-number">6</span>), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">195</span>]: ts2</span><br><span class="line">Out[<span class="hljs-number">195</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.244175</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.423331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.654040</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-01</span>    <span class="hljs-number">2.089154</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.060220</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.167933</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">196</span>]: ts2.to_period(<span class="hljs-string">'M'</span>)</span><br><span class="line">Out[<span class="hljs-number">196</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.244175</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.423331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.654040</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>    <span class="hljs-number">2.089154</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.060220</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.167933</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>要转换回时间戳，使用to_timestamp即可：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">197</span>]: pts = ts2.to_period()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">198</span>]: pts</span><br><span class="line">Out[<span class="hljs-number">198</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.244175</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.423331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.654040</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-01</span>    <span class="hljs-number">2.089154</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.060220</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.167933</span></span><br><span class="line">Freq: D, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">199</span>]: pts.to_timestamp(how=<span class="hljs-string">'end'</span>)</span><br><span class="line">Out[<span class="hljs-number">199</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.244175</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-30</span>    <span class="hljs-number">0.423331</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.654040</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-01</span>    <span class="hljs-number">2.089154</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-02</span>   <span class="hljs-number">-0.060220</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-03</span>   <span class="hljs-number">-0.167933</span></span><br><span class="line">Freq: D, dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="通过数组创建PeriodIndex"><a href="#通过数组创建PeriodIndex" class="headerlink" title="通过数组创建PeriodIndex"></a>通过数组创建PeriodIndex</h2><p>固定频率的数据集通常会将时间信息分开存放在多个列中。例如，在下面这个宏观经济数据集中，年度和季度就分别存放在不同的列中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">200</span>]: data = pd.read_csv(<span class="hljs-string">'examples/macrodata.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">201</span>]: data.head(<span class="hljs-number">5</span>)</span><br><span class="line">Out[<span class="hljs-number">201</span>]: </span><br><span class="line">     year  quarter   realgdp  realcons  realinv  realgovt  realdpi    cpi  \</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">1.0</span>  <span class="hljs-number">2710.349</span>    <span class="hljs-number">1707.4</span>  <span class="hljs-number">286.898</span>   <span class="hljs-number">470.045</span>   <span class="hljs-number">1886.9</span>  <span class="hljs-number">28.98</span>   </span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">2.0</span>  <span class="hljs-number">2778.801</span>    <span class="hljs-number">1733.7</span>  <span class="hljs-number">310.859</span>   <span class="hljs-number">481.301</span>   <span class="hljs-number">1919.7</span>  <span class="hljs-number">29.15</span>   </span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">3.0</span>  <span class="hljs-number">2775.488</span>    <span class="hljs-number">1751.8</span>  <span class="hljs-number">289.226</span>   <span class="hljs-number">491.260</span>   <span class="hljs-number">1916.4</span>  <span class="hljs-number">29.35</span>   </span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">1959.0</span>      <span class="hljs-number">4.0</span>  <span class="hljs-number">2785.204</span>    <span class="hljs-number">1753.7</span>  <span class="hljs-number">299.356</span>   <span class="hljs-number">484.052</span>   <span class="hljs-number">1931.3</span>  <span class="hljs-number">29.37</span>   </span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1960.0</span>      <span class="hljs-number">1.0</span>  <span class="hljs-number">2847.699</span>    <span class="hljs-number">1770.5</span>  <span class="hljs-number">331.722</span>   <span class="hljs-number">462.199</span>   <span class="hljs-number">1955.5</span>  <span class="hljs-number">29.54</span>   </span><br><span class="line">      m1  tbilrate  unemp      pop  infl  realint  </span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">139.7</span>      <span class="hljs-number">2.82</span>    <span class="hljs-number">5.8</span>  <span class="hljs-number">177.146</span>  <span class="hljs-number">0.00</span>     <span class="hljs-number">0.00</span>  </span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">141.7</span>      <span class="hljs-number">3.08</span>    <span class="hljs-number">5.1</span>  <span class="hljs-number">177.830</span>  <span class="hljs-number">2.34</span>     <span class="hljs-number">0.74</span>  </span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">140.5</span>      <span class="hljs-number">3.82</span>    <span class="hljs-number">5.3</span>  <span class="hljs-number">178.657</span>  <span class="hljs-number">2.74</span>     <span class="hljs-number">1.09</span>  </span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">140.0</span>      <span class="hljs-number">4.33</span>    <span class="hljs-number">5.6</span>  <span class="hljs-number">179.386</span>  <span class="hljs-number">0.27</span>     <span class="hljs-number">4.06</span>  </span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">139.6</span>      <span class="hljs-number">3.50</span>    <span class="hljs-number">5.2</span>  <span class="hljs-number">180.007</span>  <span class="hljs-number">2.31</span>     <span class="hljs-number">1.19</span>  </span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">202</span>]: data.year</span><br><span class="line">Out[<span class="hljs-number">202</span>]: </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">1959.0</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">1959.0</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">1959.0</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">1959.0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">1960.0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">1960.0</span></span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">1960.0</span></span><br><span class="line"><span class="hljs-number">7</span>      <span class="hljs-number">1960.0</span></span><br><span class="line"><span class="hljs-number">8</span>      <span class="hljs-number">1961.0</span></span><br><span class="line"><span class="hljs-number">9</span>      <span class="hljs-number">1961.0</span></span><br><span class="line">        ...  </span><br><span class="line"><span class="hljs-number">193</span>    <span class="hljs-number">2007.0</span></span><br><span class="line"><span class="hljs-number">194</span>    <span class="hljs-number">2007.0</span></span><br><span class="line"><span class="hljs-number">195</span>    <span class="hljs-number">2007.0</span></span><br><span class="line"><span class="hljs-number">196</span>    <span class="hljs-number">2008.0</span></span><br><span class="line"><span class="hljs-number">197</span>    <span class="hljs-number">2008.0</span></span><br><span class="line"><span class="hljs-number">198</span>    <span class="hljs-number">2008.0</span></span><br><span class="line"><span class="hljs-number">199</span>    <span class="hljs-number">2008.0</span></span><br><span class="line"><span class="hljs-number">200</span>    <span class="hljs-number">2009.0</span></span><br><span class="line"><span class="hljs-number">201</span>    <span class="hljs-number">2009.0</span></span><br><span class="line"><span class="hljs-number">202</span>    <span class="hljs-number">2009.0</span></span><br><span class="line">Name: year, Length: <span class="hljs-number">203</span>, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">203</span>]: data.quarter</span><br><span class="line">Out[<span class="hljs-number">203</span>]: </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">4</span>      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">5</span>      <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">6</span>      <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">7</span>      <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">8</span>      <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">9</span>      <span class="hljs-number">2.0</span></span><br><span class="line">      ... </span><br><span class="line"><span class="hljs-number">193</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">194</span>    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">195</span>    <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">196</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">197</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">198</span>    <span class="hljs-number">3.0</span></span><br><span class="line"><span class="hljs-number">199</span>    <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">200</span>    <span class="hljs-number">1.0</span></span><br><span class="line"><span class="hljs-number">201</span>    <span class="hljs-number">2.0</span></span><br><span class="line"><span class="hljs-number">202</span>    <span class="hljs-number">3.0</span></span><br><span class="line">Name: quarter, Length: <span class="hljs-number">203</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<p>通过将这些数组以及一个频率传入PeriodIndex，就可以将它们合并成DataFrame的一个索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">204</span>]: index = pd.PeriodIndex(year=data.year, quarter=data.quarter,</span><br><span class="line">   .....:                        freq=<span class="hljs-string">'Q-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">205</span>]: index</span><br><span class="line">Out[<span class="hljs-number">205</span>]: </span><br><span class="line">PeriodIndex([<span class="hljs-string">'1959Q1'</span>, <span class="hljs-string">'1959Q2'</span>, <span class="hljs-string">'1959Q3'</span>, <span class="hljs-string">'1959Q4'</span>, <span class="hljs-string">'1960Q1'</span>, <span class="hljs-string">'1960Q2'</span>,</span><br><span class="line">             <span class="hljs-string">'1960Q3'</span>, <span class="hljs-string">'1960Q4'</span>, <span class="hljs-string">'1961Q1'</span>, <span class="hljs-string">'1961Q2'</span>,</span><br><span class="line">             ...</span><br><span class="line">             <span class="hljs-string">'2007Q2'</span>, <span class="hljs-string">'2007Q3'</span>, <span class="hljs-string">'2007Q4'</span>, <span class="hljs-string">'2008Q1'</span>, <span class="hljs-string">'2008Q2'</span>, <span class="hljs-string">'2008Q3'</span>,</span><br><span class="line">             <span class="hljs-string">'2008Q4'</span>, <span class="hljs-string">'2009Q1'</span>, <span class="hljs-string">'2009Q2'</span>, <span class="hljs-string">'2009Q3'</span>],</span><br><span class="line">            dtype=<span class="hljs-string">'period[Q-DEC]'</span>, length=<span class="hljs-number">203</span>, freq=<span class="hljs-string">'Q-DEC'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">206</span>]: data.index = index</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">207</span>]: data.infl</span><br><span class="line">Out[<span class="hljs-number">207</span>]: </span><br><span class="line"><span class="hljs-number">1959</span>Q1    <span class="hljs-number">0.00</span></span><br><span class="line"><span class="hljs-number">1959</span>Q2    <span class="hljs-number">2.34</span></span><br><span class="line"><span class="hljs-number">1959</span>Q3    <span class="hljs-number">2.74</span></span><br><span class="line"><span class="hljs-number">1959</span>Q4    <span class="hljs-number">0.27</span></span><br><span class="line"><span class="hljs-number">1960</span>Q1    <span class="hljs-number">2.31</span></span><br><span class="line"><span class="hljs-number">1960</span>Q2    <span class="hljs-number">0.14</span></span><br><span class="line"><span class="hljs-number">1960</span>Q3    <span class="hljs-number">2.70</span></span><br><span class="line"><span class="hljs-number">1960</span>Q4    <span class="hljs-number">1.21</span></span><br><span class="line"><span class="hljs-number">1961</span>Q1   <span class="hljs-number">-0.40</span></span><br><span class="line"><span class="hljs-number">1961</span>Q2    <span class="hljs-number">1.47</span></span><br><span class="line">          ... </span><br><span class="line"><span class="hljs-number">2007</span>Q2    <span class="hljs-number">2.75</span></span><br><span class="line"><span class="hljs-number">2007</span>Q3    <span class="hljs-number">3.45</span></span><br><span class="line"><span class="hljs-number">2007</span>Q4    <span class="hljs-number">6.38</span></span><br><span class="line"><span class="hljs-number">2008</span>Q1    <span class="hljs-number">2.82</span></span><br><span class="line"><span class="hljs-number">2008</span>Q2    <span class="hljs-number">8.53</span></span><br><span class="line"><span class="hljs-number">2008</span>Q3   <span class="hljs-number">-3.16</span></span><br><span class="line"><span class="hljs-number">2008</span>Q4   <span class="hljs-number">-8.79</span></span><br><span class="line"><span class="hljs-number">2009</span>Q1    <span class="hljs-number">0.94</span></span><br><span class="line"><span class="hljs-number">2009</span>Q2    <span class="hljs-number">3.37</span></span><br><span class="line"><span class="hljs-number">2009</span>Q3    <span class="hljs-number">3.56</span></span><br><span class="line">Freq: Q-DEC, Name: infl, Length: <span class="hljs-number">203</span>, dtype: float64</span><br></pre></td></tr></table></figure>

<h1 id="11-6-重采样及频率转换"><a href="#11-6-重采样及频率转换" class="headerlink" title="11.6 重采样及频率转换"></a>11.6 重采样及频率转换</h1><p>重采样（resampling）指的是将时间序列从一个频率转换到另一个频率的处理过程。将高频率数据聚合到低频率称为降采样（downsampling），而将低频率数据转换到高频率则称为升采样（upsampling）。并不是所有的重采样都能被划分到这两个大类中。例如，将W-WED（每周三）转换为W-FRI既不是降采样也不是升采样。</p>
<p>pandas对象都带有一个resample方法，它是各种频率转换工作的主力函数。resample有一个类似于groupby的API，调用resample可以分组数据，然后会调用一个聚合函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">208</span>]: rng = pd.date_range(<span class="hljs-string">'2000-01-01'</span>, periods=<span class="hljs-number">100</span>, freq=<span class="hljs-string">'D'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">209</span>]: ts = pd.Series(np.random.randn(len(rng)), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">210</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">210</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span>    <span class="hljs-number">0.631634</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>   <span class="hljs-number">-1.594313</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>   <span class="hljs-number">-1.519937</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-04</span>    <span class="hljs-number">1.108752</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span>    <span class="hljs-number">1.255853</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>   <span class="hljs-number">-0.024330</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>   <span class="hljs-number">-2.047939</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>   <span class="hljs-number">-0.272657</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>   <span class="hljs-number">-1.692615</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">1.423830</span></span><br><span class="line">                ...   </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.007852</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-01</span>   <span class="hljs-number">-1.638806</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-02</span>    <span class="hljs-number">1.401227</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-03</span>    <span class="hljs-number">1.758539</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-04</span>    <span class="hljs-number">0.628932</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-05</span>   <span class="hljs-number">-0.423776</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-06</span>    <span class="hljs-number">0.789740</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-07</span>    <span class="hljs-number">0.937568</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-08</span>   <span class="hljs-number">-2.253294</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-09</span>   <span class="hljs-number">-1.772919</span></span><br><span class="line">Freq: D, Length: <span class="hljs-number">100</span>, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">211</span>]: ts.resample(<span class="hljs-string">'M'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">211</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-31</span>   <span class="hljs-number">-0.165893</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span><span class="hljs-number">-29</span>    <span class="hljs-number">0.078606</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span><span class="hljs-number">-31</span>    <span class="hljs-number">0.223811</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span><span class="hljs-number">-30</span>   <span class="hljs-number">-0.063643</span></span><br><span class="line">Freq: M, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">212</span>]: ts.resample(<span class="hljs-string">'M'</span>, kind=<span class="hljs-string">'period'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">212</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>   <span class="hljs-number">-0.165893</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span>    <span class="hljs-number">0.078606</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span>    <span class="hljs-number">0.223811</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span>   <span class="hljs-number">-0.063643</span></span><br><span class="line">Freq: M, dtype: float64</span><br></pre></td></tr></table></figure>

<p>resample是一个灵活高效的方法，可用于处理非常大的时间序列。我将通过一系列的示例说明其用法。表11-5总结它的一些选项。</p>
<p>表11-5 resample方法的参数</p>
<p><img src="/images/blog/7178691-b40a57086c904e83.webp" alt="img"></p>
<h2 id="降采样"><a href="#降采样" class="headerlink" title="降采样"></a>降采样</h2><p>将数据聚合到规律的低频率是一件非常普通的时间序列处理任务。待聚合的数据不必拥有固定的频率，期望的频率会自动定义聚合的面元边界，这些面元用于将时间序列拆分为多个片段。例如，要转换到月度频率（’M’或’BM’），数据需要被划分到多个单月时间段中。各时间段都是半开放的。一个数据点只能属于一个时间段，所有时间段的并集必须能组成整个时间帧。在用resample对数据进行降采样时，需要考虑两样东西：</p>
<ul>
<li>各区间哪边是闭合的。</li>
<li>如何标记各个聚合面元，用区间的开头还是末尾。</li>
</ul>
<p>为了说明，我们来看一些“1分钟”数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">213</span>]: rng = pd.date_range(<span class="hljs-string">'2000-01-01'</span>, periods=<span class="hljs-number">12</span>, freq=<span class="hljs-string">'T'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">214</span>]: ts = pd.Series(np.arange(<span class="hljs-number">12</span>), index=rng)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">215</span>]: ts</span><br><span class="line">Out[<span class="hljs-number">215</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">01</span>:<span class="hljs-number">00</span>     <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">02</span>:<span class="hljs-number">00</span>     <span class="hljs-number">2</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">03</span>:<span class="hljs-number">00</span>     <span class="hljs-number">3</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">04</span>:<span class="hljs-number">00</span>     <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>     <span class="hljs-number">5</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">06</span>:<span class="hljs-number">00</span>     <span class="hljs-number">6</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">07</span>:<span class="hljs-number">00</span>     <span class="hljs-number">7</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">08</span>:<span class="hljs-number">00</span>     <span class="hljs-number">8</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">09</span>:<span class="hljs-number">00</span>     <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">10</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">11</span>:<span class="hljs-number">00</span>    <span class="hljs-number">11</span></span><br><span class="line">Freq: T, dtype: int64</span><br></pre></td></tr></table></figure>

<p>假设你想要通过求和的方式将这些数据聚合到“5分钟”块中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">216</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">216</span>]: </span><br><span class="line"><span class="hljs-number">1999</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">23</span>:<span class="hljs-number">55</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>    <span class="hljs-number">40</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">11</span></span><br><span class="line">Freq: <span class="hljs-number">5</span>T, dtype: int64</span><br></pre></td></tr></table></figure>

<p>传入的频率将会以“5分钟”的增量定义面元边界。默认情况下，面元的右边界是包含的，因此00:00到00:05的区间中是包含00:05的。传入closed=’left’会让区间以左边界闭合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">217</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">217</span>]: </span><br><span class="line"><span class="hljs-number">1999</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">23</span>:<span class="hljs-number">55</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>    <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>    <span class="hljs-number">40</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">11</span></span><br><span class="line">Freq: <span class="hljs-number">5</span>T, dtype: int64</span><br></pre></td></tr></table></figure>

<p>如你所见，最终的时间序列是以各面元右边界的时间戳进行标记的。传入label=’right’即可用面元的邮编界对其进行标记：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">218</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>, label=<span class="hljs-string">'right'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">218</span>]: </span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>    <span class="hljs-number">15</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">40</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">15</span>:<span class="hljs-number">00</span>    <span class="hljs-number">11</span></span><br><span class="line">Freq: <span class="hljs-number">5</span>T, dtype: int64</span><br></pre></td></tr></table></figure>

<p>图11-3说明了“1分钟”数据被转换为“5分钟”数据的处理过程。</p>
<p><img src="/images/blog/7178691-7a77f47844f2ee8c.webp" alt="img"></p>
<p>图11-3 各种closed、label约定的“5分钟”重采样演示</p>
<p>最后，你可能希望对结果索引做一些位移，比如从右边界减去一秒以便更容易明白该时间戳到底表示的是哪个区间。只需通过loffset设置一个字符串或日期偏移量即可实现这个目的：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">219</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>,</span><br><span class="line">   .....:             label=<span class="hljs-string">'right'</span>, loffset=<span class="hljs-string">'-1s'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">219</span>]: </span><br><span class="line"><span class="hljs-number">1999</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">23</span>:<span class="hljs-number">59</span>:<span class="hljs-number">59</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">04</span>:<span class="hljs-number">59</span>    <span class="hljs-number">15</span></span><br><span class="line">In [<span class="hljs-number">219</span>]: ts.resample(<span class="hljs-string">'5min'</span>, closed=<span class="hljs-string">'right'</span>,</span><br><span class="line">   .....:             label=<span class="hljs-string">'right'</span>, loffset=<span class="hljs-string">'-1s'</span>).sum()</span><br><span class="line">Out[<span class="hljs-number">219</span>]: </span><br><span class="line"><span class="hljs-number">1999</span><span class="hljs-number">-12</span><span class="hljs-number">-31</span> <span class="hljs-number">23</span>:<span class="hljs-number">59</span>:<span class="hljs-number">59</span>     <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">04</span>:<span class="hljs-number">59</span>    <span class="hljs-number">15</span></span><br></pre></td></tr></table></figure>

<p>此外，也可以通过调用结果对象的shift方法来实现该目的，这样就不需要设置loffset了。</p>
<h2 id="OHLC重采样"><a href="#OHLC重采样" class="headerlink" title="OHLC重采样"></a>OHLC重采样</h2><p>金融领域中有一种无所不在的时间序列聚合方式，即计算各面元的四个值：第一个值（open，开盘）、最后一个值（close，收盘）、最大值（high，最高）以及最小值（low，最低）。传入how=’ohlc’即可得到一个含有这四种聚合值的DataFrame。整个过程很高效，只需一次扫描即可计算出结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">220</span>]: ts.resample(<span class="hljs-string">'5min'</span>).ohlc()</span><br><span class="line">Out[<span class="hljs-number">220</span>]: </span><br><span class="line">                     open  high  low  close</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">00</span>:<span class="hljs-number">00</span>     <span class="hljs-number">0</span>     <span class="hljs-number">4</span>    <span class="hljs-number">0</span>      <span class="hljs-number">4</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">05</span>:<span class="hljs-number">00</span>     <span class="hljs-number">5</span>     <span class="hljs-number">9</span>    <span class="hljs-number">5</span>      <span class="hljs-number">9</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-01</span> <span class="hljs-number">00</span>:<span class="hljs-number">10</span>:<span class="hljs-number">00</span>    <span class="hljs-number">10</span>    <span class="hljs-number">11</span>   <span class="hljs-number">10</span>     <span class="hljs-number">11</span></span><br></pre></td></tr></table></figure>

<h2 id="升采样和插值"><a href="#升采样和插值" class="headerlink" title="升采样和插值"></a>升采样和插值</h2><p>在将数据从低频率转换到高频率时，就不需要聚合了。我们来看一个带有一些周型数据的DataFrame：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">221</span>]: frame = pd.DataFrame(np.random.randn(<span class="hljs-number">2</span>, <span class="hljs-number">4</span>),</span><br><span class="line">   .....:                      index=pd.date_range(<span class="hljs-string">'1/1/2000'</span>, periods=<span class="hljs-number">2</span>,</span><br><span class="line">   .....:                                          freq=<span class="hljs-string">'W-WED'</span>),</span><br><span class="line">   .....:                      columns=[<span class="hljs-string">'Colorado'</span>, <span class="hljs-string">'Texas'</span>, <span class="hljs-string">'New York'</span>, <span class="hljs-string">'Ohio'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">222</span>]: frame</span><br><span class="line">Out[<span class="hljs-number">222</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<p>当你对这个数据进行聚合，每组只有一个值，这样就会引入缺失值。我们使用asfreq方法转换成高频，不经过聚合：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">223</span>]: df_daily = frame.resample(<span class="hljs-string">'D'</span>).asfreq()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">224</span>]: df_daily</span><br><span class="line">Out[<span class="hljs-number">224</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-11</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<p>假设你想要用前面的周型值填充“非星期三”。resampling的填充和插值方式跟fillna和reindex的一样：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">225</span>]: frame.resample(<span class="hljs-string">'D'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">225</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-11</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<p>同样，这里也可以只填充指定的时期数（目的是限制前面的观测值的持续使用距离）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">226</span>]: frame.resample(<span class="hljs-string">'D'</span>).ffill(limit=<span class="hljs-number">2</span>)</span><br><span class="line">Out[<span class="hljs-number">226</span>]:</span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-05</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-11</span>       NaN       NaN       NaN       NaN</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-12</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<p>注意，新的日期索引完全没必要跟旧的重叠：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">227</span>]: frame.resample(<span class="hljs-string">'W-THU'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">227</span>]: </span><br><span class="line">            Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span> <span class="hljs-number">-0.896431</span>  <span class="hljs-number">0.677263</span>  <span class="hljs-number">0.036503</span>  <span class="hljs-number">0.087102</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span><span class="hljs-number">-13</span> <span class="hljs-number">-0.046662</span>  <span class="hljs-number">0.927238</span>  <span class="hljs-number">0.482284</span> <span class="hljs-number">-0.867130</span></span><br></pre></td></tr></table></figure>

<h2 id="通过时期进行重采样"><a href="#通过时期进行重采样" class="headerlink" title="通过时期进行重采样"></a>通过时期进行重采样</h2><p>对那些使用时期索引的数据进行重采样与时间戳很像：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">228</span>]: frame = pd.DataFrame(np.random.randn(<span class="hljs-number">24</span>, <span class="hljs-number">4</span>),</span><br><span class="line">   .....:                      index=pd.period_range(<span class="hljs-string">'1-2000'</span>, <span class="hljs-string">'12-2001'</span>,</span><br><span class="line">   .....:                                            freq=<span class="hljs-string">'M'</span>),</span><br><span class="line">   .....:                      columns=[<span class="hljs-string">'Colorado'</span>, <span class="hljs-string">'Texas'</span>, <span class="hljs-string">'New York'</span>, <span class="hljs-string">'Ohio'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">229</span>]: frame[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">229</span>]: </span><br><span class="line">         Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-01</span>  <span class="hljs-number">0.493841</span> <span class="hljs-number">-0.155434</span>  <span class="hljs-number">1.397286</span>  <span class="hljs-number">1.507055</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-02</span> <span class="hljs-number">-1.179442</span>  <span class="hljs-number">0.443171</span>  <span class="hljs-number">1.395676</span> <span class="hljs-number">-0.529658</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-03</span>  <span class="hljs-number">0.787358</span>  <span class="hljs-number">0.248845</span>  <span class="hljs-number">0.743239</span>  <span class="hljs-number">1.267746</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-04</span>  <span class="hljs-number">1.302395</span> <span class="hljs-number">-0.272154</span> <span class="hljs-number">-0.051532</span> <span class="hljs-number">-0.467740</span></span><br><span class="line"><span class="hljs-number">2000</span><span class="hljs-number">-05</span> <span class="hljs-number">-1.040816</span>  <span class="hljs-number">0.426419</span>  <span class="hljs-number">0.312945</span> <span class="hljs-number">-1.115689</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">230</span>]: annual_frame = frame.resample(<span class="hljs-string">'A-DEC'</span>).mean()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">231</span>]: annual_frame</span><br><span class="line">Out[<span class="hljs-number">231</span>]: </span><br><span class="line">      Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span>  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br></pre></td></tr></table></figure>

<p>升采样要稍微麻烦一些，因为你必须决定在新频率中各区间的哪端用于放置原来的值，就像asfreq方法那样。convention参数默认为’start’，也可设置为’end’：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-comment"># Q-DEC: Quarterly, year ending in December</span></span><br><span class="line">In [<span class="hljs-number">232</span>]: annual_frame.resample(<span class="hljs-string">'Q-DEC'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">232</span>]: </span><br><span class="line">        Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span>Q1  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2000</span>Q2  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2000</span>Q3  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2000</span>Q4  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q1  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2001</span>Q2  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2001</span>Q3  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2001</span>Q4  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">233</span>]: annual_frame.resample(<span class="hljs-string">'Q-DEC'</span>, convention=<span class="hljs-string">'end'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">233</span>]: </span><br><span class="line">        Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span>Q4  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q1  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q2  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q3  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q4  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br></pre></td></tr></table></figure>

<p>由于时期指的是时间区间，所以升采样和降采样的规则就比较严格：</p>
<ul>
<li>在降采样中，目标频率必须是源频率的子时期（subperiod）。</li>
<li>在升采样中，目标频率必须是源频率的超时期（superperiod）。</li>
</ul>
<p>如果不满足这些条件，就会引发异常。这主要影响的是按季、年、周计算的频率。例如，由Q-MAR定义的时间区间只能升采样为A-MAR、A-JUN、A-SEP、A-DEC等：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">234</span>]: annual_frame.resample(<span class="hljs-string">'Q-MAR'</span>).ffill()</span><br><span class="line">Out[<span class="hljs-number">234</span>]: </span><br><span class="line">        Colorado     Texas  New York      Ohio</span><br><span class="line"><span class="hljs-number">2000</span>Q4  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q1  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q2  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q3  <span class="hljs-number">0.556703</span>  <span class="hljs-number">0.016631</span>  <span class="hljs-number">0.111873</span> <span class="hljs-number">-0.027445</span></span><br><span class="line"><span class="hljs-number">2001</span>Q4  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2002</span>Q1  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2002</span>Q2  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br><span class="line"><span class="hljs-number">2002</span>Q3  <span class="hljs-number">0.046303</span>  <span class="hljs-number">0.163344</span>  <span class="hljs-number">0.251503</span> <span class="hljs-number">-0.157276</span></span><br></pre></td></tr></table></figure>

<h1 id="11-7-移动窗口函数"><a href="#11-7-移动窗口函数" class="headerlink" title="11.7 移动窗口函数"></a>11.7 移动窗口函数</h1><p>在移动窗口（可以带有指数衰减权数）上计算的各种统计函数也是一类常见于时间序列的数组变换。这样可以圆滑噪音数据或断裂数据。我将它们称为移动窗口函数（moving window function），其中还包括那些窗口不定长的函数（如指数加权移动平均）。跟其他统计函数一样，移动窗口函数也会自动排除缺失值。</p>
<p>开始之前，我们加载一些时间序列数据，将其重采样为工作日频率：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">235</span>]: close_px_all = pd.read_csv(<span class="hljs-string">'examples/stock_px_2.csv'</span>,</span><br><span class="line">   .....:                            parse_dates=<span class="hljs-literal">True</span>, index_col=<span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">236</span>]: close_px = close_px_all[[<span class="hljs-string">'AAPL'</span>, <span class="hljs-string">'MSFT'</span>, <span class="hljs-string">'XOM'</span>]]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">237</span>]: close_px = close_px.resample(<span class="hljs-string">'B'</span>).ffill()</span><br></pre></td></tr></table></figure>

<p>现在引入rolling运算符，它与resample和groupby很像。可以在TimeSeries或DataFrame以及一个window（表示期数，见图11-4）上调用它：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">238</span>]: close_px.AAPL.plot()</span><br><span class="line">Out[<span class="hljs-number">238</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7f2f2570cf98</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">239</span>]: close_px.AAPL.rolling(<span class="hljs-number">250</span>).mean().plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-3327483eab730b09.webp" alt="img"></p>
<p>图11-4 苹果公司股价的250日均线</p>
<p>表达式rolling(250)与groupby很像，但不是对其进行分组，而是创建一个按照250天分组的滑动窗口对象。然后，我们就得到了苹果公司股价的250天的移动窗口。</p>
<p>默认情况下，rolling函数需要窗口中所有的值为非NA值。可以修改该行为以解决缺失数据的问题。其实，在时间序列开始处尚不足窗口期的那些数据就是个特例（见图11-5）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">241</span>]: appl_std250 = close_px.AAPL.rolling(<span class="hljs-number">250</span>, min_periods=<span class="hljs-number">10</span>).std()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">242</span>]: appl_std250[<span class="hljs-number">5</span>:<span class="hljs-number">12</span>]</span><br><span class="line">Out[<span class="hljs-number">242</span>]: </span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>         NaN</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>         NaN</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-13</span>         NaN</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>         NaN</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>    <span class="hljs-number">0.077496</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-16</span>    <span class="hljs-number">0.074760</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-17</span>    <span class="hljs-number">0.112368</span></span><br><span class="line">Freq: B, Name: AAPL, dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">243</span>]: appl_std250.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-15f565bed1ccad09.webp" alt="img"></p>
<p>图11-5 苹果公司250日每日回报标准差</p>
<p>要计算扩展窗口平均（expanding window mean），可以使用expanding而不是rolling。“扩展”意味着，从时间序列的起始处开始窗口，增加窗口直到它超过所有的序列。apple_std250时间序列的扩展窗口平均如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">244</span>]: expanding_mean = appl_std250.expanding().mean()</span><br></pre></td></tr></table></figure>

<p>对DataFrame调用rolling_mean（以及与之类似的函数）会将转换应用到所有的列上（见图11-6）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">246</span>]: close_px.rolling(<span class="hljs-number">60</span>).mean().plot(logy=<span class="hljs-literal">True</span>)</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-979f748052b2279f.webp" alt="img"></p>
<p>图11-6 各股价60日均线（对数Y轴）</p>
<p>rolling函数也可以接受一个指定固定大小时间补偿字符串，而不是一组时期。这样可以方便处理不规律的时间序列。这些字符串也可以传递给resample。例如，我们可以计算20天的滚动均值，如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">247</span>]: close_px.rolling(<span class="hljs-string">'20D'</span>).mean()</span><br><span class="line">Out[<span class="hljs-number">247</span>]:</span><br><span class="line">                  AAPL       MSFT        XOM</span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-02</span>    <span class="hljs-number">7.400000</span>  <span class="hljs-number">21.110000</span>  <span class="hljs-number">29.220000</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-03</span>    <span class="hljs-number">7.425000</span>  <span class="hljs-number">21.125000</span>  <span class="hljs-number">29.230000</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-06</span>    <span class="hljs-number">7.433333</span>  <span class="hljs-number">21.256667</span>  <span class="hljs-number">29.473333</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-07</span>    <span class="hljs-number">7.432500</span>  <span class="hljs-number">21.425000</span>  <span class="hljs-number">29.342500</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-08</span>    <span class="hljs-number">7.402000</span>  <span class="hljs-number">21.402000</span>  <span class="hljs-number">29.240000</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-09</span>    <span class="hljs-number">7.391667</span>  <span class="hljs-number">21.490000</span>  <span class="hljs-number">29.273333</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-10</span>    <span class="hljs-number">7.387143</span>  <span class="hljs-number">21.558571</span>  <span class="hljs-number">29.238571</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-13</span>    <span class="hljs-number">7.378750</span>  <span class="hljs-number">21.633750</span>  <span class="hljs-number">29.197500</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-14</span>    <span class="hljs-number">7.370000</span>  <span class="hljs-number">21.717778</span>  <span class="hljs-number">29.194444</span></span><br><span class="line"><span class="hljs-number">2003</span><span class="hljs-number">-01</span><span class="hljs-number">-15</span>    <span class="hljs-number">7.355000</span>  <span class="hljs-number">21.757000</span>  <span class="hljs-number">29.152000</span></span><br><span class="line"><span class="hljs-meta">... </span>               ...        ...        ...</span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-03</span>  <span class="hljs-number">398.002143</span>  <span class="hljs-number">25.890714</span>  <span class="hljs-number">72.413571</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-04</span>  <span class="hljs-number">396.802143</span>  <span class="hljs-number">25.807857</span>  <span class="hljs-number">72.427143</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-05</span>  <span class="hljs-number">395.751429</span>  <span class="hljs-number">25.729286</span>  <span class="hljs-number">72.422857</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-06</span>  <span class="hljs-number">394.099286</span>  <span class="hljs-number">25.673571</span>  <span class="hljs-number">72.375714</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-07</span>  <span class="hljs-number">392.479333</span>  <span class="hljs-number">25.712000</span>  <span class="hljs-number">72.454667</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-10</span>  <span class="hljs-number">389.351429</span>  <span class="hljs-number">25.602143</span>  <span class="hljs-number">72.527857</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-11</span>  <span class="hljs-number">388.505000</span>  <span class="hljs-number">25.674286</span>  <span class="hljs-number">72.835000</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-12</span>  <span class="hljs-number">388.531429</span>  <span class="hljs-number">25.810000</span>  <span class="hljs-number">73.400714</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-13</span>  <span class="hljs-number">388.826429</span>  <span class="hljs-number">25.961429</span>  <span class="hljs-number">73.905000</span></span><br><span class="line"><span class="hljs-number">2011</span><span class="hljs-number">-10</span><span class="hljs-number">-14</span>  <span class="hljs-number">391.038000</span>  <span class="hljs-number">26.048667</span>  <span class="hljs-number">74.185333</span></span><br><span class="line">[<span class="hljs-number">2292</span> rows x <span class="hljs-number">3</span> columns]</span><br></pre></td></tr></table></figure>

<h2 id="指数加权函数"><a href="#指数加权函数" class="headerlink" title="指数加权函数"></a>指数加权函数</h2><p>另一种使用固定大小窗口及相等权数观测值的办法是，定义一个衰减因子（decay factor）常量，以便使近期的观测值拥有更大的权数。衰减因子的定义方式有很多，比较流行的是使用时间间隔（span），它可以使结果兼容于窗口大小等于时间间隔的简单移动窗口（simple moving window）函数。</p>
<p>由于指数加权统计会赋予近期的观测值更大的权数，因此相对于等权统计，它能“适应”更快的变化。</p>
<p>除了rolling和expanding，pandas还有ewm运算符。下面这个例子对比了苹果公司股价的30日移动平均和span=30的指数加权移动平均（如图11-7所示）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">249</span>]: aapl_px = close_px.AAPL[<span class="hljs-string">'2006'</span>:<span class="hljs-string">'2007'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">250</span>]: ma60 = aapl_px.rolling(<span class="hljs-number">30</span>, min_periods=<span class="hljs-number">20</span>).mean()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">251</span>]: ewma60 = aapl_px.ewm(span=<span class="hljs-number">30</span>).mean()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">252</span>]: ma60.plot(style=<span class="hljs-string">'k--'</span>, label=<span class="hljs-string">'Simple MA'</span>)</span><br><span class="line">Out[<span class="hljs-number">252</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7f2f252161d0</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">253</span>]: ewma60.plot(style=<span class="hljs-string">'k-'</span>, label=<span class="hljs-string">'EW MA'</span>)</span><br><span class="line">Out[<span class="hljs-number">253</span>]: &lt;matplotlib.axes._subplots.AxesSubplot at <span class="hljs-number">0x7f2f252161d0</span>&gt;</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">254</span>]: plt.legend()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-dae48defe3749fad.webp" alt="img"></p>
<p>图11-7 简单移动平均与指数加权移动平均</p>
<h2 id="二元移动窗口函数"><a href="#二元移动窗口函数" class="headerlink" title="二元移动窗口函数"></a>二元移动窗口函数</h2><p>有些统计运算（如相关系数和协方差）需要在两个时间序列上执行。例如，金融分析师常常对某只股票对某个参考指数（如标准普尔500指数）的相关系数感兴趣。要进行说明，我们先计算我们感兴趣的时间序列的百分数变化：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">256</span>]: spx_px = close_px_all[<span class="hljs-string">'SPX'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">257</span>]: spx_rets = spx_px.pct_change()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">258</span>]: returns = close_px.pct_change()</span><br></pre></td></tr></table></figure>

<p>调用rolling之后，corr聚合函数开始计算与spx_rets滚动相关系数（结果见图11-8）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">259</span>]: corr = returns.AAPL.rolling(<span class="hljs-number">125</span>, min_periods=<span class="hljs-number">100</span>).corr(spx_rets)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">260</span>]: corr.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-e81e0f602b4db0ed.webp" alt="img"></p>
<p>图11-8 AAPL 6个月的回报与标准普尔500指数的相关系数</p>
<p>假设你想要一次性计算多只股票与标准普尔500指数的相关系数。虽然编写一个循环并新建一个DataFrame不是什么难事，但比较啰嗦。其实，只需传入一个TimeSeries和一个DataFrame，rolling_corr就会自动计算TimeSeries（本例中就是spx_rets）与DataFrame各列的相关系数。结果如图11-9所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">262</span>]: corr = returns.rolling(<span class="hljs-number">125</span>, min_periods=<span class="hljs-number">100</span>).corr(spx_rets)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">263</span>]: corr.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-0a54a028a62b9b50.webp" alt="img"></p>
<p>图11-9 3只股票6个月的回报与标准普尔500指数的相关系数</p>
<h2 id="用户定义的移动窗口函数"><a href="#用户定义的移动窗口函数" class="headerlink" title="用户定义的移动窗口函数"></a>用户定义的移动窗口函数</h2><p>rolling_apply函数使你能够在移动窗口上应用自己设计的数组函数。唯一要求的就是：该函数要能从数组的各个片段中产生单个值（即约简）。比如说，当我们用rolling(…).quantile(q)计算样本分位数时，可能对样本中特定值的百分等级感兴趣。scipy.stats.percentileofscore函数就能达到这个目的（结果见图11-10）：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">265</span>]: <span class="hljs-keyword">from</span> scipy.stats <span class="hljs-keyword">import</span> percentileofscore</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">266</span>]: score_at_2percent = <span class="hljs-keyword">lambda</span> x: percentileofscore(x, <span class="hljs-number">0.02</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">267</span>]: result = returns.AAPL.rolling(<span class="hljs-number">250</span>).apply(score_at_2percent)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">268</span>]: result.plot()</span><br></pre></td></tr></table></figure>

<p><img src="/images/blog/7178691-af49e84a90c23c1e.webp" alt="img"></p>
<p>图11-10 AAPL 2%回报率的百分等级（一年窗口期）</p>
<p>如果你没安装SciPy，可以使用conda或pip安装。</p>
<h1 id="11-8-总结"><a href="#11-8-总结" class="headerlink" title="11.8 总结"></a>11.8 总结</h1><p>与前面章节接触的数据相比，时间序列数据要求不同类型的分析和数据转换工具。</p>
<p>在接下来的章节中，我们将学习一些高级的pandas方法和如何开始使用建模库statsmodels和scikit-learn。</p>

        </div>
        
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-03T11:13:07.000Z">2019-10-03</time>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    2 分钟 读完 (大约 345 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/03/matplotlib%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/">matplotlib中文显示问题</a>
            
        </h1>
        <div class="content">
            <ol>
<li>查看matplotlib默认的设置文件所在位置</li>
</ol>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> matplotlib</span><br><span class="line">print(matplotlib.matplotlib_fname())</span><br></pre></td></tr></table></figure>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/10/03/matplotlib%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/10/03/matplotlib%E4%B8%AD%E6%96%87%E6%98%BE%E7%A4%BA%E9%97%AE%E9%A2%98/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-02T07:28:37.000Z">2019-10-02</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">系统配置</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    5 分钟 读完 (大约 817 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/02/manjaro%E7%B3%BB%E7%BB%9F%E5%BF%85%E5%A4%87%E8%BD%AF%E4%BB%B6/">manjaro系统必备软件</a>
            
        </h1>
        <div class="content">
            <blockquote>
<p>一开始使用的是<code>ubuntu</code> 系列的系统，但总有些软件安装好麻烦，即使安装好了，总会字体、介面、图标等等问题。后来经一朋友的帮助下，安装成功了<code>arch</code> ,软件库非常丰富，当组件、软件、系统方面有更新会提示升级，非常便捷友好。后来安装<code>QGIS</code>后，检测不到<code>python</code>，使用不了；同时由于我是多系统，一不小心把<strong>GRUB</strong>搞坏了，每次都要进入<code>arch</code>系统都要敲命令改参数。</p>
<p>我不得不考虑更换系统了，那哥们是一条一条命令把<code>arch</code>装好的，对我来说难度有点大。后来了解到arch系列下的<code>manjaro</code>，它不仅美化了介面，也集成了<code>arch</code>的软件管理系统。尝试了下，能够成功使用<code>QGIS</code>,安装系统也像之前安装<code>ubuntu</code>一样便捷。</p>
<p>下面就罗列一些安装必备软件。</p>
</blockquote>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/10/02/manjaro%E7%B3%BB%E7%BB%9F%E5%BF%85%E5%A4%87%E8%BD%AF%E4%BB%B6/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/10/02/manjaro%E7%B3%BB%E7%BB%9F%E5%BF%85%E5%A4%87%E8%BD%AF%E4%BB%B6/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-10-01T10:32:29.000Z">2019-10-01</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">系统配置</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    2 分钟 读完 (大约 274 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/10/01/manjaro%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">manjaro系统配置</a>
            
        </h1>
        <div class="content">
            <h2 id="更换国内源"><a href="#更换国内源" class="headerlink" title="更换国内源"></a>更换国内源</h2><p>使用国内的源有更快的下载速度，pacman能够测试不同源的速度并给它们排名，从中选择一个快的即可。选择的是上海交大sjtu的源。</p>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/10/01/manjaro%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/10/01/manjaro%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-09-28T13:06:53.000Z">2019-09-28</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    18 分钟 读完 (大约 2706 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/28/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-9/">mysql与pandas对照学习(9)</a>
            
        </h1>
        <div class="content">
            <h2 id="Self-join"><a href="#Self-join" class="headerlink" title="Self join"></a>Self join</h2><p><a href="https://sqlzoo.net/wiki/Self_join" target="_blank" rel="noopener">Self join</a></p>
<h3 id="Edinburgh-Buses"><a href="#Edinburgh-Buses" class="headerlink" title="Edinburgh Buses"></a>Edinburgh Buses</h3><p><a href="https://sqlzoo.net/wiki/Edinburgh_Buses." target="_blank" rel="noopener" title="Edinburgh Buses.">Details of the database</a> Looking at the data</p>
<p>stops(<strong>id</strong>, name)
route(<strong>num</strong>, <strong>company</strong>, <strong>pos</strong>, <em>stop</em>)</p>
<table>
<thead>
<tr>
<th><strong>stops</strong></th>
</tr>
</thead>
<tbody><tr>
<td><em>id</em></td>
</tr>
<tr>
<td>name</td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th><strong>route</strong></th>
</tr>
</thead>
<tbody><tr>
<td><em>num</em></td>
</tr>
<tr>
<td><em>company</em></td>
</tr>
<tr>
<td><em>pos</em></td>
</tr>
<tr>
<td>stop</td>
</tr>
</tbody></table>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/09/28/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-9/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/09/28/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-9/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-09-27T11:32:09.000Z">2019-09-27</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    9 分钟 读完 (大约 1390 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/27/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-8/">mysql与pandas对照学习(8)</a>
            
        </h1>
        <div class="content">
            <h2 id="Using-Null"><a href="#Using-Null" class="headerlink" title="Using Null"></a>Using Null</h2><p><a href="https://sqlzoo.net/wiki/Using_Null" target="_blank" rel="noopener">Using Null</a></p>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">dept</th>
<th align="left">name</th>
<th align="left">phone</th>
<th align="left">mobile</th>
</tr>
</thead>
<tbody><tr>
<td align="left">101</td>
<td align="left">1</td>
<td align="left">Shrivell</td>
<td align="left">2753</td>
<td align="left">07986 555 1234</td>
</tr>
<tr>
<td align="left">102</td>
<td align="left">1</td>
<td align="left">Throd</td>
<td align="left">2754</td>
<td align="left">07122 555 1920</td>
</tr>
<tr>
<td align="left">103</td>
<td align="left">1</td>
<td align="left">Splint</td>
<td align="left">2293</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">104</td>
<td align="left"></td>
<td align="left">Spiregrain</td>
<td align="left">3287</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">105</td>
<td align="left">2</td>
<td align="left">Cutflower</td>
<td align="left">3212</td>
<td align="left">07996 555 6574</td>
</tr>
<tr>
<td align="left">106</td>
<td align="left"></td>
<td align="left">Deadyawn</td>
<td align="left">3345</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">…</td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
<td align="left"></td>
</tr>
</tbody></table>
<table>
<thead>
<tr>
<th align="left">id</th>
<th align="left">name</th>
</tr>
</thead>
<tbody><tr>
<td align="left">1</td>
<td align="left">Computing</td>
</tr>
<tr>
<td align="left">2</td>
<td align="left">Design</td>
</tr>
<tr>
<td align="left">3</td>
<td align="left">Engineering</td>
</tr>
<tr>
<td align="left">…</td>
<td align="left"></td>
</tr>
</tbody></table>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/09/27/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-8/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/09/27/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-8/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-09-26T12:19:48.000Z">2019-09-26</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    1 小时 读完 (大约 8287 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/26/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-7/">mysql与pandas对照学习(7)</a>
            
        </h1>
        <div class="content">
            <h2 id="More-JOIN-operations-zh"><a href="#More-JOIN-operations-zh" class="headerlink" title="More JOIN operations/zh"></a>More JOIN operations/zh</h2><p><a href="https://sqlzoo.net/wiki/More_JOIN_operations/zh" target="_blank" rel="noopener">More JOIN operations/zh</a></p>
<blockquote>
<p>关于下面使用<code>ipython-sql</code>模块，查询报错的情况说明：sql语句是没有错误的，可以在终端里进入mysql里运行，只是当有三个表联表查询时，这个模块会运行不下去，卡住。</p>
</blockquote>
<h3 id="電影數據庫"><a href="#電影數據庫" class="headerlink" title="電影數據庫"></a>電影數據庫</h3><p>此教程練習表格合拼。數據庫有三個表格
<code>movie電影(id編號, title電影名稱, yr首影年份, director導演, budget製作費, gross票房收入)</code>
<code>actor演員(id編號, name姓名)</code>
<code>casting角色(movieid電影編號, actorid演員編號, ord角色次序)</code>
角色次序代表第1主角是1, 第2主角是2…如此類推.</p>
<p><a href="https://sqlzoo.net/wiki/More_details_about_the_database." target="_blank" rel="noopener" title="More details about the database.">More details about the database.</a></p>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/09/26/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-7/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/09/26/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-7/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-09-25T12:38:19.000Z">2019-09-25</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    22 分钟 读完 (大约 3252 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/25/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-6/">mysql与pandas对照学习(6)</a>
            
        </h1>
        <div class="content">
            <h2 id="The-JOIN-operation-zh"><a href="#The-JOIN-operation-zh" class="headerlink" title="The JOIN operation/zh"></a>The JOIN operation/zh</h2><p><a href="https://sqlzoo.net/wiki/The_JOIN_operation/zh" target="_blank" rel="noopener">The JOIN operation/zh</a></p>
<p>game(賽事)</p>
<table>
<thead>
<tr>
<th>id(編號)</th>
<th>mdate(日期)</th>
<th>stadium(場館)</th>
<th>team1(隊伍1)</th>
<th>team2(隊伍2)</th>
</tr>
</thead>
<tbody><tr>
<td>1001</td>
<td>8 June 2012</td>
<td>National Stadium, Warsaw</td>
<td>POL</td>
<td>GRE</td>
</tr>
<tr>
<td>1002</td>
<td>8 June 2012</td>
<td>Stadion Miejski (Wroclaw)</td>
<td>RUS</td>
<td>CZE</td>
</tr>
<tr>
<td>1003</td>
<td>12 June 2012</td>
<td>Stadion Miejski (Wroclaw)</td>
<td>GRE</td>
<td>CZE</td>
</tr>
<tr>
<td>1004</td>
<td>12 June 2012</td>
<td>National Stadium, Warsaw</td>
<td>POL</td>
<td>RUS</td>
</tr>
<tr>
<td>…</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/09/25/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-6/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/09/25/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-6/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>








    <div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-09-24T11:47:25.000Z">2019-09-24</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    7 分钟 读完 (大约 1015 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                <a class="has-link-black-ter" href="/2019/09/24/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-5/">mysql与pandas对照学习(5)</a>
            
        </h1>
        <div class="content">
            <h2 id="SUM-and-COUNT-zh"><a href="#SUM-and-COUNT-zh" class="headerlink" title="SUM and COUNT/zh"></a>SUM and COUNT/zh</h2><p><a href="https://sqlzoo.net/wiki/SUM_and_COUNT/zh" target="_blank" rel="noopener">SUM and COUNT/zh</a></p>
<h3 id="全球統計-群組函數"><a href="#全球統計-群組函數" class="headerlink" title="全球統計:群組函數"></a>全球統計:群組函數</h3><p>此教程是有關群組函數，例如COUNT, SUM 和 AVG。群組函數把多個數值運算，得出結果只有一個數值。例如SUM函數會把數值2,4,和5運算成結果11。</p>
<table>
<thead>
<tr>
<th>name</th>
<th>continent</th>
<th>area</th>
<th>population</th>
<th>gdp</th>
</tr>
</thead>
<tbody><tr>
<td>Afghanistan</td>
<td>Asia</td>
<td>652230</td>
<td>25500100</td>
<td>20343000000</td>
</tr>
<tr>
<td>Albania</td>
<td>Europe</td>
<td>28748</td>
<td>2831741</td>
<td>12960000000</td>
</tr>
<tr>
<td>Algeria</td>
<td>Africa</td>
<td>2381741</td>
<td>37100000</td>
<td>188681000000</td>
</tr>
<tr>
<td>Andorra</td>
<td>Europe</td>
<td>468</td>
<td>78115</td>
<td>3712000000</td>
</tr>
<tr>
<td>Angola</td>
<td>Africa</td>
<td>1246700</td>
<td>20609294</td>
<td>100990000000</td>
</tr>
<tr>
<td>…</td>
<td></td>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>name:國家名稱
continent:洲份
area:面積
population:人口
gdp:國內生產總值</p>
<h2 id="示範"><a href="#示範" class="headerlink" title="示範"></a>示範</h2><p><a href="https://sqlzoo.net/wiki/Using_SUM,_Count,_MAX,_DISTINCT_and_ORDER_BY" target="_blank" rel="noopener" title="Using SUM, Count, MAX, DISTINCT and ORDER BY">使用 SUM, Count, MAX, DISTINCT 和 ORDER BY</a>.</p>
        </div>
        
        
        <div class="level is-mobile">
            <div class="level-start">
                <div class="level-item">
                    <!-- 不要跳转到more处 -->
                <a class="button is-size-7 is-light" href="/2019/09/24/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-5/">阅读更多</a>

                <!-- <a class="button is-size-7 is-light" href="/2019/09/24/mysql%E4%B8%8Epandas%E5%AF%B9%E7%85%A7%E5%AD%A6%E4%B9%A0-5/#more">阅读更多</a> -->
                </div>
            </div>
        </div>
        
        
    </div>
</div>









    
<div class="card card-transparent">
    <nav class="pagination is-centered" role="navigation" aria-label="pagination">
        <div class="pagination-previous">
            <a class="is-flex-grow has-text-black-ter" href="/page/2/">上一页</a>
        </div>
        <div class="pagination-next">
            <a class="is-flex-grow has-text-black-ter" href="/page/4/">下一页</a>
        </div>
        <ul class="pagination-list is-hidden-mobile">
            
            <li><a class="pagination-link has-text-black-ter" href="/">1</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/2/">2</a></li>
            
            <li><a class="pagination-link is-current" href="/page/3/">3</a></li>
            
            <li><a class="pagination-link has-text-black-ter" href="/page/4/">4</a></li>
            
        </ul>
    </nav>
</div>
</div>
                        <!-- 修改 -->
    
    
    
    
    <div class="column is-4-tablet is-4-desktop is-3-widescreen  has-order-1 column-left ">
        
            
<div class="card widget">
    <div class="card-content">
        <nav class="level">
            <div class="level-item has-text-centered" style="flex-shrink: 1">
                <div>
                    
                        <img class="image is-128x128 has-mb-6" src="/images/avatar_tiger.jpg" alt="Lanhoo">
                    
                    
                    <p class="is-size-4 is-block">
                        Lanhoo
                    </p>
                    
                    
                    <p class="is-size-6 is-block">
                        Just do it!
                    </p>
                    
                    
                    <p class="is-size-6 is-flex is-flex-center has-text-grey">
                        <i class="fas fa-map-marker-alt has-mr-7"></i>
                        <span>Shenzhen, China</span>
                    </p>
                    
                </div>
            </div>
        </nav>
        <nav class="level is-mobile">
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        文章
                    </p>
                    <p class="title has-text-weight-normal">
                        38
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        分类
                    </p>
                    <p class="title has-text-weight-normal">
                        2
                    </p>
                </div>
            </div>
            <div class="level-item has-text-centered is-marginless">
                <div>
                    <p class="heading">
                        标签
                    </p>
                    <p class="title has-text-weight-normal">
                        17
                    </p>
                </div>
            </div>
        </nav>
        <div class="level">
            <a class="level-item button is-link is-rounded" href="https://github.com/gladall" target="_blank">
                关注我</a>
        </div>
        
        
        <div class="level is-mobile">
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Github" href="https://github.com/gladall">
                
                <i class="fab fa-github"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="Weibo" href="https://weibo.com/gladall">
                
                <i class="fab fa-weibo"></i>
                
            </a>
            
            <a class="level-item button is-white is-marginless" target="_blank"
                title="RSS" href="/atom.xml">
                
                <i class="fas fa-rss"></i>
                
            </a>
            
        </div>
        
    </div>
</div>
        
            

<div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            链接
        </h3>
        <ul class="menu-list">
        
            <li>
                <a class="level is-mobile" href="https://godweiyang.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">韦阳的博客</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">godweiyang.com</span>
                    </span>
                </a>
            </li>
        
            <li>
                <a class="level is-mobile" href="https://easyhexo.com/" target="_blank">
                    <span class="level-left">
                        <span class="level-item">Easy Hexo</span>
                    </span>
                    <span class="level-right">
                        <span class="level-item tag">easyhexo.com</span>
                    </span>
                </a>
            </li>
        
        </ul>
        </div>
    </div>
</div>


        
            
<div class="card widget">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                分类
            </h3>
            <ul class="menu-list">
            <li>
        <a class="level is-marginless" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">
            <span class="level-start">
                <span class="level-item">数据分析</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">28</span>
            </span>
        </a></li><li>
        <a class="level is-marginless" href="/categories/%E7%B3%BB%E7%BB%9F%E9%85%8D%E7%BD%AE/">
            <span class="level-start">
                <span class="level-item">系统配置</span>
            </span>
            <span class="level-end">
                <span class="level-item tag">2</span>
            </span>
        </a></li>
            </ul>
        </div>
    </div>
</div>
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            标签云
        </h3>
        <a href="/tags/SQL/" style="font-size: 15.71px;">SQL</a> <a href="/tags/arch/" style="font-size: 11.43px;">arch</a> <a href="/tags/excel/" style="font-size: 11.43px;">excel</a> <a href="/tags/hexo/" style="font-size: 10px;">hexo</a> <a href="/tags/icarus/" style="font-size: 10px;">icarus</a> <a href="/tags/jupyter/" style="font-size: 10px;">jupyter</a> <a href="/tags/linux/" style="font-size: 12.86px;">linux</a> <a href="/tags/mariadb/" style="font-size: 10px;">mariadb</a> <a href="/tags/matplotlib/" style="font-size: 10px;">matplotlib</a> <a href="/tags/mysql/" style="font-size: 14.29px;">mysql</a> <a href="/tags/pandas/" style="font-size: 18.57px;">pandas</a> <a href="/tags/python/" style="font-size: 17.14px;">python</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/%E5%8D%8E%E5%AE%B9%E9%81%93/" style="font-size: 10px;">华容道</a> <a href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" style="font-size: 20px;">数据分析</a> <a href="/tags/%E8%BD%AF%E4%BB%B6/" style="font-size: 10px;">软件</a> <a href="/tags/%E9%85%8D%E7%BD%AE/" style="font-size: 12.86px;">配置</a>
    </div>
</div>

        
            <div class="card widget">
    <div class="card-content">
        <div class="menu">
        <h3 class="menu-label">
            归档
        </h3>
        <ul class="menu-list">
        
        <li>
            <a class="level is-marginless" href="/archives/2019/11/">
                <span class="level-start">
                    <span class="level-item">十一月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">6</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/10/">
                <span class="level-start">
                    <span class="level-item">十月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">18</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/09/">
                <span class="level-start">
                    <span class="level-item">九月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">10</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/08/">
                <span class="level-start">
                    <span class="level-item">八月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">3</span>
                </span>
            </a>
        </li>
        
        <li>
            <a class="level is-marginless" href="/archives/2019/07/">
                <span class="level-start">
                    <span class="level-item">七月 2019</span>
                </span>
                <span class="level-end">
                    <span class="level-item tag">1</span>
                </span>
            </a>
        </li>
        
        </ul>
        </div>
    </div>
</div>
        
        
            <div class="column-right-shadow is-hidden-widescreen is-sticky">
            
                
            
                
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-10T11:48:06.000Z">2019-11-10</time></div>
                    <a href="/2019/11/10/%E7%94%A8python%E5%86%99%E4%BA%86%E4%B8%80%E4%B8%AA%E8%A7%A3%E6%95%B0%E5%AD%97%E5%8D%8E%E5%AE%B9%E9%81%93%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A8%8B%E5%BA%8F/" class="has-link-black-ter is-size-6">用python写了一个解数字华容道游戏的程序</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-08T01:12:36.000Z">2019-11-08</time></div>
                    <a href="/2019/11/08/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%8C%89%E7%85%A7%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%87%AA%E5%8A%A8%E6%B1%87%E6%80%BB%E7%BB%9F%E8%AE%A1%E7%9A%84%E8%84%9A%E6%9C%AC/" class="has-link-black-ter is-size-6">分享一个按照模板文件格式自动汇总统计的脚本</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:53:33.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC4%E7%AB%A0%20NumPy%E5%9F%BA%E7%A1%80%EF%BC%9A%E6%95%B0%E7%BB%84%E5%92%8C%E7%9F%A2%E9%87%8F%E8%AE%A1%E7%AE%97/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第4章 NumPy基础：数组和矢量计算</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:52:29.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC3%E7%AB%A0%20Python%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%81%E5%87%BD%E6%95%B0%E5%92%8C%E6%96%87%E4%BB%B6/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第3章 Python的数据结构、函数和文件</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:51:17.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC2%E7%AB%A0%20Python%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80%EF%BC%8CIPython%E5%92%8CJupyter%20Notebooks/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第2章 Python语法基础，IPython和Jupyter Notebooks</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

            
            </div>
        
    </div>
    
    
    <!-- 粘贴的部分 -->
    
                        <!-- 修改 -->
    
    
    
    
    <div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right is-sticky">
        
            
        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-10T11:48:06.000Z">2019-11-10</time></div>
                    <a href="/2019/11/10/%E7%94%A8python%E5%86%99%E4%BA%86%E4%B8%80%E4%B8%AA%E8%A7%A3%E6%95%B0%E5%AD%97%E5%8D%8E%E5%AE%B9%E9%81%93%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A8%8B%E5%BA%8F/" class="has-link-black-ter is-size-6">用python写了一个解数字华容道游戏的程序</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-08T01:12:36.000Z">2019-11-08</time></div>
                    <a href="/2019/11/08/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%8C%89%E7%85%A7%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%87%AA%E5%8A%A8%E6%B1%87%E6%80%BB%E7%BB%9F%E8%AE%A1%E7%9A%84%E8%84%9A%E6%9C%AC/" class="has-link-black-ter is-size-6">分享一个按照模板文件格式自动汇总统计的脚本</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:53:33.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC4%E7%AB%A0%20NumPy%E5%9F%BA%E7%A1%80%EF%BC%9A%E6%95%B0%E7%BB%84%E5%92%8C%E7%9F%A2%E9%87%8F%E8%AE%A1%E7%AE%97/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第4章 NumPy基础：数组和矢量计算</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:52:29.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC3%E7%AB%A0%20Python%E7%9A%84%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E3%80%81%E5%87%BD%E6%95%B0%E5%92%8C%E6%96%87%E4%BB%B6/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第3章 Python的数据结构、函数和文件</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T01:51:17.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC2%E7%AB%A0%20Python%E8%AF%AD%E6%B3%95%E5%9F%BA%E7%A1%80%EF%BC%8CIPython%E5%92%8CJupyter%20Notebooks/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第2章 Python语法基础，IPython和Jupyter Notebooks</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
        
    </div>
    
    
    <!-- 粘贴的部分 -->
    
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/grid.svg" alt="Lanhoo&#39;s blog" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Lanhoo&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;" target="_blank" rel="noopener">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

<script>
// [].slice.call(document.querySelectorAll('table')).forEach(function(el){
//     var wrapper = document.createElement('div');
//     wrapper.className = 'table-area';
//     el.parentNode.insertBefore(wrapper, el);
//     el.parentNode.removeChild(el);
//     wrapper.appendChild(el);
// })
// 这是给真正的表格添加样式
$(".content > table").wrap("<div class='table-area'></div>");
$("table.dataframe").wrap("<div class='table-area'></div>");
</script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>