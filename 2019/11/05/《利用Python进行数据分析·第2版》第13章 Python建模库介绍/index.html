<!DOCTYPE html>
<html  lang="zh">
<head>
    <meta charset="utf-8">
<title>《利用Python进行数据分析·第2版》第13章 Python建模库介绍 - Lanhoo&#39;s blog</title>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />



    <meta name="description" content="转载自简书 第1章 准备工作 第2章 Python语法基础，IPython和Jupyter Notebooks 第3章 Python的数据结构、函数和文件 第4章 NumPy基础：数组和矢量计算 第5章 pandas入门 第6章 数据加载、存储与文件格式 第7章 数据清洗和准备 第8章 数据规整：聚合、合并和重塑 第9章 绘图和可视化 第10章 数据聚合与分组运算 第11章 时间序列 第12章 p">
<meta name="keywords" content="数据分析,pandas,python">
<meta property="og:type" content="article">
<meta property="og:title" content="《利用Python进行数据分析·第2版》第13章 Python建模库介绍">
<meta property="og:url" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;2019&#x2F;11&#x2F;05&#x2F;%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC13%E7%AB%A0%20Python%E5%BB%BA%E6%A8%A1%E5%BA%93%E4%BB%8B%E7%BB%8D&#x2F;index.html">
<meta property="og:site_name" content="Lanhoo&#39;s blog">
<meta property="og:description" content="转载自简书 第1章 准备工作 第2章 Python语法基础，IPython和Jupyter Notebooks 第3章 Python的数据结构、函数和文件 第4章 NumPy基础：数组和矢量计算 第5章 pandas入门 第6章 数据加载、存储与文件格式 第7章 数据清洗和准备 第8章 数据规整：聚合、合并和重塑 第9章 绘图和可视化 第10章 数据聚合与分组运算 第11章 时间序列 第12章 p">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;images&#x2F;og_image.png">
<meta property="og:updated_time" content="2019-12-11T02:21:33.306Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https:&#x2F;&#x2F;glanhoo.coding.me&#x2F;images&#x2F;og_image.png">







<link rel="icon" href="/images/grid32.ico">


<!-- 添加用户的样式，用来修改表格样式 -->
<!-- 效果不好，代码块也是表格，把代码块也变了 -->
<link rel="stylesheet" href="/css/user2.css" media="screen" type="text/css">

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-146455672-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-146455672-1');
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.7.2/css/bulma.css">
<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.4.1/css/all.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Ubuntu:400,600|Source+Code+Pro">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@9.12.0/styles/atom-one-dark.css">


    
    
    
    <style>body>.footer,body>.navbar,body>.section{opacity:0}</style>
    

    
    
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/css/lightgallery.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/css/justifiedGallery.min.css">
    

    
    

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css">


    
    
    
    

<link rel="stylesheet" href="/css/back-to-top.css">


    
    

    
    
<script>
var _hmt = _hmt || [];
(function() {
    var hm = document.createElement("script");
    hm.src = "//hm.baidu.com/hm.js?98b898946b9cfb37b87a64ed209f07db";
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(hm, s);
})();
</script>

    
    

    
    
<link rel="stylesheet" href="/css/progressbar.css">
<script src="https://cdn.jsdelivr.net/npm/pace-js@1.0.2/pace.min.js"></script>

    
    
    

    
    
    


<link rel="stylesheet" href="/css/style.css">
<link rel="alternate" href="/atom.xml" title="Lanhoo's blog" type="application/atom+xml">
</head>
<body class="is-3-column">
    <nav class="navbar navbar-main">
    <div class="container">
        <div class="navbar-brand is-flex-center">
            <a class="navbar-item navbar-logo" href="/">
            
                <img src="/images/grid.svg" alt="《利用Python进行数据分析·第2版》第13章 Python建模库介绍" height="28">
            
            </a>
        </div>
        <div class="navbar-menu">
            
            <div class="navbar-start">
                
                <a class="navbar-item"
                href="/">主页</a>
                
                <a class="navbar-item"
                href="/archives">归档</a>
                
                <a class="navbar-item"
                href="/categories">分类</a>
                
                <a class="navbar-item"
                href="/tags">标签</a>
                
                <a class="navbar-item"
                href="/about">关于</a>
                
            </div>
            
            <div class="navbar-end">
                
                
                <a class="navbar-item is-hidden-tablet catalogue" title="目录" href="javascript:;" target="_blank" rel="noopener">
                    <i class="fas fa-list-ul"></i>
                </a>
                
                
                <a class="navbar-item search" title="搜索" href="javascript:;" target="_blank" rel="noopener">
                    <i class="fas fa-search"></i>
                </a>
                
            </div>
        </div>
    </div>
</nav>
    
    
    <section class="section">
        <div class="container">
            <div class="columns">
                <!-- 将main_column_class() 改为 col() -->
                <div class="column is-6-tablet is-6-desktop is-9-widescreen has-order-2 column-main"><div class="card">
    
    <div class="card-content article ">
        
        <div class="level article-meta is-size-7 is-uppercase is-mobile is-overflow-x-auto">
            <div class="level-left">

                

                <time class="level-item has-text-grey" datetime="2019-11-05T02:02:53.000Z">2019-11-05</time>
                
                <div class="level-item">
                <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                </div>
                
                
                <span class="level-item has-text-grey">
                    
                    
                    36 分钟 读完 (大约 5430 个字)
                </span>
                
                
            </div>
        </div>
        
        <h1 class="title is-size-3 is-size-4-mobile has-text-weight-normal">
            
                《利用Python进行数据分析·第2版》第13章 Python建模库介绍
            
        </h1>
        <div class="content">
            <p>转载自<a href="https://www.jianshu.com/p/e46a1ac36aa5" target="_blank" rel="noopener">简书</a></p>
<p><a href="../《利用Python进行数据分析·第2版》第1章%20准备工作">第1章 准备工作</a><br> <a href="../《利用Python进行数据分析·第2版》第2章%20Python语法基础，IPython和Jupyter%20Notebooks">第2章 Python语法基础，IPython和Jupyter Notebooks</a><br> <a href="../《利用Python进行数据分析·第2版》第3章%20Python的数据结构、函数和文件">第3章 Python的数据结构、函数和文件</a><br> <a href="../《利用Python进行数据分析·第2版》第4章%20NumPy基础：数组和矢量计算">第4章 NumPy基础：数组和矢量计算</a><br> <a href="../《利用Python进行数据分析·第2版》第5章%20pandas入门">第5章 pandas入门</a><br> <a href="../《利用Python进行数据分析·第2版》第6章%20数据加载、存储与文件格式">第6章 数据加载、存储与文件格式</a><br> <a href="../《利用Python进行数据分析·第2版》第7章%20数据清洗和准备">第7章 数据清洗和准备</a><br> <a href="../《利用Python进行数据分析·第2版》第8章%20数据规整：聚合、合并和重塑">第8章 数据规整：聚合、合并和重塑</a><br> <a href="../《利用Python进行数据分析·第2版》第9章%20绘图和可视化">第9章 绘图和可视化</a><br> <a href="../《利用Python进行数据分析·第2版》第10章%20数据聚合与分组运算">第10章 数据聚合与分组运算</a><br> <a href="../《利用Python进行数据分析·第2版》第11章%20时间序列">第11章 时间序列</a><br> <a href="../《利用Python进行数据分析·第2版》第12章%20pandas高级应用">第12章 pandas高级应用</a><br>第13章 Python建模库介绍<br> <a href="../《利用Python进行数据分析·第2版》第14章%20数据分析案例">第14章 数据分析案例</a><br> <a href="../《利用Python进行数据分析·第2版》附录A%20NumPy高级应用">附录A NumPy高级应用</a><br> <a href="../《利用Python进行数据分析·第2版》附录B%20更多关于IPython的内容（完）">附录B 更多关于IPython的内容（完）</a>      </p>
<a id="more"></a>

<hr>
<p>本书中，我已经介绍了Python数据分析的编程基础。因为数据分析师和科学家总是在数据规整和准备上花费大量时间，这本书的重点在于掌握这些功能。</p>
<p>开发模型选用什么库取决于应用本身。许多统计问题可以用简单方法解决，比如普通的最小二乘回归，其它问题可能需要复杂的机器学习方法。幸运的是，Python已经成为了运用这些分析方法的语言之一，因此读完此书，你可以探索许多工具。</p>
<p>本章中，我会回顾一些pandas的特点，在你胶着于pandas数据规整和模型拟合和评分时，它们可能派上用场。然后我会简短介绍两个流行的建模工具，statsmodels和scikit-learn。这二者每个都值得再写一本书，我就不做全面的介绍，而是建议你学习两个项目的线上文档和其它基于Python的数据科学、统计和机器学习的书籍。</p>
<h1 id="13-1-pandas与模型代码的接口"><a href="#13-1-pandas与模型代码的接口" class="headerlink" title="13.1 pandas与模型代码的接口"></a>13.1 pandas与模型代码的接口</h1><p>模型开发的通常工作流是使用pandas进行数据加载和清洗，然后切换到建模库进行建模。开发模型的重要一环是机器学习中的“特征工程”。它可以描述从原始数据集中提取信息的任何数据转换或分析，这些数据集可能在建模中有用。本书中学习的数据聚合和GroupBy工具常用于特征工程中。</p>
<p>优秀的特征工程超出了本书的范围，我会尽量直白地介绍一些用于数据操作和建模切换的方法。</p>
<p>pandas与其它分析库通常是靠NumPy的数组联系起来的。将DataFrame转换为NumPy数组，可以使用.values属性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">10</span>]: <span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">11</span>]: <span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">12</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">0.01</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">0.</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">-1.5</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">3.6</span>, <span class="hljs-number">1.3</span>, <span class="hljs-number">-2.</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">13</span>]: data</span><br><span class="line">Out[<span class="hljs-number">13</span>]: </span><br><span class="line">   x0    x1    y</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">14</span>]: data.columns</span><br><span class="line">Out[<span class="hljs-number">14</span>]: Index([<span class="hljs-string">'x0'</span>, <span class="hljs-string">'x1'</span>, <span class="hljs-string">'y'</span>], dtype=<span class="hljs-string">'object'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">15</span>]: data.values</span><br><span class="line">Out[<span class="hljs-number">15</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>, <span class="hljs-number">-1.5</span> ],</span><br><span class="line">       [ <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>,  <span class="hljs-number">0.</span>  ],</span><br><span class="line">       [ <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>,  <span class="hljs-number">3.6</span> ],</span><br><span class="line">       [ <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ,  <span class="hljs-number">1.3</span> ],</span><br><span class="line">       [ <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  , <span class="hljs-number">-2.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>要转换回DataFrame，可以传递一个二维ndarray，可带有列名：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">16</span>]: df2 = pd.DataFrame(data.values, columns=[<span class="hljs-string">'one'</span>, <span class="hljs-string">'two'</span>, <span class="hljs-string">'three'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">17</span>]: df2</span><br><span class="line">Out[<span class="hljs-number">17</span>]: </span><br><span class="line">   one   two  three</span><br><span class="line"><span class="hljs-number">0</span>  <span class="hljs-number">1.0</span>  <span class="hljs-number">0.01</span>   <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">2.0</span> <span class="hljs-number">-0.01</span>    <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>  <span class="hljs-number">3.0</span>  <span class="hljs-number">0.25</span>    <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>  <span class="hljs-number">4.0</span> <span class="hljs-number">-4.10</span>    <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">5.0</span>  <span class="hljs-number">0.00</span>   <span class="hljs-number">-2.0</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>笔记：最好当数据是均匀的时候使用.values属性。例如，全是数值类型。如果数据是不均匀的，结果会是Python对象的ndarray：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">18</span>]: df3 = data.copy()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">19</span>]: df3[<span class="hljs-string">'strings'</span>] = [<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'c'</span>, <span class="hljs-string">'d'</span>, <span class="hljs-string">'e'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">20</span>]: df3</span><br><span class="line">Out[<span class="hljs-number">20</span>]: </span><br><span class="line">  x0    x1    y strings</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>       a</span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>       b</span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>       c</span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>       d</span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>       e</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">21</span>]: df3.values</span><br><span class="line">Out[<span class="hljs-number">21</span>]: </span><br><span class="line">array([[<span class="hljs-number">1</span>, <span class="hljs-number">0.01</span>, <span class="hljs-number">-1.5</span>, <span class="hljs-string">'a'</span>],</span><br><span class="line">      [<span class="hljs-number">2</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.0</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">      [<span class="hljs-number">3</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">3.6</span>, <span class="hljs-string">'c'</span>],</span><br><span class="line">      [<span class="hljs-number">4</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">1.3</span>, <span class="hljs-string">'d'</span>],</span><br><span class="line">      [<span class="hljs-number">5</span>, <span class="hljs-number">0.0</span>, <span class="hljs-number">-2.0</span>, <span class="hljs-string">'e'</span>]], dtype=object)</span><br></pre></td></tr></table></figure>
</blockquote>
<p>对于一些模型，你可能只想使用列的子集。我建议你使用loc，用values作索引：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">22</span>]: model_cols = [<span class="hljs-string">'x0'</span>, <span class="hljs-string">'x1'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">23</span>]: data.loc[:, model_cols].values</span><br><span class="line">Out[<span class="hljs-number">23</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>],</span><br><span class="line">       [ <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ],</span><br><span class="line">       [ <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>一些库原生支持pandas，会自动完成工作：从DataFrame转换到NumPy，将模型的参数名添加到输出表的列或Series。其它情况，你可以手工进行“元数据管理”。</p>
<p>在第12章，我们学习了pandas的Categorical类型和pandas.get_dummies函数。假设数据集中有一个非数值列：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">24</span>]: data[<span class="hljs-string">'category'</span>] = pd.Categorical([<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:                                   categories=[<span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">25</span>]: data</span><br><span class="line">Out[<span class="hljs-number">25</span>]: </span><br><span class="line">   x0    x1    y category</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>        a</span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>        b</span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>        a</span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>        a</span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>        b</span><br></pre></td></tr></table></figure>

<p>如果我们想替换category列为虚变量，我们可以创建虚变量，删除category列，然后添加到结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">26</span>]: dummies = pd.get_dummies(data.category, prefix=<span class="hljs-string">'category'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">27</span>]: data_with_dummies = data.drop(<span class="hljs-string">'category'</span>, axis=<span class="hljs-number">1</span>).join(dummies)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">28</span>]: data_with_dummies</span><br><span class="line">Out[<span class="hljs-number">28</span>]: </span><br><span class="line">   x0    x1    y  category_a  category_b</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span>           <span class="hljs-number">1</span>           <span class="hljs-number">0</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span>           <span class="hljs-number">0</span>           <span class="hljs-number">1</span></span><br></pre></td></tr></table></figure>

<p>用虚变量拟合某些统计模型会有一些细微差别。当你不只有数字列时，使用Patsy（下一节的主题）可能更简单，更不容易出错。</p>
<h1 id="13-2-用Patsy创建模型描述"><a href="#13-2-用Patsy创建模型描述" class="headerlink" title="13.2 用Patsy创建模型描述"></a>13.2 用Patsy创建模型描述</h1><p>Patsy是Python的一个库，使用简短的字符串“公式语法”描述统计模型（尤其是线性模型），可能是受到了R和S统计编程语言的公式语法的启发。</p>
<p>Patsy适合描述statsmodels的线性模型，因此我会关注于它的主要特点，让你尽快掌握。Patsy的公式是一个特殊的字符串语法，如下所示：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y ~ x0 + x1</span><br></pre></td></tr></table></figure>

<p>a+b不是将a与b相加的意思，而是为模型创建的设计矩阵。patsy.dmatrices函数接收一个公式字符串和一个数据集（可以是DataFrame或数组的字典），为线性模型创建设计矩阵：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">29</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">0.01</span>, <span class="hljs-number">-0.01</span>, <span class="hljs-number">0.25</span>, <span class="hljs-number">-4.1</span>, <span class="hljs-number">0.</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">-1.5</span>, <span class="hljs-number">0.</span>, <span class="hljs-number">3.6</span>, <span class="hljs-number">1.3</span>, <span class="hljs-number">-2.</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">30</span>]: data</span><br><span class="line">Out[<span class="hljs-number">30</span>]: </span><br><span class="line">   x0    x1    y</span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">1</span>  <span class="hljs-number">0.01</span> <span class="hljs-number">-1.5</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">2</span> <span class="hljs-number">-0.01</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>   <span class="hljs-number">3</span>  <span class="hljs-number">0.25</span>  <span class="hljs-number">3.6</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">4</span> <span class="hljs-number">-4.10</span>  <span class="hljs-number">1.3</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">5</span>  <span class="hljs-number">0.00</span> <span class="hljs-number">-2.0</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">31</span>]: <span class="hljs-keyword">import</span> patsy</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">32</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ x0 + x1'</span>, data)</span><br></pre></td></tr></table></figure>

<p>现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">33</span>]: y</span><br><span class="line">Out[<span class="hljs-number">33</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">1</span>)</span><br><span class="line">     y</span><br><span class="line">  <span class="hljs-number">-1.5</span></span><br><span class="line">   <span class="hljs-number">0.0</span></span><br><span class="line">   <span class="hljs-number">3.6</span></span><br><span class="line">   <span class="hljs-number">1.3</span></span><br><span class="line">  <span class="hljs-number">-2.0</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'y'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">34</span>]: X</span><br><span class="line">Out[<span class="hljs-number">34</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  x0     x1</span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">1</span>   <span class="hljs-number">0.01</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">2</span>  <span class="hljs-number">-0.01</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">3</span>   <span class="hljs-number">0.25</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">4</span>  <span class="hljs-number">-4.10</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">5</span>   <span class="hljs-number">0.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'x1'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>这些Patsy的DesignMatrix实例是NumPy的ndarray，带有附加元数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">35</span>]: np.asarray(y)</span><br><span class="line">Out[<span class="hljs-number">35</span>]: </span><br><span class="line">array([[<span class="hljs-number">-1.5</span>],</span><br><span class="line">       [ <span class="hljs-number">0.</span> ],</span><br><span class="line">       [ <span class="hljs-number">3.6</span>],</span><br><span class="line">       [ <span class="hljs-number">1.3</span>],</span><br><span class="line">       [<span class="hljs-number">-2.</span> ]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">36</span>]: np.asarray(X)</span><br><span class="line">Out[<span class="hljs-number">36</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">1.</span>  ,  <span class="hljs-number">0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">2.</span>  , <span class="hljs-number">-0.01</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">3.</span>  ,  <span class="hljs-number">0.25</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">4.</span>  , <span class="hljs-number">-4.1</span> ],</span><br><span class="line">       [ <span class="hljs-number">1.</span>  ,  <span class="hljs-number">5.</span>  ,  <span class="hljs-number">0.</span>  ]])</span><br></pre></td></tr></table></figure>

<p>你可能想Intercept是哪里来的。这是线性模型（比如普通最小二乘回归）的惯例用法。添加 +0 到模型可以不显示intercept：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">37</span>]: patsy.dmatrices(<span class="hljs-string">'y ~ x0 + x1 + 0'</span>, data)[<span class="hljs-number">1</span>]</span><br><span class="line">Out[<span class="hljs-number">37</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  x0     x1</span><br><span class="line">   <span class="hljs-number">1</span>   <span class="hljs-number">0.01</span></span><br><span class="line">   <span class="hljs-number">2</span>  <span class="hljs-number">-0.01</span></span><br><span class="line">   <span class="hljs-number">3</span>   <span class="hljs-number">0.25</span></span><br><span class="line">   <span class="hljs-number">4</span>  <span class="hljs-number">-4.10</span></span><br><span class="line">   <span class="hljs-number">5</span>   <span class="hljs-number">0.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x1'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy对象可以直接传递到算法（比如numpy.linalg.lstsq）中，它执行普通最小二乘回归：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">38</span>]: coef, resid, _, _ = np.linalg.lstsq(X, y)</span><br></pre></td></tr></table></figure>

<p>模型的元数据保留在design_info属性中，因此你可以重新附加列名到拟合系数，以获得一个Series，例如：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">39</span>]: coef</span><br><span class="line">Out[<span class="hljs-number">39</span>]: </span><br><span class="line">array([[ <span class="hljs-number">0.3129</span>],</span><br><span class="line">       [<span class="hljs-number">-0.0791</span>],</span><br><span class="line">       [<span class="hljs-number">-0.2655</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">40</span>]: coef = pd.Series(coef.squeeze(), index=X.design_info.column_names)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">41</span>]: coef</span><br><span class="line">Out[<span class="hljs-number">41</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.312910</span></span><br><span class="line">x0          <span class="hljs-number">-0.079106</span></span><br><span class="line">x1          <span class="hljs-number">-0.265464</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<h2 id="用Patsy公式进行数据转换"><a href="#用Patsy公式进行数据转换" class="headerlink" title="用Patsy公式进行数据转换"></a>用Patsy公式进行数据转换</h2><p>你可以将Python代码与patsy公式结合。在评估公式时，库将尝试查找在封闭作用域内使用的函数：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">42</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ x0 + np.log(np.abs(x1) + 1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">43</span>]: X</span><br><span class="line">Out[<span class="hljs-number">43</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  x0  np.log(np.abs(x1) + <span class="hljs-number">1</span>)</span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">1</span>                 <span class="hljs-number">0.00995</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">2</span>                 <span class="hljs-number">0.00995</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">3</span>                 <span class="hljs-number">0.22314</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">4</span>                 <span class="hljs-number">1.62924</span></span><br><span class="line">          <span class="hljs-number">1</span>   <span class="hljs-number">5</span>                 <span class="hljs-number">0.00000</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'x0'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'np.log(np.abs(x1) + 1)'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>常见的变量转换包括标准化（平均值为0，方差为1）和中心化（减去平均值）。Patsy有内置的函数进行这样的工作：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">44</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ standardize(x0) + center(x1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">45</span>]: X</span><br><span class="line">Out[<span class="hljs-number">45</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  standardize(x0)  center(x1)</span><br><span class="line">          <span class="hljs-number">1</span>         <span class="hljs-number">-1.41421</span>        <span class="hljs-number">0.78</span></span><br><span class="line">          <span class="hljs-number">1</span>         <span class="hljs-number">-0.70711</span>        <span class="hljs-number">0.76</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0.00000</span>        <span class="hljs-number">1.02</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0.70711</span>       <span class="hljs-number">-3.33</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1.41421</span>        <span class="hljs-number">0.77</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'standardize(x0)'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'center(x1)'</span> (column <span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>作为建模的一步，你可能拟合模型到一个数据集，然后用另一个数据集评估模型。另一个数据集可能是剩余的部分或是新数据。当执行中心化和标准化转变，用新数据进行预测要格外小心。因为你必须使用平均值或标准差转换新数据集，这也称作状态转换。</p>
<p>patsy.build_design_matrices函数可以使用原始样本数据集的保存信息，来转换新数据，：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">46</span>]: new_data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'x0'</span>: [<span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>, <span class="hljs-number">9</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'x1'</span>: [<span class="hljs-number">3.1</span>, <span class="hljs-number">-0.5</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2.3</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'y'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>]&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">47</span>]: new_X = patsy.build_design_matrices([X.design_info], new_data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">48</span>]: new_X</span><br><span class="line">Out[<span class="hljs-number">48</span>]: </span><br><span class="line">[DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">4</span>, <span class="hljs-number">3</span>)</span><br><span class="line">   Intercept  standardize(x0)  center(x1)</span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">2.12132</span>        <span class="hljs-number">3.87</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">2.82843</span>        <span class="hljs-number">0.27</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">3.53553</span>        <span class="hljs-number">0.77</span></span><br><span class="line">           <span class="hljs-number">1</span>          <span class="hljs-number">4.24264</span>        <span class="hljs-number">3.07</span></span><br><span class="line">   Terms:</span><br><span class="line">     <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">     <span class="hljs-string">'standardize(x0)'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">     <span class="hljs-string">'center(x1)'</span> (column <span class="hljs-number">2</span>)]</span><br></pre></td></tr></table></figure>

<p>因为Patsy中的加号不是加法的意义，当你按照名称将数据集的列相加时，你必须用特殊I函数将它们封装起来：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">49</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'y ~ I(x0 + x1)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">50</span>]: X</span><br><span class="line">Out[<span class="hljs-number">50</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">5</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  I(x0 + x1)</span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">1.01</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">1.99</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">3.25</span></span><br><span class="line">          <span class="hljs-number">1</span>       <span class="hljs-number">-0.10</span></span><br><span class="line">          <span class="hljs-number">1</span>        <span class="hljs-number">5.00</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'I(x0 + x1)'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy的patsy.builtins模块还有一些其它的内置转换。请查看线上文档。</p>
<p>分类数据有一个特殊的转换类，下面进行讲解。</p>
<h2 id="分类数据和Patsy"><a href="#分类数据和Patsy" class="headerlink" title="分类数据和Patsy"></a>分类数据和Patsy</h2><p>非数值数据可以用多种方式转换为模型设计矩阵。完整的讲解超出了本书范围，最好和统计课一起学习。</p>
<p>当你在Patsy公式中使用非数值数据，它们会默认转换为虚变量。如果有截距，会去掉一个，避免共线性：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">51</span>]: data = pd.DataFrame(&#123;</span><br><span class="line">   ....:     <span class="hljs-string">'key1'</span>: [<span class="hljs-string">'a'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>, <span class="hljs-string">'a'</span>, <span class="hljs-string">'b'</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'key2'</span>: [<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'v1'</span>: [<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>, <span class="hljs-number">5</span>, <span class="hljs-number">6</span>, <span class="hljs-number">7</span>, <span class="hljs-number">8</span>],</span><br><span class="line">   ....:     <span class="hljs-string">'v2'</span>: [<span class="hljs-number">-1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">2.5</span>, <span class="hljs-number">-0.5</span>, <span class="hljs-number">4.0</span>, <span class="hljs-number">-1.2</span>, <span class="hljs-number">0.2</span>, <span class="hljs-number">-1.7</span>]</span><br><span class="line">   ....: &#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">52</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">53</span>]: X</span><br><span class="line">Out[<span class="hljs-number">53</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  key1[T.b]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>如果你从模型中忽略截距，每个分类值的列都会包括在设计矩阵的模型中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">54</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + 0'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">55</span>]: X</span><br><span class="line">Out[<span class="hljs-number">55</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  key1[a]  key1[b]</span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">        <span class="hljs-number">1</span>        <span class="hljs-number">0</span></span><br><span class="line">        <span class="hljs-number">0</span>        <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'key1'</span> (columns <span class="hljs-number">0</span>:<span class="hljs-number">2</span>)</span><br></pre></td></tr></table></figure>

<p>使用C函数，数值列可以截取为分类量：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">56</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ C(key2)'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">57</span>]: X</span><br><span class="line">Out[<span class="hljs-number">57</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">2</span>)</span><br><span class="line">  Intercept  C(key2)[T<span class="hljs-number">.1</span>]</span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'C(key2)'</span> (column <span class="hljs-number">1</span>)</span><br></pre></td></tr></table></figure>

<p>当你在模型中使用多个分类名，事情就会变复杂，因为会包括key1:key2形式的相交部分，它可以用在方差（ANOVA）模型分析中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">58</span>]: data[<span class="hljs-string">'key2'</span>] = data[<span class="hljs-string">'key2'</span>].map(&#123;<span class="hljs-number">0</span>: <span class="hljs-string">'zero'</span>, <span class="hljs-number">1</span>: <span class="hljs-string">'one'</span>&#125;)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">59</span>]: data</span><br><span class="line">Out[<span class="hljs-number">59</span>]: </span><br><span class="line">  key1  key2  v1   v2</span><br><span class="line"><span class="hljs-number">0</span>    a  zero   <span class="hljs-number">1</span> <span class="hljs-number">-1.0</span></span><br><span class="line"><span class="hljs-number">1</span>    a   one   <span class="hljs-number">2</span>  <span class="hljs-number">0.0</span></span><br><span class="line"><span class="hljs-number">2</span>    b  zero   <span class="hljs-number">3</span>  <span class="hljs-number">2.5</span></span><br><span class="line"><span class="hljs-number">3</span>    b   one   <span class="hljs-number">4</span> <span class="hljs-number">-0.5</span></span><br><span class="line"><span class="hljs-number">4</span>    a  zero   <span class="hljs-number">5</span>  <span class="hljs-number">4.0</span></span><br><span class="line"><span class="hljs-number">5</span>    b   one   <span class="hljs-number">6</span> <span class="hljs-number">-1.2</span></span><br><span class="line"><span class="hljs-number">6</span>    a  zero   <span class="hljs-number">7</span>  <span class="hljs-number">0.2</span></span><br><span class="line"><span class="hljs-number">7</span>    b  zero   <span class="hljs-number">8</span> <span class="hljs-number">-1.7</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">60</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + key2'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">61</span>]: X</span><br><span class="line">Out[<span class="hljs-number">61</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">3</span>)</span><br><span class="line">  Intercept  key1[T.b]  key2[T.zero]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'key2'</span> (column <span class="hljs-number">2</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">62</span>]: y, X = patsy.dmatrices(<span class="hljs-string">'v2 ~ key1 + key2 + key1:key2'</span>, data)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">63</span>]: X</span><br><span class="line">Out[<span class="hljs-number">63</span>]: </span><br><span class="line">DesignMatrix <span class="hljs-keyword">with</span> shape (<span class="hljs-number">8</span>, <span class="hljs-number">4</span>)</span><br><span class="line">  Intercept  key1[T.b]  key2[T.zero]</span><br><span class="line">key1[T.b]:key2[T.zero]</span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">1</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">0</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">0</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">0</span></span><br><span class="line">          <span class="hljs-number">1</span>          <span class="hljs-number">1</span>             <span class="hljs-number">1</span>                       <span class="hljs-number">1</span></span><br><span class="line">  Terms:</span><br><span class="line">    <span class="hljs-string">'Intercept'</span> (column <span class="hljs-number">0</span>)</span><br><span class="line">    <span class="hljs-string">'key1'</span> (column <span class="hljs-number">1</span>)</span><br><span class="line">    <span class="hljs-string">'key2'</span> (column <span class="hljs-number">2</span>)</span><br><span class="line">    <span class="hljs-string">'key1:key2'</span> (column <span class="hljs-number">3</span>)</span><br></pre></td></tr></table></figure>

<p>Patsy提供转换分类数据的其它方法，包括以特定顺序转换。请参阅线上文档。</p>
<h1 id="13-3-statsmodels介绍"><a href="#13-3-statsmodels介绍" class="headerlink" title="13.3 statsmodels介绍"></a>13.3 statsmodels介绍</h1><p>statsmodels是Python进行拟合多种统计模型、进行统计试验和数据探索可视化的库。Statsmodels包含许多经典的统计方法，但没有贝叶斯方法和机器学习模型。</p>
<p>statsmodels包含的模型有：</p>
<ul>
<li>线性模型，广义线性模型和健壮线性模型</li>
<li>线性混合效应模型</li>
<li>方差（ANOVA）方法分析</li>
<li>时间序列过程和状态空间模型</li>
<li>广义矩估计</li>
</ul>
<p>下面，我会使用一些基本的statsmodels工具，探索Patsy公式和pandasDataFrame对象如何使用模型接口。</p>
<h2 id="估计线性模型"><a href="#估计线性模型" class="headerlink" title="估计线性模型"></a>估计线性模型</h2><p>statsmodels有多种线性回归模型，包括从基本（比如普通最小二乘）到复杂（比如迭代加权最小二乘法）的。</p>
<p>statsmodels的线性模型有两种不同的接口：基于数组和基于公式。它们可以通过API模块引入：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-keyword">import</span> statsmodels.api <span class="hljs-keyword">as</span> sm</span><br><span class="line"><span class="hljs-keyword">import</span> statsmodels.formula.api <span class="hljs-keyword">as</span> smf</span><br></pre></td></tr></table></figure>

<p>为了展示它们的使用方法，我们从一些随机数据生成一个线性模型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dnorm</span><span class="hljs-params">(mean, variance, size=<span class="hljs-number">1</span>)</span>:</span></span><br><span class="line">    <span class="hljs-keyword">if</span> isinstance(size, int):</span><br><span class="line">        size = size,</span><br><span class="line">    <span class="hljs-keyword">return</span> mean + np.sqrt(variance) * np.random.randn(*size)</span><br><span class="line"></span><br><span class="line"><span class="hljs-comment"># For reproducibility</span></span><br><span class="line">np.random.seed(<span class="hljs-number">12345</span>)</span><br><span class="line"></span><br><span class="line">N = <span class="hljs-number">100</span></span><br><span class="line">X = np.c_[dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.4</span>, size=N),</span><br><span class="line">          dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.6</span>, size=N),</span><br><span class="line">          dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.2</span>, size=N)]</span><br><span class="line">eps = dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, size=N)</span><br><span class="line">beta = [<span class="hljs-number">0.1</span>, <span class="hljs-number">0.3</span>, <span class="hljs-number">0.5</span>]</span><br><span class="line"></span><br><span class="line">y = np.dot(X, beta) + eps</span><br></pre></td></tr></table></figure>

<p>这里，我使用了“真实”模型和可知参数beta。此时，dnorm可用来生成正态分布数据，带有特定均值和方差。现在有：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">66</span>]: X[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">66</span>]: </span><br><span class="line">array([[<span class="hljs-number">-0.1295</span>, <span class="hljs-number">-1.2128</span>,  <span class="hljs-number">0.5042</span>],</span><br><span class="line">       [ <span class="hljs-number">0.3029</span>, <span class="hljs-number">-0.4357</span>, <span class="hljs-number">-0.2542</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3285</span>, <span class="hljs-number">-0.0253</span>,  <span class="hljs-number">0.1384</span>],</span><br><span class="line">       [<span class="hljs-number">-0.3515</span>, <span class="hljs-number">-0.7196</span>, <span class="hljs-number">-0.2582</span>],</span><br><span class="line">       [ <span class="hljs-number">1.2433</span>, <span class="hljs-number">-0.3738</span>, <span class="hljs-number">-0.5226</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">67</span>]: y[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">67</span>]: array([ <span class="hljs-number">0.4279</span>, <span class="hljs-number">-0.6735</span>, <span class="hljs-number">-0.0909</span>, <span class="hljs-number">-0.4895</span>,<span class="hljs-number">-0.1289</span>])</span><br></pre></td></tr></table></figure>

<p>像之前Patsy看到的，线性模型通常要拟合一个截距。sm.add_constant函数可以添加一个截距的列到现存的矩阵：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">68</span>]: X_model = sm.add_constant(X)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">69</span>]: X_model[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">69</span>]: </span><br><span class="line">array([[ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.1295</span>, <span class="hljs-number">-1.2128</span>,  <span class="hljs-number">0.5042</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    ,  <span class="hljs-number">0.3029</span>, <span class="hljs-number">-0.4357</span>, <span class="hljs-number">-0.2542</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.3285</span>, <span class="hljs-number">-0.0253</span>,  <span class="hljs-number">0.1384</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    , <span class="hljs-number">-0.3515</span>, <span class="hljs-number">-0.7196</span>, <span class="hljs-number">-0.2582</span>],</span><br><span class="line">       [ <span class="hljs-number">1.</span>    ,  <span class="hljs-number">1.2433</span>, <span class="hljs-number">-0.3738</span>, <span class="hljs-number">-0.5226</span>]])</span><br></pre></td></tr></table></figure>

<p>sm.OLS类可以拟合一个普通最小二乘回归：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">70</span>]: model = sm.OLS(y, X)</span><br></pre></td></tr></table></figure>

<p>这个模型的fit方法返回了一个回归结果对象，它包含估计的模型参数和其它内容：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">71</span>]: results = model.fit()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">72</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">72</span>]: array([ <span class="hljs-number">0.1783</span>,  <span class="hljs-number">0.223</span> ,  <span class="hljs-number">0.501</span> ])</span><br></pre></td></tr></table></figure>

<p>对结果使用summary方法可以打印模型的详细诊断结果：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">73</span>]: print(results.summary())</span><br><span class="line">OLS Regression Results                            </span><br><span class="line">==============================================================================</span><br><span class="line">Dep. Variable:                      y   R-squared:                       <span class="hljs-number">0.430</span></span><br><span class="line">Model:                            OLS   Adj. R-squared:                  <span class="hljs-number">0.413</span></span><br><span class="line">Method:                 Least Squares   F-statistic:                     <span class="hljs-number">24.42</span></span><br><span class="line">Date:                Mon, <span class="hljs-number">25</span> Sep <span class="hljs-number">2017</span>   Prob (F-statistic):           <span class="hljs-number">7.44e-12</span></span><br><span class="line">Time:                        <span class="hljs-number">14</span>:<span class="hljs-number">06</span>:<span class="hljs-number">15</span>   Log-Likelihood:                <span class="hljs-number">-34.305</span></span><br><span class="line">No. Observations:                 <span class="hljs-number">100</span>   AIC:                             <span class="hljs-number">74.61</span></span><br><span class="line">Df Residuals:                      <span class="hljs-number">97</span>   BIC:                             <span class="hljs-number">82.42</span></span><br><span class="line">Df Model:                           <span class="hljs-number">3</span>                                         </span><br><span class="line">Covariance Type:            nonrobust                                         </span><br><span class="line">==============================================================================</span><br><span class="line">                 coef    std err          t      P&gt;|t|      [<span class="hljs-number">0.025</span>      <span class="hljs-number">0.975</span>]</span><br><span class="line">------------------------------------------------------------------------------</span><br><span class="line">x1             <span class="hljs-number">0.1783</span>      <span class="hljs-number">0.053</span>      <span class="hljs-number">3.364</span>      <span class="hljs-number">0.001</span>       <span class="hljs-number">0.073</span>       <span class="hljs-number">0.283</span></span><br><span class="line">x2             <span class="hljs-number">0.2230</span>      <span class="hljs-number">0.046</span>      <span class="hljs-number">4.818</span>      <span class="hljs-number">0.000</span>       <span class="hljs-number">0.131</span>       <span class="hljs-number">0.315</span></span><br><span class="line">x3             <span class="hljs-number">0.5010</span>      <span class="hljs-number">0.080</span>      <span class="hljs-number">6.237</span>      <span class="hljs-number">0.000</span>       <span class="hljs-number">0.342</span>       <span class="hljs-number">0.660</span></span><br><span class="line">==============================================================================</span><br><span class="line">Omnibus:                        <span class="hljs-number">4.662</span>   Durbin-Watson:                   <span class="hljs-number">2.201</span></span><br><span class="line">Prob(Omnibus):                  <span class="hljs-number">0.097</span>   Jarque-Bera (JB):                <span class="hljs-number">4.098</span></span><br><span class="line">Skew:                           <span class="hljs-number">0.481</span>   Prob(JB):                        <span class="hljs-number">0.129</span></span><br><span class="line">Kurtosis:                       <span class="hljs-number">3.243</span>   Cond. No.</span><br><span class="line"><span class="hljs-number">1.74</span></span><br><span class="line">==============================================================================</span><br><span class="line">Warnings:</span><br><span class="line">[<span class="hljs-number">1</span>] Standard Errors assume that the covariance matrix of the errors <span class="hljs-keyword">is</span> correctly </span><br><span class="line">specified.</span><br></pre></td></tr></table></figure>

<p>这里的参数名为通用名x1, x2等等。假设所有的模型参数都在一个DataFrame中：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">74</span>]: data = pd.DataFrame(X, columns=[<span class="hljs-string">'col0'</span>, <span class="hljs-string">'col1'</span>, <span class="hljs-string">'col2'</span>])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">75</span>]: data[<span class="hljs-string">'y'</span>] = y</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">76</span>]: data[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">76</span>]: </span><br><span class="line">       col0      col1      col2         y</span><br><span class="line"><span class="hljs-number">0</span> <span class="hljs-number">-0.129468</span> <span class="hljs-number">-1.212753</span>  <span class="hljs-number">0.504225</span>  <span class="hljs-number">0.427863</span></span><br><span class="line"><span class="hljs-number">1</span>  <span class="hljs-number">0.302910</span> <span class="hljs-number">-0.435742</span> <span class="hljs-number">-0.254180</span> <span class="hljs-number">-0.673480</span></span><br><span class="line"><span class="hljs-number">2</span> <span class="hljs-number">-0.328522</span> <span class="hljs-number">-0.025302</span>  <span class="hljs-number">0.138351</span> <span class="hljs-number">-0.090878</span></span><br><span class="line"><span class="hljs-number">3</span> <span class="hljs-number">-0.351475</span> <span class="hljs-number">-0.719605</span> <span class="hljs-number">-0.258215</span> <span class="hljs-number">-0.489494</span></span><br><span class="line"><span class="hljs-number">4</span>  <span class="hljs-number">1.243269</span> <span class="hljs-number">-0.373799</span> <span class="hljs-number">-0.522629</span> <span class="hljs-number">-0.128941</span></span><br></pre></td></tr></table></figure>

<p>现在，我们使用statsmodels的公式API和Patsy的公式字符串：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">77</span>]: results = smf.ols(<span class="hljs-string">'y ~ col0 + col1 + col2'</span>, data=data).fit()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">78</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">78</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.033559</span></span><br><span class="line">col0         <span class="hljs-number">0.176149</span></span><br><span class="line">col1         <span class="hljs-number">0.224826</span></span><br><span class="line">col2         <span class="hljs-number">0.514808</span></span><br><span class="line">dtype: float64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">79</span>]: results.tvalues</span><br><span class="line">Out[<span class="hljs-number">79</span>]: </span><br><span class="line">Intercept    <span class="hljs-number">0.952188</span></span><br><span class="line">col0         <span class="hljs-number">3.319754</span></span><br><span class="line">col1         <span class="hljs-number">4.850730</span></span><br><span class="line">col2         <span class="hljs-number">6.303971</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>观察下statsmodels是如何返回Series结果的，附带有DataFrame的列名。当使用公式和pandas对象时，我们不需要使用add_constant。</p>
<p>给出一个样本外数据，你可以根据估计的模型参数计算预测值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">80</span>]: results.predict(data[:<span class="hljs-number">5</span>])</span><br><span class="line">Out[<span class="hljs-number">80</span>]: </span><br><span class="line"><span class="hljs-number">0</span>   <span class="hljs-number">-0.002327</span></span><br><span class="line"><span class="hljs-number">1</span>   <span class="hljs-number">-0.141904</span></span><br><span class="line"><span class="hljs-number">2</span>    <span class="hljs-number">0.041226</span></span><br><span class="line"><span class="hljs-number">3</span>   <span class="hljs-number">-0.323070</span></span><br><span class="line"><span class="hljs-number">4</span>   <span class="hljs-number">-0.100535</span></span><br><span class="line">dtype: float64</span><br></pre></td></tr></table></figure>

<p>statsmodels的线性模型结果还有其它的分析、诊断和可视化工具。除了普通最小二乘模型，还有其它的线性模型。</p>
<h2 id="估计时间序列过程"><a href="#估计时间序列过程" class="headerlink" title="估计时间序列过程"></a>估计时间序列过程</h2><p>statsmodels的另一模型类是进行时间序列分析，包括自回归过程、卡尔曼滤波和其它态空间模型，和多元自回归模型。</p>
<p>用自回归结构和噪声来模拟一些时间序列数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">init_x = <span class="hljs-number">4</span></span><br><span class="line"></span><br><span class="line"><span class="hljs-keyword">import</span> random</span><br><span class="line">values = [init_x, init_x]</span><br><span class="line">N = <span class="hljs-number">1000</span></span><br><span class="line"></span><br><span class="line">b0 = <span class="hljs-number">0.8</span></span><br><span class="line">b1 = <span class="hljs-number">-0.4</span></span><br><span class="line">noise = dnorm(<span class="hljs-number">0</span>, <span class="hljs-number">0.1</span>, N)</span><br><span class="line"><span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(N):</span><br><span class="line">    new_x = values[<span class="hljs-number">-1</span>] * b0 + values[<span class="hljs-number">-2</span>] * b1 + noise[i]</span><br><span class="line">    values.append(new_x)</span><br></pre></td></tr></table></figure>

<p>这个数据有AR(2)结构（两个延迟），参数是0.8和-0.4。拟合AR模型时，你可能不知道滞后项的个数，因此可以用较多的滞后量来拟合这个模型：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">82</span>]: MAXLAGS = <span class="hljs-number">5</span></span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">83</span>]: model = sm.tsa.AR(values)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">84</span>]: results = model.fit(MAXLAGS)</span><br></pre></td></tr></table></figure>

<p>结果中的估计参数首先是截距，其次是前两个参数的估计值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">85</span>]: results.params</span><br><span class="line">Out[<span class="hljs-number">85</span>]: array([<span class="hljs-number">-0.0062</span>,  <span class="hljs-number">0.7845</span>, <span class="hljs-number">-0.4085</span>, <span class="hljs-number">-0.0136</span>,  <span class="hljs-number">0.015</span> ,  <span class="hljs-number">0.0143</span>])</span><br></pre></td></tr></table></figure>

<p>更多的细节以及如何解释结果超出了本书的范围，可以通过statsmodels文档学习更多。</p>
<h1 id="13-4-scikit-learn介绍"><a href="#13-4-scikit-learn介绍" class="headerlink" title="13.4 scikit-learn介绍"></a>13.4 scikit-learn介绍</h1><p>scikit-learn是一个广泛使用、用途多样的Python机器学习库。它包含多种标准监督和非监督机器学习方法和模型选择和评估、数据转换、数据加载和模型持久化工具。这些模型可以用于分类、聚合、预测和其它任务。</p>
<p>机器学习方面的学习和应用scikit-learn和TensorFlow解决实际问题的线上和纸质资料很多。本节中，我会简要介绍scikit-learn API的风格。</p>
<p>写作此书的时候，scikit-learn并没有和pandas深度结合，但是有些第三方包在开发中。尽管如此，pandas非常适合在模型拟合前处理数据集。</p>
<p>举个例子，我用一个Kaggle竞赛的经典数据集，关于泰坦尼克号乘客的生还率。我们用pandas加载测试和训练数据集：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">86</span>]: train = pd.read_csv(<span class="hljs-string">'datasets/titanic/train.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">87</span>]: test = pd.read_csv(<span class="hljs-string">'datasets/titanic/test.csv'</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">88</span>]: train[:<span class="hljs-number">4</span>]</span><br><span class="line">Out[<span class="hljs-number">88</span>]: </span><br><span class="line">   PassengerId  Survived  Pclass  \</span><br><span class="line"><span class="hljs-number">0</span>            <span class="hljs-number">1</span>         <span class="hljs-number">0</span>       <span class="hljs-number">3</span>   </span><br><span class="line"><span class="hljs-number">1</span>            <span class="hljs-number">2</span>         <span class="hljs-number">1</span>       <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">2</span>            <span class="hljs-number">3</span>         <span class="hljs-number">1</span>       <span class="hljs-number">3</span>   </span><br><span class="line"><span class="hljs-number">3</span>            <span class="hljs-number">4</span>         <span class="hljs-number">1</span>       <span class="hljs-number">1</span>   </span><br><span class="line">                                                Name     Sex   Age  SibSp  \</span><br><span class="line"><span class="hljs-number">0</span>                            Braund, Mr. Owen Harris    male  <span class="hljs-number">22.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">1</span>  Cumings, Mrs. John Bradley (Florence Briggs Th...  female  <span class="hljs-number">38.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line"><span class="hljs-number">2</span>                             Heikkinen, Miss. Laina  female  <span class="hljs-number">26.0</span>      <span class="hljs-number">0</span>   </span><br><span class="line"><span class="hljs-number">3</span>       Futrelle, Mrs. Jacques Heath (Lily May Peel)  female  <span class="hljs-number">35.0</span>      <span class="hljs-number">1</span>   </span><br><span class="line">   Parch            Ticket     Fare Cabin Embarked  </span><br><span class="line"><span class="hljs-number">0</span>      <span class="hljs-number">0</span>         A/<span class="hljs-number">5</span> <span class="hljs-number">21171</span>   <span class="hljs-number">7.2500</span>   NaN        S  </span><br><span class="line"><span class="hljs-number">1</span>      <span class="hljs-number">0</span>          PC <span class="hljs-number">17599</span>  <span class="hljs-number">71.2833</span>   C85        C  </span><br><span class="line"><span class="hljs-number">2</span>      <span class="hljs-number">0</span>  STON/O2. <span class="hljs-number">3101282</span>   <span class="hljs-number">7.9250</span>   NaN        S  </span><br><span class="line"><span class="hljs-number">3</span>      <span class="hljs-number">0</span>            <span class="hljs-number">113803</span>  <span class="hljs-number">53.1000</span>  C123        S</span><br></pre></td></tr></table></figure>

<p>statsmodels和scikit-learn通常不能接收缺失数据，因此我们要查看列是否包含缺失值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">89</span>]: train.isnull().sum()</span><br><span class="line">Out[<span class="hljs-number">89</span>]: </span><br><span class="line">PassengerId      <span class="hljs-number">0</span></span><br><span class="line">Survived         <span class="hljs-number">0</span></span><br><span class="line">Pclass           <span class="hljs-number">0</span></span><br><span class="line">Name             <span class="hljs-number">0</span></span><br><span class="line">Sex              <span class="hljs-number">0</span></span><br><span class="line">Age            <span class="hljs-number">177</span></span><br><span class="line">SibSp            <span class="hljs-number">0</span></span><br><span class="line">Parch            <span class="hljs-number">0</span></span><br><span class="line">Ticket           <span class="hljs-number">0</span></span><br><span class="line">Fare             <span class="hljs-number">0</span></span><br><span class="line">Cabin          <span class="hljs-number">687</span></span><br><span class="line">Embarked         <span class="hljs-number">2</span></span><br><span class="line">dtype: int64</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">90</span>]: test.isnull().sum()</span><br><span class="line">Out[<span class="hljs-number">90</span>]: </span><br><span class="line">PassengerId      <span class="hljs-number">0</span></span><br><span class="line">Pclass           <span class="hljs-number">0</span></span><br><span class="line">Name             <span class="hljs-number">0</span></span><br><span class="line">Sex              <span class="hljs-number">0</span></span><br><span class="line">Age             <span class="hljs-number">86</span></span><br><span class="line">SibSp            <span class="hljs-number">0</span></span><br><span class="line">Parch            <span class="hljs-number">0</span></span><br><span class="line">Ticket           <span class="hljs-number">0</span></span><br><span class="line">Fare             <span class="hljs-number">1</span></span><br><span class="line">Cabin          <span class="hljs-number">327</span></span><br><span class="line">Embarked         <span class="hljs-number">0</span></span><br><span class="line">dtype: int64</span><br></pre></td></tr></table></figure>

<p>在统计和机器学习的例子中，根据数据中的特征，一个典型的任务是预测乘客能否生还。模型现在训练数据集中拟合，然后用样本外测试数据集评估。</p>
<p>我想用年龄作为预测值，但是它包含缺失值。缺失数据补全的方法有多种，我用的是一种简单方法，用训练数据集的中位数补全两个表的空值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">91</span>]: impute_value = train[<span class="hljs-string">'Age'</span>].median()</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">92</span>]: train[<span class="hljs-string">'Age'</span>] = train[<span class="hljs-string">'Age'</span>].fillna(impute_value)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">93</span>]: test[<span class="hljs-string">'Age'</span>] = test[<span class="hljs-string">'Age'</span>].fillna(impute_value)</span><br></pre></td></tr></table></figure>

<p>现在我们需要指定模型。我增加了一个列IsFemale，作为“Sex”列的编码：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">94</span>]: train[<span class="hljs-string">'IsFemale'</span>] = (train[<span class="hljs-string">'Sex'</span>] == <span class="hljs-string">'female'</span>).astype(int)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">95</span>]: test[<span class="hljs-string">'IsFemale'</span>] = (test[<span class="hljs-string">'Sex'</span>] == <span class="hljs-string">'female'</span>).astype(int)</span><br></pre></td></tr></table></figure>

<p>然后，我们确定一些模型变量，并创建NumPy数组：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">96</span>]: predictors = [<span class="hljs-string">'Pclass'</span>, <span class="hljs-string">'IsFemale'</span>, <span class="hljs-string">'Age'</span>]</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">97</span>]: X_train = train[predictors].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">98</span>]: X_test = test[predictors].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">99</span>]: y_train = train[<span class="hljs-string">'Survived'</span>].values</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">100</span>]: X_train[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">100</span>]: </span><br><span class="line">array([[  <span class="hljs-number">3.</span>,   <span class="hljs-number">0.</span>,  <span class="hljs-number">22.</span>],</span><br><span class="line">       [  <span class="hljs-number">1.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">38.</span>],</span><br><span class="line">       [  <span class="hljs-number">3.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">26.</span>],</span><br><span class="line">       [  <span class="hljs-number">1.</span>,   <span class="hljs-number">1.</span>,  <span class="hljs-number">35.</span>],</span><br><span class="line">       [  <span class="hljs-number">3.</span>,   <span class="hljs-number">0.</span>,  <span class="hljs-number">35.</span>]])</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">101</span>]: y_train[:<span class="hljs-number">5</span>]</span><br><span class="line">Out[<span class="hljs-number">101</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>我不能保证这是一个好模型，但它的特征都符合。我们用scikit-learn的LogisticRegression模型，创建一个模型实例：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">102</span>]: <span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegression</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">103</span>]: model = LogisticRegression()</span><br></pre></td></tr></table></figure>

<p>与statsmodels类似，我们可以用模型的fit方法，将它拟合到训练数据：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">104</span>]: model.fit(X_train, y_train)</span><br><span class="line">Out[<span class="hljs-number">104</span>]: </span><br><span class="line">LogisticRegression(C=<span class="hljs-number">1.0</span>, class_weight=<span class="hljs-literal">None</span>, dual=<span class="hljs-literal">False</span>, fit_intercept=<span class="hljs-literal">True</span>,</span><br><span class="line">          intercept_scaling=<span class="hljs-number">1</span>, max_iter=<span class="hljs-number">100</span>, multi_class=<span class="hljs-string">'ovr'</span>, n_jobs=<span class="hljs-number">1</span>,</span><br><span class="line">          penalty=<span class="hljs-string">'l2'</span>, random_state=<span class="hljs-literal">None</span>, solver=<span class="hljs-string">'liblinear'</span>, tol=<span class="hljs-number">0.0001</span>,</span><br><span class="line">          verbose=<span class="hljs-number">0</span>, warm_start=<span class="hljs-literal">False</span>)</span><br></pre></td></tr></table></figure>

<p>现在，我们可以用model.predict，对测试数据进行预测：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">105</span>]: y_predict = model.predict(X_test)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">106</span>]: y_predict[:<span class="hljs-number">10</span>]</span><br><span class="line">Out[<span class="hljs-number">106</span>]: array([<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, <span class="hljs-number">0</span>])</span><br></pre></td></tr></table></figure>

<p>如果你有测试数据集的真实值，你可以计算准确率或其它错误度量值：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(y_true == y_predict).mean()</span><br></pre></td></tr></table></figure>

<p>在实际中，模型训练经常有许多额外的复杂因素。许多模型有可以调节的参数，有些方法（比如交叉验证）可以用来进行参数调节，避免对训练数据过拟合。这通常可以提高预测性或对新数据的健壮性。</p>
<p>交叉验证通过分割训练数据来模拟样本外预测。基于模型的精度得分（比如均方差），可以对模型参数进行网格搜索。有些模型，如logistic回归，有内置的交叉验证的估计类。例如，logisticregressioncv类可以用一个参数指定网格搜索对模型的正则化参数C的粒度：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">107</span>]: <span class="hljs-keyword">from</span> sklearn.linear_model <span class="hljs-keyword">import</span> LogisticRegressionCV</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">108</span>]: model_cv = LogisticRegressionCV(<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">109</span>]: model_cv.fit(X_train, y_train)</span><br><span class="line">Out[<span class="hljs-number">109</span>]: </span><br><span class="line">LogisticRegressionCV(Cs=<span class="hljs-number">10</span>, class_weight=<span class="hljs-literal">None</span>, cv=<span class="hljs-literal">None</span>, dual=<span class="hljs-literal">False</span>,</span><br><span class="line">           fit_intercept=<span class="hljs-literal">True</span>, intercept_scaling=<span class="hljs-number">1.0</span>, max_iter=<span class="hljs-number">100</span>,</span><br><span class="line">           multi_class=<span class="hljs-string">'ovr'</span>, n_jobs=<span class="hljs-number">1</span>, penalty=<span class="hljs-string">'l2'</span>, random_state=<span class="hljs-literal">None</span>,</span><br><span class="line">           refit=<span class="hljs-literal">True</span>, scoring=<span class="hljs-literal">None</span>, solver=<span class="hljs-string">'lbfgs'</span>, tol=<span class="hljs-number">0.0001</span>, verbose=<span class="hljs-number">0</span>)</span><br></pre></td></tr></table></figure>

<p>要手动进行交叉验证，你可以使用cross_val_score帮助函数，它可以处理数据分割。例如，要交叉验证我们的带有四个不重叠训练数据的模型，可以这样做：</p>
<figure class="highlight python hljs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">In [<span class="hljs-number">110</span>]: <span class="hljs-keyword">from</span> sklearn.model_selection <span class="hljs-keyword">import</span> cross_val_score</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">111</span>]: model = LogisticRegression(C=<span class="hljs-number">10</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">112</span>]: scores = cross_val_score(model, X_train, y_train, cv=<span class="hljs-number">4</span>)</span><br><span class="line"></span><br><span class="line">In [<span class="hljs-number">113</span>]: scores</span><br><span class="line">Out[<span class="hljs-number">113</span>]: array([ <span class="hljs-number">0.7723</span>,  <span class="hljs-number">0.8027</span>,  <span class="hljs-number">0.7703</span>,  <span class="hljs-number">0.7883</span>])</span><br></pre></td></tr></table></figure>

<p>默认的评分指标取决于模型本身，但是可以明确指定一个评分。交叉验证过的模型需要更长时间来训练，但会有更高的模型性能。</p>
<h1 id="13-5-继续学习"><a href="#13-5-继续学习" class="headerlink" title="13.5 继续学习"></a>13.5 继续学习</h1><p>我只是介绍了一些Python建模库的表面内容，现在有越来越多的框架用于各种统计和机器学习，它们都是用Python或Python用户界面实现的。</p>
<p>这本书的重点是数据规整，有其它的书是关注建模和数据科学工具的。其中优秀的有：</p>
<ul>
<li>Andreas Mueller and Sarah Guido (O’Reilly)的 《Introduction to Machine Learning with Python》</li>
<li>Jake VanderPlas (O’Reilly)的 《Python Data Science Handbook》</li>
<li>Joel Grus (O’Reilly) 的 《Data Science from Scratch: First Principles》</li>
<li>Sebastian Raschka (Packt Publishing) 的《Python Machine Learning》</li>
<li>Aurélien Géron (O’Reilly) 的《Hands-On Machine Learning with Scikit-Learn and TensorFlow》</li>
</ul>
<p>虽然书是学习的好资源，但是随着底层开源软件的发展，书的内容会过时。最好是不断熟悉各种统计和机器学习框架的文档，学习最新的功能和API。</p>

        </div>
        
        <div class="level is-size-7 is-uppercase">
            <div class="level-start">
                <div class="level-item">
                    <span class="is-size-6 has-text-grey has-mr-7">#</span>
                    <a class="has-link-grey -link" href="/tags/pandas/" rel="tag">pandas</a>, <a class="has-link-grey -link" href="/tags/python/" rel="tag">python</a>, <a class="has-link-grey -link" href="/tags/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/" rel="tag">数据分析</a>
                </div>
            </div>
        </div>
        
        
        
        <div class="social-share" data-disabled="diandian, linkedin, douban"></div>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/css/share.min.css">
<script src="https://cdn.jsdelivr.net/npm/social-share.js@1.0.16/dist/js/social-share.min.js"></script>
        
    </div>
</div>



<div class="card">
    <div class="card-content">
        <h3 class="menu-label has-text-centered">喜欢这篇文章？打赏一下作者吧</h3>
        <div class="buttons is-centered">
            
                
<a class="button is-info donate">
    <span class="icon is-small">
        <i class="fab fa-alipay"></i>
    </span>
    <span>支付宝</span>
    <div class="qrcode"><img src="/images/alipay.jpg" alt="支付宝"></div>
</a>

                
                
<a class="button is-success donate">
    <span class="icon is-small">
        <i class="fab fa-weixin"></i>
    </span>
    <span>微信</span>
    <div class="qrcode"><img src="/images/wechat.png" alt="微信"></div>
</a>

                
        </div>
    </div>
</div>



<div class="card card-transparent">
    <div class="level post-navigation is-flex-wrap is-mobile">
        
        <div class="level-start">
            <a class="level level-item has-link-grey  article-nav-prev" href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC14%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%A1%88%E4%BE%8B/">
                <i class="level-item fas fa-chevron-left"></i>
                <span class="level-item">《利用Python进行数据分析·第2版》第14章 数据分析案例</span>
            </a>
        </div>
        
        
        <div class="level-end">
            <a class="level level-item has-link-grey  article-nav-next" href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC12%E7%AB%A0%20pandas%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/">
                <span class="level-item">《利用Python进行数据分析·第2版》第12章 pandas高级应用</span>
                <i class="level-item fas fa-chevron-right"></i>
            </a>
        </div>
        
    </div>
</div>


</div>
                
    
    <!-- 粘贴的部分 -->
    
                
    
    <!-- 粘贴的部分 -->
                              <!-- 修改，可选保留的栏 -->
    
    
    
    
    <div class="column is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only has-order-3 column-right is-sticky">
        
            
<div class="card widget" id="toc">
    <div class="card-content">
        <div class="menu">
            <h3 class="menu-label">
                目录
            </h3>
            <ul class="menu-list"><li>
        <a class="is-flex" href="#13-1-pandas与模型代码的接口">
        <span class="has-mr-6">1</span>
        <span>13.1 pandas与模型代码的接口</span>
        </a></li><li>
        <a class="is-flex" href="#13-2-用Patsy创建模型描述">
        <span class="has-mr-6">2</span>
        <span>13.2 用Patsy创建模型描述</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#用Patsy公式进行数据转换">
        <span class="has-mr-6">2.1</span>
        <span>用Patsy公式进行数据转换</span>
        </a></li><li>
        <a class="is-flex" href="#分类数据和Patsy">
        <span class="has-mr-6">2.2</span>
        <span>分类数据和Patsy</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#13-3-statsmodels介绍">
        <span class="has-mr-6">3</span>
        <span>13.3 statsmodels介绍</span>
        </a><ul class="menu-list"><li>
        <a class="is-flex" href="#估计线性模型">
        <span class="has-mr-6">3.1</span>
        <span>估计线性模型</span>
        </a></li><li>
        <a class="is-flex" href="#估计时间序列过程">
        <span class="has-mr-6">3.2</span>
        <span>估计时间序列过程</span>
        </a></li></ul></li><li>
        <a class="is-flex" href="#13-4-scikit-learn介绍">
        <span class="has-mr-6">4</span>
        <span>13.4 scikit-learn介绍</span>
        </a></li><li>
        <a class="is-flex" href="#13-5-继续学习">
        <span class="has-mr-6">5</span>
        <span>13.5 继续学习</span>
        </a></li></ul>
        </div>
    </div>
</div>

        
            
<div class="card widget">
    <div class="card-content">
        <h3 class="menu-label">
            最新文章
        </h3>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-10T11:48:06.000Z">2019-11-10</time></div>
                    <a href="/2019/11/10/%E7%94%A8python%E5%86%99%E4%BA%86%E4%B8%80%E4%B8%AA%E8%A7%A3%E6%95%B0%E5%AD%97%E5%8D%8E%E5%AE%B9%E9%81%93%E6%B8%B8%E6%88%8F%E7%9A%84%E7%A8%8B%E5%BA%8F/" class="has-link-black-ter is-size-6">用python写了一个解数字华容道游戏的程序</a>
                    <p class="is-size-7 is-uppercase">
                        
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-08T01:12:36.000Z">2019-11-08</time></div>
                    <a href="/2019/11/08/%E5%88%86%E4%BA%AB%E4%B8%80%E4%B8%AA%E6%8C%89%E7%85%A7%E6%A8%A1%E6%9D%BF%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F%E8%87%AA%E5%8A%A8%E6%B1%87%E6%80%BB%E7%BB%9F%E8%AE%A1%E7%9A%84%E8%84%9A%E6%9C%AC/" class="has-link-black-ter is-size-6">分享一个按照模板文件格式自动汇总统计的脚本</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T02:05:39.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E9%99%84%E5%BD%95B%20%E6%9B%B4%E5%A4%9A%E5%85%B3%E4%BA%8EIPython%E7%9A%84%E5%86%85%E5%AE%B9%EF%BC%88%E5%AE%8C%EF%BC%89/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》附录B 更多关于IPython的内容（完）</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T02:04:52.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E9%99%84%E5%BD%95A%20NumPy%E9%AB%98%E7%BA%A7%E5%BA%94%E7%94%A8/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》附录A NumPy高级应用</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
        <article class="media">
            
            <div class="media-content">
                <div class="content">
                    <div><time class="has-text-grey is-size-7 is-uppercase" datetime="2019-11-05T02:03:49.000Z">2019-11-05</time></div>
                    <a href="/2019/11/05/%E3%80%8A%E5%88%A9%E7%94%A8Python%E8%BF%9B%E8%A1%8C%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%C2%B7%E7%AC%AC2%E7%89%88%E3%80%8B%E7%AC%AC14%E7%AB%A0%20%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90%E6%A1%88%E4%BE%8B/" class="has-link-black-ter is-size-6">《利用Python进行数据分析·第2版》第14章 数据分析案例</a>
                    <p class="is-size-7 is-uppercase">
                        <a class="has-link-grey -link" href="/categories/%E6%95%B0%E6%8D%AE%E5%88%86%E6%9E%90/">数据分析</a>
                    </p>
                </div>
            </div>
        </article>
        
    </div>
</div>

        
        
    </div>
    
            </div>
        </div>
    </section>
    <footer class="footer">
    <div class="container">
        <div class="level">
            <div class="level-start has-text-centered-mobile">
                <a class="footer-logo is-block has-mb-6" href="/">
                
                    <img src="/images/grid.svg" alt="《利用Python进行数据分析·第2版》第13章 Python建模库介绍" height="28">
                
                </a>
                <p class="is-size-7">
                &copy; 2019 Lanhoo&nbsp;
                Powered by <a href="https://hexo.io/" target="_blank">Hexo</a> & <a
                        href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank">Icarus</a>
                
                </p>
            </div>
            <div class="level-end">
            
                <div class="field has-addons is-flex-center-mobile has-mt-5-mobile is-flex-wrap is-flex-middle">
                
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Creative Commons" href="https://creativecommons.org/">
                        
                        <i class="fab fa-creative-commons"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Attribution 4.0 International" href="https://creativecommons.org/licenses/by/4.0/">
                        
                        <i class="fab fa-creative-commons-by"></i>
                        
                    </a>
                </p>
                
                <p class="control">
                    <a class="button is-white is-large" target="_blank" title="Download on GitHub" href="https://github.com/ppoffice/hexo-theme-icarus">
                        
                        <i class="fab fa-github"></i>
                        
                    </a>
                </p>
                
                </div>
            
            </div>
        </div>
    </div>
</footer>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script>
<script>moment.locale("zh-CN");</script>


    
    
    
    <script src="/js/animation.js"></script>
    

    
    
    
    <script src="https://cdn.jsdelivr.net/npm/lightgallery@1.6.8/dist/js/lightgallery.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.7.0/dist/js/jquery.justifiedGallery.min.js" defer></script>
    <script src="/js/gallery.js" defer></script>
    

    
    

<div id="outdated">
    <h6>Your browser is out-of-date!</h6>
    <p>Update your browser to view this website correctly. <a id="btnUpdateBrowser" href="http://outdatedbrowser.com/" target="_blank" rel="noopener">Update
            my browser now </a></p>
    <p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">&times;</a></p>
</div>
<script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        outdatedBrowser({
            bgColor: '#f25648',
            color: '#ffffff',
            lowerThan: 'flex'
        });
    });
</script>


    
    
<script src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/unpacked/MathJax.js?config=TeX-MML-AM_CHTML" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    MathJax.Hub.Config({
        'HTML-CSS': {
            matchFontHeight: false
        },
        SVG: {
            matchFontHeight: false
        },
        CommonHTML: {
            matchFontHeight: false
        },
        tex2jax: {
            inlineMath: [
                ['$','$'],
                ['\\(','\\)']
            ]
        }
    });
});
</script>

    
    

<a id="back-to-top" title="回到顶端" href="javascript:;" target="_blank" rel="noopener">
    <i class="fas fa-chevron-up"></i>
</a>
<script src="/js/back-to-top.js" defer></script>


    
    

    
    
    
    

    
    
    
    
    
    <script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script>
    <script src="/js/clipboard.js" defer></script>
    

    
    
    


<script src="/js/main.js" defer></script>

<script>
// [].slice.call(document.querySelectorAll('table')).forEach(function(el){
//     var wrapper = document.createElement('div');
//     wrapper.className = 'table-area';
//     el.parentNode.insertBefore(wrapper, el);
//     el.parentNode.removeChild(el);
//     wrapper.appendChild(el);
// })
// 这是给真正的表格添加样式
$(".content > table").wrap("<div class='table-area'></div>");
$("table.dataframe").wrap("<div class='table-area'></div>");
</script>

    
    <div class="searchbox ins-search">
    <div class="searchbox-container ins-search-container">
        <div class="searchbox-input-wrapper">
            <input type="text" class="searchbox-input ins-search-input" placeholder="想要查找什么..." />
            <span class="searchbox-close ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="searchbox-result-wrapper ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
    (function (window) {
        var INSIGHT_CONFIG = {
            TRANSLATION: {
                POSTS: '文章',
                PAGES: '页面',
                CATEGORIES: '分类',
                TAGS: '标签',
                UNTITLED: '(无标题)',
            },
            CONTENT_URL: '/content.json',
        };
        window.INSIGHT_CONFIG = INSIGHT_CONFIG;
    })(window);
</script>
<script src="/js/insight.js" defer></script>
<link rel="stylesheet" href="/css/search.css">
<link rel="stylesheet" href="/css/insight.css">
    
</body>
</html>